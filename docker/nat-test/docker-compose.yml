# NAT Traversal Test Environment
# Simulates different NAT types to test hole punching and relay

services:
  # Public bootstrap/relay node (no NAT)
  bootstrap:
    build:
      context: ../..
      dockerfile: docker/nat-test/Dockerfile
    container_name: nat-test-bootstrap
    hostname: bootstrap
    networks:
      public:
        ipv4_address: 10.100.0.10
    environment:
      - NODE_TYPE=bootstrap
      - NODE_ID=bootstrap-001
      - QUIC_PORT=4433
      - HTTP_PORT=8080
      - RELAY_ENABLED=true
      - MACULA_QUIC_PORT=4433
      - GATEWAY_PORT=4433
      - HEALTH_PORT=8080
      - MACULA_REALM=com.macula.nat-test
      - MACULA_TLS_MODE=development
      - TLS_CERT_FILE=/opt/macula/certs/cert.pem
      - TLS_KEY_FILE=/opt/macula/certs/key.pem
      - MACULA_HOSTNAME=10.100.0.10
    ports:
      - "18080:8080"
      - "14433:4433/udp"

  # Peer behind Full Cone NAT (EI/EI/PP) - Easy to connect
  peer_full_cone:
    build:
      context: ../..
      dockerfile: docker/nat-test/Dockerfile
    container_name: nat-test-full-cone
    hostname: peer-full-cone
    networks:
      nat_full_cone:
        ipv4_address: 172.31.1.10
    environment:
      - NODE_TYPE=peer
      - NODE_ID=peer-full-cone
      - BOOTSTRAP_HOST=10.100.0.10
      - BOOTSTRAP_PORT=4433
      - MACULA_QUIC_PORT=4433
      - GATEWAY_PORT=4433
      - HEALTH_PORT=8080
      - MACULA_REALM=com.macula.nat-test
      - MACULA_TLS_MODE=development
      - TLS_CERT_FILE=/opt/macula/certs/cert.pem
      - TLS_KEY_FILE=/opt/macula/certs/key.pem
      - MACULA_BOOTSTRAP_PEERS=https://10.100.0.10:4433
    depends_on:
      - bootstrap
      - nat_full_cone_router
    cap_add:
      - NET_ADMIN

  # Full Cone NAT router
  nat_full_cone_router:
    image: alpine:latest
    container_name: nat-router-full-cone
    hostname: nat-full-cone-router
    networks:
      public:
        ipv4_address: 10.100.0.20
      nat_full_cone:
        ipv4_address: 172.31.1.2
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    command: >
      sh -c "
        apk add --no-cache iptables iproute2 &&
        PUBLIC_IF=$$(ip -o addr | grep '10.100.0' | awk '{print $$2}') &&
        INTERNAL_IF=$$(ip -o addr | grep '172.31.1' | awk '{print $$2}') &&
        iptables -t nat -A POSTROUTING -o $$PUBLIC_IF -j MASQUERADE &&
        iptables -A FORWARD -i $$INTERNAL_IF -o $$PUBLIC_IF -j ACCEPT &&
        iptables -A FORWARD -i $$PUBLIC_IF -o $$INTERNAL_IF -j ACCEPT &&
        echo \"Full Cone NAT configured (public=$$PUBLIC_IF, internal=$$INTERNAL_IF)\" &&
        tail -f /dev/null
      "

  # Peer behind Restricted Cone NAT (EI/HD/PP) - Moderate difficulty
  peer_restricted:
    build:
      context: ../..
      dockerfile: docker/nat-test/Dockerfile
    container_name: nat-test-restricted
    hostname: peer-restricted
    networks:
      nat_restricted:
        ipv4_address: 172.32.1.10
    environment:
      - NODE_TYPE=peer
      - NODE_ID=peer-restricted
      - BOOTSTRAP_HOST=10.100.0.10
      - BOOTSTRAP_PORT=4433
      - MACULA_QUIC_PORT=4433
      - GATEWAY_PORT=4433
      - HEALTH_PORT=8080
      - MACULA_REALM=com.macula.nat-test
      - MACULA_TLS_MODE=development
      - TLS_CERT_FILE=/opt/macula/certs/cert.pem
      - TLS_KEY_FILE=/opt/macula/certs/key.pem
      - MACULA_BOOTSTRAP_PEERS=https://10.100.0.10:4433
    depends_on:
      - bootstrap
      - nat_restricted_router
    cap_add:
      - NET_ADMIN

  # Restricted Cone NAT router
  nat_restricted_router:
    image: alpine:latest
    container_name: nat-router-restricted
    hostname: nat-restricted-router
    networks:
      public:
        ipv4_address: 10.100.0.21
      nat_restricted:
        ipv4_address: 172.32.1.2
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    command: >
      sh -c "
        apk add --no-cache iptables iproute2 &&
        PUBLIC_IF=$$(ip -o addr | grep '10.100.0' | awk '{print $$2}') &&
        INTERNAL_IF=$$(ip -o addr | grep '172.32.1' | awk '{print $$2}') &&
        iptables -t nat -A POSTROUTING -o $$PUBLIC_IF -j MASQUERADE &&
        iptables -A FORWARD -i $$INTERNAL_IF -o $$PUBLIC_IF -j ACCEPT &&
        iptables -A FORWARD -i $$PUBLIC_IF -o $$INTERNAL_IF -m state --state ESTABLISHED,RELATED -j ACCEPT &&
        echo \"Restricted Cone NAT configured (public=$$PUBLIC_IF, internal=$$INTERNAL_IF)\" &&
        tail -f /dev/null
      "

  # Peer behind Symmetric NAT (PD/PD/RD) - Requires relay
  peer_symmetric:
    build:
      context: ../..
      dockerfile: docker/nat-test/Dockerfile
    container_name: nat-test-symmetric
    hostname: peer-symmetric
    networks:
      nat_symmetric:
        ipv4_address: 172.33.1.10
    environment:
      - NODE_TYPE=peer
      - NODE_ID=peer-symmetric
      - BOOTSTRAP_HOST=10.100.0.10
      - BOOTSTRAP_PORT=4433
      - MACULA_QUIC_PORT=4433
      - GATEWAY_PORT=4433
      - HEALTH_PORT=8080
      - MACULA_REALM=com.macula.nat-test
      - MACULA_TLS_MODE=development
      - TLS_CERT_FILE=/opt/macula/certs/cert.pem
      - TLS_KEY_FILE=/opt/macula/certs/key.pem
      - MACULA_BOOTSTRAP_PEERS=https://10.100.0.10:4433
    depends_on:
      - bootstrap
      - nat_symmetric_router
    cap_add:
      - NET_ADMIN

  # Symmetric NAT router (most restrictive)
  nat_symmetric_router:
    image: alpine:latest
    container_name: nat-router-symmetric
    hostname: nat-symmetric-router
    networks:
      public:
        ipv4_address: 10.100.0.22
      nat_symmetric:
        ipv4_address: 172.33.1.2
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    command: >
      sh -c "
        apk add --no-cache iptables iproute2 &&
        PUBLIC_IF=$$(ip -o addr | grep '10.100.0' | awk '{print $$2}') &&
        INTERNAL_IF=$$(ip -o addr | grep '172.33.1' | awk '{print $$2}') &&
        iptables -t nat -A POSTROUTING -o $$PUBLIC_IF -j MASQUERADE --random &&
        iptables -A FORWARD -i $$INTERNAL_IF -o $$PUBLIC_IF -j ACCEPT &&
        iptables -A FORWARD -i $$PUBLIC_IF -o $$INTERNAL_IF -m state --state ESTABLISHED,RELATED -j ACCEPT &&
        echo \"Symmetric NAT configured (public=$$PUBLIC_IF, internal=$$INTERNAL_IF)\" &&
        tail -f /dev/null
      "

networks:
  # Public network (internet simulation)
  public:
    driver: bridge
    ipam:
      config:
        - subnet: 10.100.0.0/24

  # Full Cone NAT network
  nat_full_cone:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.1.0/24

  # Restricted Cone NAT network
  nat_restricted:
    driver: bridge
    ipam:
      config:
        - subnet: 172.32.1.0/24

  # Symmetric NAT network
  nat_symmetric:
    driver: bridge
    ipam:
      config:
        - subnet: 172.33.1.0/24
