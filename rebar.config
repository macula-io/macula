%% -*- mode: erlang -*-
%% Macula HTTP/3 Mesh - Root Rebar3 Configuration

{erl_opts, [
    debug_info,
    warnings_as_errors,
    warn_export_vars,
    warn_unused_vars,
    warn_obsolete_guard
]}.

{deps, [
    %% QUIC transport
    {quicer, {git, "https://github.com/emqx/quic.git", {branch, "main"}}},

    %% mDNS for local discovery
    %% Using _checkouts overlay with rebar3 wrapper for erlang.mk-based project
    %% Source: https://github.com/shortishly/mdns (master branch)
    {gproc, "0.9.1"},
    {envy, {git, "https://github.com/shortishly/envy.git", {branch, "master"}}},

    %% JSON encoding for SDK
    {jiffy, "1.1.2"}
]}.

{project_plugins, [
    rebar3_proper,
    rebar3_ex_doc
]}.

%% Test configuration
{cover_enabled, true}.
{cover_opts, [verbose]}.

{ct_opts, [
    {sys_config, "config/test.sys.config"}
]}.

{dialyzer, [
    {warnings, [
        no_return,
        no_unused,
        no_improper_lists,
        no_fun_app,
        no_match,
        no_opaque,
        no_fail_call,
        error_handling
    ]},
    {plt_apps, top_level_deps},
    {plt_extra_apps, []},
    {plt_location, local},
    {base_plt_apps, [erts, kernel, stdlib, crypto, public_key, ssl]},
    {base_plt_location, global}
]}.

%% Shell configuration
{shell, [
    {apps, [macula]},
    {config, "config/sys.config"}
]}.

%% Release configuration
{relx, [
    {release, {macula, "0.1.0"}, [
        macula,
        macula_core,
        macula_quic,
        macula_protocol,
        macula_membership,
        macula_routing,
        macula_topology,
        macula_pubsub,
        macula_rpc,
        macula_discovery,
        macula_security,
        macula_gateway,
        macula_sdk,
        sasl,
        runtime_tools,
        observer
    ]},

    {mode, dev},
    {include_erts, true},
    {extended_start_script, true},

    {sys_config, "./config/sys.config"},
    {vm_args, "./config/vm.args"},

    {overlay, [
        {mkdir, "log"},
        {mkdir, "data"},
        {copy, "README.md", "README.md"},
        {copy, "LICENSE", "LICENSE"}
    ]}
]}.

%% Profiles
{profiles, [
    {test, [
        {deps, [
            {proper, "1.4.0"},
            {meck, "0.9.2"}
        ]},
        {erl_opts, [nowarn_export_all]}
    ]},

    {prod, [
        {erl_opts, [
            no_debug_info,
            deterministic
        ]},
        {relx, [
            {mode, prod},
            {dev_mode, false},
            {include_src, false}
        ]}
    ]},

    {lint, [
        {plugins, [
            {rebar3_lint, "3.2.5"}
        ]}
    ]}
]}.

%% Documentation
{ex_doc, [
    {extras, [
        {"README.md", #{title => "Overview"}},
        {"architecture/macula_http3_mesh_root.md", #{title => "Architecture"}},
        {"LICENSE", #{title => "License"}}
    ]},
    {main, "README.md"},
    {source_url, "https://github.com/macula-io/macula"},
    {prefix_ref_vsn_with_v, false}
]}.

%% Hex package configuration (for future publishing)
{hex, [
    {doc, #{provider => ex_doc}}
]}.
