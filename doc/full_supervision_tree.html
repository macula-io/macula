<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.10.0">


    <title>Supervision Tree — macula v0.10.0</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-074F6B0F.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="readme.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.10.0
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula Full Supervision Tree</h1>


      <a href="https://github.com/macula-io/macula/blob/0.10.0/architecture/FULL_SUPERVISION_TREE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<h2 id="complete-supervision-hierarchy-v0-8-5-always-on-architecture" class="section-heading"><a href="#complete-supervision-hierarchy-v0-8-5-always-on-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Complete Supervision Hierarchy (v0.8.5 Always-On Architecture)</span></h2><p><strong>Date:</strong> 2025-11-18
<strong>Version:</strong> v0.8.5+
<strong>Architecture:</strong> Always-On (all capabilities enabled on every node)
<strong>Based on:</strong> v0.8.5 architectural foundations release</p><hr class="thin"/><h2 id="visual-tree" class="section-heading"><a href="#visual-tree" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Visual Tree</span></h2><pre><code class="makeup erlang" translate="no"><span class="nf">macula</span><span class="w"> </span><span class="p" data-group-id="1781258372-1">(</span><span class="n">OTP</span><span class="w"> </span><span class="ss">application</span><span class="p" data-group-id="1781258372-1">)</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">macula_root</span><span class="w"> </span><span class="p" data-group-id="1781258372-2">[</span><span class="ss">one_for_one</span><span class="p" data-group-id="1781258372-2">]</span><span class="w">
    </span><span class="err">│</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_routing_server</span><span class="w"> </span><span class="p" data-group-id="1781258372-3">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-3">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="nf">infrastructure</span><span class="w"> </span><span class="p" data-group-id="1781258372-4">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="1781258372-4">)</span><span class="w">
    </span><span class="err">│</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">macula_bootstrap_system</span><span class="w"> </span><span class="p" data-group-id="1781258372-5">[</span><span class="ss">one_for_one</span><span class="p" data-group-id="1781258372-5">]</span><span class="w"> </span><span class="p" data-group-id="1781258372-6">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="1781258372-6">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_bootstrap_server</span><span class="w"> </span><span class="p" data-group-id="1781258372-7">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-7">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">queries</span><span class="p">,</span><span class="w"> </span><span class="ss">routing</span><span class="w"> </span><span class="ss">table</span><span class="w"> </span><span class="ss">storage</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_bootstrap_registry</span><span class="w"> </span><span class="p" data-group-id="1781258372-8">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-8">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="nf">registry</span><span class="w"> </span><span class="p" data-group-id="1781258372-9">(</span><span class="ss">advertised</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="ss">endpoints</span><span class="p" data-group-id="1781258372-9">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_bootstrap_health</span><span class="w"> </span><span class="p" data-group-id="1781258372-10">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-10">)</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">System</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">monitoring</span><span class="w">
    </span><span class="err">│</span><span class="w">
    </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">macula_gateway_system</span><span class="w"> </span><span class="p" data-group-id="1781258372-11">[</span><span class="ss">rest_for_one</span><span class="p" data-group-id="1781258372-11">]</span><span class="w"> </span><span class="p" data-group-id="1781258372-12">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="1781258372-12">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_health</span><span class="w"> </span><span class="p" data-group-id="1781258372-13">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-13">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Health</span><span class="w"> </span><span class="ss">check</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="ss">server</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_diagnostics</span><span class="w"> </span><span class="p" data-group-id="1781258372-14">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-14">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Diagnostics</span><span class="w"> </span><span class="ss">service</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_quic_server</span><span class="w"> </span><span class="p" data-group-id="1781258372-15">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-15">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">transport</span><span class="w"> </span><span class="nf">layer</span><span class="w"> </span><span class="p" data-group-id="1781258372-16">(</span><span class="n">UDP</span><span class="w"> </span><span class="ss">listener</span><span class="p" data-group-id="1781258372-16">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway</span><span class="w"> </span><span class="p" data-group-id="1781258372-17">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-17">)</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="ss">routing</span><span class="w"> </span><span class="ss">coordinator</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">macula_gateway_workers_sup</span><span class="w"> </span><span class="p" data-group-id="1781258372-18">[</span><span class="ss">rest_for_one</span><span class="p" data-group-id="1781258372-18">]</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_clients</span><span class="w"> </span><span class="p" data-group-id="1781258372-19">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-19">)</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Client</span><span class="w"> </span><span class="ss">connection</span><span class="w"> </span><span class="ss">tracking</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ss">stream</span><span class="w"> </span><span class="ss">management</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_pubsub</span><span class="w"> </span><span class="p" data-group-id="1781258372-20">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-20">)</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Pub</span><span class="o">/</span><span class="n">Sub</span><span class="w"> </span><span class="ss">message</span><span class="w"> </span><span class="ss">routing</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="ss">wildcards</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_rpc</span><span class="w"> </span><span class="p" data-group-id="1781258372-21">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-21">)</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="ss">handler</span><span class="w"> </span><span class="ss">registration</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ss">management</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
    </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_mesh</span><span class="w"> </span><span class="p" data-group-id="1781258372-22">(</span><span class="ss">worker</span><span class="p" data-group-id="1781258372-22">)</span><span class="w">
    </span><span class="err">│</span><span class="w">           </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="ss">connection</span><span class="w"> </span><span class="nf">pooling</span><span class="w"> </span><span class="p" data-group-id="1781258372-23">(</span><span class="n">LRU</span><span class="p">,</span><span class="w"> </span><span class="ss">max</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="ss">connections</span><span class="p" data-group-id="1781258372-23">)</span><span class="w">
    </span><span class="err">│</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">macula_peers_sup</span><span class="w"> </span><span class="p" data-group-id="1781258372-24">[</span><span class="ss">simple_one_for_one</span><span class="p" data-group-id="1781258372-24">]</span><span class="w"> </span><span class="p" data-group-id="1781258372-25">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="1781258372-25">)</span><span class="w">
        </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="p" data-group-id="1781258372-26">(</span><span class="ss">dynamically</span><span class="w"> </span><span class="ss">spawned</span><span class="w"> </span><span class="ss">macula_peer_system</span><span class="w"> </span><span class="ss">instances</span><span class="p" data-group-id="1781258372-26">)</span></code></pre><hr class="thin"/><h2 id="peer-connections-per-client-peer" class="section-heading"><a href="#peer-connections-per-client-peer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Peer Connections (Per Client/Peer)</span></h2><p>When a peer connects (either as client to gateway, or peer-to-peer), it gets its own supervision tree:</p><pre><code class="makeup erlang" translate="no"><span class="ss">macula_peer_system</span><span class="w"> </span><span class="p" data-group-id="5712059641-1">[</span><span class="ss">rest_for_one</span><span class="p" data-group-id="5712059641-1">]</span><span class="w"> </span><span class="p" data-group-id="5712059641-2">(</span><span class="ss">per</span><span class="w"> </span><span class="ss">connection</span><span class="p" data-group-id="5712059641-2">)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_connection</span><span class="w"> </span><span class="p" data-group-id="5712059641-3">(</span><span class="ss">worker</span><span class="p" data-group-id="5712059641-3">)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">connection</span><span class="w"> </span><span class="nf">lifecycle</span><span class="w"> </span><span class="p" data-group-id="5712059641-4">(</span><span class="ss">transport</span><span class="w"> </span><span class="ss">layer</span><span class="p" data-group-id="5712059641-4">)</span><span class="w">
</span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_pubsub_handler</span><span class="w"> </span><span class="p" data-group-id="5712059641-5">(</span><span class="ss">worker</span><span class="p" data-group-id="5712059641-5">)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">Pub</span><span class="o">/</span><span class="ss">sub</span><span class="w"> </span><span class="ss">operations</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">this</span><span class="w"> </span><span class="ss">peer</span><span class="w">
</span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_rpc_handler</span><span class="w"> </span><span class="p" data-group-id="5712059641-6">(</span><span class="ss">worker</span><span class="p" data-group-id="5712059641-6">)</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="ss">operations</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">this</span><span class="w"> </span><span class="ss">peer</span><span class="w">
</span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_advertisement_manager</span><span class="w"> </span><span class="p" data-group-id="5712059641-7">(</span><span class="ss">worker</span><span class="p" data-group-id="5712059641-7">)</span><span class="w">
    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">service</span><span class="w"> </span><span class="ss">advertisements</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">this</span><span class="w"> </span><span class="ss">peer</span></code></pre><p><strong>Note:</strong> Each peer connection gets its own <code class="inline">macula_peer_system</code> supervisor with dedicated handlers.</p><hr class="thin"/><h2 id="detailed-component-breakdown" class="section-heading"><a href="#detailed-component-breakdown" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Detailed Component Breakdown</span></h2><h3 id="1-application-root-macula_root" class="section-heading"><a href="#1-application-root-macula_root" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Application Root (macula_root)</span></h3><p><strong>Strategy:</strong> <code class="inline">one_for_one</code>
<strong>Intensity:</strong> 10 restarts in 5 seconds</p><p><strong>Children (v0.8.5 - always-on):</strong></p><ol><li><code class="inline">macula_routing_server</code> - Core DHT infrastructure (always on)</li><li><code class="inline">macula_bootstrap_system</code> - Bootstrap services (always on)</li><li><code class="inline">macula_gateway_system</code> - Gateway services (always on)</li><li><code class="inline">macula_peers_sup</code> - Dynamic peer connections supervisor (always on)</li></ol><p><strong>Startup Sequence:</strong></p><ul><li>TLS certificates auto-generated if missing (stable Node ID)</li><li>All subsystems start unconditionally</li><li>Beautiful startup banner displays configuration</li><li>Node ready for P2P mesh participation</li></ul><p><strong>Fault Isolation:</strong></p><ul><li>Routing server crash → Only routing restarts</li><li>Bootstrap system crash → Only bootstrap restarts</li><li>Gateway system crash → Only gateway restarts</li><li>Peers supervisor crash → Only peers supervisor restarts (existing connections preserved)</li><li>Each subsystem is isolated</li></ul><hr class="thin"/><h3 id="2-bootstrap-system-macula_bootstrap_system" class="section-heading"><a href="#2-bootstrap-system-macula_bootstrap_system" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Bootstrap System (macula_bootstrap_system)</span></h3><p><strong>Strategy:</strong> <code class="inline">one_for_one</code>
<strong>Intensity:</strong> 10 restarts in 60 seconds
<strong>Started when:</strong> <code class="inline">mode ∈ {bootstrap, hybrid}</code></p><p><strong>Children (all workers):</strong></p><ol><li><p><strong>macula_bootstrap_server</strong></p><ul><li>Handles DHT queries (FIND_NODE, FIND_VALUE, STORE)</li><li>Stores routing table entries</li><li>Tracks query statistics</li></ul></li><li><p><strong>macula_bootstrap_registry</strong></p><ul><li>Service registry for advertised RPC endpoints</li><li>Generic key/value store for DHT</li><li>Provides lookup API</li></ul></li><li><p><strong>macula_bootstrap_health</strong></p><ul><li>System health monitoring</li><li>Periodic health checks</li><li>Unhealthy service detection</li></ul></li></ol><p><strong>Purpose:</strong></p><ul><li>Provides DHT bootstrap for new peers joining the mesh</li><li>Acts as initial contact point (well-known peer)</li><li>Does NOT route messages (that's gateway's job if enabled)</li></ul><hr class="thin"/><h3 id="3-gateway-system-macula_gateway_system" class="section-heading"><a href="#3-gateway-system-macula_gateway_system" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Gateway System (macula_gateway_system)</span></h3><p><strong>Strategy:</strong> <code class="inline">rest_for_one</code>
<strong>Intensity:</strong> 10 restarts in 60 seconds
<strong>Started when:</strong> <code class="inline">mode ∈ {gateway, hybrid}</code> AND <code class="inline">start_gateway = true</code></p><p><strong>Children (in dependency order):</strong></p><h4>Child 1: macula_gateway_health</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Health check HTTP server</li><li><strong>Port:</strong> Configurable (default 8080)</li><li><strong>Endpoint:</strong> <code class="inline">/health</code></li><li><strong>Crash impact:</strong> Restarts health + diagnostics + quic_server + gateway + workers_sup</li></ul><h4>Child 2: macula_gateway_diagnostics</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Diagnostics service</li><li><strong>Provides:</strong> System metrics, debugging info</li><li><strong>Crash impact:</strong> Restarts diagnostics + quic_server + gateway + workers_sup</li></ul><h4>Child 3: macula_gateway_quic_server</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> QUIC transport layer (UDP listener)</li><li><strong>Port:</strong> Configurable (default 9443, or MACULA_QUIC_PORT)</li><li><strong>Protocol:</strong> HTTP/3 over QUIC</li><li><strong>TLS:</strong> Required (cert/key files)</li><li><strong>Crash impact:</strong> Restarts quic_server + gateway + workers_sup</li></ul><h4>Child 4: macula_gateway</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Message routing coordinator</li><li><strong>Role:</strong> Facade/orchestrator that delegates to worker children</li><li><strong>Crash impact:</strong> Restarts gateway + workers_sup</li></ul><h4>Child 5: macula_gateway_workers_sup</h4><ul><li><strong>Type:</strong> Supervisor</li><li><strong>Strategy:</strong> <code class="inline">rest_for_one</code></li><li><strong>Purpose:</strong> Supervises business logic workers</li><li><strong>Crash impact:</strong> Restarts workers_sup only (quic_server and gateway continue)</li></ul><hr class="thin"/><h3 id="4-gateway-workers-macula_gateway_workers_sup" class="section-heading"><a href="#4-gateway-workers-macula_gateway_workers_sup" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Gateway Workers (macula_gateway_workers_sup)</span></h3><p><strong>Strategy:</strong> <code class="inline">rest_for_one</code>
<strong>Intensity:</strong> 10 restarts in 60 seconds</p><p><strong>Children (in dependency order):</strong></p><h4>Child 1: macula_gateway_clients</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Client connection and stream tracking</li><li><strong>Max clients:</strong> 10,000 (configurable, with backpressure)</li><li><strong>Tracks:</strong> ClientID → {ConnPid, Streams, LastSeen}</li><li><strong>Stream cleanup:</strong> Coordinated map cleanup on disconnect</li><li><strong>Crash impact:</strong> Restarts all workers (foundational)</li></ul><h4>Child 2: macula_gateway_pubsub</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Pub/Sub message routing with wildcards</li><li><strong>Supports:</strong> Topic hierarchies (e.g., <code class="inline">game.events.*</code>)</li><li><strong>Wildcard matching:</strong> Prefix matching for subscriptions</li><li><strong>Crash impact:</strong> Restarts pubsub + rpc + mesh</li></ul><h4>Child 3: macula_gateway_rpc</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> RPC handler registration and management</li><li><strong>Registry:</strong> Procedure → HandlerPid mapping</li><li><strong>Routing:</strong> Local handlers + DHT discovery for remote</li><li><strong>Crash impact:</strong> Restarts rpc + mesh</li></ul><h4>Child 4: macula_gateway_mesh</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Mesh connection pooling and management</li><li><strong>Pool size:</strong> Max 1,000 connections (LRU eviction)</li><li><strong>Connects to:</strong> Other gateways/peers in the mesh</li><li><strong>Purpose:</strong> Efficient connection reuse for multi-hop routing</li><li><strong>Crash impact:</strong> Restarts mesh only</li></ul><hr class="thin"/><h3 id="5-peer-system-macula_peer_system" class="section-heading"><a href="#5-peer-system-macula_peer_system" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">5. Peer System (macula_peer_system)</span></h3><p><strong>Strategy:</strong> <code class="inline">rest_for_one</code>
<strong>Intensity:</strong> 10 restarts in 60 seconds
<strong>Instantiation:</strong> One per peer connection (client or P2P peer)</p><p><strong>Children (in dependency order):</strong></p><h4>Child 1: macula_connection</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> QUIC connection lifecycle (transport layer)</li><li><strong>Role:</strong> Low-level QUIC send/receive, stream management</li><li><strong>Crash impact:</strong> Restarts all peer handlers (foundational)</li></ul><h4>Child 2: macula_pubsub_handler</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> Pub/sub operations for this specific peer</li><li><strong>Operations:</strong> Subscribe, unsubscribe, publish</li><li><strong>Crash impact:</strong> Restarts pubsub + rpc + advertisement</li></ul><h4>Child 3: macula_rpc_handler</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> RPC operations for this specific peer</li><li><strong>Operations:</strong> Register handler, call RPC, handle requests</li><li><strong>Pending calls:</strong> Tracked with correlation IDs and timeouts</li><li><strong>Caller monitoring:</strong> Immediate cleanup on caller death</li><li><strong>Crash impact:</strong> Restarts rpc + advertisement</li></ul><h4>Child 4: macula_advertisement_manager</h4><ul><li><strong>Type:</strong> Worker</li><li><strong>Purpose:</strong> DHT service advertisements for this peer</li><li><strong>Operations:</strong> Advertise service, unadvertise, list active</li><li><strong>TTL:</strong> 5 minutes (configurable)</li><li><strong>Cleanup:</strong> Automatic removal of expired advertisements</li><li><strong>Crash impact:</strong> Restarts advertisement only</li></ul><hr class="thin"/><h2 id="supervision-strategies-explained" class="section-heading"><a href="#supervision-strategies-explained" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Supervision Strategies Explained</span></h2><h3 id="one_for_one" class="section-heading"><a href="#one_for_one" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">one_for_one</span></h3><ul><li><strong>Crash:</strong> Child N crashes</li><li><strong>Restart:</strong> Only child N restarts</li><li><strong>Use case:</strong> Independent children, no dependencies</li></ul><p><strong>Used by:</strong></p><ul><li><code class="inline">macula_root</code> - Core subsystems are independent</li><li><code class="inline">macula_bootstrap_system</code> - Bootstrap workers are independent</li></ul><h3 id="rest_for_one" class="section-heading"><a href="#rest_for_one" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">rest_for_one</span></h3><ul><li><strong>Crash:</strong> Child N crashes</li><li><strong>Restart:</strong> Child N + all children after N restart</li><li><strong>Use case:</strong> Ordered dependencies (later children depend on earlier ones)</li></ul><p><strong>Used by:</strong></p><ul><li><code class="inline">macula_gateway_system</code> - Dependency chain: health → diagnostics → quic → gateway → workers</li><li><code class="inline">macula_gateway_workers_sup</code> - clients is foundational, others depend on it</li><li><code class="inline">macula_peer_system</code> - connection is foundational, handlers depend on it</li></ul><h3 id="simple_one_for_one" class="section-heading"><a href="#simple_one_for_one" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">simple_one_for_one</span></h3><ul><li><strong>Purpose:</strong> Template-based dynamic child spawning</li><li><strong>Restart:</strong> Each child has its own restart strategy (not collective)</li><li><strong>Use case:</strong> Managing many similar children (peer connections)</li></ul><p><strong>Used by:</strong></p><ul><li><code class="inline">macula_peers_sup</code> - Dynamic peer connections (v0.8.5+)</li></ul><hr class="thin"/><h2 id="v0-8-5-always-on-architecture" class="section-heading"><a href="#v0-8-5-always-on-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">v0.8.5 Always-On Architecture</span></h2><p><strong>As of v0.8.5, mode-based configuration has been removed.</strong></p><h3 id="always-on-configuration" class="section-heading"><a href="#always-on-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Always-On Configuration</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">macula_root</span><span class="w"> </span><span class="p" data-group-id="8967175193-1">[</span><span class="ss">one_for_one</span><span class="p" data-group-id="8967175193-1">]</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_routing_server</span><span class="w"> </span><span class="p" data-group-id="8967175193-2">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="8967175193-2">)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_bootstrap_system</span><span class="w"> </span><span class="p" data-group-id="8967175193-3">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="8967175193-3">)</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_gateway_system</span><span class="w"> </span><span class="p" data-group-id="8967175193-4">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="8967175193-4">)</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_peers_sup</span><span class="w"> </span><span class="p" data-group-id="8967175193-5">(</span><span class="ss">always</span><span class="w"> </span><span class="ss">on</span><span class="p" data-group-id="8967175193-5">)</span></code></pre><p><strong>Every node has ALL capabilities:</strong></p><ul><li>✅ DHT routing (core infrastructure)</li><li>✅ Bootstrap service (helps new peers join)</li><li>✅ Gateway with QUIC listener (accepts connections)</li><li>✅ Dynamic peer management (on-demand connections)</li></ul><p><strong>Benefits:</strong></p><ul><li>Zero configuration required</li><li>Simplified deployment (no mode selection)</li><li>True P2P mesh (nodes connect on-demand)</li><li>TLS auto-generated (stable Node ID)</li></ul><p><strong>Environment Variables (v0.8.5+):</strong></p><pre><code class="makeup bash" translate="no"><span class="">MACULA_QUIC_PORT=4433                  # QUIC listener port
</span><span class="">MACULA_REALM=my.realm                  # Realm name
</span><span class="">MACULA_BOOTSTRAP_URL=https://...       # Optional bootstrap peer
</span><span class="">HEALTH_PORT=8080                       # Health check port
</span><span class="">MACULA_CERT_PATH=/path/to/cert.pem    # Optional (auto-generated)
</span><span class="">MACULA_KEY_PATH=/path/to/key.pem      # Optional (auto-generated)
</span></code></pre><h3 id="legacy-mode-configuration-v0-8-4-and-earlier" class="section-heading"><a href="#legacy-mode-configuration-v0-8-4-and-earlier" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Legacy Mode Configuration (v0.8.4 and earlier)</span></h3><p><strong>DEPRECATED:</strong> Mode-based configuration was removed in v0.8.5.</p><p>For historical reference, v0.8.4 supported these modes:</p><ul><li><code class="inline">bootstrap</code> - DHT bootstrap only</li><li><code class="inline">edge</code> - Peer-only (no incoming connections)</li><li><code class="inline">gateway</code> - Gateway routing only</li><li><code class="inline">hybrid</code> - All capabilities (equivalent to v0.8.5 default)</li></ul><hr class="thin"/><h2 id="process-count-estimation" class="section-heading"><a href="#process-count-estimation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Process Count Estimation</span></h2><h3 id="v0-8-5-always-on-architecture-1" class="section-heading"><a href="#v0-8-5-always-on-architecture-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">v0.8.5 Always-On Architecture:</span></h3><pre><code class="makeup erlang" translate="no"><span class="mi">1</span><span class="w">   </span><span class="ss">macula_root</span><span class="w">
</span><span class="mi">1</span><span class="w">   </span><span class="ss">macula_routing_server</span><span class="w">
</span><span class="mi">1</span><span class="w">   </span><span class="ss">macula_bootstrap_system</span><span class="w">
</span><span class="mi">3</span><span class="w">   </span><span class="ss">bootstrap</span><span class="w"> </span><span class="nf">workers</span><span class="w"> </span><span class="p" data-group-id="3410099243-1">(</span><span class="ss">server</span><span class="p">,</span><span class="w"> </span><span class="ss">registry</span><span class="p">,</span><span class="w"> </span><span class="ss">health</span><span class="p" data-group-id="3410099243-1">)</span><span class="w">
</span><span class="mi">1</span><span class="w">   </span><span class="ss">macula_gateway_system</span><span class="w">
</span><span class="mi">5</span><span class="w">   </span><span class="ss">gateway</span><span class="w"> </span><span class="nf">workers</span><span class="w"> </span><span class="p" data-group-id="3410099243-2">(</span><span class="ss">health</span><span class="p">,</span><span class="w"> </span><span class="ss">diagnostics</span><span class="p">,</span><span class="w"> </span><span class="ss">quic</span><span class="p">,</span><span class="w"> </span><span class="ss">gateway</span><span class="p">,</span><span class="w"> </span><span class="ss">workers_sup</span><span class="p" data-group-id="3410099243-2">)</span><span class="w">
</span><span class="mi">4</span><span class="w">   </span><span class="ss">business</span><span class="w"> </span><span class="ss">logic</span><span class="w"> </span><span class="nf">workers</span><span class="w"> </span><span class="p" data-group-id="3410099243-3">(</span><span class="ss">clients</span><span class="p">,</span><span class="w"> </span><span class="ss">pubsub</span><span class="p">,</span><span class="w"> </span><span class="ss">rpc</span><span class="p">,</span><span class="w"> </span><span class="ss">mesh</span><span class="p" data-group-id="3410099243-3">)</span><span class="w">
</span><span class="mi">1</span><span class="w">   </span><span class="ss">macula_peers_sup</span><span class="w">
</span><span class="o">--</span><span class="o">-</span><span class="w">
</span><span class="mi">17</span><span class="w">  </span><span class="nf">processes</span><span class="w"> </span><span class="p" data-group-id="3410099243-4">(</span><span class="ss">base</span><span class="p" data-group-id="3410099243-4">)</span><span class="w">

</span><span class="o">+</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="ss">per</span><span class="w"> </span><span class="ss">peer</span><span class="w"> </span><span class="nf">connection</span><span class="w"> </span><span class="p" data-group-id="3410099243-5">(</span><span class="ss">peer_system</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="ss">handlers</span><span class="p" data-group-id="3410099243-5">)</span></code></pre><p><strong>Example:</strong> Node with 10 peer connections = 17 + (10 × 4) = <strong>57 processes</strong></p><p><strong>Example:</strong> Node with 100 peer connections = 17 + (100 × 4) = <strong>417 processes</strong></p><h3 id="legacy-v0-8-4-for-reference" class="section-heading"><a href="#legacy-v0-8-4-for-reference" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Legacy v0.8.4 (for reference):</span></h3><p><strong>Minimal (edge mode):</strong> 2 processes
<strong>Bootstrap only:</strong> 6 processes
<strong>Gateway only:</strong> 12 processes
<strong>Hybrid:</strong> 16 + (4 × peers) processes</p><hr class="thin"/><h2 id="fault-tolerance-examples" class="section-heading"><a href="#fault-tolerance-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Fault Tolerance Examples</span></h2><h3 id="scenario-1-gateway-worker-crashes" class="section-heading"><a href="#scenario-1-gateway-worker-crashes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 1: Gateway worker crashes</span></h3><pre><code class="makeup erlang" translate="no"><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="ss">macula_gateway_pubsub</span><span class="w"> </span><span class="ss">crashes</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="ss">rest_for_one</span><span class="w"> </span><span class="nc">restarts</span><span class="p">:</span><span class="w"> </span><span class="ss">pubsub</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">rpc</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">mesh</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Clients</span><span class="w"> </span><span class="nf">continue</span><span class="w"> </span><span class="p" data-group-id="2061350334-1">(</span><span class="ss">no</span><span class="w"> </span><span class="ss">disconnection</span><span class="p" data-group-id="2061350334-1">)</span><span class="w">
</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="ss">quic_server</span><span class="w"> </span><span class="nf">continues</span><span class="w"> </span><span class="p" data-group-id="2061350334-2">(</span><span class="ss">no</span><span class="w"> </span><span class="ss">listening</span><span class="w"> </span><span class="ss">disruption</span><span class="p" data-group-id="2061350334-2">)</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Recovery</span><span class="p">:</span><span class="w"> </span><span class="err">~</span><span class="mi">100</span><span class="nf">ms</span><span class="w"> </span><span class="p" data-group-id="2061350334-3">(</span><span class="ss">restart</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">state</span><span class="w"> </span><span class="ss">rebuild</span><span class="p" data-group-id="2061350334-3">)</span></code></pre><h3 id="scenario-2-quic-server-crashes" class="section-heading"><a href="#scenario-2-quic-server-crashes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 2: QUIC server crashes</span></h3><pre><code class="makeup erlang" translate="no"><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="ss">macula_gateway_quic_server</span><span class="w"> </span><span class="ss">crashes</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="ss">rest_for_one</span><span class="w"> </span><span class="nc">restarts</span><span class="p">:</span><span class="w"> </span><span class="ss">quic_server</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">gateway</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">workers_sup</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="ss">workers</span><span class="w"> </span><span class="ss">restart</span><span class="w">
</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">New</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">listener</span><span class="w"> </span><span class="ss">started</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Clients</span><span class="w"> </span><span class="ss">must</span><span class="w"> </span><span class="nf">reconnect</span><span class="w"> </span><span class="p" data-group-id="6717907209-1">(</span><span class="n">UDP</span><span class="w"> </span><span class="ss">listener</span><span class="w"> </span><span class="ss">changed</span><span class="p" data-group-id="6717907209-1">)</span><span class="w">
</span><span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="n">Recovery</span><span class="p">:</span><span class="w"> </span><span class="err">~</span><span class="mi">500</span><span class="nf">ms</span><span class="w"> </span><span class="p" data-group-id="6717907209-2">(</span><span class="ss">full</span><span class="w"> </span><span class="ss">gateway</span><span class="w"> </span><span class="ss">restart</span><span class="p" data-group-id="6717907209-2">)</span></code></pre><h3 id="scenario-3-bootstrap-system-crashes" class="section-heading"><a href="#scenario-3-bootstrap-system-crashes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 3: Bootstrap system crashes</span></h3><pre><code class="makeup erlang" translate="no"><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="ss">macula_bootstrap_system</span><span class="w"> </span><span class="ss">crashes</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="ss">one_for_one</span><span class="w"> </span><span class="nc">restarts</span><span class="p">:</span><span class="w"> </span><span class="ss">bootstrap_system</span><span class="w"> </span><span class="ss">only</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="nf">continues</span><span class="w"> </span><span class="p" data-group-id="9820005854-1">(</span><span class="ss">independent</span><span class="p" data-group-id="9820005854-1">)</span><span class="w">
</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">Routing</span><span class="w"> </span><span class="ss">server</span><span class="w"> </span><span class="nf">continues</span><span class="w"> </span><span class="p" data-group-id="9820005854-2">(</span><span class="ss">independent</span><span class="p" data-group-id="9820005854-2">)</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Recovery</span><span class="p">:</span><span class="w"> </span><span class="err">~</span><span class="mi">200</span><span class="nf">ms</span><span class="w"> </span><span class="p" data-group-id="9820005854-3">(</span><span class="ss">restart</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">bootstrap</span><span class="w"> </span><span class="ss">workers</span><span class="p" data-group-id="9820005854-3">)</span></code></pre><h3 id="scenario-4-peer-connection-handler-crashes" class="section-heading"><a href="#scenario-4-peer-connection-handler-crashes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 4: Peer connection handler crashes</span></h3><pre><code class="makeup erlang" translate="no"><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="nf">macula_rpc_handler</span><span class="w"> </span><span class="p" data-group-id="9689814611-1">(</span><span class="ss">for</span><span class="w"> </span><span class="ss">peer</span><span class="w"> </span><span class="n">X</span><span class="p" data-group-id="9689814611-1">)</span><span class="w"> </span><span class="ss">crashes</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="ss">rest_for_one</span><span class="w"> </span><span class="nc">restarts</span><span class="p">:</span><span class="w"> </span><span class="ss">rpc_handler</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">advertisement_manager</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Peer</span><span class="w"> </span><span class="n">X</span><span class="ss">&#39;s connection and pubsub_handler continue
4. Peer X doesn&#39;</span><span class="ss">t</span><span class="w"> </span><span class="ss">need</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">reconnect</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Recovery</span><span class="p">:</span><span class="w"> </span><span class="err">~</span><span class="mi">50</span><span class="nf">ms</span><span class="w"> </span><span class="p" data-group-id="9689814611-2">(</span><span class="ss">restart</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="ss">handlers</span><span class="p" data-group-id="9689814611-2">)</span></code></pre><hr class="thin"/><h2 id="memory-management" class="section-heading"><a href="#memory-management" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Memory Management</span></h2><p>Each subsystem implements bounded data structures:</p><ol><li><strong>Gateway mesh pool:</strong> Max 1,000 connections (LRU eviction)</li><li><strong>Gateway clients:</strong> Max 10,000 clients (backpressure)</li><li><strong>Service registry:</strong> 5-min TTL with automatic cleanup every 60s</li><li><strong>RPC pending calls:</strong> Monitored caller PIDs (cleanup on death)</li><li><strong>Stream tracking:</strong> Coordinated cleanup on client disconnect</li></ol><p><strong>See:</strong> <code class="inline">architecture/memory_management/</code> for comprehensive details</p><hr class="thin"/><h2 id="configuration" class="section-heading"><a href="#configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration</span></h2><h3 id="environment-variables-v0-8-5" class="section-heading"><a href="#environment-variables-v0-8-5" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Environment Variables (v0.8.5+)</span></h3><pre><code class="makeup bash" translate="no"><span class=""># QUIC configuration
</span><span class="">MACULA_QUIC_PORT=4433                 # QUIC listener port
</span><span class="">MACULA_REALM=macula.arcade            # Realm name
</span><span class="">HEALTH_PORT=8080                      # Health check HTTP port
</span><span class="">
</span><span class=""># TLS certificates (auto-generated if not provided)
</span><span class="">MACULA_CERT_PATH=/var/lib/macula/cert.pem    # Optional
</span><span class="">MACULA_KEY_PATH=/var/lib/macula/key.pem      # Optional
</span><span class="">
</span><span class=""># Bootstrap (optional - for joining existing mesh)
</span><span class="">MACULA_BOOTSTRAP_URL=https://bootstrap:4433
</span><span class="">
</span><span class=""># Legacy support (v0.8.4 compatibility)
</span><span class="">GATEWAY_PORT=4433                     # Falls back to MACULA_QUIC_PORT
</span></code></pre><h3 id="application-config-sys-config-v0-8-5" class="section-heading"><a href="#application-config-sys-config-v0-8-5" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Application Config (sys.config) - v0.8.5+</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="5913740145-1">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5913740145-2">[</span><span class="w">
    </span><span class="p" data-group-id="5913740145-3">{</span><span class="ss">quic_port</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p" data-group-id="5913740145-3">}</span><span class="p">,</span><span class="w">                 </span><span class="c1">% QUIC listener</span><span class="w">
    </span><span class="p" data-group-id="5913740145-4">{</span><span class="ss">realm</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5913740145-5">&lt;&lt;</span><span class="s">&quot;macula.arcade&quot;</span><span class="p" data-group-id="5913740145-5">&gt;&gt;</span><span class="p" data-group-id="5913740145-4">}</span><span class="p">,</span><span class="w">      </span><span class="c1">% Realm name</span><span class="w">
    </span><span class="p" data-group-id="5913740145-6">{</span><span class="ss">health_port</span><span class="p">,</span><span class="w"> </span><span class="mi">8080</span><span class="p" data-group-id="5913740145-6">}</span><span class="p">,</span><span class="w">               </span><span class="c1">% Health check port</span><span class="w">
    </span><span class="p" data-group-id="5913740145-7">{</span><span class="ss">bootstrap_health_interval</span><span class="p">,</span><span class="w"> </span><span class="mi">60000</span><span class="p" data-group-id="5913740145-7">}</span><span class="p">,</span><span class="w"> </span><span class="c1">% Health check interval (ms)</span><span class="w">

    </span><span class="c1">% TLS configuration (optional - auto-generated if missing)</span><span class="w">
    </span><span class="p" data-group-id="5913740145-8">{</span><span class="ss">cert_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/var/lib/macula/cert.pem&quot;</span><span class="p" data-group-id="5913740145-8">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5913740145-9">{</span><span class="ss">key_path</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/var/lib/macula/key.pem&quot;</span><span class="p" data-group-id="5913740145-9">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5913740145-10">{</span><span class="ss">cert_validity_days</span><span class="p">,</span><span class="w"> </span><span class="mi">3650</span><span class="p" data-group-id="5913740145-10">}</span><span class="p">,</span><span class="w">        </span><span class="c1">% 10 years</span><span class="w">
    </span><span class="p" data-group-id="5913740145-11">{</span><span class="ss">cert_key_bits</span><span class="p">,</span><span class="w"> </span><span class="mi">2048</span><span class="p" data-group-id="5913740145-11">}</span><span class="w">              </span><span class="c1">% RSA key size</span><span class="w">
</span><span class="p" data-group-id="5913740145-2">]</span><span class="p" data-group-id="5913740145-1">}</span></code></pre><h3 id="legacy-configuration-v0-8-4" class="section-heading"><a href="#legacy-configuration-v0-8-4" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Legacy Configuration (v0.8.4)</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2748423159-1">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2748423159-2">[</span><span class="w">
    </span><span class="p" data-group-id="2748423159-3">{</span><span class="ss">mode</span><span class="p">,</span><span class="w"> </span><span class="ss">hybrid</span><span class="p" data-group-id="2748423159-3">}</span><span class="p">,</span><span class="w">                    </span><span class="c1">% DEPRECATED in v0.8.5</span><span class="w">
    </span><span class="p" data-group-id="2748423159-4">{</span><span class="ss">start_gateway</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="2748423159-4">}</span><span class="p">,</span><span class="w">             </span><span class="c1">% DEPRECATED in v0.8.5</span><span class="w">
    </span><span class="p" data-group-id="2748423159-5">{</span><span class="ss">gateway_port</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p" data-group-id="2748423159-5">}</span><span class="p">,</span><span class="w">              </span><span class="c1">% Use quic_port in v0.8.5</span><span class="w">
    </span><span class="p" data-group-id="2748423159-6">{</span><span class="ss">gateway_realm</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2748423159-7">&lt;&lt;</span><span class="s">&quot;macula.arcade&quot;</span><span class="p" data-group-id="2748423159-7">&gt;&gt;</span><span class="p" data-group-id="2748423159-6">}</span><span class="w"> </span><span class="c1">% Use realm in v0.8.5</span><span class="w">
</span><span class="p" data-group-id="2748423159-2">]</span><span class="p" data-group-id="2748423159-1">}</span></code></pre><hr class="thin"/><h2 id="related-documents" class="section-heading"><a href="#related-documents" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Related Documents</span></h2><ul><li><code class="inline">architecture/memory_management/</code> - Memory leak prevention and bounded data structures</li><li><code class="inline">architecture/dht_routed_rpc.md</code> - DHT-routed RPC design</li><li><code class="inline">architecture/NAT_TRAVERSAL_ROADMAP.md</code> - v0.8.0/v0.9.0 P2P connectivity</li><li><code class="inline">architecture/v0.9.0-CONSISTENCY-CONCERNS.md</code> - Correlation and consistency patterns</li><li><code class="inline">CODE_REVIEW_REPORT.md</code> - Code quality and health score</li></ul><hr class="thin"/><h2 id="summary" class="section-heading"><a href="#summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Summary</span></h2><p><strong>v0.8.5 Always-On Architecture - Every node runs:</strong></p><ul><li>✅ Core DHT routing (always on)</li><li>✅ Bootstrap service (helps new peers join)</li><li>✅ Gateway with QUIC listener (accepts connections)</li><li>✅ Pub/Sub routing (message forwarding)</li><li>✅ RPC handling (service registry + routing)</li><li>✅ Mesh connections (connection pooling)</li><li>✅ Per-peer handlers (connection + pubsub + rpc + advertisements)</li></ul><p><strong>Total processes:</strong> 17 base + 4 per connected peer</p><p><strong>Zero configuration:</strong></p><ul><li>TLS certificates auto-generated on first boot</li><li>Stable Node ID derived from public key (SHA-256)</li><li>No mode selection needed</li></ul><p><strong>Fault tolerance:</strong> Proper OTP supervision with <code class="inline">one_for_one</code> and <code class="inline">rest_for_one</code> strategies</p><p><strong>Scalability:</strong> Bounded pools prevent unbounded memory growth (see memory management docs)</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="license.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
License
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="v0-8-0-overview.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
v0.8.0 Release Overview
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.10.0" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.10.0">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.10.0/show/architecture/FULL_SUPERVISION_TREE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
