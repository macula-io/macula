<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.9.2">


    <title>Migration Guide v0.8.5 — macula v0.9.2</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-91483A11.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="readme.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.9.2
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Migration Guide: v0.8.4 to v0.8.5</h1>


      <a href="https://github.com/macula-io/macula/blob/0.9.2/architecture/MIGRATION_V0.8.4_TO_V0.8.5.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Date:</strong> 2025-11-18
<strong>Status:</strong> Production-Ready
<strong>Breaking Changes:</strong> None (fully backward compatible)</p><hr class="thin"/><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>v0.8.5 introduces a <strong>zero-configuration, always-on architecture</strong> that eliminates mode-based configuration and automates TLS certificate management. This migration guide helps you understand the changes and upgrade smoothly.</p><p><strong>Good News</strong>: v0.8.5 is <strong>fully backward compatible</strong>. Existing deployments continue to work without any configuration changes.</p><hr class="thin"/><h2 id="what-s-new-in-v0-8-5" class="section-heading"><a href="#what-s-new-in-v0-8-5" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What's New in v0.8.5</span></h2><h3 id="1-always-on-architecture" class="section-heading"><a href="#1-always-on-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Always-On Architecture</span></h3><p><strong>Before (v0.8.4):</strong></p><pre><code class="makeup bash" translate="no"><span class=""># You had to choose a mode
</span><span class="">MACULA_MODE=bootstrap    # Bootstrap node
</span><span class="">MACULA_MODE=edge         # Edge peer (no incoming connections)
</span><span class="">MACULA_MODE=gateway      # Gateway only
</span><span class="">MACULA_MODE=hybrid       # All capabilities
</span></code></pre><p><strong>After (v0.8.5):</strong></p><pre><code class="makeup bash" translate="no"><span class=""># No mode configuration needed
</span><span class=""># Every node has ALL capabilities (bootstrap + gateway + peer)
</span><span class=""># MACULA_MODE is ignored (all nodes are always-on)
</span></code></pre><p><strong>Why?</strong> Mode selection confused users and prevented mass deployment. v0.8.5 simplifies this: every node does everything.</p><h3 id="2-tls-auto-generation" class="section-heading"><a href="#2-tls-auto-generation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. TLS Auto-Generation</span></h3><p><strong>Before (v0.8.4):</strong></p><ul><li>Manual certificate generation required</li><li>No stable Node ID without certificates</li><li>Complex deployment setup</li></ul><p><strong>After (v0.8.5):</strong></p><pre><code class="makeup bash" translate="no"><span class=""># Certificates auto-generated on first boot
</span><span class=""># Node ID derived from public key (SHA-256)
</span><span class=""># Files: /var/lib/macula/cert.pem, /var/lib/macula/key.pem
</span></code></pre><p><strong>Override paths (optional):</strong></p><pre><code class="makeup bash" translate="no"><span class="">MACULA_CERT_PATH=/custom/path/cert.pem
</span><span class="">MACULA_KEY_PATH=/custom/path/key.pem
</span></code></pre><h3 id="3-environment-variable-changes" class="section-heading"><a href="#3-environment-variable-changes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Environment Variable Changes</span></h3><p><strong>New Variables:</strong></p><pre><code class="makeup bash" translate="no"><span class="">MACULA_QUIC_PORT=4433              # Replaces GATEWAY_PORT
</span><span class="">MACULA_CERT_PATH=/path/to/cert.pem  # Optional (auto-generated)
</span><span class="">MACULA_KEY_PATH=/path/to/key.pem    # Optional (auto-generated)
</span></code></pre><p><strong>Deprecated (still work):</strong></p><pre><code class="makeup bash" translate="no"><span class="">GATEWAY_PORT=4433    # Falls back to MACULA_QUIC_PORT
</span><span class="">MACULA_MODE=hybrid   # Ignored (all nodes always-on)
</span></code></pre><hr class="thin"/><h2 id="migration-scenarios" class="section-heading"><a href="#migration-scenarios" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration Scenarios</span></h2><h3 id="scenario-1-existing-hybrid-mode-deployment" class="section-heading"><a href="#scenario-1-existing-hybrid-mode-deployment" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 1: Existing Hybrid Mode Deployment</span></h3><p><strong>Your Current Setup (v0.8.4):</strong></p><pre><code class="makeup bash" translate="no"><span class="">MACULA_MODE=hybrid
</span><span class="">GATEWAY_PORT=4433
</span><span class="">MACULA_REALM=com.example.realm
</span></code></pre><p><strong>Migration Steps:</strong></p><ol><li>Update to v0.8.5 (no config changes needed)</li><li>Redeploy</li><li>Done!</li></ol><p><strong>What Happens:</strong></p><ul><li><code class="inline">MACULA_MODE=hybrid</code> is silently ignored (all nodes are hybrid now)</li><li><code class="inline">GATEWAY_PORT</code> still works (backward compatible)</li><li>If TLS certificates exist, they're reused (Node ID preserved)</li><li>If no certificates, they're auto-generated on first boot</li></ul><p><strong>Optional Cleanup:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># You can remove these (but not required)
</span><span class=""># MACULA_MODE=hybrid  # Not needed anymore
</span><span class=""># Use new variable names (but old ones still work)
</span><span class="">MACULA_QUIC_PORT=4433  # Replaces GATEWAY_PORT
</span></code></pre><h3 id="scenario-2-existing-bootstrap-only-deployment" class="section-heading"><a href="#scenario-2-existing-bootstrap-only-deployment" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 2: Existing Bootstrap-Only Deployment</span></h3><p><strong>Your Current Setup (v0.8.4):</strong></p><pre><code class="makeup bash" translate="no"><span class="">MACULA_MODE=bootstrap
</span><span class="">HEALTH_PORT=8080
</span><span class="">MACULA_REALM=com.example.realm
</span></code></pre><p><strong>Migration Steps:</strong></p><ol><li>Update to v0.8.5</li><li><strong>Important</strong>: Bootstrap node will now also run gateway (QUIC listener)</li><li>Ensure port 4433 (or custom <code class="inline">MACULA_QUIC_PORT</code>) is available</li><li>Redeploy</li></ol><p><strong>What Happens:</strong></p><ul><li>Bootstrap node now has gateway + peer capabilities</li><li>QUIC listener starts on port 4433 (default) or <code class="inline">MACULA_QUIC_PORT</code></li><li>If certificates don't exist, auto-generated</li><li>Node can now accept peer connections (not just DHT queries)</li></ul><p><strong>Configuration After Migration:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># MACULA_MODE=bootstrap  # Not needed anymore
</span><span class="">MACULA_QUIC_PORT=4433     # Explicitly set if needed
</span><span class="">HEALTH_PORT=8080          # Unchanged
</span><span class="">MACULA_REALM=com.example.realm
</span></code></pre><h3 id="scenario-3-existing-edge-only-deployment" class="section-heading"><a href="#scenario-3-existing-edge-only-deployment" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 3: Existing Edge-Only Deployment</span></h3><p><strong>Your Current Setup (v0.8.4):</strong></p><pre><code class="makeup bash" translate="no"><span class="">MACULA_MODE=edge
</span><span class="">MACULA_BOOTSTRAP_URL=https://bootstrap:4433
</span><span class="">MACULA_REALM=com.example.realm
</span></code></pre><p><strong>Migration Steps:</strong></p><ol><li>Update to v0.8.5</li><li><strong>Important</strong>: Edge node will now run bootstrap + gateway</li><li>Ensure port 4433 (or custom <code class="inline">MACULA_QUIC_PORT</code>) is available</li><li>Redeploy</li></ol><p><strong>What Happens:</strong></p><ul><li>Edge node now has bootstrap + gateway capabilities</li><li>Can accept incoming connections (was edge-only before)</li><li>Can help with DHT queries (was edge-only before)</li><li>Can accept peer connections (was edge-only before)</li></ul><p><strong>Configuration After Migration:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># MACULA_MODE=edge  # Not needed anymore
</span><span class="">MACULA_QUIC_PORT=4433  # Set if needed
</span><span class="">MACULA_BOOTSTRAP_URL=https://bootstrap:4433  # Still works
</span><span class="">MACULA_REALM=com.example.realm
</span></code></pre><h3 id="scenario-4-docker-kubernetes-deployment" class="section-heading"><a href="#scenario-4-docker-kubernetes-deployment" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Scenario 4: Docker/Kubernetes Deployment</span></h3><p><strong>Your Current docker-compose.yml (v0.8.4):</strong></p><pre><code class="yaml">services:
  macula-gateway:
    image: registry.local/macula:0.8.4
    environment:
      - MACULA_MODE=hybrid
      - GATEWAY_PORT=4433
      - MACULA_REALM=com.example.realm
    ports:
      - &quot;4433:4433/udp&quot;</code></pre><p><strong>Migration Steps:</strong></p><ol><li>Update image tag to v0.8.5</li><li>(Optional) Update environment variables to new names</li><li>Deploy</li></ol><p><strong>Updated docker-compose.yml (v0.8.5):</strong></p><pre><code class="yaml">services:
  macula-gateway:
    image: registry.local/macula:0.8.5
    environment:
      # MACULA_MODE removed (not needed)
      - MACULA_QUIC_PORT=4433
      - MACULA_REALM=com.example.realm
      # TLS certs auto-generated in container
    ports:
      - &quot;4433:4433/udp&quot;
    volumes:
      # Optional: Persist TLS certificates for stable Node ID
      - macula-certs:/var/lib/macula

volumes:
  macula-certs:</code></pre><p><strong>What Changed:</strong></p><ul><li>Removed <code class="inline">MACULA_MODE</code> (all nodes always-on)</li><li>Changed <code class="inline">GATEWAY_PORT</code> to <code class="inline">MACULA_QUIC_PORT</code> (optional)</li><li>Added volume mount for TLS certificate persistence (recommended)</li></ul><hr class="thin"/><h2 id="tls-certificate-management" class="section-heading"><a href="#tls-certificate-management" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">TLS Certificate Management</span></h2><h3 id="automatic-certificate-generation" class="section-heading"><a href="#automatic-certificate-generation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Automatic Certificate Generation</span></h3><p>v0.8.5 auto-generates TLS certificates on first boot if missing:</p><p><strong>Default Paths:</strong></p><pre><code class="makeup bash" translate="no"><span class="">/var/lib/macula/cert.pem  # Certificate (public)
</span><span class="">/var/lib/macula/key.pem   # Private key (0600 permissions)
</span></code></pre><p><strong>Node ID Derivation:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Node</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SHA</span><span class="o">-</span><span class="mi">256</span><span class="p" data-group-id="3245993765-1">(</span><span class="n">Public</span><span class="w"> </span><span class="n">Key</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="ss">cert</span><span class="p">.</span><span class="ss">pem</span><span class="p" data-group-id="3245993765-1">)</span></code></pre><p><strong>Certificate Properties:</strong></p><ul><li>RSA 2048-bit key</li><li>10-year validity (3650 days)</li><li>Self-signed</li><li>Subject: CN=macula-node</li></ul><h3 id="preserving-node-id-across-deployments" class="section-heading"><a href="#preserving-node-id-across-deployments" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Preserving Node ID Across Deployments</span></h3><p><strong>Problem</strong>: Node ID changes if certificates regenerate on every deployment.</p><p><strong>Solution</strong>: Persist certificates using volume mounts.</p><p><strong>Docker Example:</strong></p><pre><code class="yaml">services:
  macula:
    image: registry.local/macula:0.8.5
    volumes:
      - macula-certs:/var/lib/macula  # Persist certificates
    environment:
      - MACULA_QUIC_PORT=4433

volumes:
  macula-certs:  # Named volume preserves certs</code></pre><p><strong>Kubernetes Example:</strong></p><pre><code class="yaml">apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: macula-certs-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Mi  # Certificates are tiny
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: macula-gateway
spec:
  template:
    spec:
      containers:
      - name: macula
        image: registry.local/macula:0.8.5
        volumeMounts:
        - name: certs
          mountPath: /var/lib/macula
      volumes:
      - name: certs
        persistentVolumeClaim:
          claimName: macula-certs-pvc</code></pre><h3 id="using-custom-certificates" class="section-heading"><a href="#using-custom-certificates" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Using Custom Certificates</span></h3><p>If you want to use your own certificates (e.g., from a CA or cert-manager):</p><pre><code class="makeup bash" translate="no"><span class="">MACULA_CERT_PATH=/custom/path/cert.pem
</span><span class="">MACULA_KEY_PATH=/custom/path/key.pem
</span></code></pre><p><strong>Requirements:</strong></p><ul><li>Must be valid X.509 certificates in PEM format</li><li>Private key must be RSA (2048-bit or higher)</li><li>Certificate and key must match</li></ul><hr class="thin"/><h2 id="verification" class="section-heading"><a href="#verification" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Verification</span></h2><p>After migrating to v0.8.5, verify everything works:</p><h3 id="1-check-startup-banner" class="section-heading"><a href="#1-check-startup-banner" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Check Startup Banner</span></h3><pre><code class="makeup bash" translate="no"><span class="">docker logs &lt;container&gt; | head -20
</span></code></pre><p><strong>Expected Output:</strong></p><pre><code class="makeup erlang" translate="no"><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="w">
  </span><span class="n">Starting</span><span class="w"> </span><span class="n">Macula</span><span class="w"> </span><span class="ss">v0</span><span class="p">.</span><span class="mf">8.5</span><span class="w"> </span><span class="p" data-group-id="3667834274-1">(</span><span class="n">Always</span><span class="o">-</span><span class="n">On</span><span class="w"> </span><span class="n">Architecture</span><span class="p" data-group-id="3667834274-1">)</span><span class="w">
  </span><span class="n">All</span><span class="w"> </span><span class="ss">capabilities</span><span class="w"> </span><span class="nc">enabled</span><span class="p">:</span><span class="w"> </span><span class="n">Bootstrap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Peer</span><span class="w">
</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="w">

</span><span class="err">✓</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="n">Certificate</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="ss">var</span><span class="o">/</span><span class="ss">lib</span><span class="o">/</span><span class="ss">macula</span><span class="o">/</span><span class="ss">cert</span><span class="p">.</span><span class="ss">pem</span><span class="w">
</span><span class="err">✓</span><span class="w"> </span><span class="n">Private</span><span class="w"> </span><span class="n">Key</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="ss">var</span><span class="o">/</span><span class="ss">lib</span><span class="o">/</span><span class="ss">macula</span><span class="o">/</span><span class="ss">key</span><span class="p">.</span><span class="ss">pem</span><span class="w">
</span><span class="err">✓</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="ss">a1b2c3d4e5f6</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="n">Configuration</span><span class="p">:</span><span class="w">
  </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Port</span><span class="p">:</span><span class="w"> </span><span class="mi">4433</span><span class="w">
  </span><span class="n">Realm</span><span class="p">:</span><span class="w"> </span><span class="ss">com</span><span class="p">.</span><span class="ss">example</span><span class="p">.</span><span class="ss">realm</span><span class="w">
  </span><span class="n">Health</span><span class="w"> </span><span class="n">Port</span><span class="p">:</span><span class="w"> </span><span class="mi">8080</span><span class="w">
  </span><span class="n">Bootstrap</span><span class="w"> </span><span class="n">Health</span><span class="w"> </span><span class="n">Interval</span><span class="p">:</span><span class="w"> </span><span class="mi">60000</span><span class="ss">ms</span><span class="w">

</span><span class="n">Starting</span><span class="w"> </span><span class="nc">subsystems</span><span class="p">:</span><span class="w">
  </span><span class="p" data-group-id="3667834274-2">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p" data-group-id="3667834274-2">]</span><span class="w"> </span><span class="n">Core</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="n">Routing</span><span class="w">
  </span><span class="p" data-group-id="3667834274-3">[</span><span class="mi">2</span><span class="o">/</span><span class="mi">4</span><span class="p" data-group-id="3667834274-3">]</span><span class="w"> </span><span class="n">Bootstrap</span><span class="w"> </span><span class="n">System</span><span class="w">
  </span><span class="p" data-group-id="3667834274-4">[</span><span class="mi">3</span><span class="o">/</span><span class="mi">4</span><span class="p" data-group-id="3667834274-4">]</span><span class="w"> </span><span class="n">Gateway</span><span class="w"> </span><span class="n">System</span><span class="w">
  </span><span class="p" data-group-id="3667834274-5">[</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span><span class="p" data-group-id="3667834274-5">]</span><span class="w"> </span><span class="n">Peers</span><span class="w"> </span><span class="n">Supervisor</span></code></pre><h3 id="2-check-processes" class="section-heading"><a href="#2-check-processes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Check Processes</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Connect to running node
</span><span class="">docker exec -it &lt;container&gt; rebar3 shell
</span><span class="">
</span><span class=""># List supervisor tree
</span><span class="">1&gt; observer:start().  % Graphical observer (if X11 available)
</span><span class="">2&gt; supervisor:which_children(macula_root).
</span></code></pre><p><strong>Expected Output:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="0676813688-1">[</span><span class="w">
 </span><span class="p" data-group-id="0676813688-2">{</span><span class="ss">macula_peers_sup</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">0.123</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">supervisor</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0676813688-3">[</span><span class="ss">macula_peers_sup</span><span class="p" data-group-id="0676813688-3">]</span><span class="p" data-group-id="0676813688-2">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="0676813688-4">{</span><span class="ss">macula_gateway_system</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">0.122</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">supervisor</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0676813688-5">[</span><span class="ss">macula_gateway_system</span><span class="p" data-group-id="0676813688-5">]</span><span class="p" data-group-id="0676813688-4">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="0676813688-6">{</span><span class="ss">macula_bootstrap_system</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">0.121</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">supervisor</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0676813688-7">[</span><span class="ss">macula_bootstrap_system</span><span class="p" data-group-id="0676813688-7">]</span><span class="p" data-group-id="0676813688-6">}</span><span class="p">,</span><span class="w">
 </span><span class="p" data-group-id="0676813688-8">{</span><span class="ss">macula_routing_server</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="mf">0.120</span><span class="p">.</span><span class="mi">0</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">worker</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0676813688-9">[</span><span class="ss">macula_routing_server</span><span class="p" data-group-id="0676813688-9">]</span><span class="p" data-group-id="0676813688-8">}</span><span class="w">
</span><span class="p" data-group-id="0676813688-1">]</span></code></pre><h3 id="3-check-health-endpoint" class="section-heading"><a href="#3-check-health-endpoint" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Check Health Endpoint</span></h3><pre><code class="makeup bash" translate="no"><span class="">curl http://localhost:8080/health
</span></code></pre><p><strong>Expected Output:</strong></p><pre><code class="json">{
  &quot;status&quot;: &quot;ok&quot;,
  &quot;node_id&quot;: &quot;a1b2c3d4e5f6...&quot;,
  &quot;version&quot;: &quot;0.8.5&quot;,
  &quot;realm&quot;: &quot;com.example.realm&quot;,
  &quot;uptime_seconds&quot;: 123
}</code></pre><h3 id="4-verify-tls-certificate" class="section-heading"><a href="#4-verify-tls-certificate" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Verify TLS Certificate</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Check certificate exists
</span><span class="">docker exec &lt;container&gt; ls -lh /var/lib/macula/
</span></code></pre><p><strong>Expected Output:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">rw</span><span class="o">-</span><span class="ss">r</span><span class="o">--</span><span class="ss">r</span><span class="o">--</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">root</span><span class="w"> </span><span class="ss">root</span><span class="w"> </span><span class="mf">1.2</span><span class="n">K</span><span class="w"> </span><span class="n">Nov</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="ss">cert</span><span class="p">.</span><span class="ss">pem</span><span class="w">
</span><span class="p">-</span><span class="na">rw</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">root</span><span class="w"> </span><span class="ss">root</span><span class="w"> </span><span class="mf">1.7</span><span class="n">K</span><span class="w"> </span><span class="n">Nov</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="w"> </span><span class="ss">key</span><span class="p">.</span><span class="ss">pem</span></code></pre><p><strong>Note</strong>: Private key has 0600 permissions (read/write owner only)</p><h3 id="5-derive-node-id-manually" class="section-heading"><a href="#5-derive-node-id-manually" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">5. Derive Node ID Manually</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Extract public key from certificate
</span><span class="">docker exec &lt;container&gt; openssl x509 -in /var/lib/macula/cert.pem -pubkey -noout &gt; pubkey.pem
</span><span class="">
</span><span class=""># Compute SHA-256
</span><span class="">docker exec &lt;container&gt; openssl pkey -pubin -in pubkey.pem -outform DER | sha256sum
</span></code></pre><p><strong>Result</strong>: Should match Node ID shown in startup banner</p><hr class="thin"/><h2 id="troubleshooting" class="section-heading"><a href="#troubleshooting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Troubleshooting</span></h2><h3 id="issue-1-port-4433-already-in-use" class="section-heading"><a href="#issue-1-port-4433-already-in-use" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Issue 1: Port 4433 Already in Use</span></h3><p><strong>Error:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="9077257386-1">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">eaddrinuse</span><span class="p" data-group-id="9077257386-1">}</span></code></pre><p><strong>Solution:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># Option 1: Use different port
</span><span class="">MACULA_QUIC_PORT=4434
</span><span class="">
</span><span class=""># Option 2: Stop conflicting service
</span><span class="">sudo lsof -i :4433
</span><span class="">sudo kill &lt;pid&gt;
</span></code></pre><h3 id="issue-2-tls-certificate-generation-fails" class="section-heading"><a href="#issue-2-tls-certificate-generation-fails" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Issue 2: TLS Certificate Generation Fails</span></h3><p><strong>Error:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="1914130748-1">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1914130748-2">{</span><span class="ss">openssl_failed</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;openssl: command not found&quot;</span><span class="p" data-group-id="1914130748-2">}</span><span class="p" data-group-id="1914130748-1">}</span></code></pre><p><strong>Solution:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># Install OpenSSL in container
</span><span class="">apt-get update &amp;&amp; apt-get install -y openssl
</span><span class="">
</span><span class=""># Or rebuild Docker image with OpenSSL
</span></code></pre><h3 id="issue-3-node-id-changes-on-every-restart" class="section-heading"><a href="#issue-3-node-id-changes-on-every-restart" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Issue 3: Node ID Changes on Every Restart</span></h3><p><strong>Problem</strong>: Certificates regenerate on every restart.</p><p><strong>Solution</strong>: Persist certificates using volume mounts (see &quot;Preserving Node ID&quot; above)</p><h3 id="issue-4-old-environment-variables-not-working" class="section-heading"><a href="#issue-4-old-environment-variables-not-working" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Issue 4: Old Environment Variables Not Working</span></h3><p><strong>Problem</strong>: <code class="inline">GATEWAY_PORT</code> not recognized.</p><p><strong>Solution</strong>: Check you're running v0.8.5:</p><pre><code class="makeup bash" translate="no"><span class="">docker exec &lt;container&gt; rebar3 shell
</span><span class="">1&gt; application:get_key(macula, vsn).
</span><span class="">{ok, &quot;0.8.5&quot;}
</span></code></pre><p>If version is correct and <code class="inline">GATEWAY_PORT</code> still doesn't work, use <code class="inline">MACULA_QUIC_PORT</code> instead.</p><hr class="thin"/><h2 id="rollback-plan" class="section-heading"><a href="#rollback-plan" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Rollback Plan</span></h2><p>If you encounter issues with v0.8.5 and need to rollback:</p><h3 id="step-1-revert-to-v0-8-4" class="section-heading"><a href="#step-1-revert-to-v0-8-4" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 1: Revert to v0.8.4</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Docker
</span><span class="">docker pull registry.local/macula:0.8.4
</span><span class="">
</span><span class=""># Kubernetes
</span><span class="">kubectl set image deployment/macula macula=registry.local/macula:0.8.4
</span></code></pre><h3 id="step-2-restore-configuration" class="section-heading"><a href="#step-2-restore-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 2: Restore Configuration</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Re-add mode configuration (required in v0.8.4)
</span><span class="">MACULA_MODE=hybrid  # Or bootstrap/edge/gateway
</span><span class="">GATEWAY_PORT=4433   # v0.8.4 uses GATEWAY_PORT
</span></code></pre><h3 id="step-3-remove-v0-8-5-features" class="section-heading"><a href="#step-3-remove-v0-8-5-features" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 3: Remove v0.8.5 Features</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Remove v0.8.5 environment variables
</span><span class=""># MACULA_QUIC_PORT  # Not in v0.8.4
</span><span class=""># MACULA_CERT_PATH  # Not in v0.8.4
</span><span class=""># MACULA_KEY_PATH   # Not in v0.8.4
</span></code></pre><h3 id="step-4-redeploy" class="section-heading"><a href="#step-4-redeploy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 4: Redeploy</span></h3><pre><code class="makeup bash" translate="no"><span class="">docker-compose down
</span><span class="">docker-compose up -d
</span></code></pre><p><strong>Note</strong>: If you persisted TLS certificates, Node ID will remain stable across rollback/upgrade.</p><hr class="thin"/><h2 id="faq" class="section-heading"><a href="#faq" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">FAQ</span></h2><h3 id="q1-will-my-node-id-change-after-upgrade" class="section-heading"><a href="#q1-will-my-node-id-change-after-upgrade" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q1: Will my Node ID change after upgrade?</span></h3><p><strong>A</strong>: No, if you have existing TLS certificates. v0.8.5 reuses existing certificates.</p><p><strong>B</strong>: Yes, if you don't have certificates AND don't persist them. Use volume mounts to persist.</p><h3 id="q2-do-i-need-to-update-my-configuration" class="section-heading"><a href="#q2-do-i-need-to-update-my-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q2: Do I need to update my configuration?</span></h3><p><strong>A</strong>: No. v0.8.5 is fully backward compatible. Old configuration continues to work.</p><p><strong>B</strong>: Optional: Update to new variable names (<code class="inline">MACULA_QUIC_PORT</code> instead of <code class="inline">GATEWAY_PORT</code>)</p><h3 id="q3-what-if-i-want-edge-only-nodes-no-incoming-connections" class="section-heading"><a href="#q3-what-if-i-want-edge-only-nodes-no-incoming-connections" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q3: What if I want edge-only nodes (no incoming connections)?</span></h3><p><strong>A</strong>: v0.8.5 doesn't support edge-only mode. All nodes run gateway (QUIC listener).</p><p><strong>Workaround</strong>: Use firewall rules to block incoming connections on port 4433.</p><pre><code class="makeup bash" translate="no"><span class=""># Block incoming connections (but allow outgoing)
</span><span class="">iptables -A INPUT -p udp --dport 4433 -j DROP
</span></code></pre><h3 id="q4-can-i-use-my-own-tls-certificates" class="section-heading"><a href="#q4-can-i-use-my-own-tls-certificates" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q4: Can I use my own TLS certificates?</span></h3><p><strong>A</strong>: Yes. Set <code class="inline">MACULA_CERT_PATH</code> and <code class="inline">MACULA_KEY_PATH</code> to your certificate paths.</p><h3 id="q5-how-do-i-monitor-tls-certificate-expiration" class="section-heading"><a href="#q5-how-do-i-monitor-tls-certificate-expiration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q5: How do I monitor TLS certificate expiration?</span></h3><p><strong>A</strong>: Auto-generated certificates have 10-year validity. Check expiration:</p><pre><code class="makeup bash" translate="no"><span class="">openssl x509 -in /var/lib/macula/cert.pem -noout -dates
</span></code></pre><p><strong>Output:</strong></p><pre><code class="makeup erlang" translate="no"><span class="ss">notBefore</span><span class="o">=</span><span class="n">Nov</span><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">56</span><span class="w"> </span><span class="mi">2025</span><span class="w"> </span><span class="n">GMT</span><span class="w">
</span><span class="ss">notAfter</span><span class="o">=</span><span class="n">Nov</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">56</span><span class="w"> </span><span class="mi">2035</span><span class="w"> </span><span class="n">GMT</span></code></pre><h3 id="q6-what-happens-if-i-run-out-of-disk-space-for-certificates" class="section-heading"><a href="#q6-what-happens-if-i-run-out-of-disk-space-for-certificates" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q6: What happens if I run out of disk space for certificates?</span></h3><p><strong>A</strong>: Certificate files are tiny (~3KB total). Disk space is not a concern.</p><h3 id="q7-can-i-deploy-v0-8-5-alongside-v0-8-4-nodes" class="section-heading"><a href="#q7-can-i-deploy-v0-8-5-alongside-v0-8-4-nodes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Q7: Can I deploy v0.8.5 alongside v0.8.4 nodes?</span></h3><p><strong>A</strong>: Yes. v0.8.5 is wire-compatible with v0.8.4. You can have mixed versions in the mesh.</p><hr class="thin"/><h2 id="summary" class="section-heading"><a href="#summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Summary</span></h2><p>v0.8.5 simplifies deployment with:</p><ul><li>✅ <strong>Zero configuration</strong> - No mode selection needed</li><li>✅ <strong>TLS auto-generation</strong> - Certificates created on first boot</li><li>✅ <strong>Backward compatibility</strong> - Existing configs continue to work</li><li>✅ <strong>Stable Node IDs</strong> - Derived from public key (SHA-256)</li><li>✅ <strong>Production-ready</strong> - 44/44 tests passing, no regressions</li></ul><p><strong>Recommended Migration Path</strong>:</p><ol><li>Update to v0.8.5</li><li>Add volume mounts for TLS certificate persistence</li><li>(Optional) Update environment variable names</li><li>Redeploy</li><li>Verify startup banner shows v0.8.5</li><li>Done!</li></ol><p><strong>No configuration changes required</strong> - just update and redeploy.</p><hr class="thin"/><h2 id="support" class="section-heading"><a href="#support" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Support</span></h2><p>If you encounter issues during migration:</p><ul><li><strong>GitHub Issues</strong>: <a href="https://github.com/macula-io/macula/issues">https://github.com/macula-io/macula/issues</a></li><li><strong>Documentation</strong>: <code class="inline">architecture/FULL_SUPERVISION_TREE.md</code></li><li><strong>Changelog</strong>: <code class="inline">CHANGELOG.md</code></li><li><strong>Test Coverage</strong>: Run <code class="inline">rebar3 eunit</code> to verify everything works</li></ul><p><strong>Remember</strong>: v0.8.5 is fully backward compatible. Your existing deployment will continue to work without any changes.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="changelog.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Changelog
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="todo.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Known Issues & Roadmap
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.9.2" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.9.2">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.9.2/show/architecture/MIGRATION_V0.8.4_TO_V0.8.5.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
