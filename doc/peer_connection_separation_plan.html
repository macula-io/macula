<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.7.7">


    <title>Peer-Connection Refactoring — macula v0.7.7</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-62100C5B.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="hello_world.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="hello_world.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.7.7
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Peer-Connection Separation: TDD Implementation Plan</h1>


      <a href="https://github.com/macula-io/macula/blob/0.7.7/docs/PEER_CONNECTION_SEPARATION_PLAN.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Date:</strong> 2025-11-15
<strong>Target Version:</strong> 0.6.0
<strong>Approach:</strong> Option B - Full separation with comprehensive test coverage</p><hr class="thin"/><h2 id="executive-summary" class="section-heading"><a href="#executive-summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Executive Summary</span></h2><p>Split <code class="inline">macula_connection</code> into two distinct responsibilities:</p><ol><li><strong><code class="inline">macula_peer</code></strong> - High-level mesh participant (pub/sub, RPC, DHT)</li><li><strong><code class="inline">macula_connection</code></strong> - Low-level QUIC transport</li></ol><p><strong>Strategy:</strong> Test-Driven Development with no regression</p><hr class="thin"/><h2 id="current-test-coverage" class="section-heading"><a href="#current-test-coverage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Current Test Coverage</span></h2><h3 id="existing-test-files-144-tests-total" class="section-heading"><a href="#existing-test-files-144-tests-total" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Existing Test Files (144 tests total)</span></h3><table><thead><tr><th style="text-align: left;">Test File</th><th style="text-align: left;">Tests</th><th style="text-align: left;">Coverage</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">macula_connection_error_tests.erl</code></td><td style="text-align: left;">25</td><td style="text-align: left;">Error handling</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_manager_tests.erl</code></td><td style="text-align: left;">25</td><td style="text-align: left;">QUIC lifecycle</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_rpc_tests.erl</code></td><td style="text-align: left;">25</td><td style="text-align: left;">RPC operations</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_pool_tests.erl</code></td><td style="text-align: left;">19</td><td style="text-align: left;">Connection pooling</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_sup_tests.erl</code></td><td style="text-align: left;">15</td><td style="text-align: left;">Supervision</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_protocol_tests.erl</code></td><td style="text-align: left;">14</td><td style="text-align: left;">Protocol encoding</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_tests.erl</code></td><td style="text-align: left;">11</td><td style="text-align: left;">Facade API</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_pubsub_tests.erl</code></td><td style="text-align: left;">10</td><td style="text-align: left;">Pub/sub operations</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_integration_tests.erl</code></td><td style="text-align: left;">0</td><td style="text-align: left;">Integration (empty)</td></tr><tr><td style="text-align: left;"><code class="inline">macula_connection_pattern_qos_tests.erl</code></td><td style="text-align: left;">0</td><td style="text-align: left;">QoS patterns (empty)</td></tr></tbody></table><p><strong>Total:</strong> 144 test functions across 10 files</p><hr class="thin"/><h2 id="target-architecture" class="section-heading"><a href="#target-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Target Architecture</span></h2><h3 id="macula_peer-erl-mesh-participant-api" class="section-heading"><a href="#macula_peer-erl-mesh-participant-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_peer.erl - Mesh Participant API</span></h3><p><strong>Responsibilities:</strong></p><ul><li>Mesh-level operations (pub/sub, RPC, service discovery)</li><li>DHT participation and peer discovery</li><li>Peer identity management (node ID, realm)</li><li>Application-facing high-level API</li></ul><p><strong>API:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Lifecycle</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="3802870875-1">(</span><span class="n">PeerOpts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="3802870875-2">(</span><span class="p" data-group-id="3802870875-2">)</span><span class="p" data-group-id="3802870875-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-4">(</span><span class="p" data-group-id="3802870875-4">)</span><span class="p" data-group-id="3802870875-3">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-6">(</span><span class="p" data-group-id="3802870875-6">)</span><span class="p" data-group-id="3802870875-5">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">stop</span><span class="p" data-group-id="3802870875-7">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-8">(</span><span class="p" data-group-id="3802870875-8">)</span><span class="p" data-group-id="3802870875-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">get_info</span><span class="p" data-group-id="3802870875-9">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-10">(</span><span class="p" data-group-id="3802870875-10">)</span><span class="p" data-group-id="3802870875-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-11">#{</span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-12">(</span><span class="p" data-group-id="3802870875-12">)</span><span class="p">,</span><span class="w"> </span><span class="ss">realm</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-13">(</span><span class="p" data-group-id="3802870875-13">)</span><span class="p">,</span><span class="w"> </span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">atom</span><span class="p" data-group-id="3802870875-14">(</span><span class="p" data-group-id="3802870875-14">)</span><span class="p" data-group-id="3802870875-11">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Pub/Sub (mesh-level)</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">publish</span><span class="p" data-group-id="3802870875-15">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-16">(</span><span class="p" data-group-id="3802870875-16">)</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-17">(</span><span class="p" data-group-id="3802870875-17">)</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-18">(</span><span class="p" data-group-id="3802870875-18">)</span><span class="p" data-group-id="3802870875-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-19">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-20">(</span><span class="p" data-group-id="3802870875-20">)</span><span class="p" data-group-id="3802870875-19">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">publish</span><span class="p" data-group-id="3802870875-21">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-22">(</span><span class="p" data-group-id="3802870875-22">)</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-23">(</span><span class="p" data-group-id="3802870875-23">)</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-24">(</span><span class="p" data-group-id="3802870875-24">)</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="3802870875-25">(</span><span class="p" data-group-id="3802870875-25">)</span><span class="p" data-group-id="3802870875-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-26">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-27">(</span><span class="p" data-group-id="3802870875-27">)</span><span class="p" data-group-id="3802870875-26">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">subscribe</span><span class="p" data-group-id="3802870875-28">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-29">(</span><span class="p" data-group-id="3802870875-29">)</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-30">(</span><span class="p" data-group-id="3802870875-30">)</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3802870875-31">(</span><span class="p" data-group-id="3802870875-31">)</span><span class="p" data-group-id="3802870875-28">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-32">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">reference</span><span class="p" data-group-id="3802870875-33">(</span><span class="p" data-group-id="3802870875-33">)</span><span class="p" data-group-id="3802870875-32">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-34">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-35">(</span><span class="p" data-group-id="3802870875-35">)</span><span class="p" data-group-id="3802870875-34">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">unsubscribe</span><span class="p" data-group-id="3802870875-36">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-37">(</span><span class="p" data-group-id="3802870875-37">)</span><span class="p">,</span><span class="w"> </span><span class="n">SubRef</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">reference</span><span class="p" data-group-id="3802870875-38">(</span><span class="p" data-group-id="3802870875-38">)</span><span class="p" data-group-id="3802870875-36">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-39">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-40">(</span><span class="p" data-group-id="3802870875-40">)</span><span class="p" data-group-id="3802870875-39">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% RPC (mesh-level)</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">call</span><span class="p" data-group-id="3802870875-41">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-42">(</span><span class="p" data-group-id="3802870875-42">)</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-43">(</span><span class="p" data-group-id="3802870875-43">)</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-44">(</span><span class="p" data-group-id="3802870875-44">)</span><span class="p" data-group-id="3802870875-41">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-45">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-46">(</span><span class="p" data-group-id="3802870875-46">)</span><span class="p" data-group-id="3802870875-45">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-47">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-48">(</span><span class="p" data-group-id="3802870875-48">)</span><span class="p" data-group-id="3802870875-47">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">call</span><span class="p" data-group-id="3802870875-49">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-50">(</span><span class="p" data-group-id="3802870875-50">)</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-51">(</span><span class="p" data-group-id="3802870875-51">)</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-52">(</span><span class="p" data-group-id="3802870875-52">)</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="3802870875-53">(</span><span class="p" data-group-id="3802870875-53">)</span><span class="p" data-group-id="3802870875-49">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-54">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-55">(</span><span class="p" data-group-id="3802870875-55">)</span><span class="p" data-group-id="3802870875-54">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-56">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-57">(</span><span class="p" data-group-id="3802870875-57">)</span><span class="p" data-group-id="3802870875-56">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">advertise</span><span class="p" data-group-id="3802870875-58">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-59">(</span><span class="p" data-group-id="3802870875-59">)</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-60">(</span><span class="p" data-group-id="3802870875-60">)</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3802870875-61">(</span><span class="p" data-group-id="3802870875-61">)</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="3802870875-62">(</span><span class="p" data-group-id="3802870875-62">)</span><span class="p" data-group-id="3802870875-58">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-63">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-64">(</span><span class="p" data-group-id="3802870875-64">)</span><span class="p" data-group-id="3802870875-63">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">unadvertise</span><span class="p" data-group-id="3802870875-65">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-66">(</span><span class="p" data-group-id="3802870875-66">)</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-67">(</span><span class="p" data-group-id="3802870875-67">)</span><span class="p" data-group-id="3802870875-65">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-68">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-69">(</span><span class="p" data-group-id="3802870875-69">)</span><span class="p" data-group-id="3802870875-68">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% DHT/Mesh Operations</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">discover_peers</span><span class="p" data-group-id="3802870875-70">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-71">(</span><span class="p" data-group-id="3802870875-71">)</span><span class="p">,</span><span class="w"> </span><span class="n">Realm</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-72">(</span><span class="p" data-group-id="3802870875-72">)</span><span class="p" data-group-id="3802870875-70">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-73">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3802870875-74">[</span><span class="nf">peer_info</span><span class="p" data-group-id="3802870875-75">(</span><span class="p" data-group-id="3802870875-75">)</span><span class="p" data-group-id="3802870875-74">]</span><span class="p" data-group-id="3802870875-73">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-76">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-77">(</span><span class="p" data-group-id="3802870875-77">)</span><span class="p" data-group-id="3802870875-76">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">find_service</span><span class="p" data-group-id="3802870875-78">(</span><span class="n">Peer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="3802870875-79">(</span><span class="p" data-group-id="3802870875-79">)</span><span class="p">,</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="3802870875-80">(</span><span class="p" data-group-id="3802870875-80">)</span><span class="p" data-group-id="3802870875-78">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3802870875-81">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3802870875-82">[</span><span class="nf">endpoint</span><span class="p" data-group-id="3802870875-83">(</span><span class="p" data-group-id="3802870875-83">)</span><span class="p" data-group-id="3802870875-82">]</span><span class="p" data-group-id="3802870875-81">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3802870875-84">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3802870875-85">(</span><span class="p" data-group-id="3802870875-85">)</span><span class="p" data-group-id="3802870875-84">}</span><span class="p">.</span></code></pre><p><strong>State:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="7553372269-1">(</span><span class="ss">peer_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7553372269-2">{</span><span class="w">
    </span><span class="ss">node_id</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="7553372269-3">(</span><span class="p" data-group-id="7553372269-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">realm</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="7553372269-4">(</span><span class="p" data-group-id="7553372269-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">status</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="ss">connecting</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">connected</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">disconnected</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Child process PIDs</span><span class="w">
    </span><span class="ss">connection_pid</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="7553372269-5">(</span><span class="p" data-group-id="7553372269-5">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">      </span><span class="c1">%% macula_connection</span><span class="w">
    </span><span class="ss">pubsub_handler_pid</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="7553372269-6">(</span><span class="p" data-group-id="7553372269-6">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">  </span><span class="c1">%% macula_pubsub_handler</span><span class="w">
    </span><span class="ss">rpc_handler_pid</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="7553372269-7">(</span><span class="p" data-group-id="7553372269-7">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">     </span><span class="c1">%% macula_rpc_handler</span><span class="w">
    </span><span class="ss">advertisement_manager_pid</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="7553372269-8">(</span><span class="p" data-group-id="7553372269-8">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">  </span><span class="c1">%% macula_advertisement_manager</span><span class="w">

    </span><span class="c1">%% Mesh-level state</span><span class="w">
    </span><span class="ss">subscriptions</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7553372269-9">#{</span><span class="nf">reference</span><span class="p" data-group-id="7553372269-10">(</span><span class="p" data-group-id="7553372269-10">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">subscription</span><span class="p" data-group-id="7553372269-11">(</span><span class="p" data-group-id="7553372269-11">)</span><span class="p" data-group-id="7553372269-9">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">advertised_services</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7553372269-12">#{</span><span class="nf">binary</span><span class="p" data-group-id="7553372269-13">(</span><span class="p" data-group-id="7553372269-13">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">handler</span><span class="p" data-group-id="7553372269-14">(</span><span class="p" data-group-id="7553372269-14">)</span><span class="p" data-group-id="7553372269-12">}</span><span class="w">
</span><span class="p" data-group-id="7553372269-2">}</span><span class="p" data-group-id="7553372269-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h3 id="macula_connection-erl-quic-transport-layer" class="section-heading"><a href="#macula_connection-erl-quic-transport-layer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_connection.erl - QUIC Transport Layer</span></h3><p><strong>Responsibilities:</strong></p><ul><li>QUIC connection establishment and lifecycle</li><li>Stream management (send/receive)</li><li>Message encoding/decoding</li><li>Reconnection and error handling</li><li>Transport-level concerns ONLY</li></ul><p><strong>API:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Lifecycle</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="2795570465-1">(</span><span class="n">ConnectionOpts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="2795570465-2">(</span><span class="p" data-group-id="2795570465-2">)</span><span class="p" data-group-id="2795570465-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2795570465-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-4">(</span><span class="p" data-group-id="2795570465-4">)</span><span class="p" data-group-id="2795570465-3">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="2795570465-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="2795570465-6">(</span><span class="p" data-group-id="2795570465-6">)</span><span class="p" data-group-id="2795570465-5">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">stop</span><span class="p" data-group-id="2795570465-7">(</span><span class="n">Connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-8">(</span><span class="p" data-group-id="2795570465-8">)</span><span class="p" data-group-id="2795570465-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">get_status</span><span class="p" data-group-id="2795570465-9">(</span><span class="n">Connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-10">(</span><span class="p" data-group-id="2795570465-10">)</span><span class="p" data-group-id="2795570465-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">connecting</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">connected</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">disconnected</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">error</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Transport operations</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">send</span><span class="p" data-group-id="2795570465-11">(</span><span class="n">Connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-12">(</span><span class="p" data-group-id="2795570465-12">)</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="2795570465-13">(</span><span class="p" data-group-id="2795570465-13">)</span><span class="p" data-group-id="2795570465-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="2795570465-14">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="2795570465-15">(</span><span class="p" data-group-id="2795570465-15">)</span><span class="p" data-group-id="2795570465-14">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">send_message</span><span class="p" data-group-id="2795570465-16">(</span><span class="n">Connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-17">(</span><span class="p" data-group-id="2795570465-17">)</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">atom</span><span class="p" data-group-id="2795570465-18">(</span><span class="p" data-group-id="2795570465-18">)</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="2795570465-19">(</span><span class="p" data-group-id="2795570465-19">)</span><span class="p" data-group-id="2795570465-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="2795570465-20">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="2795570465-21">(</span><span class="p" data-group-id="2795570465-21">)</span><span class="p" data-group-id="2795570465-20">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Stream management</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">get_stream_info</span><span class="p" data-group-id="2795570465-22">(</span><span class="n">Connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-23">(</span><span class="p" data-group-id="2795570465-23">)</span><span class="p" data-group-id="2795570465-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2795570465-24">#{</span><span class="ss">stream_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="2795570465-25">(</span><span class="p" data-group-id="2795570465-25">)</span><span class="p">,</span><span class="w"> </span><span class="ss">bytes_sent</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="2795570465-26">(</span><span class="p" data-group-id="2795570465-26">)</span><span class="p" data-group-id="2795570465-24">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Callbacks (for receiving data)</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">set_message_handler</span><span class="p" data-group-id="2795570465-27">(</span><span class="n">Connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-28">(</span><span class="p" data-group-id="2795570465-28">)</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="2795570465-29">(</span><span class="p" data-group-id="2795570465-29">)</span><span class="p" data-group-id="2795570465-27">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span></code></pre><p><strong>State:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="0380182505-1">(</span><span class="ss">connection_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0380182505-2">{</span><span class="w">
    </span><span class="ss">url</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0380182505-3">(</span><span class="p" data-group-id="0380182505-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">host</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0380182505-4">(</span><span class="p" data-group-id="0380182505-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">port</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="0380182505-5">(</span><span class="p" data-group-id="0380182505-5">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% QUIC state</span><span class="w">
    </span><span class="ss">connection</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="0380182505-6">(</span><span class="p" data-group-id="0380182505-6">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">  </span><span class="c1">%% quicer connection</span><span class="w">
    </span><span class="ss">stream</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="0380182505-7">(</span><span class="p" data-group-id="0380182505-7">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">      </span><span class="c1">%% quicer stream</span><span class="w">
    </span><span class="ss">status</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="ss">connecting</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">connected</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">disconnected</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">error</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Transport state</span><span class="w">
    </span><span class="ss">recv_buffer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0380182505-8">(</span><span class="p" data-group-id="0380182505-8">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">message_handler</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">pid</span><span class="p" data-group-id="0380182505-9">(</span><span class="p" data-group-id="0380182505-9">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">  </span><span class="c1">%% Who to send decoded messages to</span><span class="w">

    </span><span class="c1">%% Reconnection</span><span class="w">
    </span><span class="ss">reconnect_timer</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">reference</span><span class="p" data-group-id="0380182505-10">(</span><span class="p" data-group-id="0380182505-10">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="p">,</span><span class="w">
    </span><span class="ss">reconnect_attempts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="0380182505-11">(</span><span class="p" data-group-id="0380182505-11">)</span><span class="w">
</span><span class="p" data-group-id="0380182505-2">}</span><span class="p" data-group-id="0380182505-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="implementation-phases" class="section-heading"><a href="#implementation-phases" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Implementation Phases</span></h2><h3 id="phase-1-test-coverage-analysis-completed" class="section-heading"><a href="#phase-1-test-coverage-analysis-completed" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 1: Test Coverage Analysis ✅ (COMPLETED)</span></h3><p><strong>Tasks:</strong></p><ul><li>[x] Identify all existing test files</li><li>[x] Count test functions per file</li><li>[x] Map tests to responsibilities (peer vs connection)</li></ul><p><strong>Results:</strong></p><ul><li>144 tests across 10 files</li><li>Need to split into peer tests (pub/sub, RPC, DHT) vs connection tests (QUIC, transport)</li></ul><hr class="thin"/><h3 id="phase-2-design-new-architecture-2-days" class="section-heading"><a href="#phase-2-design-new-architecture-2-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 2: Design New Architecture (2 days)</span></h3><p><strong>Tasks:</strong></p><ol><li>Define <code class="inline">macula_peer</code> API and behavior specification</li><li>Define <code class="inline">macula_connection</code> API and behavior specification</li><li>Design interaction protocol between peer and connection</li><li>Design supervision tree structure</li><li>Document state management and ownership</li></ol><p><strong>Deliverables:</strong></p><ul><li><code class="inline">docs/macula_peer_specification.md</code></li><li><code class="inline">docs/macula_connection_specification.md</code></li><li><code class="inline">docs/peer_connection_interaction_protocol.md</code></li></ul><hr class="thin"/><h3 id="phase-3-write-peer-tests-3-days" class="section-heading"><a href="#phase-3-write-peer-tests-3-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 3: Write Peer Tests (3 days)</span></h3><p><strong>Test Files to Create:</strong></p><h4><code class="inline">test/macula_peer_tests.erl</code> - Core peer functionality</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Lifecycle tests</span><span class="w">
</span><span class="nf">peer_start_link_test</span><span class="p" data-group-id="3070155012-1">(</span><span class="p" data-group-id="3070155012-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_stop_test</span><span class="p" data-group-id="3070155012-2">(</span><span class="p" data-group-id="3070155012-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_get_info_test</span><span class="p" data-group-id="3070155012-3">(</span><span class="p" data-group-id="3070155012-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% State management</span><span class="w">
</span><span class="nf">peer_tracks_node_id_test</span><span class="p" data-group-id="3070155012-4">(</span><span class="p" data-group-id="3070155012-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_tracks_realm_test</span><span class="p" data-group-id="3070155012-5">(</span><span class="p" data-group-id="3070155012-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_tracks_status_test</span><span class="p" data-group-id="3070155012-6">(</span><span class="p" data-group-id="3070155012-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Connection integration</span><span class="w">
</span><span class="nf">peer_starts_connection_test</span><span class="p" data-group-id="3070155012-7">(</span><span class="p" data-group-id="3070155012-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_handles_connection_failure_test</span><span class="p" data-group-id="3070155012-8">(</span><span class="p" data-group-id="3070155012-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_reconnects_after_disconnect_test</span><span class="p" data-group-id="3070155012-9">(</span><span class="p" data-group-id="3070155012-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h4><code class="inline">test/macula_peer_pubsub_tests.erl</code> - Pub/sub operations</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Publishing</span><span class="w">
</span><span class="nf">peer_publish_simple_test</span><span class="p" data-group-id="6161528776-1">(</span><span class="p" data-group-id="6161528776-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_publish_with_opts_test</span><span class="p" data-group-id="6161528776-2">(</span><span class="p" data-group-id="6161528776-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_publish_while_disconnected_test</span><span class="p" data-group-id="6161528776-3">(</span><span class="p" data-group-id="6161528776-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_publish_queues_when_connecting_test</span><span class="p" data-group-id="6161528776-4">(</span><span class="p" data-group-id="6161528776-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Subscribing</span><span class="w">
</span><span class="nf">peer_subscribe_test</span><span class="p" data-group-id="6161528776-5">(</span><span class="p" data-group-id="6161528776-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_unsubscribe_test</span><span class="p" data-group-id="6161528776-6">(</span><span class="p" data-group-id="6161528776-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_receives_published_events_test</span><span class="p" data-group-id="6161528776-7">(</span><span class="p" data-group-id="6161528776-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_wildcard_subscribe_test</span><span class="p" data-group-id="6161528776-8">(</span><span class="p" data-group-id="6161528776-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Error handling</span><span class="w">
</span><span class="nf">peer_publish_invalid_topic_test</span><span class="p" data-group-id="6161528776-9">(</span><span class="p" data-group-id="6161528776-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_subscribe_callback_error_test</span><span class="p" data-group-id="6161528776-10">(</span><span class="p" data-group-id="6161528776-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h4><code class="inline">test/macula_peer_rpc_tests.erl</code> - RPC operations</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Calling services</span><span class="w">
</span><span class="nf">peer_call_simple_test</span><span class="p" data-group-id="6441304649-1">(</span><span class="p" data-group-id="6441304649-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_call_with_timeout_test</span><span class="p" data-group-id="6441304649-2">(</span><span class="p" data-group-id="6441304649-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_call_nonexistent_service_test</span><span class="p" data-group-id="6441304649-3">(</span><span class="p" data-group-id="6441304649-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_call_multiple_providers_test</span><span class="p" data-group-id="6441304649-4">(</span><span class="p" data-group-id="6441304649-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Advertising services</span><span class="w">
</span><span class="nf">peer_advertise_test</span><span class="p" data-group-id="6441304649-5">(</span><span class="p" data-group-id="6441304649-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_unadvertise_test</span><span class="p" data-group-id="6441304649-6">(</span><span class="p" data-group-id="6441304649-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_handler_receives_call_test</span><span class="p" data-group-id="6441304649-7">(</span><span class="p" data-group-id="6441304649-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_handler_returns_result_test</span><span class="p" data-group-id="6441304649-8">(</span><span class="p" data-group-id="6441304649-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Failover</span><span class="w">
</span><span class="nf">peer_call_failover_on_timeout_test</span><span class="p" data-group-id="6441304649-9">(</span><span class="p" data-group-id="6441304649-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_call_failover_on_error_test</span><span class="p" data-group-id="6441304649-10">(</span><span class="p" data-group-id="6441304649-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h4><code class="inline">test/macula_peer_dht_tests.erl</code> - DHT and discovery</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Peer discovery</span><span class="w">
</span><span class="nf">peer_discover_peers_test</span><span class="p" data-group-id="5575397882-1">(</span><span class="p" data-group-id="5575397882-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_discover_peers_in_realm_test</span><span class="p" data-group-id="5575397882-2">(</span><span class="p" data-group-id="5575397882-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_discover_peers_empty_test</span><span class="p" data-group-id="5575397882-3">(</span><span class="p" data-group-id="5575397882-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Service discovery</span><span class="w">
</span><span class="nf">peer_find_service_test</span><span class="p" data-group-id="5575397882-4">(</span><span class="p" data-group-id="5575397882-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_find_service_multiple_providers_test</span><span class="p" data-group-id="5575397882-5">(</span><span class="p" data-group-id="5575397882-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_find_service_not_found_test</span><span class="p" data-group-id="5575397882-6">(</span><span class="p" data-group-id="5575397882-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% DHT operations</span><span class="w">
</span><span class="nf">peer_dht_query_test</span><span class="p" data-group-id="5575397882-7">(</span><span class="p" data-group-id="5575397882-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">peer_dht_store_test</span><span class="p" data-group-id="5575397882-8">(</span><span class="p" data-group-id="5575397882-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p><strong>Estimated Tests:</strong> ~60-70 new tests</p><hr class="thin"/><h3 id="phase-4-write-connection-tests-2-days" class="section-heading"><a href="#phase-4-write-connection-tests-2-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 4: Write Connection Tests (2 days)</span></h3><p><strong>Test Files to Create:</strong></p><h4><code class="inline">test/macula_connection_tests.erl</code> - Core transport</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Lifecycle</span><span class="w">
</span><span class="nf">connection_start_link_test</span><span class="p" data-group-id="5084251348-1">(</span><span class="p" data-group-id="5084251348-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_stop_test</span><span class="p" data-group-id="5084251348-2">(</span><span class="p" data-group-id="5084251348-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_get_status_test</span><span class="p" data-group-id="5084251348-3">(</span><span class="p" data-group-id="5084251348-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% QUIC connection</span><span class="w">
</span><span class="nf">connection_establishes_quic_test</span><span class="p" data-group-id="5084251348-4">(</span><span class="p" data-group-id="5084251348-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_creates_stream_test</span><span class="p" data-group-id="5084251348-5">(</span><span class="p" data-group-id="5084251348-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_handles_connection_failure_test</span><span class="p" data-group-id="5084251348-6">(</span><span class="p" data-group-id="5084251348-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Reconnection</span><span class="w">
</span><span class="nf">connection_reconnects_on_disconnect_test</span><span class="p" data-group-id="5084251348-7">(</span><span class="p" data-group-id="5084251348-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_backs_off_on_repeated_failures_test</span><span class="p" data-group-id="5084251348-8">(</span><span class="p" data-group-id="5084251348-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_max_reconnect_attempts_test</span><span class="p" data-group-id="5084251348-9">(</span><span class="p" data-group-id="5084251348-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h4><code class="inline">test/macula_connection_send_tests.erl</code> - Sending messages</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Send operations</span><span class="w">
</span><span class="nf">connection_send_binary_test</span><span class="p" data-group-id="0613821209-1">(</span><span class="p" data-group-id="0613821209-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_send_message_test</span><span class="p" data-group-id="0613821209-2">(</span><span class="p" data-group-id="0613821209-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_send_while_connecting_test</span><span class="p" data-group-id="0613821209-3">(</span><span class="p" data-group-id="0613821209-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_send_while_disconnected_test</span><span class="p" data-group-id="0613821209-4">(</span><span class="p" data-group-id="0613821209-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Encoding</span><span class="w">
</span><span class="nf">connection_encodes_message_type_test</span><span class="p" data-group-id="0613821209-5">(</span><span class="p" data-group-id="0613821209-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_encodes_message_data_test</span><span class="p" data-group-id="0613821209-6">(</span><span class="p" data-group-id="0613821209-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_handles_encoding_error_test</span><span class="p" data-group-id="0613821209-7">(</span><span class="p" data-group-id="0613821209-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h4><code class="inline">test/macula_connection_receive_tests.erl</code> - Receiving messages</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Receive operations</span><span class="w">
</span><span class="nf">connection_receives_data_test</span><span class="p" data-group-id="7136767600-1">(</span><span class="p" data-group-id="7136767600-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_decodes_messages_test</span><span class="p" data-group-id="7136767600-2">(</span><span class="p" data-group-id="7136767600-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_handles_partial_messages_test</span><span class="p" data-group-id="7136767600-3">(</span><span class="p" data-group-id="7136767600-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_forwards_to_handler_test</span><span class="p" data-group-id="7136767600-4">(</span><span class="p" data-group-id="7136767600-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Buffering</span><span class="w">
</span><span class="nf">connection_buffers_incomplete_messages_test</span><span class="p" data-group-id="7136767600-5">(</span><span class="p" data-group-id="7136767600-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="nf">connection_clears_buffer_on_reconnect_test</span><span class="p" data-group-id="7136767600-6">(</span><span class="p" data-group-id="7136767600-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><p><strong>Estimated Tests:</strong> ~40-50 new tests</p><hr class="thin"/><h3 id="phase-5-implement-macula_connection-tdd-4-days" class="section-heading"><a href="#phase-5-implement-macula_connection-tdd-4-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 5: Implement macula_connection (TDD) (4 days)</span></h3><p><strong>Approach:</strong></p><ol><li>Write tests first (Red)</li><li>Implement minimal code to pass (Green)</li><li>Refactor for idiomatic Erlang (Refactor)</li><li>Repeat</li></ol><p><strong>Sub-tasks:</strong></p><ul><li>Day 1: Lifecycle and QUIC connection setup</li><li>Day 2: Send operations and encoding</li><li>Day 3: Receive operations and decoding</li><li>Day 4: Reconnection logic and error handling</li></ul><p><strong>Success Criteria:</strong></p><ul><li>All connection tests passing</li><li>No direct mesh logic in connection module</li><li>Clean transport abstraction</li></ul><hr class="thin"/><h3 id="phase-6-implement-macula_peer-tdd-5-days" class="section-heading"><a href="#phase-6-implement-macula_peer-tdd-5-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 6: Implement macula_peer (TDD) (5 days)</span></h3><p><strong>Approach:</strong> Same TDD cycle</p><p><strong>Sub-tasks:</strong></p><ul><li>Day 1: Lifecycle and peer identity</li><li>Day 2: Pub/sub operations (uses macula_pubsub_handler)</li><li>Day 3: RPC operations (uses macula_rpc_handler)</li><li>Day 4: DHT and service discovery</li><li>Day 5: Error handling and edge cases</li></ul><p><strong>Success Criteria:</strong></p><ul><li>All peer tests passing</li><li>Clean delegation to connection layer</li><li>No transport logic in peer module</li></ul><hr class="thin"/><h3 id="phase-7-integration-and-migration-3-days" class="section-heading"><a href="#phase-7-integration-and-migration-3-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 7: Integration and Migration (3 days)</span></h3><p><strong>Tasks:</strong></p><ol><li>Update all references from old <code class="inline">macula_connection</code> to new modules</li><li>Create backward-compatible wrapper (optional)</li><li>Update supervision trees</li><li>Update documentation</li><li>Update examples and demos</li></ol><p><strong>Migration Script:</strong></p><pre><code class="makeup bash" translate="no"><span class="">#!/bin/bash
</span><span class=""># scripts/migrate-to-peer-connection.sh
</span><span class="">
</span><span class=""># Rename test files
</span><span class="">mv test/macula_connection_tests.erl test/macula_peer_facade_tests.erl
</span><span class="">mv test/macula_connection_manager_tests.erl test/macula_connection_tests.erl
</span><span class="">
</span><span class=""># Update references in source files
</span><span class="">find src -name &quot;*.erl&quot; -exec sed -i &#39;s/macula_connection:start_link/macula_peer:start_link/g&#39; {} \;
</span><span class="">find src -name &quot;*.erl&quot; -exec sed -i &#39;s/macula_connection:publish/macula_peer:publish/g&#39; {} \;
</span><span class=""># ... (complete list of API replacements)
</span><span class="">
</span><span class=""># Update test references
</span><span class="">find test -name &quot;*.erl&quot; -exec sed -i &#39;s/macula_connection:start_link/macula_peer:start_link/g&#39; {} \;
</span></code></pre><hr class="thin"/><h3 id="phase-8-testing-and-validation-2-days" class="section-heading"><a href="#phase-8-testing-and-validation-2-days" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 8: Testing and Validation (2 days)</span></h3><p><strong>Test Levels:</strong></p><ol><li><p><strong>Unit Tests:</strong></p><ul><li>All macula_peer tests passing (60-70 tests)</li><li>All macula_connection tests passing (40-50 tests)</li><li>All existing tests still passing (144 tests)</li></ul></li><li><p><strong>Integration Tests:</strong></p><ul><li>Multi-node pub/sub test</li><li>Multi-node RPC test</li><li>Service discovery test</li><li>Reconnection scenario test</li></ul></li><li><p><strong>Regression Tests:</strong></p><ul><li>Run full eunit suite</li><li>Run integration tests</li><li>Test macula-arcade compatibility</li></ul></li></ol><p><strong>Success Criteria:</strong></p><ul><li>100% of existing tests passing</li><li>100% of new tests passing</li><li>No performance degradation</li><li>Clean separation of concerns</li></ul><hr class="thin"/><h2 id="timeline" class="section-heading"><a href="#timeline" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Timeline</span></h2><table><thead><tr><th style="text-align: left;">Phase</th><th style="text-align: left;">Duration</th><th style="text-align: left;">Status</th></tr></thead><tbody><tr><td style="text-align: left;">1. Test Coverage Analysis</td><td style="text-align: left;">0.5 days</td><td style="text-align: left;">✅ COMPLETED</td></tr><tr><td style="text-align: left;">2. Design New Architecture</td><td style="text-align: left;">2 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;">3. Write Peer Tests</td><td style="text-align: left;">3 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;">4. Write Connection Tests</td><td style="text-align: left;">2 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;">5. Implement macula_connection (TDD)</td><td style="text-align: left;">4 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;">6. Implement macula_peer (TDD)</td><td style="text-align: left;">5 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;">7. Integration and Migration</td><td style="text-align: left;">3 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;">8. Testing and Validation</td><td style="text-align: left;">2 days</td><td style="text-align: left;">📋 PENDING</td></tr><tr><td style="text-align: left;"><strong>TOTAL</strong></td><td style="text-align: left;"><strong>21.5 days</strong> (~4.5 weeks)</td><td style="text-align: left;"></td></tr></tbody></table><hr class="thin"/><h2 id="risk-mitigation" class="section-heading"><a href="#risk-mitigation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Risk Mitigation</span></h2><h3 id="risk-1-breaking-existing-functionality" class="section-heading"><a href="#risk-1-breaking-existing-functionality" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Risk 1: Breaking Existing Functionality</span></h3><p><strong>Mitigation:</strong></p><ul><li>Keep all existing tests</li><li>Run tests after each phase</li><li>Create backward-compatible wrapper if needed</li></ul><h3 id="risk-2-state-management-complexity" class="section-heading"><a href="#risk-2-state-management-complexity" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Risk 2: State Management Complexity</span></h3><p><strong>Mitigation:</strong></p><ul><li>Design state ownership upfront</li><li>Document interaction protocol</li><li>Use well-defined message passing</li></ul><h3 id="risk-3-performance-degradation" class="section-heading"><a href="#risk-3-performance-degradation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Risk 3: Performance Degradation</span></h3><p><strong>Mitigation:</strong></p><ul><li>Benchmark before and after</li><li>Profile message passing overhead</li><li>Optimize hot paths</li></ul><h3 id="risk-4-timeline-overrun" class="section-heading"><a href="#risk-4-timeline-overrun" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Risk 4: Timeline Overrun</span></h3><p><strong>Mitigation:</strong></p><ul><li>Daily progress tracking</li><li>Adjust scope if needed</li><li>Pair programming for complex areas</li></ul><hr class="thin"/><h2 id="success-metrics" class="section-heading"><a href="#success-metrics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Success Metrics</span></h2><h3 id="code-quality" class="section-heading"><a href="#code-quality" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Code Quality</span></h3><ul><li>[x] Single Responsibility Principle: Each module has ONE clear purpose</li><li>[ ] Test Coverage: &gt;90% for new modules</li><li>[ ] Idiomatic Erlang: Pattern matching, guards, no deep nesting</li><li>[ ] Documentation: Comprehensive specs and examples</li></ul><h3 id="functionality" class="section-heading"><a href="#functionality" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Functionality</span></h3><ul><li>[ ] All existing features working</li><li>[ ] Clean API separation</li><li>[ ] No performance regression</li><li>[ ] Backward compatibility (via wrapper)</li></ul><h3 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h3><ul><li>[ ] macula_peer = mesh logic only</li><li>[ ] macula_connection = transport only</li><li>[ ] Clear interface contract</li><li>[ ] Easy to extend/modify</li></ul><hr class="thin"/><h2 id="next-steps" class="section-heading"><a href="#next-steps" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Next Steps</span></h2><ol><li><strong>Get approval</strong> for 4.5-week timeline</li><li><strong>Start Phase 2</strong>: Design specifications</li><li><strong>Daily standup</strong>: Track progress and blockers</li><li><strong>Weekly review</strong>: Adjust timeline if needed</li></ol><hr class="thin"/><p><strong>Decision Point:</strong> Proceed with Option B full separation?</p><p><strong>Estimated Completion:</strong> 4.5 weeks from start (around early December 2025)</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="kademlia_dht_architecture.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Kademlia DHT Architecture
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="v0-6-0_release_summary.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
v0.6.0 Release Summary
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.7.7" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.7.7">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.7.7/show/docs/PEER_CONNECTION_SEPARATION_PLAN.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
