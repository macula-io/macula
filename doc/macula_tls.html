<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module macula_tls</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module macula_tls</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>TLS Certificate Management and Verification Module (v0.11.0+).


<h2><a name="description">Description</a></h2><p>TLS Certificate Management and Verification Module (v0.11.0+)</p>
  
   <p>This module provides TLS certificate management for Macula nodes with   
two operating modes:</p>
  
   <p>- **Production Mode**: Strict certificate verification with CA bundle   
- **Development Mode**: Self-signed certificates (auto-generated)</p>
  
   <h3><a name="Configuration_(sys.config)">Configuration (sys.config)</a></h3>
  
     <p>{macula, [         
%% TLS mode: production (strict) or development (permissive)         
{tls_mode, development},  % or production</p>
  
         <p>%% CA certificate bundle (production mode)         
{tls_cacertfile, "/path/to/ca-bundle.crt"},</p>
  
         <p>%% Server/client certificate and key         
{tls_certfile, "/path/to/server.crt"},         
{tls_keyfile, "/path/to/server.key"},</p>
  
         <p>%% Hostname verification (production mode, default: true)         
{tls_verify_hostname, true}     
]}</p>
  
   <h3><a name="Environment_Variables">Environment Variables</a></h3>
  
   <p>- MACULA_TLS_MODE: production | development   
- MACULA_TLS_CACERTFILE: Path to CA bundle   
- MACULA_TLS_CERTFILE: Path to certificate   
- MACULA_TLS_KEYFILE: Path to private key</p>
  
   <h3><a name="Security_Note">Security Note</a></h3>
  
   In production mode, TLS connections will:
   - Verify the server certificate chain against the CA bundle
   - Reject expired or invalid certificates
   - Optionally verify hostname matches certificate CN/SAN
  
<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#derive_node_id-1">derive_node_id/1</a></td><td>Derive Node ID from certificate public key.</td></tr>
<tr><td valign="top"><a href="#ensure_cert_exists-2">ensure_cert_exists/2</a></td><td>Ensure TLS certificate exists, generate if missing.</td></tr>
<tr><td valign="top"><a href="#generate_self_signed_cert-1">generate_self_signed_cert/1</a></td><td>Generate self-signed TLS certificate using OpenSSL.</td></tr>
<tr><td valign="top"><a href="#get_cert_paths-0">get_cert_paths/0</a></td><td>Get default certificate paths from application environment.</td></tr>
<tr><td valign="top"><a href="#get_tls_mode-0">get_tls_mode/0</a></td><td>Get the current TLS mode (production or development).</td></tr>
<tr><td valign="top"><a href="#hostname_verify_fun-3">hostname_verify_fun/3</a></td><td>TLS verify_fun callback for hostname verification.</td></tr>
<tr><td valign="top"><a href="#is_production_mode-0">is_production_mode/0</a></td><td>Check if running in production TLS mode.</td></tr>
<tr><td valign="top"><a href="#quic_client_opts-0">quic_client_opts/0</a></td><td>Get QUIC client TLS options based on current TLS mode.</td></tr>
<tr><td valign="top"><a href="#quic_client_opts-1">quic_client_opts/1</a></td><td>Get QUIC client TLS options with overrides.</td></tr>
<tr><td valign="top"><a href="#quic_client_opts_with_hostname-1">quic_client_opts_with_hostname/1</a></td><td>Get QUIC client TLS options with hostname verification.</td></tr>
<tr><td valign="top"><a href="#quic_server_opts-0">quic_server_opts/0</a></td><td>Get QUIC server TLS options based on current TLS mode.</td></tr>
<tr><td valign="top"><a href="#quic_server_opts-1">quic_server_opts/1</a></td><td>Get QUIC server TLS options with overrides.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="derive_node_id-1">derive_node_id/1</a></h3>
<div class="spec">
<p><code>derive_node_id(CertPEM::binary()) -&gt; NodeID::binary()</code><br></p>
<p><code>CertPEM</code>: PEM-encoded certificate binary<br>
</p>
<p>returns: NodeID Binary (32-byte SHA-256 hash, hex-encoded)</p>
</div><p><p>Derive Node ID from certificate public key.</p>
 
  Extracts the public key from the PEM-encoded certificate and computes
  SHA-256 hash to create a stable, cryptographically-derived Node ID.
 </p>

<h3 class="function"><a name="ensure_cert_exists-2">ensure_cert_exists/2</a></h3>
<div class="spec">
<p><code>ensure_cert_exists(CertPath::<a href="/home/rl/work/github.com/macula-io/kernel/doc/file.html#type-filename" docgen-rel="seetype" docgen-href="kernel:file#filename/0">file:filename()</a>, KeyPath::<a href="/home/rl/work/github.com/macula-io/kernel/doc/file.html#type-filename" docgen-rel="seetype" docgen-href="kernel:file#filename/0">file:filename()</a>) -&gt; {ok, <a href="/home/rl/work/github.com/macula-io/kernel/doc/file.html#type-filename" docgen-rel="seetype" docgen-href="kernel:file#filename/0">file:filename()</a>, <a href="/home/rl/work/github.com/macula-io/kernel/doc/file.html#type-filename" docgen-rel="seetype" docgen-href="kernel:file#filename/0">file:filename()</a>, binary()} | {error, term()}</code><br></p>
<p><code>CertPath</code>: Path to certificate file (PEM format)<br>
<code>KeyPath</code>: Path to private key file (PEM format)<br>
</p>
<p>returns: {ok, CertPath, KeyPath, NodeID} | {error, Reason}</p>
</div><p><p>Ensure TLS certificate exists, generate if missing.</p>
 
  Checks if certificate and key files exist at the specified paths.
  If they don't exist, generates new self-signed certificate and saves to disk.
  Returns the paths and derived Node ID.
 </p>

<h3 class="function"><a name="generate_self_signed_cert-1">generate_self_signed_cert/1</a></h3>
<div class="spec">
<p><code>generate_self_signed_cert(Opts::map()) -&gt; {ok, CertPEM::binary(), KeyPEM::binary()} | {error, term()}</code><br></p>
<p><code>Opts</code>: Options map (currently unused, reserved for future extensions)<br>
</p>
<p>returns: {ok, CertPEM, KeyPEM} | {error, Reason}</p>
</div><p><p>Generate self-signed TLS certificate using OpenSSL.</p>
 
  Creates a new RSA key pair and self-signed X.509 certificate with:
  - RSA 2048-bit key
  - 10-year validity period
  - Subject: CN=macula-node
  - Self-signed (issuer = subject)
 </p>

<h3 class="function"><a name="get_cert_paths-0">get_cert_paths/0</a></h3>
<div class="spec">
<p><code>get_cert_paths() -&gt; {<a href="/home/rl/work/github.com/macula-io/kernel/doc/file.html#type-filename" docgen-rel="seetype" docgen-href="kernel:file#filename/0">file:filename()</a>, <a href="/home/rl/work/github.com/macula-io/kernel/doc/file.html#type-filename" docgen-rel="seetype" docgen-href="kernel:file#filename/0">file:filename()</a>}</code><br></p>
<p> </p>
<p>returns: {CertPath, KeyPath}</p>
</div><p>Get default certificate paths from application environment.
 </p>

<h3 class="function"><a name="get_tls_mode-0">get_tls_mode/0</a></h3>
<div class="spec">
<p><code>get_tls_mode() -&gt; production | development</code><br></p>
<p> </p>
<p>returns: production | development</p>
</div><p><p>Get the current TLS mode (production or development).</p>
 
  Checks in order:
  1. MACULA_TLS_MODE environment variable
  2. tls_mode application environment setting
  3. Defaults to 'development'
 </p>

<h3 class="function"><a name="hostname_verify_fun-3">hostname_verify_fun/3</a></h3>
<div class="spec">
<p><code>hostname_verify_fun(Cert::term(), Event::{bad_cert, term()} | {extension, term()} | valid | valid_peer, State::map()) -&gt; {valid, map()} | {fail, term()} | {unknown, map()}</code><br></p>
<p><code>Cert</code>: The DER-encoded certificate being verified<br>
<code>Event</code>: The verification event (valid_peer, valid, extension, etc.)<br>
<code>State</code>: User state containing verification options (#{hostname =&gt; ...})<br>
</p>
<p>returns: {valid, State} | {fail, Reason} | {unknown, State}</p>
</div><p><p>TLS verify_fun callback for hostname verification.</p>
 
  <p>This function is called during TLS handshake to verify the peer certificate.  
When used with hostname verification, it checks that the server's certificate  
contains the expected hostname in either the Subject CN or Subject Alt Names.</p>
 
  <p>Usage:</p>
 
    {verify_fun, {fun macula_tls:hostname_verify_fun/3, #{hostname =&gt; "example.com"}}}
 </p>

<h3 class="function"><a name="is_production_mode-0">is_production_mode/0</a></h3>
<div class="spec">
<p><code>is_production_mode() -&gt; boolean()</code><br></p>
<p> </p>
<p>returns: true if production mode, false if development mode</p>
</div><p>Check if running in production TLS mode.
 </p>

<h3 class="function"><a name="quic_client_opts-0">quic_client_opts/0</a></h3>
<div class="spec">
<p><code>quic_client_opts() -&gt; list()</code><br></p>
<p> </p>
<p>returns: Proplist of QUIC TLS options suitable for quicer:connect/4</p>
</div><p><p>Get QUIC client TLS options based on current TLS mode.</p>
 
  In production mode: Returns options with certificate verification enabled.
  In development mode: Returns options with verification disabled.
 </p>

<h3 class="function"><a name="quic_client_opts-1">quic_client_opts/1</a></h3>
<div class="spec">
<p><code>quic_client_opts(Overrides::map()) -&gt; list()</code><br></p>
<p><code>Overrides</code>: Map of options to override defaults<br>
</p>
<p>returns: Proplist of QUIC TLS options</p>
</div><p>Get QUIC client TLS options with overrides.
 </p>

<h3 class="function"><a name="quic_client_opts_with_hostname-1">quic_client_opts_with_hostname/1</a></h3>
<div class="spec">
<p><code>quic_client_opts_with_hostname(Hostname::string() | binary()) -&gt; list()</code><br></p>
<p><code>Hostname</code>: The hostname to verify (string or binary)<br>
</p>
<p>returns: Proplist of QUIC TLS options with hostname verification</p>
</div><p><p>Get QUIC client TLS options with hostname verification.</p>
 
  In production mode, adds SNI and hostname verification if enabled.
  In development mode, hostname verification is skipped.
 </p>

<h3 class="function"><a name="quic_server_opts-0">quic_server_opts/0</a></h3>
<div class="spec">
<p><code>quic_server_opts() -&gt; list()</code><br></p>
<p> </p>
<p>returns: Proplist of QUIC TLS options suitable for quicer:listen/2</p>
</div><p><p>Get QUIC server TLS options based on current TLS mode.</p>
 
  Server always needs a certificate and key.
  In production mode: Also verifies client certificates if presented.
  In development mode: Auto-generates self-signed certificate if needed.
 </p>

<h3 class="function"><a name="quic_server_opts-1">quic_server_opts/1</a></h3>
<div class="spec">
<p><code>quic_server_opts(Overrides::map()) -&gt; list()</code><br></p>
<p><code>Overrides</code>: Map of options to override defaults<br>
</p>
<p>returns: Proplist of QUIC TLS options</p>
</div><p>Get QUIC server TLS options with overrides.
 </p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
