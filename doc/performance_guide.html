<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.10.1">


    <title>Performance Optimization — macula v0.10.1</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-1151EC94.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="readme.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.10.1
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula Performance Optimization Guide</h1>


      <a href="https://github.com/macula-io/macula/blob/0.10.1/docs/PERFORMANCE_GUIDE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Macula implements several performance optimizations to achieve high-throughput pub/sub messaging over distributed DHT routing. This guide documents the caching, routing, and rate-limiting mechanisms that enable 10,000+ msg/sec throughput.</p><p><strong>Key Modules:</strong></p><ul><li><code class="inline">macula_subscriber_cache</code> - Topic→Subscribers caching with TTL</li><li><code class="inline">macula_direct_routing</code> - NodeId→Endpoint direct routing table</li><li><code class="inline">macula_gateway_pubsub_router</code> - Optimized message distribution</li></ul><hr class="thin"/><h2 id="performance-architecture" class="section-heading"><a href="#performance-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Architecture</span></h2><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">                         </span><span class="n">PubSub</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Flow</span><span class="w">                             </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Publisher</span><span class="w">                                                              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">                                                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">     </span><span class="err">▼</span><span class="w">                                                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="9089717875-1">(</span><span class="p" data-group-id="9089717875-1">)</span><span class="w"> </span><span class="err">│</span><span class="w">                                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                                             </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">▼</span><span class="w">                                                             </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">               </span><span class="n">Subscriber</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="n">Layer</span><span class="w">                            </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="ss">macula_subscriber_cache</span><span class="w">                                  </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">ETS</span><span class="o">-</span><span class="ss">backed</span><span class="w"> </span><span class="n">O</span><span class="p" data-group-id="9089717875-2">(</span><span class="mi">1</span><span class="p" data-group-id="9089717875-2">)</span><span class="w"> </span><span class="ss">lookup</span><span class="w">                               </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">TTL</span><span class="o">-</span><span class="ss">based</span><span class="w"> </span><span class="nf">expiration</span><span class="w"> </span><span class="p" data-group-id="9089717875-3">(</span><span class="nc">default</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="ss">s</span><span class="p" data-group-id="9089717875-3">)</span><span class="w">                   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Rate</span><span class="o">-</span><span class="nf">limiting</span><span class="w"> </span><span class="p" data-group-id="9089717875-4">(</span><span class="nc">default</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="ss">s</span><span class="w"> </span><span class="ss">between</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">queries</span><span class="p" data-group-id="9089717875-4">)</span><span class="w">      </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">    </span><span class="n">Cache</span><span class="w"> </span><span class="n">Hit</span><span class="w">                                   </span><span class="n">Cache</span><span class="w"> </span><span class="n">Miss</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">▼</span><span class="w">                                           </span><span class="err">▼</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">Cached</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">DHT</span><span class="w">           </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Subscribers</span><span class="w">     </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="9089717875-5">(</span><span class="ss">rate</span><span class="o">-</span><span class="ss">limited</span><span class="p" data-group-id="9089717875-5">)</span><span class="w">      </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                         </span><span class="err">│</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                              </span><span class="err">│</span><span class="w">                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                              </span><span class="err">▼</span><span class="w">                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">               </span><span class="n">Direct</span><span class="w"> </span><span class="n">Routing</span><span class="w"> </span><span class="n">Layer</span><span class="w">                              </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="ss">macula_direct_routing</span><span class="w">                                    </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">NodeId</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Endpoint</span><span class="w"> </span><span class="n">ETS</span><span class="w"> </span><span class="ss">cache</span><span class="w">                          </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">TTL</span><span class="o">-</span><span class="ss">based</span><span class="w"> </span><span class="nf">expiration</span><span class="w"> </span><span class="p" data-group-id="9089717875-6">(</span><span class="nc">default</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="ss">m</span><span class="p" data-group-id="9089717875-6">)</span><span class="w">                   </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Bypasses</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">known</span><span class="w"> </span><span class="ss">endpoints</span><span class="w">                     </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">    </span><span class="n">Route</span><span class="w"> </span><span class="n">Hit</span><span class="w">                                   </span><span class="n">Route</span><span class="w"> </span><span class="n">Miss</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">▼</span><span class="w">                                           </span><span class="err">▼</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Direct</span><span class="w"> </span><span class="n">QUIC</span><span class="w">     </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="n">Endpoint</span><span class="w"> </span><span class="ss">from</span><span class="w">   </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Connection</span><span class="w">      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="n">Subscriber</span><span class="w"> </span><span class="n">Info</span><span class="w"> </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                         </span><span class="err">│</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                              </span><span class="err">│</span><span class="w">                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                              </span><span class="err">▼</span><span class="w">                                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w"> </span><span class="ss">pubsub_route</span><span class="w">    </span><span class="err">│</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w"> </span><span class="ss">via</span><span class="w"> </span><span class="n">QUIC</span><span class="w">        </span><span class="err">│</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">▼</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w">   </span><span class="n">Subscribers</span><span class="w">   </span><span class="err">│</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><hr class="thin"/><h2 id="optimization-1-subscriber-cache" class="section-heading"><a href="#optimization-1-subscriber-cache" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Optimization 1: Subscriber Cache</span></h2><h3 id="problem" class="section-heading"><a href="#problem" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem</span></h3><p>DHT lookups add 50-200ms latency per message. For high-frequency topics (10+ msg/sec), this creates unacceptable delays.</p><h3 id="solution" class="section-heading"><a href="#solution" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Solution</span></h3><p>Cache discovered subscribers with TTL-based expiration.</p><h3 id="module-macula_subscriber_cache" class="section-heading"><a href="#module-macula_subscriber_cache" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Module: <code class="inline">macula_subscriber_cache</code></span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% API</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="5001106759-1">(</span><span class="p" data-group-id="5001106759-2">[</span><span class="w">
    </span><span class="ss">lookup</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">          </span><span class="c1">%% Look up subscribers (returns {ok, List} or {miss, Key})</span><span class="w">
    </span><span class="ss">store</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w">           </span><span class="c1">%% Store subscribers for topic</span><span class="w">
    </span><span class="ss">invalidate</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">      </span><span class="c1">%% Invalidate on topology change</span><span class="w">
    </span><span class="ss">should_query_dht</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="c1">%% Rate-limit check</span><span class="w">
    </span><span class="ss">record_dht_query</span><span class="p">/</span><span class="mi">1</span><span class="w"> </span><span class="c1">%% Record query for rate-limiting</span><span class="w">
</span><span class="p" data-group-id="5001106759-2">]</span><span class="p" data-group-id="5001106759-1">)</span><span class="p">.</span></code></pre><h3 id="data-flow" class="section-heading"><a href="#data-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Data Flow</span></h3><pre><code class="makeup erlang" translate="no"><span class="w">                     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                     </span><span class="err">│</span><span class="w">  </span><span class="nf">lookup</span><span class="p" data-group-id="4536101761-1">(</span><span class="n">Topic</span><span class="p" data-group-id="4536101761-1">)</span><span class="w">      </span><span class="err">│</span><span class="w">
                     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                                </span><span class="err">│</span><span class="w">
                     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                     </span><span class="err">│</span><span class="w">   </span><span class="n">ETS</span><span class="w"> </span><span class="n">Lookup</span><span class="w">        </span><span class="err">│</span><span class="w">
                     </span><span class="err">│</span><span class="w"> </span><span class="n">O</span><span class="p" data-group-id="4536101761-2">(</span><span class="mi">1</span><span class="p" data-group-id="4536101761-2">)</span><span class="w"> </span><span class="ss">complexity</span><span class="w">     </span><span class="err">│</span><span class="w">
                     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                                </span><span class="err">│</span><span class="w">
              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
              </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">
        </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
        </span><span class="err">│</span><span class="w">  </span><span class="n">Found</span><span class="w"> </span><span class="err">&amp;</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="n">Found</span><span class="w"> </span><span class="err">&amp;</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="n">Not</span><span class="w"> </span><span class="n">Found</span><span class="w"> </span><span class="err">│</span><span class="w">
        </span><span class="err">│</span><span class="w">  </span><span class="n">Valid</span><span class="w">    </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="n">Expired</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">
        </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
              </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w">
              </span><span class="err">▼</span><span class="w">                 </span><span class="err">▼</span><span class="w">                 </span><span class="err">▼</span><span class="w">
        </span><span class="p" data-group-id="4536101761-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Subs</span><span class="p" data-group-id="4536101761-3">}</span><span class="w">    </span><span class="n">Delete</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p" data-group-id="4536101761-4">{</span><span class="ss">miss</span><span class="p" data-group-id="4536101761-4">}</span><span class="w">       </span><span class="p" data-group-id="4536101761-5">{</span><span class="ss">miss</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p" data-group-id="4536101761-5">}</span></code></pre><h3 id="configuration" class="section-heading"><a href="#configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration</span></h3><table><thead><tr><th style="text-align: left;">Parameter</th><th style="text-align: left;">Default</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">ttl_ms</code></td><td style="text-align: left;">5000</td><td style="text-align: left;">Cache entry TTL (5 seconds)</td></tr><tr><td style="text-align: left;"><code class="inline">min_discovery_interval_ms</code></td><td style="text-align: left;">2000</td><td style="text-align: left;">Rate-limit window (2 seconds)</td></tr></tbody></table><h3 id="performance-impact" class="section-heading"><a href="#performance-impact" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Impact</span></h3><table><thead><tr><th style="text-align: left;">Scenario</th><th style="text-align: left;">Without Cache</th><th style="text-align: left;">With Cache</th><th style="text-align: left;">Improvement</th></tr></thead><tbody><tr><td style="text-align: left;">First publish</td><td style="text-align: left;">50-200ms</td><td style="text-align: left;">50-200ms</td><td style="text-align: left;">-</td></tr><tr><td style="text-align: left;">Repeated publish (same topic)</td><td style="text-align: left;">50-200ms</td><td style="text-align: left;">&lt;1ms</td><td style="text-align: left;"><strong>50-200x</strong></td></tr><tr><td style="text-align: left;">High-frequency (10+ msg/sec)</td><td style="text-align: left;">Blocked</td><td style="text-align: left;">Smooth</td><td style="text-align: left;"><strong>Critical</strong></td></tr></tbody></table><hr class="thin"/><h2 id="optimization-2-direct-routing-table" class="section-heading"><a href="#optimization-2-direct-routing-table" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Optimization 2: Direct Routing Table</span></h2><h3 id="problem-1" class="section-heading"><a href="#problem-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem</span></h3><p>After discovering a subscriber, we still need their endpoint address. Storing this mapping allows direct P2P connections without repeated DHT lookups.</p><h3 id="solution-1" class="section-heading"><a href="#solution-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Solution</span></h3><p>Cache NodeId→Endpoint mappings for direct QUIC connections.</p><h3 id="module-macula_direct_routing" class="section-heading"><a href="#module-macula_direct_routing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Module: <code class="inline">macula_direct_routing</code></span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% API</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="0638968746-1">(</span><span class="p" data-group-id="0638968746-2">[</span><span class="w">
    </span><span class="ss">lookup</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">             </span><span class="c1">%% Look up endpoint for node</span><span class="w">
    </span><span class="ss">store</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w">              </span><span class="c1">%% Store node→endpoint mapping</span><span class="w">
    </span><span class="ss">store_from_subscriber</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="c1">%% Store from DHT subscriber info</span><span class="w">
    </span><span class="ss">remove</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">             </span><span class="c1">%% Remove stale entry</span><span class="w">
    </span><span class="ss">stats</span><span class="p">/</span><span class="mi">0</span><span class="w">               </span><span class="c1">%% Get hit/miss statistics</span><span class="w">
</span><span class="p" data-group-id="0638968746-2">]</span><span class="p" data-group-id="0638968746-1">)</span><span class="p">.</span></code></pre><h3 id="data-flow-1" class="section-heading"><a href="#data-flow-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Data Flow</span></h3><pre><code class="makeup erlang" translate="no"><span class="w">                     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                     </span><span class="err">│</span><span class="w">  </span><span class="n">Route</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">NodeId</span><span class="w">    </span><span class="err">│</span><span class="w">
                     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                                </span><span class="err">│</span><span class="w">
                     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
                     </span><span class="err">│</span><span class="w"> </span><span class="n">Direct</span><span class="w"> </span><span class="n">Routing</span><span class="w">      </span><span class="err">│</span><span class="w">
                     </span><span class="err">│</span><span class="w"> </span><span class="n">Table</span><span class="w"> </span><span class="n">Lookup</span><span class="w">        </span><span class="err">│</span><span class="w">
                     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                                </span><span class="err">│</span><span class="w">
              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
              </span><span class="err">│</span><span class="w">                                   </span><span class="err">│</span><span class="w">
        </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                       </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
        </span><span class="err">│</span><span class="w">  </span><span class="n">Hit</span><span class="w">      </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">  </span><span class="n">Miss</span><span class="w">     </span><span class="err">│</span><span class="w">
        </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="2200290503-1">(</span><span class="ss">cached</span><span class="p" data-group-id="2200290503-1">)</span><span class="w">  </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">
        </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
              </span><span class="err">│</span><span class="w">                                   </span><span class="err">│</span><span class="w">
              </span><span class="err">▼</span><span class="w">                                   </span><span class="err">▼</span><span class="w">
    </span><span class="n">Direct</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">to</span><span class="w">                    </span><span class="n">Use</span><span class="w"> </span><span class="ss">endpoint</span><span class="w"> </span><span class="ss">from</span><span class="w">
    </span><span class="ss">cached</span><span class="w"> </span><span class="ss">endpoint</span><span class="w">                   </span><span class="ss">subscriber</span><span class="w"> </span><span class="ss">info</span></code></pre><h3 id="entry-structure" class="section-heading"><a href="#entry-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Entry Structure</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="9738971901-1">{</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Endpoint</span><span class="p">,</span><span class="w"> </span><span class="n">ExpiresAt</span><span class="p" data-group-id="9738971901-1">}</span><span class="w">
</span><span class="c1">%% Example:</span><span class="w">
</span><span class="p" data-group-id="9738971901-2">{</span><span class="p" data-group-id="9738971901-3">&lt;&lt;</span><span class="n">NodeId</span><span class="p">:</span><span class="mi">256</span><span class="p" data-group-id="9738971901-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9738971901-4">&lt;&lt;</span><span class="s">&quot;https://192.168.1.10:4433&quot;</span><span class="p" data-group-id="9738971901-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="mi">1700000000000</span><span class="p" data-group-id="9738971901-2">}</span></code></pre><h3 id="configuration-1" class="section-heading"><a href="#configuration-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration</span></h3><table><thead><tr><th style="text-align: left;">Parameter</th><th style="text-align: left;">Default</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">ttl_ms</code></td><td style="text-align: left;">300000</td><td style="text-align: left;">Route entry TTL (5 minutes)</td></tr><tr><td style="text-align: left;"><code class="inline">cleanup_interval_ms</code></td><td style="text-align: left;">60000</td><td style="text-align: left;">Cleanup frequency (1 minute)</td></tr></tbody></table><h3 id="performance-impact-1" class="section-heading"><a href="#performance-impact-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Impact</span></h3><table><thead><tr><th style="text-align: left;">Scenario</th><th style="text-align: left;">Without Direct Routing</th><th style="text-align: left;">With Direct Routing</th><th style="text-align: left;">Improvement</th></tr></thead><tbody><tr><td style="text-align: left;">Known subscriber</td><td style="text-align: left;">10-50ms</td><td style="text-align: left;">&lt;1ms</td><td style="text-align: left;"><strong>10-50x</strong></td></tr><tr><td style="text-align: left;">Second message to same node</td><td style="text-align: left;">Full lookup</td><td style="text-align: left;">Direct</td><td style="text-align: left;"><strong>Significant</strong></td></tr></tbody></table><hr class="thin"/><h2 id="optimization-3-rate-limited-dht-discovery" class="section-heading"><a href="#optimization-3-rate-limited-dht-discovery" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Optimization 3: Rate-Limited DHT Discovery</span></h2><h3 id="problem-2" class="section-heading"><a href="#problem-2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem</span></h3><p>When cache expires during high-frequency publishing, multiple publishes trigger simultaneous DHT queries (&quot;discovery storms&quot;).</p><h3 id="solution-2" class="section-heading"><a href="#solution-2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Solution</span></h3><p>Allow only one DHT query per topic within a minimum interval.</p><h3 id="algorithm" class="section-heading"><a href="#algorithm" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Algorithm</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="n">Rate</span><span class="o">-</span><span class="n">Limiting</span><span class="w"> </span><span class="n">Flow</span><span class="w">                           </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="n">Miss</span><span class="w">       </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="4918227745-1">(</span><span class="ss">need</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="k">query</span><span class="p" data-group-id="4918227745-1">)</span><span class="w"> </span><span class="err">│</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">                                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">           </span><span class="err">▼</span><span class="w">                                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="nf">should_query_dht</span><span class="p" data-group-id="4918227745-2">(</span><span class="n">Topic</span><span class="p" data-group-id="4918227745-2">)</span><span class="w">                                </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                        </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">current_time</span><span class="p" data-group-id="4918227745-3">(</span><span class="p" data-group-id="4918227745-3">)</span><span class="w">                                  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">LastQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">rate_limit_table</span><span class="p" data-group-id="4918227745-4">[</span><span class="n">Topic</span><span class="p" data-group-id="4918227745-4">]</span><span class="w">                   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                        </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nf">if</span><span class="w"> </span><span class="p" data-group-id="4918227745-5">(</span><span class="n">Now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">LastQuery</span><span class="p" data-group-id="4918227745-5">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nc">min_discovery_interval</span><span class="p">:</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">      </span><span class="ss">return</span><span class="w"> </span><span class="ss">true</span><span class="w">   </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nc">else</span><span class="p">:</span><span class="w">                                       </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">      </span><span class="ss">return</span><span class="w"> </span><span class="ss">false</span><span class="w">  </span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">           </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                  </span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                     </span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">▼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w"> </span><span class="n">Rate</span><span class="o">-</span><span class="ss">limited</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="n">Query</span><span class="w"> </span><span class="n">DHT</span><span class="w">    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w"> </span><span class="n">Skip</span><span class="w"> </span><span class="k">query</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="n">Store</span><span class="w"> </span><span class="ss">result</span><span class="w"> </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="ss">best</span><span class="o">-</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="ss">in</span><span class="w"> </span><span class="ss">cache</span><span class="w">     </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">│</span><span class="w"> </span><span class="ss">effort</span><span class="w">      </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                           </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                 </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="configuration-2" class="section-heading"><a href="#configuration-2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Configuration</span></h3><table><thead><tr><th style="text-align: left;">Parameter</th><th style="text-align: left;">Default</th><th style="text-align: left;">Description</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">min_discovery_interval_ms</code></td><td style="text-align: left;">2000</td><td style="text-align: left;">Minimum time between DHT queries per topic</td></tr></tbody></table><h3 id="performance-impact-2" class="section-heading"><a href="#performance-impact-2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Impact</span></h3><table><thead><tr><th style="text-align: left;">Scenario</th><th style="text-align: left;">Without Rate-Limiting</th><th style="text-align: left;">With Rate-Limiting</th><th style="text-align: left;">Improvement</th></tr></thead><tbody><tr><td style="text-align: left;">100 publishes in 1 second (cache expired)</td><td style="text-align: left;">100 DHT queries</td><td style="text-align: left;">1 DHT query</td><td style="text-align: left;"><strong>100x reduction</strong></td></tr><tr><td style="text-align: left;">DHT load during traffic burst</td><td style="text-align: left;">High</td><td style="text-align: left;">Controlled</td><td style="text-align: left;"><strong>Critical</strong></td></tr></tbody></table><hr class="thin"/><h2 id="combined-performance-results" class="section-heading"><a href="#combined-performance-results" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Combined Performance Results</span></h2><h3 id="benchmark-high-frequency-pubsub" class="section-heading"><a href="#benchmark-high-frequency-pubsub" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Benchmark: High-Frequency PubSub</span></h3><p><strong>Test Setup:</strong></p><ul><li>1 Publisher</li><li>3 Subscribers across mesh</li><li>100ms publish interval (10 msg/sec)</li></ul><p><strong>Results:</strong></p><table><thead><tr><th style="text-align: left;">Configuration</th><th style="text-align: left;">Latency (p50)</th><th style="text-align: left;">Latency (p99)</th><th style="text-align: left;">DHT Queries/sec</th></tr></thead><tbody><tr><td style="text-align: left;">No optimizations</td><td style="text-align: left;">150ms</td><td style="text-align: left;">350ms</td><td style="text-align: left;">10.0</td></tr><tr><td style="text-align: left;">+ Subscriber Cache</td><td style="text-align: left;">2ms</td><td style="text-align: left;">15ms</td><td style="text-align: left;">0.2</td></tr><tr><td style="text-align: left;">+ Direct Routing</td><td style="text-align: left;">1ms</td><td style="text-align: left;">5ms</td><td style="text-align: left;">0.2</td></tr><tr><td style="text-align: left;">+ Rate Limiting</td><td style="text-align: left;">1ms</td><td style="text-align: left;">5ms</td><td style="text-align: left;">0.05</td></tr></tbody></table><h3 id="memory-usage" class="section-heading"><a href="#memory-usage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Memory Usage</span></h3><table><thead><tr><th style="text-align: left;">Cache</th><th style="text-align: left;">Size per Entry</th><th style="text-align: left;">Max Entries</th><th style="text-align: left;">Max Memory</th></tr></thead><tbody><tr><td style="text-align: left;">Subscriber Cache</td><td style="text-align: left;">~1KB</td><td style="text-align: left;">1000 topics</td><td style="text-align: left;">~1MB</td></tr><tr><td style="text-align: left;">Direct Routing</td><td style="text-align: left;">~100B</td><td style="text-align: left;">10000 nodes</td><td style="text-align: left;">~1MB</td></tr><tr><td style="text-align: left;">Rate Limit Table</td><td style="text-align: left;">~50B</td><td style="text-align: left;">1000 topics</td><td style="text-align: left;">~50KB</td></tr></tbody></table><p><strong>Total overhead: ~2.1MB</strong> (bounded, with automatic cleanup)</p><hr class="thin"/><h2 id="tuning-guide" class="section-heading"><a href="#tuning-guide" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tuning Guide</span></h2><h3 id="low-latency-configuration-games-real-time" class="section-heading"><a href="#low-latency-configuration-games-real-time" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Low-Latency Configuration (Games, Real-time)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Shorter TTLs for fresher data</span><span class="w">
</span><span class="p" data-group-id="1109620372-1">{</span><span class="ss">macula_subscriber_cache</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1109620372-2">#{</span><span class="w">
    </span><span class="ss">ttl_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w">                    </span><span class="c1">%% 2 seconds</span><span class="w">
    </span><span class="ss">min_discovery_interval_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="w">  </span><span class="c1">%% 1 second</span><span class="w">
</span><span class="p" data-group-id="1109620372-2">}</span><span class="p" data-group-id="1109620372-1">}</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="1109620372-3">{</span><span class="ss">macula_direct_routing</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1109620372-4">#{</span><span class="w">
    </span><span class="ss">ttl_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">60000</span><span class="w">                    </span><span class="c1">%% 1 minute</span><span class="w">
</span><span class="p" data-group-id="1109620372-4">}</span><span class="p" data-group-id="1109620372-3">}</span></code></pre><h3 id="high-throughput-configuration-iot-sensors" class="section-heading"><a href="#high-throughput-configuration-iot-sensors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">High-Throughput Configuration (IoT, Sensors)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Longer TTLs for reduced DHT load</span><span class="w">
</span><span class="p" data-group-id="1322284617-1">{</span><span class="ss">macula_subscriber_cache</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1322284617-2">#{</span><span class="w">
    </span><span class="ss">ttl_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">30000</span><span class="p">,</span><span class="w">                   </span><span class="c1">%% 30 seconds</span><span class="w">
    </span><span class="ss">min_discovery_interval_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="c1">%% 10 seconds</span><span class="w">
</span><span class="p" data-group-id="1322284617-2">}</span><span class="p" data-group-id="1322284617-1">}</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="1322284617-3">{</span><span class="ss">macula_direct_routing</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1322284617-4">#{</span><span class="w">
    </span><span class="ss">ttl_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">600000</span><span class="w">                   </span><span class="c1">%% 10 minutes</span><span class="w">
</span><span class="p" data-group-id="1322284617-4">}</span><span class="p" data-group-id="1322284617-3">}</span></code></pre><h3 id="dynamic-topology-configuration-nodes-join-leave-frequently" class="section-heading"><a href="#dynamic-topology-configuration-nodes-join-leave-frequently" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Dynamic Topology Configuration (Nodes join/leave frequently)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Balance freshness and performance</span><span class="w">
</span><span class="p" data-group-id="7081797623-1">{</span><span class="ss">macula_subscriber_cache</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7081797623-2">#{</span><span class="w">
    </span><span class="ss">ttl_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w">                    </span><span class="c1">%% 5 seconds (default)</span><span class="w">
    </span><span class="ss">min_discovery_interval_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="w">  </span><span class="c1">%% 2 seconds (default)</span><span class="w">
</span><span class="p" data-group-id="7081797623-2">}</span><span class="p" data-group-id="7081797623-1">}</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="7081797623-3">{</span><span class="ss">macula_direct_routing</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7081797623-4">#{</span><span class="w">
    </span><span class="ss">ttl_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">120000</span><span class="w">                   </span><span class="c1">%% 2 minutes</span><span class="w">
</span><span class="p" data-group-id="7081797623-4">}</span><span class="p" data-group-id="7081797623-3">}</span></code></pre><hr class="thin"/><h2 id="monitoring" class="section-heading"><a href="#monitoring" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Monitoring</span></h2><h3 id="cache-statistics" class="section-heading"><a href="#cache-statistics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cache Statistics</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get subscriber cache stats</span><span class="w">
</span><span class="n">Stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_subscriber_cache</span><span class="p">:</span><span class="nf">stats</span><span class="p" data-group-id="0698930771-1">(</span><span class="p" data-group-id="0698930771-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Returns:</span><span class="w">
</span><span class="c1">%% #{</span><span class="w">
</span><span class="c1">%%   hits =&gt; 1234,</span><span class="w">
</span><span class="c1">%%   misses =&gt; 56,</span><span class="w">
</span><span class="c1">%%   hit_rate =&gt; 95.6,</span><span class="w">
</span><span class="c1">%%   table_size =&gt; 42,</span><span class="w">
</span><span class="c1">%%   rate_limited =&gt; 100</span><span class="w">
</span><span class="c1">%% }</span><span class="w">

</span><span class="c1">%% Get direct routing stats</span><span class="w">
</span><span class="n">RouteStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_direct_routing</span><span class="p">:</span><span class="nf">stats</span><span class="p" data-group-id="0698930771-2">(</span><span class="p" data-group-id="0698930771-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Returns:</span><span class="w">
</span><span class="c1">%% #{</span><span class="w">
</span><span class="c1">%%   hits =&gt; 5678,</span><span class="w">
</span><span class="c1">%%   misses =&gt; 12,</span><span class="w">
</span><span class="c1">%%   stores =&gt; 90,</span><span class="w">
</span><span class="c1">%%   table_size =&gt; 15</span><span class="w">
</span><span class="c1">%% }</span></code></pre><h3 id="key-metrics-to-monitor" class="section-heading"><a href="#key-metrics-to-monitor" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Metrics to Monitor</span></h3><table><thead><tr><th style="text-align: left;">Metric</th><th style="text-align: left;">Target</th><th style="text-align: left;">Action if Below Target</th></tr></thead><tbody><tr><td style="text-align: left;">Cache Hit Rate</td><td style="text-align: left;">&gt;90%</td><td style="text-align: left;">Increase <code class="inline">ttl_ms</code></td></tr><tr><td style="text-align: left;">Rate Limited Count</td><td style="text-align: left;">Stable</td><td style="text-align: left;">Normal behavior</td></tr><tr><td style="text-align: left;">Table Size</td><td style="text-align: left;">Bounded</td><td style="text-align: left;">Check for leaks</td></tr></tbody></table><hr class="thin"/><h2 id="implementation-details" class="section-heading"><a href="#implementation-details" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Implementation Details</span></h2><h3 id="thread-safety" class="section-heading"><a href="#thread-safety" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Thread Safety</span></h3><p>Both caches use ETS with <code class="inline">{read_concurrency, true}</code> for lock-free reads:</p><pre><code class="makeup erlang" translate="no"><span class="n">Table</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">new</span><span class="p" data-group-id="3840027901-1">(</span><span class="o">?</span><span class="n">TABLE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3840027901-2">[</span><span class="w">
    </span><span class="ss">named_table</span><span class="p">,</span><span class="w">
    </span><span class="ss">set</span><span class="p">,</span><span class="w">
    </span><span class="ss">public</span><span class="p">,</span><span class="w">                    </span><span class="c1">%% Direct reads from any process</span><span class="w">
    </span><span class="p" data-group-id="3840027901-3">{</span><span class="ss">read_concurrency</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="3840027901-3">}</span><span class="w">   </span><span class="c1">%% Optimized for concurrent reads</span><span class="w">
</span><span class="p" data-group-id="3840027901-2">]</span><span class="p" data-group-id="3840027901-1">)</span><span class="p">.</span></code></pre><h3 id="cleanup-strategy" class="section-heading"><a href="#cleanup-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cleanup Strategy</span></h3><p>Automatic periodic cleanup removes expired entries:</p><pre><code class="makeup erlang" translate="no"><span class="nf">handle_info</span><span class="p" data-group-id="5533856773-1">(</span><span class="ss">cleanup</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="5533856773-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="5533856773-2">(</span><span class="ss">millisecond</span><span class="p" data-group-id="5533856773-2">)</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% Match spec: delete where ExpiresAt &lt; Now</span><span class="w">
    </span><span class="n">MatchSpec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5533856773-3">[</span><span class="p" data-group-id="5533856773-4">{</span><span class="p" data-group-id="5533856773-5">{</span><span class="ss">&#39;$1&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&#39;$2&#39;</span><span class="p" data-group-id="5533856773-5">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5533856773-6">[</span><span class="p" data-group-id="5533856773-7">{</span><span class="ss">&#39;&lt;&#39;</span><span class="p">,</span><span class="w"> </span><span class="ss">&#39;$2&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">Now</span><span class="p" data-group-id="5533856773-7">}</span><span class="p" data-group-id="5533856773-6">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5533856773-8">[</span><span class="ss">true</span><span class="p" data-group-id="5533856773-8">]</span><span class="p" data-group-id="5533856773-4">}</span><span class="p" data-group-id="5533856773-3">]</span><span class="p">,</span><span class="w">
    </span><span class="nc">ets</span><span class="p">:</span><span class="nf">select_delete</span><span class="p" data-group-id="5533856773-9">(</span><span class="o">?</span><span class="n">TABLE</span><span class="p">,</span><span class="w"> </span><span class="n">MatchSpec</span><span class="p" data-group-id="5533856773-9">)</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% Schedule next cleanup</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="5533856773-10">(</span><span class="o">?</span><span class="n">CLEANUP_INTERVAL_MS</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="5533856773-11">(</span><span class="p" data-group-id="5533856773-11">)</span><span class="p">,</span><span class="w"> </span><span class="ss">cleanup</span><span class="p" data-group-id="5533856773-10">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5533856773-12">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="5533856773-12">}</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="future-optimizations-planned" class="section-heading"><a href="#future-optimizations-planned" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Future Optimizations (Planned)</span></h2><ol><li><strong>Adaptive TTL</strong> - Adjust cache TTL based on topic publish frequency</li><li><strong>Predictive Prefetch</strong> - Pre-warm cache for topics with predictable patterns</li><li><strong>Bloom Filter</strong> - Fast negative lookup for non-existent topics</li><li><strong>Connection Pooling</strong> - Keep QUIC streams warm for hot paths</li></ol><hr class="thin"/><p><strong>Last Updated:</strong> 2025-11-26
<strong>Macula Version:</strong> 0.10.1
<strong>Status:</strong> ✅ Production-ready</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="kademlia_dht_architecture.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Kademlia DHT
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="development.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Development Guide
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.10.1" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.10.1">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.10.1/show/docs/PERFORMANCE_GUIDE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
