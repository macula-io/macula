<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.12.4">


    <title>RPC Guide â€” macula v0.12.4</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-DE2E663F.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="overview.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="overview.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.12.4
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula HTTP/3 Mesh - RPC Guide</h1>


      <a href="https://github.com/macula-io/macula/blob/0.12.4/docs/developer/RPC_GUIDE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Complete guide to decentralized RPC with DHT-based service discovery</strong></p><p><strong>Status</strong>: âœ… COMPLETE
<strong>Last Updated</strong>: 2025-01-10</p><hr class="thin"/><h2 id="table-of-contents" class="section-heading"><a href="#table-of-contents" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Table of Contents</span></h2><ol><li><a href="#overview">Overview</a></li><li><a href="#architecture">Architecture</a></li><li><a href="#service-advertisement">Service Advertisement</a></li><li><a href="#service-discovery">Service Discovery</a></li><li><a href="#making-rpc-calls">Making RPC Calls</a></li><li><a href="#error-handling">Error Handling</a></li><li><a href="#performance-optimization">Performance Optimization</a></li><li><a href="#best-practices">Best Practices</a></li><li><a href="#examples">Examples</a></li><li><a href="#migration-from-wamp">Migration from WAMP</a></li></ol><hr class="thin"/><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Macula provides <strong>fully decentralized RPC</strong> without requiring any central registry or broker. Services advertise themselves to a <strong>Kademlia DHT</strong> (Distributed Hash Table), and consumers discover providers by querying the DHT.</p><h3 id="key-features" class="section-heading"><a href="#key-features" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Features</span></h3><p>âœ… <strong>Fully Decentralized</strong> - No central authority, DHT-based discovery
âœ… <strong>Local-First Optimization</strong> - Zero-latency for local services
âœ… <strong>Smart Caching</strong> - DHT results cached (60s TTL) to reduce queries
âœ… <strong>Graceful Degradation</strong> - Continues operation when DHT unavailable
âœ… <strong>Multiple Providers</strong> - Automatic load balancing across providers
âœ… <strong>Fault Tolerant</strong> - Provider failover if one becomes unavailable
âœ… <strong>NAT-Friendly</strong> - HTTP/3 QUIC works through firewalls</p><h3 id="how-it-works" class="section-heading"><a href="#how-it-works" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">How It Works</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">â”Œ</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Provider</span><span class="w"> </span><span class="p" data-group-id="2672736457-1">(</span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="2672736457-1">)</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">                                                          </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="nf">advertise</span><span class="p" data-group-id="2672736457-2">(</span><span class="s">&quot;energy.home.get&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">handler_fn</span><span class="p">,</span><span class="w"> </span><span class="ss">metadata</span><span class="p" data-group-id="2672736457-2">)</span><span class="w">     </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">     </span><span class="err">â†“</span><span class="w">                                                    </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="ss">handler</span><span class="w"> </span><span class="ss">locally</span><span class="w">                               </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">Publish</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="ss">key</span><span class="o">=</span><span class="n">SHA256</span><span class="p" data-group-id="2672736457-3">(</span><span class="s">&quot;energy.home.get&quot;</span><span class="p" data-group-id="2672736457-3">)</span><span class="w">    </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">     </span><span class="err">â†’</span><span class="w"> </span><span class="p" data-group-id="2672736457-4">{</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="ss">endpoint</span><span class="p">,</span><span class="w"> </span><span class="ss">metadata</span><span class="p">,</span><span class="w"> </span><span class="ss">ttl</span><span class="p" data-group-id="2672736457-4">}</span><span class="w">                </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â””</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”˜</span><span class="w">
                          </span><span class="err">â†“</span><span class="w">
                  </span><span class="p" data-group-id="2672736457-5">[</span><span class="n">Kademlia</span><span class="w"> </span><span class="n">DHT</span><span class="p" data-group-id="2672736457-5">]</span><span class="w">
                  </span><span class="p" data-group-id="2672736457-6">(</span><span class="ss">distributed</span><span class="p" data-group-id="2672736457-6">)</span><span class="w">
                          </span><span class="err">â†“</span><span class="w">
</span><span class="err">â”Œ</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”</span><span class="w">
</span><span class="err">â”‚</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="n">Consumer</span><span class="w"> </span><span class="p" data-group-id="2672736457-7">(</span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="2672736457-7">)</span><span class="w">                                </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">                                                          </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="nf">call</span><span class="p" data-group-id="2672736457-8">(</span><span class="s">&quot;energy.home.get&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">args</span><span class="p" data-group-id="2672736457-8">)</span><span class="w">                          </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">     </span><span class="err">â†“</span><span class="w">                                                    </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="ss">local</span><span class="w"> </span><span class="nf">handler</span><span class="w"> </span><span class="p" data-group-id="2672736457-9">(</span><span class="ss">local</span><span class="o">-</span><span class="ss">first</span><span class="p" data-group-id="2672736457-9">)</span><span class="w">                   </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="nf">cache</span><span class="w"> </span><span class="p" data-group-id="2672736457-10">(</span><span class="mi">60</span><span class="ss">s</span><span class="w"> </span><span class="n">TTL</span><span class="p" data-group-id="2672736457-10">)</span><span class="w">                               </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">providers</span><span class="w">                             </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="ss">result</span><span class="w">                                        </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Pick</span><span class="w"> </span><span class="ss">provider</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">MSG_CALL</span><span class="w"> </span><span class="ss">via</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="n">QUIC</span><span class="w">      </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">     </span><span class="err">â†“</span><span class="w">                                                    </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="n">Provider</span><span class="w"> </span><span class="ss">executes</span><span class="w"> </span><span class="ss">handler</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">MSG_REPLY</span><span class="w">                  </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">     </span><span class="err">â†“</span><span class="w">                                                    </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â”‚</span><span class="w">  </span><span class="p" data-group-id="2672736457-11">{</span><span class="p">:</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">result</span><span class="p" data-group-id="2672736457-11">}</span><span class="w">                                           </span><span class="err">â”‚</span><span class="w">
</span><span class="err">â””</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”€</span><span class="err">â”˜</span></code></pre><h3 id="discovery-hierarchy" class="section-heading"><a href="#discovery-hierarchy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Discovery Hierarchy</span></h3><p>Macula uses a <strong>4-tier fallback hierarchy</strong> for optimal performance:</p><ol><li><strong>Local Handler</strong> âš¡ - Zero latency if service advertised locally</li><li><strong>Cache Hit</strong> ğŸš€ - Fast retrieval from local cache (60s TTL)</li><li><strong>DHT Query</strong> ğŸŒ - Query DHT for providers, cache result</li><li><strong>Direct Call</strong> ğŸ”— - Fallback to connected endpoint</li></ol><p>This design ensures:</p><ul><li>Local calls have <strong>zero network overhead</strong></li><li>Cached discoveries are <strong>sub-millisecond</strong></li><li>DHT queries happen only on <strong>cache miss</strong> (every 60 seconds per service)</li><li>System <strong>continues working</strong> even if DHT is unavailable</li></ul><hr class="thin"/><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><h3 id="components" class="section-heading"><a href="#components" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Components</span></h3><h4><code class="inline">macula_service_registry</code></h4><p>Core registry module that manages:</p><ul><li><strong>Local services</strong> - Handler functions for services this node provides</li><li><strong>Discovery cache</strong> - Cached provider lists from DHT queries (60s TTL)</li><li><strong>DHT integration</strong> - Publish/query/remove operations</li></ul><p><strong>Key Functions</strong>:</p><ul><li><code class="inline">advertise_local/4</code> - Store handler locally</li><li><code class="inline">get_local_handler/2</code> - Retrieve local handler</li><li><code class="inline">discover_service/2,3</code> - Check cache for providers</li><li><code class="inline">cache_service/4</code> - Store DHT results in cache</li><li><code class="inline">publish_to_dht/5</code> - Publish service to DHT</li><li><code class="inline">query_dht_for_service/3</code> - Query DHT for providers</li><li><code class="inline">remove_from_dht/3</code> - Remove service from DHT</li></ul><h4><code class="inline">macula_connection</code></h4><p>Connection gen_server that:</p><ul><li>Holds <code class="inline">service_registry</code> in state</li><li>Handles <code class="inline">advertise</code>, <code class="inline">unadvertise</code>, <code class="inline">call</code> requests</li><li>Executes handlers in spawned processes (non-blocking)</li><li>Sends <code class="inline">MSG_CALL</code>, <code class="inline">MSG_REPLY</code>, <code class="inline">MSG_ERROR</code> messages</li></ul><h4><code class="inline">macula</code> (Public API)</h4><p>The <strong>only module</strong> applications should import. Delegates to internal modules:</p><ul><li><code class="inline">connect/2</code>, <code class="inline">connect_local/1</code> - Connect to mesh</li><li><code class="inline">advertise/3,4</code> - Advertise a service</li><li><code class="inline">call/3,4</code> - Call a service</li><li><code class="inline">unadvertise/2</code> - Stop advertising</li><li><code class="inline">disconnect/1</code> - Close connection</li></ul><h4><code class="inline">macula_peer</code> (Internal)</h4><p>Internal mesh participant module (called by <code class="inline">macula</code>).</p><h4><code class="inline">macula_routing_dht</code></h4><p>DHT implementation (Kademlia):</p><ul><li>Pure functional DHT operations</li><li>K-bucket routing table</li><li>Store/find value operations</li><li>K-value replication (typically 20)</li></ul><h3 id="data-flow" class="section-heading"><a href="#data-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Data Flow</span></h3><p><strong>Service Advertisement</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Application</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="6795381370-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="6795381370-1">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nf">macula_connection</span><span class="w"> </span><span class="p" data-group-id="6795381370-2">(</span><span class="nc">gen_server</span><span class="p">:</span><span class="ss">call</span><span class="p" data-group-id="6795381370-2">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">advertise_local</span><span class="p" data-group-id="6795381370-3">(</span><span class="n">Registry</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p" data-group-id="6795381370-3">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">publish_to_dht</span><span class="p" data-group-id="6795381370-4">(</span><span class="n">DhtPid</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">ProviderInfo</span><span class="p">,</span><span class="w"> </span><span class="n">TTL</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="6795381370-4">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nf">macula_routing_dht</span><span class="w"> </span><span class="p" data-group-id="6795381370-5">(</span><span class="n">DHT</span><span class="w"> </span><span class="ss">storage</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="ss">key</span><span class="o">=</span><span class="n">SHA256</span><span class="p" data-group-id="6795381370-6">(</span><span class="n">Procedure</span><span class="p" data-group-id="6795381370-6">)</span><span class="p" data-group-id="6795381370-5">)</span></code></pre><p><strong>Service Discovery and Call</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Application</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="3851455655-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="3851455655-1">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nf">macula_connection</span><span class="w"> </span><span class="p" data-group-id="3851455655-2">(</span><span class="nc">gen_server</span><span class="p">:</span><span class="ss">call</span><span class="p" data-group-id="3851455655-2">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">get_local_handler</span><span class="p" data-group-id="3851455655-3">(</span><span class="n">Registry</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p" data-group-id="3851455655-3">)</span><span class="w">
   </span><span class="err">â†’</span><span class="w"> </span><span class="n">Found</span><span class="o">?</span><span class="w"> </span><span class="n">Execute</span><span class="w"> </span><span class="nf">locally</span><span class="w"> </span><span class="p" data-group-id="3851455655-4">(</span><span class="ss">zero</span><span class="o">-</span><span class="ss">latency</span><span class="w"> </span><span class="ss">path</span><span class="p" data-group-id="3851455655-4">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">discover_service</span><span class="p" data-group-id="3851455655-5">(</span><span class="n">Registry</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p" data-group-id="3851455655-5">)</span><span class="w">
   </span><span class="err">â†’</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="ss">hit</span><span class="o">?</span><span class="w"> </span><span class="n">Use</span><span class="w"> </span><span class="ss">cached</span><span class="w"> </span><span class="nf">providers</span><span class="w"> </span><span class="p" data-group-id="3851455655-6">(</span><span class="ss">fast</span><span class="w"> </span><span class="ss">path</span><span class="p" data-group-id="3851455655-6">)</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">query_dht_for_service</span><span class="p" data-group-id="3851455655-7">(</span><span class="n">DhtPid</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="3851455655-7">)</span><span class="w">
   </span><span class="err">â†’</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">DHT</span><span class="p">,</span><span class="w"> </span><span class="ss">cache</span><span class="w"> </span><span class="ss">result</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="n">Pick</span><span class="w"> </span><span class="ss">provider</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="ss">list</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="n">Send</span><span class="w"> </span><span class="n">MSG_CALL</span><span class="w"> </span><span class="ss">over</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">provider</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="n">Provider</span><span class="w"> </span><span class="ss">executes</span><span class="w"> </span><span class="ss">handler</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">MSG_REPLY</span><span class="w">
   </span><span class="err">â†“</span><span class="w">
</span><span class="n">Application</span><span class="w"> </span><span class="ss">receives</span><span class="w"> </span><span class="ss">result</span></code></pre><h3 id="storage" class="section-heading"><a href="#storage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Storage</span></h3><p><strong>DHT Key</strong>: <code class="inline">SHA256(Procedure)</code> (32-byte key)</p><p><strong>DHT Value</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="9784022027-1">#{</span><span class="w">
    </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="9784022027-2">(</span><span class="p" data-group-id="9784022027-2">)</span><span class="p">,</span><span class="w">         </span><span class="c1">% 32-byte node identifier</span><span class="w">
    </span><span class="ss">endpoint</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="9784022027-3">(</span><span class="p" data-group-id="9784022027-3">)</span><span class="p">,</span><span class="w">        </span><span class="c1">% Connection endpoint (e.g., &lt;&lt;&quot;https://localhost:9443&quot;&gt;&gt;)</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="9784022027-4">(</span><span class="p" data-group-id="9784022027-4">)</span><span class="p">,</span><span class="w">           </span><span class="c1">% Custom metadata (version, description, etc.)</span><span class="w">
    </span><span class="ss">advertised_at</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="9784022027-5">(</span><span class="p" data-group-id="9784022027-5">)</span><span class="p">,</span><span class="w">  </span><span class="c1">% Unix timestamp</span><span class="w">
    </span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">pos_integer</span><span class="p" data-group-id="9784022027-6">(</span><span class="p" data-group-id="9784022027-6">)</span><span class="w">         </span><span class="c1">% Seconds</span><span class="w">
</span><span class="p" data-group-id="9784022027-1">}</span></code></pre><p><strong>Local Cache Entry</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="4629039582-1">#{</span><span class="w">
    </span><span class="ss">service_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="4629039582-2">(</span><span class="p" data-group-id="4629039582-2">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">providers</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4629039582-3">[</span><span class="n">ProviderInfo</span><span class="p" data-group-id="4629039582-3">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">cached_at</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="4629039582-4">(</span><span class="p" data-group-id="4629039582-4">)</span><span class="p">,</span><span class="w">      </span><span class="c1">% Unix timestamp</span><span class="w">
    </span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">60</span><span class="w">                    </span><span class="c1">% Seconds (hard-coded)</span><span class="w">
</span><span class="p" data-group-id="4629039582-1">}</span></code></pre><hr class="thin"/><h2 id="service-advertisement" class="section-heading"><a href="#service-advertisement" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Service Advertisement</span></h2><h3 id="basic-advertisement" class="section-heading"><a href="#basic-advertisement" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Basic Advertisement</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Erlang</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="4393095343-1">(</span><span class="n">Args</span><span class="p" data-group-id="4393095343-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="4393095343-2">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="4393095343-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="4393095343-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4393095343-4">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">UserId</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4393095343-5">&lt;&lt;</span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="4393095343-5">&gt;&gt;</span><span class="p" data-group-id="4393095343-4">}</span><span class="p" data-group-id="4393095343-3">}</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="4393095343-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_args</span><span class="p" data-group-id="4393095343-6">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">

</span><span class="p" data-group-id="4393095343-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="4393095343-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="4393095343-8">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4393095343-9">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="4393095343-9">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">Handler</span><span class="w">
</span><span class="p" data-group-id="4393095343-8">)</span><span class="p">.</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Elixir</span><span class="w">
</span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="9545277854-1">fn</span><span class="w">
  </span><span class="p" data-group-id="9545277854-2">%{</span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">user_id</span><span class="p" data-group-id="9545277854-2">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9545277854-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9545277854-4">%{</span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="9545277854-4">}</span><span class="p" data-group-id="9545277854-3">}</span><span class="w">

  </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9545277854-5">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:invalid_args</span><span class="p" data-group-id="9545277854-5">}</span><span class="w">
</span><span class="k" data-group-id="9545277854-1">end</span><span class="w">

</span><span class="p" data-group-id="9545277854-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="p" data-group-id="9545277854-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">advertise</span><span class="p" data-group-id="9545277854-7">(</span><span class="w">
  </span><span class="n">client</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;myapp.user.get&quot;</span><span class="p">,</span><span class="w">
  </span><span class="n">handler</span><span class="w">
</span><span class="p" data-group-id="9545277854-7">)</span></code></pre><h3 id="with-options" class="section-heading"><a href="#with-options" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">With Options</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="1988061518-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="1988061518-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="1988061518-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1988061518-3">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="1988061518-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">Handler</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1988061518-4">#{</span><span class="w">
        </span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1988061518-5">#{</span><span class="w">
            </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1988061518-6">&lt;&lt;</span><span class="s">&quot;1.0.0&quot;</span><span class="p" data-group-id="1988061518-6">&gt;&gt;</span><span class="p">,</span><span class="w">
            </span><span class="ss">description</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1988061518-7">&lt;&lt;</span><span class="s">&quot;Fetch user by ID&quot;</span><span class="p" data-group-id="1988061518-7">&gt;&gt;</span><span class="p">,</span><span class="w">
            </span><span class="ss">capabilities</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1988061518-8">[</span><span class="p" data-group-id="1988061518-9">&lt;&lt;</span><span class="s">&quot;read&quot;</span><span class="p" data-group-id="1988061518-9">&gt;&gt;</span><span class="p" data-group-id="1988061518-8">]</span><span class="w">
        </span><span class="p" data-group-id="1988061518-5">}</span><span class="p">,</span><span class="w">
        </span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">300</span><span class="w">  </span><span class="c1">% 5 minutes</span><span class="w">
    </span><span class="p" data-group-id="1988061518-4">}</span><span class="w">
</span><span class="p" data-group-id="1988061518-2">)</span><span class="p">.</span></code></pre><h3 id="handler-function-contract" class="section-heading"><a href="#handler-function-contract" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Handler Function Contract</span></h3><p>Handlers must follow this contract:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">handler_fn</span><span class="p" data-group-id="7507049574-1">(</span><span class="p" data-group-id="7507049574-1">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7507049574-2">(</span><span class="p" data-group-id="7507049574-3">(</span><span class="n">Args</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="7507049574-4">(</span><span class="p" data-group-id="7507049574-4">)</span><span class="p" data-group-id="7507049574-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7507049574-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="7507049574-6">(</span><span class="p" data-group-id="7507049574-6">)</span><span class="p" data-group-id="7507049574-5">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="7507049574-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="7507049574-8">(</span><span class="p" data-group-id="7507049574-8">)</span><span class="p" data-group-id="7507049574-7">}</span><span class="p" data-group-id="7507049574-2">)</span><span class="p">.</span></code></pre><p><strong>Rules</strong>:</p><ul><li>Input: Always a map (even if empty: <code class="inline">#{}</code>)</li><li>Output: Tuple <code class="inline">{ok, Result}</code> or <code class="inline">{error, Reason}</code></li><li>Execution: Handlers run in <strong>spawned processes</strong> (non-blocking)</li><li>Errors: Handler crashes are caught and returned as <code class="inline">{error, {handler_crash, Reason}}</code></li></ul><h3 id="ttl-and-re-advertisement" class="section-heading"><a href="#ttl-and-re-advertisement" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">TTL and Re-advertisement</span></h3><p><strong>Default TTL</strong>: 300 seconds (5 minutes)</p><p>Services must be <strong>re-advertised</strong> before TTL expiration to remain discoverable. Currently this is <strong>manual</strong> - future enhancement will add automatic periodic re-advertisement.</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Manual re-advertisement pattern</span><span class="w">
</span><span class="nf">re_advertise_loop</span><span class="p" data-group-id="4612574409-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="4612574409-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">TTL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="4612574409-2">(</span><span class="ss">ttl</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="mi">300</span><span class="p" data-group-id="4612574409-2">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4612574409-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Ref</span><span class="p" data-group-id="4612574409-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="4612574409-4">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="4612574409-4">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Re-advertise every 4 minutes (before 5-minute TTL expires)</span><span class="w">
    </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="4612574409-5">(</span><span class="p" data-group-id="4612574409-6">(</span><span class="n">TTL</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">60</span><span class="p" data-group-id="4612574409-6">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="4612574409-5">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">re_advertise_loop</span><span class="p" data-group-id="4612574409-7">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="4612574409-7">)</span><span class="p">.</span></code></pre><h3 id="unadvertising" class="section-heading"><a href="#unadvertising" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Unadvertising</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">unadvertise</span><span class="p" data-group-id="7000305447-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7000305447-2">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="7000305447-2">&gt;&gt;</span><span class="p" data-group-id="7000305447-1">)</span><span class="p">.</span></code></pre><p><strong>Behavior</strong>:</p><ol><li>Removes local handler from service registry</li><li>Attempts to remove from DHT (best-effort)</li><li>DHT entries expire naturally via TTL anyway</li></ol><hr class="thin"/><h2 id="service-discovery" class="section-heading"><a href="#service-discovery" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Service Discovery</span></h2><p>Service discovery happens <strong>automatically</strong> when calling a service via <code class="inline">macula:call/2,3</code>.</p><h3 id="discovery-flow" class="section-heading"><a href="#discovery-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Discovery Flow</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check local handler (zero-latency)</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">get_local_handler</span><span class="p" data-group-id="0003083676-1">(</span><span class="n">Registry</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p" data-group-id="0003083676-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="0003083676-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="0003083676-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Execute locally - no network overhead</span><span class="w">
        </span><span class="n">Handler</span><span class="p" data-group-id="0003083676-3">(</span><span class="n">Args</span><span class="p" data-group-id="0003083676-3">)</span><span class="p">;</span><span class="w">

    </span><span class="ss">not_found</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% 2. Check cache (fast path)</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">discover_service</span><span class="p" data-group-id="0003083676-4">(</span><span class="n">Registry</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p" data-group-id="0003083676-4">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="0003083676-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Providers</span><span class="p">,</span><span class="w"> </span><span class="n">Registry2</span><span class="p" data-group-id="0003083676-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="c1">%% Cache hit - use cached providers</span><span class="w">
                </span><span class="nf">pick_provider_and_call</span><span class="p" data-group-id="0003083676-6">(</span><span class="n">Providers</span><span class="p" data-group-id="0003083676-6">)</span><span class="p">;</span><span class="w">

            </span><span class="p" data-group-id="0003083676-7">{</span><span class="ss">cache_miss</span><span class="p">,</span><span class="w"> </span><span class="n">Registry2</span><span class="p" data-group-id="0003083676-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="c1">%% 3. Query DHT (cache miss)</span><span class="w">
                </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">query_dht_for_service</span><span class="p" data-group-id="0003083676-8">(</span><span class="n">DhtPid</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p" data-group-id="0003083676-8">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                    </span><span class="p" data-group-id="0003083676-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Providers</span><span class="p" data-group-id="0003083676-9">}</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">Providers</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="p" data-group-id="0003083676-10">[</span><span class="p" data-group-id="0003083676-10">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="c1">%% Cache the result (60s TTL)</span><span class="w">
                        </span><span class="n">Registry3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">cache_service</span><span class="p" data-group-id="0003083676-11">(</span><span class="w">
                            </span><span class="n">Registry2</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Providers</span><span class="p">,</span><span class="w"> </span><span class="mi">60</span><span class="w">
                        </span><span class="p" data-group-id="0003083676-11">)</span><span class="p">,</span><span class="w">
                        </span><span class="nf">pick_provider_and_call</span><span class="p" data-group-id="0003083676-12">(</span><span class="n">Providers</span><span class="p" data-group-id="0003083676-12">)</span><span class="p">;</span><span class="w">

                    </span><span class="p" data-group-id="0003083676-13">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0003083676-14">[</span><span class="p" data-group-id="0003083676-14">]</span><span class="p" data-group-id="0003083676-13">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="c1">%% No providers found</span><span class="w">
                        </span><span class="p" data-group-id="0003083676-15">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">service_not_found</span><span class="p" data-group-id="0003083676-15">}</span><span class="p">;</span><span class="w">

                    </span><span class="p" data-group-id="0003083676-16">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="0003083676-16">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                        </span><span class="c1">%% DHT unavailable - fallback to direct call</span><span class="w">
                        </span><span class="nf">direct_call_fallback</span><span class="p" data-group-id="0003083676-17">(</span><span class="p" data-group-id="0003083676-17">)</span><span class="w">
                </span><span class="k">end</span><span class="w">
        </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="force-refresh" class="section-heading"><a href="#force-refresh" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Force Refresh</span></h3><p>Skip cache and force DHT query:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="4890088041-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="4890088041-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="4890088041-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4890088041-3">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="4890088041-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4890088041-4">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4890088041-5">&lt;&lt;</span><span class="s">&quot;user-123&quot;</span><span class="p" data-group-id="4890088041-5">&gt;&gt;</span><span class="p" data-group-id="4890088041-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4890088041-6">#{</span><span class="ss">force_refresh</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="4890088041-6">}</span><span class="w">
</span><span class="p" data-group-id="4890088041-2">)</span><span class="p">.</span></code></pre><h3 id="cache-management" class="section-heading"><a href="#cache-management" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Cache Management</span></h3><p><strong>Cache TTL</strong>: 60 seconds (hard-coded in <code class="inline">macula_service_registry</code>)</p><p><strong>Pruning</strong>: Expired entries can be pruned manually:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="9722988020-1">{</span><span class="n">Registry2</span><span class="p">,</span><span class="w"> </span><span class="n">RemovedCount</span><span class="p" data-group-id="9722988020-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">prune_expired</span><span class="p" data-group-id="9722988020-2">(</span><span class="n">Registry</span><span class="p" data-group-id="9722988020-2">)</span><span class="p">.</span></code></pre><p><strong>Clearing</strong>: Clear all cache entries:</p><pre><code class="makeup erlang" translate="no"><span class="n">Registry2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">clear_cache</span><span class="p" data-group-id="5058162826-1">(</span><span class="n">Registry</span><span class="p" data-group-id="5058162826-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="making-rpc-calls" class="section-heading"><a href="#making-rpc-calls" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Making RPC Calls</span></h2><h3 id="basic-call" class="section-heading"><a href="#basic-call" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Basic Call</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Erlang</span><span class="w">
</span><span class="p" data-group-id="3098883336-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p" data-group-id="3098883336-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="3098883336-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="3098883336-3">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="3098883336-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="3098883336-4">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3098883336-5">&lt;&lt;</span><span class="s">&quot;user-123&quot;</span><span class="p" data-group-id="3098883336-5">&gt;&gt;</span><span class="p" data-group-id="3098883336-4">}</span><span class="w">
</span><span class="p" data-group-id="3098883336-2">)</span><span class="p">.</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Elixir</span><span class="w">
</span><span class="p" data-group-id="5786304571-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="5786304571-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="5786304571-2">(</span><span class="w">
  </span><span class="n">client</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;myapp.user.get&quot;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="5786304571-3">%{</span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;user-123&quot;</span><span class="p" data-group-id="5786304571-3">}</span><span class="w">
</span><span class="p" data-group-id="5786304571-2">)</span></code></pre><h3 id="with-timeout" class="section-heading"><a href="#with-timeout" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">With Timeout</span></h3><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="5660346277-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="5660346277-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="5660346277-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5660346277-3">&lt;&lt;</span><span class="s">&quot;slow.operation&quot;</span><span class="p" data-group-id="5660346277-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5660346277-4">#{</span><span class="ss">data</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SomeData</span><span class="p" data-group-id="5660346277-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5660346277-5">#{</span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="5660346277-5">}</span><span class="w">  </span><span class="c1">% 30 seconds</span><span class="w">
</span><span class="p" data-group-id="5660346277-2">)</span><span class="p">.</span></code></pre><h3 id="local-first-pattern" class="section-heading"><a href="#local-first-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Local-First Pattern</span></h3><p>If a service is advertised locally, the call has <strong>zero network overhead</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Node A advertises service</span><span class="w">
</span><span class="p" data-group-id="0796678734-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="0796678734-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="0796678734-2">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0796678734-3">&lt;&lt;</span><span class="s">&quot;calc.add&quot;</span><span class="p" data-group-id="0796678734-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">HandlerFn</span><span class="p" data-group-id="0796678734-2">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Node A calls the same service - executed locally (no network)</span><span class="w">
</span><span class="p" data-group-id="0796678734-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="0796678734-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="0796678734-5">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0796678734-6">&lt;&lt;</span><span class="s">&quot;calc.add&quot;</span><span class="p" data-group-id="0796678734-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0796678734-7">#{</span><span class="ss">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="0796678734-7">}</span><span class="p" data-group-id="0796678734-5">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Result = #{result =&gt; 15}</span></code></pre><p>This is extremely efficient for:</p><ul><li>Self-service calls</li><li>Co-located services on the same node</li><li>Testing and development</li></ul><hr class="thin"/><h2 id="error-handling" class="section-heading"><a href="#error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling</span></h2><h3 id="error-types" class="section-heading"><a href="#error-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Types</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">call_error</span><span class="p" data-group-id="4957927595-1">(</span><span class="p" data-group-id="4957927595-1">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w">
    </span><span class="ss">timeout</span><span class="w"> </span><span class="p">|</span><span class="w">                          </span><span class="c1">% Call timed out</span><span class="w">
    </span><span class="ss">service_not_found</span><span class="w"> </span><span class="p">|</span><span class="w">                </span><span class="c1">% No providers found in DHT</span><span class="w">
    </span><span class="p" data-group-id="4957927595-2">{</span><span class="ss">handler_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="4957927595-3">(</span><span class="p" data-group-id="4957927595-3">)</span><span class="p" data-group-id="4957927595-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="c1">% Handler returned {error, Reason}</span><span class="w">
    </span><span class="p" data-group-id="4957927595-4">{</span><span class="ss">handler_crash</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="4957927595-5">(</span><span class="p" data-group-id="4957927595-5">)</span><span class="p" data-group-id="4957927595-4">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="c1">% Handler process crashed</span><span class="w">
    </span><span class="p" data-group-id="4957927595-6">{</span><span class="ss">connection_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="4957927595-7">(</span><span class="p" data-group-id="4957927595-7">)</span><span class="p" data-group-id="4957927595-6">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="c1">% Network error</span><span class="w">
    </span><span class="nf">term</span><span class="p" data-group-id="4957927595-8">(</span><span class="p" data-group-id="4957927595-8">)</span><span class="p">.</span><span class="w">                            </span><span class="c1">% Other errors</span></code></pre><h3 id="comprehensive-error-handling" class="section-heading"><a href="#comprehensive-error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Comprehensive Error Handling</span></h3><pre><code class="makeup erlang" translate="no"><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="4677829399-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-2">#{</span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p" data-group-id="4677829399-2">}</span><span class="p" data-group-id="4677829399-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="4677829399-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="4677829399-3">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Success</span><span class="w">
        </span><span class="nf">process_result</span><span class="p" data-group-id="4677829399-4">(</span><span class="n">Result</span><span class="p" data-group-id="4677829399-4">)</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="4677829399-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">timeout</span><span class="p" data-group-id="4677829399-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Call timed out after 10 seconds</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_WARNING</span><span class="p" data-group-id="4677829399-6">(</span><span class="s">&quot;RPC call timed out: </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-7">[</span><span class="n">Procedure</span><span class="p" data-group-id="4677829399-7">]</span><span class="p" data-group-id="4677829399-6">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4677829399-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">timeout</span><span class="p" data-group-id="4677829399-8">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="4677829399-9">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">service_not_found</span><span class="p" data-group-id="4677829399-9">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% No providers found in DHT</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_ERROR</span><span class="p" data-group-id="4677829399-10">(</span><span class="s">&quot;Service not available: </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-11">[</span><span class="n">Procedure</span><span class="p" data-group-id="4677829399-11">]</span><span class="p" data-group-id="4677829399-10">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4677829399-12">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">unavailable</span><span class="p" data-group-id="4677829399-12">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="4677829399-13">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-14">{</span><span class="ss">handler_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-14">}</span><span class="p" data-group-id="4677829399-13">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Handler explicitly returned {error, Reason}</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_WARNING</span><span class="p" data-group-id="4677829399-15">(</span><span class="s">&quot;Handler error for </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-16">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-16">]</span><span class="p" data-group-id="4677829399-15">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4677829399-17">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-18">{</span><span class="ss">business_logic_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-18">}</span><span class="p" data-group-id="4677829399-17">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="4677829399-19">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-20">{</span><span class="ss">handler_crash</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-20">}</span><span class="p" data-group-id="4677829399-19">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Handler process crashed</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_ERROR</span><span class="p" data-group-id="4677829399-21">(</span><span class="s">&quot;Handler crashed for </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-22">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-22">]</span><span class="p" data-group-id="4677829399-21">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4677829399-23">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">internal_error</span><span class="p" data-group-id="4677829399-23">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="4677829399-24">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-25">{</span><span class="ss">connection_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-25">}</span><span class="p" data-group-id="4677829399-24">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Network/transport error</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_ERROR</span><span class="p" data-group-id="4677829399-26">(</span><span class="s">&quot;Connection error calling </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-27">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-27">]</span><span class="p" data-group-id="4677829399-26">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4677829399-28">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">network_error</span><span class="p" data-group-id="4677829399-28">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="4677829399-29">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-29">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Catch-all for other errors</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_ERROR</span><span class="p" data-group-id="4677829399-30">(</span><span class="s">&quot;Unexpected error calling </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4677829399-31">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4677829399-31">]</span><span class="p" data-group-id="4677829399-30">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4677829399-32">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">unknown_error</span><span class="p" data-group-id="4677829399-32">}</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="retry-pattern" class="section-heading"><a href="#retry-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Retry Pattern</span></h3><pre><code class="makeup erlang" translate="no"><span class="nf">call_with_retry</span><span class="p" data-group-id="5062131271-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">MaxRetries</span><span class="p" data-group-id="5062131271-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">call_with_retry</span><span class="p" data-group-id="5062131271-2">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">MaxRetries</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5062131271-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">call_with_retry</span><span class="p" data-group-id="5062131271-3">(</span><span class="p">_</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">MaxRetries</span><span class="p">,</span><span class="w"> </span><span class="n">Attempt</span><span class="p" data-group-id="5062131271-3">)</span><span class="w">
        </span><span class="k">when</span><span class="w"> </span><span class="n">Attempt</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MaxRetries</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5062131271-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">max_retries_exceeded</span><span class="p" data-group-id="5062131271-4">}</span><span class="p">;</span><span class="w">

</span><span class="nf">call_with_retry</span><span class="p" data-group-id="5062131271-5">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">MaxRetries</span><span class="p">,</span><span class="w"> </span><span class="n">Attempt</span><span class="p" data-group-id="5062131271-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="5062131271-6">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5062131271-7">#{</span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="5062131271-7">}</span><span class="p" data-group-id="5062131271-6">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="5062131271-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="5062131271-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5062131271-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="5062131271-9">}</span><span class="p">;</span><span class="w">

        </span><span class="p" data-group-id="5062131271-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">timeout</span><span class="p" data-group-id="5062131271-10">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Retry on timeout</span><span class="w">
            </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="5062131271-11">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p" data-group-id="5062131271-12">(</span><span class="n">Attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5062131271-12">)</span><span class="p" data-group-id="5062131271-11">)</span><span class="p">,</span><span class="w">  </span><span class="c1">% Exponential backoff</span><span class="w">
            </span><span class="nf">call_with_retry</span><span class="p" data-group-id="5062131271-13">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">MaxRetries</span><span class="p">,</span><span class="w"> </span><span class="n">Attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5062131271-13">)</span><span class="p">;</span><span class="w">

        </span><span class="p" data-group-id="5062131271-14">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5062131271-15">{</span><span class="ss">connection_error</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="5062131271-15">}</span><span class="p" data-group-id="5062131271-14">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Retry on connection errors</span><span class="w">
            </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="5062131271-16">(</span><span class="mi">1000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p" data-group-id="5062131271-17">(</span><span class="n">Attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5062131271-17">)</span><span class="p" data-group-id="5062131271-16">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">call_with_retry</span><span class="p" data-group-id="5062131271-18">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">MaxRetries</span><span class="p">,</span><span class="w"> </span><span class="n">Attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5062131271-18">)</span><span class="p">;</span><span class="w">

        </span><span class="p" data-group-id="5062131271-19">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5062131271-19">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Don&#39;t retry on business logic errors</span><span class="w">
            </span><span class="p" data-group-id="5062131271-20">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5062131271-20">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="performance-optimization" class="section-heading"><a href="#performance-optimization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Optimization</span></h2><h3 id="local-first-optimization" class="section-heading"><a href="#local-first-optimization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Local-First Optimization</span></h3><p><strong>Zero-latency local calls</strong>:</p><ul><li>Local handlers checked first</li><li>No network overhead if service advertised locally</li><li>Ideal for co-located services</li></ul><h3 id="caching-strategy" class="section-heading"><a href="#caching-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Caching Strategy</span></h3><p><strong>60-second cache TTL</strong>:</p><ul><li>DHT queries cached for 60 seconds</li><li>Reduces DHT load</li><li>Balances freshness vs performance</li></ul><p><strong>Cache hit ratio</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Cache</span><span class="w"> </span><span class="n">Hit</span><span class="w"> </span><span class="n">Ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0374521661-1">(</span><span class="n">Cache</span><span class="w"> </span><span class="n">Hits</span><span class="p" data-group-id="0374521661-1">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p" data-group-id="0374521661-2">(</span><span class="n">Total</span><span class="w"> </span><span class="n">Calls</span><span class="p" data-group-id="0374521661-2">)</span><span class="w">

</span><span class="n">Example</span><span class="p">:</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Service</span><span class="w"> </span><span class="ss">called</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="ss">times</span><span class="o">/</span><span class="ss">minute</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="n">TTL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="ss">seconds</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">queries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">~</span><span class="mi">2</span><span class="o">/</span><span class="nf">minute</span><span class="w"> </span><span class="p" data-group-id="0374521661-3">(</span><span class="ss">every</span><span class="w"> </span><span class="mi">60</span><span class="ss">s</span><span class="p" data-group-id="0374521661-3">)</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="ss">hit</span><span class="w"> </span><span class="ss">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">98</span><span class="c1">%</span></code></pre><h3 id="dht-query-optimization" class="section-heading"><a href="#dht-query-optimization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">DHT Query Optimization</span></h3><p><strong>Kademlia K-value</strong>: 20 (standard)</p><ul><li>Stores service advertisement on 20 nodes</li><li>High availability even if nodes fail</li><li>Fast lookups (log N hops)</li></ul><p><strong>SHA-256 Key Distribution</strong>:</p><ul><li>Deterministic key generation</li><li>Even distribution across DHT keyspace</li><li>Prevents hotspots</li></ul><h3 id="provider-selection" class="section-heading"><a href="#provider-selection" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Provider Selection</span></h3><p><strong>Current</strong>: Simple first-provider selection</p><p><strong>Future enhancements</strong>:</p><ul><li>Round-robin load balancing</li><li>Random selection</li><li>Least-loaded provider</li><li>Geographic proximity</li><li>Custom selection strategies</li></ul><h3 id="graceful-degradation" class="section-heading"><a href="#graceful-degradation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Graceful Degradation</span></h3><p><strong>DHT unavailable</strong>:</p><ul><li>Logs warning but continues</li><li>Falls back to direct call to connected endpoint</li><li>Local services still work</li></ul><p><strong>Network partitions</strong>:</p><ul><li>Each partition has local DHT</li><li>Services discoverable within partition</li><li>Automatic recovery when partition heals</li></ul><hr class="thin"/><h2 id="best-practices" class="section-heading"><a href="#best-practices" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Best Practices</span></h2><h3 id="service-naming" class="section-heading"><a href="#service-naming" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Service Naming</span></h3><p>Use <strong>hierarchical naming</strong> with dot-separated segments:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Good</span><span class="w">
</span><span class="p" data-group-id="4080821905-1">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="4080821905-1">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="4080821905-2">&lt;&lt;</span><span class="s">&quot;energy.home.measure&quot;</span><span class="p" data-group-id="4080821905-2">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="4080821905-3">&lt;&lt;</span><span class="s">&quot;payment.invoice.create&quot;</span><span class="p" data-group-id="4080821905-3">&gt;&gt;</span><span class="w">

</span><span class="c1">%% Avoid</span><span class="w">
</span><span class="p" data-group-id="4080821905-4">&lt;&lt;</span><span class="s">&quot;get_user&quot;</span><span class="p" data-group-id="4080821905-4">&gt;&gt;</span><span class="w">          </span><span class="c1">% Not namespaced</span><span class="w">
</span><span class="p" data-group-id="4080821905-5">&lt;&lt;</span><span class="s">&quot;user&quot;</span><span class="p" data-group-id="4080821905-5">&gt;&gt;</span><span class="w">              </span><span class="c1">% Too generic</span><span class="w">
</span><span class="p" data-group-id="4080821905-6">&lt;&lt;</span><span class="s">&quot;user-get&quot;</span><span class="p" data-group-id="4080821905-6">&gt;&gt;</span><span class="w">          </span><span class="c1">% Use dots, not dashes</span></code></pre><h3 id="handler-design" class="section-heading"><a href="#handler-design" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Handler Design</span></h3><p><strong>Keep handlers simple</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Good - simple, focused</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="2810600311-1">(</span><span class="p" data-group-id="2810600311-2">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="2810600311-2">}</span><span class="p" data-group-id="2810600311-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">user_db</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2810600311-3">(</span><span class="n">UserId</span><span class="p" data-group-id="2810600311-3">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2810600311-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p" data-group-id="2810600311-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2810600311-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p" data-group-id="2810600311-5">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">not_found</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2810600311-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_found</span><span class="p" data-group-id="2810600311-6">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Avoid - complex logic in handler</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="2810600311-7">(</span><span class="n">Args</span><span class="p" data-group-id="2810600311-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Don&#39;t do heavy processing in handler</span><span class="w">
    </span><span class="c1">%% Spawn workers if needed</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2810600311-8">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2810600311-9">&lt;&lt;</span><span class="s">&quot;create&quot;</span><span class="p" data-group-id="2810600311-9">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">data</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2810600311-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Heavy processing...</span><span class="w">
        </span><span class="p" data-group-id="2810600311-10">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2810600311-11">&lt;&lt;</span><span class="s">&quot;update&quot;</span><span class="p" data-group-id="2810600311-11">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">data</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2810600311-10">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% More heavy processing...</span><span class="w">
        </span><span class="p" data-group-id="2810600311-12">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="2810600311-13">&lt;&lt;</span><span class="s">&quot;delete&quot;</span><span class="p" data-group-id="2810600311-13">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Id</span><span class="p" data-group-id="2810600311-12">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Even more processing...</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><p><strong>Pattern matching on function heads</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Good - separate functions for different actions</span><span class="w">
</span><span class="nf">handle_get</span><span class="p" data-group-id="3616401956-1">(</span><span class="p" data-group-id="3616401956-2">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="3616401956-2">}</span><span class="p" data-group-id="3616401956-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">user_db</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="3616401956-3">(</span><span class="n">UserId</span><span class="p" data-group-id="3616401956-3">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_create</span><span class="p" data-group-id="3616401956-4">(</span><span class="p" data-group-id="3616401956-5">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Email</span><span class="p" data-group-id="3616401956-5">}</span><span class="p" data-group-id="3616401956-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">user_db</span><span class="p">:</span><span class="nf">create</span><span class="p" data-group-id="3616401956-6">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Email</span><span class="p" data-group-id="3616401956-6">)</span><span class="p">.</span><span class="w">

</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3616401956-7">(</span><span class="n">Args</span><span class="p" data-group-id="3616401956-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="3616401956-8">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="3616401956-9">&lt;&lt;</span><span class="s">&quot;get&quot;</span><span class="p" data-group-id="3616401956-9">&gt;&gt;</span><span class="p" data-group-id="3616401956-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_get</span><span class="p" data-group-id="3616401956-10">(</span><span class="n">Args</span><span class="p" data-group-id="3616401956-10">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="3616401956-11">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="3616401956-12">&lt;&lt;</span><span class="s">&quot;create&quot;</span><span class="p" data-group-id="3616401956-12">&gt;&gt;</span><span class="p" data-group-id="3616401956-11">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_create</span><span class="p" data-group-id="3616401956-13">(</span><span class="n">Args</span><span class="p" data-group-id="3616401956-13">)</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3616401956-14">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_action</span><span class="p" data-group-id="3616401956-14">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="metadata-usage" class="section-heading"><a href="#metadata-usage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Metadata Usage</span></h3><p><strong>Include useful metadata</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="3686960917-1">#{</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-2">#{</span><span class="w">
        </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-3">&lt;&lt;</span><span class="s">&quot;1.2.3&quot;</span><span class="p" data-group-id="3686960917-3">&gt;&gt;</span><span class="p">,</span><span class="w">              </span><span class="c1">% Semantic version</span><span class="w">
        </span><span class="ss">description</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-4">&lt;&lt;</span><span class="s">&quot;User management&quot;</span><span class="p" data-group-id="3686960917-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">% Human-readable description</span><span class="w">
        </span><span class="ss">capabilities</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-5">[</span><span class="p" data-group-id="3686960917-6">&lt;&lt;</span><span class="s">&quot;read&quot;</span><span class="p" data-group-id="3686960917-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3686960917-7">&lt;&lt;</span><span class="s">&quot;write&quot;</span><span class="p" data-group-id="3686960917-7">&gt;&gt;</span><span class="p" data-group-id="3686960917-5">]</span><span class="p">,</span><span class="w"> </span><span class="c1">% What it can do</span><span class="w">
        </span><span class="ss">schema</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-8">#{</span><span class="w">                         </span><span class="c1">% Input/output schema</span><span class="w">
            </span><span class="ss">input</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-9">[</span><span class="ss">user_id</span><span class="p" data-group-id="3686960917-9">]</span><span class="p">,</span><span class="w">
            </span><span class="ss">output</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3686960917-10">[</span><span class="ss">user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="p" data-group-id="3686960917-10">]</span><span class="w">
        </span><span class="p" data-group-id="3686960917-8">}</span><span class="w">
    </span><span class="p" data-group-id="3686960917-2">}</span><span class="w">
</span><span class="p" data-group-id="3686960917-1">}</span></code></pre><h3 id="ttl-configuration" class="section-heading"><a href="#ttl-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">TTL Configuration</span></h3><p><strong>Choose TTL based on service characteristics</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Long-lived services (rarely change)</span><span class="w">
</span><span class="p" data-group-id="3803282653-1">#{</span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3600</span><span class="p" data-group-id="3803282653-1">}</span><span class="w">  </span><span class="c1">% 1 hour</span><span class="w">

</span><span class="c1">%% Normal services</span><span class="w">
</span><span class="p" data-group-id="3803282653-2">#{</span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">300</span><span class="p" data-group-id="3803282653-2">}</span><span class="w">   </span><span class="c1">% 5 minutes (default)</span><span class="w">

</span><span class="c1">%% Dynamic services (frequently changing)</span><span class="w">
</span><span class="p" data-group-id="3803282653-3">#{</span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">60</span><span class="p" data-group-id="3803282653-3">}</span><span class="w">    </span><span class="c1">% 1 minute</span></code></pre><h3 id="error-handling-in-handlers" class="section-heading"><a href="#error-handling-in-handlers" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling in Handlers</span></h3><p><strong>Always return proper error tuples</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3300073014-1">(</span><span class="n">Args</span><span class="p" data-group-id="3300073014-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">try</span><span class="w">
        </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">do_work</span><span class="p" data-group-id="3300073014-2">(</span><span class="n">Args</span><span class="p" data-group-id="3300073014-2">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="3300073014-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="3300073014-3">}</span><span class="w">
    </span><span class="k">catch</span><span class="w">
        </span><span class="nc">error</span><span class="p">:</span><span class="p" data-group-id="3300073014-4">{</span><span class="ss">badmatch</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="3300073014-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="3300073014-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_args</span><span class="p" data-group-id="3300073014-5">}</span><span class="p">;</span><span class="w">
        </span><span class="nc">error</span><span class="p">:</span><span class="ss">database_error</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="3300073014-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">service_unavailable</span><span class="p" data-group-id="3300073014-6">}</span><span class="p">;</span><span class="w">
        </span><span class="n">Class</span><span class="p">:</span><span class="n">Reason</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="o">?</span><span class="n">LOG_ERROR</span><span class="p" data-group-id="3300073014-7">(</span><span class="s">&quot;Handler crashed: </span><span class="si">~p</span><span class="s">:</span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3300073014-8">[</span><span class="n">Class</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="3300073014-8">]</span><span class="p" data-group-id="3300073014-7">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="3300073014-9">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">internal_error</span><span class="p" data-group-id="3300073014-9">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="monitoring" class="section-heading"><a href="#monitoring" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Monitoring</span></h3><p><strong>Log important events</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% On advertisement</span><span class="w">
</span><span class="o">?</span><span class="n">LOG_INFO</span><span class="p" data-group-id="9202387388-1">(</span><span class="s">&quot;Advertised service </span><span class="si">~s</span><span class="s"> with metadata </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9202387388-2">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p" data-group-id="9202387388-2">]</span><span class="p" data-group-id="9202387388-1">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% On DHT publish success/failure</span><span class="w">
</span><span class="o">?</span><span class="n">LOG_INFO</span><span class="p" data-group-id="9202387388-3">(</span><span class="s">&quot;Published service </span><span class="si">~s</span><span class="s"> to DHT&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9202387388-4">[</span><span class="n">Procedure</span><span class="p" data-group-id="9202387388-4">]</span><span class="p" data-group-id="9202387388-3">)</span><span class="p">,</span><span class="w">
</span><span class="o">?</span><span class="n">LOG_WARNING</span><span class="p" data-group-id="9202387388-5">(</span><span class="s">&quot;Failed to publish service </span><span class="si">~s</span><span class="s"> to DHT: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9202387388-6">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="9202387388-6">]</span><span class="p" data-group-id="9202387388-5">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% On service calls</span><span class="w">
</span><span class="o">?</span><span class="n">LOG_DEBUG</span><span class="p" data-group-id="9202387388-7">(</span><span class="s">&quot;Calling service </span><span class="si">~s</span><span class="s"> with args </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9202387388-8">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="9202387388-8">]</span><span class="p" data-group-id="9202387388-7">)</span><span class="p">,</span><span class="w">
</span><span class="o">?</span><span class="n">LOG_INFO</span><span class="p" data-group-id="9202387388-9">(</span><span class="s">&quot;Service </span><span class="si">~s</span><span class="s"> completed in </span><span class="si">~p</span><span class="s"> ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9202387388-10">[</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p" data-group-id="9202387388-10">]</span><span class="p" data-group-id="9202387388-9">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="examples" class="section-heading"><a href="#examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Examples</span></h2><h3 id="example-1-calculator-service" class="section-heading"><a href="#example-1-calculator-service" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 1: Calculator Service</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% calculator_service.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="4259779717-1">(</span><span class="ss">calculator_service</span><span class="p" data-group-id="4259779717-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="4259779717-2">(</span><span class="p" data-group-id="4259779717-3">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">advertise</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="4259779717-3">]</span><span class="p" data-group-id="4259779717-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="4259779717-4">(</span><span class="n">Client</span><span class="p" data-group-id="4259779717-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="4259779717-5">(</span><span class="n">Args</span><span class="p" data-group-id="4259779717-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="n">Args</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="4259779717-6">#{</span><span class="ss">operation</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="4259779717-7">&lt;&lt;</span><span class="s">&quot;add&quot;</span><span class="p" data-group-id="4259779717-7">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-6">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="p" data-group-id="4259779717-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-9">#{</span><span class="ss">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-9">}</span><span class="p" data-group-id="4259779717-8">}</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="4259779717-10">#{</span><span class="ss">operation</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="4259779717-11">&lt;&lt;</span><span class="s">&quot;subtract&quot;</span><span class="p" data-group-id="4259779717-11">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-10">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="p" data-group-id="4259779717-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-13">#{</span><span class="ss">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-13">}</span><span class="p" data-group-id="4259779717-12">}</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="4259779717-14">#{</span><span class="ss">operation</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="4259779717-15">&lt;&lt;</span><span class="s">&quot;multiply&quot;</span><span class="p" data-group-id="4259779717-15">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-14">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="p" data-group-id="4259779717-16">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-17">#{</span><span class="ss">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-17">}</span><span class="p" data-group-id="4259779717-16">}</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="4259779717-18">#{</span><span class="ss">operation</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="4259779717-19">&lt;&lt;</span><span class="s">&quot;divide&quot;</span><span class="p" data-group-id="4259779717-19">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="4259779717-18">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="p" data-group-id="4259779717-20">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">division_by_zero</span><span class="p" data-group-id="4259779717-20">}</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="4259779717-21">#{</span><span class="ss">operation</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="4259779717-22">&lt;&lt;</span><span class="s">&quot;divide&quot;</span><span class="p" data-group-id="4259779717-22">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-21">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="p" data-group-id="4259779717-23">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-24">#{</span><span class="ss">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="4259779717-24">}</span><span class="p" data-group-id="4259779717-23">}</span><span class="p">;</span><span class="w">
            </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="p" data-group-id="4259779717-25">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_operation</span><span class="p" data-group-id="4259779717-25">}</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="4259779717-26">(</span><span class="w">
        </span><span class="n">Peer</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4259779717-27">&lt;&lt;</span><span class="s">&quot;calculator.compute&quot;</span><span class="p" data-group-id="4259779717-27">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="n">Handler</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="4259779717-28">#{</span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4259779717-29">#{</span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4259779717-30">&lt;&lt;</span><span class="s">&quot;1.0.0&quot;</span><span class="p" data-group-id="4259779717-30">&gt;&gt;</span><span class="p" data-group-id="4259779717-29">}</span><span class="p" data-group-id="4259779717-28">}</span><span class="w">
    </span><span class="p" data-group-id="4259779717-26">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Client code</span><span class="w">
</span><span class="p" data-group-id="4259779717-31">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="4259779717-31">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="4259779717-32">(</span><span class="p" data-group-id="4259779717-33">&lt;&lt;</span><span class="s">&quot;https://localhost:9443&quot;</span><span class="p" data-group-id="4259779717-33">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-34">#{</span><span class="p" data-group-id="4259779717-34">}</span><span class="p" data-group-id="4259779717-32">)</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="4259779717-35">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Ref</span><span class="p" data-group-id="4259779717-35">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">calculator_service</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="4259779717-36">(</span><span class="n">Client</span><span class="p" data-group-id="4259779717-36">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Make calls</span><span class="w">
</span><span class="p" data-group-id="4259779717-37">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-38">#{</span><span class="ss">result</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="mi">15</span><span class="p" data-group-id="4259779717-38">}</span><span class="p" data-group-id="4259779717-37">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="4259779717-39">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4259779717-40">&lt;&lt;</span><span class="s">&quot;calculator.compute&quot;</span><span class="p" data-group-id="4259779717-40">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4259779717-41">#{</span><span class="ss">operation</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4259779717-42">&lt;&lt;</span><span class="s">&quot;add&quot;</span><span class="p" data-group-id="4259779717-42">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">a</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="ss">b</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="4259779717-41">}</span><span class="w">
</span><span class="p" data-group-id="4259779717-39">)</span><span class="p">.</span></code></pre><h3 id="example-2-user-service-with-database" class="section-heading"><a href="#example-2-user-service-with-database" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 2: User Service with Database</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% user_service.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="1398798338-1">(</span><span class="ss">user_service</span><span class="p" data-group-id="1398798338-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1398798338-2">(</span><span class="p" data-group-id="1398798338-3">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="1398798338-3">]</span><span class="p" data-group-id="1398798338-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="1398798338-4">(</span><span class="n">Client</span><span class="p" data-group-id="1398798338-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="1398798338-5">(</span><span class="n">Args</span><span class="p" data-group-id="1398798338-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nf">handle_request</span><span class="p" data-group-id="1398798338-6">(</span><span class="n">Args</span><span class="p" data-group-id="1398798338-6">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="1398798338-7">(</span><span class="w">
        </span><span class="n">Peer</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="1398798338-8">&lt;&lt;</span><span class="s">&quot;users.manage&quot;</span><span class="p" data-group-id="1398798338-8">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="n">Handler</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="1398798338-9">#{</span><span class="w">
            </span><span class="ss">metadata</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-10">#{</span><span class="w">
                </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-11">&lt;&lt;</span><span class="s">&quot;2.0.0&quot;</span><span class="p" data-group-id="1398798338-11">&gt;&gt;</span><span class="p">,</span><span class="w">
                </span><span class="ss">capabilities</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-12">[</span><span class="p" data-group-id="1398798338-13">&lt;&lt;</span><span class="s">&quot;read&quot;</span><span class="p" data-group-id="1398798338-13">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1398798338-14">&lt;&lt;</span><span class="s">&quot;write&quot;</span><span class="p" data-group-id="1398798338-14">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1398798338-15">&lt;&lt;</span><span class="s">&quot;delete&quot;</span><span class="p" data-group-id="1398798338-15">&gt;&gt;</span><span class="p" data-group-id="1398798338-12">]</span><span class="w">
            </span><span class="p" data-group-id="1398798338-10">}</span><span class="p">,</span><span class="w">
            </span><span class="ss">ttl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">300</span><span class="w">
        </span><span class="p" data-group-id="1398798338-9">}</span><span class="w">
    </span><span class="p" data-group-id="1398798338-7">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_request</span><span class="p" data-group-id="1398798338-16">(</span><span class="p" data-group-id="1398798338-17">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="1398798338-18">&lt;&lt;</span><span class="s">&quot;get&quot;</span><span class="p" data-group-id="1398798338-18">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="1398798338-17">}</span><span class="p" data-group-id="1398798338-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">user_db</span><span class="p">:</span><span class="nf">fetch</span><span class="p" data-group-id="1398798338-19">(</span><span class="n">UserId</span><span class="p" data-group-id="1398798338-19">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1398798338-20">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p" data-group-id="1398798338-20">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-21">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p" data-group-id="1398798338-21">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">not_found</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-22">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">user_not_found</span><span class="p" data-group-id="1398798338-22">}</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_request</span><span class="p" data-group-id="1398798338-23">(</span><span class="p" data-group-id="1398798338-24">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="1398798338-25">&lt;&lt;</span><span class="s">&quot;create&quot;</span><span class="p" data-group-id="1398798338-25">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Email</span><span class="p" data-group-id="1398798338-24">}</span><span class="p" data-group-id="1398798338-23">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">user_db</span><span class="p">:</span><span class="nf">create</span><span class="p" data-group-id="1398798338-26">(</span><span class="p" data-group-id="1398798338-27">#{</span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Email</span><span class="p" data-group-id="1398798338-27">}</span><span class="p" data-group-id="1398798338-26">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1398798338-28">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="1398798338-28">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1398798338-29">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1398798338-30">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">UserId</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="ss">email</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Email</span><span class="p" data-group-id="1398798338-30">}</span><span class="p" data-group-id="1398798338-29">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1398798338-31">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1398798338-31">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1398798338-32">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1398798338-32">}</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_request</span><span class="p" data-group-id="1398798338-33">(</span><span class="p" data-group-id="1398798338-34">#{</span><span class="ss">action</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="1398798338-35">&lt;&lt;</span><span class="s">&quot;delete&quot;</span><span class="p" data-group-id="1398798338-35">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="1398798338-34">}</span><span class="p" data-group-id="1398798338-33">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">user_db</span><span class="p">:</span><span class="nf">delete</span><span class="p" data-group-id="1398798338-36">(</span><span class="n">UserId</span><span class="p" data-group-id="1398798338-36">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-37">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1398798338-38">#{</span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-39">&lt;&lt;</span><span class="s">&quot;deleted&quot;</span><span class="p" data-group-id="1398798338-39">&gt;&gt;</span><span class="p" data-group-id="1398798338-38">}</span><span class="p" data-group-id="1398798338-37">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1398798338-40">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1398798338-40">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1398798338-41">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1398798338-41">}</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_request</span><span class="p" data-group-id="1398798338-42">(</span><span class="p">_</span><span class="p" data-group-id="1398798338-42">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1398798338-43">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_action</span><span class="p" data-group-id="1398798338-43">}</span><span class="p">.</span></code></pre><h3 id="example-3-multi-provider-discovery" class="section-heading"><a href="#example-3-multi-provider-discovery" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 3: Multi-Provider Discovery</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Provider Node 1</span><span class="w">
</span><span class="p" data-group-id="7492000996-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client1</span><span class="p" data-group-id="7492000996-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="7492000996-2">(</span><span class="p" data-group-id="7492000996-3">&lt;&lt;</span><span class="s">&quot;https://node1:9443&quot;</span><span class="p" data-group-id="7492000996-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7492000996-4">#{</span><span class="p" data-group-id="7492000996-4">}</span><span class="p" data-group-id="7492000996-2">)</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="7492000996-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="7492000996-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="7492000996-6">(</span><span class="n">Client1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7492000996-7">&lt;&lt;</span><span class="s">&quot;weather.get&quot;</span><span class="p" data-group-id="7492000996-7">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Handler1</span><span class="p" data-group-id="7492000996-6">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Provider Node 2</span><span class="w">
</span><span class="p" data-group-id="7492000996-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client2</span><span class="p" data-group-id="7492000996-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="7492000996-9">(</span><span class="p" data-group-id="7492000996-10">&lt;&lt;</span><span class="s">&quot;https://node2:9443&quot;</span><span class="p" data-group-id="7492000996-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7492000996-11">#{</span><span class="p" data-group-id="7492000996-11">}</span><span class="p" data-group-id="7492000996-9">)</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="7492000996-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="7492000996-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="7492000996-13">(</span><span class="n">Client2</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7492000996-14">&lt;&lt;</span><span class="s">&quot;weather.get&quot;</span><span class="p" data-group-id="7492000996-14">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Handler2</span><span class="p" data-group-id="7492000996-13">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Consumer Node</span><span class="w">
</span><span class="p" data-group-id="7492000996-15">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client3</span><span class="p" data-group-id="7492000996-15">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="7492000996-16">(</span><span class="p" data-group-id="7492000996-17">&lt;&lt;</span><span class="s">&quot;https://node3:9443&quot;</span><span class="p" data-group-id="7492000996-17">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7492000996-18">#{</span><span class="p" data-group-id="7492000996-18">}</span><span class="p" data-group-id="7492000996-16">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Call service - DHT returns both providers</span><span class="w">
</span><span class="c1">%% One is selected automatically</span><span class="w">
</span><span class="p" data-group-id="7492000996-19">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Weather</span><span class="p" data-group-id="7492000996-19">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="7492000996-20">(</span><span class="w">
    </span><span class="n">Client3</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="7492000996-21">&lt;&lt;</span><span class="s">&quot;weather.get&quot;</span><span class="p" data-group-id="7492000996-21">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="7492000996-22">#{</span><span class="ss">city</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7492000996-23">&lt;&lt;</span><span class="s">&quot;Brussels&quot;</span><span class="p" data-group-id="7492000996-23">&gt;&gt;</span><span class="p" data-group-id="7492000996-22">}</span><span class="w">
</span><span class="p" data-group-id="7492000996-20">)</span><span class="p">.</span></code></pre><h3 id="example-4-elixir-phoenix-application" class="section-heading"><a href="#example-4-elixir-phoenix-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 4: Elixir Phoenix Application</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/macula_rpc.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.MaculaRPC</span><span class="w"> </span><span class="k" data-group-id="2036565403-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="2036565403-2">(</span><span class="n">opts</span><span class="p" data-group-id="2036565403-2">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-3">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="2036565403-4">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="2036565403-4">)</span><span class="w">
  </span><span class="k" data-group-id="2036565403-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="2036565403-5">(</span><span class="c">_opts</span><span class="p" data-group-id="2036565403-5">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-6">do</span><span class="w">
    </span><span class="p" data-group-id="2036565403-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="2036565403-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="2036565403-8">(</span><span class="s">&quot;https://localhost:9443&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-9">%{</span><span class="w">
      </span><span class="ss">realm</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;com.myapp&quot;</span><span class="w">
    </span><span class="p" data-group-id="2036565403-9">}</span><span class="p" data-group-id="2036565403-8">)</span><span class="w">

    </span><span class="c1"># Advertise multiple services</span><span class="w">
    </span><span class="n">advertise_services</span><span class="p" data-group-id="2036565403-10">(</span><span class="n">client</span><span class="p" data-group-id="2036565403-10">)</span><span class="w">

    </span><span class="p" data-group-id="2036565403-11">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-12">%{</span><span class="ss">client</span><span class="p">:</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="2036565403-12">}</span><span class="p" data-group-id="2036565403-11">}</span><span class="w">
  </span><span class="k" data-group-id="2036565403-6">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">advertise_services</span><span class="p" data-group-id="2036565403-13">(</span><span class="n">client</span><span class="p" data-group-id="2036565403-13">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-14">do</span><span class="w">
    </span><span class="c1"># User service</span><span class="w">
    </span><span class="n">user_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="2036565403-15">fn</span><span class="w">
      </span><span class="p" data-group-id="2036565403-16">%{</span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">user_id</span><span class="p" data-group-id="2036565403-16">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">MyApp.Users</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="2036565403-17">(</span><span class="n">user_id</span><span class="p" data-group-id="2036565403-17">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-18">do</span><span class="w">
          </span><span class="p" data-group-id="2036565403-19">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="2036565403-19">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2036565403-20">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="2036565403-20">}</span><span class="w">
          </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2036565403-21">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:not_found</span><span class="p" data-group-id="2036565403-21">}</span><span class="w">
        </span><span class="k" data-group-id="2036565403-18">end</span><span class="w">

      </span><span class="p" data-group-id="2036565403-22">%{</span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">params</span><span class="p">:</span><span class="w"> </span><span class="n">params</span><span class="p" data-group-id="2036565403-22">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">MyApp.Users</span><span class="o">.</span><span class="n">create</span><span class="p" data-group-id="2036565403-23">(</span><span class="n">params</span><span class="p" data-group-id="2036565403-23">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-24">do</span><span class="w">
          </span><span class="p" data-group-id="2036565403-25">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="2036565403-25">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2036565403-26">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="2036565403-26">}</span><span class="w">
          </span><span class="p" data-group-id="2036565403-27">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="2036565403-27">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2036565403-28">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-29">{</span><span class="ss">:validation</span><span class="p">,</span><span class="w"> </span><span class="n">changeset</span><span class="p" data-group-id="2036565403-29">}</span><span class="p" data-group-id="2036565403-28">}</span><span class="w">
        </span><span class="k" data-group-id="2036565403-24">end</span><span class="w">
    </span><span class="k" data-group-id="2036565403-15">end</span><span class="w">

    </span><span class="nc">:macula</span><span class="o">.</span><span class="n">advertise</span><span class="p" data-group-id="2036565403-30">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;myapp.users&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_handler</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-31">%{</span><span class="w">
      </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2036565403-32">%{</span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User management&quot;</span><span class="p" data-group-id="2036565403-32">}</span><span class="w">
    </span><span class="p" data-group-id="2036565403-31">}</span><span class="p" data-group-id="2036565403-30">)</span><span class="w">

    </span><span class="c1"># Post service</span><span class="w">
    </span><span class="n">post_handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="2036565403-33">fn</span><span class="w"> </span><span class="n">args</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">MyApp.Posts</span><span class="o">.</span><span class="n">handle_rpc</span><span class="p" data-group-id="2036565403-34">(</span><span class="n">args</span><span class="p" data-group-id="2036565403-34">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-33">end</span><span class="w">

    </span><span class="nc">:macula</span><span class="o">.</span><span class="n">advertise</span><span class="p" data-group-id="2036565403-35">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;myapp.posts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">post_handler</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-36">%{</span><span class="w">
      </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2036565403-37">%{</span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p" data-group-id="2036565403-37">}</span><span class="w">
    </span><span class="p" data-group-id="2036565403-36">}</span><span class="p" data-group-id="2036565403-35">)</span><span class="w">
  </span><span class="k" data-group-id="2036565403-14">end</span><span class="w">

  </span><span class="c1"># Client wrapper</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">call</span><span class="p" data-group-id="2036565403-38">(</span><span class="n">procedure</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="w"> </span><span class="o">\\</span><span class="w"> </span><span class="p" data-group-id="2036565403-39">%{</span><span class="p" data-group-id="2036565403-39">}</span><span class="p" data-group-id="2036565403-38">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-40">do</span><span class="w">
    </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="2036565403-41">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="ss">:get_client</span><span class="p" data-group-id="2036565403-41">)</span><span class="w">
    </span><span class="nc">:macula</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="2036565403-42">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">procedure</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="2036565403-42">)</span><span class="w">
  </span><span class="k" data-group-id="2036565403-40">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="2036565403-43">(</span><span class="ss">:get_client</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-44">%{</span><span class="ss">client</span><span class="p">:</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="2036565403-44">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="2036565403-43">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-45">do</span><span class="w">
    </span><span class="p" data-group-id="2036565403-46">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="2036565403-46">}</span><span class="w">
  </span><span class="k" data-group-id="2036565403-45">end</span><span class="w">
</span><span class="k" data-group-id="2036565403-1">end</span><span class="w">

</span><span class="c1"># Usage in Phoenix controller</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.UserController</span><span class="w"> </span><span class="k" data-group-id="2036565403-47">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">MyAppWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:controller</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">show</span><span class="p" data-group-id="2036565403-48">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-49">%{</span><span class="s">&quot;id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="2036565403-49">}</span><span class="p" data-group-id="2036565403-48">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-50">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">MyApp.MaculaRPC</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="2036565403-51">(</span><span class="s">&quot;myapp.users&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2036565403-52">%{</span><span class="ss">action</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">user_id</span><span class="p">:</span><span class="w"> </span><span class="n">id</span><span class="p" data-group-id="2036565403-52">}</span><span class="p" data-group-id="2036565403-51">)</span><span class="w"> </span><span class="k" data-group-id="2036565403-53">do</span><span class="w">
      </span><span class="p" data-group-id="2036565403-54">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="2036565403-54">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">json</span><span class="p" data-group-id="2036565403-55">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p" data-group-id="2036565403-55">)</span><span class="w">

      </span><span class="p" data-group-id="2036565403-56">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:not_found</span><span class="p" data-group-id="2036565403-56">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_status</span><span class="p" data-group-id="2036565403-57">(</span><span class="ss">:not_found</span><span class="p" data-group-id="2036565403-57">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">json</span><span class="p" data-group-id="2036565403-58">(</span><span class="p" data-group-id="2036565403-59">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User not found&quot;</span><span class="p" data-group-id="2036565403-59">}</span><span class="p" data-group-id="2036565403-58">)</span><span class="w">

      </span><span class="p" data-group-id="2036565403-60">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="2036565403-60">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">conn</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">put_status</span><span class="p" data-group-id="2036565403-61">(</span><span class="ss">:internal_server_error</span><span class="p" data-group-id="2036565403-61">)</span><span class="w">
        </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">json</span><span class="p" data-group-id="2036565403-62">(</span><span class="p" data-group-id="2036565403-63">%{</span><span class="ss">error</span><span class="p">:</span><span class="w"> </span><span class="n">inspect</span><span class="p" data-group-id="2036565403-64">(</span><span class="n">reason</span><span class="p" data-group-id="2036565403-64">)</span><span class="p" data-group-id="2036565403-63">}</span><span class="p" data-group-id="2036565403-62">)</span><span class="w">
    </span><span class="k" data-group-id="2036565403-53">end</span><span class="w">
  </span><span class="k" data-group-id="2036565403-50">end</span><span class="w">
</span><span class="k" data-group-id="2036565403-47">end</span></code></pre><hr class="thin"/><h2 id="migration-from-wamp" class="section-heading"><a href="#migration-from-wamp" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration from WAMP</span></h2><h3 id="key-differences" class="section-heading"><a href="#key-differences" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Differences</span></h3><table><thead><tr><th style="text-align: left;">Aspect</th><th style="text-align: left;">WAMP (Bondy)</th><th style="text-align: left;">Macula HTTP/3</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Discovery</strong></td><td style="text-align: left;">Centralized registry</td><td style="text-align: left;">DHT-based (decentralized)</td></tr><tr><td style="text-align: left;"><strong>Transport</strong></td><td style="text-align: left;">WebSocket</td><td style="text-align: left;">HTTP/3 QUIC</td></tr><tr><td style="text-align: left;"><strong>Registration</strong></td><td style="text-align: left;"><code class="inline">session.register(Procedure, Handler)</code></td><td style="text-align: left;"><code class="inline">macula:advertise(Client, Procedure, Handler)</code></td></tr><tr><td style="text-align: left;"><strong>RPC Call</strong></td><td style="text-align: left;"><code class="inline">session.call(Procedure, Args)</code></td><td style="text-align: left;"><code class="inline">macula:call(Client, Procedure, Args)</code></td></tr><tr><td style="text-align: left;"><strong>Unregister</strong></td><td style="text-align: left;"><code class="inline">session.unregister(Registration)</code></td><td style="text-align: left;"><code class="inline">macula:unadvertise(Client, Procedure)</code></td></tr><tr><td style="text-align: left;"><strong>Handler Args</strong></td><td style="text-align: left;"><code class="inline">[Args, Kwargs]</code> (positional + keyword)</td><td style="text-align: left;"><code class="inline">Args :: map()</code> (map only)</td></tr><tr><td style="text-align: left;"><strong>NAT Traversal</strong></td><td style="text-align: left;">Requires special config</td><td style="text-align: left;">Built-in (QUIC)</td></tr></tbody></table><h3 id="migration-steps" class="section-heading"><a href="#migration-steps" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration Steps</span></h3><h4>1. Update Dependencies</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="p" data-group-id="8339790052-1">{</span><span class="ss">deps</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8339790052-2">[</span><span class="w">
    </span><span class="p" data-group-id="8339790052-3">{</span><span class="ss">bondy</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8339790052-4">{</span><span class="ss">git</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;https://github.com/bondy-io/bondy.git&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8339790052-5">{</span><span class="ss">tag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p" data-group-id="8339790052-5">}</span><span class="p" data-group-id="8339790052-4">}</span><span class="p" data-group-id="8339790052-3">}</span><span class="w">
</span><span class="p" data-group-id="8339790052-2">]</span><span class="p" data-group-id="8339790052-1">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="p" data-group-id="8339790052-6">{</span><span class="ss">deps</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8339790052-7">[</span><span class="w">
    </span><span class="p" data-group-id="8339790052-8">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0.6.6&quot;</span><span class="p" data-group-id="8339790052-8">}</span><span class="w">
</span><span class="p" data-group-id="8339790052-7">]</span><span class="p" data-group-id="8339790052-6">}</span><span class="p">.</span></code></pre><h4>2. Convert Registration</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3509028367-1">(</span><span class="p" data-group-id="3509028367-2">[</span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="3509028367-2">]</span><span class="p" data-group-id="3509028367-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">UserId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="3509028367-3">(</span><span class="p" data-group-id="3509028367-4">&lt;&lt;</span><span class="s">&quot;user_id&quot;</span><span class="p" data-group-id="3509028367-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="3509028367-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="3509028367-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3509028367-6">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">UserId</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3509028367-7">&lt;&lt;</span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="3509028367-7">&gt;&gt;</span><span class="p" data-group-id="3509028367-6">}</span><span class="p" data-group-id="3509028367-5">}</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="3509028367-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Registration</span><span class="p" data-group-id="3509028367-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">bondy</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="3509028367-9">(</span><span class="n">Session</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3509028367-10">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="3509028367-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="3509028367-9">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="3509028367-11">(</span><span class="n">Args</span><span class="p" data-group-id="3509028367-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="3509028367-12">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="3509028367-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="3509028367-13">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3509028367-14">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">UserId</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3509028367-15">&lt;&lt;</span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="3509028367-15">&gt;&gt;</span><span class="p" data-group-id="3509028367-14">}</span><span class="p" data-group-id="3509028367-13">}</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="3509028367-16">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="3509028367-16">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="3509028367-17">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3509028367-18">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="3509028367-18">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="3509028367-17">)</span><span class="p">.</span></code></pre><h4>3. Convert RPC Calls</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="p" data-group-id="5501693330-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="5501693330-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">bondy</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="5501693330-2">(</span><span class="n">Session</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5501693330-3">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="5501693330-3">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5501693330-4">[</span><span class="p" data-group-id="5501693330-5">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5501693330-6">&lt;&lt;</span><span class="s">&quot;123&quot;</span><span class="p" data-group-id="5501693330-6">&gt;&gt;</span><span class="p" data-group-id="5501693330-5">}</span><span class="p" data-group-id="5501693330-4">]</span><span class="p" data-group-id="5501693330-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="p" data-group-id="5501693330-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="5501693330-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="5501693330-8">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5501693330-9">&lt;&lt;</span><span class="s">&quot;myapp.user.get&quot;</span><span class="p" data-group-id="5501693330-9">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5501693330-10">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5501693330-11">&lt;&lt;</span><span class="s">&quot;123&quot;</span><span class="p" data-group-id="5501693330-11">&gt;&gt;</span><span class="p" data-group-id="5501693330-10">}</span><span class="p" data-group-id="5501693330-8">)</span><span class="p">.</span></code></pre><h4>4. Update Handler Signatures</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP) - separate positional and keyword args</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6354921291-1">(</span><span class="p" data-group-id="6354921291-2">[</span><span class="n">PositionalArgs</span><span class="p">,</span><span class="w"> </span><span class="n">KeywordArgs</span><span class="p" data-group-id="6354921291-2">]</span><span class="p" data-group-id="6354921291-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">UserId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="6354921291-3">(</span><span class="p" data-group-id="6354921291-4">&lt;&lt;</span><span class="s">&quot;user_id&quot;</span><span class="p" data-group-id="6354921291-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">KeywordArgs</span><span class="p" data-group-id="6354921291-3">)</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% ...</span><span class="w">
</span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula) - single map argument</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="6354921291-5">(</span><span class="n">Args</span><span class="p" data-group-id="6354921291-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6354921291-6">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">UserId</span><span class="p" data-group-id="6354921291-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% ...</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h4>5. Update Error Handling</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">bondy</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="7609604013-1">(</span><span class="n">Session</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="7609604013-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="7609604013-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="7609604013-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_result</span><span class="p" data-group-id="7609604013-3">(</span><span class="n">Result</span><span class="p" data-group-id="7609604013-3">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="7609604013-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7609604013-5">{</span><span class="ss">wamp_error</span><span class="p">,</span><span class="w"> </span><span class="n">Uri</span><span class="p">,</span><span class="w"> </span><span class="n">Details</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Args</span><span class="p" data-group-id="7609604013-5">}</span><span class="p" data-group-id="7609604013-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_wamp_error</span><span class="p" data-group-id="7609604013-6">(</span><span class="n">Uri</span><span class="p" data-group-id="7609604013-6">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="7609604013-7">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="7609604013-7">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="7609604013-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="7609604013-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_result</span><span class="p" data-group-id="7609604013-9">(</span><span class="n">Result</span><span class="p" data-group-id="7609604013-9">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="7609604013-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">timeout</span><span class="p" data-group-id="7609604013-10">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_timeout</span><span class="p" data-group-id="7609604013-11">(</span><span class="p" data-group-id="7609604013-11">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="7609604013-12">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">service_not_found</span><span class="p" data-group-id="7609604013-12">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_not_found</span><span class="p" data-group-id="7609604013-13">(</span><span class="p" data-group-id="7609604013-13">)</span><span class="p">;</span><span class="w">
    </span><span class="p" data-group-id="7609604013-14">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7609604013-15">{</span><span class="ss">handler_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="7609604013-15">}</span><span class="p" data-group-id="7609604013-14">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_business_error</span><span class="p" data-group-id="7609604013-16">(</span><span class="n">Reason</span><span class="p" data-group-id="7609604013-16">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="migration-checklist" class="section-heading"><a href="#migration-checklist" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration Checklist</span></h3><ul><li>[ ] Update dependencies (WAMP â†’ Macula)</li><li>[ ] Convert handler signatures (<code class="inline">[Args, Kwargs]</code> â†’ <code class="inline">Args :: map()</code>)</li><li>[ ] Replace <code class="inline">bondy:register/3</code> with <code class="inline">macula:advertise/3,4</code></li><li>[ ] Replace <code class="inline">bondy:call/3</code> with <code class="inline">macula:call/2,3</code></li><li>[ ] Replace <code class="inline">bondy:unregister/2</code> with <a href="macula.html#unadvertise/2"><code class="inline">macula:unadvertise/2</code></a></li><li>[ ] Update error handling patterns</li><li>[ ] Add periodic re-advertisement logic (if needed)</li><li>[ ] Test with DHT unavailable (graceful degradation)</li><li>[ ] Update monitoring and logging</li></ul><hr class="thin"/><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="quick_start.html">Quick Start Guide</a> - Getting started tutorial</li><li><a href="pubsub_guide.html">PubSub Guide</a> - Pub/Sub patterns and usage</li><li><a href="glossary.html">Glossary</a> - Terminology reference</li></ul><hr class="thin"/><p><strong>Last Updated</strong>: 2025-11-30
<strong>Status</strong>: âœ… Complete</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="development.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
Development Guide
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="pubsub_guide.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
PubSub Guide
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.12.4" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.12.4">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.12.4/show/docs/developer/RPC_GUIDE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
