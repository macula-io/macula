<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module macula_service_registry</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module macula_service_registry</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>   
Decentralized service advertisement registry using DHT.


<h2><a name="description">Description</a></h2><p>   
Decentralized service advertisement registry using DHT.</p>
  
   <p>Provides service discovery via Kademlia DHT instead of centralized   
registration. Services advertise their capabilities to the DHT,   
and clients discover providers by querying the DHT.</p>
  
   <h3><a name="Architecture">Architecture</a></h3>
  
   <p>- Services advertise: "I provide procedure X" → DHT stores node_id at key=hash(procedure)   
- Clients discover: "Who provides procedure X?" → DHT returns list of node_ids   
- Local cache: Recent discoveries cached with TTL for low-latency lookups   
- Re-advertisement: Periodic republish to DHT for TTL renewal (default: every 5 min)</p>
  
   <h3><a name="Features">Features</a></h3>
  
   - Fully decentralized (no central authority)
   - Multiple providers supported (DHT returns list)
   - Load balancing (client picks from list)
   - Fault tolerant (try another provider if one fails)
   - Low latency after first lookup (local cache)
  
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-cache_entry">cache_entry()</a></h3>
<p><code>cache_entry() = #{service_id := <a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, providers := [<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>], cached_at := integer(), ttl := pos_integer()}</code></p>


<h3 class="typedecl"><a name="type-handler_fn">handler_fn()</a></h3>
<p><code>handler_fn() = fun((map()) -&gt; {ok, term()} | {error, term()})</code></p>
<p>  Handler function for local service implementations.</p>

<h3 class="typedecl"><a name="type-local_service">local_service()</a></h3>
<p><code>local_service() = #{service_id := <a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, handler := <a href="#type-handler_fn" docgen-rel="seetype" docgen-href="#handler_fn/0">handler_fn()</a>, metadata := map(), advertised_at := integer()}</code></p>


<h3 class="typedecl"><a name="type-node_id">node_id()</a></h3>
<p><code>node_id() = binary()</code></p>
<p>  32-byte node identifier.</p>

<h3 class="typedecl"><a name="type-provider_info">provider_info()</a></h3>
<p><code>provider_info() = #{node_id := <a href="#type-node_id" docgen-rel="seetype" docgen-href="#node_id/0">node_id()</a>, endpoint := binary(), metadata := map(), advertised_at := integer()}</code></p>


<h3 class="typedecl"><a name="type-registry">registry()</a></h3>
<p><code>registry() = #{local_services := #{<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a> =&gt; <a href="#type-local_service" docgen-rel="seetype" docgen-href="#local_service/0">local_service()</a>}, cache := #{<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a> =&gt; <a href="#type-cache_entry" docgen-rel="seetype" docgen-href="#cache_entry/0">cache_entry()</a>}, subscriber_cache := #{binary() =&gt; <a href="#type-cache_entry" docgen-rel="seetype" docgen-href="#cache_entry/0">cache_entry()</a>}, default_ttl := pos_integer(), cache_ttl := pos_integer(), service_ttl := pos_integer()}</code></p>


<h3 class="typedecl"><a name="type-service_id">service_id()</a></h3>
<p><code>service_id() = binary()</code></p>
<p>  Service identifier (procedure URI). Example: &lt;&lt;"energy.home.get"&gt;&gt;.</p>

<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#advertise_local-4">advertise_local/4</a></td><td>Advertise a service locally (stores handler for incoming calls).</td></tr>
<tr><td valign="top"><a href="#cache_service-4">cache_service/4</a></td><td>Cache discovered service providers.</td></tr>
<tr><td valign="top"><a href="#cache_subscribers-4">cache_subscribers/4</a></td><td>Cache discovered subscribers for a topic.</td></tr>
<tr><td valign="top"><a href="#clear_cache-1">clear_cache/1</a></td><td>Clear the entire discovery cache.</td></tr>
<tr><td valign="top"><a href="#clear_subscriber_cache-1">clear_subscriber_cache/1</a></td><td>Clear the entire subscriber cache.</td></tr>
<tr><td valign="top"><a href="#discover_service-2">discover_service/2</a></td><td>Discover service providers (checks cache first, returns cached if available).</td></tr>
<tr><td valign="top"><a href="#discover_service-3">discover_service/3</a></td><td>Discover service providers with options.</td></tr>
<tr><td valign="top"><a href="#discover_subscribers-2">discover_subscribers/2</a></td><td>Discover subscribers for a topic (checks cache first).</td></tr>
<tr><td valign="top"><a href="#get_local_handler-2">get_local_handler/2</a></td><td>Get handler function for a locally advertised service.</td></tr>
<tr><td valign="top"><a href="#list_local_services-1">list_local_services/1</a></td><td>List all locally advertised services.</td></tr>
<tr><td valign="top"><a href="#new-0">new/0</a></td><td>Create new empty service registry with default settings.</td></tr>
<tr><td valign="top"><a href="#new-1">new/1</a></td><td>Create new service registry with custom options.</td></tr>
<tr><td valign="top"><a href="#prune_expired-1">prune_expired/1</a></td><td>Remove expired entries from discovery cache.</td></tr>
<tr><td valign="top"><a href="#prune_expired_local_services-1">prune_expired_local_services/1</a></td><td>Remove expired local services.</td></tr>
<tr><td valign="top"><a href="#prune_expired_subscribers-1">prune_expired_subscribers/1</a></td><td>Remove expired subscriber cache entries.</td></tr>
<tr><td valign="top"><a href="#publish_to_dht-5">publish_to_dht/5</a></td><td>Publish a service advertisement to the DHT.</td></tr>
<tr><td valign="top"><a href="#query_dht_for_service-3">query_dht_for_service/3</a></td><td>Query the DHT for service providers.</td></tr>
<tr><td valign="top"><a href="#remove_from_dht-3">remove_from_dht/3</a></td><td>Remove a service advertisement from the DHT.</td></tr>
<tr><td valign="top"><a href="#unadvertise_local-2">unadvertise_local/2</a></td><td>Remove a local service advertisement.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="advertise_local-4">advertise_local/4</a></h3>
<div class="spec">
<p><code>advertise_local(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, Handler::<a href="#type-handler_fn" docgen-rel="seetype" docgen-href="#handler_fn/0">handler_fn()</a>, Metadata::map()) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p><p>Advertise a service locally (stores handler for incoming calls).</p>
 
  This registers the service handler locally so this node can respond
  to incoming RPC calls. The actual DHT advertisement must be done
  separately (see <code>publish_to_dht/4</code>).</p>

<h3 class="function"><a name="cache_service-4">cache_service/4</a></h3>
<div class="spec">
<p><code>cache_service(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, Providers::[<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>], TTL::pos_integer()) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p><p>Cache discovered service providers.</p>
 
  Stores providers in local cache with TTL. Subsequent <code>discover_service</code>
  calls will return cached results until TTL expires.</p>

<h3 class="function"><a name="cache_subscribers-4">cache_subscribers/4</a></h3>
<div class="spec">
<p><code>cache_subscribers(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, Topic::binary(), Subscribers::[<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>], TTL::pos_integer()) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p><p>Cache discovered subscribers for a topic.</p>
 
  Stores subscribers in local cache with TTL. Subsequent discover_subscribers/2
  calls will return cached results until TTL expires.</p>

<h3 class="function"><a name="clear_cache-1">clear_cache/1</a></h3>
<div class="spec">
<p><code>clear_cache(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p>Clear the entire discovery cache.</p>

<h3 class="function"><a name="clear_subscriber_cache-1">clear_subscriber_cache/1</a></h3>
<div class="spec">
<p><code>clear_subscriber_cache(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p>Clear the entire subscriber cache.</p>

<h3 class="function"><a name="discover_service-2">discover_service/2</a></h3>
<div class="spec">
<p><code>discover_service(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>) -&gt; {ok, [<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>], <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>} | {cache_miss, <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>}</code><br></p>
<p> </p>
</div><p>Discover service providers (checks cache first, returns cached if available).</p>

<h3 class="function"><a name="discover_service-3">discover_service/3</a></h3>
<div class="spec">
<p><code>discover_service(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, Opts::map()) -&gt; {ok, [<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>], <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>} | {cache_miss, <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>}</code><br></p>
<p> </p>
</div><p><p>Discover service providers with options.</p>
 
  <p>Checks local cache first. If found and not expired, returns cached providers.
  If cache miss or expired, returns <code>{cache_miss, Registry}</code> so caller can  
query DHT.</p>
 
  Options:
  - <code>force_refresh</code> - Skip cache, force DHT lookup (default: false)</p>

<h3 class="function"><a name="discover_subscribers-2">discover_subscribers/2</a></h3>
<div class="spec">
<p><code>discover_subscribers(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, Topic::binary()) -&gt; {ok, [<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>], <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>} | {cache_miss, <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>}</code><br></p>
<p> </p>
</div><p><p>Discover subscribers for a topic (checks cache first).</p>
 
  Similar to discover_service/2 but for pub/sub subscribers.
  Returns cached subscribers if found and not expired, otherwise cache_miss.</p>

<h3 class="function"><a name="get_local_handler-2">get_local_handler/2</a></h3>
<div class="spec">
<p><code>get_local_handler(X1::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>) -&gt; {ok, <a href="#type-handler_fn" docgen-rel="seetype" docgen-href="#handler_fn/0">handler_fn()</a>} | not_found</code><br></p>
<p> </p>
</div><p>Get handler function for a locally advertised service.</p>

<h3 class="function"><a name="list_local_services-1">list_local_services/1</a></h3>
<div class="spec">
<p><code>list_local_services(X1::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>) -&gt; [<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>]</code><br></p>
<p> </p>
</div><p>List all locally advertised services.</p>

<h3 class="function"><a name="new-0">new/0</a></h3>
<div class="spec">
<p><code>new() -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p>Create new empty service registry with default settings.</p>

<h3 class="function"><a name="new-1">new/1</a></h3>
<div class="spec">
<p><code>new(Opts::map()) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p><p>Create new service registry with custom options.</p>
 
  Options:
  - <code>default_ttl</code> - Default TTL for DHT advertisements (default: 300s)
  - <code>cache_ttl</code> - How long to cache discovered services (default: 60s)
  - <code>service_ttl</code> - TTL for local services before cleanup (default: 300s, 5 minutes)</p>

<h3 class="function"><a name="prune_expired-1">prune_expired/1</a></h3>
<div class="spec">
<p><code>prune_expired(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>) -&gt; {<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, non_neg_integer()}</code><br></p>
<p> </p>
</div><p><p>Remove expired entries from discovery cache.</p>
 
  Should be called periodically to prevent memory leaks.
  Returns updated registry and count of removed entries.</p>

<h3 class="function"><a name="prune_expired_local_services-1">prune_expired_local_services/1</a></h3>
<div class="spec">
<p><code>prune_expired_local_services(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>) -&gt; {<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, non_neg_integer()}</code><br></p>
<p> </p>
</div><p><p>Remove expired local services.</p>
 
  Should be called periodically to prevent memory leaks from stale service
  registrations. Returns updated registry and count of removed services.</p>

<h3 class="function"><a name="prune_expired_subscribers-1">prune_expired_subscribers/1</a></h3>
<div class="spec">
<p><code>prune_expired_subscribers(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>) -&gt; {<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, non_neg_integer()}</code><br></p>
<p> </p>
</div><p><p>Remove expired subscriber cache entries.</p>
 
  Should be called periodically to prevent memory leaks.
  Returns updated registry and count of removed entries.</p>

<h3 class="function"><a name="publish_to_dht-5">publish_to_dht/5</a></h3>
<div class="spec">
<p><code>publish_to_dht(DhtPid::pid() | atom(), ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, ProviderInfo::<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>, TTL::pos_integer(), K::pos_integer()) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p><p>Publish a service advertisement to the DHT.</p>
 
  <p>This function publishes a service's provider information to the DHT  
so other nodes can discover it. The service_id is hashed to create  
a DHT key, and the provider information is stored at that key.</p>
 
  <p>Parameters:  
- DhtPid: Process ID or registered name of macula_routing_server  
- ServiceId: The service identifier (procedure URI)  
- ProviderInfo: Information about this provider (node_id, endpoint, metadata)  
- TTL: Time-to-live in seconds for this advertisement  
- K: Number of nodes to store at (typically 20 for Kademlia)</p>
 
  <p>Returns:  
- ok if successful  
- {error, Reason} if publication failed</p>
 
  Example:
  <pre>  ProviderInfo = #{
      node_id =&gt; &lt;&lt;"my-node-123"&gt;&gt;,
      endpoint =&gt; &lt;&lt;"https://localhost:9443"&gt;&gt;,
      metadata =&gt; #{version =&gt; &lt;&lt;"1.0"&gt;&gt;}
  },
  ok = publish_to_dht(DhtPid, &amp;lt;&amp;lt;"energy.home.get"&amp;gt;&amp;gt;, ProviderInfo, 300, 20).</pre></p>

<h3 class="function"><a name="query_dht_for_service-3">query_dht_for_service/3</a></h3>
<div class="spec">
<p><code>query_dht_for_service(DhtPid::pid() | atom(), ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, K::pos_integer()) -&gt; {ok, [<a href="#type-provider_info" docgen-rel="seetype" docgen-href="#provider_info/0">provider_info()</a>]} | {error, term()}</code><br></p>
<p> </p>
</div><p><p>Query the DHT for service providers.</p>
 
  <p>This function queries the DHT to find nodes that provide a given service.  
It returns a list of provider_info() maps, each containing node_id, endpoint,  
and metadata for a provider.</p>
 
  <p>Parameters:  
- DhtPid: Process ID or registered name of macula_routing_server  
- ServiceId: The service identifier to query for  
- K: Number of closest nodes to query (typically 20 for Kademlia)</p>
 
  <p>Returns:  
- {ok, [ProviderInfo]} if providers found  
- {ok, []} if no providers found  
- {error, Reason} if query failed</p>
 
  Example:
  <pre>  {ok, Providers} = query_dht_for_service(DhtPid, &amp;lt;&amp;lt;"energy.home.get"&amp;gt;&amp;gt;, 20),
  %% Returns: [{ok, [#{node_id =&gt; ..., endpoint =&gt; ..., metadata =&gt; ...}]}]</pre></p>

<h3 class="function"><a name="remove_from_dht-3">remove_from_dht/3</a></h3>
<div class="spec">
<p><code>remove_from_dht(DhtPid::pid() | atom(), ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>, NodeId::<a href="#type-node_id" docgen-rel="seetype" docgen-href="#node_id/0">node_id()</a>) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p><p>Remove a service advertisement from the DHT.</p>
 
  <p>This function removes a service advertisement when unadvertising.  
Note: In practice, DHT entries expire naturally via TTL, so this  
is optional and mainly useful for immediate cleanup.</p>
 
  <p>Parameters:  
- DhtPid: Process ID or registered name of macula_routing_server  
- ServiceId: The service identifier to remove  
- NodeId: This node's identifier (to remove only this provider)</p>
 
  Returns:
  - ok if successful or entry not found
  - {error, Reason} if removal failed</p>

<h3 class="function"><a name="unadvertise_local-2">unadvertise_local/2</a></h3>
<div class="spec">
<p><code>unadvertise_local(Registry::<a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a>, ServiceId::<a href="#type-service_id" docgen-rel="seetype" docgen-href="#service_id/0">service_id()</a>) -&gt; <a href="#type-registry" docgen-rel="seetype" docgen-href="#registry/0">registry()</a></code><br></p>
<p> </p>
</div><p>Remove a local service advertisement.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
