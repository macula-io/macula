<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.12.4">


    <title>PubSub Guide â€” macula v0.12.4</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-DE2E663F.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="overview.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="overview.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.12.4
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula HTTP/3 Mesh - Pub/Sub Guide</h1>


      <a href="https://github.com/macula-io/macula/blob/0.12.4/docs/developer/PUBSUB_GUIDE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Complete guide to decentralized publish/subscribe with DHT-based subscriber discovery</strong></p><p><strong>Status</strong>: COMPLETE
<strong>Last Updated</strong>: 2025-11-28</p><hr class="thin"/><h2 id="table-of-contents" class="section-heading"><a href="#table-of-contents" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Table of Contents</span></h2><ol><li><a href="#overview">Overview</a></li><li><a href="#architecture">Architecture</a></li><li><a href="#subscribing-to-topics">Subscribing to Topics</a></li><li><a href="#publishing-events">Publishing Events</a></li><li><a href="#wildcard-subscriptions">Wildcard Subscriptions</a></li><li><a href="#error-handling">Error Handling</a></li><li><a href="#performance-optimization">Performance Optimization</a></li><li><a href="#best-practices">Best Practices</a></li><li><a href="#examples">Examples</a></li><li><a href="#migration-from-wamp">Migration from WAMP</a></li></ol><hr class="thin"/><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Macula provides <strong>fully decentralized pub/sub</strong> without requiring any central message broker. Subscribers advertise their interest to a <strong>Kademlia DHT</strong> (Distributed Hash Table), and publishers discover subscribers by querying the DHT.</p><h3 id="key-features" class="section-heading"><a href="#key-features" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Features</span></h3><ul><li><strong>Fully Decentralized</strong> - No central broker, DHT-based subscriber discovery</li><li><strong>Topic-Based Routing</strong> - Events routed to all topic subscribers</li><li><strong>Wildcard Support</strong> - Subscribe to patterns like <code class="inline">sensor.*</code> or <code class="inline">#</code></li><li><strong>At-Least-Once Delivery</strong> - Direct delivery via QUIC connections</li><li><strong>Multi-Subscriber Fanout</strong> - One publish reaches all matching subscribers</li><li><strong>NAT-Friendly</strong> - HTTP/3 QUIC works through firewalls</li></ul><h3 id="how-it-works" class="section-heading"><a href="#how-it-works" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">How It Works</span></h3><pre><code class="makeup erlang" translate="no"><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="o">+</span><span class="w">
</span><span class="p">|</span><span class="w"> </span><span class="n">Subscriber</span><span class="w"> </span><span class="p" data-group-id="1027812156-1">(</span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="1027812156-1">)</span><span class="w">                                          </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">                                                              </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="nf">subscribe</span><span class="p" data-group-id="1027812156-2">(</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">callback_fn</span><span class="p" data-group-id="1027812156-2">)</span><span class="w">               </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">     </span><span class="p">|</span><span class="w">                                                        </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">Store</span><span class="w"> </span><span class="ss">callback</span><span class="w"> </span><span class="ss">locally</span><span class="w">                                  </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">Advertise</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="ss">key</span><span class="o">=</span><span class="n">SHA256</span><span class="p" data-group-id="1027812156-3">(</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="1027812156-3">)</span><span class="w">   </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">     </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1027812156-4">{</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="ss">endpoint</span><span class="p">,</span><span class="w"> </span><span class="ss">topic</span><span class="p" data-group-id="1027812156-4">}</span><span class="w">                           </span><span class="p">|</span><span class="w">
</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="o">+</span><span class="w">
                          </span><span class="p">|</span><span class="w">
                  </span><span class="p" data-group-id="1027812156-5">[</span><span class="n">Kademlia</span><span class="w"> </span><span class="n">DHT</span><span class="p" data-group-id="1027812156-5">]</span><span class="w">
                  </span><span class="p" data-group-id="1027812156-6">(</span><span class="ss">distributed</span><span class="p" data-group-id="1027812156-6">)</span><span class="w">
                          </span><span class="p">|</span><span class="w">
</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="o">+</span><span class="w">
</span><span class="p">|</span><span class="w"> </span><span class="n">Publisher</span><span class="w"> </span><span class="p" data-group-id="1027812156-7">(</span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="1027812156-7">)</span><span class="w">                                           </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">                                                              </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="nf">publish</span><span class="p" data-group-id="1027812156-8">(</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1027812156-9">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="1027812156-9">}</span><span class="p" data-group-id="1027812156-8">)</span><span class="w">           </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">     </span><span class="p">|</span><span class="w">                                                        </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">subscribers</span><span class="w">                               </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="ss">subscriber</span><span class="w"> </span><span class="nf">list</span><span class="w"> </span><span class="p" data-group-id="1027812156-10">(</span><span class="mi">60</span><span class="ss">s</span><span class="w"> </span><span class="n">TTL</span><span class="p" data-group-id="1027812156-10">)</span><span class="w">                         </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">For</span><span class="w"> </span><span class="ss">each</span><span class="w"> </span><span class="nc">subscriber</span><span class="p">:</span><span class="w">                                    </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">     </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="n">MSG_PUBLISH</span><span class="w"> </span><span class="ss">via</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="n">QUIC</span><span class="w">                    </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">     </span><span class="p">|</span><span class="w">                                                        </span><span class="p">|</span><span class="w">
</span><span class="p">|</span><span class="w">  </span><span class="n">Subscriber</span><span class="w"> </span><span class="ss">receives</span><span class="w"> </span><span class="ss">event</span><span class="w"> </span><span class="ss">via</span><span class="w"> </span><span class="ss">callback</span><span class="w">                     </span><span class="p">|</span><span class="w">
</span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="o">+</span></code></pre><h3 id="message-flow" class="section-heading"><a href="#message-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Message Flow</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Publisher</span><span class="w">                          </span><span class="n">DHT</span><span class="w">                         </span><span class="n">Subscriber</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="ss">subscribers</span><span class="w">         </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">&gt;</span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">  </span><span class="n">Returns</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="1684009081-1">[</span><span class="n">NodeA</span><span class="p">,</span><span class="w"> </span><span class="n">NodeC</span><span class="p" data-group-id="1684009081-1">]</span><span class="w">      </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="o">&lt;-</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">Direct</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">NodeA</span><span class="w">      </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">&gt;</span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">   </span><span class="n">MSG_PUBLISH</span><span class="p">:</span><span class="w"> </span><span class="ss">sensor</span><span class="p">.</span><span class="ss">temperature</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1684009081-2">{</span><span class="nc">value</span><span class="p">:</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="1684009081-2">}</span><span class="w">      </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="nf">callback</span><span class="p" data-group-id="1684009081-3">(</span><span class="p" data-group-id="1684009081-4">{</span><span class="ss">macula_event</span><span class="p">,</span><span class="w">   </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">     </span><span class="s">&quot;sensor.temperature&quot;</span><span class="p">,</span><span class="w">     </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">     </span><span class="p" data-group-id="1684009081-5">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="1684009081-5">}</span><span class="p" data-group-id="1684009081-4">}</span><span class="p" data-group-id="1684009081-3">)</span><span class="w">        </span><span class="p">|</span><span class="w">
    </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span><span class="w">                               </span><span class="p">|</span></code></pre><hr class="thin"/><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><h3 id="components" class="section-heading"><a href="#components" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Components</span></h3><h4><code class="inline">macula_pubsub_dht</code></h4><p>DHT integration for pub/sub:</p><ul><li><strong>Subscriber advertisement</strong> - Store subscriptions in DHT</li><li><strong>Subscriber discovery</strong> - Query DHT for topic subscribers</li><li><strong>Topic matching</strong> - Support for exact and wildcard topics</li></ul><p><strong>Key Functions</strong>:</p><ul><li><code class="inline">subscribe/3</code> - Advertise subscription to DHT</li><li><code class="inline">unsubscribe/2</code> - Remove subscription from DHT</li><li><code class="inline">find_subscribers/2</code> - Query DHT for topic subscribers</li><li><code class="inline">match_topic/2</code> - Match topic against patterns</li></ul><h4><code class="inline">macula_pubsub_handler</code></h4><p>Connection-level pub/sub handler:</p><ul><li>Holds local subscriptions and callbacks</li><li>Handles incoming <code class="inline">MSG_PUBLISH</code> messages</li><li>Invokes subscriber callbacks</li></ul><h4><code class="inline">macula_gateway_pubsub</code></h4><p>Gateway pub/sub routing:</p><ul><li>Routes messages to connected clients</li><li>Handles wildcard matching</li><li>Manages subscription state for gateway clients</li></ul><h4><code class="inline">macula</code> (Public API)</h4><p>The <strong>only module</strong> applications should import:</p><ul><li><code class="inline">connect/2</code>, <code class="inline">connect_local/1</code> - Connect to mesh</li><li><code class="inline">subscribe/3</code> - Subscribe to a topic</li><li><code class="inline">unsubscribe/2</code> - Unsubscribe from a topic</li><li><code class="inline">publish/3,4</code> - Publish an event</li><li><code class="inline">disconnect/1</code> - Close connection</li></ul><h4><code class="inline">macula_peer</code> (Internal)</h4><p>Internal mesh participant module (called by <code class="inline">macula</code>).</p><h3 id="data-flow" class="section-heading"><a href="#data-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Data Flow</span></h3><p><strong>Subscription</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Application</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="3699127634-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="p" data-group-id="3699127634-1">)</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nf">macula_connection</span><span class="w"> </span><span class="p" data-group-id="3699127634-2">(</span><span class="nc">gen_server</span><span class="p">:</span><span class="ss">call</span><span class="p" data-group-id="3699127634-2">)</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nf">macula_pubsub_handler</span><span class="w"> </span><span class="p" data-group-id="3699127634-3">(</span><span class="ss">store</span><span class="w"> </span><span class="ss">local</span><span class="w"> </span><span class="ss">callback</span><span class="p" data-group-id="3699127634-3">)</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nc">macula_pubsub_dht</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="3699127634-4">(</span><span class="n">DhtPid</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriberInfo</span><span class="p" data-group-id="3699127634-4">)</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nf">macula_routing_dht</span><span class="w"> </span><span class="p" data-group-id="3699127634-5">(</span><span class="n">DHT</span><span class="w"> </span><span class="ss">storage</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="ss">key</span><span class="o">=</span><span class="n">SHA256</span><span class="p" data-group-id="3699127634-6">(</span><span class="n">Topic</span><span class="p" data-group-id="3699127634-6">)</span><span class="p" data-group-id="3699127634-5">)</span></code></pre><p><strong>Publishing</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Application</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="4478980684-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="4478980684-1">)</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nf">macula_connection</span><span class="w"> </span><span class="p" data-group-id="4478980684-2">(</span><span class="nc">gen_server</span><span class="p">:</span><span class="ss">call</span><span class="p" data-group-id="4478980684-2">)</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="nc">macula_pubsub_dht</span><span class="p">:</span><span class="nf">find_subscribers</span><span class="p" data-group-id="4478980684-3">(</span><span class="n">DhtPid</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p" data-group-id="4478980684-3">)</span><span class="w">
   </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Returns</span><span class="w"> </span><span class="ss">list</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="ss">subscriber</span><span class="w"> </span><span class="ss">endpoints</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="n">For</span><span class="w"> </span><span class="ss">each</span><span class="w"> </span><span class="nc">subscriber</span><span class="p">:</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="n">Send</span><span class="w"> </span><span class="n">MSG_PUBLISH</span><span class="w"> </span><span class="ss">over</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="n">QUIC</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="n">Subscriber</span><span class="err">&#39;</span><span class="ss">s</span><span class="w"> </span><span class="ss">macula_pubsub_handler</span><span class="w">
   </span><span class="p">|</span><span class="w">
</span><span class="n">Invoke</span><span class="w"> </span><span class="ss">registered</span><span class="w"> </span><span class="ss">callback</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="ss">event</span></code></pre><hr class="thin"/><h2 id="subscribing-to-topics" class="section-heading"><a href="#subscribing-to-topics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscribing to Topics</span></h2><h3 id="basic-subscription" class="section-heading"><a href="#basic-subscription" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Basic Subscription</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Erlang</span><span class="w">
</span><span class="n">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="8179877747-1">(</span><span class="n">Event</span><span class="p" data-group-id="8179877747-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="8179877747-2">#{</span><span class="ss">topic</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="8179877747-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="8179877747-3">(</span><span class="s">&quot;Received </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8179877747-4">[</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="8179877747-4">]</span><span class="p" data-group-id="8179877747-3">)</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">

</span><span class="p" data-group-id="8179877747-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="8179877747-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="8179877747-6">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8179877747-7">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="8179877747-7">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">Callback</span><span class="w">
</span><span class="p" data-group-id="8179877747-6">)</span><span class="p">.</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Elixir</span><span class="w">
</span><span class="n">callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k" data-group-id="5274351795-1">fn</span><span class="w"> </span><span class="n">event</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="p" data-group-id="5274351795-2">%{</span><span class="ss">topic</span><span class="p">:</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="ss">payload</span><span class="p">:</span><span class="w"> </span><span class="n">payload</span><span class="p" data-group-id="5274351795-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="w">
  </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="5274351795-3">(</span><span class="s">&quot;Received </span><span class="si" data-group-id="5274351795-4">#{</span><span class="n">topic</span><span class="si" data-group-id="5274351795-4">}</span><span class="s">: </span><span class="si" data-group-id="5274351795-5">#{</span><span class="n">inspect</span><span class="p" data-group-id="5274351795-6">(</span><span class="n">payload</span><span class="p" data-group-id="5274351795-6">)</span><span class="si" data-group-id="5274351795-5">}</span><span class="s">&quot;</span><span class="p" data-group-id="5274351795-3">)</span><span class="w">
</span><span class="k" data-group-id="5274351795-1">end</span><span class="w">

</span><span class="p" data-group-id="5274351795-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="p" data-group-id="5274351795-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="5274351795-8">(</span><span class="w">
  </span><span class="n">client</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;sensor.temperature&quot;</span><span class="p">,</span><span class="w">
  </span><span class="n">callback</span><span class="w">
</span><span class="p" data-group-id="5274351795-8">)</span></code></pre><h3 id="callback-contract" class="section-heading"><a href="#callback-contract" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Callback Contract</span></h3><p>Callbacks receive events as maps:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">event</span><span class="p" data-group-id="7220043256-1">(</span><span class="p" data-group-id="7220043256-1">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7220043256-2">#{</span><span class="w">
    </span><span class="ss">topic</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="7220043256-3">(</span><span class="p" data-group-id="7220043256-3">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="7220043256-4">(</span><span class="p" data-group-id="7220043256-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">publisher_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="7220043256-5">(</span><span class="p" data-group-id="7220043256-5">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="7220043256-6">(</span><span class="p" data-group-id="7220043256-6">)</span><span class="w">
</span><span class="p" data-group-id="7220043256-2">}</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">callback_fn</span><span class="p" data-group-id="7220043256-7">(</span><span class="p" data-group-id="7220043256-7">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7220043256-8">(</span><span class="p" data-group-id="7220043256-9">(</span><span class="nf">event</span><span class="p" data-group-id="7220043256-10">(</span><span class="p" data-group-id="7220043256-10">)</span><span class="p" data-group-id="7220043256-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="7220043256-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="7220043256-12">(</span><span class="p" data-group-id="7220043256-12">)</span><span class="p" data-group-id="7220043256-11">}</span><span class="p" data-group-id="7220043256-8">)</span><span class="p">.</span></code></pre><p><strong>Callback Rules</strong>:</p><ul><li>Input: Event map with <code class="inline">topic</code> and <code class="inline">payload</code></li><li>Output: <code class="inline">ok</code> or <code class="inline">{error, Reason}</code> (return value is ignored for at-least-once)</li><li>Execution: Callbacks run in <strong>spawned processes</strong> (non-blocking)</li><li>Errors: Callback crashes are logged but don't affect other subscribers</li></ul><h3 id="process-based-subscription" class="section-heading"><a href="#process-based-subscription" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Process-Based Subscription</span></h3><p>Send events to a process instead of callback:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Subscribe with process pid</span><span class="w">
</span><span class="p" data-group-id="0845993635-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="0845993635-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="0845993635-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0845993635-3">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="0845993635-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="nf">self</span><span class="p" data-group-id="0845993635-4">(</span><span class="p" data-group-id="0845993635-4">)</span><span class="w">  </span><span class="c1">% Events sent as messages</span><span class="w">
</span><span class="p" data-group-id="0845993635-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Handle events in receive loop</span><span class="w">
</span><span class="k">receive</span><span class="w">
    </span><span class="p" data-group-id="0845993635-5">{</span><span class="ss">macula_event</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="0845993635-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nf">handle_event</span><span class="p" data-group-id="0845993635-6">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="0845993635-6">)</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="unsubscribing" class="section-heading"><a href="#unsubscribing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Unsubscribing</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">unsubscribe</span><span class="p" data-group-id="9681301563-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9681301563-2">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="9681301563-2">&gt;&gt;</span><span class="p" data-group-id="9681301563-1">)</span><span class="p">.</span></code></pre><p><strong>Behavior</strong>:</p><ol><li>Removes local callback from subscription list</li><li>Attempts to remove from DHT (best-effort)</li><li>DHT entries expire naturally via TTL</li></ol><hr class="thin"/><h2 id="publishing-events" class="section-heading"><a href="#publishing-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Publishing Events</span></h2><h3 id="basic-publishing" class="section-heading"><a href="#basic-publishing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Basic Publishing</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Erlang</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="8479264943-1">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8479264943-2">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="8479264943-2">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8479264943-3">#{</span><span class="w">
        </span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p">,</span><span class="w">
        </span><span class="ss">unit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8479264943-4">&lt;&lt;</span><span class="s">&quot;celsius&quot;</span><span class="p" data-group-id="8479264943-4">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="8479264943-5">(</span><span class="ss">millisecond</span><span class="p" data-group-id="8479264943-5">)</span><span class="w">
    </span><span class="p" data-group-id="8479264943-3">}</span><span class="w">
</span><span class="p" data-group-id="8479264943-1">)</span><span class="p">.</span></code></pre><pre><code class="makeup elixir" translate="no"><span class="c1"># Elixir</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="0765087257-1">(</span><span class="w">
  </span><span class="n">client</span><span class="p">,</span><span class="w">
  </span><span class="s">&quot;sensor.temperature&quot;</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="0765087257-2">%{</span><span class="w">
    </span><span class="ss">value</span><span class="p">:</span><span class="w"> </span><span class="mf">21.5</span><span class="p">,</span><span class="w">
    </span><span class="ss">unit</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;celsius&quot;</span><span class="p">,</span><span class="w">
    </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="0765087257-3">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="0765087257-3">)</span><span class="w">
  </span><span class="p" data-group-id="0765087257-2">}</span><span class="w">
</span><span class="p" data-group-id="0765087257-1">)</span></code></pre><h3 id="fire-and-forget-semantics" class="section-heading"><a href="#fire-and-forget-semantics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Fire-and-Forget Semantics</span></h3><p>Publishing is <strong>asynchronous</strong> by default:</p><ul><li><code class="inline">publish/3</code> returns immediately after initiating delivery</li><li>Delivery happens in background</li><li>No confirmation that all subscribers received the message</li></ul><h3 id="with-options" class="section-heading"><a href="#with-options" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">With Options</span></h3><pre><code class="makeup erlang" translate="no"><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="8562084553-1">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8562084553-2">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="8562084553-2">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">Payload</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8562084553-3">#{</span><span class="w">
        </span><span class="ss">exclude_self</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p">,</span><span class="w">    </span><span class="c1">% Don&#39;t deliver to self</span><span class="w">
        </span><span class="ss">retain</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="w">          </span><span class="c1">% Don&#39;t retain message (future feature)</span><span class="w">
    </span><span class="p" data-group-id="8562084553-3">}</span><span class="w">
</span><span class="p" data-group-id="8562084553-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="wildcard-subscriptions" class="section-heading"><a href="#wildcard-subscriptions" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Wildcard Subscriptions</span></h2><h3 id="wildcard-types" class="section-heading"><a href="#wildcard-types" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Wildcard Types</span></h3><p>Macula supports two wildcard patterns:</p><table><thead><tr><th style="text-align: left;">Pattern</th><th style="text-align: left;">Matches</th><th style="text-align: left;">Example</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">*</code></td><td style="text-align: left;">Single segment</td><td style="text-align: left;"><code class="inline">sensor.*</code> matches <code class="inline">sensor.temperature</code>, <code class="inline">sensor.humidity</code></td></tr><tr><td style="text-align: left;"><code class="inline">#</code></td><td style="text-align: left;">Multiple segments</td><td style="text-align: left;"><code class="inline">sensor.#</code> matches <code class="inline">sensor.room1.temperature</code>, <code class="inline">sensor.room2.humidity.indoor</code></td></tr></tbody></table><h3 id="single-level-wildcard" class="section-heading"><a href="#single-level-wildcard" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Single-Level Wildcard (*)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Subscribe to all sensors (one level)</span><span class="w">
</span><span class="p" data-group-id="6675901331-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="6675901331-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="6675901331-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6675901331-3">&lt;&lt;</span><span class="s">&quot;sensor.*&quot;</span><span class="p" data-group-id="6675901331-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="nf">fun</span><span class="p" data-group-id="6675901331-4">(</span><span class="p" data-group-id="6675901331-5">#{</span><span class="ss">topic</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="6675901331-5">}</span><span class="p" data-group-id="6675901331-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6675901331-6">(</span><span class="s">&quot;Sensor event on </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-7">[</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="6675901331-7">]</span><span class="p" data-group-id="6675901331-6">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="6675901331-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% These will match:</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="6675901331-8">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-9">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="6675901331-9">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-10">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="6675901331-10">}</span><span class="p" data-group-id="6675901331-8">)</span><span class="p">,</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="6675901331-11">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-12">&lt;&lt;</span><span class="s">&quot;sensor.humidity&quot;</span><span class="p" data-group-id="6675901331-12">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-13">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">65</span><span class="p" data-group-id="6675901331-13">}</span><span class="p" data-group-id="6675901331-11">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% These will NOT match:</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="6675901331-14">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-15">&lt;&lt;</span><span class="s">&quot;sensor.room1.temperature&quot;</span><span class="p" data-group-id="6675901331-15">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-16">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">22.0</span><span class="p" data-group-id="6675901331-16">}</span><span class="p" data-group-id="6675901331-14">)</span><span class="p">,</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="6675901331-17">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-18">&lt;&lt;</span><span class="s">&quot;device.sensor&quot;</span><span class="p" data-group-id="6675901331-18">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6675901331-19">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="6675901331-19">}</span><span class="p" data-group-id="6675901331-17">)</span><span class="p">.</span></code></pre><h3 id="multi-level-wildcard" class="section-heading"><a href="#multi-level-wildcard" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Multi-Level Wildcard (#)</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Subscribe to all sensor events (any depth)</span><span class="w">
</span><span class="p" data-group-id="0464100171-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="0464100171-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="0464100171-2">(</span><span class="w">
    </span><span class="n">Peer</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0464100171-3">&lt;&lt;</span><span class="s">&quot;sensor.#&quot;</span><span class="p" data-group-id="0464100171-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="nf">fun</span><span class="p" data-group-id="0464100171-4">(</span><span class="p" data-group-id="0464100171-5">#{</span><span class="ss">topic</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="0464100171-5">}</span><span class="p" data-group-id="0464100171-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="0464100171-6">(</span><span class="s">&quot;Sensor event on </span><span class="si">~s</span><span class="s">: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-7">[</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="0464100171-7">]</span><span class="p" data-group-id="0464100171-6">)</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="p" data-group-id="0464100171-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% All of these will match:</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="0464100171-8">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-9">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="0464100171-9">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-10">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="0464100171-10">}</span><span class="p" data-group-id="0464100171-8">)</span><span class="p">,</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="0464100171-11">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-12">&lt;&lt;</span><span class="s">&quot;sensor.room1.temperature&quot;</span><span class="p" data-group-id="0464100171-12">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-13">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">22.0</span><span class="p" data-group-id="0464100171-13">}</span><span class="p" data-group-id="0464100171-11">)</span><span class="p">,</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="0464100171-14">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-15">&lt;&lt;</span><span class="s">&quot;sensor.building.floor3.room42.humidity&quot;</span><span class="p" data-group-id="0464100171-15">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0464100171-16">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">55</span><span class="p" data-group-id="0464100171-16">}</span><span class="p" data-group-id="0464100171-14">)</span><span class="p">.</span></code></pre><h3 id="topic-matching-algorithm" class="section-heading"><a href="#topic-matching-algorithm" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Topic Matching Algorithm</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Internal matching logic</span><span class="w">
</span><span class="nf">match_topic</span><span class="p" data-group-id="3349541988-1">(</span><span class="p" data-group-id="3349541988-2">&lt;&lt;</span><span class="s">&quot;sensor.*&quot;</span><span class="p" data-group-id="3349541988-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-3">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="3349541988-3">&gt;&gt;</span><span class="p" data-group-id="3349541988-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p">;</span><span class="w">
</span><span class="nf">match_topic</span><span class="p" data-group-id="3349541988-4">(</span><span class="p" data-group-id="3349541988-5">&lt;&lt;</span><span class="s">&quot;sensor.*&quot;</span><span class="p" data-group-id="3349541988-5">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-6">&lt;&lt;</span><span class="s">&quot;sensor.room1.temp&quot;</span><span class="p" data-group-id="3349541988-6">&gt;&gt;</span><span class="p" data-group-id="3349541988-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p">;</span><span class="w">
</span><span class="nf">match_topic</span><span class="p" data-group-id="3349541988-7">(</span><span class="p" data-group-id="3349541988-8">&lt;&lt;</span><span class="s">&quot;sensor.#&quot;</span><span class="p" data-group-id="3349541988-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-9">&lt;&lt;</span><span class="s">&quot;sensor.room1.temp&quot;</span><span class="p" data-group-id="3349541988-9">&gt;&gt;</span><span class="p" data-group-id="3349541988-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p">;</span><span class="w">
</span><span class="nf">match_topic</span><span class="p" data-group-id="3349541988-10">(</span><span class="p" data-group-id="3349541988-11">&lt;&lt;</span><span class="s">&quot;sensor.*.temperature&quot;</span><span class="p" data-group-id="3349541988-11">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-12">&lt;&lt;</span><span class="s">&quot;sensor.room1.temperature&quot;</span><span class="p" data-group-id="3349541988-12">&gt;&gt;</span><span class="p" data-group-id="3349541988-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p">;</span><span class="w">
</span><span class="nf">match_topic</span><span class="p" data-group-id="3349541988-13">(</span><span class="n">Pattern</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p" data-group-id="3349541988-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Split on dots and match segment by segment</span><span class="w">
    </span><span class="nf">match_segments</span><span class="p" data-group-id="3349541988-14">(</span><span class="nc">binary</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="3349541988-15">(</span><span class="n">Pattern</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-16">&lt;&lt;</span><span class="s">&quot;.&quot;</span><span class="p" data-group-id="3349541988-16">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-17">[</span><span class="ss">global</span><span class="p" data-group-id="3349541988-17">]</span><span class="p" data-group-id="3349541988-15">)</span><span class="p">,</span><span class="w">
                   </span><span class="nc">binary</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="3349541988-18">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-19">&lt;&lt;</span><span class="s">&quot;.&quot;</span><span class="p" data-group-id="3349541988-19">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3349541988-20">[</span><span class="ss">global</span><span class="p" data-group-id="3349541988-20">]</span><span class="p" data-group-id="3349541988-18">)</span><span class="p" data-group-id="3349541988-14">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="error-handling" class="section-heading"><a href="#error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling</span></h2><h3 id="subscription-errors" class="section-heading"><a href="#subscription-errors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscription Errors</span></h3><pre><code class="makeup erlang" translate="no"><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="1062715652-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="p" data-group-id="1062715652-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="p" data-group-id="1062715652-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="1062715652-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Successfully subscribed</span><span class="w">
        </span><span class="p" data-group-id="1062715652-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="1062715652-3">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="1062715652-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_topic</span><span class="p" data-group-id="1062715652-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Topic format is invalid</span><span class="w">
        </span><span class="p" data-group-id="1062715652-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">bad_topic</span><span class="p" data-group-id="1062715652-5">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="1062715652-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1062715652-7">{</span><span class="ss">dht_error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1062715652-7">}</span><span class="p" data-group-id="1062715652-6">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Failed to advertise to DHT</span><span class="w">
        </span><span class="c1">%% Subscription still works locally</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_WARNING</span><span class="p" data-group-id="1062715652-8">(</span><span class="s">&quot;DHT advertisement failed: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1062715652-9">[</span><span class="n">Reason</span><span class="p" data-group-id="1062715652-9">]</span><span class="p" data-group-id="1062715652-8">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="1062715652-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">partial_subscription</span><span class="p" data-group-id="1062715652-10">}</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="1062715652-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1062715652-11">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="1062715652-12">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1062715652-12">}</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="publishing-errors" class="section-heading"><a href="#publishing-errors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Publishing Errors</span></h3><pre><code class="makeup erlang" translate="no"><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="8029143195-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="8029143195-1">)</span><span class="w"> </span><span class="k">of</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Published to at least one subscriber (or no subscribers exist)</span><span class="w">
        </span><span class="ss">ok</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="8029143195-2">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_subscribers</span><span class="p" data-group-id="8029143195-2">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% No subscribers found for topic</span><span class="w">
        </span><span class="c1">%% This may be expected behavior</span><span class="w">
        </span><span class="ss">ok</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="8029143195-3">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8029143195-4">{</span><span class="ss">partial_delivery</span><span class="p">,</span><span class="w"> </span><span class="n">FailedNodes</span><span class="p" data-group-id="8029143195-4">}</span><span class="p" data-group-id="8029143195-3">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="c1">%% Some subscribers unreachable</span><span class="w">
        </span><span class="o">?</span><span class="n">LOG_WARNING</span><span class="p" data-group-id="8029143195-5">(</span><span class="s">&quot;Failed to deliver to: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8029143195-6">[</span><span class="n">FailedNodes</span><span class="p" data-group-id="8029143195-6">]</span><span class="p" data-group-id="8029143195-5">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">ok</span><span class="p">;</span><span class="w">

    </span><span class="p" data-group-id="8029143195-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8029143195-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="8029143195-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8029143195-8">}</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="callback-error-handling" class="section-heading"><a href="#callback-error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Callback Error Handling</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Defensive callback implementation</span><span class="w">
</span><span class="n">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9921112333-1">(</span><span class="n">Event</span><span class="p" data-group-id="9921112333-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">try</span><span class="w">
        </span><span class="p" data-group-id="9921112333-2">#{</span><span class="ss">topic</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9921112333-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w">
        </span><span class="nf">process_event</span><span class="p" data-group-id="9921112333-3">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9921112333-3">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">ok</span><span class="w">
    </span><span class="k">catch</span><span class="w">
        </span><span class="n">Class</span><span class="p">:</span><span class="n">Reason</span><span class="p">:</span><span class="n">Stacktrace</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="o">?</span><span class="n">LOG_ERROR</span><span class="p" data-group-id="9921112333-4">(</span><span class="s">&quot;Callback error: </span><span class="si">~p</span><span class="s">:</span><span class="si">~p</span><span class="si">~n</span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w">
                       </span><span class="p" data-group-id="9921112333-5">[</span><span class="n">Class</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p">,</span><span class="w"> </span><span class="n">Stacktrace</span><span class="p" data-group-id="9921112333-5">]</span><span class="p" data-group-id="9921112333-4">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="9921112333-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">callback_failed</span><span class="p" data-group-id="9921112333-6">}</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="performance-optimization" class="section-heading"><a href="#performance-optimization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Optimization</span></h2><h3 id="subscriber-caching" class="section-heading"><a href="#subscriber-caching" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscriber Caching</span></h3><p>Publishers cache subscriber lists:</p><ul><li><strong>Cache TTL</strong>: 60 seconds</li><li><strong>DHT queries</strong>: Only on cache miss</li><li><strong>Cache hit ratio</strong>: ~98% for frequent publishes</li></ul><pre><code class="makeup erlang" translate="no"><span class="n">Example</span><span class="p">:</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Topic</span><span class="w"> </span><span class="ss">published</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="ss">times</span><span class="o">/</span><span class="ss">minute</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="n">TTL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="ss">seconds</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">queries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">~</span><span class="mi">2</span><span class="o">/</span><span class="ss">minute</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="ss">hit</span><span class="w"> </span><span class="ss">ratio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">98</span><span class="c1">%</span></code></pre><h3 id="batching-strategy" class="section-heading"><a href="#batching-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Batching Strategy</span></h3><p>For high-throughput scenarios, batch messages:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Instead of many individual publishes</span><span class="w">
</span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="8145540133-1">(</span><span class="nf">fun</span><span class="p" data-group-id="8145540133-2">(</span><span class="n">Value</span><span class="p" data-group-id="8145540133-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="8145540133-3">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8145540133-4">&lt;&lt;</span><span class="s">&quot;sensor.data&quot;</span><span class="p" data-group-id="8145540133-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8145540133-5">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="8145540133-5">}</span><span class="p" data-group-id="8145540133-3">)</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Values</span><span class="p" data-group-id="8145540133-1">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Consider batching</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="8145540133-6">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8145540133-7">&lt;&lt;</span><span class="s">&quot;sensor.data.batch&quot;</span><span class="p" data-group-id="8145540133-7">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8145540133-8">#{</span><span class="w">
    </span><span class="ss">values</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Values</span><span class="p">,</span><span class="w">
    </span><span class="ss">count</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="8145540133-9">(</span><span class="n">Values</span><span class="p" data-group-id="8145540133-9">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="8145540133-10">(</span><span class="ss">millisecond</span><span class="p" data-group-id="8145540133-10">)</span><span class="w">
</span><span class="p" data-group-id="8145540133-8">}</span><span class="p" data-group-id="8145540133-6">)</span><span class="p">.</span></code></pre><h3 id="connection-pooling" class="section-heading"><a href="#connection-pooling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Pooling</span></h3><p>The gateway maintains connection pools to subscribers:</p><ul><li><strong>Max connections</strong>: 1,000 (configurable)</li><li><strong>LRU eviction</strong>: Least recently used connections evicted when pool is full</li><li><strong>Connection reuse</strong>: QUIC streams multiplexed on single connection</li></ul><h3 id="topic-design-for-performance" class="section-heading"><a href="#topic-design-for-performance" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Topic Design for Performance</span></h3><p><strong>Avoid</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Too many unique topics (one per entity)</span><span class="w">
</span><span class="p" data-group-id="2459635810-1">&lt;&lt;</span><span class="s">&quot;sensor.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SensorId</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.temperature&quot;</span><span class="p" data-group-id="2459635810-1">&gt;&gt;</span><span class="w">  </span><span class="c1">% Millions of topics</span></code></pre><p><strong>Prefer</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Fewer topics with IDs in payload</span><span class="w">
</span><span class="p" data-group-id="6174036373-1">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="6174036373-1">&gt;&gt;</span><span class="w">  </span><span class="c1">% Single topic</span><span class="w">
</span><span class="p" data-group-id="6174036373-2">#{</span><span class="ss">sensor_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SensorId</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="6174036373-2">}</span><span class="w">  </span><span class="c1">% ID in payload</span></code></pre><hr class="thin"/><h2 id="best-practices" class="section-heading"><a href="#best-practices" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Best Practices</span></h2><h3 id="topic-naming" class="section-heading"><a href="#topic-naming" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Topic Naming</span></h3><p>Use <strong>hierarchical naming</strong> with dot-separated segments:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Good - hierarchical, namespaced</span><span class="w">
</span><span class="p" data-group-id="8047183036-1">&lt;&lt;</span><span class="s">&quot;myapp.sensor.temperature&quot;</span><span class="p" data-group-id="8047183036-1">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="8047183036-2">&lt;&lt;</span><span class="s">&quot;myapp.user.status&quot;</span><span class="p" data-group-id="8047183036-2">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="8047183036-3">&lt;&lt;</span><span class="s">&quot;energy.home.consumption&quot;</span><span class="p" data-group-id="8047183036-3">&gt;&gt;</span><span class="w">

</span><span class="c1">%% Avoid</span><span class="w">
</span><span class="p" data-group-id="8047183036-4">&lt;&lt;</span><span class="s">&quot;temperature&quot;</span><span class="p" data-group-id="8047183036-4">&gt;&gt;</span><span class="w">          </span><span class="c1">% Not namespaced</span><span class="w">
</span><span class="p" data-group-id="8047183036-5">&lt;&lt;</span><span class="s">&quot;user-status&quot;</span><span class="p" data-group-id="8047183036-5">&gt;&gt;</span><span class="w">          </span><span class="c1">% Use dots, not dashes</span><span class="w">
</span><span class="p" data-group-id="8047183036-6">&lt;&lt;</span><span class="s">&quot;myapp_sensor_temp&quot;</span><span class="p" data-group-id="8047183036-6">&gt;&gt;</span><span class="w">    </span><span class="c1">% Use dots, not underscores</span></code></pre><h3 id="payload-design" class="section-heading"><a href="#payload-design" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Payload Design</span></h3><p><strong>Include metadata in payloads</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="8737048407-1">#{</span><span class="w">
    </span><span class="c1">%% Required data</span><span class="w">
    </span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Contextual metadata</span><span class="w">
    </span><span class="ss">sensor_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8737048407-2">&lt;&lt;</span><span class="s">&quot;sensor-001&quot;</span><span class="p" data-group-id="8737048407-2">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">location</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8737048407-3">&lt;&lt;</span><span class="s">&quot;room-42&quot;</span><span class="p" data-group-id="8737048407-3">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="8737048407-4">(</span><span class="ss">millisecond</span><span class="p" data-group-id="8737048407-4">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Optional metadata</span><span class="w">
    </span><span class="ss">unit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8737048407-5">&lt;&lt;</span><span class="s">&quot;celsius&quot;</span><span class="p" data-group-id="8737048407-5">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">source</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8737048407-6">&lt;&lt;</span><span class="s">&quot;direct&quot;</span><span class="p" data-group-id="8737048407-6">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="8737048407-1">}</span></code></pre><h3 id="callback-design" class="section-heading"><a href="#callback-design" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Callback Design</span></h3><p><strong>Keep callbacks simple and fast</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Good - simple, delegates heavy work</span><span class="w">
</span><span class="n">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9519434965-1">(</span><span class="n">Event</span><span class="p" data-group-id="9519434965-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Quick validation</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">validate_event</span><span class="p" data-group-id="9519434965-2">(</span><span class="n">Event</span><span class="p" data-group-id="9519434965-2">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Delegate to worker for heavy processing</span><span class="w">
            </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="9519434965-3">(</span><span class="ss">my_worker</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9519434965-4">{</span><span class="ss">process_event</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9519434965-4">}</span><span class="p" data-group-id="9519434965-3">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="9519434965-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="9519434965-5">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="w">  </span><span class="c1">% Ignore invalid events</span><span class="w">
    </span><span class="k">end</span><span class="w">
</span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Avoid - heavy processing in callback</span><span class="w">
</span><span class="n">Callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9519434965-6">(</span><span class="n">Event</span><span class="p" data-group-id="9519434965-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Don&#39;t do database writes or HTTP calls here</span><span class="w">
    </span><span class="p" data-group-id="9519434965-7">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9519434965-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w">
    </span><span class="nc">database</span><span class="p">:</span><span class="nf">insert</span><span class="p" data-group-id="9519434965-8">(</span><span class="ss">payload_table</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9519434965-8">)</span><span class="p">,</span><span class="w">  </span><span class="c1">% Blocking!</span><span class="w">
    </span><span class="nc">http_client</span><span class="p">:</span><span class="nf">post</span><span class="p" data-group-id="9519434965-9">(</span><span class="ss">webhook_url</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9519434965-9">)</span><span class="w">    </span><span class="c1">% Blocking!</span><span class="w">
</span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="subscription-lifecycle" class="section-heading"><a href="#subscription-lifecycle" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Subscription Lifecycle</span></h3><p><strong>Subscribe early, unsubscribe on shutdown</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="nf">init</span><span class="p" data-group-id="9938294876-1">(</span><span class="p" data-group-id="9938294876-2">[</span><span class="p" data-group-id="9938294876-2">]</span><span class="p" data-group-id="9938294876-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9938294876-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="9938294876-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="9938294876-4">(</span><span class="n">Endpoint</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9938294876-5">#{</span><span class="p" data-group-id="9938294876-5">}</span><span class="p" data-group-id="9938294876-4">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9938294876-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="9938294876-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="9938294876-7">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9938294876-8">&lt;&lt;</span><span class="s">&quot;events.#&quot;</span><span class="p" data-group-id="9938294876-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9938294876-9">(</span><span class="p" data-group-id="9938294876-9">)</span><span class="p" data-group-id="9938294876-7">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9938294876-10">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9938294876-11">#{</span><span class="ss">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="ss">subscription</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="9938294876-11">}</span><span class="p" data-group-id="9938294876-10">}</span><span class="p">.</span><span class="w">

</span><span class="nf">terminate</span><span class="p" data-group-id="9938294876-12">(</span><span class="p">_</span><span class="n">Reason</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9938294876-13">#{</span><span class="ss">client</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="9938294876-13">}</span><span class="p" data-group-id="9938294876-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Clean up subscription</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">unsubscribe</span><span class="p" data-group-id="9938294876-14">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9938294876-15">&lt;&lt;</span><span class="s">&quot;events.#&quot;</span><span class="p" data-group-id="9938294876-15">&gt;&gt;</span><span class="p" data-group-id="9938294876-14">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">disconnect</span><span class="p" data-group-id="9938294876-16">(</span><span class="n">Client</span><span class="p" data-group-id="9938294876-16">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><h3 id="error-recovery" class="section-heading"><a href="#error-recovery" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Recovery</span></h3><p><strong>Handle reconnection gracefully</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="nf">handle_info</span><span class="p" data-group-id="4955625176-1">(</span><span class="p" data-group-id="4955625176-2">{</span><span class="ss">macula_disconnected</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="4955625176-2">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="4955625176-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="o">?</span><span class="n">LOG_WARNING</span><span class="p" data-group-id="4955625176-3">(</span><span class="s">&quot;Disconnected: </span><span class="si">~p</span><span class="s">, reconnecting...&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4955625176-4">[</span><span class="n">Reason</span><span class="p" data-group-id="4955625176-4">]</span><span class="p" data-group-id="4955625176-3">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">timer</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="4955625176-5">(</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="ss">reconnect</span><span class="p" data-group-id="4955625176-5">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4955625176-6">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="4955625176-7">#{</span><span class="ss">connected</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="4955625176-7">}</span><span class="p" data-group-id="4955625176-6">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="4955625176-8">(</span><span class="ss">reconnect</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4955625176-9">#{</span><span class="ss">endpoint</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Endpoint</span><span class="p" data-group-id="4955625176-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="4955625176-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="4955625176-10">(</span><span class="n">Endpoint</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4955625176-11">#{</span><span class="p" data-group-id="4955625176-11">}</span><span class="p" data-group-id="4955625176-10">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="4955625176-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="4955625176-12">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Re-subscribe to topics</span><span class="w">
            </span><span class="nf">resubscribe</span><span class="p" data-group-id="4955625176-13">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="4955625176-13">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="4955625176-14">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="4955625176-15">#{</span><span class="ss">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="ss">connected</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="4955625176-15">}</span><span class="p" data-group-id="4955625176-14">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="4955625176-16">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="4955625176-16">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">timer</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="4955625176-17">(</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="ss">reconnect</span><span class="p" data-group-id="4955625176-17">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="4955625176-18">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="4955625176-18">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="examples" class="section-heading"><a href="#examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Examples</span></h2><h3 id="example-1-temperature-monitoring" class="section-heading"><a href="#example-1-temperature-monitoring" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 1: Temperature Monitoring</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% temperature_monitor.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="5298948255-1">(</span><span class="ss">temperature_monitor</span><span class="p" data-group-id="5298948255-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="5298948255-2">(</span><span class="ss">gen_server</span><span class="p" data-group-id="5298948255-2">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="5298948255-3">(</span><span class="p" data-group-id="5298948255-4">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_info</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="5298948255-4">]</span><span class="p" data-group-id="5298948255-3">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="5298948255-5">(</span><span class="n">Endpoint</span><span class="p" data-group-id="5298948255-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="5298948255-6">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5298948255-7">[</span><span class="n">Endpoint</span><span class="p" data-group-id="5298948255-7">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5298948255-8">[</span><span class="p" data-group-id="5298948255-8">]</span><span class="p" data-group-id="5298948255-6">)</span><span class="p">.</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="5298948255-9">(</span><span class="p" data-group-id="5298948255-10">[</span><span class="n">Endpoint</span><span class="p" data-group-id="5298948255-10">]</span><span class="p" data-group-id="5298948255-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5298948255-11">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="5298948255-11">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="5298948255-12">(</span><span class="n">Endpoint</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5298948255-13">#{</span><span class="p" data-group-id="5298948255-13">}</span><span class="p" data-group-id="5298948255-12">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Subscribe to all temperature sensors</span><span class="w">
    </span><span class="p" data-group-id="5298948255-14">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="5298948255-14">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="5298948255-15">(</span><span class="w">
        </span><span class="n">Peer</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="5298948255-16">&lt;&lt;</span><span class="s">&quot;sensor.*.temperature&quot;</span><span class="p" data-group-id="5298948255-16">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="nf">self</span><span class="p" data-group-id="5298948255-17">(</span><span class="p" data-group-id="5298948255-17">)</span><span class="w">
    </span><span class="p" data-group-id="5298948255-15">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="5298948255-18">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5298948255-19">#{</span><span class="ss">client</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="ss">readings</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5298948255-20">#{</span><span class="p" data-group-id="5298948255-20">}</span><span class="p" data-group-id="5298948255-19">}</span><span class="p" data-group-id="5298948255-18">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="5298948255-21">(</span><span class="p" data-group-id="5298948255-22">{</span><span class="ss">macula_event</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="5298948255-22">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="5298948255-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5298948255-23">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="ss">sensor_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">SensorId</span><span class="p" data-group-id="5298948255-23">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Payload</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Check for alerts</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">30.0</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nf">alert_high_temperature</span><span class="p" data-group-id="5298948255-24">(</span><span class="n">SensorId</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="5298948255-24">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Store reading</span><span class="w">
    </span><span class="n">Readings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="5298948255-25">(</span><span class="n">SensorId</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="5298948255-26">(</span><span class="ss">readings</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="5298948255-26">)</span><span class="p" data-group-id="5298948255-25">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5298948255-27">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="5298948255-28">#{</span><span class="ss">readings</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Readings</span><span class="p" data-group-id="5298948255-28">}</span><span class="p" data-group-id="5298948255-27">}</span><span class="p">.</span><span class="w">

</span><span class="nf">alert_high_temperature</span><span class="p" data-group-id="5298948255-29">(</span><span class="n">SensorId</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="5298948255-29">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5298948255-30">(</span><span class="s">&quot;ALERT: </span><span class="si">~s</span><span class="s"> temperature is ~.1f C!</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5298948255-31">[</span><span class="n">SensorId</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="5298948255-31">]</span><span class="p" data-group-id="5298948255-30">)</span><span class="p">.</span></code></pre><h3 id="example-2-event-bus-pattern" class="section-heading"><a href="#example-2-event-bus-pattern" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 2: Event Bus Pattern</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% event_bus.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="2139602671-1">(</span><span class="ss">event_bus</span><span class="p" data-group-id="2139602671-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="2139602671-2">(</span><span class="p" data-group-id="2139602671-3">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">subscribe</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">publish</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="2139602671-3">]</span><span class="p" data-group-id="2139602671-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="2139602671-4">(</span><span class="n">Endpoint</span><span class="p" data-group-id="2139602671-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2139602671-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="2139602671-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="2139602671-6">(</span><span class="n">Endpoint</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2139602671-7">#{</span><span class="p" data-group-id="2139602671-7">}</span><span class="p" data-group-id="2139602671-6">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">register</span><span class="p" data-group-id="2139602671-8">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="nf">spawn</span><span class="p" data-group-id="2139602671-9">(</span><span class="nf">fun</span><span class="p" data-group-id="2139602671-10">(</span><span class="p" data-group-id="2139602671-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">loop</span><span class="p" data-group-id="2139602671-11">(</span><span class="n">Client</span><span class="p" data-group-id="2139602671-11">)</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="2139602671-9">)</span><span class="p" data-group-id="2139602671-8">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2139602671-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="2139602671-12">}</span><span class="p">.</span><span class="w">

</span><span class="nf">subscribe</span><span class="p" data-group-id="2139602671-13">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="2139602671-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="o">?</span><span class="n">MODULE</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="2139602671-14">{</span><span class="ss">subscribe</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="2139602671-14">}</span><span class="p">.</span><span class="w">

</span><span class="nf">publish</span><span class="p" data-group-id="2139602671-15">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="2139602671-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="o">?</span><span class="n">MODULE</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="2139602671-16">{</span><span class="ss">publish</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="2139602671-16">}</span><span class="p">.</span><span class="w">

</span><span class="nf">loop</span><span class="p" data-group-id="2139602671-17">(</span><span class="n">Client</span><span class="p" data-group-id="2139602671-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="2139602671-18">{</span><span class="ss">subscribe</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="2139602671-18">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="2139602671-19">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="2139602671-19">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">loop</span><span class="p" data-group-id="2139602671-20">(</span><span class="n">Client</span><span class="p" data-group-id="2139602671-20">)</span><span class="p">;</span><span class="w">

        </span><span class="p" data-group-id="2139602671-21">{</span><span class="ss">publish</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="2139602671-21">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="2139602671-22">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="2139602671-22">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">loop</span><span class="p" data-group-id="2139602671-23">(</span><span class="n">Client</span><span class="p" data-group-id="2139602671-23">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Usage</span><span class="w">
</span><span class="nc">event_bus</span><span class="p">:</span><span class="nf">start</span><span class="p" data-group-id="2139602671-24">(</span><span class="p" data-group-id="2139602671-25">&lt;&lt;</span><span class="s">&quot;https://localhost:9443&quot;</span><span class="p" data-group-id="2139602671-25">&gt;&gt;</span><span class="p" data-group-id="2139602671-24">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Subscribe to user events</span><span class="w">
</span><span class="nc">event_bus</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="2139602671-26">(</span><span class="p" data-group-id="2139602671-27">&lt;&lt;</span><span class="s">&quot;user.#&quot;</span><span class="p" data-group-id="2139602671-27">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="2139602671-28">(</span><span class="n">E</span><span class="p" data-group-id="2139602671-28">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2139602671-29">(</span><span class="s">&quot;User event: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2139602671-30">[</span><span class="n">E</span><span class="p" data-group-id="2139602671-30">]</span><span class="p" data-group-id="2139602671-29">)</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="2139602671-26">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Publish events</span><span class="w">
</span><span class="nc">event_bus</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="2139602671-31">(</span><span class="p" data-group-id="2139602671-32">&lt;&lt;</span><span class="s">&quot;user.created&quot;</span><span class="p" data-group-id="2139602671-32">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2139602671-33">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2139602671-34">&lt;&lt;</span><span class="s">&quot;123&quot;</span><span class="p" data-group-id="2139602671-34">&gt;&gt;</span><span class="p" data-group-id="2139602671-33">}</span><span class="p" data-group-id="2139602671-31">)</span><span class="p">,</span><span class="w">
</span><span class="nc">event_bus</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="2139602671-35">(</span><span class="p" data-group-id="2139602671-36">&lt;&lt;</span><span class="s">&quot;user.updated&quot;</span><span class="p" data-group-id="2139602671-36">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2139602671-37">#{</span><span class="ss">user_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2139602671-38">&lt;&lt;</span><span class="s">&quot;123&quot;</span><span class="p" data-group-id="2139602671-38">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2139602671-39">&lt;&lt;</span><span class="s">&quot;Alice&quot;</span><span class="p" data-group-id="2139602671-39">&gt;&gt;</span><span class="p" data-group-id="2139602671-37">}</span><span class="p" data-group-id="2139602671-35">)</span><span class="p">.</span></code></pre><h3 id="example-3-real-time-dashboard" class="section-heading"><a href="#example-3-real-time-dashboard" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 3: Real-Time Dashboard</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># lib/my_app/realtime_dashboard.ex</span><span class="w">
</span><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.RealtimeDashboard</span><span class="w"> </span><span class="k" data-group-id="2556432682-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="2556432682-2">(</span><span class="n">opts</span><span class="p" data-group-id="2556432682-2">)</span><span class="w"> </span><span class="k" data-group-id="2556432682-3">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="2556432682-4">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="2556432682-4">)</span><span class="w">
  </span><span class="k" data-group-id="2556432682-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="2556432682-5">(</span><span class="c">_opts</span><span class="p" data-group-id="2556432682-5">)</span><span class="w"> </span><span class="k" data-group-id="2556432682-6">do</span><span class="w">
    </span><span class="p" data-group-id="2556432682-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p" data-group-id="2556432682-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="2556432682-8">(</span><span class="s">&quot;https://localhost:9443&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2556432682-9">%{</span><span class="p" data-group-id="2556432682-9">}</span><span class="p" data-group-id="2556432682-8">)</span><span class="w">

    </span><span class="c1"># Subscribe to multiple topics</span><span class="w">
    </span><span class="n">topics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2556432682-10">[</span><span class="w">
      </span><span class="s">&quot;metrics.cpu&quot;</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;metrics.memory&quot;</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;metrics.disk&quot;</span><span class="p">,</span><span class="w">
      </span><span class="s">&quot;alerts.#&quot;</span><span class="w">
    </span><span class="p" data-group-id="2556432682-10">]</span><span class="w">

    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">each</span><span class="p" data-group-id="2556432682-11">(</span><span class="n">topics</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="2556432682-12">fn</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">:macula</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="2556432682-13">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="2556432682-14">(</span><span class="p" data-group-id="2556432682-14">)</span><span class="p" data-group-id="2556432682-13">)</span><span class="w">
    </span><span class="k" data-group-id="2556432682-12">end</span><span class="p" data-group-id="2556432682-11">)</span><span class="w">

    </span><span class="p" data-group-id="2556432682-15">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2556432682-16">%{</span><span class="ss">client</span><span class="p">:</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2556432682-17">%{</span><span class="p" data-group-id="2556432682-17">}</span><span class="p" data-group-id="2556432682-16">}</span><span class="p" data-group-id="2556432682-15">}</span><span class="w">
  </span><span class="k" data-group-id="2556432682-6">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="2556432682-18">(</span><span class="p" data-group-id="2556432682-19">{</span><span class="ss">:macula_event</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p" data-group-id="2556432682-19">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="2556432682-18">)</span><span class="w"> </span><span class="k" data-group-id="2556432682-20">do</span><span class="w">
    </span><span class="c1"># Broadcast to Phoenix channels</span><span class="w">
    </span><span class="nc">MyAppWeb.Endpoint</span><span class="o">.</span><span class="n">broadcast!</span><span class="p" data-group-id="2556432682-21">(</span><span class="s">&quot;dashboard:metrics&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;update&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2556432682-22">%{</span><span class="w">
      </span><span class="ss">topic</span><span class="p">:</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w">
      </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w">
      </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">utc_now</span><span class="p" data-group-id="2556432682-23">(</span><span class="p" data-group-id="2556432682-23">)</span><span class="w">
    </span><span class="p" data-group-id="2556432682-22">}</span><span class="p" data-group-id="2556432682-21">)</span><span class="w">

    </span><span class="c1"># Update local state</span><span class="w">
    </span><span class="n">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="2556432682-24">(</span><span class="n">state</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p" data-group-id="2556432682-24">)</span><span class="w">
    </span><span class="p" data-group-id="2556432682-25">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2556432682-26">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">metrics</span><span class="p">:</span><span class="w"> </span><span class="n">metrics</span><span class="p" data-group-id="2556432682-26">}</span><span class="p" data-group-id="2556432682-25">}</span><span class="w">
  </span><span class="k" data-group-id="2556432682-20">end</span><span class="w">
</span><span class="k" data-group-id="2556432682-1">end</span></code></pre><h3 id="example-4-distributed-sensor-network" class="section-heading"><a href="#example-4-distributed-sensor-network" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 4: Distributed Sensor Network</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% sensor_node.erl - Runs on each sensor</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="9244089277-1">(</span><span class="ss">sensor_node</span><span class="p" data-group-id="9244089277-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="9244089277-2">(</span><span class="p" data-group-id="9244089277-3">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="9244089277-3">]</span><span class="p" data-group-id="9244089277-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="9244089277-4">(</span><span class="n">Gateway</span><span class="p">,</span><span class="w"> </span><span class="n">SensorId</span><span class="p" data-group-id="9244089277-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9244089277-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="9244089277-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="9244089277-6">(</span><span class="n">Gateway</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9244089277-7">#{</span><span class="p" data-group-id="9244089277-7">}</span><span class="p" data-group-id="9244089277-6">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">publish_loop</span><span class="p" data-group-id="9244089277-8">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">SensorId</span><span class="p" data-group-id="9244089277-8">)</span><span class="p">.</span><span class="w">

</span><span class="nf">publish_loop</span><span class="p" data-group-id="9244089277-9">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">SensorId</span><span class="p" data-group-id="9244089277-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Read sensor value</span><span class="w">
    </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">read_temperature_sensor</span><span class="p" data-group-id="9244089277-10">(</span><span class="p" data-group-id="9244089277-10">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Publish reading</span><span class="w">
    </span><span class="n">Topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9244089277-11">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="9244089277-11">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">Payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9244089277-12">#{</span><span class="w">
        </span><span class="ss">sensor_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SensorId</span><span class="p">,</span><span class="w">
        </span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="9244089277-13">(</span><span class="ss">millisecond</span><span class="p" data-group-id="9244089277-13">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">location</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">get_location</span><span class="p" data-group-id="9244089277-14">(</span><span class="p" data-group-id="9244089277-14">)</span><span class="w">
    </span><span class="p" data-group-id="9244089277-12">}</span><span class="p">,</span><span class="w">

    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="9244089277-15">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9244089277-15">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Wait and repeat</span><span class="w">
    </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="9244089277-16">(</span><span class="mi">1000</span><span class="p" data-group-id="9244089277-16">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">publish_loop</span><span class="p" data-group-id="9244089277-17">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">SensorId</span><span class="p" data-group-id="9244089277-17">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% aggregator.erl - Runs on aggregation node</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="9244089277-18">(</span><span class="ss">aggregator</span><span class="p" data-group-id="9244089277-18">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="9244089277-19">(</span><span class="p" data-group-id="9244089277-20">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="9244089277-20">]</span><span class="p" data-group-id="9244089277-19">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="9244089277-21">(</span><span class="n">Gateway</span><span class="p" data-group-id="9244089277-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="9244089277-22">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="9244089277-22">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="9244089277-23">(</span><span class="n">Gateway</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9244089277-24">#{</span><span class="p" data-group-id="9244089277-24">}</span><span class="p" data-group-id="9244089277-23">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Subscribe to all sensors</span><span class="w">
    </span><span class="p" data-group-id="9244089277-25">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="9244089277-25">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="9244089277-26">(</span><span class="w">
        </span><span class="n">Peer</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="9244089277-27">&lt;&lt;</span><span class="s">&quot;sensor.#&quot;</span><span class="p" data-group-id="9244089277-27">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="nf">fun</span><span class="p" data-group-id="9244089277-28">(</span><span class="n">Event</span><span class="p" data-group-id="9244089277-28">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="9244089277-29">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="9244089277-30">#{</span><span class="ss">sensor_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="ss">value</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">V</span><span class="p" data-group-id="9244089277-30">}</span><span class="p" data-group-id="9244089277-29">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w">
            </span><span class="nf">store_reading</span><span class="p" data-group-id="9244089277-31">(</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="p" data-group-id="9244089277-31">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">update_dashboard</span><span class="p" data-group-id="9244089277-32">(</span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="p" data-group-id="9244089277-32">)</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="p" data-group-id="9244089277-26">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9244089277-33">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Client</span><span class="p" data-group-id="9244089277-33">}</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="migration-from-wamp" class="section-heading"><a href="#migration-from-wamp" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration from WAMP</span></h2><h3 id="key-differences" class="section-heading"><a href="#key-differences" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Key Differences</span></h3><table><thead><tr><th style="text-align: left;">Aspect</th><th style="text-align: left;">WAMP (Bondy)</th><th style="text-align: left;">Macula HTTP/3</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Discovery</strong></td><td style="text-align: left;">Centralized broker</td><td style="text-align: left;">DHT-based (decentralized)</td></tr><tr><td style="text-align: left;"><strong>Transport</strong></td><td style="text-align: left;">WebSocket</td><td style="text-align: left;">HTTP/3 QUIC</td></tr><tr><td style="text-align: left;"><strong>Subscribe</strong></td><td style="text-align: left;"><code class="inline">session.subscribe(Topic, Handler)</code></td><td style="text-align: left;"><code class="inline">macula:subscribe(Client, Topic, Handler)</code></td></tr><tr><td style="text-align: left;"><strong>Publish</strong></td><td style="text-align: left;"><code class="inline">session.publish(Topic, Args)</code></td><td style="text-align: left;"><code class="inline">macula:publish(Client, Topic, Payload)</code></td></tr><tr><td style="text-align: left;"><strong>Unsubscribe</strong></td><td style="text-align: left;"><code class="inline">session.unsubscribe(Subscription)</code></td><td style="text-align: left;"><code class="inline">macula:unsubscribe(Client, Topic)</code></td></tr><tr><td style="text-align: left;"><strong>Event Format</strong></td><td style="text-align: left;"><code class="inline">[Args, Kwargs]</code></td><td style="text-align: left;"><code class="inline">#{topic, payload}</code> map</td></tr><tr><td style="text-align: left;"><strong>NAT Traversal</strong></td><td style="text-align: left;">Requires config</td><td style="text-align: left;">Built-in (QUIC)</td></tr></tbody></table><h3 id="migration-steps" class="section-heading"><a href="#migration-steps" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration Steps</span></h3><h4>1. Update Dependencies</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="p" data-group-id="2168609734-1">{</span><span class="ss">deps</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2168609734-2">[</span><span class="w">
    </span><span class="p" data-group-id="2168609734-3">{</span><span class="ss">bondy</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2168609734-4">{</span><span class="ss">git</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;https://github.com/bondy-io/bondy.git&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2168609734-5">{</span><span class="ss">tag</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p" data-group-id="2168609734-5">}</span><span class="p" data-group-id="2168609734-4">}</span><span class="p" data-group-id="2168609734-3">}</span><span class="w">
</span><span class="p" data-group-id="2168609734-2">]</span><span class="p" data-group-id="2168609734-1">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="p" data-group-id="2168609734-6">{</span><span class="ss">deps</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2168609734-7">[</span><span class="w">
    </span><span class="p" data-group-id="2168609734-8">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0.10.0&quot;</span><span class="p" data-group-id="2168609734-8">}</span><span class="w">
</span><span class="p" data-group-id="2168609734-7">]</span><span class="p" data-group-id="2168609734-6">}</span><span class="p">.</span></code></pre><h4>2. Convert Subscriptions</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0904921494-1">(</span><span class="p" data-group-id="0904921494-2">[</span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="0904921494-2">]</span><span class="p" data-group-id="0904921494-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="0904921494-3">(</span><span class="p" data-group-id="0904921494-4">&lt;&lt;</span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="0904921494-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="0904921494-3">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">process_value</span><span class="p" data-group-id="0904921494-5">(</span><span class="n">Value</span><span class="p" data-group-id="0904921494-5">)</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="0904921494-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Subscription</span><span class="p" data-group-id="0904921494-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">bondy</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="0904921494-7">(</span><span class="n">Session</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0904921494-8">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="0904921494-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="0904921494-7">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="n">Handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="0904921494-9">(</span><span class="n">Event</span><span class="p" data-group-id="0904921494-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0904921494-10">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="0904921494-11">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="0904921494-11">}</span><span class="p" data-group-id="0904921494-10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w">
    </span><span class="nf">process_value</span><span class="p" data-group-id="0904921494-12">(</span><span class="n">Value</span><span class="p" data-group-id="0904921494-12">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="p" data-group-id="0904921494-13">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="0904921494-13">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="0904921494-14">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0904921494-15">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="0904921494-15">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="0904921494-14">)</span><span class="p">.</span></code></pre><h4>3. Convert Publishing</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="nc">bondy</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="7711080553-1">(</span><span class="n">Session</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7711080553-2">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="7711080553-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7711080553-3">[</span><span class="p" data-group-id="7711080553-4">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="7711080553-4">}</span><span class="p" data-group-id="7711080553-3">]</span><span class="p" data-group-id="7711080553-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="7711080553-5">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7711080553-6">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="7711080553-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7711080553-7">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">21.5</span><span class="p" data-group-id="7711080553-7">}</span><span class="p" data-group-id="7711080553-5">)</span><span class="p">.</span></code></pre><h4>4. Update Event Handlers</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Before (WAMP)</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="4651099305-1">(</span><span class="p" data-group-id="4651099305-2">[</span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="4651099305-2">]</span><span class="p" data-group-id="4651099305-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="4651099305-3">(</span><span class="p" data-group-id="4651099305-4">&lt;&lt;</span><span class="s">&quot;value&quot;</span><span class="p" data-group-id="4651099305-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="4651099305-3">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="4651099305-5">(</span><span class="p" data-group-id="4651099305-6">&lt;&lt;</span><span class="s">&quot;timestamp&quot;</span><span class="p" data-group-id="4651099305-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Kwargs</span><span class="p" data-group-id="4651099305-5">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4651099305-7">{</span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="p" data-group-id="4651099305-7">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% After (Macula)</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="4651099305-8">(</span><span class="n">Event</span><span class="p" data-group-id="4651099305-8">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="4651099305-9">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="4651099305-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4651099305-10">#{</span><span class="ss">value</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Timestamp</span><span class="p" data-group-id="4651099305-10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Payload</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4651099305-11">{</span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="p" data-group-id="4651099305-11">}</span><span class="p">.</span></code></pre><h3 id="migration-checklist" class="section-heading"><a href="#migration-checklist" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Migration Checklist</span></h3><ul><li>[ ] Update dependencies (WAMP -&gt; Macula)</li><li>[ ] Convert subscription calls</li><li>[ ] Update event handler signatures</li><li>[ ] Replace <code class="inline">bondy:publish/3</code> with <a href="macula.html#publish/3"><code class="inline">macula:publish/3</code></a></li><li>[ ] Replace <code class="inline">bondy:subscribe/3</code> with <a href="macula.html#subscribe/3"><code class="inline">macula:subscribe/3</code></a></li><li>[ ] Update error handling patterns</li><li>[ ] Test wildcard subscriptions</li><li>[ ] Verify event delivery under load</li><li>[ ] Update monitoring and logging</li></ul><hr class="thin"/><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="rpc_guide.html">RPC Guide</a> - Remote procedure calls with DHT discovery</li><li><a href="quick_start.html">Quick Start</a> - Getting started tutorial</li><li><a href="hello_world.html">Hello World</a> - Your first Macula application</li><li><a href="architecture.html">Architecture</a> - System architecture overview</li></ul><hr class="thin"/><p><strong>Last Updated</strong>: 2025-11-28
<strong>Status</strong>: Complete</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="rpc_guide.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
RPC Guide
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="performance_guide.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
Performance Guide
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.12.4" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.12.4">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.12.4/show/docs/developer/PUBSUB_GUIDE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
