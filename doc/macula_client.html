<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module macula_client</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module macula_client</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>   
Macula SDK - Main API module for HTTP/3 mesh client operations.

<p><b>Behaviours:</b> <a href="macula_client_behaviour.html"><code>macula_client_behaviour</code></a>.</p>

<h2><a name="description">Description</a></h2><p>   
Macula SDK - Main API module for HTTP/3 mesh client operations.</p>
  
   <p>This module provides the primary interface for applications to   
connect to Macula mesh networks and perform pub/sub and RPC   
operations over HTTP/3 (QUIC) transport.</p>
  
   <h3><a name="Quick_Start">Quick Start</a></h3>
  
   <p>Connect to a mesh, publish events, subscribe to topics, and make RPC calls.   
See individual function documentation for detailed examples with code.</p>
  
   <h3><a name="DHT_Network_Bootstrap_(v0.8.7+)">DHT Network Bootstrap (v0.8.7+)</a></h3>
  
   <p>Macula v0.8.7+ implements platform-level DHT bootstrapping. Each macula node
   automatically joins the configured DHT network on startup via the
   <code>MACULA_BOOTSTRAP_PEERS` environment variable.
  
   &lt;b&gt;Platform Configuration (Recommended):&lt;/b&gt;
   ```
   # Bootstrap node (no peers configured)
   MACULA_BOOTSTRAP_PEERS=  # empty - this IS a bootstrap peer
  
   # Other nodes (connect to bootstrap)
   MACULA_BOOTSTRAP_PEERS=https://bootstrap-node:4433</code>''</p>
  
   <b>Client SDK Usage:</b>
   Applications connect to their LOCAL macula instance, which is already part
   of the DHT network:
   <pre>   {ok, Client} = macula_client:connect(&amp;lt;&amp;lt;"https://localhost:4433"&amp;gt;&amp;gt;, #{
       realm =&gt; &amp;lt;&amp;lt;"my.app"&amp;gt;&amp;gt;
   }).</pre>
  
   The platform handles DHT network formation - applications don't need to
   manage bootstrap peer URLs.
  
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-args">args()</a></h3>
<p><code>args() = map() | list() | binary()</code></p>
<p>  Arguments for RPC calls.</p>

<h3 class="typedecl"><a name="type-client">client()</a></h3>
<p><code>client() = pid()</code></p>
<p>  Reference to a connected Macula mesh client.</p>

<h3 class="typedecl"><a name="type-event_data">event_data()</a></h3>
<p><code>event_data() = map() | binary()</code></p>
<p>  Event payload data. Typically a map that will be JSON-encoded.</p>

<h3 class="typedecl"><a name="type-options">options()</a></h3>
<p><code>options() = map()</code></p>
<p>  Connection or operation options.</p>

<h3 class="typedecl"><a name="type-procedure">procedure()</a></h3>
<p><code>procedure() = binary()</code></p>
<p>  RPC procedure name. Example: <code>"my.app.get_user"</code>.</p>

<h3 class="typedecl"><a name="type-subscription_ref">subscription_ref()</a></h3>
<p><code>subscription_ref() = reference()</code></p>
<p>  Reference to an active subscription for unsubscribe operations.</p>

<h3 class="typedecl"><a name="type-topic">topic()</a></h3>
<p><code>topic() = binary()</code></p>
<p>  Topic name for pub/sub operations. Topics should describe event types,
  not entity IDs. Example: <code>"my.app.user.registered"</code> (good),
  not <code>"my.app.user.123.registered"</code> (bad - ID belongs in payload).</p>

<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#advertise-3">advertise/3</a></td><td>Advertise a service that this client provides.</td></tr>
<tr><td valign="top"><a href="#advertise-4">advertise/4</a></td><td>Advertise a service with options.</td></tr>
<tr><td valign="top"><a href="#call-3">call/3</a></td><td>Make a synchronous RPC call.</td></tr>
<tr><td valign="top"><a href="#call-4">call/4</a></td><td>Make an RPC call with options.</td></tr>
<tr><td valign="top"><a href="#connect-2">connect/2</a></td><td>Connect to a Macula mesh network.</td></tr>
<tr><td valign="top"><a href="#connect_local-1">connect_local/1</a></td><td>Connect to the local Macula gateway (for in-VM workloads).</td></tr>
<tr><td valign="top"><a href="#disconnect-1">disconnect/1</a></td><td>Disconnect from the Macula mesh.</td></tr>
<tr><td valign="top"><a href="#discover_subscribers-2">discover_subscribers/2</a></td><td>Discover subscribers to a topic via DHT query.</td></tr>
<tr><td valign="top"><a href="#get_node_id-1">get_node_id/1</a></td><td>Get the node ID of this client.</td></tr>
<tr><td valign="top"><a href="#publish-3">publish/3</a></td><td>Publish an event to a topic.</td></tr>
<tr><td valign="top"><a href="#publish-4">publish/4</a></td><td>Publish an event with options.</td></tr>
<tr><td valign="top"><a href="#subscribe-3">subscribe/3</a></td><td>Subscribe to a topic.</td></tr>
<tr><td valign="top"><a href="#unadvertise-2">unadvertise/2</a></td><td>Stop advertising a service.</td></tr>
<tr><td valign="top"><a href="#unsubscribe-2">unsubscribe/2</a></td><td>Unsubscribe from a topic.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="advertise-3">advertise/3</a></h3>
<div class="spec">
<p><code>advertise(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Procedure::<a href="#type-procedure" docgen-rel="seetype" docgen-href="#procedure/0">procedure()</a>, Handler::<a href="/home/rl/work/github.com/macula-io/macula/doc/macula_service_registry.html#type-handler_fn" docgen-rel="seetype" docgen-href="macula:macula_service_registry#handler_fn/0">macula_service_registry:handler_fn()</a>) -&gt; {ok, reference()} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Advertise a service that this client provides.</p>
 
  <p>Registers a handler function for the specified procedure and advertises  
it to the DHT so other clients can discover and call it.</p>
 
  <p>The handler function receives a map of arguments and must return
  <code>{ok, Result}</code> or <code>{error, Reason}</code>.</p>
 
  <h3><a name="Options">Options</a></h3>
 
  <ul>
  <li><code>ttl</code> - Advertisement TTL in seconds (default: 300)</li>
  <li><code>metadata</code> - Custom metadata map (default: #{})</li>
  </ul>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  %% Define a handler function
  Handler = fun(#{user_id := UserId}) -&gt;
      {ok, #{user_id =&gt; UserId, name =&gt; &amp;lt;&amp;lt;"Alice"&amp;gt;&amp;gt;}}
  end.
 
  %% Advertise the service
  {ok, Ref} = macula_client:advertise(
      Client,
      &amp;lt;&amp;lt;"my.app.get_user"&amp;gt;&amp;gt;,
      Handler
  ).
 
  %% Other clients can now call:
  %% {ok, User} = macula_client:call(OtherClient, &amp;lt;&amp;lt;"my.app.get_user"&amp;gt;&amp;gt;,
  %%     #{user_id =&gt; &amp;lt;&amp;lt;"user-123"&amp;gt;&amp;gt;}).</pre></p>

<h3 class="function"><a name="advertise-4">advertise/4</a></h3>
<div class="spec">
<p><code>advertise(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Procedure::<a href="#type-procedure" docgen-rel="seetype" docgen-href="#procedure/0">procedure()</a>, Handler::<a href="/home/rl/work/github.com/macula-io/macula/doc/macula_service_registry.html#type-handler_fn" docgen-rel="seetype" docgen-href="macula:macula_service_registry#handler_fn/0">macula_service_registry:handler_fn()</a>, Opts::<a href="#type-options" docgen-rel="seetype" docgen-href="#options/0">options()</a>) -&gt; {ok, reference()} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p>Advertise a service with options.</p>

<h3 class="function"><a name="call-3">call/3</a></h3>
<div class="spec">
<p><code>call(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Procedure::<a href="#type-procedure" docgen-rel="seetype" docgen-href="#procedure/0">procedure()</a>, Args::<a href="#type-args" docgen-rel="seetype" docgen-href="#args/0">args()</a>) -&gt; {ok, Result::term()} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Make a synchronous RPC call.</p>
 
  <p>Calls a remote procedure and waits for the result.</p>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  %% Simple RPC call
  {ok, User} = macula_client:call(Client, &amp;lt;&amp;lt;"my.app.get_user"&amp;gt;&amp;gt;, #{
      user_id =&gt; &amp;lt;&amp;lt;"user-123"&amp;gt;&amp;gt;
  }).
 
  %% With timeout
  {ok, Result} = macula_client:call(Client, &amp;lt;&amp;lt;"my.app.process"&amp;gt;&amp;gt;,
      #{data =&gt; &amp;lt;&amp;lt;"large"&amp;gt;&amp;gt;},
      #{timeout =&gt; 30000}).</pre></p>

<h3 class="function"><a name="call-4">call/4</a></h3>
<div class="spec">
<p><code>call(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Procedure::<a href="#type-procedure" docgen-rel="seetype" docgen-href="#procedure/0">procedure()</a>, Args::<a href="#type-args" docgen-rel="seetype" docgen-href="#args/0">args()</a>, Opts::<a href="#type-options" docgen-rel="seetype" docgen-href="#options/0">options()</a>) -&gt; {ok, Result::term()} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p>Make an RPC call with options.</p>

<h3 class="function"><a name="connect-2">connect/2</a></h3>
<div class="spec">
<p><code>connect(Url::binary(), Opts::<a href="#type-options" docgen-rel="seetype" docgen-href="#options/0">options()</a>) -&gt; {ok, <a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Connect to a Macula mesh network.</p>
 
  <p>Creates a new HTTP/3 (QUIC) connection to the specified mesh endpoint.</p>
 
  <h3><a name="Options">Options</a></h3>
 
  <ul>
  <li><code>realm</code> - Required. Binary realm identifier (e.g., <code>&amp;lt;&amp;lt;"my.app.realm"&amp;gt;&amp;gt;</code>)</li>
  <li><code>auth</code> - Optional. Authentication map with <code>api_key</code> or other auth methods</li>
  <li><code>timeout</code> - Optional. Connection timeout in milliseconds (default: 5000)</li>
  <li><code>node_id</code> - Optional. 32-byte node ID (generated if not provided)</li>
  </ul>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  %% Basic connection
  {ok, Client} = macula_client:connect(&amp;lt;&amp;lt;"https://mesh.local:443"&amp;gt;&amp;gt;, #{
      realm =&gt; &amp;lt;&amp;lt;"my.realm"&amp;gt;&amp;gt;
  }).
 
  %% With API key authentication
  {ok, Client} = macula_client:connect(&amp;lt;&amp;lt;"https://mesh.local:443"&amp;gt;&amp;gt;, #{
      realm =&gt; &amp;lt;&amp;lt;"my.realm"&amp;gt;&amp;gt;,
      auth =&gt; #{api_key =&gt; &amp;lt;&amp;lt;"secret-key"&amp;gt;&amp;gt;}
  }).</pre></p>

<h3 class="function"><a name="connect_local-1">connect_local/1</a></h3>
<div class="spec">
<p><code>connect_local(Opts::<a href="#type-options" docgen-rel="seetype" docgen-href="#options/0">options()</a>) -&gt; {ok, <a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Connect to the local Macula gateway (for in-VM workloads).</p>
 
  <p>This function is used by applications running in the same BEAM VM as
  the Macula platform. Instead of creating a QUIC connection to localhost,
  it connects directly to the local <code>macula_gateway</code> process via  
process-to-process communication.</p>
 
  <h3><a name="Architecture">Architecture</a></h3>
 
  <pre>  Phoenix/Elixir App → macula_local_client → macula_gateway
                                              ↓ (QUIC)
                                         Other Peers</pre>
 
  <h3><a name="When_to_Use">When to Use</a></h3>
 
  <ul>
  <li>✅ Use <code>connect_local/1</code> when your application runs in the same VM as Macula</li>
  <li>✅ Phoenix applications deployed with Macula in the same container</li>
  <li>❌ Do NOT use <code>connect/2</code> with localhost URL - it creates unnecessary QUIC overhead</li>
  </ul>
 
  <h3><a name="Options">Options</a></h3>
 
  <ul>
  <li><code>realm</code> - Required. Binary realm identifier (e.g., <code>&amp;lt;&amp;lt;"my.app.realm"&amp;gt;&amp;gt;</code>)</li>
  <li><code>event_handler</code> - Optional. PID to receive events (default: caller PID)</li>
  </ul>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  %% Elixir Phoenix application
  {:ok, client} = :macula_client.connect_local(%{
      realm: "macula.arcade.dev"
  })
 
  %% Erlang application
  {ok, Client} = macula_client:connect_local(#{
      realm =&gt; &amp;lt;&amp;lt;"my.app.realm"&amp;gt;&amp;gt;
  }).</pre>
 </p>
<p><b>Introduced in:</b> v0.8.9</p>

<h3 class="function"><a name="disconnect-1">disconnect/1</a></h3>
<div class="spec">
<p><code>disconnect(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>) -&gt; ok | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Disconnect from the Macula mesh.</p>
 
  Cleanly closes the HTTP/3 connection and cleans up all subscriptions.</p>

<h3 class="function"><a name="discover_subscribers-2">discover_subscribers/2</a></h3>
<div class="spec">
<p><code>discover_subscribers(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Topic::<a href="#type-topic" docgen-rel="seetype" docgen-href="#topic/0">topic()</a>) -&gt; {ok, [#{node_id := binary(), endpoint := binary()}]} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Discover subscribers to a topic via DHT query.</p>
 
  <p>Queries the DHT for all nodes subscribed to the given topic.  
Returns a list of subscriber nodes with their node IDs and endpoints.</p>
 
  This is used for P2P discovery before sending direct messages.</p>

<h3 class="function"><a name="get_node_id-1">get_node_id/1</a></h3>
<div class="spec">
<p><code>get_node_id(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>) -&gt; {ok, binary()} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Get the node ID of this client.</p>
 
  Returns the 32-byte node ID assigned to this client.</p>

<h3 class="function"><a name="publish-3">publish/3</a></h3>
<div class="spec">
<p><code>publish(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Topic::<a href="#type-topic" docgen-rel="seetype" docgen-href="#topic/0">topic()</a>, Data::<a href="#type-event_data" docgen-rel="seetype" docgen-href="#event_data/0">event_data()</a>) -&gt; ok | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Publish an event to a topic.</p>
 
  <p>Publishes data to the specified topic. All subscribers to this topic  
will receive the event.</p>
 
  <h3><a name="Topic_Design">Topic Design</a></h3>
 
  Topics should describe EVENT TYPES, not entity instances:
  <ul>
  <li>Good: <code>&amp;lt;&amp;lt;"my.app.user.registered"&amp;gt;&amp;gt;</code> (event type)</li>
  <li>Bad: <code>&amp;lt;&amp;lt;"my.app.user.123.registered"&amp;gt;&amp;gt;</code> (entity ID in topic)</li>
  </ul>
 
  <p>Entity IDs belong in the event payload, not the topic name.</p>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  %% Publish with default options
  ok = macula_client:publish(Client, &amp;lt;&amp;lt;"my.app.events"&amp;gt;&amp;gt;, #{
      type =&gt; &amp;lt;&amp;lt;"user.registered"&amp;gt;&amp;gt;,
      user_id =&gt; &amp;lt;&amp;lt;"user-123"&amp;gt;&amp;gt;,
      email =&gt; &amp;lt;&amp;lt;"user@example.com"&amp;gt;&amp;gt;
  }).
 
  %% Publish with options
  ok = macula_client:publish(Client, &amp;lt;&amp;lt;"my.app.events"&amp;gt;&amp;gt;, #{
      data =&gt; &amp;lt;&amp;lt;"important"&amp;gt;&amp;gt;
  }, #{acknowledge =&gt; true}).</pre></p>

<h3 class="function"><a name="publish-4">publish/4</a></h3>
<div class="spec">
<p><code>publish(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Topic::<a href="#type-topic" docgen-rel="seetype" docgen-href="#topic/0">topic()</a>, Data::<a href="#type-event_data" docgen-rel="seetype" docgen-href="#event_data/0">event_data()</a>, Opts::<a href="#type-options" docgen-rel="seetype" docgen-href="#options/0">options()</a>) -&gt; ok | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p>Publish an event with options.</p>

<h3 class="function"><a name="subscribe-3">subscribe/3</a></h3>
<div class="spec">
<p><code>subscribe(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Topic::<a href="#type-topic" docgen-rel="seetype" docgen-href="#topic/0">topic()</a>, Callback::fun((<a href="#type-event_data" docgen-rel="seetype" docgen-href="#event_data/0">event_data()</a>) -&gt; ok)) -&gt; {ok, <a href="#type-subscription_ref" docgen-rel="seetype" docgen-href="#subscription_ref/0">subscription_ref()</a>} | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Subscribe to a topic.</p>
 
  <p>Subscribes to events on the specified topic. The callback function  
will be invoked for each event received.</p>
 
  <h3><a name="Callback_Function">Callback Function</a></h3>
 
  <p>The callback receives the event data and should return <code>ok</code>.</p>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  %% Simple subscription
  {ok, SubRef} = macula_client:subscribe(Client, &amp;lt;&amp;lt;"my.app.events"&amp;gt;&amp;gt;,
      fun(EventData) -&gt;
          io:format("Event: ~p~n", [EventData]),
          ok
      end).
 
  %% Unsubscribe later
  ok = macula_client:unsubscribe(Client, SubRef).</pre></p>

<h3 class="function"><a name="unadvertise-2">unadvertise/2</a></h3>
<div class="spec">
<p><code>unadvertise(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, Procedure::<a href="#type-procedure" docgen-rel="seetype" docgen-href="#procedure/0">procedure()</a>) -&gt; ok | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Stop advertising a service.</p>
 
  <p>Removes the local handler and stops advertising to the DHT.</p>
 
  <h3><a name="Examples">Examples</a></h3>
 
  <pre>  ok = macula_client:unadvertise(Client, &amp;lt;&amp;lt;"my.app.get_user"&amp;gt;&amp;gt;).</pre></p>

<h3 class="function"><a name="unsubscribe-2">unsubscribe/2</a></h3>
<div class="spec">
<p><code>unsubscribe(Client::<a href="#type-client" docgen-rel="seetype" docgen-href="#client/0">client()</a>, SubRef::<a href="#type-subscription_ref" docgen-rel="seetype" docgen-href="#subscription_ref/0">subscription_ref()</a>) -&gt; ok | {error, Reason::term()}</code><br></p>
<p> </p>
</div><p><p>Unsubscribe from a topic.</p>
 
  Removes the subscription identified by the subscription reference.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
