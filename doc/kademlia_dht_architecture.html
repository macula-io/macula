<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.8.2">


    <title>Kademlia DHT — macula v0.8.2</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-21B89CD6.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="readme.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.8.2
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Kademlia DHT Architecture in Macula</h1>


      <a href="https://github.com/macula-io/macula/blob/0.8.2/docs/KADEMLIA_DHT_ARCHITECTURE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Macula uses a <strong>Kademlia Distributed Hash Table (DHT)</strong> for decentralized service discovery and peer-to-peer routing. This document describes how Kademlia principles are implemented in the HTTP/3 mesh network.</p><p><strong>Key Reference:</strong> <a href="http://www.scs.stanford.edu/~dm/home/papers/kpos.pdf">Kademlia: A Peer-to-peer Information System Based on the XOR Metric</a> (Maymounkov &amp; Mazières, 2002)</p><h2 id="why-kademlia" class="section-heading"><a href="#why-kademlia" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why Kademlia?</span></h2><p>Traditional DHTs (like Chord) use numeric distance metrics that don't align well with network topology. Kademlia's XOR-based metric provides:</p><ol><li><strong>Symmetric distance</strong> - <code class="inline">distance(A, B) = distance(B, A)</code></li><li><strong>Network-aware routing</strong> - Nodes sharing common prefixes tend to be routed through similar paths</li><li><strong>O(log N) lookup complexity</strong> - Efficient even with millions of nodes</li><li><strong>Self-organizing</strong> - No central coordination required</li><li><strong>NAT-friendly</strong> - Works well with HTTP/3's connection-oriented transport</li></ol><h2 id="core-concepts" class="section-heading"><a href="#core-concepts" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Core Concepts</span></h2><h3 id="1-node-ids-and-xor-metric" class="section-heading"><a href="#1-node-ids-and-xor-metric" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Node IDs and XOR Metric</span></h3><p>Every node in the Macula mesh has a 160-bit <strong>Node ID</strong> derived from:</p><ul><li>Gateway mode: Hash of (realm + IP + port)</li><li>Edge peer mode: Randomly generated on startup</li></ul><p><strong>XOR Distance Formula:</strong></p><pre><code class="makeup erlang" translate="no"><span class="nf">distance</span><span class="p" data-group-id="3263465630-1">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="3263465630-1">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">⊕</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p" data-group-id="3263465630-2">(</span><span class="ss">bitwise</span><span class="w"> </span><span class="n">XOR</span><span class="p" data-group-id="3263465630-2">)</span></code></pre><p><strong>Example:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="ss">b10110101</span><span class="w">
</span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="ss">b11010011</span><span class="w">
</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">-</span><span class="w">
</span><span class="n">XOR</span><span class="p">:</span><span class="w">    </span><span class="mi">0</span><span class="nf">b01100110</span><span class="w">  </span><span class="p" data-group-id="6147273463-1">(</span><span class="ss">distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">102</span><span class="w"> </span><span class="ss">decimal</span><span class="p" data-group-id="6147273463-1">)</span></code></pre><p>Nodes are considered &quot;closer&quot; when their XOR distance is smaller. This creates a geometric address space where routing naturally follows network topology.</p><h3 id="2-k-buckets-routing-table" class="section-heading"><a href="#2-k-buckets-routing-table" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. K-Buckets (Routing Table)</span></h3><p>Each node maintains a <strong>routing table</strong> of <code class="inline">160 k-buckets</code>, where <code class="inline">k = 20</code> (typical value).</p><p><strong>Structure:</strong></p><ul><li><strong>Bucket 0</strong>: Nodes at distance <code class="inline">2^0</code> to <code class="inline">2^1 - 1</code> (immediate neighbors)</li><li><strong>Bucket 1</strong>: Nodes at distance <code class="inline">2^1</code> to <code class="inline">2^2 - 1</code></li><li><strong>Bucket i</strong>: Nodes at distance <code class="inline">2^i</code> to <code class="inline">2^(i+1) - 1</code></li><li><strong>Bucket 159</strong>: Nodes at distance <code class="inline">2^159</code> to <code class="inline">2^160 - 1</code> (furthest)</li></ul><p><strong>K-Bucket Properties:</strong></p><ul><li>Maximum of <code class="inline">k</code> entries per bucket</li><li>Least-recently-seen nodes are evicted first (LRU)</li><li>Bucket 0 (closest nodes) is most important for routing</li></ul><p><strong>Macula Implementation:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% In macula_routing.erl (conceptual)</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="8490845920-1">(</span><span class="n">KADEMLIA_K</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p" data-group-id="8490845920-1">)</span><span class="p">.</span><span class="w">          </span><span class="c1">%% Bucket size</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="8490845920-2">(</span><span class="n">KADEMLIA_ALPHA</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="8490845920-2">)</span><span class="p">.</span><span class="w">       </span><span class="c1">%% Parallel lookup factor</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="8490845920-3">(</span><span class="n">ID_BITS</span><span class="p">,</span><span class="w"> </span><span class="mi">160</span><span class="p" data-group-id="8490845920-3">)</span><span class="p">.</span><span class="w">            </span><span class="c1">%% SHA-1 hash size</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="8490845920-4">(</span><span class="ss">k_bucket</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8490845920-5">{</span><span class="w">
    </span><span class="ss">distance_range</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8490845920-6">{</span><span class="nf">integer</span><span class="p" data-group-id="8490845920-7">(</span><span class="p" data-group-id="8490845920-7">)</span><span class="p">,</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="8490845920-8">(</span><span class="p" data-group-id="8490845920-8">)</span><span class="p" data-group-id="8490845920-6">}</span><span class="p">,</span><span class="w">
    </span><span class="nb">nodes</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8490845920-9">[</span><span class="nf">node_entry</span><span class="p" data-group-id="8490845920-10">(</span><span class="p" data-group-id="8490845920-10">)</span><span class="p" data-group-id="8490845920-9">]</span><span class="p">,</span><span class="w">       </span><span class="c1">%% Max 20 entries</span><span class="w">
    </span><span class="ss">last_updated</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">timestamp</span><span class="p" data-group-id="8490845920-11">(</span><span class="p" data-group-id="8490845920-11">)</span><span class="w">
</span><span class="p" data-group-id="8490845920-5">}</span><span class="p" data-group-id="8490845920-4">)</span><span class="p">.</span></code></pre><h3 id="3-dht-operations" class="section-heading"><a href="#3-dht-operations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. DHT Operations</span></h3><p>Kademlia defines four core RPC operations:</p><h4>PING</h4><p><strong>Purpose:</strong> Check if a node is alive</p><p><strong>Request:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="5593004134-1">{</span><span class="ss">ping</span><span class="p">,</span><span class="w"> </span><span class="n">FromNodeID</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="p" data-group-id="5593004134-1">}</span></code></pre><p><strong>Response:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="8261113544-1">{</span><span class="ss">pong</span><span class="p">,</span><span class="w"> </span><span class="n">ToNodeID</span><span class="p">,</span><span class="w"> </span><span class="n">Timestamp</span><span class="p" data-group-id="8261113544-1">}</span></code></pre><p><strong>Use Case:</strong> Health checking, routing table maintenance</p><hr class="thin"/><h4>STORE</h4><p><strong>Purpose:</strong> Store a key-value pair on a node</p><p><strong>Request:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="7749326025-1">{</span><span class="ss">store</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p">,</span><span class="w"> </span><span class="n">TTL</span><span class="p" data-group-id="7749326025-1">}</span></code></pre><p><strong>Response:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="1723806357-1">{</span><span class="ss">stored</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">ExpiresAt</span><span class="p" data-group-id="1723806357-1">}</span></code></pre><p><strong>Macula Mapping:</strong></p><ul><li><strong>Key</strong>: Service name hash (e.g., <code class="inline">sha1(&quot;game.matchmaking&quot;)</code>)</li><li><strong>Value</strong>: Service endpoint info (realm, node_id, capabilities)</li><li><strong>TTL</strong>: Advertisement lifetime (default: 5 minutes)</li></ul><hr class="thin"/><h4>FIND_NODE</h4><p><strong>Purpose:</strong> Locate k closest nodes to a target ID</p><p><strong>Request:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="6504253643-1">{</span><span class="ss">find_node</span><span class="p">,</span><span class="w"> </span><span class="n">TargetID</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="6504253643-1">}</span></code></pre><p><strong>Response:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2083885766-1">{</span><span class="nb">nodes</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2083885766-2">[</span><span class="w">
    </span><span class="p" data-group-id="2083885766-3">{</span><span class="n">NodeID1</span><span class="p">,</span><span class="w"> </span><span class="n">IP1</span><span class="p">,</span><span class="w"> </span><span class="n">Port1</span><span class="p">,</span><span class="w"> </span><span class="n">Realm1</span><span class="p" data-group-id="2083885766-3">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2083885766-4">{</span><span class="n">NodeID2</span><span class="p">,</span><span class="w"> </span><span class="n">IP2</span><span class="p">,</span><span class="w"> </span><span class="n">Port2</span><span class="p">,</span><span class="w"> </span><span class="n">Realm2</span><span class="p" data-group-id="2083885766-4">}</span><span class="p">,</span><span class="w">
    </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="p" data-group-id="2083885766-2">]</span><span class="p" data-group-id="2083885766-1">}</span><span class="w"> </span><span class="c1">%% Sorted by XOR distance to TargetID</span></code></pre><p><strong>Use Case:</strong> Populating routing table, iterative lookups</p><hr class="thin"/><h4>FIND_VALUE</h4><p><strong>Purpose:</strong> Retrieve value for a key (service discovery)</p><p><strong>Request:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="0396401757-1">{</span><span class="ss">find_value</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p" data-group-id="0396401757-1">}</span></code></pre><p><strong>Response (if found):</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2607345155-1">{</span><span class="ss">value</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceInfo</span><span class="p" data-group-id="2607345155-1">}</span></code></pre><p><strong>Response (if not found):</strong></p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="0585838701-1">{</span><span class="nb">nodes</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0585838701-2">[</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="0585838701-2">]</span><span class="p" data-group-id="0585838701-1">}</span><span class="w">  </span><span class="c1">%% Fallback to FIND_NODE</span></code></pre><p><strong>Macula Mapping:</strong></p><ul><li><strong>Key</strong>: Service name (e.g., <code class="inline">&quot;game.matchmaking&quot;</code>)</li><li><strong>ServiceInfo</strong>: List of providers advertising that service</li></ul><hr class="thin"/><h3 id="4-iterative-lookup-algorithm" class="section-heading"><a href="#4-iterative-lookup-algorithm" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Iterative Lookup Algorithm</span></h3><p>To find a service or node, Macula performs an <strong>iterative FIND_VALUE</strong> lookup:</p><p><strong>Algorithm:</strong></p><ol><li>Start with the <code class="inline">α = 3</code> closest nodes from local routing table</li><li>Send parallel <code class="inline">FIND_VALUE</code> requests to these nodes</li><li>If value found → return immediately</li><li>Otherwise, add returned nodes to candidate set</li><li>Select next <code class="inline">α</code> closest unqueried nodes</li><li>Repeat until:<ul><li>Value is found, OR</li><li>No closer nodes remain, OR</li><li>Maximum hops reached (log₂N)</li></ul></li></ol><p><strong>Convergence:</strong> Guaranteed to find value in O(log N) hops</p><p><strong>Macula Implementation (conceptual):</strong></p><pre><code class="makeup erlang" translate="no"><span class="nf">find_service</span><span class="p" data-group-id="5623008025-1">(</span><span class="n">ServiceName</span><span class="p">,</span><span class="w"> </span><span class="n">Realm</span><span class="p" data-group-id="5623008025-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="5623008025-2">(</span><span class="ss">sha</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceName</span><span class="p" data-group-id="5623008025-2">)</span><span class="p">,</span><span class="w">
    </span><span class="n">ClosestNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_closest_nodes</span><span class="p" data-group-id="5623008025-3">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">KADEMLIA_ALPHA</span><span class="p" data-group-id="5623008025-3">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">iterative_lookup</span><span class="p" data-group-id="5623008025-4">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">ClosestNodes</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5623008025-5">#{</span><span class="p" data-group-id="5623008025-5">}</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5623008025-4">)</span><span class="p">.</span><span class="w">

</span><span class="nf">iterative_lookup</span><span class="p" data-group-id="5623008025-6">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5623008025-7">[</span><span class="p" data-group-id="5623008025-7">]</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Hops</span><span class="p" data-group-id="5623008025-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5623008025-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_found</span><span class="p" data-group-id="5623008025-8">}</span><span class="p">;</span><span class="w">
</span><span class="nf">iterative_lookup</span><span class="p" data-group-id="5623008025-9">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">Candidates</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="n">Hops</span><span class="p" data-group-id="5623008025-9">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">Hops</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5623008025-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">max_hops_exceeded</span><span class="p" data-group-id="5623008025-10">}</span><span class="p">;</span><span class="w">
</span><span class="nf">iterative_lookup</span><span class="p" data-group-id="5623008025-11">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">Candidates</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="n">Hops</span><span class="p" data-group-id="5623008025-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Query α closest unqueried nodes in parallel</span><span class="w">
    </span><span class="n">Results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">query_nodes</span><span class="p" data-group-id="5623008025-12">(</span><span class="n">Candidates</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5623008025-13">{</span><span class="ss">find_value</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p" data-group-id="5623008025-13">}</span><span class="p" data-group-id="5623008025-12">)</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nf">find_value_in_results</span><span class="p" data-group-id="5623008025-14">(</span><span class="n">Results</span><span class="p" data-group-id="5623008025-14">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="5623008025-15">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="5623008025-15">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5623008025-16">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Value</span><span class="p" data-group-id="5623008025-16">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">not_found</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">NewNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">extract_nodes</span><span class="p" data-group-id="5623008025-17">(</span><span class="n">Results</span><span class="p" data-group-id="5623008025-17">)</span><span class="p">,</span><span class="w">
            </span><span class="n">NextCandidates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_closest_unqueried</span><span class="p" data-group-id="5623008025-18">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">NewNodes</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p" data-group-id="5623008025-18">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">iterative_lookup</span><span class="p" data-group-id="5623008025-19">(</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">NextCandidates</span><span class="p">,</span><span class="w">
                           </span><span class="nc">maps</span><span class="p">:</span><span class="nf">merge</span><span class="p" data-group-id="5623008025-20">(</span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="nf">mark_queried</span><span class="p" data-group-id="5623008025-21">(</span><span class="n">Candidates</span><span class="p" data-group-id="5623008025-21">)</span><span class="p" data-group-id="5623008025-20">)</span><span class="p">,</span><span class="w">
                           </span><span class="n">Hops</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="5623008025-19">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="macula-specific-adaptations" class="section-heading"><a href="#macula-specific-adaptations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Macula-Specific Adaptations</span></h2><h3 id="1-realm-scoped-dht" class="section-heading"><a href="#1-realm-scoped-dht" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Realm-Scoped DHT</span></h3><p>Unlike traditional Kademlia, Macula implements <strong>multi-tenancy via realms</strong>:</p><ul><li>Each realm has its own isolated DHT keyspace</li><li>Node IDs include realm hash: <code class="inline">sha1(Realm || IP || Port)</code></li><li>Service keys are realm-scoped: <code class="inline">sha1(Realm || ServiceName)</code></li><li>Cross-realm queries are blocked at protocol level</li></ul><p><strong>Example:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Realm &quot;macula.arcade&quot;</span><span class="w">
</span><span class="n">NodeID_A</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sha1</span><span class="p" data-group-id="6926158431-1">(</span><span class="s">&quot;macula.arcade&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;192.168.1.10&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;4433&quot;</span><span class="p" data-group-id="6926158431-1">)</span><span class="w">

</span><span class="c1">%% Realm &quot;macula.energy&quot;</span><span class="w">
</span><span class="n">NodeID_B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sha1</span><span class="p" data-group-id="6926158431-2">(</span><span class="s">&quot;macula.energy&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;192.168.1.10&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;4433&quot;</span><span class="p" data-group-id="6926158431-2">)</span><span class="w">

</span><span class="c1">%% Same IP/port, different realms → different DHT partitions</span></code></pre><h3 id="2-gateway-bootstrap-nodes" class="section-heading"><a href="#2-gateway-bootstrap-nodes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Gateway Bootstrap Nodes</span></h3><p>Traditional Kademlia requires <strong>bootstrap nodes</strong> to join the network. Macula handles this differently:</p><p><strong>Gateway Mode:</strong></p><ul><li>Gateways act as well-known bootstrap nodes</li><li>Published at predictable URLs (e.g., <code class="inline">https://gateway.example.com:4433</code>)</li><li>Maintain authoritative registry for their realm</li></ul><p><strong>Edge Peer Mode:</strong></p><ul><li>Peers connect to gateway via <code class="inline">MACULA_BOOTSTRAP_REGISTRY</code> env var</li><li>Gateway returns <code class="inline">α</code> closest nodes to peer's ID</li><li>Peer populates routing table via <code class="inline">FIND_NODE</code> requests</li></ul><p><strong>No Hardcoded Bootstrap IPs:</strong> Unlike BitTorrent DHT, Macula uses DNS/HTTPS URLs for gateway discovery, making it firewall-friendly.</p><h3 id="3-service-advertisement-ttl" class="section-heading"><a href="#3-service-advertisement-ttl" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Service Advertisement TTL</span></h3><p>Services are stored in the DHT with a <strong>Time-To-Live (TTL)</strong>:</p><ul><li>Default TTL: <strong>5 minutes</strong></li><li>Providers re-advertise every <strong>60 seconds</strong> (heartbeat)</li><li>Expired entries are removed by <code class="inline">macula_advertisement_manager</code></li></ul><p><strong>Rationale:</strong> Short TTL ensures stale services don't linger after node crashes, while frequent heartbeats maintain availability.</p><h3 id="4-http-3-transport-integration" class="section-heading"><a href="#4-http-3-transport-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. HTTP/3 Transport Integration</span></h3><p>Traditional Kademlia uses UDP for RPCs. Macula uses <strong>QUIC (HTTP/3)</strong>:</p><p><strong>Advantages:</strong></p><ul><li>Reliable transport (no packet loss issues)</li><li>Connection multiplexing (multiple RPCs over one connection)</li><li>TLS 1.3 encryption (secure by default)</li><li>NAT traversal (QUIC connection migration)</li></ul><p><strong>Message Encoding:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% DHT query wrapped in Macula protocol</span><span class="w">
</span><span class="p" data-group-id="0938785035-1">#{</span><span class="w">
  </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">dht_query</span><span class="p">,</span><span class="w">
  </span><span class="ss">operation</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">find_value</span><span class="p">,</span><span class="w">
  </span><span class="ss">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0938785035-2">&lt;&lt;</span><span class="n">ServiceNameHash</span><span class="p">:</span><span class="mi">160</span><span class="p" data-group-id="0938785035-2">&gt;&gt;</span><span class="p">,</span><span class="w">
  </span><span class="ss">realm</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0938785035-3">&lt;&lt;</span><span class="s">&quot;macula.arcade&quot;</span><span class="p" data-group-id="0938785035-3">&gt;&gt;</span><span class="p">,</span><span class="w">
  </span><span class="ss">from_node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0938785035-4">&lt;&lt;</span><span class="n">SenderNodeID</span><span class="p">:</span><span class="mi">160</span><span class="p" data-group-id="0938785035-4">&gt;&gt;</span><span class="p">,</span><span class="w">
  </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="0938785035-5">(</span><span class="ss">millisecond</span><span class="p" data-group-id="0938785035-5">)</span><span class="w">
</span><span class="p" data-group-id="0938785035-1">}</span></code></pre><hr class="thin"/><h2 id="routing-table-maintenance" class="section-heading"><a href="#routing-table-maintenance" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Routing Table Maintenance</span></h2><p>Macula keeps routing tables fresh through <strong>active probing</strong>:</p><h3 id="1-passive-updates" class="section-heading"><a href="#1-passive-updates" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Passive Updates</span></h3><ul><li>When receiving any message from node N, refresh N's entry in k-bucket</li><li>Update last-seen timestamp</li><li>Move N to tail of LRU list (most recently seen)</li></ul><h3 id="2-active-probing" class="section-heading"><a href="#2-active-probing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Active Probing</span></h3><ul><li>Every <strong>60 seconds</strong>, ping least-recently-seen node in each non-empty bucket</li><li>If ping fails 3 times consecutively, evict node</li><li>Backfill bucket via <code class="inline">FIND_NODE</code> request</li></ul><h3 id="3-bucket-splitting" class="section-heading"><a href="#3-bucket-splitting" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Bucket Splitting</span></h3><ul><li>When bucket 0 (closest nodes) exceeds <code class="inline">k</code> entries, split into two buckets</li><li>Move nodes to new buckets based on refined distance ranges</li><li>Only split buckets containing own node ID (hot zone)</li></ul><p><strong>Implementation:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% In macula_routing.erl</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2302673954-1">(</span><span class="n">REFRESH_INTERVAL</span><span class="p">,</span><span class="w"> </span><span class="mi">60000</span><span class="p" data-group-id="2302673954-1">)</span><span class="p">.</span><span class="w">  </span><span class="c1">%% 60 seconds</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2302673954-2">(</span><span class="n">PING_TIMEOUT</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="2302673954-2">)</span><span class="p">.</span><span class="w">       </span><span class="c1">%% 5 seconds</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2302673954-3">(</span><span class="n">MAX_FAILURES</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="2302673954-3">)</span><span class="p">.</span><span class="w">

</span><span class="nf">refresh_buckets</span><span class="p" data-group-id="2302673954-4">(</span><span class="n">State</span><span class="p" data-group-id="2302673954-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p" data-group-id="2302673954-5">(</span><span class="k">fun</span><span class="w"> </span><span class="ss">refresh_bucket</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">k_buckets</span><span class="p" data-group-id="2302673954-5">)</span><span class="p">.</span><span class="w">

</span><span class="nf">refresh_bucket</span><span class="p" data-group-id="2302673954-6">(</span><span class="n">Bucket</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="2302673954-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">get_least_recent_node</span><span class="p" data-group-id="2302673954-7">(</span><span class="n">Bucket</span><span class="p" data-group-id="2302673954-7">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">undefined</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">State</span><span class="p">;</span><span class="w">  </span><span class="c1">%% Empty bucket</span><span class="w">
        </span><span class="n">Node</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nf">ping_node</span><span class="p" data-group-id="2302673954-8">(</span><span class="n">Node</span><span class="p" data-group-id="2302673954-8">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">pong</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">update_node_timestamp</span><span class="p" data-group-id="2302673954-9">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="2302673954-9">)</span><span class="p">;</span><span class="w">
                </span><span class="ss">timeout</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_ping_failure</span><span class="p" data-group-id="2302673954-10">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="2302673954-10">)</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="performance-characteristics" class="section-heading"><a href="#performance-characteristics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Characteristics</span></h2><table><thead><tr><th style="text-align: left;">Metric</th><th style="text-align: left;">Value</th><th style="text-align: left;">Notes</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Lookup Time</strong></td><td style="text-align: left;">O(log N) hops</td><td style="text-align: left;">N = total nodes in mesh</td></tr><tr><td style="text-align: left;"><strong>Routing Table Size</strong></td><td style="text-align: left;">O(log N) entries</td><td style="text-align: left;">~160 buckets × 20 nodes = 3,200 max</td></tr><tr><td style="text-align: left;"><strong>Network Traffic</strong></td><td style="text-align: left;">O(log N) messages/lookup</td><td style="text-align: left;">α parallel requests per hop</td></tr><tr><td style="text-align: left;"><strong>Storage</strong></td><td style="text-align: left;">O(k × log N)</td><td style="text-align: left;">Per node, for advertised services</td></tr><tr><td style="text-align: left;"><strong>Convergence</strong></td><td style="text-align: left;">&lt; 1 second</td><td style="text-align: left;">Typical for 10,000-node network</td></tr></tbody></table><p><strong>Example (10,000-node network):</strong></p><ul><li>Expected hops: <code class="inline">log₂(10,000) ≈ 13.3</code> → 14 hops max</li><li>Parallel factor α = 3 → ~5 rounds of queries</li><li>Average lookup time: <code class="inline">5 rounds × 100ms RTT = 500ms</code></li></ul><hr class="thin"/><h2 id="comparison-to-other-dhts" class="section-heading"><a href="#comparison-to-other-dhts" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Comparison to Other DHTs</span></h2><table><thead><tr><th style="text-align: left;">Feature</th><th style="text-align: left;">Kademlia (Macula)</th><th style="text-align: left;">Chord</th><th style="text-align: left;">Pastry</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Distance Metric</strong></td><td style="text-align: left;">XOR (symmetric)</td><td style="text-align: left;">Modular arithmetic</td><td style="text-align: left;">Numeric proximity</td></tr><tr><td style="text-align: left;"><strong>Routing Complexity</strong></td><td style="text-align: left;">O(log N)</td><td style="text-align: left;">O(log N)</td><td style="text-align: left;">O(log N)</td></tr><tr><td style="text-align: left;"><strong>Lookup Parallelism</strong></td><td style="text-align: left;">Yes (α = 3)</td><td style="text-align: left;">No (sequential)</td><td style="text-align: left;">Limited</td></tr><tr><td style="text-align: left;"><strong>NAT-Friendly</strong></td><td style="text-align: left;">✅ (with HTTP/3)</td><td style="text-align: left;">❌</td><td style="text-align: left;">❌</td></tr><tr><td style="text-align: left;"><strong>Bootstrap Required</strong></td><td style="text-align: left;">Optional (gateway)</td><td style="text-align: left;">Yes</td><td style="text-align: left;">Yes</td></tr><tr><td style="text-align: left;"><strong>Self-Organizing</strong></td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td></tr></tbody></table><hr class="thin"/><h2 id="future-enhancements" class="section-heading"><a href="#future-enhancements" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Future Enhancements</span></h2><h3 id="1-s-kademlia-secure-kademlia" class="section-heading"><a href="#1-s-kademlia-secure-kademlia" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. S/Kademlia (Secure Kademlia)</span></h3><ul><li>Cryptographic node ID generation (prevent Sybil attacks)</li><li>Require nodes to solve proof-of-work for ID assignment</li><li>Disjoint routing paths for redundancy</li></ul><h3 id="2-dht-persistence" class="section-heading"><a href="#2-dht-persistence" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. DHT Persistence</span></h3><ul><li>Store service advertisements in distributed database (e.g., CRDT)</li><li>Survive network partitions with eventual consistency</li><li>Reduce re-advertisement overhead</li></ul><h3 id="3-adaptive-k-bucket-sizing" class="section-heading"><a href="#3-adaptive-k-bucket-sizing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Adaptive K-Bucket Sizing</span></h3><ul><li>Dynamically adjust <code class="inline">k</code> based on network churn rate</li><li>Larger <code class="inline">k</code> for stable networks (less probing overhead)</li><li>Smaller <code class="inline">k</code> for high-churn networks (faster convergence)</li></ul><hr class="thin"/><h2 id="references" class="section-heading"><a href="#references" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">References</span></h2><ol><li><strong>Kademlia Paper:</strong> <a href="http://www.scs.stanford.edu/~dm/home/papers/kpos.pdf">Maymounkov &amp; Mazières (2002)</a></li><li><strong>S/Kademlia:</strong> <a href="https://ieeexplore.ieee.org/document/4447808">Baumgart &amp; Mies (2007)</a></li><li><strong>BitTorrent DHT (BEP-0005):</strong> <a href="http://www.bittorrent.org/beps/bep_0005.html">bittorrent.org/beps/bep_0005.html</a></li><li><strong>QUIC Protocol:</strong> <a href="https://www.rfc-editor.org/rfc/rfc9000.html">RFC 9000</a></li><li><strong>Macula Architecture:</strong> <code class="inline">docs/QUIC_TLS_GATEWAY_SETUP.md</code></li></ol><hr class="thin"/><p><strong>Last Updated:</strong> 2025-11-15
<strong>Macula Version:</strong> 0.6.0
<strong>Status:</strong> ✅ Production-ready DHT implementation</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="readme-2.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Documentation Index
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="development.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Development Guide
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.8.2" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.8.2">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.8.2/show/docs/KADEMLIA_DHT_ARCHITECTURE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
