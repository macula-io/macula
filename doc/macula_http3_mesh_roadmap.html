<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.7.7">


    <title>Roadmap — macula v0.7.7</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-62100C5B.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="hello_world.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="hello_world.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.7.7
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula HTTP/3 Mesh: Comprehensive Technical Roadmap</h1>


      <a href="https://github.com/macula-io/macula/blob/0.7.7/architecture/macula_http3_mesh_roadmap.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<h2 id="executive-summary" class="section-heading"><a href="#executive-summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Executive Summary</span></h2><p><strong>Vision:</strong> Macula enables distributed BEAM applications to form encrypted, self-healing mesh networks over HTTP/3, with zero infrastructure dependencies. Works behind NATs, scales to thousands of nodes, native distributed Erlang semantics - all over standard HTTPS.</p><p><strong>The &quot;Wow&quot; Factor:</strong></p><ul><li>Distributed Erlang over HTTP/3 (nobody else does this!)</li><li>Works through corporate firewalls (it's just HTTPS!)</li><li>Self-healing mesh topology (no central coordinator)</li><li>Built-in NAT traversal (QUIC magic)</li><li>Native BEAM implementation (minimal NIFs)</li></ul><p><strong>Timeline:</strong> 20 weeks (5 months)</p><p><strong>Outcome:</strong> Production-ready mesh networking infrastructure for edge BEAM applications.</p><hr class="thin"/><h2 id="table-of-contents" class="section-heading"><a href="#table-of-contents" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Table of Contents</span></h2><ol><li><a href="#understanding-quic-and-http3">Understanding QUIC and HTTP/3</a></li><li><a href="#quic-http3-libraries-for-beam">QUIC/HTTP/3 Libraries for BEAM</a></li><li><a href="#architecture-overview">Architecture Overview</a></li><li><a href="#detailed-roadmap">Detailed Roadmap</a></li><li><a href="#architecture-diagrams">Architecture Diagrams</a></li><li><a href="#technical-deep-dives">Technical Deep Dives</a></li><li><a href="#success-metrics">Success Metrics</a></li></ol><hr class="thin"/><h2 id="understanding-quic-and-http-3" class="section-heading"><a href="#understanding-quic-and-http-3" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Understanding QUIC and HTTP/3</span></h2><h3 id="what-is-quic" class="section-heading"><a href="#what-is-quic" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What is QUIC?</span></h3><p><strong>QUIC (Quick UDP Internet Connections)</strong> is a modern transport protocol developed by Google and standardized by IETF as RFC 9000. It's designed to replace TCP for web traffic.</p><h4>Key Characteristics</h4><p><strong>1. UDP-Based Transport</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Traditional</span><span class="p">:</span><span class="w">  </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">TCP</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">IP</span><span class="w">
</span><span class="n">Modern</span><span class="p">:</span><span class="w">       </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="p" data-group-id="0461648868-1">(</span><span class="ss">includes</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="p" data-group-id="0461648868-1">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">UDP</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">IP</span></code></pre><p>QUIC runs over UDP instead of TCP, which provides several advantages:</p><ul><li>Faster connection establishment (0-RTT and 1-RTT)</li><li>No head-of-line blocking across streams</li><li>Better performance on lossy networks</li><li>Easier NAT traversal (UDP is simpler than TCP for NAT)</li></ul><p><strong>2. Built-in Encryption</strong></p><ul><li>TLS 1.3 is integrated into QUIC (not layered on top)</li><li>All packets are encrypted (except initial handshake metadata)</li><li>Forward secrecy by default</li><li>Connection migration (can change IP addresses mid-connection)</li></ul><p><strong>3. Multiplexed Streams</strong></p><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Connection</span><span class="w">                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w"> </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">0</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1278395638-1">(</span><span class="n">Ordered</span><span class="p" data-group-id="1278395638-1">)</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1278395638-2">(</span><span class="n">Ordered</span><span class="p" data-group-id="1278395638-2">)</span><span class="w"> </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w"> </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Streams</span><span class="w"> </span><span class="ss">are</span><span class="w"> </span><span class="ss">independent</span><span class="o">!</span><span class="w">           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Loss</span><span class="w"> </span><span class="ss">in</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="ss">doesn</span><span class="err">&#39;</span><span class="ss">t</span><span class="w"> </span><span class="ss">block</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p" data-group-id="1278395638-3">(</span><span class="ss">unlike</span><span class="w"> </span><span class="n">TCP</span><span class="p" data-group-id="1278395638-3">)</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><p><strong>4. Connection Establishment</strong></p><p>Traditional TCP + TLS:</p><pre><code class="makeup erlang" translate="no"><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">SYN</span><span class="w">                        </span><span class="p" data-group-id="7242076954-1">(</span><span class="mi">1</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="7242076954-1">)</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w">  </span><span class="n">SYN</span><span class="o">-</span><span class="n">ACK</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">ACK</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">ClientHello</span><span class="w"> </span><span class="p" data-group-id="7242076954-2">(</span><span class="n">TLS</span><span class="p" data-group-id="7242076954-2">)</span><span class="w">          </span><span class="p" data-group-id="7242076954-3">(</span><span class="mi">2</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="7242076954-3">)</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w">  </span><span class="n">ServerHello</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Certificate</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">Finished</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w">  </span><span class="n">Finished</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">HTTP</span><span class="w"> </span><span class="n">Request</span><span class="w">               </span><span class="p" data-group-id="7242076954-4">(</span><span class="mi">3</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="7242076954-4">)</span><span class="w">
                  </span><span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">Round</span><span class="w"> </span><span class="n">Trips</span></code></pre><p>QUIC (first connection):</p><pre><code class="makeup erlang" translate="no"><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">Initial</span><span class="w"> </span><span class="p" data-group-id="7734984786-1">(</span><span class="n">ClientHello</span><span class="p" data-group-id="7734984786-1">)</span><span class="w">      </span><span class="p" data-group-id="7734984786-2">(</span><span class="mi">1</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="7734984786-2">)</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w">  </span><span class="n">Handshake</span><span class="w"> </span><span class="p" data-group-id="7734984786-3">(</span><span class="n">ServerHello</span><span class="p" data-group-id="7734984786-3">)</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="n">HTTP</span><span class="w"> </span><span class="n">Request</span><span class="w">               </span><span class="p" data-group-id="7734984786-4">(</span><span class="mi">1</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="7734984786-4">)</span><span class="w">
                  </span><span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">Round</span><span class="w"> </span><span class="n">Trip</span></code></pre><p>QUIC (resumed connection):</p><pre><code class="makeup erlang" translate="no"><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w">  </span><span class="mi">0</span><span class="o">-</span><span class="n">RTT</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">Request</span><span class="w">  </span><span class="p" data-group-id="3738510039-1">(</span><span class="mi">0</span><span class="w"> </span><span class="n">RTT</span><span class="o">!</span><span class="p" data-group-id="3738510039-1">)</span><span class="w">
                  </span><span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">Round</span><span class="w"> </span><span class="n">Trips</span></code></pre><p><strong>5. Loss Recovery</strong></p><ul><li>Per-stream reliability (not per-connection like TCP)</li><li>More sophisticated than TCP (monotonically increasing packet numbers)</li><li>Better handling of spurious retransmissions</li><li>Pluggable congestion control</li></ul><p><strong>6. Connection Migration</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Mobile</span><span class="w"> </span><span class="ss">device</span><span class="w"> </span><span class="nc">scenario</span><span class="p">:</span><span class="w">
</span><span class="n">WiFi</span><span class="w"> </span><span class="p" data-group-id="5282408963-1">(</span><span class="n">IP</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.100</span><span class="p" data-group-id="5282408963-1">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Cellular</span><span class="w"> </span><span class="p" data-group-id="5282408963-2">(</span><span class="n">IP</span><span class="p">:</span><span class="w"> </span><span class="mf">10.20</span><span class="p">.</span><span class="mf">30.40</span><span class="p" data-group-id="5282408963-2">)</span><span class="w">

</span><span class="n">TCP</span><span class="p">:</span><span class="w">  </span><span class="n">Connection</span><span class="w"> </span><span class="ss">breaks</span><span class="p">,</span><span class="w"> </span><span class="ss">must</span><span class="w"> </span><span class="nf">reconnect</span><span class="w"> </span><span class="p" data-group-id="5282408963-3">(</span><span class="ss">new</span><span class="w"> </span><span class="ss">handshake</span><span class="p" data-group-id="5282408963-3">)</span><span class="w">
</span><span class="n">QUIC</span><span class="p">:</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="ss">continues</span><span class="w"> </span><span class="nf">seamlessly</span><span class="w"> </span><span class="p" data-group-id="5282408963-4">(</span><span class="ss">connection</span><span class="w"> </span><span class="n">ID</span><span class="w"> </span><span class="ss">stays</span><span class="w"> </span><span class="ss">same</span><span class="p" data-group-id="5282408963-4">)</span></code></pre><h3 id="what-is-http-3" class="section-heading"><a href="#what-is-http-3" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What is HTTP/3?</span></h3><p><strong>HTTP/3</strong> is the third major version of HTTP, using QUIC as its transport instead of TCP.</p><h4>HTTP Evolution</h4><pre><code class="makeup erlang" translate="no"><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="p" data-group-id="5426583289-1">(</span><span class="mi">1997</span><span class="p" data-group-id="5426583289-1">)</span><span class="w">
  </span><span class="err">↓</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Text</span><span class="o">-</span><span class="ss">based</span><span class="w"> </span><span class="ss">protocol</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">One</span><span class="w"> </span><span class="ss">request</span><span class="w"> </span><span class="ss">per</span><span class="w"> </span><span class="nf">connection</span><span class="w"> </span><span class="p" data-group-id="5426583289-2">(</span><span class="ow">or</span><span class="w"> </span><span class="ss">pipelining</span><span class="p" data-group-id="5426583289-2">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Head</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="ss">line</span><span class="w"> </span><span class="ss">blocking</span><span class="w">

</span><span class="n">HTTP</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p" data-group-id="5426583289-3">(</span><span class="mi">2015</span><span class="p" data-group-id="5426583289-3">)</span><span class="w">
  </span><span class="err">↓</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Binary</span><span class="w"> </span><span class="ss">framing</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Multiplexing</span><span class="w"> </span><span class="ss">over</span><span class="w"> </span><span class="ss">single</span><span class="w"> </span><span class="n">TCP</span><span class="w"> </span><span class="ss">connection</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Header</span><span class="w"> </span><span class="nf">compression</span><span class="w"> </span><span class="p" data-group-id="5426583289-4">(</span><span class="n">HPACK</span><span class="p" data-group-id="5426583289-4">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Still</span><span class="w"> </span><span class="ss">suffers</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="n">TCP</span><span class="w"> </span><span class="ss">head</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="ss">line</span><span class="w"> </span><span class="ss">blocking</span><span class="w">

</span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p" data-group-id="5426583289-5">(</span><span class="mi">2022</span><span class="p" data-group-id="5426583289-5">)</span><span class="w">
  </span><span class="err">↓</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Same</span><span class="w"> </span><span class="ss">semantics</span><span class="w"> </span><span class="ss">as</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">2</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="nf">transport</span><span class="w"> </span><span class="p" data-group-id="5426583289-6">(</span><span class="n">UDP</span><span class="o">-</span><span class="ss">based</span><span class="p" data-group-id="5426583289-6">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="ss">head</span><span class="o">-</span><span class="k">of</span><span class="o">-</span><span class="ss">line</span><span class="w"> </span><span class="ss">blocking</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">RTT</span><span class="w"> </span><span class="ss">connection</span><span class="w"> </span><span class="ss">resumption</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Better</span><span class="w"> </span><span class="ss">mobile</span><span class="w"> </span><span class="ss">performance</span></code></pre><h4>HTTP/3 Frame Types</h4><p>HTTP/3 uses similar frames to HTTP/2 but adapted for QUIC:</p><pre><code class="makeup erlang" translate="no"><span class="n">Frame</span><span class="w"> </span><span class="n">Types</span><span class="p">:</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">DATA</span><span class="p">:</span><span class="w">        </span><span class="n">Application</span><span class="w"> </span><span class="nf">data</span><span class="w"> </span><span class="p" data-group-id="0938496890-1">(</span><span class="ss">response</span><span class="w"> </span><span class="ss">body</span><span class="p" data-group-id="0938496890-1">)</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">HEADERS</span><span class="p">:</span><span class="w">     </span><span class="n">HTTP</span><span class="w"> </span><span class="nf">headers</span><span class="w"> </span><span class="p" data-group-id="0938496890-2">(</span><span class="ss">compressed</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="n">QPACK</span><span class="p" data-group-id="0938496890-2">)</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">PRIORITY</span><span class="p">:</span><span class="w">    </span><span class="n">Stream</span><span class="w"> </span><span class="ss">priority</span><span class="w"> </span><span class="ss">hints</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">CANCEL_PUSH</span><span class="p">:</span><span class="w"> </span><span class="n">Cancel</span><span class="w"> </span><span class="ss">server</span><span class="w"> </span><span class="ss">push</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">SETTINGS</span><span class="p">:</span><span class="w">    </span><span class="n">Connection</span><span class="w"> </span><span class="ss">parameters</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">PUSH_PROMISE</span><span class="p">:</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="ss">push</span><span class="w"> </span><span class="ss">announcement</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">GOAWAY</span><span class="p">:</span><span class="w">      </span><span class="n">Graceful</span><span class="w"> </span><span class="ss">shutdown</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">MAX_PUSH_ID</span><span class="p">:</span><span class="w"> </span><span class="n">Limit</span><span class="w"> </span><span class="ss">server</span><span class="w"> </span><span class="ss">push</span></code></pre><h4>QPACK Header Compression</h4><p>HTTP/3 uses QPACK (QUIC-aware header compression) instead of HPACK:</p><ul><li>Dynamic table updates on dedicated stream</li><li>Prevents head-of-line blocking from header compression</li><li>Better performance on lossy networks</li></ul><h3 id="why-quic-http-3-for-macula-mesh" class="section-heading"><a href="#why-quic-http-3-for-macula-mesh" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why QUIC/HTTP/3 for Macula Mesh?</span></h3><h4>1. <strong>NAT Traversal</strong></h4><p>UDP is much easier to punch through NATs than TCP:</p><ul><li>Simpler state machines in NAT devices</li><li>Easier simultaneous open</li><li>Better compatibility with STUN/TURN</li></ul><h4>2. <strong>Multiplexing Without Head-of-Line Blocking</strong></h4><p>Perfect for distributed Erlang:</p><pre><code class="makeup erlang" translate="no"><span class="n">Process</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w">  </span><span class="nf">send</span><span class="p" data-group-id="8297622513-1">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="8297622513-1">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="p" data-group-id="8297622513-2">[</span><span class="ss">packet</span><span class="w"> </span><span class="ss">lost</span><span class="o">!</span><span class="p" data-group-id="8297622513-2">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">retransmit</span><span class="w">
</span><span class="n">Process</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">  </span><span class="nf">send</span><span class="p" data-group-id="8297622513-3">(</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="8297622513-3">)</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">delivered</span><span class="w"> </span><span class="ss">immediately</span><span class="o">!</span><span class="w">

</span><span class="n">With</span><span class="w"> </span><span class="n">TCP</span><span class="p">:</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="ss">would</span><span class="w"> </span><span class="ss">be</span><span class="w"> </span><span class="ss">blocked</span><span class="w"> </span><span class="ss">waiting</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="n">A</span><span class="ss">&#39;s retransmit
With QUIC: Process B&#39;</span><span class="ss">s</span><span class="w"> </span><span class="ss">stream</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">independent</span></code></pre><h4>3. <strong>Connection Migration</strong></h4><p>Edge devices often change networks:</p><pre><code class="makeup erlang" translate="no"><span class="n">IoT</span><span class="w"> </span><span class="ss">device</span><span class="w"> </span><span class="ss">switches</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="n">WiFi</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="nc">cellular</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">TCP</span><span class="p">:</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="ss">lost</span><span class="p">,</span><span class="w"> </span><span class="ss">full</span><span class="w"> </span><span class="ss">reconnect</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">QUIC</span><span class="p">:</span><span class="w"> </span><span class="n">Seamless</span><span class="w"> </span><span class="ss">migration</span><span class="p">,</span><span class="w"> </span><span class="ss">no</span><span class="w"> </span><span class="ss">interruption</span></code></pre><h4>4. <strong>Firewall Friendly</strong></h4><ul><li>Uses port 443 (standard HTTPS)</li><li>Looks like HTTPS to middleboxes</li><li>No special firewall rules needed</li></ul><h4>5. <strong>0-RTT Resumption</strong></h4><p>Reconnecting nodes don't waste time:</p><pre><code class="makeup erlang" translate="no"><span class="n">Node</span><span class="w"> </span><span class="ss">rejoins</span><span class="w"> </span><span class="ss">mesh</span><span class="w"> </span><span class="k">after</span><span class="w"> </span><span class="ss">brief</span><span class="w"> </span><span class="nc">disconnect</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">TCP</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">TLS</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">RTT</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">re</span><span class="o">-</span><span class="ss">establish</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">RTT</span><span class="p">:</span><span class="w"> </span><span class="n">Immediate</span><span class="w"> </span><span class="ss">data</span><span class="w"> </span><span class="ss">transmission</span></code></pre><h4>6. <strong>Built-in Encryption</strong></h4><ul><li>TLS 1.3 integrated (not optional)</li><li>Perfect forward secrecy</li><li>No configuration needed</li></ul><h3 id="quic-protocol-details" class="section-heading"><a href="#quic-protocol-details" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">QUIC Protocol Details</span></h3><h4>Connection ID</h4><p>QUIC uses Connection IDs instead of 4-tuple (src IP, src port, dst IP, dst port):</p><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Packet</span><span class="w">                         </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Header</span><span class="p">:</span><span class="w">                             </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="ss">x1a2b3c4d</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="err">←</span><span class="w"> </span><span class="n">Identifies</span><span class="w"> </span><span class="ss">connection</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Packet</span><span class="w"> </span><span class="n">Number</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="w">                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Flags</span><span class="p">:</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Encrypted</span><span class="w"> </span><span class="n">Payload</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">

</span><span class="n">Benefits</span><span class="p">:</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="ss">survives</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="ss">address</span><span class="w"> </span><span class="ss">changes</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">Load</span><span class="w"> </span><span class="ss">balancers</span><span class="w"> </span><span class="ss">can</span><span class="w"> </span><span class="ss">route</span><span class="w"> </span><span class="ss">without</span><span class="w"> </span><span class="ss">decryption</span><span class="w">
</span><span class="o">-</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="ss">rebinding</span><span class="w"> </span><span class="ss">doesn</span><span class="err">&#39;</span><span class="ss">t</span><span class="w"> </span><span class="ss">break</span><span class="w"> </span><span class="ss">connection</span></code></pre><h4>Stream Management</h4><p>QUIC streams are lightweight:</p><pre><code class="makeup erlang" translate="no"><span class="c1">% Each Erlang process can have its own stream</span><span class="w">
</span><span class="nf">spawn</span><span class="p" data-group-id="2937851897-1">(</span><span class="nf">fun</span><span class="p" data-group-id="2937851897-2">(</span><span class="p" data-group-id="2937851897-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2937851897-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p" data-group-id="2937851897-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quic</span><span class="p">:</span><span class="nf">open_stream</span><span class="p" data-group-id="2937851897-4">(</span><span class="n">Conn</span><span class="p" data-group-id="2937851897-4">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">quic</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="2937851897-5">(</span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2937851897-5">)</span><span class="p">,</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="2937851897-6">{</span><span class="ss">stream_data</span><span class="p">,</span><span class="w"> </span><span class="n">StreamId</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p" data-group-id="2937851897-6">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle</span><span class="p" data-group-id="2937851897-7">(</span><span class="n">Response</span><span class="p" data-group-id="2937851897-7">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">
    </span><span class="nc">quic</span><span class="p">:</span><span class="nf">close_stream</span><span class="p" data-group-id="2937851897-8">(</span><span class="n">StreamId</span><span class="p" data-group-id="2937851897-8">)</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="2937851897-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">% Streams are cheap! Can create thousands</span><span class="w">
</span><span class="c1">% No overhead like TCP sockets</span></code></pre><h4>Congestion Control</h4><p>QUIC implements multiple congestion control algorithms:</p><ul><li><strong>Reno</strong>: Traditional TCP-like</li><li><strong>Cubic</strong>: Linux default (aggressive)</li><li><strong>BBR</strong>: Google's Bottleneck Bandwidth and RTT</li><li><strong>Custom</strong>: Can implement your own!</li></ul><p>For Macula Mesh:</p><pre><code class="makeup erlang" translate="no"><span class="c1">% Could implement edge-optimized congestion control</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="7410248125-1">(</span><span class="ss">macula_congestion</span><span class="p" data-group-id="7410248125-1">)</span><span class="p">.</span><span class="w">

</span><span class="nf">estimate_bandwidth</span><span class="p" data-group-id="7410248125-2">(</span><span class="n">Samples</span><span class="p" data-group-id="7410248125-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">% Use local measurements instead of RTT</span><span class="w">
    </span><span class="c1">% Better for edge networks with variable latency</span><span class="w">
    </span><span class="p">.</span><span class="p">.</span><span class="p">.</span></code></pre><h4>Flow Control</h4><p>QUIC has flow control at two levels:</p><ol><li><strong>Stream-level</strong>: Each stream has credit</li><li><strong>Connection-level</strong>: Overall connection credit</li></ol><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">Credit</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">MB</span><span class="w">             </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w">  </span><span class="mi">256</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="ss">credit</span><span class="w">            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">  </span><span class="mi">512</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="ss">credit</span><span class="w">            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w">  </span><span class="mi">256</span><span class="w"> </span><span class="n">KB</span><span class="w"> </span><span class="ss">credit</span><span class="w">            </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">

</span><span class="n">Prevents</span><span class="w"> </span><span class="ss">any</span><span class="w"> </span><span class="ss">single</span><span class="w"> </span><span class="ss">stream</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="ss">starving</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">connection</span></code></pre><hr class="thin"/><h2 id="quic-http-3-libraries-for-beam" class="section-heading"><a href="#quic-http-3-libraries-for-beam" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">QUIC/HTTP/3 Libraries for BEAM</span></h2><h3 id="1-quicer-recommended" class="section-heading"><a href="#1-quicer-recommended" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. quicer (Recommended)</span></h3><p><strong>Repository:</strong> <a href="https://github.com/emqx/quic">https://github.com/emqx/quic</a>
<strong>License:</strong> Apache 2.0
<strong>Maintainer:</strong> EMQX Team (Erlang Solutions)
<strong>Language:</strong> Erlang + C (NIF wrapper)
<strong>Backend:</strong> Microsoft MsQuic</p><h4>Overview</h4><p><code class="inline">quicer</code> is an Erlang NIF binding for Microsoft's MsQuic library. MsQuic is a production-grade QUIC implementation used by Windows, Azure, and various Microsoft services.</p><h4>Architecture</h4><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Erlang</span><span class="w"> </span><span class="n">Application</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="nf">quicer</span><span class="w"> </span><span class="p" data-group-id="2703915844-1">(</span><span class="n">Erlang</span><span class="w"> </span><span class="n">API</span><span class="p" data-group-id="2703915844-1">)</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="ss">listen</span><span class="p">/</span><span class="mi">2</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="ss">connect</span><span class="p">/</span><span class="mi">3</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nb">send</span><span class="p">/</span><span class="mi">2</span><span class="w">                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="ss">recv</span><span class="p">/</span><span class="mi">2</span><span class="w">                    </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="ss">quicer</span><span class="w"> </span><span class="n">NIF</span><span class="w"> </span><span class="p" data-group-id="2703915844-2">(</span><span class="n">C</span><span class="p" data-group-id="2703915844-2">)</span><span class="w">                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Erlang</span><span class="w"> </span><span class="err">↔</span><span class="w"> </span><span class="n">MsQuic</span><span class="w"> </span><span class="ss">bridge</span><span class="w">          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="ss">management</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Callback</span><span class="w"> </span><span class="ss">handling</span><span class="w">                </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">MsQuic</span><span class="w"> </span><span class="p" data-group-id="2703915844-3">(</span><span class="n">C</span><span class="p" data-group-id="2703915844-3">)</span><span class="w">                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">RFC</span><span class="w"> </span><span class="mi">9000</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">implementation</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="ss">integration</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Platform</span><span class="o">-</span><span class="ss">specific</span><span class="w"> </span><span class="ss">optimizations</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">OS</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Stack</span><span class="w"> </span><span class="p" data-group-id="2703915844-4">(</span><span class="n">UDP</span><span class="p" data-group-id="2703915844-4">)</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h4>Features</h4><p>✅ <strong>Supported:</strong></p><ul><li>QUIC v1 (RFC 9000)</li><li>TLS 1.3</li><li>0-RTT connection resumption</li><li>Connection migration</li><li>Multiple streams per connection</li><li>Flow control and congestion control</li><li>Both client and server modes</li></ul><p>❌ <strong>Limitations:</strong></p><ul><li>NIF dependency (requires C compilation)</li><li>Tied to MsQuic release cycle</li><li>Platform-specific quirks</li></ul><h4>API Examples</h4><pre><code class="makeup erlang" translate="no"><span class="c1">%% Server</span><span class="w">
</span><span class="nf">start_server</span><span class="p" data-group-id="5295794298-1">(</span><span class="p" data-group-id="5295794298-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Load certificate</span><span class="w">
    </span><span class="p" data-group-id="5295794298-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Cert</span><span class="p" data-group-id="5295794298-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p" data-group-id="5295794298-3">(</span><span class="s">&quot;server.crt&quot;</span><span class="p" data-group-id="5295794298-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5295794298-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p" data-group-id="5295794298-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p" data-group-id="5295794298-5">(</span><span class="s">&quot;server.key&quot;</span><span class="p" data-group-id="5295794298-5">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Listen options</span><span class="w">
    </span><span class="n">ListenOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5295794298-6">#{</span><span class="w">
        </span><span class="ss">cert</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Cert</span><span class="p">,</span><span class="w">
        </span><span class="ss">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w">
        </span><span class="ss">alpn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5295794298-7">[</span><span class="s">&quot;macula/1.0&quot;</span><span class="p" data-group-id="5295794298-7">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">peer_unidi_stream_count</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
        </span><span class="ss">peer_bidi_stream_count</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w">
    </span><span class="p" data-group-id="5295794298-6">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Start listener</span><span class="w">
    </span><span class="p" data-group-id="5295794298-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Listener</span><span class="p" data-group-id="5295794298-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">listen</span><span class="p" data-group-id="5295794298-9">(</span><span class="s">&quot;0.0.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p">,</span><span class="w"> </span><span class="n">ListenOpts</span><span class="p" data-group-id="5295794298-9">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Accept loop</span><span class="w">
    </span><span class="nf">accept_loop</span><span class="p" data-group-id="5295794298-10">(</span><span class="n">Listener</span><span class="p" data-group-id="5295794298-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">accept_loop</span><span class="p" data-group-id="5295794298-11">(</span><span class="n">Listener</span><span class="p" data-group-id="5295794298-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="5295794298-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="5295794298-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept</span><span class="p" data-group-id="5295794298-13">(</span><span class="n">Listener</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5295794298-14">[</span><span class="p" data-group-id="5295794298-14">]</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="5295794298-13">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5295794298-15">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="5295794298-15">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">handshake</span><span class="p" data-group-id="5295794298-16">(</span><span class="n">Conn</span><span class="p" data-group-id="5295794298-16">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Spawn handler</span><span class="w">
    </span><span class="nf">spawn</span><span class="p" data-group-id="5295794298-17">(</span><span class="nf">fun</span><span class="p" data-group-id="5295794298-18">(</span><span class="p" data-group-id="5295794298-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_connection</span><span class="p" data-group-id="5295794298-19">(</span><span class="n">Conn</span><span class="p" data-group-id="5295794298-19">)</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="5295794298-17">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Continue accepting</span><span class="w">
    </span><span class="nf">accept_loop</span><span class="p" data-group-id="5295794298-20">(</span><span class="n">Listener</span><span class="p" data-group-id="5295794298-20">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_connection</span><span class="p" data-group-id="5295794298-21">(</span><span class="n">Conn</span><span class="p" data-group-id="5295794298-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Accept stream</span><span class="w">
    </span><span class="p" data-group-id="5295794298-22">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="5295794298-22">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept_stream</span><span class="p" data-group-id="5295794298-23">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5295794298-24">[</span><span class="p" data-group-id="5295794298-24">]</span><span class="p" data-group-id="5295794298-23">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Receive data</span><span class="w">
    </span><span class="p" data-group-id="5295794298-25">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="5295794298-25">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="5295794298-26">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5295794298-26">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Process and respond</span><span class="w">
    </span><span class="n">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">process</span><span class="p" data-group-id="5295794298-27">(</span><span class="n">Data</span><span class="p" data-group-id="5295794298-27">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="5295794298-28">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p" data-group-id="5295794298-28">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Close stream</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_stream</span><span class="p" data-group-id="5295794298-29">(</span><span class="n">Stream</span><span class="p" data-group-id="5295794298-29">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Client</span><span class="w">
</span><span class="nf">start_client</span><span class="p" data-group-id="5295794298-30">(</span><span class="p" data-group-id="5295794298-30">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Connect options</span><span class="w">
    </span><span class="n">ConnOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5295794298-31">#{</span><span class="w">
        </span><span class="ss">alpn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="5295794298-32">[</span><span class="s">&quot;macula/1.0&quot;</span><span class="p" data-group-id="5295794298-32">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">verify</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">verify_peer</span><span class="p">,</span><span class="w">
        </span><span class="ss">cacertfile</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="s">&quot;ca.crt&quot;</span><span class="w">
    </span><span class="p" data-group-id="5295794298-31">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Connect</span><span class="w">
    </span><span class="p" data-group-id="5295794298-33">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="5295794298-33">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="5295794298-34">(</span><span class="s">&quot;server.example.com&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p">,</span><span class="w"> </span><span class="n">ConnOpts</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="5295794298-34">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Open stream</span><span class="w">
    </span><span class="n">StreamOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5295794298-35">#{</span><span class="ss">active</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="5295794298-35">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5295794298-36">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="5295794298-36">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">start_stream</span><span class="p" data-group-id="5295794298-37">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">StreamOpts</span><span class="p" data-group-id="5295794298-37">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Send data</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="5295794298-38">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5295794298-39">&lt;&lt;</span><span class="s">&quot;Hello, QUIC!&quot;</span><span class="p" data-group-id="5295794298-39">&gt;&gt;</span><span class="p" data-group-id="5295794298-38">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Receive response</span><span class="w">
    </span><span class="p" data-group-id="5295794298-40">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p" data-group-id="5295794298-40">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="5295794298-41">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5295794298-41">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5295794298-42">(</span><span class="s">&quot;Received: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5295794298-43">[</span><span class="n">Response</span><span class="p" data-group-id="5295794298-43">]</span><span class="p" data-group-id="5295794298-42">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Close</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_stream</span><span class="p" data-group-id="5295794298-44">(</span><span class="n">Stream</span><span class="p" data-group-id="5295794298-44">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_connection</span><span class="p" data-group-id="5295794298-45">(</span><span class="n">Conn</span><span class="p" data-group-id="5295794298-45">)</span><span class="p">.</span></code></pre><h4>Production Usage</h4><p><strong>EMQX:</strong> Used in EMQX 5.0+ for MQTT over QUIC</p><ul><li>Handles millions of concurrent connections</li><li>Production-tested at scale</li><li>Good performance characteristics</li></ul><p><strong>RabbitMQ:</strong> Experimental QUIC support via quicer</p><ul><li>AMQP 1.0 over QUIC transport</li><li>Still in development</li></ul><h4>Pros &amp; Cons</h4><p><strong>Pros:</strong></p><ul><li>✅ Battle-tested (MsQuic used in Windows, Azure)</li><li>✅ Actively maintained</li><li>✅ Good documentation</li><li>✅ Performance optimized</li><li>✅ Cross-platform (Linux, macOS, Windows)</li><li>✅ Production-ready (used in EMQX)</li></ul><p><strong>Cons:</strong></p><ul><li>❌ NIF dependency (requires compilation)</li><li>❌ Tied to MsQuic (external C library)</li><li>❌ Breaking changes between MsQuic versions</li><li>❌ Limited control over low-level behavior</li></ul><p><strong>Verdict:</strong> ⭐⭐⭐⭐⭐ <strong>Best choice for Macula Mesh</strong></p><h3 id="2-xquic-alternative" class="section-heading"><a href="#2-xquic-alternative" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. xquic (Alternative)</span></h3><p><strong>Repository:</strong> <a href="https://github.com/alibaba/xquic">https://github.com/alibaba/xquic</a>
<strong>License:</strong> Apache 2.0
<strong>Maintainer:</strong> Alibaba Cloud
<strong>Language:</strong> C + Erlang bindings
<strong>Backend:</strong> xquic (Alibaba's QUIC)</p><h4>Overview</h4><p>xquic is Alibaba's in-house QUIC implementation, used in their edge CDN and cloud services.</p><h4>Features</h4><ul><li>QUIC v1 + IETF draft-29</li><li>HTTP/3 support</li><li>QUIC multipath extension</li><li>BBR congestion control</li><li>High performance (optimized for Alibaba scale)</li></ul><h4>Erlang Bindings</h4><p>Erlang bindings exist but are less mature than quicer:</p><ul><li><a href="https://github.com/emqx/xquic-erl">https://github.com/emqx/xquic-erl</a> (community maintained)</li></ul><h4>Pros &amp; Cons</h4><p><strong>Pros:</strong></p><ul><li>✅ Very high performance</li><li>✅ Multipath QUIC support</li><li>✅ Used at Alibaba scale</li></ul><p><strong>Cons:</strong></p><ul><li>❌ Less mature Erlang bindings</li><li>❌ Documentation mostly in Chinese</li><li>❌ Smaller community</li><li>❌ Not as widely tested outside Alibaba</li></ul><p><strong>Verdict:</strong> ⭐⭐⭐ <strong>Good but less accessible</strong></p><h3 id="3-quinn-rust-via-rustler" class="section-heading"><a href="#3-quinn-rust-via-rustler" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. quinn (Rust, via Rustler)</span></h3><p><strong>Repository:</strong> <a href="https://github.com/quinn-rs/quinn">https://github.com/quinn-rs/quinn</a>
<strong>License:</strong> Apache 2.0 / MIT
<strong>Language:</strong> Rust
<strong>Bindings:</strong> Could use Rustler for Erlang</p><h4>Overview</h4><p>quinn is a pure Rust QUIC implementation, considered one of the best non-C QUIC libraries.</p><h4>Hypothetical Erlang Integration</h4><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Erlang</span><span class="w"> </span><span class="n">Application</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="nf">quinn_nif</span><span class="w"> </span><span class="p" data-group-id="4496508567-1">(</span><span class="n">Rustler</span><span class="p" data-group-id="4496508567-1">)</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Erlang</span><span class="w"> </span><span class="err">↔</span><span class="w"> </span><span class="n">Rust</span><span class="w"> </span><span class="ss">bridge</span><span class="w">            </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="nf">quinn</span><span class="w"> </span><span class="p" data-group-id="4496508567-2">(</span><span class="n">Rust</span><span class="p" data-group-id="4496508567-2">)</span><span class="w">                        </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Pure</span><span class="w"> </span><span class="n">Rust</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">implementation</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="nf">tokio</span><span class="w"> </span><span class="p" data-group-id="4496508567-3">(</span><span class="n">Rust</span><span class="w"> </span><span class="ss">async</span><span class="w"> </span><span class="ss">runtime</span><span class="p" data-group-id="4496508567-3">)</span><span class="w">          </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h4>Pros &amp; Cons</h4><p><strong>Pros:</strong></p><ul><li>✅ Pure Rust (memory safe)</li><li>✅ Excellent performance</li><li>✅ Active development</li><li>✅ Clean API</li></ul><p><strong>Cons:</strong></p><ul><li>❌ No official Erlang bindings</li><li>❌ Would need to build Rustler wrapper</li><li>❌ Rust async runtime complexity</li><li>❌ Additional development effort</li></ul><p><strong>Verdict:</strong> ⭐⭐ <strong>Interesting but requires work</strong></p><h3 id="4-pure-erlang-quic-hypothetical" class="section-heading"><a href="#4-pure-erlang-quic-hypothetical" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Pure Erlang QUIC (Hypothetical)</span></h3><p><strong>Status:</strong> Doesn't exist
<strong>Effort:</strong> 6-12 months of development</p><h4>Why Pure Erlang?</h4><p><strong>Pros:</strong></p><ul><li>✅ No NIFs (easier deployment)</li><li>✅ Full control over implementation</li><li>✅ Could optimize for BEAM semantics</li><li>✅ Easier debugging</li></ul><p><strong>Cons:</strong></p><ul><li>❌ Huge development effort</li><li>❌ Likely slower than C/Rust</li><li>❌ Hard to match performance of tuned C libs</li><li>❌ Cryptography still needs NIFs</li></ul><h4>Feasibility Analysis</h4><pre><code class="makeup erlang" translate="no"><span class="n">Components</span><span class="w"> </span><span class="nc">needed</span><span class="p">:</span><span class="w">
</span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">UDP</span><span class="w"> </span><span class="ss">socket</span><span class="w"> </span><span class="ss">handling</span><span class="w">         </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-1">(</span><span class="ss">gen_udp</span><span class="p" data-group-id="1204463583-1">)</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="ss">implementation</span><span class="w">     </span><span class="err">⚠</span><span class="err">️</span><span class="w">  </span><span class="p" data-group-id="1204463583-2">(</span><span class="ss">ssl</span><span class="w"> </span><span class="ss">app</span><span class="p">,</span><span class="w"> </span><span class="ss">but</span><span class="w"> </span><span class="ss">need</span><span class="w"> </span><span class="ss">low</span><span class="o">-</span><span class="ss">level</span><span class="w"> </span><span class="ss">access</span><span class="p" data-group-id="1204463583-2">)</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Packet</span><span class="w"> </span><span class="ss">parsing</span><span class="w">             </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-3">(</span><span class="ss">binary</span><span class="w"> </span><span class="ss">pattern</span><span class="w"> </span><span class="ss">matching</span><span class="p" data-group-id="1204463583-3">)</span><span class="w">
</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="ss">state</span><span class="w"> </span><span class="ss">machine</span><span class="w">   </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-4">(</span><span class="ss">gen_statem</span><span class="p" data-group-id="1204463583-4">)</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="ss">multiplexing</span><span class="w">        </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-5">(</span><span class="ss">processes</span><span class="p" data-group-id="1204463583-5">)</span><span class="w">
</span><span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="n">Flow</span><span class="w"> </span><span class="ss">control</span><span class="w">               </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-6">(</span><span class="ss">credits</span><span class="o">/</span><span class="ss">backpressure</span><span class="p" data-group-id="1204463583-6">)</span><span class="w">
</span><span class="mi">7</span><span class="p">.</span><span class="w"> </span><span class="n">Congestion</span><span class="w"> </span><span class="ss">control</span><span class="w">         </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-7">(</span><span class="ss">algorithms</span><span class="w"> </span><span class="ss">in</span><span class="w"> </span><span class="n">Erlang</span><span class="p" data-group-id="1204463583-7">)</span><span class="w">
</span><span class="mi">8</span><span class="p">.</span><span class="w"> </span><span class="n">Loss</span><span class="w"> </span><span class="ss">detection</span><span class="w">             </span><span class="err">✅</span><span class="w"> </span><span class="p" data-group-id="1204463583-8">(</span><span class="ss">timers</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="ss">state</span><span class="p" data-group-id="1204463583-8">)</span><span class="w">
</span><span class="mi">9</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">RTT</span><span class="w"> </span><span class="ss">resumption</span><span class="w">          </span><span class="err">⚠</span><span class="err">️</span><span class="w">  </span><span class="p" data-group-id="1204463583-9">(</span><span class="ss">needs</span><span class="w"> </span><span class="ss">crypto</span><span class="w"> </span><span class="ss">primitives</span><span class="p" data-group-id="1204463583-9">)</span><span class="w">

</span><span class="n">Estimated</span><span class="w"> </span><span class="nc">effort</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="o">-</span><span class="mi">6</span><span class="w"> </span><span class="ss">person</span><span class="o">-</span><span class="ss">months</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">basic</span><span class="w"> </span><span class="ss">implementation</span><span class="w">
                 </span><span class="mi">12</span><span class="o">+</span><span class="w"> </span><span class="ss">person</span><span class="o">-</span><span class="ss">months</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">production</span><span class="o">-</span><span class="ss">ready</span></code></pre><p><strong>Verdict:</strong> ⭐ <strong>Not practical for Phase 1</strong></p><h3 id="library-comparison-matrix" class="section-heading"><a href="#library-comparison-matrix" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Library Comparison Matrix</span></h3><table><thead><tr><th style="text-align: left;">Feature</th><th style="text-align: left;">quicer</th><th style="text-align: left;">xquic</th><th style="text-align: left;">quinn</th><th style="text-align: left;">Pure Erlang</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Maturity</strong></td><td style="text-align: left;">⭐⭐⭐⭐⭐</td><td style="text-align: left;">⭐⭐⭐</td><td style="text-align: left;">⭐⭐⭐⭐</td><td style="text-align: left;">❌</td></tr><tr><td style="text-align: left;"><strong>Erlang Integration</strong></td><td style="text-align: left;">⭐⭐⭐⭐⭐</td><td style="text-align: left;">⭐⭐</td><td style="text-align: left;">❌</td><td style="text-align: left;">⭐⭐⭐⭐⭐</td></tr><tr><td style="text-align: left;"><strong>Performance</strong></td><td style="text-align: left;">⭐⭐⭐⭐⭐</td><td style="text-align: left;">⭐⭐⭐⭐⭐</td><td style="text-align: left;">⭐⭐⭐⭐⭐</td><td style="text-align: left;">⭐⭐⭐</td></tr><tr><td style="text-align: left;"><strong>Documentation</strong></td><td style="text-align: left;">⭐⭐⭐⭐</td><td style="text-align: left;">⭐⭐</td><td style="text-align: left;">⭐⭐⭐⭐⭐</td><td style="text-align: left;">N/A</td></tr><tr><td style="text-align: left;"><strong>Production Ready</strong></td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td><td style="text-align: left;">❌</td></tr><tr><td style="text-align: left;"><strong>Cross-platform</strong></td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td><td style="text-align: left;">✅</td></tr><tr><td style="text-align: left;"><strong>NIF Required</strong></td><td style="text-align: left;">Yes</td><td style="text-align: left;">Yes</td><td style="text-align: left;">Yes</td><td style="text-align: left;">No</td></tr><tr><td style="text-align: left;"><strong>Development Effort</strong></td><td style="text-align: left;">Low</td><td style="text-align: left;">Medium</td><td style="text-align: left;">High</td><td style="text-align: left;">Very High</td></tr><tr><td style="text-align: left;"><strong>Community Support</strong></td><td style="text-align: left;">Strong</td><td style="text-align: left;">Moderate</td><td style="text-align: left;">Strong</td><td style="text-align: left;">N/A</td></tr></tbody></table><h3 id="recommendation-quicer" class="section-heading"><a href="#recommendation-quicer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Recommendation: quicer</span></h3><p>For Macula Mesh Phase 1, <strong>quicer is the clear choice</strong>:</p><ol><li><strong>Production-ready</strong>: Used in EMQX with millions of connections</li><li><strong>Well-documented</strong>: Good examples and API docs</li><li><strong>Actively maintained</strong>: Regular updates, responsive maintainers</li><li><strong>Erlang-native</strong>: Designed for BEAM from the ground up</li><li><strong>MsQuic backend</strong>: Battle-tested in Microsoft services</li></ol><p><strong>Migration Path:</strong></p><ul><li>Phase 1: Use quicer (proven, fast path to PoC)</li><li>Phase 2: Optimize (profile, tune, maybe contribute improvements)</li><li>Phase 3: Evaluate alternatives (if needed, could switch to pure Erlang or Rust)</li></ul><hr class="thin"/><h2 id="architecture-overview" class="section-heading"><a href="#architecture-overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture Overview</span></h2><h3 id="high-level-architecture" class="section-heading"><a href="#high-level-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">High-Level Architecture</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">                    </span><span class="n">Macula</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="n">Network</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">      </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">      </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">      </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">      </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w">                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                  </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p" data-group-id="0987831121-1">(</span><span class="n">QUIC</span><span class="p" data-group-id="0987831121-1">)</span><span class="w">                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="p" data-group-id="0987831121-2">(</span><span class="n">Encrypted</span><span class="p">,</span><span class="w"> </span><span class="n">Multiplexed</span><span class="p" data-group-id="0987831121-2">)</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="layered-architecture" class="section-heading"><a href="#layered-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Layered Architecture</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span><span class="w"> </span><span class="n">Application</span><span class="w">                                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Elixir</span><span class="o">/</span><span class="n">Erlang</span><span class="w"> </span><span class="n">Applications</span><span class="w">                          </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Standard</span><span class="w"> </span><span class="ss">distributed</span><span class="w"> </span><span class="n">Erlang</span><span class="w"> </span><span class="n">API</span><span class="w">                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nb">spawn</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">send</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">monitor</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">etc</span><span class="p">.</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
              </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="2903081610-1">(</span><span class="ss">transparent</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">application</span><span class="p" data-group-id="2903081610-1">)</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w"> </span><span class="n">WAMP</span><span class="w"> </span><span class="n">Protocol</span><span class="w"> </span><span class="p" data-group-id="2903081610-2">(</span><span class="n">Optional</span><span class="w"> </span><span class="n">Compatibility</span><span class="p" data-group-id="2903081610-2">)</span><span class="w">        </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nf">publish</span><span class="p" data-group-id="2903081610-3">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2903081610-3">)</span><span class="w">                                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nf">subscribe</span><span class="p" data-group-id="2903081610-4">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="2903081610-4">)</span><span class="w">                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nf">call</span><span class="p" data-group-id="2903081610-5">(</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="2903081610-5">)</span><span class="w">                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nf">register</span><span class="p" data-group-id="2903081610-6">(</span><span class="n">Procedure</span><span class="p">,</span><span class="w"> </span><span class="n">Handler</span><span class="p" data-group-id="2903081610-6">)</span><span class="w">                        </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
              </span><span class="err">↓</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="n">Routing</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="nf">discovery</span><span class="w"> </span><span class="p" data-group-id="2903081610-7">(</span><span class="ss">bootstrap</span><span class="p">,</span><span class="w"> </span><span class="ss">mDNS</span><span class="p">,</span><span class="w"> </span><span class="n">DHT</span><span class="p" data-group-id="2903081610-7">)</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Membership</span><span class="w"> </span><span class="nf">management</span><span class="w"> </span><span class="p" data-group-id="2903081610-8">(</span><span class="n">SWIM</span><span class="w"> </span><span class="ss">gossip</span><span class="p" data-group-id="2903081610-8">)</span><span class="w">                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Topology</span><span class="w"> </span><span class="nf">management</span><span class="w"> </span><span class="p" data-group-id="2903081610-9">(</span><span class="ss">k</span><span class="o">-</span><span class="ss">regular</span><span class="w"> </span><span class="ss">graph</span><span class="p" data-group-id="2903081610-9">)</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="nf">routing</span><span class="w"> </span><span class="p" data-group-id="2903081610-10">(</span><span class="n">DHT</span><span class="o">-</span><span class="ss">based</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p" data-group-id="2903081610-11">(</span><span class="ss">log</span><span class="w"> </span><span class="ss">n</span><span class="p" data-group-id="2903081610-11">)</span><span class="w"> </span><span class="ss">hops</span><span class="p" data-group-id="2903081610-10">)</span><span class="w">         </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
              </span><span class="err">↓</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">Macula</span><span class="w"> </span><span class="n">Distribution</span><span class="w"> </span><span class="n">Protocol</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="nf">framing</span><span class="w"> </span><span class="p" data-group-id="2903081610-12">(</span><span class="ss">wire</span><span class="w"> </span><span class="ss">protocol</span><span class="p" data-group-id="2903081610-12">)</span><span class="w">                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Handshake</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ss">authentication</span><span class="w">                        </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="nf">messaging</span><span class="w"> </span><span class="p" data-group-id="2903081610-13">(</span><span class="n">SEND</span><span class="p">,</span><span class="w"> </span><span class="n">LINK</span><span class="p">,</span><span class="w"> </span><span class="n">MONITOR</span><span class="p">,</span><span class="w"> </span><span class="ss">etc</span><span class="p">.</span><span class="p" data-group-id="2903081610-13">)</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="nf">multiplexing</span><span class="w"> </span><span class="p" data-group-id="2903081610-14">(</span><span class="ss">process</span><span class="w"> </span><span class="err">↔</span><span class="w"> </span><span class="ss">stream</span><span class="w"> </span><span class="ss">mapping</span><span class="p" data-group-id="2903081610-14">)</span><span class="w">     </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
              </span><span class="err">↓</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Transport</span><span class="w"> </span><span class="p" data-group-id="2903081610-15">(</span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="p" data-group-id="2903081610-15">)</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nf">quicer</span><span class="w"> </span><span class="p" data-group-id="2903081610-16">(</span><span class="n">Erlang</span><span class="w"> </span><span class="n">NIF</span><span class="p" data-group-id="2903081610-16">)</span><span class="w">                                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">MsQuic</span><span class="w"> </span><span class="p" data-group-id="2903081610-17">(</span><span class="n">C</span><span class="w"> </span><span class="ss">library</span><span class="p" data-group-id="2903081610-17">)</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">UDP</span><span class="w"> </span><span class="ss">sockets</span><span class="w">                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="ss">encryption</span><span class="w">                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="nf">traversal</span><span class="w"> </span><span class="p" data-group-id="2903081610-18">(</span><span class="n">STUN</span><span class="o">/</span><span class="n">ICE</span><span class="p" data-group-id="2903081610-18">)</span><span class="w">                           </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="component-architecture" class="section-heading"><a href="#component-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Component Architecture</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Macula</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p" data-group-id="2607947116-1">(</span><span class="n">Erlang</span><span class="o">/</span><span class="n">OTP</span><span class="w"> </span><span class="n">Application</span><span class="p" data-group-id="2607947116-1">)</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w">                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Supervision</span><span class="w"> </span><span class="n">Tree</span><span class="w">                                 </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nf">macula_sup</span><span class="w"> </span><span class="p" data-group-id="2607947116-2">(</span><span class="ss">top</span><span class="o">-</span><span class="ss">level</span><span class="w"> </span><span class="ss">supervisor</span><span class="p" data-group-id="2607947116-2">)</span><span class="w">              </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_connection_sup</span><span class="w"> </span><span class="p" data-group-id="2607947116-3">(</span><span class="ss">connections</span><span class="p" data-group-id="2607947116-3">)</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_membership</span><span class="w"> </span><span class="p" data-group-id="2607947116-4">(</span><span class="n">SWIM</span><span class="w"> </span><span class="ss">gossip</span><span class="p" data-group-id="2607947116-4">)</span><span class="w">           </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_topology</span><span class="w"> </span><span class="p" data-group-id="2607947116-5">(</span><span class="ss">neighbor</span><span class="w"> </span><span class="ss">management</span><span class="p" data-group-id="2607947116-5">)</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_routing</span><span class="w"> </span><span class="p" data-group-id="2607947116-6">(</span><span class="n">DHT</span><span class="w"> </span><span class="ss">routing</span><span class="p" data-group-id="2607947116-6">)</span><span class="w">              </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_discovery</span><span class="w"> </span><span class="p" data-group-id="2607947116-7">(</span><span class="nb">node</span><span class="w"> </span><span class="ss">discovery</span><span class="p" data-group-id="2607947116-7">)</span><span class="w">         </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_pubsub</span><span class="w"> </span><span class="p" data-group-id="2607947116-8">(</span><span class="ss">pub</span><span class="o">/</span><span class="ss">sub</span><span class="w"> </span><span class="ss">registry</span><span class="p" data-group-id="2607947116-8">)</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">└</span><span class="err">─</span><span class="w"> </span><span class="nf">macula_dist</span><span class="w"> </span><span class="p" data-group-id="2607947116-9">(</span><span class="ss">distribution</span><span class="w"> </span><span class="ss">driver</span><span class="p" data-group-id="2607947116-9">)</span><span class="w">         </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">Pool</span><span class="w"> </span><span class="p" data-group-id="2607947116-10">(</span><span class="ss">one</span><span class="w"> </span><span class="ss">per</span><span class="w"> </span><span class="ss">remote</span><span class="w"> </span><span class="nb">node</span><span class="p" data-group-id="2607947116-10">)</span><span class="w">            </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nf">connection_1</span><span class="w"> </span><span class="p" data-group-id="2607947116-11">(</span><span class="n">QUIC</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="ss">streams</span><span class="w"> </span><span class="ss">active</span><span class="p" data-group-id="2607947116-11">)</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nf">connection_2</span><span class="w"> </span><span class="p" data-group-id="2607947116-12">(</span><span class="n">QUIC</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">streams</span><span class="w"> </span><span class="ss">active</span><span class="p" data-group-id="2607947116-12">)</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="nf">connection_3</span><span class="w"> </span><span class="p" data-group-id="2607947116-13">(</span><span class="n">QUIC</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="ss">streams</span><span class="w"> </span><span class="ss">active</span><span class="p" data-group-id="2607947116-13">)</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">ETS</span><span class="w"> </span><span class="n">Tables</span><span class="w"> </span><span class="p" data-group-id="2607947116-14">(</span><span class="ss">shared</span><span class="w"> </span><span class="ss">state</span><span class="p" data-group-id="2607947116-14">)</span><span class="w">                        </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nf">membership_table</span><span class="w"> </span><span class="p" data-group-id="2607947116-15">(</span><span class="ss">alive</span><span class="w"> </span><span class="nb">nodes</span><span class="p" data-group-id="2607947116-15">)</span><span class="w">                </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nf">routing_table</span><span class="w"> </span><span class="p" data-group-id="2607947116-16">(</span><span class="n">DHT</span><span class="w"> </span><span class="ss">entries</span><span class="p" data-group-id="2607947116-16">)</span><span class="w">                   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nf">stream_registry</span><span class="w"> </span><span class="p" data-group-id="2607947116-17">(</span><span class="ss">stream_id</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">pid</span><span class="p" data-group-id="2607947116-17">)</span><span class="w">            </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="nf">subscription_registry</span><span class="w"> </span><span class="p" data-group-id="2607947116-18">(</span><span class="ss">topic</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="p" data-group-id="2607947116-19">[</span><span class="ss">pids</span><span class="p" data-group-id="2607947116-19">]</span><span class="p" data-group-id="2607947116-18">)</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><hr class="thin"/><h2 id="detailed-roadmap" class="section-heading"><a href="#detailed-roadmap" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Detailed Roadmap</span></h2><h3 id="phase-1-foundation-weeks-1-4" class="section-heading"><a href="#phase-1-foundation-weeks-1-4" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 1: Foundation (Weeks 1-4)</span></h3><p><strong>Goal:</strong> Prove HTTP/3 Can Carry Erlang Distribution Traffic</p><h4>Week 1-2: QUIC Transport Layer</h4><p><strong>Objectives:</strong></p><ol><li>Set up quicer dependency</li><li>Create basic QUIC server/client</li><li>Implement bidirectional streaming</li><li>Build connection management</li></ol><p><strong>Deliverables:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_quic_echo.erl</span><span class="w">
</span><span class="c1">%% Simple QUIC echo server/client to validate transport</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="2490271838-1">(</span><span class="ss">macula_quic_echo</span><span class="p" data-group-id="2490271838-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="2490271838-2">(</span><span class="p" data-group-id="2490271838-3">[</span><span class="ss">start_server</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">start_client</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="2490271838-3">]</span><span class="p" data-group-id="2490271838-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_server</span><span class="p" data-group-id="2490271838-4">(</span><span class="n">Port</span><span class="p" data-group-id="2490271838-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Generate self-signed cert for testing</span><span class="w">
    </span><span class="p" data-group-id="2490271838-5">{</span><span class="n">Cert</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p" data-group-id="2490271838-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_cert</span><span class="p">:</span><span class="nf">generate_self_signed</span><span class="p" data-group-id="2490271838-6">(</span><span class="s">&quot;localhost&quot;</span><span class="p" data-group-id="2490271838-6">)</span><span class="p">,</span><span class="w">

    </span><span class="n">ListenOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2490271838-7">#{</span><span class="w">
        </span><span class="ss">cert</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Cert</span><span class="p">,</span><span class="w">
        </span><span class="ss">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w">
        </span><span class="ss">alpn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2490271838-8">[</span><span class="s">&quot;macula/1.0&quot;</span><span class="p" data-group-id="2490271838-8">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">idle_timeout_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
        </span><span class="ss">peer_unidi_stream_count</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
        </span><span class="ss">peer_bidi_stream_count</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w">
    </span><span class="p" data-group-id="2490271838-7">}</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="2490271838-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Listener</span><span class="p" data-group-id="2490271838-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">listen</span><span class="p" data-group-id="2490271838-10">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">ListenOpts</span><span class="p" data-group-id="2490271838-10">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-11">(</span><span class="s">&quot;QUIC server listening on port </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-12">[</span><span class="n">Port</span><span class="p" data-group-id="2490271838-12">]</span><span class="p" data-group-id="2490271838-11">)</span><span class="p">,</span><span class="w">

    </span><span class="nf">accept_loop</span><span class="p" data-group-id="2490271838-13">(</span><span class="n">Listener</span><span class="p" data-group-id="2490271838-13">)</span><span class="p">.</span><span class="w">

</span><span class="nf">accept_loop</span><span class="p" data-group-id="2490271838-14">(</span><span class="n">Listener</span><span class="p" data-group-id="2490271838-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept</span><span class="p" data-group-id="2490271838-15">(</span><span class="n">Listener</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-16">[</span><span class="p" data-group-id="2490271838-16">]</span><span class="p">,</span><span class="w"> </span><span class="ss">infinity</span><span class="p" data-group-id="2490271838-15">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2490271838-17">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="2490271838-17">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Complete handshake</span><span class="w">
            </span><span class="p" data-group-id="2490271838-18">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="2490271838-18">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">handshake</span><span class="p" data-group-id="2490271838-19">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-19">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Get peer info</span><span class="w">
            </span><span class="p" data-group-id="2490271838-20">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">PeerAddr</span><span class="p" data-group-id="2490271838-20">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">getopt</span><span class="p" data-group-id="2490271838-21">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="ss">peer_addr</span><span class="p" data-group-id="2490271838-21">)</span><span class="p">,</span><span class="w">
            </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-22">(</span><span class="s">&quot;Accepted connection from </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-23">[</span><span class="n">PeerAddr</span><span class="p" data-group-id="2490271838-23">]</span><span class="p" data-group-id="2490271838-22">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Spawn connection handler</span><span class="w">
            </span><span class="nf">spawn_link</span><span class="p" data-group-id="2490271838-24">(</span><span class="nf">fun</span><span class="p" data-group-id="2490271838-25">(</span><span class="p" data-group-id="2490271838-25">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">handle_connection</span><span class="p" data-group-id="2490271838-26">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-26">)</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="2490271838-24">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Continue accepting</span><span class="w">
            </span><span class="nf">accept_loop</span><span class="p" data-group-id="2490271838-27">(</span><span class="n">Listener</span><span class="p" data-group-id="2490271838-27">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2490271838-28">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2490271838-28">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-29">(</span><span class="s">&quot;Accept error: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-30">[</span><span class="n">Reason</span><span class="p" data-group-id="2490271838-30">]</span><span class="p" data-group-id="2490271838-29">)</span><span class="p">,</span><span class="w">
            </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="2490271838-31">(</span><span class="mi">1000</span><span class="p" data-group-id="2490271838-31">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">accept_loop</span><span class="p" data-group-id="2490271838-32">(</span><span class="n">Listener</span><span class="p" data-group-id="2490271838-32">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_connection</span><span class="p" data-group-id="2490271838-33">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-33">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Accept streams</span><span class="w">
    </span><span class="nf">stream_accept_loop</span><span class="p" data-group-id="2490271838-34">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-34">)</span><span class="p">.</span><span class="w">

</span><span class="nf">stream_accept_loop</span><span class="p" data-group-id="2490271838-35">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-35">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept_stream</span><span class="p" data-group-id="2490271838-36">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-37">[</span><span class="p" data-group-id="2490271838-37">]</span><span class="p" data-group-id="2490271838-36">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2490271838-38">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="2490271838-38">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Spawn stream handler</span><span class="w">
            </span><span class="nf">spawn_link</span><span class="p" data-group-id="2490271838-39">(</span><span class="nf">fun</span><span class="p" data-group-id="2490271838-40">(</span><span class="p" data-group-id="2490271838-40">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">echo_stream</span><span class="p" data-group-id="2490271838-41">(</span><span class="n">Stream</span><span class="p" data-group-id="2490271838-41">)</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="2490271838-39">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">stream_accept_loop</span><span class="p" data-group-id="2490271838-42">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-42">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2490271838-43">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">closed</span><span class="p" data-group-id="2490271838-43">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-44">(</span><span class="s">&quot;Connection closed</span><span class="si">~n</span><span class="s">&quot;</span><span class="p" data-group-id="2490271838-44">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2490271838-45">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2490271838-45">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-46">(</span><span class="s">&quot;Stream accept error: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-47">[</span><span class="n">Reason</span><span class="p" data-group-id="2490271838-47">]</span><span class="p" data-group-id="2490271838-46">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">echo_stream</span><span class="p" data-group-id="2490271838-48">(</span><span class="n">Stream</span><span class="p" data-group-id="2490271838-48">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="2490271838-49">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="2490271838-49">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2490271838-50">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2490271838-50">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-51">(</span><span class="s">&quot;Received: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-52">[</span><span class="n">Data</span><span class="p" data-group-id="2490271838-52">]</span><span class="p" data-group-id="2490271838-51">)</span><span class="p">,</span><span class="w">
            </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="2490271838-53">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2490271838-53">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">echo_stream</span><span class="p" data-group-id="2490271838-54">(</span><span class="n">Stream</span><span class="p" data-group-id="2490271838-54">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2490271838-55">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">closed</span><span class="p" data-group-id="2490271838-55">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_stream</span><span class="p" data-group-id="2490271838-56">(</span><span class="n">Stream</span><span class="p" data-group-id="2490271838-56">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2490271838-57">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2490271838-57">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-58">(</span><span class="s">&quot;Recv error: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-59">[</span><span class="n">Reason</span><span class="p" data-group-id="2490271838-59">]</span><span class="p" data-group-id="2490271838-58">)</span><span class="p">,</span><span class="w">
            </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_stream</span><span class="p" data-group-id="2490271838-60">(</span><span class="n">Stream</span><span class="p" data-group-id="2490271838-60">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">start_client</span><span class="p" data-group-id="2490271838-61">(</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="2490271838-61">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">ConnOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2490271838-62">#{</span><span class="w">
        </span><span class="ss">alpn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2490271838-63">[</span><span class="s">&quot;macula/1.0&quot;</span><span class="p" data-group-id="2490271838-63">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">verify</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">verify_none</span><span class="w">  </span><span class="c1">%% For testing only!</span><span class="w">
    </span><span class="p" data-group-id="2490271838-62">}</span><span class="p">,</span><span class="w">

    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-64">(</span><span class="s">&quot;Connecting to </span><span class="si">~s</span><span class="s">:</span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-65">[</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="2490271838-65">]</span><span class="p" data-group-id="2490271838-64">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2490271838-66">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="2490271838-66">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="2490271838-67">(</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">ConnOpts</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="2490271838-67">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Open stream</span><span class="w">
    </span><span class="p" data-group-id="2490271838-68">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="2490271838-68">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">start_stream</span><span class="p" data-group-id="2490271838-69">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-70">#{</span><span class="ss">active</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="2490271838-70">}</span><span class="p" data-group-id="2490271838-69">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Send message</span><span class="w">
    </span><span class="n">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2490271838-71">&lt;&lt;</span><span class="s">&quot;Hello, QUIC!&quot;</span><span class="p" data-group-id="2490271838-71">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="2490271838-72">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="2490271838-72">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-73">(</span><span class="s">&quot;Sent: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-74">[</span><span class="n">Message</span><span class="p" data-group-id="2490271838-74">]</span><span class="p" data-group-id="2490271838-73">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Receive echo</span><span class="w">
    </span><span class="p" data-group-id="2490271838-75">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Echo</span><span class="p" data-group-id="2490271838-75">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="2490271838-76">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="2490271838-76">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2490271838-77">(</span><span class="s">&quot;Received echo: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2490271838-78">[</span><span class="n">Echo</span><span class="p" data-group-id="2490271838-78">]</span><span class="p" data-group-id="2490271838-77">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Close</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_stream</span><span class="p" data-group-id="2490271838-79">(</span><span class="n">Stream</span><span class="p" data-group-id="2490271838-79">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_connection</span><span class="p" data-group-id="2490271838-80">(</span><span class="n">Conn</span><span class="p" data-group-id="2490271838-80">)</span><span class="p">.</span></code></pre><p><strong>Testing:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># Terminal 1: Start server
</span><span class="gp unselectable">$ </span><span class="">erl -pa _build/default/lib/*/ebin
</span><span class="">1&gt; macula_quic_echo:start_server(4433).
</span><span class="">
</span><span class=""># Terminal 2: Connect client
</span><span class="gp unselectable">$ </span><span class="">erl -pa _build/default/lib/*/ebin
</span><span class="">1&gt; macula_quic_echo:start_client(&quot;localhost&quot;, 4433).
</span></code></pre><p><strong>Success Criteria:</strong></p><ul><li>✅ Server accepts QUIC connections</li><li>✅ Client can connect and exchange data</li><li>✅ Multiple streams work concurrently</li><li>✅ Connection survives stream closure</li></ul><hr class="thin"/><h4>Week 3: Message Framing Protocol</h4><p><strong>Objectives:</strong></p><ol><li>Design Macula wire protocol v1</li><li>Implement message encoding/decoding</li><li>Define message types for distribution</li></ol><p><strong>Wire Protocol Specification:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Macula</span><span class="w"> </span><span class="n">Wire</span><span class="w"> </span><span class="n">Protocol</span><span class="w"> </span><span class="ss">v1</span><span class="w">
</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">==</span><span class="o">=</span><span class="w">

</span><span class="n">All</span><span class="w"> </span><span class="ss">integers</span><span class="w"> </span><span class="ss">are</span><span class="w"> </span><span class="ss">big</span><span class="o">-</span><span class="ss">endian</span><span class="p">.</span><span class="w">

</span><span class="n">Packet</span><span class="w"> </span><span class="n">Format</span><span class="p">:</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Ver</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">Length</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">Payload</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1461339868-1">(</span><span class="mi">1</span><span class="n">B</span><span class="p" data-group-id="1461339868-1">)</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1461339868-2">(</span><span class="mi">1</span><span class="n">B</span><span class="p" data-group-id="1461339868-2">)</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1461339868-3">(</span><span class="mi">2</span><span class="n">B</span><span class="p" data-group-id="1461339868-3">)</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1461339868-4">(</span><span class="mi">4</span><span class="n">B</span><span class="p" data-group-id="1461339868-4">)</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="1461339868-5">(</span><span class="n">N</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="1461339868-5">)</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┴</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┴</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┴</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┴</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">

</span><span class="n">Version</span><span class="w"> </span><span class="p" data-group-id="1461339868-6">(</span><span class="mi">1</span><span class="w"> </span><span class="ss">byte</span><span class="p" data-group-id="1461339868-6">)</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x01</span><span class="p">:</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="mi">1</span><span class="w">

</span><span class="n">Type</span><span class="w"> </span><span class="p" data-group-id="1461339868-7">(</span><span class="mi">1</span><span class="w"> </span><span class="ss">byte</span><span class="p" data-group-id="1461339868-7">)</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x01</span><span class="p">:</span><span class="w"> </span><span class="n">HANDSHAKE</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x02</span><span class="p">:</span><span class="w"> </span><span class="n">HEARTBEAT</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x03</span><span class="p">:</span><span class="w"> </span><span class="n">SEND</span><span class="w">           </span><span class="p" data-group-id="1461339868-8">(</span><span class="nb">send</span><span class="w"> </span><span class="ss">message</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">process</span><span class="p" data-group-id="1461339868-8">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x04</span><span class="p">:</span><span class="w"> </span><span class="n">REG_SEND</span><span class="w">       </span><span class="p" data-group-id="1461339868-9">(</span><span class="nb">send</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">registered</span><span class="w"> </span><span class="ss">name</span><span class="p" data-group-id="1461339868-9">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x05</span><span class="p">:</span><span class="w"> </span><span class="n">EXIT</span><span class="w">           </span><span class="p" data-group-id="1461339868-10">(</span><span class="ss">process</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="ss">signal</span><span class="p" data-group-id="1461339868-10">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x06</span><span class="p">:</span><span class="w"> </span><span class="n">LINK</span><span class="w">           </span><span class="p" data-group-id="1461339868-11">(</span><span class="nb">link</span><span class="w"> </span><span class="ss">processes</span><span class="p" data-group-id="1461339868-11">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x07</span><span class="p">:</span><span class="w"> </span><span class="n">UNLINK</span><span class="w">         </span><span class="p" data-group-id="1461339868-12">(</span><span class="nb">unlink</span><span class="w"> </span><span class="ss">processes</span><span class="p" data-group-id="1461339868-12">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x08</span><span class="p">:</span><span class="w"> </span><span class="n">MONITOR</span><span class="w">        </span><span class="p" data-group-id="1461339868-13">(</span><span class="nb">monitor</span><span class="w"> </span><span class="ss">process</span><span class="p" data-group-id="1461339868-13">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x09</span><span class="p">:</span><span class="w"> </span><span class="n">DEMONITOR</span><span class="w">      </span><span class="p" data-group-id="1461339868-14">(</span><span class="nb">demonitor</span><span class="p" data-group-id="1461339868-14">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x0A</span><span class="p">:</span><span class="w"> </span><span class="n">GROUP_LEADER</span><span class="w">   </span><span class="p" data-group-id="1461339868-15">(</span><span class="ss">group</span><span class="w"> </span><span class="ss">leader</span><span class="w"> </span><span class="ss">operations</span><span class="p" data-group-id="1461339868-15">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x0B</span><span class="p">:</span><span class="w"> </span><span class="n">RPC</span><span class="w">            </span><span class="p" data-group-id="1461339868-16">(</span><span class="ss">remote</span><span class="w"> </span><span class="ss">procedure</span><span class="w"> </span><span class="ss">call</span><span class="p" data-group-id="1461339868-16">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x0C</span><span class="p">:</span><span class="w"> </span><span class="n">SPAWN_REQUEST</span><span class="w">  </span><span class="p" data-group-id="1461339868-17">(</span><span class="nb">spawn</span><span class="w"> </span><span class="ss">on</span><span class="w"> </span><span class="ss">remote</span><span class="w"> </span><span class="nb">node</span><span class="p" data-group-id="1461339868-17">)</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="mi">0</span><span class="nc">x0D</span><span class="p">:</span><span class="w"> </span><span class="n">SPAWN_REPLY</span><span class="w">    </span><span class="p" data-group-id="1461339868-18">(</span><span class="nb">spawn</span><span class="w"> </span><span class="ss">result</span><span class="p" data-group-id="1461339868-18">)</span><span class="w">

</span><span class="n">Flags</span><span class="w"> </span><span class="p" data-group-id="1461339868-19">(</span><span class="mi">2</span><span class="w"> </span><span class="ss">bytes</span><span class="p" data-group-id="1461339868-19">)</span><span class="p">:</span><span class="w">
  </span><span class="n">Bit</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">COMPRESSED</span><span class="w"> </span><span class="p" data-group-id="1461339868-20">(</span><span class="ss">payload</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">compressed</span><span class="p" data-group-id="1461339868-20">)</span><span class="w">
  </span><span class="n">Bit</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">FRAGMENTED</span><span class="w"> </span><span class="p" data-group-id="1461339868-21">(</span><span class="ss">part</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="ss">fragmented</span><span class="w"> </span><span class="ss">message</span><span class="p" data-group-id="1461339868-21">)</span><span class="w">
  </span><span class="n">Bit</span><span class="w"> </span><span class="mi">2</span><span class="o">-</span><span class="mi">15</span><span class="p">:</span><span class="w"> </span><span class="n">Reserved</span><span class="w">

</span><span class="n">Length</span><span class="w"> </span><span class="p" data-group-id="1461339868-22">(</span><span class="mi">4</span><span class="w"> </span><span class="ss">bytes</span><span class="p" data-group-id="1461339868-22">)</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Payload</span><span class="w"> </span><span class="nb">length</span><span class="w"> </span><span class="ss">in</span><span class="w"> </span><span class="nf">bytes</span><span class="w"> </span><span class="p" data-group-id="1461339868-23">(</span><span class="ss">max</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="n">MB</span><span class="p" data-group-id="1461339868-23">)</span><span class="w">

</span><span class="n">Payload</span><span class="w"> </span><span class="p" data-group-id="1461339868-24">(</span><span class="n">N</span><span class="w"> </span><span class="ss">bytes</span><span class="p" data-group-id="1461339868-24">)</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Message</span><span class="o">-</span><span class="ss">type</span><span class="w"> </span><span class="ss">specific</span><span class="w"> </span><span class="ss">data</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Encoded</span><span class="w"> </span><span class="ss">using</span><span class="w"> </span><span class="n">Erlang</span><span class="w"> </span><span class="n">External</span><span class="w"> </span><span class="n">Term</span><span class="w"> </span><span class="n">Format</span><span class="w"> </span><span class="p" data-group-id="1461339868-25">(</span><span class="n">EETF</span><span class="p" data-group-id="1461339868-25">)</span></code></pre><p><strong>Implementation:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_protocol.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="2054686050-1">(</span><span class="ss">macula_protocol</span><span class="p" data-group-id="2054686050-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="2054686050-2">(</span><span class="p" data-group-id="2054686050-3">[</span><span class="ss">encode</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">decode</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="2054686050-3">]</span><span class="p" data-group-id="2054686050-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Protocol version</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-4">(</span><span class="n">VERSION</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2054686050-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Message types</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-5">(</span><span class="n">MSG_HANDSHAKE</span><span class="p">,</span><span class="w"> </span><span class="mi">16#01</span><span class="p" data-group-id="2054686050-5">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-6">(</span><span class="n">MSG_HEARTBEAT</span><span class="p">,</span><span class="w"> </span><span class="mi">16#02</span><span class="p" data-group-id="2054686050-6">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-7">(</span><span class="n">MSG_SEND</span><span class="p">,</span><span class="w"> </span><span class="mi">16#03</span><span class="p" data-group-id="2054686050-7">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-8">(</span><span class="n">MSG_REG_SEND</span><span class="p">,</span><span class="w"> </span><span class="mi">16#04</span><span class="p" data-group-id="2054686050-8">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-9">(</span><span class="n">MSG_EXIT</span><span class="p">,</span><span class="w"> </span><span class="mi">16#05</span><span class="p" data-group-id="2054686050-9">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-10">(</span><span class="n">MSG_LINK</span><span class="p">,</span><span class="w"> </span><span class="mi">16#06</span><span class="p" data-group-id="2054686050-10">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-11">(</span><span class="n">MSG_UNLINK</span><span class="p">,</span><span class="w"> </span><span class="mi">16#07</span><span class="p" data-group-id="2054686050-11">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-12">(</span><span class="n">MSG_MONITOR</span><span class="p">,</span><span class="w"> </span><span class="mi">16#08</span><span class="p" data-group-id="2054686050-12">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-13">(</span><span class="n">MSG_DEMONITOR</span><span class="p">,</span><span class="w"> </span><span class="mi">16#09</span><span class="p" data-group-id="2054686050-13">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-14">(</span><span class="n">MSG_GROUP_LEADER</span><span class="p">,</span><span class="w"> </span><span class="mi">16#0A</span><span class="p" data-group-id="2054686050-14">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-15">(</span><span class="n">MSG_RPC</span><span class="p">,</span><span class="w"> </span><span class="mi">16#0B</span><span class="p" data-group-id="2054686050-15">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-16">(</span><span class="n">MSG_SPAWN_REQUEST</span><span class="p">,</span><span class="w"> </span><span class="mi">16#0C</span><span class="p" data-group-id="2054686050-16">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-17">(</span><span class="n">MSG_SPAWN_REPLY</span><span class="p">,</span><span class="w"> </span><span class="mi">16#0D</span><span class="p" data-group-id="2054686050-17">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Flags</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-18">(</span><span class="n">FLAG_COMPRESSED</span><span class="p">,</span><span class="w"> </span><span class="mi">16#0001</span><span class="p" data-group-id="2054686050-18">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="2054686050-19">(</span><span class="n">FLAG_FRAGMENTED</span><span class="p">,</span><span class="w"> </span><span class="mi">16#0002</span><span class="p" data-group-id="2054686050-19">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Encode message</span><span class="w">
</span><span class="nf">encode</span><span class="p" data-group-id="2054686050-20">(</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="2054686050-20">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_integer</span><span class="p" data-group-id="2054686050-21">(</span><span class="n">Type</span><span class="p" data-group-id="2054686050-21">)</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="o">=&lt;</span><span class="w"> </span><span class="mi">255</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">encode</span><span class="p" data-group-id="2054686050-22">(</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="2054686050-22">)</span><span class="p">.</span><span class="w">

</span><span class="nf">encode</span><span class="p" data-group-id="2054686050-23">(</span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">Flags</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="2054686050-23">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Serialize payload</span><span class="w">
    </span><span class="n">PayloadBin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">term_to_binary</span><span class="p" data-group-id="2054686050-24">(</span><span class="n">Payload</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-25">[</span><span class="ss">compressed</span><span class="p" data-group-id="2054686050-25">]</span><span class="p" data-group-id="2054686050-24">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">byte_size</span><span class="p" data-group-id="2054686050-26">(</span><span class="n">PayloadBin</span><span class="p" data-group-id="2054686050-26">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Check size limit (16 MB)</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">Length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">16#1000000</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2054686050-27">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">payload_too_large</span><span class="p" data-group-id="2054686050-27">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Build packet</span><span class="w">
            </span><span class="p" data-group-id="2054686050-28">&lt;&lt;</span><span class="o">?</span><span class="n">VERSION</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">Flags</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">PayloadBin</span><span class="o">/</span><span class="ss">binary</span><span class="p" data-group-id="2054686050-28">&gt;&gt;</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Decode message</span><span class="w">
</span><span class="nf">decode</span><span class="p" data-group-id="2054686050-29">(</span><span class="p" data-group-id="2054686050-30">&lt;&lt;</span><span class="o">?</span><span class="n">VERSION</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="n">Flags</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">Length</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="w"> </span><span class="n">PayloadBin</span><span class="p">:</span><span class="n">Length</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="n">Rest</span><span class="o">/</span><span class="ss">binary</span><span class="p" data-group-id="2054686050-30">&gt;&gt;</span><span class="p" data-group-id="2054686050-29">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Deserialize payload</span><span class="w">
    </span><span class="n">Payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">binary_to_term</span><span class="p" data-group-id="2054686050-31">(</span><span class="n">PayloadBin</span><span class="p" data-group-id="2054686050-31">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="2054686050-32">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-33">#{</span><span class="w">
        </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Type</span><span class="p">,</span><span class="w">
        </span><span class="ss">flags</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Flags</span><span class="p">,</span><span class="w">
        </span><span class="ss">payload</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Payload</span><span class="w">
    </span><span class="p" data-group-id="2054686050-33">}</span><span class="p">,</span><span class="w"> </span><span class="n">Rest</span><span class="p" data-group-id="2054686050-32">}</span><span class="p">;</span><span class="w">
</span><span class="nf">decode</span><span class="p" data-group-id="2054686050-34">(</span><span class="n">Bin</span><span class="p" data-group-id="2054686050-34">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">byte_size</span><span class="p" data-group-id="2054686050-35">(</span><span class="n">Bin</span><span class="p" data-group-id="2054686050-35">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2054686050-36">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">insufficient_data</span><span class="p" data-group-id="2054686050-36">}</span><span class="p">;</span><span class="w">
</span><span class="nf">decode</span><span class="p" data-group-id="2054686050-37">(</span><span class="p" data-group-id="2054686050-38">&lt;&lt;</span><span class="n">Version</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="o">/</span><span class="ss">binary</span><span class="p" data-group-id="2054686050-38">&gt;&gt;</span><span class="p" data-group-id="2054686050-37">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="o">?</span><span class="n">VERSION</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2054686050-39">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-40">{</span><span class="ss">unsupported_version</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="2054686050-40">}</span><span class="p" data-group-id="2054686050-39">}</span><span class="p">;</span><span class="w">
</span><span class="nf">decode</span><span class="p" data-group-id="2054686050-41">(</span><span class="p">_</span><span class="p" data-group-id="2054686050-41">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="2054686050-42">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_packet</span><span class="p" data-group-id="2054686050-42">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Helper: Encode SEND message</span><span class="w">
</span><span class="nf">encode_send</span><span class="p" data-group-id="2054686050-43">(</span><span class="n">FromPid</span><span class="p">,</span><span class="w"> </span><span class="n">ToPid</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="2054686050-43">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">encode</span><span class="p" data-group-id="2054686050-44">(</span><span class="o">?</span><span class="n">MSG_SEND</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-45">{</span><span class="n">FromPid</span><span class="p">,</span><span class="w"> </span><span class="n">ToPid</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="2054686050-45">}</span><span class="p" data-group-id="2054686050-44">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Helper: Encode LINK message</span><span class="w">
</span><span class="nf">encode_link</span><span class="p" data-group-id="2054686050-46">(</span><span class="n">Pid1</span><span class="p">,</span><span class="w"> </span><span class="n">Pid2</span><span class="p" data-group-id="2054686050-46">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">encode</span><span class="p" data-group-id="2054686050-47">(</span><span class="o">?</span><span class="n">MSG_LINK</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-48">{</span><span class="n">Pid1</span><span class="p">,</span><span class="w"> </span><span class="n">Pid2</span><span class="p" data-group-id="2054686050-48">}</span><span class="p" data-group-id="2054686050-47">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Helper: Encode MONITOR message</span><span class="w">
</span><span class="nf">encode_monitor</span><span class="p" data-group-id="2054686050-49">(</span><span class="n">Pid</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">MonitoredPid</span><span class="p" data-group-id="2054686050-49">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">encode</span><span class="p" data-group-id="2054686050-50">(</span><span class="o">?</span><span class="n">MSG_MONITOR</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-51">{</span><span class="n">Pid</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">MonitoredPid</span><span class="p" data-group-id="2054686050-51">}</span><span class="p" data-group-id="2054686050-50">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Helper: Encode SPAWN_REQUEST message</span><span class="w">
</span><span class="nf">encode_spawn_request</span><span class="p" data-group-id="2054686050-52">(</span><span class="n">ReqId</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="2054686050-52">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">encode</span><span class="p" data-group-id="2054686050-53">(</span><span class="o">?</span><span class="n">MSG_SPAWN_REQUEST</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2054686050-54">{</span><span class="n">ReqId</span><span class="p">,</span><span class="w"> </span><span class="n">Module</span><span class="p">,</span><span class="w"> </span><span class="n">Function</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="2054686050-54">}</span><span class="p" data-group-id="2054686050-53">)</span><span class="p">.</span></code></pre><p><strong>Handshake Protocol:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_handshake.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="5560746715-1">(</span><span class="ss">macula_handshake</span><span class="p" data-group-id="5560746715-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="5560746715-2">(</span><span class="p" data-group-id="5560746715-3">[</span><span class="ss">perform</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">accept</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="5560746715-3">]</span><span class="p" data-group-id="5560746715-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="5560746715-4">(</span><span class="ss">handshake</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-5">{</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="n">MACULA_VERSION</span><span class="p">,</span><span class="w">
    </span><span class="ss">node_name</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">atom</span><span class="p" data-group-id="5560746715-6">(</span><span class="p" data-group-id="5560746715-6">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">node_id</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="5560746715-7">(</span><span class="p" data-group-id="5560746715-7">)</span><span class="p">,</span><span class="w">      </span><span class="c1">%% SHA256(certificate)</span><span class="w">
    </span><span class="ss">capabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5560746715-8">[</span><span class="p" data-group-id="5560746715-8">]</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5560746715-9">[</span><span class="nf">atom</span><span class="p" data-group-id="5560746715-10">(</span><span class="p" data-group-id="5560746715-10">)</span><span class="p" data-group-id="5560746715-9">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">creation</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="5560746715-11">(</span><span class="p" data-group-id="5560746715-11">)</span><span class="p">,</span><span class="w">    </span><span class="c1">%% Node start time</span><span class="w">
    </span><span class="ss">challenge</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="5560746715-12">(</span><span class="p" data-group-id="5560746715-12">)</span><span class="w">     </span><span class="c1">%% Random bytes for auth</span><span class="w">
</span><span class="p" data-group-id="5560746715-5">}</span><span class="p" data-group-id="5560746715-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Initiate handshake (client side)</span><span class="w">
</span><span class="nf">perform</span><span class="p" data-group-id="5560746715-13">(</span><span class="n">Conn</span><span class="p" data-group-id="5560746715-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Generate our handshake</span><span class="w">
    </span><span class="n">Handshake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">handshake</span><span class="p" data-group-id="5560746715-14">{</span><span class="w">
        </span><span class="ss">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">node</span><span class="p" data-group-id="5560746715-15">(</span><span class="p" data-group-id="5560746715-15">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="5560746715-16">(</span><span class="p" data-group-id="5560746715-16">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">capabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5560746715-17">[</span><span class="ss">compression</span><span class="p">,</span><span class="w"> </span><span class="ss">rpc</span><span class="p">,</span><span class="w"> </span><span class="ss">monitoring</span><span class="p">,</span><span class="w"> </span><span class="ss">streams</span><span class="p" data-group-id="5560746715-17">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">creation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="5560746715-18">(</span><span class="ss">millisecond</span><span class="p" data-group-id="5560746715-18">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">strong_rand_bytes</span><span class="p" data-group-id="5560746715-19">(</span><span class="mi">32</span><span class="p" data-group-id="5560746715-19">)</span><span class="w">
    </span><span class="p" data-group-id="5560746715-14">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Send handshake</span><span class="w">
    </span><span class="n">Packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="5560746715-20">(</span><span class="o">?</span><span class="n">MSG_HANDSHAKE</span><span class="p">,</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5560746715-20">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5560746715-21">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="5560746715-21">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">start_stream</span><span class="p" data-group-id="5560746715-22">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-23">#{</span><span class="ss">active</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="5560746715-23">}</span><span class="p" data-group-id="5560746715-22">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="5560746715-24">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="p" data-group-id="5560746715-24">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Receive remote handshake</span><span class="w">
    </span><span class="p" data-group-id="5560746715-25">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">ResponsePacket</span><span class="p" data-group-id="5560746715-25">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="5560746715-26">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5560746715-26">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5560746715-27">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-28">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="5560746715-28">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="5560746715-27">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">decode</span><span class="p" data-group-id="5560746715-29">(</span><span class="n">ResponsePacket</span><span class="p" data-group-id="5560746715-29">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Verify compatibility</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">check_compatibility</span><span class="p" data-group-id="5560746715-30">(</span><span class="n">Handshake</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="5560746715-30">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Send acknowledgment</span><span class="w">
            </span><span class="n">Ack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="5560746715-31">(</span><span class="o">?</span><span class="n">MSG_HANDSHAKE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-32">{</span><span class="ss">ack</span><span class="p">,</span><span class="w"> </span><span class="n">Handshake</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">challenge</span><span class="p" data-group-id="5560746715-32">}</span><span class="p" data-group-id="5560746715-31">)</span><span class="p">,</span><span class="w">
            </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="5560746715-33">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Ack</span><span class="p" data-group-id="5560746715-33">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="5560746715-34">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="5560746715-34">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="5560746715-35">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5560746715-35">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5560746715-36">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5560746715-36">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Accept handshake (server side)</span><span class="w">
</span><span class="nf">accept</span><span class="p" data-group-id="5560746715-37">(</span><span class="n">Conn</span><span class="p" data-group-id="5560746715-37">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Accept stream</span><span class="w">
    </span><span class="p" data-group-id="5560746715-38">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="5560746715-38">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept_stream</span><span class="p" data-group-id="5560746715-39">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-40">[</span><span class="p" data-group-id="5560746715-40">]</span><span class="p" data-group-id="5560746715-39">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Receive handshake</span><span class="w">
    </span><span class="p" data-group-id="5560746715-41">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="p" data-group-id="5560746715-41">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="5560746715-42">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5560746715-42">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5560746715-43">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-44">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="5560746715-44">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="5560746715-43">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">decode</span><span class="p" data-group-id="5560746715-45">(</span><span class="n">Packet</span><span class="p" data-group-id="5560746715-45">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Generate our handshake</span><span class="w">
    </span><span class="n">Handshake</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">handshake</span><span class="p" data-group-id="5560746715-46">{</span><span class="w">
        </span><span class="ss">node_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">node</span><span class="p" data-group-id="5560746715-47">(</span><span class="p" data-group-id="5560746715-47">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="5560746715-48">(</span><span class="p" data-group-id="5560746715-48">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">capabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="5560746715-49">[</span><span class="ss">compression</span><span class="p">,</span><span class="w"> </span><span class="ss">rpc</span><span class="p">,</span><span class="w"> </span><span class="ss">monitoring</span><span class="p">,</span><span class="w"> </span><span class="ss">streams</span><span class="p" data-group-id="5560746715-49">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">creation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="5560746715-50">(</span><span class="ss">millisecond</span><span class="p" data-group-id="5560746715-50">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">challenge</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">strong_rand_bytes</span><span class="p" data-group-id="5560746715-51">(</span><span class="mi">32</span><span class="p" data-group-id="5560746715-51">)</span><span class="w">
    </span><span class="p" data-group-id="5560746715-46">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Verify compatibility</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">check_compatibility</span><span class="p" data-group-id="5560746715-52">(</span><span class="n">Handshake</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="5560746715-52">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Send our handshake</span><span class="w">
            </span><span class="n">Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="5560746715-53">(</span><span class="o">?</span><span class="n">MSG_HANDSHAKE</span><span class="p">,</span><span class="w"> </span><span class="n">Handshake</span><span class="p" data-group-id="5560746715-53">)</span><span class="p">,</span><span class="w">
            </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="5560746715-54">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Response</span><span class="p" data-group-id="5560746715-54">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Wait for acknowledgment</span><span class="w">
            </span><span class="p" data-group-id="5560746715-55">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">AckPacket</span><span class="p" data-group-id="5560746715-55">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="5560746715-56">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="5560746715-56">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="5560746715-57">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5560746715-58">#{</span><span class="ss">payload</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="5560746715-59">{</span><span class="ss">ack</span><span class="p">,</span><span class="w"> </span><span class="n">Challenge</span><span class="p" data-group-id="5560746715-59">}</span><span class="p" data-group-id="5560746715-58">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="5560746715-57">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">decode</span><span class="p" data-group-id="5560746715-60">(</span><span class="n">AckPacket</span><span class="p" data-group-id="5560746715-60">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Verify challenge</span><span class="w">
            </span><span class="k">if</span><span class="w">
                </span><span class="n">Challenge</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="n">Handshake</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">challenge</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="5560746715-61">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="5560746715-61">}</span><span class="p">;</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="5560746715-62">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_challenge</span><span class="p" data-group-id="5560746715-62">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="5560746715-63">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5560746715-63">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5560746715-64">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="5560746715-64">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">check_compatibility</span><span class="p" data-group-id="5560746715-65">(</span><span class="n">Local</span><span class="p">,</span><span class="w"> </span><span class="n">Remote</span><span class="p" data-group-id="5560746715-65">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Check version</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="n">Local</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">version</span><span class="w"> </span><span class="o">=/=</span><span class="w"> </span><span class="n">Remote</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">version</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="5560746715-66">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">version_mismatch</span><span class="p" data-group-id="5560746715-66">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Check capabilities</span><span class="w">
            </span><span class="n">CommonCaps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">sets</span><span class="p">:</span><span class="nf">intersection</span><span class="p" data-group-id="5560746715-67">(</span><span class="w">
                </span><span class="nc">sets</span><span class="p">:</span><span class="nf">from_list</span><span class="p" data-group-id="5560746715-68">(</span><span class="n">Local</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">capabilities</span><span class="p" data-group-id="5560746715-68">)</span><span class="p">,</span><span class="w">
                </span><span class="nc">sets</span><span class="p">:</span><span class="nf">from_list</span><span class="p" data-group-id="5560746715-69">(</span><span class="n">Remote</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">capabilities</span><span class="p" data-group-id="5560746715-69">)</span><span class="w">
            </span><span class="p" data-group-id="5560746715-67">)</span><span class="p">,</span><span class="w">
            </span><span class="k">if</span><span class="w">
                </span><span class="nc">sets</span><span class="p">:</span><span class="nf">size</span><span class="p" data-group-id="5560746715-70">(</span><span class="n">CommonCaps</span><span class="p" data-group-id="5560746715-70">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="5560746715-71">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_common_capabilities</span><span class="p" data-group-id="5560746715-71">}</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h4>Week 4: Basic Distribution Protocol</h4><p><strong>Objectives:</strong></p><ol><li>Implement net_kernel distribution driver</li><li>Support basic message sending</li><li>Enable process spawning</li></ol><p><strong>Distribution Driver:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_dist.erl</span><span class="w">
</span><span class="c1">%% Erlang distribution protocol driver for Macula</span><span class="w">
</span><span class="c1">%%</span><span class="w">
</span><span class="c1">%% This module implements the callbacks required by Erlang&#39;s net_kernel</span><span class="w">
</span><span class="c1">%% to use Macula as a custom distribution protocol.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="1294607164-1">(</span><span class="ss">macula_dist</span><span class="p" data-group-id="1294607164-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Distribution driver callbacks</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1294607164-2">(</span><span class="p" data-group-id="1294607164-3">[</span><span class="w">
    </span><span class="ss">listen</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">accept</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">accept_connection</span><span class="p">/</span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="ss">setup</span><span class="p">/</span><span class="mi">5</span><span class="p">,</span><span class="w">
    </span><span class="ss">close</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">select</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">is_node_name</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">address</span><span class="p">/</span><span class="mi">0</span><span class="w">
</span><span class="p" data-group-id="1294607164-3">]</span><span class="p" data-group-id="1294607164-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Internal API</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1294607164-4">(</span><span class="p" data-group-id="1294607164-5">[</span><span class="w">
    </span><span class="nb">send</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nb">send</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">recv</span><span class="p">/</span><span class="mi">2</span><span class="w">
</span><span class="p" data-group-id="1294607164-5">]</span><span class="p" data-group-id="1294607164-4">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="1294607164-6">(</span><span class="ss">macula_dist_state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-7">{</span><span class="w">
    </span><span class="ss">listener</span><span class="p">,</span><span class="w">      </span><span class="c1">%% QUIC listener</span><span class="w">
    </span><span class="ss">connection</span><span class="p">,</span><span class="w">    </span><span class="c1">%% QUIC connection</span><span class="w">
    </span><span class="nb">node</span><span class="p">,</span><span class="w">          </span><span class="c1">%% Remote node name</span><span class="w">
    </span><span class="ss">streams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1294607164-8">#{</span><span class="p" data-group-id="1294607164-8">}</span><span class="w">  </span><span class="c1">%% Map: purpose =&gt; stream</span><span class="w">
</span><span class="p" data-group-id="1294607164-7">}</span><span class="p" data-group-id="1294607164-6">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Listen for incoming connections</span><span class="w">
</span><span class="nf">listen</span><span class="p" data-group-id="1294607164-9">(</span><span class="n">Name</span><span class="p" data-group-id="1294607164-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Extract port from name (e.g., node@host:4433)</span><span class="w">
    </span><span class="n">Port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">extract_port</span><span class="p" data-group-id="1294607164-10">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p" data-group-id="1294607164-10">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Generate certificate</span><span class="w">
    </span><span class="p" data-group-id="1294607164-11">{</span><span class="n">Cert</span><span class="p">,</span><span class="w"> </span><span class="n">Key</span><span class="p" data-group-id="1294607164-11">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_cert</span><span class="p">:</span><span class="nf">generate_node_cert</span><span class="p" data-group-id="1294607164-12">(</span><span class="n">Name</span><span class="p" data-group-id="1294607164-12">)</span><span class="p">,</span><span class="w">

    </span><span class="n">ListenOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1294607164-13">#{</span><span class="w">
        </span><span class="ss">cert</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Cert</span><span class="p">,</span><span class="w">
        </span><span class="ss">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w">
        </span><span class="ss">alpn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1294607164-14">[</span><span class="s">&quot;macula-dist/1.0&quot;</span><span class="p" data-group-id="1294607164-14">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">peer_bidi_stream_count</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">100</span><span class="w">
    </span><span class="p" data-group-id="1294607164-13">}</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">listen</span><span class="p" data-group-id="1294607164-15">(</span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">ListenOpts</span><span class="p" data-group-id="1294607164-15">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-16">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Listener</span><span class="p" data-group-id="1294607164-16">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-17">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-18">{</span><span class="n">Listener</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">macula_dist_state</span><span class="p" data-group-id="1294607164-19">{</span><span class="ss">listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Listener</span><span class="p" data-group-id="1294607164-19">}</span><span class="p" data-group-id="1294607164-18">}</span><span class="p" data-group-id="1294607164-17">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1294607164-20">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-20">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-21">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-21">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Accept incoming connection</span><span class="w">
</span><span class="nf">accept</span><span class="p" data-group-id="1294607164-22">(</span><span class="n">Listen</span><span class="p" data-group-id="1294607164-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Listener</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element</span><span class="p" data-group-id="1294607164-23">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Listen</span><span class="p" data-group-id="1294607164-23">)</span><span class="p">,</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept</span><span class="p" data-group-id="1294607164-24">(</span><span class="n">Listener</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-25">[</span><span class="p" data-group-id="1294607164-25">]</span><span class="p">,</span><span class="w"> </span><span class="ss">infinity</span><span class="p" data-group-id="1294607164-24">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-26">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="1294607164-26">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Perform handshake</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_handshake</span><span class="p">:</span><span class="nf">accept</span><span class="p" data-group-id="1294607164-27">(</span><span class="n">Conn</span><span class="p" data-group-id="1294607164-27">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="p" data-group-id="1294607164-28">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="1294607164-28">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="n">RemoteNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="o">#</span><span class="ss">handshake</span><span class="p">.</span><span class="ss">node_name</span><span class="p">,</span><span class="w">
                    </span><span class="n">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">macula_dist_state</span><span class="p" data-group-id="1294607164-29">{</span><span class="w">
                        </span><span class="ss">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Conn</span><span class="p">,</span><span class="w">
                        </span><span class="nb">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RemoteNode</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-29">}</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-30">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1294607164-30">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="1294607164-31">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-31">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_connection</span><span class="p" data-group-id="1294607164-32">(</span><span class="n">Conn</span><span class="p" data-group-id="1294607164-32">)</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-33">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-33">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1294607164-34">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-34">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-35">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-35">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Accept connection (post-handshake setup)</span><span class="w">
</span><span class="nf">accept_connection</span><span class="p" data-group-id="1294607164-36">(</span><span class="n">AcceptPid</span><span class="p">,</span><span class="w"> </span><span class="n">DistCtrl</span><span class="p">,</span><span class="w"> </span><span class="n">MyNode</span><span class="p">,</span><span class="w"> </span><span class="n">Allowed</span><span class="p">,</span><span class="w"> </span><span class="n">SetupTime</span><span class="p" data-group-id="1294607164-36">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% This is called by net_kernel after accept/1 succeeds</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="1294607164-37">(</span><span class="n">DistCtrl</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-38">{</span><span class="ss">accept_connection</span><span class="p">,</span><span class="w"> </span><span class="n">AcceptPid</span><span class="p">,</span><span class="w"> </span><span class="n">MyNode</span><span class="p">,</span><span class="w"> </span><span class="n">Allowed</span><span class="p">,</span><span class="w"> </span><span class="n">SetupTime</span><span class="p" data-group-id="1294607164-38">}</span><span class="p" data-group-id="1294607164-37">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Setup outgoing connection</span><span class="w">
</span><span class="nf">setup</span><span class="p" data-group-id="1294607164-39">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="p">,</span><span class="w"> </span><span class="n">MyNode</span><span class="p">,</span><span class="w"> </span><span class="n">LongOrShortNames</span><span class="p">,</span><span class="w"> </span><span class="n">SetupTime</span><span class="p" data-group-id="1294607164-39">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Extract host and port</span><span class="w">
    </span><span class="p" data-group-id="1294607164-40">{</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="1294607164-40">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">parse_node_name</span><span class="p" data-group-id="1294607164-41">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-41">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Connect</span><span class="w">
    </span><span class="n">ConnOpts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1294607164-42">#{</span><span class="w">
        </span><span class="ss">alpn</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="1294607164-43">[</span><span class="s">&quot;macula-dist/1.0&quot;</span><span class="p" data-group-id="1294607164-43">]</span><span class="p">,</span><span class="w">
        </span><span class="ss">verify</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">verify_peer</span><span class="w">
    </span><span class="p" data-group-id="1294607164-42">}</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="1294607164-44">(</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">ConnOpts</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="1294607164-44">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-45">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="1294607164-45">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Perform handshake</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_handshake</span><span class="p">:</span><span class="nf">perform</span><span class="p" data-group-id="1294607164-46">(</span><span class="n">Conn</span><span class="p" data-group-id="1294607164-46">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="p" data-group-id="1294607164-47">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteHandshake</span><span class="p" data-group-id="1294607164-47">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="n">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">macula_dist_state</span><span class="p" data-group-id="1294607164-48">{</span><span class="w">
                        </span><span class="ss">connection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Conn</span><span class="p">,</span><span class="w">
                        </span><span class="nb">node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Node</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-48">}</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-49">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="1294607164-49">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="1294607164-50">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-50">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_connection</span><span class="p" data-group-id="1294607164-51">(</span><span class="n">Conn</span><span class="p" data-group-id="1294607164-51">)</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-52">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-52">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1294607164-53">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-53">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-54">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-54">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Close connection</span><span class="w">
</span><span class="nf">close</span><span class="p" data-group-id="1294607164-55">(</span><span class="n">Conn</span><span class="p" data-group-id="1294607164-55">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">close_connection</span><span class="p" data-group-id="1294607164-56">(</span><span class="n">Conn</span><span class="p" data-group-id="1294607164-56">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Select (for epmd compatibility)</span><span class="w">
</span><span class="nf">select</span><span class="p" data-group-id="1294607164-57">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-57">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Macula doesn&#39;t use epmd</span><span class="w">
    </span><span class="p" data-group-id="1294607164-58">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="p" data-group-id="1294607164-58">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Check if valid node name</span><span class="w">
</span><span class="nf">is_node_name</span><span class="p" data-group-id="1294607164-59">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-59">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_atom</span><span class="p" data-group-id="1294607164-60">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-60">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">atom_to_list</span><span class="p" data-group-id="1294607164-61">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-61">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-62">[</span><span class="sc">$@</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1294607164-62">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p">;</span><span class="w">
        </span><span class="n">Name</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">string</span><span class="p">:</span><span class="nf">chr</span><span class="p" data-group-id="1294607164-63">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="sc">$@</span><span class="p" data-group-id="1294607164-63">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="mi">0</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p">;</span><span class="w">
                </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">
</span><span class="nf">is_node_name</span><span class="p" data-group-id="1294607164-64">(</span><span class="p">_</span><span class="p" data-group-id="1294607164-64">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">false</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Get address (for net_kernel)</span><span class="w">
</span><span class="nf">address</span><span class="p" data-group-id="1294607164-65">(</span><span class="p" data-group-id="1294607164-65">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Return local node address</span><span class="w">
    </span><span class="p" data-group-id="1294607164-66">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-67">{</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1294607164-67">}</span><span class="p" data-group-id="1294607164-66">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Send message to process on remote node</span><span class="w">
</span><span class="nf">send</span><span class="p" data-group-id="1294607164-68">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Pid</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1294607164-68">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Encode SEND message</span><span class="w">
    </span><span class="n">Packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">encode_send</span><span class="p" data-group-id="1294607164-69">(</span><span class="nf">self</span><span class="p" data-group-id="1294607164-70">(</span><span class="p" data-group-id="1294607164-70">)</span><span class="p">,</span><span class="w"> </span><span class="n">Pid</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1294607164-69">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Get or create stream for this message</span><span class="w">
    </span><span class="p" data-group-id="1294607164-71">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-71">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_or_create_stream</span><span class="p" data-group-id="1294607164-72">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="ss">control</span><span class="p" data-group-id="1294607164-72">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Send</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="1294607164-73">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="p" data-group-id="1294607164-73">)</span><span class="p">.</span><span class="w">

</span><span class="nf">send</span><span class="p" data-group-id="1294607164-74">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1294607164-74">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_atom</span><span class="p" data-group-id="1294607164-75">(</span><span class="n">Name</span><span class="p" data-group-id="1294607164-75">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Send to registered name</span><span class="w">
    </span><span class="n">Packet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">encode</span><span class="p" data-group-id="1294607164-76">(</span><span class="o">?</span><span class="n">MSG_REG_SEND</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-77">{</span><span class="nf">self</span><span class="p" data-group-id="1294607164-78">(</span><span class="p" data-group-id="1294607164-78">)</span><span class="p">,</span><span class="w"> </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1294607164-77">}</span><span class="p" data-group-id="1294607164-76">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1294607164-79">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-79">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_or_create_stream</span><span class="p" data-group-id="1294607164-80">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="ss">control</span><span class="p" data-group-id="1294607164-80">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="1294607164-81">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="p" data-group-id="1294607164-81">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Receive message</span><span class="w">
</span><span class="nf">recv</span><span class="p" data-group-id="1294607164-82">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="p" data-group-id="1294607164-82">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Accept next stream with data</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">accept_stream</span><span class="p" data-group-id="1294607164-83">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-84">[</span><span class="p" data-group-id="1294607164-84">]</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="p" data-group-id="1294607164-83">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-85">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-85">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="1294607164-86">(</span><span class="n">Stream</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="1294607164-86">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="p" data-group-id="1294607164-87">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Packet</span><span class="p" data-group-id="1294607164-87">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-88">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1294607164-88">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_protocol</span><span class="p">:</span><span class="nf">decode</span><span class="p" data-group-id="1294607164-89">(</span><span class="n">Packet</span><span class="p" data-group-id="1294607164-89">)</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-90">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p" data-group-id="1294607164-90">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="1294607164-91">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-91">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="1294607164-92">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-92">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1294607164-93">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-93">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-94">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1294607164-94">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%%% Internal functions</span><span class="w">

</span><span class="nf">get_or_create_stream</span><span class="p" data-group-id="1294607164-95">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Purpose</span><span class="p" data-group-id="1294607164-95">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Look up existing stream for this purpose</span><span class="w">
    </span><span class="c1">%% If not found, create new stream</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">lookup</span><span class="p" data-group-id="1294607164-96">(</span><span class="ss">macula_streams</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-97">{</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Purpose</span><span class="p" data-group-id="1294607164-97">}</span><span class="p" data-group-id="1294607164-96">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-98">[</span><span class="p" data-group-id="1294607164-99">{</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-99">}</span><span class="p" data-group-id="1294607164-98">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-100">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-100">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1294607164-101">[</span><span class="p" data-group-id="1294607164-101">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-102">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-102">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">start_stream</span><span class="p" data-group-id="1294607164-103">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-104">#{</span><span class="ss">active</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="1294607164-104">}</span><span class="p" data-group-id="1294607164-103">)</span><span class="p">,</span><span class="w">
            </span><span class="nc">ets</span><span class="p">:</span><span class="nf">insert</span><span class="p" data-group-id="1294607164-105">(</span><span class="ss">macula_streams</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1294607164-106">{</span><span class="p" data-group-id="1294607164-107">{</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Purpose</span><span class="p" data-group-id="1294607164-107">}</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-106">}</span><span class="p" data-group-id="1294607164-105">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="1294607164-108">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="p" data-group-id="1294607164-108">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">parse_node_name</span><span class="p" data-group-id="1294607164-109">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-109">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_atom</span><span class="p" data-group-id="1294607164-110">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-110">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">string</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="1294607164-111">(</span><span class="nf">atom_to_list</span><span class="p" data-group-id="1294607164-112">(</span><span class="n">Node</span><span class="p" data-group-id="1294607164-112">)</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;@&quot;</span><span class="p" data-group-id="1294607164-111">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-113">[</span><span class="p">_</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">HostPort</span><span class="p" data-group-id="1294607164-113">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">string</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="1294607164-114">(</span><span class="n">HostPort</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p" data-group-id="1294607164-114">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="p" data-group-id="1294607164-115">[</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="1294607164-115">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1294607164-116">{</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="nf">list_to_integer</span><span class="p" data-group-id="1294607164-117">(</span><span class="n">Port</span><span class="p" data-group-id="1294607164-117">)</span><span class="p" data-group-id="1294607164-116">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="1294607164-118">[</span><span class="n">Host</span><span class="p" data-group-id="1294607164-118">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1294607164-119">{</span><span class="n">Host</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p" data-group-id="1294607164-119">}</span><span class="w">  </span><span class="c1">%% Default port</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1294607164-120">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">invalid_node_name</span><span class="p" data-group-id="1294607164-120">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">extract_port</span><span class="p" data-group-id="1294607164-121">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Default</span><span class="p" data-group-id="1294607164-121">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">string</span><span class="p">:</span><span class="nf">split</span><span class="p" data-group-id="1294607164-122">(</span><span class="nf">atom_to_list</span><span class="p" data-group-id="1294607164-123">(</span><span class="n">Name</span><span class="p" data-group-id="1294607164-123">)</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="p" data-group-id="1294607164-122">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1294607164-124">[</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p" data-group-id="1294607164-124">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">list_to_integer</span><span class="p" data-group-id="1294607164-125">(</span><span class="n">Port</span><span class="p" data-group-id="1294607164-125">)</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Default</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p><strong>Testing:</strong></p><pre><code class="makeup bash" translate="no"><span class=""># Terminal 1: Start first node
</span><span class="gp unselectable">$ </span><span class="">erl -name node1@localhost:4433 -proto_dist macula -pa _build/default/lib/*/ebin
</span><span class="">
</span><span class=""># Terminal 2: Start second node
</span><span class="gp unselectable">$ </span><span class="">erl -name node2@localhost:4434 -proto_dist macula -pa _build/default/lib/*/ebin
</span><span class="">
</span><span class=""># In node2:
</span><span class="">(node2@localhost:4434)1&gt; net_kernel:connect_node(&#39;node1@localhost:4433&#39;).
</span><span class="">true
</span><span class="">
</span><span class="">(node2@localhost:4434)2&gt; nodes().
</span><span class="">[&#39;node1@localhost:4433&#39;]
</span><span class="">
</span><span class="">(node2@localhost:4434)3&gt; {node1, &#39;node1@localhost:4433&#39;} ! {hello, from, node2}.
</span><span class="">{hello, from, node2}
</span><span class="">
</span><span class=""># In node1, check process mailbox:
</span><span class="">(node1@localhost:4433)1&gt; receive Msg -&gt; Msg end.
</span><span class="">{hello, from, node2}
</span><span class="">
</span><span class=""># Spawn remote process:
</span><span class="">(node2@localhost:4434)4&gt; spawn(&#39;node1@localhost:4433&#39;, fun() -&gt;
</span><span class="">    io:format(&quot;Running on ~p!~n&quot;, [node()])
</span><span class="">end).
</span><span class="">&lt;12345.67.0&gt;
</span><span class="">
</span><span class=""># On node1, see output:
</span><span class="">Running on &#39;node1@localhost:4433&#39;!
</span></code></pre><p><strong>Success Criteria:</strong></p><ul><li>✅ Two nodes can connect via Macula</li><li>✅ <code class="inline">nodes()</code> shows connected nodes</li><li>✅ Messages can be sent between nodes</li><li>✅ Remote spawning works</li><li>✅ Basic distributed Erlang operations function</li></ul><hr class="thin"/><h3 id="phase-2-mesh-topology-weeks-5-8" class="section-heading"><a href="#phase-2-mesh-topology-weeks-5-8" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 2: Mesh Topology (Weeks 5-8)</span></h3><p><strong>Goal:</strong> Move Beyond Point-to-Point to Self-Organizing Mesh</p><h4>Week 5-6: Node Discovery and Membership</h4><p><strong>Objectives:</strong></p><ol><li>Implement multi-strategy node discovery</li><li>Build SWIM-based membership protocol</li><li>Handle node joins, leaves, failures</li></ol><p><strong>Node Discovery:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_discovery.erl</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="0137951005-1">(</span><span class="ss">macula_discovery</span><span class="p" data-group-id="0137951005-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="0137951005-2">(</span><span class="ss">gen_server</span><span class="p" data-group-id="0137951005-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="0137951005-3">(</span><span class="p" data-group-id="0137951005-4">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">discover</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">get_known_nodes</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="0137951005-4">]</span><span class="p" data-group-id="0137951005-3">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="0137951005-5">(</span><span class="p" data-group-id="0137951005-6">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_call</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_cast</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_info</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="0137951005-6">]</span><span class="p" data-group-id="0137951005-5">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="0137951005-7">(</span><span class="ss">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0137951005-8">{</span><span class="w">
    </span><span class="ss">bootstrap_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0137951005-9">[</span><span class="p" data-group-id="0137951005-9">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">known_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">sets</span><span class="p">:</span><span class="nf">new</span><span class="p" data-group-id="0137951005-10">(</span><span class="p" data-group-id="0137951005-10">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">discovery_interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">30000</span><span class="w">  </span><span class="c1">%% 30 seconds</span><span class="w">
</span><span class="p" data-group-id="0137951005-8">}</span><span class="p" data-group-id="0137951005-7">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="0137951005-11">(</span><span class="p" data-group-id="0137951005-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="0137951005-12">(</span><span class="p" data-group-id="0137951005-13">{</span><span class="ss">local</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p" data-group-id="0137951005-13">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0137951005-14">[</span><span class="p" data-group-id="0137951005-14">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0137951005-15">[</span><span class="p" data-group-id="0137951005-15">]</span><span class="p" data-group-id="0137951005-12">)</span><span class="p">.</span><span class="w">

</span><span class="nf">discover</span><span class="p" data-group-id="0137951005-16">(</span><span class="p" data-group-id="0137951005-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="0137951005-17">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">discover</span><span class="p" data-group-id="0137951005-17">)</span><span class="p">.</span><span class="w">

</span><span class="nf">get_known_nodes</span><span class="p" data-group-id="0137951005-18">(</span><span class="p" data-group-id="0137951005-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="0137951005-19">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">get_known_nodes</span><span class="p" data-group-id="0137951005-19">)</span><span class="p">.</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="0137951005-20">(</span><span class="p" data-group-id="0137951005-21">[</span><span class="p" data-group-id="0137951005-21">]</span><span class="p" data-group-id="0137951005-20">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Load bootstrap nodes from config</span><span class="w">
    </span><span class="n">Bootstrap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="0137951005-22">(</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="ss">bootstrap_nodes</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0137951005-23">[</span><span class="p" data-group-id="0137951005-23">]</span><span class="p" data-group-id="0137951005-22">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Start discovery timer</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="0137951005-24">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="0137951005-25">(</span><span class="p" data-group-id="0137951005-25">)</span><span class="p">,</span><span class="w"> </span><span class="ss">discover</span><span class="p" data-group-id="0137951005-24">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="0137951005-26">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="0137951005-27">{</span><span class="ss">bootstrap_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Bootstrap</span><span class="p" data-group-id="0137951005-27">}</span><span class="p" data-group-id="0137951005-26">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="0137951005-28">(</span><span class="ss">discover</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-28">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Run all discovery strategies in parallel</span><span class="w">
    </span><span class="n">Self</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="0137951005-29">(</span><span class="p" data-group-id="0137951005-29">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">spawn</span><span class="p" data-group-id="0137951005-30">(</span><span class="nf">fun</span><span class="p" data-group-id="0137951005-31">(</span><span class="p" data-group-id="0137951005-31">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="0137951005-32">{</span><span class="ss">discovered</span><span class="p">,</span><span class="w"> </span><span class="nf">discover_via_bootstrap</span><span class="p" data-group-id="0137951005-33">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">bootstrap_nodes</span><span class="p" data-group-id="0137951005-33">)</span><span class="p" data-group-id="0137951005-32">}</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="0137951005-30">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">spawn</span><span class="p" data-group-id="0137951005-34">(</span><span class="nf">fun</span><span class="p" data-group-id="0137951005-35">(</span><span class="p" data-group-id="0137951005-35">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="0137951005-36">{</span><span class="ss">discovered</span><span class="p">,</span><span class="w"> </span><span class="nf">discover_via_mdns</span><span class="p" data-group-id="0137951005-37">(</span><span class="p" data-group-id="0137951005-37">)</span><span class="p" data-group-id="0137951005-36">}</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="0137951005-34">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">spawn</span><span class="p" data-group-id="0137951005-38">(</span><span class="nf">fun</span><span class="p" data-group-id="0137951005-39">(</span><span class="p" data-group-id="0137951005-39">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Self</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p" data-group-id="0137951005-40">{</span><span class="ss">discovered</span><span class="p">,</span><span class="w"> </span><span class="nf">discover_via_dns_srv</span><span class="p" data-group-id="0137951005-41">(</span><span class="p" data-group-id="0137951005-41">)</span><span class="p" data-group-id="0137951005-40">}</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="0137951005-38">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="0137951005-42">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-42">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="0137951005-43">(</span><span class="ss">get_known_nodes</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-43">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">sets</span><span class="p">:</span><span class="nf">to_list</span><span class="p" data-group-id="0137951005-44">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">known_nodes</span><span class="p" data-group-id="0137951005-44">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0137951005-45">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-45">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_cast</span><span class="p" data-group-id="0137951005-46">(</span><span class="p">_</span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-46">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0137951005-47">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-47">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="0137951005-48">(</span><span class="ss">discover</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-48">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Trigger discovery</span><span class="w">
    </span><span class="nf">discover</span><span class="p" data-group-id="0137951005-49">(</span><span class="p" data-group-id="0137951005-49">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Schedule next discovery</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="0137951005-50">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">discovery_interval</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="0137951005-51">(</span><span class="p" data-group-id="0137951005-51">)</span><span class="p">,</span><span class="w"> </span><span class="ss">discover</span><span class="p" data-group-id="0137951005-50">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0137951005-52">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-52">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="0137951005-53">(</span><span class="p" data-group-id="0137951005-54">{</span><span class="ss">discovered</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="0137951005-54">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="0137951005-53">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Merge discovered nodes</span><span class="w">
    </span><span class="n">KnownNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p" data-group-id="0137951005-55">(</span><span class="w">
        </span><span class="nf">fun</span><span class="p" data-group-id="0137951005-56">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="0137951005-56">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">sets</span><span class="p">:</span><span class="nf">add_element</span><span class="p" data-group-id="0137951005-57">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="0137951005-57">)</span><span class="w"> </span><span class="k">end</span><span class="p">,</span><span class="w">
        </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">known_nodes</span><span class="p">,</span><span class="w">
        </span><span class="n">Nodes</span><span class="w">
    </span><span class="p" data-group-id="0137951005-55">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Notify membership protocol</span><span class="w">
    </span><span class="nc">macula_membership</span><span class="p">:</span><span class="nf">discovered_nodes</span><span class="p" data-group-id="0137951005-58">(</span><span class="n">Nodes</span><span class="p" data-group-id="0137951005-58">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="0137951005-59">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="0137951005-60">{</span><span class="ss">known_nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KnownNodes</span><span class="p" data-group-id="0137951005-60">}</span><span class="p" data-group-id="0137951005-59">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%%% Discovery Strategies</span><span class="w">

</span><span class="c1">%% Strategy 1: Bootstrap Nodes</span><span class="w">
</span><span class="nf">discover_via_bootstrap</span><span class="p" data-group-id="0137951005-61">(</span><span class="n">Bootstrap</span><span class="p" data-group-id="0137951005-61">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Try to connect to bootstrap nodes</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">filtermap</span><span class="p" data-group-id="0137951005-62">(</span><span class="nf">fun</span><span class="p" data-group-id="0137951005-63">(</span><span class="n">Node</span><span class="p" data-group-id="0137951005-63">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">ping</span><span class="p" data-group-id="0137951005-64">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="0137951005-64">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="ss">pong</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0137951005-65">{</span><span class="ss">true</span><span class="p">,</span><span class="w"> </span><span class="n">Node</span><span class="p" data-group-id="0137951005-65">}</span><span class="p">;</span><span class="w">
            </span><span class="ss">timeout</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">false</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Bootstrap</span><span class="p" data-group-id="0137951005-62">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Strategy 2: mDNS (local network)</span><span class="w">
</span><span class="nf">discover_via_mdns</span><span class="p" data-group-id="0137951005-66">(</span><span class="p" data-group-id="0137951005-66">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Send mDNS query for _macula._udp.local</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_mdns</span><span class="p">:</span><span class="nf">discover</span><span class="p" data-group-id="0137951005-67">(</span><span class="s">&quot;_macula._udp.local&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p" data-group-id="0137951005-67">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="0137951005-68">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="0137951005-68">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Nodes</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="0137951005-69">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="0137951005-69">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0137951005-70">[</span><span class="p" data-group-id="0137951005-70">]</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Strategy 3: DNS SRV Records</span><span class="w">
</span><span class="nf">discover_via_dns_srv</span><span class="p" data-group-id="0137951005-71">(</span><span class="p" data-group-id="0137951005-71">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Query DNS SRV for _macula._udp.example.com</span><span class="w">
    </span><span class="n">Domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="0137951005-72">(</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="ss">dns_domain</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;macula.local&quot;</span><span class="p" data-group-id="0137951005-72">)</span><span class="p">,</span><span class="w">
    </span><span class="n">SRVName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;_macula._udp.&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">Domain</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">inet_res</span><span class="p">:</span><span class="nf">lookup</span><span class="p" data-group-id="0137951005-73">(</span><span class="n">SRVName</span><span class="p">,</span><span class="w"> </span><span class="ss">in</span><span class="p">,</span><span class="w"> </span><span class="ss">srv</span><span class="p" data-group-id="0137951005-73">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="0137951005-74">[</span><span class="p" data-group-id="0137951005-74">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0137951005-75">[</span><span class="p" data-group-id="0137951005-75">]</span><span class="p">;</span><span class="w">
        </span><span class="n">Records</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Extract host:port from SRV records</span><span class="w">
            </span><span class="nc">lists</span><span class="p">:</span><span class="nf">map</span><span class="p" data-group-id="0137951005-76">(</span><span class="nf">fun</span><span class="p" data-group-id="0137951005-77">(</span><span class="p" data-group-id="0137951005-78">{</span><span class="p">_</span><span class="n">Priority</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Weight</span><span class="p">,</span><span class="w"> </span><span class="n">Port</span><span class="p">,</span><span class="w"> </span><span class="n">Host</span><span class="p" data-group-id="0137951005-78">}</span><span class="p" data-group-id="0137951005-77">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nf">list_to_atom</span><span class="p" data-group-id="0137951005-79">(</span><span class="nf">atom_to_list</span><span class="p" data-group-id="0137951005-80">(</span><span class="nf">node</span><span class="p" data-group-id="0137951005-81">(</span><span class="p" data-group-id="0137951005-81">)</span><span class="p" data-group-id="0137951005-80">)</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;@&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;:&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="nf">integer_to_list</span><span class="p" data-group-id="0137951005-82">(</span><span class="n">Port</span><span class="p" data-group-id="0137951005-82">)</span><span class="p" data-group-id="0137951005-79">)</span><span class="w">
            </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Records</span><span class="p" data-group-id="0137951005-76">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p><strong>SWIM Membership Protocol:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_membership.erl</span><span class="w">
</span><span class="c1">%% SWIM: Scalable Weakly-consistent Infection-style Process Group Membership Protocol</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="6969281993-1">(</span><span class="ss">macula_membership</span><span class="p" data-group-id="6969281993-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="6969281993-2">(</span><span class="ss">gen_server</span><span class="p" data-group-id="6969281993-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="6969281993-3">(</span><span class="p" data-group-id="6969281993-4">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">join</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">leave</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">get_members</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">discovered_nodes</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="6969281993-4">]</span><span class="p" data-group-id="6969281993-3">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="6969281993-5">(</span><span class="p" data-group-id="6969281993-6">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_call</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_cast</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_info</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="6969281993-6">]</span><span class="p" data-group-id="6969281993-5">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="6969281993-7">(</span><span class="ss">member</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-8">{</span><span class="w">
    </span><span class="ss">node_id</span><span class="p">,</span><span class="w">
    </span><span class="ss">address</span><span class="p">,</span><span class="w">
    </span><span class="ss">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">alive</span><span class="p">,</span><span class="w">      </span><span class="c1">%% alive | suspect | dead</span><span class="w">
    </span><span class="ss">incarnation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">    </span><span class="c1">%% For conflict resolution</span><span class="w">
    </span><span class="ss">last_seen</span><span class="p">,</span><span class="w">          </span><span class="c1">%% Timestamp</span><span class="w">
    </span><span class="ss">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-9">#{</span><span class="p" data-group-id="6969281993-9">}</span><span class="w">      </span><span class="c1">%% Arbitrary key-value data</span><span class="w">
</span><span class="p" data-group-id="6969281993-8">}</span><span class="p" data-group-id="6969281993-7">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="6969281993-10">(</span><span class="ss">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-11">{</span><span class="w">
    </span><span class="ss">local_member</span><span class="p">,</span><span class="w">
    </span><span class="ss">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-12">#{</span><span class="p" data-group-id="6969281993-12">}</span><span class="p">,</span><span class="w">       </span><span class="c1">%% node_id =&gt; member</span><span class="w">
    </span><span class="ss">protocol_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">  </span><span class="c1">%% 1 second</span><span class="w">
    </span><span class="ss">suspect_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w">  </span><span class="c1">%% 5 seconds</span><span class="w">
    </span><span class="ss">ping_targets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-13">[</span><span class="p" data-group-id="6969281993-13">]</span><span class="w">
</span><span class="p" data-group-id="6969281993-11">}</span><span class="p" data-group-id="6969281993-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="6969281993-14">(</span><span class="p" data-group-id="6969281993-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="6969281993-15">(</span><span class="p" data-group-id="6969281993-16">{</span><span class="ss">local</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p" data-group-id="6969281993-16">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-17">[</span><span class="p" data-group-id="6969281993-17">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-18">[</span><span class="p" data-group-id="6969281993-18">]</span><span class="p" data-group-id="6969281993-15">)</span><span class="p">.</span><span class="w">

</span><span class="nf">join</span><span class="p" data-group-id="6969281993-19">(</span><span class="n">BootstrapNode</span><span class="p" data-group-id="6969281993-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="6969281993-20">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-21">{</span><span class="ss">join</span><span class="p">,</span><span class="w"> </span><span class="n">BootstrapNode</span><span class="p" data-group-id="6969281993-21">}</span><span class="p" data-group-id="6969281993-20">)</span><span class="p">.</span><span class="w">

</span><span class="nf">leave</span><span class="p" data-group-id="6969281993-22">(</span><span class="p" data-group-id="6969281993-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="6969281993-23">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">leave</span><span class="p" data-group-id="6969281993-23">)</span><span class="p">.</span><span class="w">

</span><span class="nf">get_members</span><span class="p" data-group-id="6969281993-24">(</span><span class="p" data-group-id="6969281993-24">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="6969281993-25">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">get_members</span><span class="p" data-group-id="6969281993-25">)</span><span class="p">.</span><span class="w">

</span><span class="nf">discovered_nodes</span><span class="p" data-group-id="6969281993-26">(</span><span class="n">Nodes</span><span class="p" data-group-id="6969281993-26">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="6969281993-27">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-28">{</span><span class="ss">discovered_nodes</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="6969281993-28">}</span><span class="p" data-group-id="6969281993-27">)</span><span class="p">.</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="6969281993-29">(</span><span class="p" data-group-id="6969281993-30">[</span><span class="p" data-group-id="6969281993-30">]</span><span class="p" data-group-id="6969281993-29">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Create local member</span><span class="w">
    </span><span class="n">Local</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">member</span><span class="p" data-group-id="6969281993-31">{</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="6969281993-32">(</span><span class="p" data-group-id="6969281993-32">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">address</span><span class="p" data-group-id="6969281993-33">(</span><span class="p" data-group-id="6969281993-33">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">alive</span><span class="p">,</span><span class="w">
        </span><span class="ss">incarnation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="ss">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="6969281993-34">(</span><span class="ss">millisecond</span><span class="p" data-group-id="6969281993-34">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-35">#{</span><span class="w">
            </span><span class="ss">node_name</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">node</span><span class="p" data-group-id="6969281993-36">(</span><span class="p" data-group-id="6969281993-36">)</span><span class="p">,</span><span class="w">
            </span><span class="ss">started_at</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="6969281993-37">(</span><span class="ss">millisecond</span><span class="p" data-group-id="6969281993-37">)</span><span class="w">
        </span><span class="p" data-group-id="6969281993-35">}</span><span class="w">
    </span><span class="p" data-group-id="6969281993-31">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Start protocol tick</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="6969281993-38">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="6969281993-39">(</span><span class="p" data-group-id="6969281993-39">)</span><span class="p">,</span><span class="w"> </span><span class="ss">protocol_tick</span><span class="p" data-group-id="6969281993-38">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="6969281993-40">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="6969281993-41">{</span><span class="ss">local_member</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Local</span><span class="p" data-group-id="6969281993-41">}</span><span class="p" data-group-id="6969281993-40">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="6969281993-42">(</span><span class="p" data-group-id="6969281993-43">{</span><span class="ss">join</span><span class="p">,</span><span class="w"> </span><span class="n">BootstrapNode</span><span class="p" data-group-id="6969281993-43">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-42">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Contact bootstrap node and exchange membership</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="6969281993-44">(</span><span class="n">BootstrapNode</span><span class="p" data-group-id="6969281993-44">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="6969281993-45">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="6969281993-45">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Send join request</span><span class="w">
            </span><span class="n">Request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-46">{</span><span class="ss">join</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">local_member</span><span class="p" data-group-id="6969281993-46">}</span><span class="p">,</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_rpc</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="6969281993-47">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_join</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-48">[</span><span class="n">Request</span><span class="p" data-group-id="6969281993-48">]</span><span class="p" data-group-id="6969281993-47">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="p" data-group-id="6969281993-49">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteMembers</span><span class="p" data-group-id="6969281993-49">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="c1">%% Merge members</span><span class="w">
                    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">merge</span><span class="p" data-group-id="6969281993-50">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p">,</span><span class="w"> </span><span class="n">RemoteMembers</span><span class="p" data-group-id="6969281993-50">)</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="6969281993-51">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="6969281993-52">{</span><span class="ss">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Members</span><span class="p" data-group-id="6969281993-52">}</span><span class="p" data-group-id="6969281993-51">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="6969281993-53">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6969281993-53">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="6969281993-54">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-55">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6969281993-55">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-54">}</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="6969281993-56">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6969281993-56">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="6969281993-57">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-58">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="6969281993-58">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-57">}</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="6969281993-59">(</span><span class="ss">get_members</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-59">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">values</span><span class="p" data-group-id="6969281993-60">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-60">)</span><span class="p">,</span><span class="w">
    </span><span class="n">AliveMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">filter</span><span class="p" data-group-id="6969281993-61">(</span><span class="nf">fun</span><span class="p" data-group-id="6969281993-62">(</span><span class="n">M</span><span class="p" data-group-id="6969281993-62">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">M</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">state</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="ss">alive</span><span class="w"> </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Members</span><span class="p" data-group-id="6969281993-61">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6969281993-63">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="n">AliveMembers</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-63">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="6969281993-64">(</span><span class="ss">leave</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-64">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Broadcast leave message</span><span class="w">
    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">values</span><span class="p" data-group-id="6969281993-65">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-65">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-66">{</span><span class="ss">leave</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">local_member</span><span class="p" data-group-id="6969281993-66">}</span><span class="p">,</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="6969281993-67">(</span><span class="nf">fun</span><span class="p" data-group-id="6969281993-68">(</span><span class="n">Member</span><span class="p" data-group-id="6969281993-68">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="6969281993-69">(</span><span class="n">Member</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">Msg</span><span class="p" data-group-id="6969281993-69">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Members</span><span class="p" data-group-id="6969281993-67">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="6969281993-70">{</span><span class="ss">stop</span><span class="p">,</span><span class="w"> </span><span class="ss">normal</span><span class="p">,</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-70">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_cast</span><span class="p" data-group-id="6969281993-71">(</span><span class="p" data-group-id="6969281993-72">{</span><span class="ss">discovered_nodes</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="6969281993-72">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-71">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Add discovered nodes to members (if not already known)</span><span class="w">
    </span><span class="n">NewMembers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foldl</span><span class="p" data-group-id="6969281993-73">(</span><span class="nf">fun</span><span class="p" data-group-id="6969281993-74">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="6969281993-74">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">NodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="6969281993-75">(</span><span class="n">Node</span><span class="p" data-group-id="6969281993-75">)</span><span class="p">,</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">is_key</span><span class="p" data-group-id="6969281993-76">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="6969281993-76">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Acc</span><span class="p">;</span><span class="w">
            </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="n">Member</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">member</span><span class="p" data-group-id="6969281993-77">{</span><span class="w">
                    </span><span class="ss">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NodeId</span><span class="p">,</span><span class="w">
                    </span><span class="ss">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Node</span><span class="p">,</span><span class="w">
                    </span><span class="ss">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">alive</span><span class="p">,</span><span class="w">
                    </span><span class="ss">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="6969281993-78">(</span><span class="ss">millisecond</span><span class="p" data-group-id="6969281993-78">)</span><span class="w">
                </span><span class="p" data-group-id="6969281993-77">}</span><span class="p">,</span><span class="w">
                </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="6969281993-79">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Member</span><span class="p">,</span><span class="w"> </span><span class="n">Acc</span><span class="p" data-group-id="6969281993-79">)</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="6969281993-73">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="6969281993-80">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="6969281993-81">{</span><span class="ss">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewMembers</span><span class="p" data-group-id="6969281993-81">}</span><span class="p" data-group-id="6969281993-80">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_cast</span><span class="p" data-group-id="6969281993-82">(</span><span class="p">_</span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-82">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="6969281993-83">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-83">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="6969281993-84">(</span><span class="ss">protocol_tick</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-84">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% SWIM protocol tick</span><span class="w">
    </span><span class="n">NewState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">swim_tick</span><span class="p" data-group-id="6969281993-85">(</span><span class="n">State</span><span class="p" data-group-id="6969281993-85">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Schedule next tick</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="6969281993-86">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">protocol_period</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="6969281993-87">(</span><span class="p" data-group-id="6969281993-87">)</span><span class="p">,</span><span class="w"> </span><span class="ss">protocol_tick</span><span class="p" data-group-id="6969281993-86">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="6969281993-88">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">NewState</span><span class="p" data-group-id="6969281993-88">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="6969281993-89">(</span><span class="p" data-group-id="6969281993-90">{</span><span class="ss">ping</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">Incarnation</span><span class="p" data-group-id="6969281993-90">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-89">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Respond to ping</span><span class="w">
    </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="6969281993-91">(</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-92">{</span><span class="ss">ack</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">local_member</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">incarnation</span><span class="p" data-group-id="6969281993-92">}</span><span class="p" data-group-id="6969281993-91">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6969281993-93">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-93">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="6969281993-94">(</span><span class="p" data-group-id="6969281993-95">{</span><span class="ss">ack</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Incarnation</span><span class="p" data-group-id="6969281993-95">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-94">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Received ack from ping</span><span class="w">
    </span><span class="p" data-group-id="6969281993-96">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-96">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="6969281993-97">(</span><span class="p" data-group-id="6969281993-98">{</span><span class="ss">ping_req</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p" data-group-id="6969281993-98">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-97">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Indirect ping request</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">ping</span><span class="p" data-group-id="6969281993-99">(</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p" data-group-id="6969281993-99">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">pong</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="6969281993-100">(</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-101">{</span><span class="ss">ping_req_ack</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="p" data-group-id="6969281993-101">}</span><span class="p" data-group-id="6969281993-100">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">timeout</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="6969281993-102">(</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-103">{</span><span class="ss">ping_req_timeout</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="p" data-group-id="6969281993-103">}</span><span class="p" data-group-id="6969281993-102">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6969281993-104">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-104">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%%% SWIM Protocol Implementation</span><span class="w">

</span><span class="nf">swim_tick</span><span class="p" data-group-id="6969281993-105">(</span><span class="n">State</span><span class="p" data-group-id="6969281993-105">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% 1. Select random member to ping</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">select_random_member</span><span class="p" data-group-id="6969281993-106">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-106">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="6969281993-107">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="p" data-group-id="6969281993-107">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nf">direct_ping</span><span class="p" data-group-id="6969281993-108">(</span><span class="n">Target</span><span class="p" data-group-id="6969281993-108">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">pong</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="c1">%% Update last_seen</span><span class="w">
                    </span><span class="nf">update_member_state</span><span class="p" data-group-id="6969281993-109">(</span><span class="n">Target</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="ss">alive</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-109">)</span><span class="p">;</span><span class="w">
                </span><span class="ss">timeout</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="c1">%% Try indirect ping via other members</span><span class="w">
                    </span><span class="k">case</span><span class="w"> </span><span class="nf">indirect_ping</span><span class="p" data-group-id="6969281993-110">(</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-110">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                            </span><span class="nf">update_member_state</span><span class="p" data-group-id="6969281993-111">(</span><span class="n">Target</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="ss">alive</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-111">)</span><span class="p">;</span><span class="w">
                        </span><span class="ss">failed</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                            </span><span class="c1">%% Mark as suspect</span><span class="w">
                            </span><span class="n">State1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">update_member_state</span><span class="p" data-group-id="6969281993-112">(</span><span class="n">Target</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="ss">suspect</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-112">)</span><span class="p">,</span><span class="w">
                            </span><span class="c1">%% Schedule suspicion timeout</span><span class="w">
                            </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="6969281993-113">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">suspect_timeout</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="6969281993-114">(</span><span class="p" data-group-id="6969281993-114">)</span><span class="p">,</span><span class="w">
                                </span><span class="p" data-group-id="6969281993-115">{</span><span class="ss">suspect_timeout</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p" data-group-id="6969281993-115">}</span><span class="p" data-group-id="6969281993-113">)</span><span class="p">,</span><span class="w">
                            </span><span class="n">State1</span><span class="w">
                    </span><span class="k">end</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="ss">error</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">State</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% 2. Gossip membership changes</span><span class="w">
    </span><span class="nf">gossip_changes</span><span class="p" data-group-id="6969281993-116">(</span><span class="n">State</span><span class="p" data-group-id="6969281993-116">)</span><span class="p">,</span><span class="w">

    </span><span class="n">State</span><span class="p">.</span><span class="w">

</span><span class="nf">direct_ping</span><span class="p" data-group-id="6969281993-117">(</span><span class="n">Target</span><span class="p" data-group-id="6969281993-117">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">ping</span><span class="p" data-group-id="6969281993-118">(</span><span class="n">Target</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="6969281993-118">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">pong</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">pong</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">timeout</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">indirect_ping</span><span class="p" data-group-id="6969281993-119">(</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-119">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Select K random members for indirect ping</span><span class="w">
    </span><span class="n">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">values</span><span class="p" data-group-id="6969281993-120">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-120">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Proxies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_random_n</span><span class="p" data-group-id="6969281993-121">(</span><span class="n">Members</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="6969281993-121">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Send ping_req to proxies</span><span class="w">
    </span><span class="n">Ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">make_ref</span><span class="p" data-group-id="6969281993-122">(</span><span class="p" data-group-id="6969281993-122">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="6969281993-123">(</span><span class="nf">fun</span><span class="p" data-group-id="6969281993-124">(</span><span class="n">Proxy</span><span class="p" data-group-id="6969281993-124">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="6969281993-125">(</span><span class="n">Proxy</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-126">{</span><span class="ss">ping_req</span><span class="p">,</span><span class="w"> </span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="6969281993-127">(</span><span class="p" data-group-id="6969281993-127">)</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="6969281993-126">}</span><span class="p" data-group-id="6969281993-125">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Proxies</span><span class="p" data-group-id="6969281993-123">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Wait for responses</span><span class="w">
    </span><span class="nf">wait_for_ping_req_responses</span><span class="p" data-group-id="6969281993-128">(</span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="mi">2000</span><span class="p" data-group-id="6969281993-128">)</span><span class="p">.</span><span class="w">

</span><span class="nf">wait_for_ping_req_responses</span><span class="p" data-group-id="6969281993-129">(</span><span class="p">_</span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Timeout</span><span class="p" data-group-id="6969281993-129">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">failed</span><span class="p">;</span><span class="w">
</span><span class="nf">wait_for_ping_req_responses</span><span class="p" data-group-id="6969281993-130">(</span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">Remaining</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="p" data-group-id="6969281993-130">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">receive</span><span class="w">
        </span><span class="p" data-group-id="6969281993-131">{</span><span class="ss">ping_req_ack</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="6969281993-131">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="6969281993-132">{</span><span class="ss">ping_req_timeout</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Target</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="6969281993-132">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nf">wait_for_ping_req_responses</span><span class="p" data-group-id="6969281993-133">(</span><span class="n">Ref</span><span class="p">,</span><span class="w"> </span><span class="n">Remaining</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="p" data-group-id="6969281993-133">)</span><span class="w">
    </span><span class="k">after</span><span class="w"> </span><span class="n">Timeout</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="ss">failed</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">gossip_changes</span><span class="p" data-group-id="6969281993-134">(</span><span class="n">State</span><span class="p" data-group-id="6969281993-134">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Select random peers for gossip</span><span class="w">
    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">values</span><span class="p" data-group-id="6969281993-135">(</span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-135">)</span><span class="p">,</span><span class="w">
    </span><span class="n">GossipTargets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_random_n</span><span class="p" data-group-id="6969281993-136">(</span><span class="n">Members</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="6969281993-136">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Get recent changes</span><span class="w">
    </span><span class="n">Changes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_recent_changes</span><span class="p" data-group-id="6969281993-137">(</span><span class="n">State</span><span class="p" data-group-id="6969281993-137">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Send to targets</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="6969281993-138">(</span><span class="nf">fun</span><span class="p" data-group-id="6969281993-139">(</span><span class="n">Target</span><span class="p" data-group-id="6969281993-139">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="6969281993-140">(</span><span class="n">Target</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6969281993-141">{</span><span class="ss">gossip</span><span class="p">,</span><span class="w"> </span><span class="n">Changes</span><span class="p" data-group-id="6969281993-141">}</span><span class="p" data-group-id="6969281993-140">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">GossipTargets</span><span class="p" data-group-id="6969281993-138">)</span><span class="p">.</span><span class="w">

</span><span class="nf">get_recent_changes</span><span class="p" data-group-id="6969281993-142">(</span><span class="n">State</span><span class="p" data-group-id="6969281993-142">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Get members that changed state recently (last 10 seconds)</span><span class="w">
    </span><span class="n">Now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="6969281993-143">(</span><span class="ss">millisecond</span><span class="p" data-group-id="6969281993-143">)</span><span class="p">,</span><span class="w">
    </span><span class="n">RecentWindow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">

    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">filter</span><span class="p" data-group-id="6969281993-144">(</span><span class="nf">fun</span><span class="p" data-group-id="6969281993-145">(</span><span class="p">_</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Member</span><span class="p" data-group-id="6969281993-145">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="6969281993-146">(</span><span class="n">Now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Member</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">last_seen</span><span class="p" data-group-id="6969281993-146">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">RecentWindow</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-144">)</span><span class="p">.</span><span class="w">

</span><span class="nf">update_member_state</span><span class="p" data-group-id="6969281993-147">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">NewState</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="6969281993-147">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">find</span><span class="p" data-group-id="6969281993-148">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-148">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="6969281993-149">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Member</span><span class="p" data-group-id="6969281993-149">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">UpdatedMember</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Member</span><span class="o">#</span><span class="ss">member</span><span class="p" data-group-id="6969281993-150">{</span><span class="w">
                </span><span class="ss">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewState</span><span class="p">,</span><span class="w">
                </span><span class="ss">last_seen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="6969281993-151">(</span><span class="ss">millisecond</span><span class="p" data-group-id="6969281993-151">)</span><span class="w">
            </span><span class="p" data-group-id="6969281993-150">}</span><span class="p">,</span><span class="w">
            </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="6969281993-152">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">UpdatedMember</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">members</span><span class="p" data-group-id="6969281993-152">)</span><span class="p">,</span><span class="w">
            </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="6969281993-153">{</span><span class="ss">members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Members</span><span class="p" data-group-id="6969281993-153">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">error</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">State</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">select_random_member</span><span class="p" data-group-id="6969281993-154">(</span><span class="n">Members</span><span class="p" data-group-id="6969281993-154">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">map_size</span><span class="p" data-group-id="6969281993-155">(</span><span class="n">Members</span><span class="p" data-group-id="6969281993-155">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">List</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">values</span><span class="p" data-group-id="6969281993-156">(</span><span class="n">Members</span><span class="p" data-group-id="6969281993-156">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="6969281993-157">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p" data-group-id="6969281993-158">(</span><span class="nc">rand</span><span class="p">:</span><span class="nf">uniform</span><span class="p" data-group-id="6969281993-159">(</span><span class="nf">length</span><span class="p" data-group-id="6969281993-160">(</span><span class="n">List</span><span class="p" data-group-id="6969281993-160">)</span><span class="p" data-group-id="6969281993-159">)</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="p" data-group-id="6969281993-158">)</span><span class="p" data-group-id="6969281993-157">}</span><span class="p">;</span><span class="w">
</span><span class="nf">select_random_member</span><span class="p" data-group-id="6969281993-161">(</span><span class="p">_</span><span class="p" data-group-id="6969281993-161">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">error</span><span class="p">.</span><span class="w">

</span><span class="nf">select_random_n</span><span class="p" data-group-id="6969281993-162">(</span><span class="n">List</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p" data-group-id="6969281993-162">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="6969281993-163">(</span><span class="n">List</span><span class="p" data-group-id="6969281993-163">)</span><span class="w"> </span><span class="o">=&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">List</span><span class="p">;</span><span class="w">
</span><span class="nf">select_random_n</span><span class="p" data-group-id="6969281993-164">(</span><span class="n">List</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p" data-group-id="6969281993-164">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Shuffle and take N</span><span class="w">
    </span><span class="n">Shuffled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6969281993-165">[</span><span class="n">X</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="6969281993-166">{</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">X</span><span class="p" data-group-id="6969281993-166">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p" data-group-id="6969281993-167">(</span><span class="p" data-group-id="6969281993-168">[</span><span class="p" data-group-id="6969281993-169">{</span><span class="nc">rand</span><span class="p">:</span><span class="nf">uniform</span><span class="p" data-group-id="6969281993-170">(</span><span class="p" data-group-id="6969281993-170">)</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p" data-group-id="6969281993-169">}</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">List</span><span class="p" data-group-id="6969281993-168">]</span><span class="p" data-group-id="6969281993-167">)</span><span class="p" data-group-id="6969281993-165">]</span><span class="p">,</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sublist</span><span class="p" data-group-id="6969281993-171">(</span><span class="n">Shuffled</span><span class="p">,</span><span class="w"> </span><span class="n">N</span><span class="p" data-group-id="6969281993-171">)</span><span class="p">.</span></code></pre><hr class="thin"/><h4>Week 7: Topology Management and Routing</h4><p><strong>Objectives:</strong></p><ol><li>Implement k-regular graph topology</li><li>Build DHT-based routing</li><li>Optimize for low diameter</li></ol><p><strong>Topology Manager:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_topology.erl</span><span class="w">
</span><span class="c1">%% Manages connection topology using k-regular graph</span><span class="w">
</span><span class="c1">%% Each node maintains K connections to neighbors on consistent hash ring</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="7050575662-1">(</span><span class="ss">macula_topology</span><span class="p" data-group-id="7050575662-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="7050575662-2">(</span><span class="ss">gen_server</span><span class="p" data-group-id="7050575662-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7050575662-3">(</span><span class="p" data-group-id="7050575662-4">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">maintain</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">get_neighbors</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="7050575662-4">]</span><span class="p" data-group-id="7050575662-3">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="7050575662-5">(</span><span class="p" data-group-id="7050575662-6">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_call</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_cast</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_info</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="7050575662-6">]</span><span class="p" data-group-id="7050575662-5">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="7050575662-7">(</span><span class="n">K_NEIGHBORS</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p" data-group-id="7050575662-7">)</span><span class="p">.</span><span class="w">  </span><span class="c1">%% Number of neighbors to maintain</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="7050575662-8">(</span><span class="ss">state</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-9">{</span><span class="w">
    </span><span class="ss">neighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7050575662-10">[</span><span class="p" data-group-id="7050575662-10">]</span><span class="p">,</span><span class="w">         </span><span class="c1">%% Current neighbor connections</span><span class="w">
    </span><span class="ss">desired_neighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7050575662-11">[</span><span class="p" data-group-id="7050575662-11">]</span><span class="p">,</span><span class="w"> </span><span class="c1">%% Neighbors we should connect to</span><span class="w">
    </span><span class="ss">ring_position</span><span class="w">          </span><span class="c1">%% Our position on hash ring</span><span class="w">
</span><span class="p" data-group-id="7050575662-9">}</span><span class="p" data-group-id="7050575662-8">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="7050575662-12">(</span><span class="p" data-group-id="7050575662-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="7050575662-13">(</span><span class="p" data-group-id="7050575662-14">{</span><span class="ss">local</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p" data-group-id="7050575662-14">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-15">[</span><span class="p" data-group-id="7050575662-15">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-16">[</span><span class="p" data-group-id="7050575662-16">]</span><span class="p" data-group-id="7050575662-13">)</span><span class="p">.</span><span class="w">

</span><span class="nf">maintain</span><span class="p" data-group-id="7050575662-17">(</span><span class="p" data-group-id="7050575662-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="7050575662-18">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">maintain</span><span class="p" data-group-id="7050575662-18">)</span><span class="p">.</span><span class="w">

</span><span class="nf">get_neighbors</span><span class="p" data-group-id="7050575662-19">(</span><span class="p" data-group-id="7050575662-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="7050575662-20">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">get_neighbors</span><span class="p" data-group-id="7050575662-20">)</span><span class="p">.</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="7050575662-21">(</span><span class="p" data-group-id="7050575662-22">[</span><span class="p" data-group-id="7050575662-22">]</span><span class="p" data-group-id="7050575662-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Calculate our position on hash ring</span><span class="w">
    </span><span class="n">NodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="7050575662-23">(</span><span class="p" data-group-id="7050575662-23">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="7050575662-24">(</span><span class="ss">sha256</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-24">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Start maintenance timer</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="7050575662-25">(</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="7050575662-26">(</span><span class="p" data-group-id="7050575662-26">)</span><span class="p">,</span><span class="w"> </span><span class="ss">maintain</span><span class="p" data-group-id="7050575662-25">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="7050575662-27">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="7050575662-28">{</span><span class="ss">ring_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Position</span><span class="p" data-group-id="7050575662-28">}</span><span class="p" data-group-id="7050575662-27">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="7050575662-29">(</span><span class="ss">get_neighbors</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="7050575662-29">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="7050575662-30">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">neighbors</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="7050575662-30">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="7050575662-31">(</span><span class="ss">maintain</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="7050575662-31">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">maintain_topology</span><span class="p" data-group-id="7050575662-32">(</span><span class="n">State</span><span class="p" data-group-id="7050575662-32">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="7050575662-33">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">NewState</span><span class="p" data-group-id="7050575662-33">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_cast</span><span class="p" data-group-id="7050575662-34">(</span><span class="p">_</span><span class="n">Msg</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="7050575662-34">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="7050575662-35">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="7050575662-35">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="7050575662-36">(</span><span class="ss">maintain</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="7050575662-36">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">NewState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">maintain_topology</span><span class="p" data-group-id="7050575662-37">(</span><span class="n">State</span><span class="p" data-group-id="7050575662-37">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="7050575662-38">(</span><span class="mi">5000</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="7050575662-39">(</span><span class="p" data-group-id="7050575662-39">)</span><span class="p">,</span><span class="w"> </span><span class="ss">maintain</span><span class="p" data-group-id="7050575662-38">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="7050575662-40">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">NewState</span><span class="p" data-group-id="7050575662-40">}</span><span class="p">.</span><span class="w">

</span><span class="nf">maintain_topology</span><span class="p" data-group-id="7050575662-41">(</span><span class="n">State</span><span class="p" data-group-id="7050575662-41">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Get all known members</span><span class="w">
    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_membership</span><span class="p">:</span><span class="nf">get_members</span><span class="p" data-group-id="7050575662-42">(</span><span class="p" data-group-id="7050575662-42">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Select desired neighbors using consistent hashing</span><span class="w">
    </span><span class="n">DesiredNeighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_neighbors</span><span class="p" data-group-id="7050575662-43">(</span><span class="n">Members</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">K_NEIGHBORS</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">ring_position</span><span class="p" data-group-id="7050575662-43">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Current connections</span><span class="w">
    </span><span class="n">CurrentNeighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p">.</span><span class="ss">neighbors</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Find missing connections</span><span class="w">
    </span><span class="n">Missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DesiredNeighbors</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">CurrentNeighbors</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Find extra connections (if we&#39;re over K neighbors)</span><span class="w">
    </span><span class="n">Extra</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CurrentNeighbors</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">DesiredNeighbors</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Connect to missing</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="7050575662-44">(</span><span class="nf">fun</span><span class="p" data-group-id="7050575662-45">(</span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-45">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="7050575662-46">(</span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-46">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="7050575662-47">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Conn</span><span class="p" data-group-id="7050575662-47">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="7050575662-48">(</span><span class="s">&quot;Connected to neighbor: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-49">[</span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-49">]</span><span class="p" data-group-id="7050575662-48">)</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="7050575662-50">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="7050575662-50">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="7050575662-51">(</span><span class="s">&quot;Failed to connect to </span><span class="si">~p</span><span class="s">: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-52">[</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="7050575662-52">]</span><span class="p" data-group-id="7050575662-51">)</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Missing</span><span class="p" data-group-id="7050575662-44">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Disconnect extra (if too many connections)</span><span class="w">
    </span><span class="k">if</span><span class="w">
        </span><span class="nf">length</span><span class="p" data-group-id="7050575662-53">(</span><span class="n">CurrentNeighbors</span><span class="p" data-group-id="7050575662-53">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">?</span><span class="n">K_NEIGHBORS</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="7050575662-54">(</span><span class="nf">fun</span><span class="p" data-group-id="7050575662-55">(</span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-55">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">disconnect</span><span class="p" data-group-id="7050575662-56">(</span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-56">)</span><span class="w">
            </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Extra</span><span class="p" data-group-id="7050575662-54">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Update state</span><span class="w">
    </span><span class="n">NewNeighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7050575662-57">(</span><span class="n">CurrentNeighbors</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">Missing</span><span class="p" data-group-id="7050575662-57">)</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">Extra</span><span class="p">,</span><span class="w">
    </span><span class="n">State</span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="7050575662-58">{</span><span class="w">
        </span><span class="ss">neighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NewNeighbors</span><span class="p">,</span><span class="w">
        </span><span class="ss">desired_neighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DesiredNeighbors</span><span class="w">
    </span><span class="p" data-group-id="7050575662-58">}</span><span class="p">.</span><span class="w">

</span><span class="nf">select_neighbors</span><span class="p" data-group-id="7050575662-59">(</span><span class="n">Members</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">MyPosition</span><span class="p" data-group-id="7050575662-59">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Place all members on hash ring</span><span class="w">
    </span><span class="n">Ring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">map</span><span class="p" data-group-id="7050575662-60">(</span><span class="nf">fun</span><span class="p" data-group-id="7050575662-61">(</span><span class="n">Member</span><span class="p" data-group-id="7050575662-61">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">NodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Member</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w">
        </span><span class="n">Position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="7050575662-62">(</span><span class="ss">sha256</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-62">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="7050575662-63">{</span><span class="n">Position</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-63">}</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Members</span><span class="p" data-group-id="7050575662-60">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Sort by position</span><span class="w">
    </span><span class="n">SortedRing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p" data-group-id="7050575662-64">(</span><span class="n">Ring</span><span class="p" data-group-id="7050575662-64">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Find our position</span><span class="w">
    </span><span class="n">MyIndex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-65">(</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="n">SortedRing</span><span class="p" data-group-id="7050575662-65">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Select K clockwise neighbors (for redundancy, select K/2 clockwise + K/2 counter-clockwise)</span><span class="w">
    </span><span class="n">ClockwiseCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="ow">div</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="n">CounterClockwiseCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ClockwiseCount</span><span class="p">,</span><span class="w">

    </span><span class="n">Clockwise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_clockwise</span><span class="p" data-group-id="7050575662-66">(</span><span class="n">MyIndex</span><span class="p">,</span><span class="w"> </span><span class="n">ClockwiseCount</span><span class="p">,</span><span class="w"> </span><span class="n">SortedRing</span><span class="p" data-group-id="7050575662-66">)</span><span class="p">,</span><span class="w">
    </span><span class="n">CounterClockwise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_counter_clockwise</span><span class="p" data-group-id="7050575662-67">(</span><span class="n">MyIndex</span><span class="p">,</span><span class="w"> </span><span class="n">CounterClockwiseCount</span><span class="p">,</span><span class="w"> </span><span class="n">SortedRing</span><span class="p" data-group-id="7050575662-67">)</span><span class="p">,</span><span class="w">

    </span><span class="n">Clockwise</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">CounterClockwise</span><span class="p">.</span><span class="w">

</span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-68">(</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-68">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-69">(</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="7050575662-69">)</span><span class="p">.</span><span class="w">

</span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-70">(</span><span class="p">_</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-71">[</span><span class="p" data-group-id="7050575662-71">]</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Index</span><span class="p" data-group-id="7050575662-70">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-72">(</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-73">[</span><span class="p" data-group-id="7050575662-74">{</span><span class="n">Position</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-74">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="n">Rest</span><span class="p" data-group-id="7050575662-73">]</span><span class="p">,</span><span class="w"> </span><span class="n">Index</span><span class="p" data-group-id="7050575662-72">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="n">Position</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">MyPosition</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Index</span><span class="p">;</span><span class="w">
</span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-75">(</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-76">[</span><span class="p">_</span><span class="n">H</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="n">Rest</span><span class="p" data-group-id="7050575662-76">]</span><span class="p">,</span><span class="w"> </span><span class="n">Index</span><span class="p" data-group-id="7050575662-75">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">find_position</span><span class="p" data-group-id="7050575662-77">(</span><span class="n">MyPosition</span><span class="p">,</span><span class="w"> </span><span class="n">Rest</span><span class="p">,</span><span class="w"> </span><span class="n">Index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7050575662-77">)</span><span class="p">.</span><span class="w">

</span><span class="nf">select_clockwise</span><span class="p" data-group-id="7050575662-78">(</span><span class="n">MyIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-78">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">RingSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="7050575662-79">(</span><span class="n">Ring</span><span class="p" data-group-id="7050575662-79">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7050575662-80">[</span><span class="p" data-group-id="7050575662-81">(</span><span class="n">MyIndex</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">I</span><span class="p" data-group-id="7050575662-81">)</span><span class="w"> </span><span class="ow">rem</span><span class="w"> </span><span class="n">RingSize</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p" data-group-id="7050575662-82">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Count</span><span class="p" data-group-id="7050575662-82">)</span><span class="p" data-group-id="7050575662-80">]</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="7050575662-83">[</span><span class="n">NodeId</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="7050575662-84">{</span><span class="n">Idx</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-85">{</span><span class="p">_</span><span class="n">Pos</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-85">}</span><span class="p" data-group-id="7050575662-84">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">zip</span><span class="p" data-group-id="7050575662-86">(</span><span class="n">Indices</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-86">)</span><span class="p">,</span><span class="w"> </span><span class="n">Idx</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="nf">element</span><span class="p" data-group-id="7050575662-87">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p" data-group-id="7050575662-88">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">zip</span><span class="p" data-group-id="7050575662-89">(</span><span class="nc">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p" data-group-id="7050575662-90">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RingSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7050575662-90">)</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-89">)</span><span class="p" data-group-id="7050575662-88">)</span><span class="p" data-group-id="7050575662-87">)</span><span class="p" data-group-id="7050575662-83">]</span><span class="p">.</span><span class="w">

</span><span class="nf">select_counter_clockwise</span><span class="p" data-group-id="7050575662-91">(</span><span class="n">MyIndex</span><span class="p">,</span><span class="w"> </span><span class="n">Count</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-91">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">RingSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="7050575662-92">(</span><span class="n">Ring</span><span class="p" data-group-id="7050575662-92">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7050575662-93">[</span><span class="p" data-group-id="7050575662-94">(</span><span class="n">MyIndex</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">RingSize</span><span class="p" data-group-id="7050575662-94">)</span><span class="w"> </span><span class="ow">rem</span><span class="w"> </span><span class="n">RingSize</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p" data-group-id="7050575662-95">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Count</span><span class="p" data-group-id="7050575662-95">)</span><span class="p" data-group-id="7050575662-93">]</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="7050575662-96">[</span><span class="n">NodeId</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="7050575662-97">{</span><span class="n">Idx</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7050575662-98">{</span><span class="p">_</span><span class="n">Pos</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="7050575662-98">}</span><span class="p" data-group-id="7050575662-97">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">zip</span><span class="p" data-group-id="7050575662-99">(</span><span class="n">Indices</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-99">)</span><span class="p">,</span><span class="w"> </span><span class="n">Idx</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="nf">element</span><span class="p" data-group-id="7050575662-100">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p" data-group-id="7050575662-101">(</span><span class="n">Idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">zip</span><span class="p" data-group-id="7050575662-102">(</span><span class="nc">lists</span><span class="p">:</span><span class="nf">seq</span><span class="p" data-group-id="7050575662-103">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">RingSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7050575662-103">)</span><span class="p">,</span><span class="w"> </span><span class="n">Ring</span><span class="p" data-group-id="7050575662-102">)</span><span class="p" data-group-id="7050575662-101">)</span><span class="p" data-group-id="7050575662-100">)</span><span class="p" data-group-id="7050575662-96">]</span><span class="p">.</span></code></pre><p><strong>DHT Routing:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% File: macula_routing.erl</span><span class="w">
</span><span class="c1">%% Kademlia-inspired DHT routing for mesh</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="1628611784-1">(</span><span class="ss">macula_routing</span><span class="p" data-group-id="1628611784-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1628611784-2">(</span><span class="p" data-group-id="1628611784-3">[</span><span class="ss">route</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">find_node</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">find_closest_nodes</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="1628611784-3">]</span><span class="p" data-group-id="1628611784-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="1628611784-4">(</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p" data-group-id="1628611784-4">)</span><span class="p">.</span><span class="w">  </span><span class="c1">%% Replication factor</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="1628611784-5">(</span><span class="n">ALPHA</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="1628611784-5">)</span><span class="p">.</span><span class="w">  </span><span class="c1">%% Concurrency parameter</span><span class="w">

</span><span class="c1">%% Route message to destination node</span><span class="w">
</span><span class="nf">route</span><span class="p" data-group-id="1628611784-6">(</span><span class="n">DestNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1628611784-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">is_connected</span><span class="p" data-group-id="1628611784-7">(</span><span class="n">DestNodeId</span><span class="p" data-group-id="1628611784-7">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Direct connection, send immediately</span><span class="w">
            </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="1628611784-8">(</span><span class="n">DestNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1628611784-8">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Find next hop via DHT</span><span class="w">
            </span><span class="n">NextHop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">find_next_hop</span><span class="p" data-group-id="1628611784-9">(</span><span class="n">DestNodeId</span><span class="p" data-group-id="1628611784-9">)</span><span class="p">,</span><span class="w">
            </span><span class="nf">forward</span><span class="p" data-group-id="1628611784-10">(</span><span class="n">NextHop</span><span class="p">,</span><span class="w"> </span><span class="n">DestNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1628611784-10">)</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Find next hop closer to destination</span><span class="w">
</span><span class="nf">find_next_hop</span><span class="p" data-group-id="1628611784-11">(</span><span class="n">DestNodeId</span><span class="p" data-group-id="1628611784-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">MyNodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="1628611784-12">(</span><span class="p" data-group-id="1628611784-12">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Get connected neighbors</span><span class="w">
    </span><span class="n">Neighbors</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_topology</span><span class="p">:</span><span class="nf">get_neighbors</span><span class="p" data-group-id="1628611784-13">(</span><span class="p" data-group-id="1628611784-13">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Calculate XOR distance from each neighbor to destination</span><span class="w">
    </span><span class="n">Distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">map</span><span class="p" data-group-id="1628611784-14">(</span><span class="nf">fun</span><span class="p" data-group-id="1628611784-15">(</span><span class="n">NeighborId</span><span class="p" data-group-id="1628611784-15">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">Dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-16">(</span><span class="n">NeighborId</span><span class="p">,</span><span class="w"> </span><span class="n">DestNodeId</span><span class="p" data-group-id="1628611784-16">)</span><span class="p">,</span><span class="w">
        </span><span class="p" data-group-id="1628611784-17">{</span><span class="n">Dist</span><span class="p">,</span><span class="w"> </span><span class="n">NeighborId</span><span class="p" data-group-id="1628611784-17">}</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Neighbors</span><span class="p" data-group-id="1628611784-14">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Sort by distance (closest first)</span><span class="w">
    </span><span class="n">Sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p" data-group-id="1628611784-18">(</span><span class="n">Distances</span><span class="p" data-group-id="1628611784-18">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Return closest neighbor</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="n">Sorted</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1628611784-19">[</span><span class="p" data-group-id="1628611784-20">{</span><span class="p">_</span><span class="n">Dist</span><span class="p">,</span><span class="w"> </span><span class="n">NextHop</span><span class="p" data-group-id="1628611784-20">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1628611784-19">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Check if NextHop is closer than us</span><span class="w">
            </span><span class="n">MyDist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-21">(</span><span class="n">MyNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">DestNodeId</span><span class="p" data-group-id="1628611784-21">)</span><span class="p">,</span><span class="w">
            </span><span class="k">if</span><span class="w">
                </span><span class="p">_</span><span class="n">Dist</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">MyDist</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">NextHop</span><span class="p">;</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">DestNodeId</span><span class="w">  </span><span class="c1">%% We&#39;re closest, destination must be dead</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1628611784-22">[</span><span class="p" data-group-id="1628611784-22">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% No neighbors, can&#39;t route</span><span class="w">
            </span><span class="p" data-group-id="1628611784-23">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_route</span><span class="p" data-group-id="1628611784-23">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Forward message to next hop</span><span class="w">
</span><span class="nf">forward</span><span class="p" data-group-id="1628611784-24">(</span><span class="n">NextHop</span><span class="p">,</span><span class="w"> </span><span class="n">FinalDest</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1628611784-24">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">ForwardMsg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1628611784-25">{</span><span class="ss">forward</span><span class="p">,</span><span class="w"> </span><span class="n">FinalDest</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1628611784-25">}</span><span class="p">,</span><span class="w">
    </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="1628611784-26">(</span><span class="n">NextHop</span><span class="p">,</span><span class="w"> </span><span class="n">ForwardMsg</span><span class="p" data-group-id="1628611784-26">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% XOR distance metric (like Kademlia)</span><span class="w">
</span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-27">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="1628611784-27">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_binary</span><span class="p" data-group-id="1628611784-28">(</span><span class="n">A</span><span class="p" data-group-id="1628611784-28">)</span><span class="p">,</span><span class="w"> </span><span class="nf">is_binary</span><span class="p" data-group-id="1628611784-29">(</span><span class="n">B</span><span class="p" data-group-id="1628611784-29">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">bytes_to_integer</span><span class="p" data-group-id="1628611784-30">(</span><span class="nc">crypto</span><span class="p">:</span><span class="nf">exor</span><span class="p" data-group-id="1628611784-31">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="1628611784-31">)</span><span class="p" data-group-id="1628611784-30">)</span><span class="p">;</span><span class="w">
</span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-32">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="1628611784-32">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-33">(</span><span class="nf">term_to_binary</span><span class="p" data-group-id="1628611784-34">(</span><span class="n">A</span><span class="p" data-group-id="1628611784-34">)</span><span class="p">,</span><span class="w"> </span><span class="nf">term_to_binary</span><span class="p" data-group-id="1628611784-35">(</span><span class="n">B</span><span class="p" data-group-id="1628611784-35">)</span><span class="p" data-group-id="1628611784-33">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Find node by ID (iterative lookup)</span><span class="w">
</span><span class="nf">find_node</span><span class="p" data-group-id="1628611784-36">(</span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-36">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">find_node</span><span class="p" data-group-id="1628611784-37">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1628611784-38">[</span><span class="p" data-group-id="1628611784-38">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1628611784-39">[</span><span class="nc">macula_identity</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="1628611784-40">(</span><span class="p" data-group-id="1628611784-40">)</span><span class="p" data-group-id="1628611784-39">]</span><span class="p" data-group-id="1628611784-37">)</span><span class="p">.</span><span class="w">

</span><span class="nf">find_node</span><span class="p" data-group-id="1628611784-41">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="n">Closest</span><span class="p" data-group-id="1628611784-41">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Select ALPHA closest unqueried nodes</span><span class="w">
    </span><span class="n">ToQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_unqueried</span><span class="p" data-group-id="1628611784-42">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">ALPHA</span><span class="p" data-group-id="1628611784-42">)</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="n">ToQuery</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1628611784-43">[</span><span class="p" data-group-id="1628611784-43">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% No more nodes to query, return closest</span><span class="w">
            </span><span class="p" data-group-id="1628611784-44">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sublist</span><span class="p" data-group-id="1628611784-45">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">K</span><span class="p" data-group-id="1628611784-45">)</span><span class="p" data-group-id="1628611784-44">}</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Query nodes in parallel</span><span class="w">
            </span><span class="n">Results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">query_nodes</span><span class="p" data-group-id="1628611784-46">(</span><span class="n">ToQuery</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-46">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Merge results</span><span class="w">
            </span><span class="n">NewClosest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge_and_sort</span><span class="p" data-group-id="1628611784-47">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">Results</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-47">)</span><span class="p">,</span><span class="w">
            </span><span class="n">NewQueried</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Queried</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">ToQuery</span><span class="p">,</span><span class="w">

            </span><span class="c1">%% Check if we found target</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">member</span><span class="p" data-group-id="1628611784-48">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">NewClosest</span><span class="p" data-group-id="1628611784-48">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1628611784-49">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-49">}</span><span class="p">;</span><span class="w">
                </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">find_node</span><span class="p" data-group-id="1628611784-50">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">NewQueried</span><span class="p">,</span><span class="w"> </span><span class="n">NewClosest</span><span class="p" data-group-id="1628611784-50">)</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">query_nodes</span><span class="p" data-group-id="1628611784-51">(</span><span class="n">Nodes</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-51">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Query each node for closer nodes</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">flatmap</span><span class="p" data-group-id="1628611784-52">(</span><span class="nf">fun</span><span class="p" data-group-id="1628611784-53">(</span><span class="n">NodeId</span><span class="p" data-group-id="1628611784-53">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_rpc</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="1628611784-54">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">find_closest_nodes</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1628611784-55">[</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">K</span><span class="p" data-group-id="1628611784-55">]</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="1628611784-54">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="1628611784-56">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="1628611784-56">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Nodes</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="1628611784-57">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="1628611784-57">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="1628611784-58">[</span><span class="p" data-group-id="1628611784-58">]</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="1628611784-52">)</span><span class="p">.</span><span class="w">

</span><span class="nf">find_closest_nodes</span><span class="p" data-group-id="1628611784-59">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="1628611784-59">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Return K closest known nodes to TargetId</span><span class="w">
    </span><span class="n">Members</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_membership</span><span class="p">:</span><span class="nf">get_members</span><span class="p" data-group-id="1628611784-60">(</span><span class="p" data-group-id="1628611784-60">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1628611784-61">[</span><span class="p" data-group-id="1628611784-62">{</span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-63">(</span><span class="n">M</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-63">)</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="o">#</span><span class="ss">member</span><span class="p">.</span><span class="ss">node_id</span><span class="p" data-group-id="1628611784-62">}</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Members</span><span class="p" data-group-id="1628611784-61">]</span><span class="p">,</span><span class="w">
    </span><span class="n">Sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p" data-group-id="1628611784-64">(</span><span class="n">Distances</span><span class="p" data-group-id="1628611784-64">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1628611784-65">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1628611784-66">[</span><span class="n">NodeId</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="1628611784-67">{</span><span class="p">_</span><span class="n">Dist</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="1628611784-67">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sublist</span><span class="p" data-group-id="1628611784-68">(</span><span class="n">Sorted</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="1628611784-68">)</span><span class="p" data-group-id="1628611784-66">]</span><span class="p" data-group-id="1628611784-65">}</span><span class="p">.</span><span class="w">

</span><span class="nf">select_unqueried</span><span class="p" data-group-id="1628611784-69">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="n">Alpha</span><span class="p" data-group-id="1628611784-69">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Unqueried</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Closest</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sublist</span><span class="p" data-group-id="1628611784-70">(</span><span class="n">Unqueried</span><span class="p">,</span><span class="w"> </span><span class="n">Alpha</span><span class="p" data-group-id="1628611784-70">)</span><span class="p">.</span><span class="w">

</span><span class="nf">merge_and_sort</span><span class="p" data-group-id="1628611784-71">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">New</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-71">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">All</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">usort</span><span class="p" data-group-id="1628611784-72">(</span><span class="n">Closest</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">New</span><span class="p" data-group-id="1628611784-72">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Distances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="1628611784-73">[</span><span class="p" data-group-id="1628611784-74">{</span><span class="nf">xor_distance</span><span class="p" data-group-id="1628611784-75">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="1628611784-75">)</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="1628611784-74">}</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="n">NodeId</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">All</span><span class="p" data-group-id="1628611784-73">]</span><span class="p">,</span><span class="w">
    </span><span class="n">Sorted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p" data-group-id="1628611784-76">(</span><span class="n">Distances</span><span class="p" data-group-id="1628611784-76">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1628611784-77">[</span><span class="n">NodeId</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="1628611784-78">{</span><span class="p">_</span><span class="n">Dist</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="1628611784-78">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Sorted</span><span class="p" data-group-id="1628611784-77">]</span><span class="p">.</span></code></pre><hr class="thin"/><p>(Continuing in next section due to length...)</p><h3 id="phase-3-nat-traversal-weeks-9-12" class="section-heading"><a href="#phase-3-nat-traversal-weeks-9-12" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 3: NAT Traversal (Weeks 9-12)</span></h3><h3 id="phase-4-wamp-layer-weeks-13-16" class="section-heading"><a href="#phase-4-wamp-layer-weeks-13-16" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 4: WAMP Layer (Weeks 13-16)</span></h3><h3 id="phase-5-production-hardening-weeks-17-20" class="section-heading"><a href="#phase-5-production-hardening-weeks-17-20" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 5: Production Hardening (Weeks 17-20)</span></h3><hr class="thin"/><h2 id="architecture-diagrams" class="section-heading"><a href="#architecture-diagrams" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture Diagrams</span></h2><h3 id="1-system-architecture" class="section-heading"><a href="#1-system-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. System Architecture</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">                         </span><span class="n">Macula</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="n">Network</span><span class="w">                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Internet</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">WAN</span><span class="w">                                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                                                              </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">          </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">          </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="w">  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="w">  </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">C</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="0690487434-1">(</span><span class="n">USA</span><span class="p" data-group-id="0690487434-1">)</span><span class="w">   </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="0690487434-2">(</span><span class="n">Europe</span><span class="p" data-group-id="0690487434-2">)</span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="0690487434-3">(</span><span class="n">Asia</span><span class="p" data-group-id="0690487434-3">)</span><span class="w">  </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">          </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">          </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┼</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">          </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">                                </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                   </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p" data-group-id="0690487434-4">(</span><span class="n">QUIC</span><span class="o">/</span><span class="n">UDP</span><span class="p" data-group-id="0690487434-4">)</span><span class="w">                         </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">                     </span><span class="n">Port</span><span class="w"> </span><span class="mi">443</span><span class="o">/</span><span class="n">UDP</span><span class="w">                            </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">NAT</span><span class="o">/</span><span class="n">Firewall</span><span class="w"> </span><span class="n">Traversal</span><span class="p">:</span><span class="w">                                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">STUN</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">public</span><span class="w"> </span><span class="ss">address</span><span class="w"> </span><span class="ss">discovery</span><span class="w">                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">ICE</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">connectivity</span><span class="w"> </span><span class="ss">checks</span><span class="w">                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">UDP</span><span class="w"> </span><span class="ss">hole</span><span class="w"> </span><span class="ss">punching</span><span class="w">                                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="ss">relay</span><span class="w"> </span><span class="ss">as</span><span class="w"> </span><span class="ss">fallback</span><span class="w">                                          </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="2-node-internal-architecture" class="section-heading"><a href="#2-node-internal-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Node Internal Architecture</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Macula</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="p" data-group-id="8251629002-1">(</span><span class="n">BEAM</span><span class="w"> </span><span class="n">VM</span><span class="p" data-group-id="8251629002-1">)</span><span class="w">                                               </span><span class="err">│</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">Layer</span><span class="w">                                          </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Elixir</span><span class="o">/</span><span class="n">Erlang</span><span class="w"> </span><span class="n">Apps</span><span class="w">                                      </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="nb">spawn</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">send</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nb">monitor</span><span class="p">/</span><span class="mi">2</span><span class="w">                             </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Transparent</span><span class="w"> </span><span class="ss">distribution</span><span class="w">                                </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">↓</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">WAMP</span><span class="w"> </span><span class="n">Compatibility</span><span class="w"> </span><span class="n">Layer</span><span class="w"> </span><span class="p" data-group-id="8251629002-2">(</span><span class="n">Optional</span><span class="p" data-group-id="8251629002-2">)</span><span class="w">                        </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="ss">publish</span><span class="o">/</span><span class="ss">subscribe</span><span class="w">                                       </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="ss">call</span><span class="o">/</span><span class="nf">register</span><span class="w"> </span><span class="p" data-group-id="8251629002-3">(</span><span class="n">RPC</span><span class="p" data-group-id="8251629002-3">)</span><span class="w">                                     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">↓</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Mesh</span><span class="w"> </span><span class="n">Services</span><span class="w">                                              </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Discovery</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Membership</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Topology</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8251629002-4">(</span><span class="n">Bootstrap</span><span class="p">,</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8251629002-5">(</span><span class="n">SWIM</span><span class="w">        </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8251629002-6">(</span><span class="ss">k</span><span class="o">-</span><span class="ss">regular</span><span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="ss">mDNS</span><span class="p">,</span><span class="w"> </span><span class="n">DNS</span><span class="p" data-group-id="8251629002-6">)</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Gossip</span><span class="p" data-group-id="8251629002-5">)</span><span class="w">     </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="ss">graph</span><span class="p" data-group-id="8251629002-4">)</span><span class="w">      </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Routing</span><span class="w">      </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Pub</span><span class="o">/</span><span class="n">Sub</span><span class="w">      </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">RPC</span><span class="w">          </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8251629002-7">(</span><span class="n">DHT</span><span class="p">,</span><span class="w">        </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8251629002-8">(</span><span class="n">Topic</span><span class="o">-</span><span class="ss">based</span><span class="w"> </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8251629002-9">(</span><span class="n">Request</span><span class="o">/</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Kademlia</span><span class="p" data-group-id="8251629002-9">)</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Registry</span><span class="p" data-group-id="8251629002-8">)</span><span class="w">   </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Response</span><span class="p" data-group-id="8251629002-7">)</span><span class="w">   </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">↓</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">Macula</span><span class="w"> </span><span class="n">Distribution</span><span class="w"> </span><span class="n">Protocol</span><span class="w">                               </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="nf">framing</span><span class="w"> </span><span class="p" data-group-id="8251629002-10">(</span><span class="ss">wire</span><span class="w"> </span><span class="ss">protocol</span><span class="p" data-group-id="8251629002-10">)</span><span class="w">                         </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Handshake</span><span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="ss">authentication</span><span class="w">                              </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="ss">multiplexing</span><span class="w">                                     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Process</span><span class="w"> </span><span class="err">↔</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="ss">mapping</span><span class="w">                               </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">↓</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Transport</span><span class="w"> </span><span class="p" data-group-id="8251629002-11">(</span><span class="ss">via</span><span class="w"> </span><span class="ss">quicer</span><span class="w"> </span><span class="n">NIF</span><span class="p" data-group-id="8251629002-11">)</span><span class="w">                            </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">MsQuic</span><span class="w"> </span><span class="p" data-group-id="8251629002-12">(</span><span class="n">C</span><span class="w"> </span><span class="ss">library</span><span class="p" data-group-id="8251629002-12">)</span><span class="w">                                </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">RFC</span><span class="w"> </span><span class="mi">9000</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">implementation</span><span class="w">                   </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="mf">1.3</span><span class="w"> </span><span class="ss">integrated</span><span class="w">                             </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Streams</span><span class="p">,</span><span class="w"> </span><span class="ss">flow</span><span class="w"> </span><span class="ss">control</span><span class="p">,</span><span class="w"> </span><span class="ss">congestion</span><span class="w"> </span><span class="ss">control</span><span class="w">      </span><span class="err">│</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">     </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                             </span><span class="err">↓</span><span class="w">                                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">UDP</span><span class="w"> </span><span class="n">Sockets</span><span class="w"> </span><span class="p" data-group-id="8251629002-13">(</span><span class="n">OS</span><span class="w"> </span><span class="n">Network</span><span class="w"> </span><span class="n">Stack</span><span class="p" data-group-id="8251629002-13">)</span><span class="w">                             </span><span class="err">│</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="3-message-flow-diagram" class="section-heading"><a href="#3-message-flow-diagram" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Message Flow Diagram</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Process</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p" data-group-id="2351075960-1">(</span><span class="n">Node</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2351075960-1">)</span><span class="w">                                  </span><span class="n">Process</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p" data-group-id="2351075960-2">(</span><span class="n">Node</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="2351075960-2">)</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="n">Pid</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="n">Message</span><span class="w">                                     </span><span class="err">│</span><span class="w">
      </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">▼</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
 </span><span class="ss">macula_dist</span><span class="w">                 </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="nf">encode_send</span><span class="p" data-group-id="2351075960-3">(</span><span class="p" data-group-id="2351075960-3">)</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">▼</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
 </span><span class="ss">macula_protocol</span><span class="w">    </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="n">Frame</span><span class="p">:</span><span class="w">      </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="2351075960-4">[</span><span class="n">Ver</span><span class="p">|</span><span class="n">Type</span><span class="p">|</span><span class="w">  </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">  </span><span class="n">Flags</span><span class="p">|</span><span class="n">Len</span><span class="p">|</span><span class="w"> </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">  </span><span class="n">Payload</span><span class="p" data-group-id="2351075960-4">]</span><span class="w">   </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">▼</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
 </span><span class="ss">macula_connection</span><span class="w">           </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="n">Get</span><span class="o">/</span><span class="n">Create</span><span class="w"> </span><span class="n">Stream</span><span class="w">    </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">▼</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
 </span><span class="nf">quicer</span><span class="w"> </span><span class="p" data-group-id="2351075960-5">(</span><span class="n">NIF</span><span class="p" data-group-id="2351075960-5">)</span><span class="w">       </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="2351075960-6">(</span><span class="p" data-group-id="2351075960-6">)</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">        </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">▼</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
   </span><span class="n">MsQuic</span><span class="w"> </span><span class="p" data-group-id="2351075960-7">(</span><span class="n">C</span><span class="p" data-group-id="2351075960-7">)</span><span class="w">                </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Packet</span><span class="w">          </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="2351075960-8">(</span><span class="ss">encrypted</span><span class="p" data-group-id="2351075960-8">)</span><span class="w">          </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">                            </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                   </span><span class="err">│</span><span class="w">
      </span><span class="err">▼</span><span class="w">                                                   </span><span class="err">│</span><span class="w">
   </span><span class="n">UDP</span><span class="w"> </span><span class="n">Socket</span><span class="w">                                             </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                   </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w"> </span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">►</span><span class="w">   </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">           </span><span class="n">Network</span><span class="w"> </span><span class="p" data-group-id="2351075960-9">(</span><span class="n">Internet</span><span class="p" data-group-id="2351075960-9">)</span><span class="w">                     </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                            </span><span class="n">UDP</span><span class="w"> </span><span class="n">Socket</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span><span class="w">
      </span><span class="err">│</span><span class="w">                                             </span><span class="n">MsQuic</span><span class="w"> </span><span class="p" data-group-id="2351075960-10">(</span><span class="n">C</span><span class="p" data-group-id="2351075960-10">)</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="n">Decrypt</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="n">Reassemble</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span><span class="w">         </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                            </span><span class="nf">quicer</span><span class="w"> </span><span class="p" data-group-id="2351075960-11">(</span><span class="n">NIF</span><span class="p" data-group-id="2351075960-11">)</span><span class="w">    </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="nc">quicer</span><span class="p">:</span><span class="nf">recv</span><span class="p" data-group-id="2351075960-12">(</span><span class="p" data-group-id="2351075960-12">)</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span><span class="w">
      </span><span class="err">│</span><span class="w">                                         </span><span class="ss">macula_connection</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Pid</span><span class="w"> </span><span class="ss">lookup</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span><span class="w">         </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                          </span><span class="ss">macula_protocol</span><span class="w">   </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">         </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="nf">decode</span><span class="p" data-group-id="2351075960-13">(</span><span class="p" data-group-id="2351075960-13">)</span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span><span class="w">
      </span><span class="err">│</span><span class="w">                                            </span><span class="ss">macula_dist</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="n">Deliver</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">process</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span><span class="w">        </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                            </span><span class="n">Process</span><span class="w"> </span><span class="n">B</span><span class="w">      </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w"> </span><span class="k">receive</span><span class="w"> </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">   </span><span class="n">Message</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">│</span><span class="w">
      </span><span class="err">│</span><span class="w">                                                  </span><span class="err">▼</span></code></pre><h3 id="4-mesh-topology-diagram" class="section-heading"><a href="#4-mesh-topology-diagram" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. Mesh Topology Diagram</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Consistent</span><span class="w"> </span><span class="n">Hash</span><span class="w"> </span><span class="n">Ring</span><span class="w"> </span><span class="p" data-group-id="4842607180-1">(</span><span class="ss">k</span><span class="o">-</span><span class="ss">regular</span><span class="w"> </span><span class="ss">graph</span><span class="p">,</span><span class="w"> </span><span class="ss">k</span><span class="o">=</span><span class="mi">6</span><span class="p" data-group-id="4842607180-1">)</span><span class="w">                     </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                          </span><span class="n">Node</span><span class="w"> </span><span class="mi">3</span><span class="w">                                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                            </span><span class="err">●</span><span class="w">                                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                       </span><span class="err">╱</span><span class="w">         </span><span class="err">╲</span><span class="w">                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                  </span><span class="err">╱</span><span class="w">                  </span><span class="err">╲</span><span class="w">                            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">             </span><span class="err">╱</span><span class="w">                           </span><span class="err">╲</span><span class="w">                        </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">        </span><span class="err">╱</span><span class="w">                                    </span><span class="err">╲</span><span class="w">                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="n">Node</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">●</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">●</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="mi">4</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">╲</span><span class="w">                         </span><span class="err">╱</span><span class="w">   </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">       </span><span class="err">╲</span><span class="w">                 </span><span class="err">╱</span><span class="w">       </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">           </span><span class="err">╲</span><span class="w">         </span><span class="err">╱</span><span class="w">           </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">               </span><span class="err">●</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="mi">5</span><span class="w">          </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">           </span><span class="err">╱</span><span class="w">         </span><span class="err">╲</span><span class="w">           </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">       </span><span class="err">╱</span><span class="w">                 </span><span class="err">╲</span><span class="w">       </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">   </span><span class="err">╱</span><span class="w">                         </span><span class="err">╲</span><span class="w">   </span><span class="err">│</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="n">Node</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">●</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">●</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="mi">6</span><span class="w">                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">        </span><span class="err">╲</span><span class="w">                                    </span><span class="err">╱</span><span class="w">                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">             </span><span class="err">╲</span><span class="w">                           </span><span class="err">╱</span><span class="w">                        </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                  </span><span class="err">╲</span><span class="w">                  </span><span class="err">╱</span><span class="w">                            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                       </span><span class="err">╲</span><span class="w">         </span><span class="err">╱</span><span class="w">                               </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                            </span><span class="err">●</span><span class="w">                                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                        </span><span class="n">Node</span><span class="w"> </span><span class="mi">7</span><span class="w">                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Each</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="ss">connects</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="nf">neighbors</span><span class="w"> </span><span class="p" data-group-id="4842607180-2">(</span><span class="n">K</span><span class="o">=</span><span class="mi">6</span><span class="w"> </span><span class="ss">in</span><span class="w"> </span><span class="ss">this</span><span class="w"> </span><span class="ss">example</span><span class="p" data-group-id="4842607180-2">)</span><span class="w">       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ss">clockwise</span><span class="w"> </span><span class="nf">neighbors</span><span class="w"> </span><span class="p" data-group-id="4842607180-3">(</span><span class="mi">3</span><span class="p" data-group-id="4842607180-3">)</span><span class="w">                                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">K</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="ss">counter</span><span class="o">-</span><span class="ss">clockwise</span><span class="w"> </span><span class="nf">neighbors</span><span class="w"> </span><span class="p" data-group-id="4842607180-4">(</span><span class="mi">3</span><span class="p" data-group-id="4842607180-4">)</span><span class="w">                         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Properties</span><span class="p">:</span><span class="w">                                                    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Low</span><span class="w"> </span><span class="nf">diameter</span><span class="w"> </span><span class="p" data-group-id="4842607180-5">(</span><span class="n">O</span><span class="p" data-group-id="4842607180-6">(</span><span class="ss">log</span><span class="w"> </span><span class="ss">n</span><span class="p" data-group-id="4842607180-6">)</span><span class="w"> </span><span class="ss">hops</span><span class="w"> </span><span class="ss">between</span><span class="w"> </span><span class="ss">any</span><span class="w"> </span><span class="ss">two</span><span class="w"> </span><span class="nb">nodes</span><span class="p" data-group-id="4842607180-5">)</span><span class="w">         </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">High</span><span class="w"> </span><span class="ss">fault</span><span class="w"> </span><span class="nf">tolerance</span><span class="w"> </span><span class="p" data-group-id="4842607180-7">(</span><span class="ss">multiple</span><span class="w"> </span><span class="ss">paths</span><span class="p" data-group-id="4842607180-7">)</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">•</span><span class="w"> </span><span class="n">Scalable</span><span class="w"> </span><span class="p" data-group-id="4842607180-8">(</span><span class="ss">each</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="ss">has</span><span class="w"> </span><span class="ss">fixed</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="ss">connections</span><span class="p" data-group-id="4842607180-8">)</span><span class="w">               </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="5-nat-traversal-flow" class="section-heading"><a href="#5-nat-traversal-flow" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">5. NAT Traversal Flow</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="n">Traversal</span><span class="w"> </span><span class="n">Using</span><span class="w"> </span><span class="n">STUN</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ICE</span><span class="w">                                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                                                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p" data-group-id="8597312702-1">(</span><span class="ss">behind</span><span class="w"> </span><span class="n">NAT</span><span class="p" data-group-id="8597312702-1">)</span><span class="w">          </span><span class="n">STUN</span><span class="w"> </span><span class="n">Server</span><span class="w">         </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p" data-group-id="8597312702-2">(</span><span class="ss">public</span><span class="p" data-group-id="8597312702-2">)</span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">STUN</span><span class="w"> </span><span class="n">Binding</span><span class="w"> </span><span class="n">Request</span><span class="w">   </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">STUN</span><span class="w"> </span><span class="n">Response</span><span class="w">          </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="p" data-group-id="8597312702-3">(</span><span class="n">Public</span><span class="w"> </span><span class="n">IP</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">.</span><span class="mf">3.4</span><span class="p" data-group-id="8597312702-3">)</span><span class="w">   </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                            </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Register</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="n">Signaling</span><span class="w"> </span><span class="n">Server</span><span class="w">               </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="nb">register</span><span class="w">                                </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="p" data-group-id="8597312702-4">{</span><span class="w"> </span><span class="nc">candidates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8597312702-5">[</span><span class="w">                               </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">       </span><span class="p" data-group-id="8597312702-6">{</span><span class="nc">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;host&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;192.168.1.100&quot;</span><span class="p" data-group-id="8597312702-6">}</span><span class="p">,</span><span class="w">      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">       </span><span class="p" data-group-id="8597312702-7">{</span><span class="nc">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;srflx&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.2.3.4&quot;</span><span class="p" data-group-id="8597312702-7">}</span><span class="w">            </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="p" data-group-id="8597312702-5">]</span><span class="p" data-group-id="8597312702-4">}</span><span class="w">                                             </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">Query</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="ss">candidates</span><span class="w">                   </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="n">GET</span><span class="w"> </span><span class="o">/</span><span class="ss">lookup</span><span class="o">/</span><span class="ss">node_b</span><span class="w">                            </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Receive</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="ss">candidates</span><span class="w">                     </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="p" data-group-id="8597312702-8">{</span><span class="w"> </span><span class="nc">candidates</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8597312702-9">[</span><span class="p" data-group-id="8597312702-10">{</span><span class="nc">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;host&quot;</span><span class="p">,</span><span class="w"> </span><span class="nc">addr</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;5.6.7.8&quot;</span><span class="p" data-group-id="8597312702-10">}</span><span class="p" data-group-id="8597312702-9">]</span><span class="p" data-group-id="8597312702-8">}</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">6</span><span class="p">.</span><span class="w"> </span><span class="n">Connectivity</span><span class="w"> </span><span class="n">Checks</span><span class="w"> </span><span class="p" data-group-id="8597312702-11">(</span><span class="n">ICE</span><span class="p" data-group-id="8597312702-11">)</span><span class="w">                     </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="n">Send</span><span class="w"> </span><span class="n">STUN</span><span class="w"> </span><span class="ss">probes</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="ss">candidate</span><span class="w"> </span><span class="ss">pairs</span><span class="w">       </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="err">◄</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┤</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">7</span><span class="p">.</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="ss">best</span><span class="w"> </span><span class="ss">candidate</span><span class="w"> </span><span class="ss">pair</span><span class="w">                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">     </span><span class="p" data-group-id="8597312702-12">(</span><span class="n">Direct</span><span class="p">:</span><span class="w"> </span><span class="mf">1.2</span><span class="p">.</span><span class="mf">3.4</span><span class="w"> </span><span class="err">↔</span><span class="w"> </span><span class="mf">5.6</span><span class="p">.</span><span class="mf">7.8</span><span class="p" data-group-id="8597312702-12">)</span><span class="w">                  </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">8</span><span class="p">.</span><span class="w"> </span><span class="n">Establish</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Connection</span><span class="w">                     </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">►</span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">  </span><span class="mi">9</span><span class="p">.</span><span class="w"> </span><span class="n">Communication</span><span class="w"> </span><span class="ss">over</span><span class="w"> </span><span class="n">QUIC</span><span class="o">/</span><span class="n">UDP</span><span class="w">                   </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="err">◄</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">═</span><span class="err">►</span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">       </span><span class="err">│</span><span class="w">                                                    </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="6-development-roadmap-gantt-chart" class="section-heading"><a href="#6-development-roadmap-gantt-chart" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">6. Development Roadmap Gantt Chart</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Week</span><span class="w">  </span><span class="n">Phase</span><span class="w">   </span><span class="n">Milestone</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="w">  </span><span class="err">│</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Transport</span><span class="w"> </span><span class="n">Layer</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="ss">quicer</span><span class="w"> </span><span class="ss">integration</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Basic</span><span class="w"> </span><span class="ss">client</span><span class="o">/</span><span class="ss">server</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Bidirectional</span><span class="w"> </span><span class="ss">streams</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">3</span><span class="w">    </span><span class="err">│</span><span class="w">  </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">Framing</span><span class="w"> </span><span class="n">Protocol</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Wire</span><span class="w"> </span><span class="ss">protocol</span><span class="w"> </span><span class="ss">spec</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Encode</span><span class="o">/</span><span class="ss">decode</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Handshake</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">4</span><span class="w">    </span><span class="err">│</span><span class="w">   </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Distribution</span><span class="w"> </span><span class="n">Protocol</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="ss">net_kernel</span><span class="w"> </span><span class="ss">driver</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Basic</span><span class="w"> </span><span class="ss">messaging</span><span class="w">
      </span><span class="err">│</span><span class="w">      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Remote</span><span class="w"> </span><span class="nb">spawn</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">5</span><span class="o">-</span><span class="mi">6</span><span class="w">  </span><span class="err">│</span><span class="w">    </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">Discovery</span><span class="w">
      </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Bootstrap</span><span class="w">
      </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="ss">mDNS</span><span class="w">
      </span><span class="err">│</span><span class="w">        </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">SWIM</span><span class="w"> </span><span class="ss">membership</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">7</span><span class="w">    </span><span class="err">│</span><span class="w">       </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Topology</span><span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="n">Routing</span><span class="w">
      </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="ss">k</span><span class="o">-</span><span class="ss">regular</span><span class="w"> </span><span class="ss">graph</span><span class="w">
      </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">DHT</span><span class="w"> </span><span class="ss">routing</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">8</span><span class="w">    </span><span class="err">│</span><span class="w">        </span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Testing</span><span class="w"> </span><span class="err">&amp;</span><span class="w"> </span><span class="n">Validation</span><span class="w">
      </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Chaos</span><span class="w"> </span><span class="ss">testing</span><span class="w">
      </span><span class="err">│</span><span class="w">          </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Benchmarks</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
 </span><span class="mi">9</span><span class="o">-</span><span class="mi">10</span><span class="w"> </span><span class="err">│</span><span class="w">         </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="n">Traversal</span><span class="w">
      </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">STUN</span><span class="w"> </span><span class="ss">client</span><span class="w">
      </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">ICE</span><span class="w"> </span><span class="ss">implementation</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">11</span><span class="o">-</span><span class="mi">12</span><span class="w"> </span><span class="err">│</span><span class="w">           </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Hole</span><span class="w"> </span><span class="n">Punching</span><span class="w">
      </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">UDP</span><span class="w"> </span><span class="ss">hole</span><span class="w"> </span><span class="ss">punch</span><span class="w">
      </span><span class="err">│</span><span class="w">               </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="ss">relay</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">13</span><span class="o">-</span><span class="mi">14</span><span class="w"> </span><span class="err">│</span><span class="w">             </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Distributed</span><span class="w"> </span><span class="n">Pub</span><span class="o">/</span><span class="n">Sub</span><span class="w">
      </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Topic</span><span class="w"> </span><span class="ss">registry</span><span class="w">
      </span><span class="err">│</span><span class="w">                 </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Content</span><span class="w"> </span><span class="ss">routing</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">15</span><span class="o">-</span><span class="mi">16</span><span class="w"> </span><span class="err">│</span><span class="w">               </span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="n">Layer</span><span class="w">
      </span><span class="err">│</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Sync</span><span class="w"> </span><span class="n">RPC</span><span class="w">
      </span><span class="err">│</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">WAMP</span><span class="w"> </span><span class="ss">compat</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">17</span><span class="w">    </span><span class="err">│</span><span class="w">                 </span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Security</span><span class="w">
      </span><span class="err">│</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="ss">certs</span><span class="w">
      </span><span class="err">│</span><span class="w">                   </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Rate</span><span class="w"> </span><span class="ss">limiting</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">18</span><span class="w">    </span><span class="err">│</span><span class="w">                  </span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Monitoring</span><span class="w">
      </span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Metrics</span><span class="w">
      </span><span class="err">│</span><span class="w">                    </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Visualization</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">19</span><span class="w">    </span><span class="err">│</span><span class="w">                   </span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Performance</span><span class="w">
      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Optimization</span><span class="w">
      </span><span class="err">│</span><span class="w">                     </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Benchmarks</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">
</span><span class="mi">20</span><span class="w">    </span><span class="err">│</span><span class="w">                    </span><span class="err">■</span><span class="err">■</span><span class="err">│</span><span class="w"> </span><span class="n">Documentation</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">Arch</span><span class="w"> </span><span class="ss">guide</span><span class="w">
      </span><span class="err">│</span><span class="w">                      </span><span class="err">│</span><span class="w"> </span><span class="err">•</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="ss">docs</span><span class="w">
</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="w">

</span><span class="n">Legend</span><span class="p">:</span><span class="w">
</span><span class="err">■</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Active</span><span class="w"> </span><span class="ss">development</span></code></pre><hr class="thin"/><h2 id="technical-deep-dives" class="section-heading"><a href="#technical-deep-dives" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Technical Deep Dives</span></h2><h3 id="deep-dive-1-quic-vs-tcp-for-distributed-erlang" class="section-heading"><a href="#deep-dive-1-quic-vs-tcp-for-distributed-erlang" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Deep Dive 1: QUIC vs TCP for Distributed Erlang</span></h3><p><strong>Why QUIC is Better for Distributed Erlang:</strong></p><h4>1. Head-of-Line Blocking</h4><p><strong>TCP Problem:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Process</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="nc">sends</span><span class="p">:</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="7811747013-1">[</span><span class="n">Packet</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="7811747013-1">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="7811747013-2">[</span><span class="n">Packet</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="7811747013-2">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="7811747013-3">[</span><span class="n">Packet</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">LOST</span><span class="p" data-group-id="7811747013-3">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="7811747013-4">[</span><span class="n">Packet</span><span class="w"> </span><span class="mi">4</span><span class="p" data-group-id="7811747013-4">]</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="w">
                                          </span><span class="err">▲</span><span class="w">
                                          </span><span class="err">│</span><span class="w">
                        </span><span class="n">All</span><span class="w"> </span><span class="ss">packets</span><span class="w"> </span><span class="mi">4</span><span class="o">+</span><span class="w"> </span><span class="ss">blocked</span><span class="w"> </span><span class="ss">until</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">retransmitted</span><span class="o">!</span><span class="w">

</span><span class="n">Process</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="ss">waiting</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="k">receive</span><span class="w"> </span><span class="n">Packet</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span><span class="w">  </span><span class="err">⏳</span><span class="w"> </span><span class="n">BLOCKED</span></code></pre><p><strong>QUIC Solution:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Stream</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p" data-group-id="9866054264-1">(</span><span class="n">Process</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="9866054264-1">)</span><span class="p">:</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="9866054264-2">[</span><span class="n">Pkt</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9866054264-2">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="9866054264-3">[</span><span class="n">Pkt</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9866054264-3">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="9866054264-4">[</span><span class="n">Pkt</span><span class="w"> </span><span class="mi">3</span><span class="o">*</span><span class="n">LOST</span><span class="p" data-group-id="9866054264-4">]</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="w">
                                          </span><span class="err">▲</span><span class="w"> </span><span class="n">Retransmit</span><span class="w"> </span><span class="ss">only</span><span class="w"> </span><span class="ss">this</span><span class="w">
                                          </span><span class="err">│</span><span class="w">
</span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p" data-group-id="9866054264-5">(</span><span class="n">Process</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="9866054264-5">)</span><span class="p">:</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="9866054264-6">[</span><span class="n">Pkt</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9866054264-6">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="9866054264-7">[</span><span class="n">Pkt</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="9866054264-7">]</span><span class="err">─</span><span class="err">─</span><span class="p" data-group-id="9866054264-8">[</span><span class="n">Pkt</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="9866054264-8">]</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="w"> </span><span class="err">✓</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">BLOCKED</span><span class="o">!</span><span class="w">

</span><span class="n">Independent</span><span class="w"> </span><span class="ss">streams</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">No</span><span class="w"> </span><span class="ss">cross</span><span class="o">-</span><span class="ss">stream</span><span class="w"> </span><span class="ss">blocking</span></code></pre><h4>2. Connection Migration</h4><p><strong>TCP Problem:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Mobile</span><span class="w"> </span><span class="ss">device</span><span class="w"> </span><span class="ss">moves</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="n">WiFi</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">Cellular</span><span class="p">:</span><span class="w">

</span><span class="n">WiFi</span><span class="w"> </span><span class="n">IP</span><span class="p">:</span><span class="w">     </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.100</span><span class="p">:</span><span class="mi">5000</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="0572012387-1">[</span><span class="n">Connection</span><span class="w"> </span><span class="ss">established</span><span class="p" data-group-id="0572012387-1">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="0572012387-2">[</span><span class="n">Active</span><span class="w"> </span><span class="ss">transfers</span><span class="p" data-group-id="0572012387-2">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="0572012387-3">[</span><span class="n">Network</span><span class="w"> </span><span class="ss">switches</span><span class="p" data-group-id="0572012387-3">]</span><span class="w">
</span><span class="n">Cellular</span><span class="w"> </span><span class="n">IP</span><span class="p">:</span><span class="w"> </span><span class="mf">10.20</span><span class="p">.</span><span class="mf">30.40</span><span class="p">:</span><span class="mi">6000</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="0572012387-4">[</span><span class="n">TCP</span><span class="w"> </span><span class="ss">connection</span><span class="w"> </span><span class="n">LOST</span><span class="p" data-group-id="0572012387-4">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="0572012387-5">[</span><span class="n">Must</span><span class="w"> </span><span class="ss">re</span><span class="o">-</span><span class="nc">establish</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="0572012387-5">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="0572012387-6">[</span><span class="n">Resume</span><span class="w"> </span><span class="ss">transfers</span><span class="p" data-group-id="0572012387-6">]</span></code></pre><p><strong>QUIC Solution:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">WiFi</span><span class="w"> </span><span class="n">IP</span><span class="p">:</span><span class="w">     </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.100</span><span class="p">:</span><span class="mi">5000</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="7503031764-1">[</span><span class="n">Connection</span><span class="w"> </span><span class="n">ID</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="ss">x1a2b3c4d</span><span class="p" data-group-id="7503031764-1">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="7503031764-2">[</span><span class="n">Active</span><span class="w"> </span><span class="ss">transfers</span><span class="p" data-group-id="7503031764-2">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="7503031764-3">[</span><span class="n">Network</span><span class="w"> </span><span class="ss">switches</span><span class="p" data-group-id="7503031764-3">]</span><span class="w">
</span><span class="n">Cellular</span><span class="w"> </span><span class="n">IP</span><span class="p">:</span><span class="w"> </span><span class="mf">10.20</span><span class="p">.</span><span class="mf">30.40</span><span class="p">:</span><span class="mi">6000</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="7503031764-4">[</span><span class="n">Same</span><span class="w"> </span><span class="n">Connection</span><span class="w"> </span><span class="n">ID</span><span class="o">!</span><span class="p" data-group-id="7503031764-4">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="7503031764-5">[</span><span class="n">Continue</span><span class="w"> </span><span class="nc">immediately</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">RTT</span><span class="p" data-group-id="7503031764-5">]</span><span class="w">
             </span><span class="err">↓</span><span class="w"> </span><span class="p" data-group-id="7503031764-6">[</span><span class="n">Transfers</span><span class="w"> </span><span class="ss">uninterrupted</span><span class="p" data-group-id="7503031764-6">]</span></code></pre><h4>3. 0-RTT Resumption</h4><p><strong>TCP + TLS 1.2:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">SYN</span><span class="w">                      </span><span class="n">RTT</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w"> </span><span class="n">SYN</span><span class="o">-</span><span class="n">ACK</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">ACK</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">ClientHello</span><span class="w">              </span><span class="n">RTT</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w"> </span><span class="n">ServerHello</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Certificate</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Finished</span><span class="w">
</span><span class="n">Server</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Client</span><span class="p">:</span><span class="w"> </span><span class="n">Finished</span><span class="w">
</span><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">Request</span><span class="w">             </span><span class="n">RTT</span><span class="w"> </span><span class="mi">3</span><span class="w">

</span><span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="n">RTT</span><span class="w"> </span><span class="ss">before</span><span class="w"> </span><span class="ss">application</span><span class="w"> </span><span class="ss">data</span></code></pre><p><strong>QUIC (with 0-RTT token):</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Client</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Initial</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">0</span><span class="o">-</span><span class="n">RTT</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">App</span><span class="w"> </span><span class="n">Request</span><span class="w">   </span><span class="n">RTT</span><span class="w"> </span><span class="mi">0</span><span class="w">

</span><span class="n">Total</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">RTT</span><span class="o">!</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="ss">sent</span><span class="w"> </span><span class="ss">immediately</span></code></pre><p>This is HUGE for edge devices that frequently reconnect!</p><h4>4. Multiplexing Efficiency</h4><p><strong>HTTP/2 over TCP:</strong></p><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">TCP</span><span class="w"> </span><span class="n">Connection</span><span class="w">                       </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="n">Multiplexing</span><span class="w">          </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Stream</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">     </span><span class="err">│</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Problem</span><span class="p">:</span><span class="w"> </span><span class="n">TCP</span><span class="w"> </span><span class="ss">sees</span><span class="w"> </span><span class="ss">bytes</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="ss">streams</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Single</span><span class="w"> </span><span class="ss">packet</span><span class="w"> </span><span class="ss">loss</span><span class="w"> </span><span class="ss">blocks</span><span class="w"> </span><span class="n">ALL</span><span class="w"> </span><span class="ss">streams</span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><p><strong>HTTP/3 over QUIC:</strong></p><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="n">Connection</span><span class="w">                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p" data-group-id="3247185579-1">(</span><span class="ss">independent</span><span class="p" data-group-id="3247185579-1">)</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p" data-group-id="3247185579-2">(</span><span class="ss">independent</span><span class="p" data-group-id="3247185579-2">)</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="n">Stream</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p" data-group-id="3247185579-3">(</span><span class="ss">independent</span><span class="p" data-group-id="3247185579-3">)</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">                                 </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">                                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">QUIC</span><span class="w"> </span><span class="ss">understands</span><span class="w"> </span><span class="ss">streams</span><span class="w"> </span><span class="ss">natively</span><span class="o">!</span><span class="w">   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Packet</span><span class="w"> </span><span class="ss">loss</span><span class="w"> </span><span class="ss">only</span><span class="w"> </span><span class="ss">affects</span><span class="w"> </span><span class="ss">one</span><span class="w"> </span><span class="ss">stream</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><p>For Erlang distribution with millions of processes, this is critical!</p><hr class="thin"/><h3 id="deep-dive-2-swim-gossip-protocol" class="section-heading"><a href="#deep-dive-2-swim-gossip-protocol" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Deep Dive 2: SWIM Gossip Protocol</span></h3><p><strong>SWIM: Scalable Weakly-consistent Infection-style Process Group Membership</strong></p><h4>Why SWIM?</h4><p>Traditional heartbeat protocols don't scale:</p><pre><code class="makeup erlang" translate="no"><span class="n">N</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">sending</span><span class="w"> </span><span class="ss">heartbeats</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="nc">others</span><span class="p">:</span><span class="w">
  </span><span class="n">Network</span><span class="w"> </span><span class="nc">load</span><span class="p">:</span><span class="w"> </span><span class="n">O</span><span class="p" data-group-id="7194749515-1">(</span><span class="n">N</span><span class="err">²</span><span class="p" data-group-id="7194749515-1">)</span><span class="w"> </span><span class="ss">messages</span><span class="w"> </span><span class="ss">per</span><span class="w"> </span><span class="ss">period</span><span class="w">

</span><span class="n">Example</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="nb">nodes</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">sec</span><span class="w"> </span><span class="ss">heartbeat</span><span class="w">
  </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">000</span><span class="p">,</span><span class="mi">000</span><span class="w"> </span><span class="ss">messages</span><span class="o">/</span><span class="ss">sec</span><span class="w">
  </span><span class="o">=</span><span class="w"> </span><span class="n">NOT</span><span class="w"> </span><span class="n">SCALABLE</span></code></pre><p>SWIM uses gossip:</p><pre><code class="makeup erlang" translate="no"><span class="n">Each</span><span class="w"> </span><span class="nc">node</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Pings</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="ss">random</span><span class="w"> </span><span class="ss">member</span><span class="w"> </span><span class="ss">per</span><span class="w"> </span><span class="ss">period</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Gossips</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="ss">random</span><span class="w"> </span><span class="ss">members</span><span class="w">

</span><span class="n">Network</span><span class="w"> </span><span class="nc">load</span><span class="p">:</span><span class="w"> </span><span class="n">O</span><span class="p" data-group-id="7564527733-1">(</span><span class="n">N</span><span class="p" data-group-id="7564527733-1">)</span><span class="w"> </span><span class="ss">messages</span><span class="w"> </span><span class="ss">per</span><span class="w"> </span><span class="ss">period</span><span class="w">

</span><span class="n">Example</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="nb">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">=</span><span class="mi">3</span><span class="w">
  </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="ss">pings</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3000</span><span class="w"> </span><span class="ss">gossip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="w"> </span><span class="ss">messages</span><span class="o">/</span><span class="ss">sec</span><span class="w">
  </span><span class="o">=</span><span class="w"> </span><span class="n">SCALABLE</span><span class="o">!</span></code></pre><h4>SWIM Algorithm</h4><pre><code class="makeup erlang" translate="no"><span class="n">Every</span><span class="w"> </span><span class="ss">protocol</span><span class="w"> </span><span class="nf">period</span><span class="w"> </span><span class="p" data-group-id="9085359550-1">(</span><span class="mi">1</span><span class="w"> </span><span class="ss">second</span><span class="p" data-group-id="9085359550-1">)</span><span class="p">:</span><span class="w">

</span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">SELECT</span><span class="w"> </span><span class="ss">random</span><span class="w"> </span><span class="ss">member</span><span class="w"> </span><span class="n">M</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">PING</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="p" data-group-id="9085359550-2">(</span><span class="ss">wait</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="n">ACK</span><span class="p" data-group-id="9085359550-2">)</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="ss">received</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">alive</span><span class="w">
   </span><span class="err">└</span><span class="err">─</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="ss">timeout</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">INDIRECT</span><span class="w"> </span><span class="n">PING</span><span class="w">

</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">INDIRECT</span><span class="w"> </span><span class="n">PING</span><span class="p">:</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="ss">random</span><span class="w"> </span><span class="nf">members</span><span class="w"> </span><span class="p" data-group-id="9085359550-3">(</span><span class="ss">e</span><span class="p">.</span><span class="ss">g</span><span class="p">.</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">=</span><span class="mi">3</span><span class="p" data-group-id="9085359550-3">)</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">Ask</span><span class="w"> </span><span class="ss">each</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">ping</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">on</span><span class="w"> </span><span class="ss">your</span><span class="w"> </span><span class="ss">behalf</span><span class="w">
   </span><span class="err">└</span><span class="err">─</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="ss">any</span><span class="w"> </span><span class="n">ACK</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">alive</span><span class="w">
       </span><span class="n">If</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="ss">timeout</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="n">SUSPECT</span><span class="w">

</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">SUSPECT</span><span class="w"> </span><span class="nc">handling</span><span class="p">:</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">Don</span><span class="err">&#39;</span><span class="ss">t</span><span class="w"> </span><span class="ss">immediately</span><span class="w"> </span><span class="ss">mark</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">as</span><span class="w"> </span><span class="ss">dead</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">Give</span><span class="w"> </span><span class="ss">time</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="nf">refutation</span><span class="w"> </span><span class="p" data-group-id="9085359550-4">(</span><span class="mi">5</span><span class="w"> </span><span class="ss">seconds</span><span class="p" data-group-id="9085359550-4">)</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">can</span><span class="w"> </span><span class="ss">increase</span><span class="w"> </span><span class="ss">its</span><span class="w"> </span><span class="s">&quot;incarnation number&quot;</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">refute</span><span class="w">
   </span><span class="err">└</span><span class="err">─</span><span class="w"> </span><span class="n">If</span><span class="w"> </span><span class="ss">no</span><span class="w"> </span><span class="ss">refutation</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="n">DEAD</span><span class="w">

</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">GOSSIP</span><span class="p">:</span><span class="w">
   </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="ss">random</span><span class="w"> </span><span class="ss">members</span><span class="w">
   </span><span class="err">└</span><span class="err">─</span><span class="w"> </span><span class="n">Send</span><span class="w"> </span><span class="ss">recent</span><span class="w"> </span><span class="ss">membership</span><span class="w"> </span><span class="nf">changes</span><span class="w">
       </span><span class="p" data-group-id="9085359550-5">(</span><span class="ss">new</span><span class="w"> </span><span class="ss">members</span><span class="p">,</span><span class="w"> </span><span class="ss">state</span><span class="w"> </span><span class="ss">changes</span><span class="p">,</span><span class="w"> </span><span class="ss">etc</span><span class="p">.</span><span class="p" data-group-id="9085359550-5">)</span></code></pre><h4>Suspicion Mechanism</h4><pre><code class="makeup erlang" translate="no"><span class="n">Timeline</span><span class="p">:</span><span class="w">

</span><span class="n">T</span><span class="o">+</span><span class="mi">0</span><span class="nc">s</span><span class="p">:</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="ss">fails</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">respond</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">ping</span><span class="w">
       </span><span class="err">│</span><span class="w">
       </span><span class="err">▼</span><span class="w">
       </span><span class="n">Mark</span><span class="w"> </span><span class="ss">as</span><span class="w"> </span><span class="n">SUSPECT</span><span class="w"> </span><span class="p" data-group-id="5536141261-1">(</span><span class="ow">not</span><span class="w"> </span><span class="ss">dead</span><span class="o">!</span><span class="p" data-group-id="5536141261-1">)</span><span class="w">
       </span><span class="err">│</span><span class="w">
       </span><span class="err">├</span><span class="err">─</span><span class="w"> </span><span class="n">Broadcast</span><span class="w"> </span><span class="s">&quot;Node X is suspect&quot;</span><span class="w">
       </span><span class="err">│</span><span class="w">  </span><span class="ss">via</span><span class="w"> </span><span class="ss">gossip</span><span class="w">
       </span><span class="err">│</span><span class="w">
</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="nc">s</span><span class="p">:</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Other</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">hear</span><span class="w"> </span><span class="ss">rumor</span><span class="w">
       </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">►</span><span class="w"> </span><span class="n">Try</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">ping</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">X</span><span class="w">
       </span><span class="err">│</span><span class="w">       </span><span class="err">└</span><span class="err">─</span><span class="err">►</span><span class="w"> </span><span class="n">Some</span><span class="w"> </span><span class="ss">may</span><span class="w"> </span><span class="ss">succeed</span><span class="o">!</span><span class="w">
       </span><span class="err">│</span><span class="w">
</span><span class="n">T</span><span class="o">+</span><span class="mi">2</span><span class="nc">s</span><span class="p">:</span><span class="w">  </span><span class="err">│</span><span class="w">  </span><span class="n">Node</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="ss">hears</span><span class="w"> </span><span class="ss">it</span><span class="err">&#39;</span><span class="ss">s</span><span class="w"> </span><span class="ss">suspected</span><span class="w">
       </span><span class="err">│</span><span class="w">  </span><span class="err">└</span><span class="err">─</span><span class="err">►</span><span class="w"> </span><span class="n">Refutes</span><span class="w"> </span><span class="ss">by</span><span class="w"> </span><span class="ss">increasing</span><span class="w">
       </span><span class="err">│</span><span class="w">       </span><span class="ss">incarnation</span><span class="w"> </span><span class="ss">number</span><span class="w">
       </span><span class="err">│</span><span class="w">
</span><span class="n">T</span><span class="o">+</span><span class="mi">5</span><span class="nc">s</span><span class="p">:</span><span class="w">  </span><span class="err">▼</span><span class="w">
       </span><span class="n">If</span><span class="w"> </span><span class="ss">no</span><span class="w"> </span><span class="ss">refutation</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Mark</span><span class="w"> </span><span class="ss">as</span><span class="w"> </span><span class="n">DEAD</span><span class="w">
       </span><span class="err">│</span><span class="w">
       </span><span class="err">└</span><span class="err">─</span><span class="w"> </span><span class="n">Broadcast</span><span class="w"> </span><span class="s">&quot;Node X is dead&quot;</span></code></pre><p>This prevents false positives from temporary network glitches!</p><h4>Gossip Dissemination</h4><pre><code class="makeup erlang" translate="no"><span class="n">Epidemic</span><span class="o">-</span><span class="ss">style</span><span class="w"> </span><span class="nc">spread</span><span class="p">:</span><span class="w">

</span><span class="n">T</span><span class="o">+</span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="ss">detects</span><span class="w"> </span><span class="nf">change</span><span class="w"> </span><span class="p" data-group-id="8142373235-1">(</span><span class="n">Node</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="ss">joined</span><span class="p" data-group-id="8142373235-1">)</span><span class="w">
     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
     </span><span class="err">│</span><span class="w">   </span><span class="n">A</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="nc">knows</span><span class="p">:</span><span class="w"> </span><span class="n">X</span><span class="w"> </span><span class="ss">joined</span><span class="w">
     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">

</span><span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="ss">gossips</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="p" data-group-id="8142373235-2">(</span><span class="n">K</span><span class="o">=</span><span class="mi">3</span><span class="w"> </span><span class="ss">random</span><span class="p" data-group-id="8142373235-2">)</span><span class="w">
     </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">   </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">   </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">   </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
     </span><span class="err">│</span><span class="w">   </span><span class="n">A</span><span class="w">   </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">   </span><span class="n">B</span><span class="w">   </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">   </span><span class="n">C</span><span class="w">   </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="err">►</span><span class="err">│</span><span class="w">   </span><span class="n">D</span><span class="w">   </span><span class="err">│</span><span class="w">
     </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                  </span><span class="ss">knows</span><span class="w">       </span><span class="ss">knows</span><span class="w">       </span><span class="ss">knows</span><span class="w">

</span><span class="n">T</span><span class="o">+</span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="n">D</span><span class="w"> </span><span class="ss">gossip</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="ss">others</span><span class="w"> </span><span class="nf">each</span><span class="w"> </span><span class="p" data-group-id="8142373235-3">(</span><span class="ss">exponential</span><span class="w"> </span><span class="ss">spread</span><span class="p" data-group-id="8142373235-3">)</span><span class="w">
     </span><span class="mi">9</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">know</span><span class="w">

</span><span class="n">T</span><span class="o">+</span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">know</span><span class="w">

</span><span class="n">T</span><span class="o">+</span><span class="ss">log</span><span class="err">₃</span><span class="p" data-group-id="8142373235-4">(</span><span class="n">N</span><span class="p" data-group-id="8142373235-4">)</span><span class="p">:</span><span class="w"> </span><span class="n">All</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">know</span><span class="o">!</span></code></pre><p>Convergence time: <strong>O(log N)</strong></p><hr class="thin"/><h3 id="deep-dive-3-kademlia-dht-for-routing" class="section-heading"><a href="#deep-dive-3-kademlia-dht-for-routing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Deep Dive 3: Kademlia DHT for Routing</span></h3><p><strong>Why DHT (Distributed Hash Table)?</strong></p><p>In large mesh networks, full mesh (N² connections) doesn't scale:</p><pre><code class="makeup erlang" translate="no"><span class="n">Nodes</span><span class="w">  </span><span class="n">Connections</span><span class="w">  </span><span class="n">Problem</span><span class="w">
  </span><span class="mi">10</span><span class="w">       </span><span class="mi">45</span><span class="w">       </span><span class="n">OK</span><span class="w">
 </span><span class="mi">100</span><span class="w">     </span><span class="mi">4</span><span class="p">,</span><span class="mi">950</span><span class="w">      </span><span class="n">Getting</span><span class="w"> </span><span class="ss">expensive</span><span class="w">
</span><span class="mi">1000</span><span class="w">   </span><span class="mi">499</span><span class="p">,</span><span class="mi">500</span><span class="w">      </span><span class="n">IMPOSSIBLE</span></code></pre><p>DHT enables O(log N) routing:</p><pre><code class="makeup erlang" translate="no"><span class="n">Nodes</span><span class="w">  </span><span class="n">Hops</span><span class="w"> </span><span class="p" data-group-id="6954981262-1">(</span><span class="ss">log</span><span class="err">₂</span><span class="w"> </span><span class="n">N</span><span class="p" data-group-id="6954981262-1">)</span><span class="w">
  </span><span class="mi">10</span><span class="w">        </span><span class="mi">3</span><span class="w">
 </span><span class="mi">100</span><span class="w">        </span><span class="mi">6</span><span class="w">
</span><span class="mi">1000</span><span class="w">       </span><span class="mi">10</span></code></pre><h4>Kademlia Basics</h4><p><strong>XOR Distance Metric:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Node</span><span class="w"> </span><span class="n">IDs</span><span class="w"> </span><span class="ss">are</span><span class="w"> </span><span class="mi">256</span><span class="o">-</span><span class="ss">bit</span><span class="w"> </span><span class="nf">hashes</span><span class="w"> </span><span class="p" data-group-id="0479871356-1">(</span><span class="n">SHA256</span><span class="p" data-group-id="0479871356-1">)</span><span class="w">

</span><span class="n">Node</span><span class="w"> </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="ss">x3a7f</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="n">Node</span><span class="w"> </span><span class="n">B</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="ss">x8c12</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="n">Distance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">XOR</span><span class="w"> </span><span class="n">B</span><span class="w">
         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="ss">x3a7f</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w"> </span><span class="n">XOR</span><span class="w"> </span><span class="mi">0</span><span class="ss">x8c12</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
         </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="ss">xb66d</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">

</span><span class="n">Properties</span><span class="p">:</span><span class="w">
  </span><span class="err">•</span><span class="w"> </span><span class="nf">d</span><span class="p" data-group-id="0479871356-2">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="0479871356-2">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">d</span><span class="p" data-group-id="0479871356-3">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="0479871356-3">)</span><span class="w">  </span><span class="p" data-group-id="0479871356-4">(</span><span class="ss">symmetric</span><span class="p" data-group-id="0479871356-4">)</span><span class="w">
  </span><span class="err">•</span><span class="w"> </span><span class="nf">d</span><span class="p" data-group-id="0479871356-5">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="0479871356-5">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="err">•</span><span class="w"> </span><span class="nf">d</span><span class="p" data-group-id="0479871356-6">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="0479871356-6">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">d</span><span class="p" data-group-id="0479871356-7">(</span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p" data-group-id="0479871356-7">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nf">d</span><span class="p" data-group-id="0479871356-8">(</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">C</span><span class="p" data-group-id="0479871356-8">)</span><span class="w">  </span><span class="p" data-group-id="0479871356-9">(</span><span class="ss">triangle</span><span class="w"> </span><span class="ss">inequality</span><span class="p" data-group-id="0479871356-9">)</span></code></pre><p><strong>k-buckets:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Each</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="ss">maintains</span><span class="w"> </span><span class="ss">k</span><span class="o">-</span><span class="ss">buckets</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">distance</span><span class="w"> </span><span class="nc">ranges</span><span class="p">:</span><span class="w">

</span><span class="n">Bucket</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w">  </span><span class="n">Distance</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">0</span><span class="w">  </span><span class="ss">to</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">1</span><span class="w">   </span><span class="p" data-group-id="6911031878-1">(</span><span class="mi">1</span><span class="w"> </span><span class="ss">hop</span><span class="w"> </span><span class="ss">away</span><span class="p" data-group-id="6911031878-1">)</span><span class="w">
</span><span class="n">Bucket</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w">  </span><span class="n">Distance</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">1</span><span class="w">  </span><span class="ss">to</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">2</span><span class="w">   </span><span class="p" data-group-id="6911031878-2">(</span><span class="mi">2</span><span class="w"> </span><span class="ss">hops</span><span class="p" data-group-id="6911031878-2">)</span><span class="w">
</span><span class="n">Bucket</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w">  </span><span class="n">Distance</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">2</span><span class="w">  </span><span class="ss">to</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">3</span><span class="w">   </span><span class="p" data-group-id="6911031878-3">(</span><span class="mi">4</span><span class="w"> </span><span class="ss">hops</span><span class="p" data-group-id="6911031878-3">)</span><span class="w">
</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="w">
</span><span class="n">Bucket</span><span class="w"> </span><span class="mi">255</span><span class="p">:</span><span class="w"> </span><span class="n">Distance</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">255</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mi">2</span><span class="err">^</span><span class="mi">256</span><span class="w"> </span><span class="p" data-group-id="6911031878-4">(</span><span class="ss">very</span><span class="w"> </span><span class="ss">far</span><span class="p" data-group-id="6911031878-4">)</span><span class="w">

</span><span class="n">Each</span><span class="w"> </span><span class="ss">bucket</span><span class="w"> </span><span class="ss">stores</span><span class="w"> </span><span class="ss">up</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">K</span><span class="w"> </span><span class="nf">nodes</span><span class="w"> </span><span class="p" data-group-id="6911031878-5">(</span><span class="ss">e</span><span class="p">.</span><span class="ss">g</span><span class="p">.</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="o">=</span><span class="mi">20</span><span class="p" data-group-id="6911031878-5">)</span></code></pre><p><strong>Routing:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">To</span><span class="w"> </span><span class="nb">send</span><span class="w"> </span><span class="ss">message</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">target</span><span class="w"> </span><span class="n">T</span><span class="p">:</span><span class="w">

</span><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="n">Calculate</span><span class="w"> </span><span class="nc">distance</span><span class="p">:</span><span class="w"> </span><span class="ss">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">XOR</span><span class="p" data-group-id="8007133191-1">(</span><span class="ss">my_id</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p" data-group-id="8007133191-1">)</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="n">Find</span><span class="w"> </span><span class="ss">bucket</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="ss">distance</span><span class="w"> </span><span class="ss">d</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="n">Select</span><span class="w"> </span><span class="ss">closest</span><span class="w"> </span><span class="nb">node</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="ss">bucket</span><span class="w">
</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="n">Forward</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">N</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="n">Repeat</span><span class="w"> </span><span class="ss">until</span><span class="w"> </span><span class="ss">reached</span><span class="w"> </span><span class="n">T</span><span class="w">

</span><span class="n">Max</span><span class="w"> </span><span class="nc">hops</span><span class="p">:</span><span class="w"> </span><span class="ss">log</span><span class="err">₂</span><span class="p" data-group-id="8007133191-2">(</span><span class="ss">total_nodes</span><span class="p" data-group-id="8007133191-2">)</span></code></pre><h4>Iterative Node Lookup</h4><pre><code class="makeup erlang" translate="no"><span class="nf">find_node</span><span class="p" data-group-id="5953579282-1">(</span><span class="n">TargetId</span><span class="p" data-group-id="5953579282-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">% Start with K closest known nodes</span><span class="w">
    </span><span class="n">Closest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_k_closest</span><span class="p" data-group-id="5953579282-2">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="5953579282-2">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">find_node_iter</span><span class="p" data-group-id="5953579282-3">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5953579282-4">[</span><span class="p" data-group-id="5953579282-4">]</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="5953579282-3">)</span><span class="p">.</span><span class="w">

</span><span class="nf">find_node_iter</span><span class="p" data-group-id="5953579282-5">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="5953579282-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">% Select ALPHA unqueried nodes to ask</span><span class="w">
    </span><span class="n">ToQuery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">select_closest_unqueried</span><span class="p" data-group-id="5953579282-6">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">Queried</span><span class="p">,</span><span class="w"> </span><span class="n">ALPHA</span><span class="p" data-group-id="5953579282-6">)</span><span class="p">,</span><span class="w">

    </span><span class="k">if</span><span class="w">
        </span><span class="n">ToQuery</span><span class="w"> </span><span class="o">=:=</span><span class="w"> </span><span class="p" data-group-id="5953579282-7">[</span><span class="p" data-group-id="5953579282-7">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">% No more to query, return result</span><span class="w">
            </span><span class="nc">lists</span><span class="p">:</span><span class="nf">sublist</span><span class="p" data-group-id="5953579282-8">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="5953579282-8">)</span><span class="p">;</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">% Query nodes in parallel</span><span class="w">
            </span><span class="n">Results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">pmap</span><span class="p" data-group-id="5953579282-9">(</span><span class="nf">fun</span><span class="p" data-group-id="5953579282-10">(</span><span class="n">Node</span><span class="p" data-group-id="5953579282-10">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">rpc</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="5953579282-11">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="ss">kademlia</span><span class="p">,</span><span class="w"> </span><span class="ss">get_closest</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5953579282-12">[</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="5953579282-12">]</span><span class="p" data-group-id="5953579282-11">)</span><span class="w">
            </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">ToQuery</span><span class="p" data-group-id="5953579282-9">)</span><span class="p">,</span><span class="w">

            </span><span class="c1">% Merge results and sort by distance</span><span class="w">
            </span><span class="n">NewClosest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">merge_and_sort</span><span class="p" data-group-id="5953579282-13">(</span><span class="n">Closest</span><span class="p">,</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">flatten</span><span class="p" data-group-id="5953579282-14">(</span><span class="n">Results</span><span class="p" data-group-id="5953579282-14">)</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="5953579282-13">)</span><span class="p">,</span><span class="w">
            </span><span class="n">NewQueried</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Queried</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">ToQuery</span><span class="p">,</span><span class="w">

            </span><span class="c1">% Check if target found</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">member</span><span class="p" data-group-id="5953579282-15">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">NewClosest</span><span class="p" data-group-id="5953579282-15">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="5953579282-16">{</span><span class="ss">found</span><span class="p">,</span><span class="w"> </span><span class="n">TargetId</span><span class="p" data-group-id="5953579282-16">}</span><span class="p">;</span><span class="w">
                </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">find_node_iter</span><span class="p" data-group-id="5953579282-17">(</span><span class="n">TargetId</span><span class="p">,</span><span class="w"> </span><span class="n">NewClosest</span><span class="p">,</span><span class="w"> </span><span class="n">NewQueried</span><span class="p">,</span><span class="w"> </span><span class="n">K</span><span class="p" data-group-id="5953579282-17">)</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p>Complexity: <strong>O(log N)</strong> lookups, <strong>O(ALPHA * log N)</strong> messages</p><hr class="thin"/><h2 id="success-metrics" class="section-heading"><a href="#success-metrics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Success Metrics</span></h2><h3 id="phase-1-success-criteria" class="section-heading"><a href="#phase-1-success-criteria" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 1 Success Criteria</span></h3><ul><li><p>✅ <strong>QUIC Transport Works</strong></p><ul><li>Server accepts connections</li><li>Client can connect</li><li>Bidirectional streams function</li><li>Connection survives stream closure</li></ul></li><li><p>✅ <strong>Wire Protocol Implemented</strong></p><ul><li>Messages encode/decode correctly</li><li>Handshake completes successfully</li><li>All message types supported</li></ul></li><li><p>✅ <strong>Basic Distribution Functions</strong></p><ul><li><a href="https://www.erlang.org/doc/apps/kernel/net_kernel.html#connect_node/1"><code class="inline">net_kernel:connect_node/1</code></a> works</li><li><code class="inline">nodes()</code> shows connected nodes</li><li>Message sending: <code class="inline">{Name, Node} ! Msg</code></li><li>Remote spawn: <code class="inline">spawn(Node, Fun)</code></li><li>Process linking works</li><li>Monitoring works</li></ul></li></ul><p><strong>Deliverable:</strong> Two Erlang nodes communicating over HTTP/3</p><hr class="thin"/><h3 id="phase-2-success-criteria" class="section-heading"><a href="#phase-2-success-criteria" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 2 Success Criteria</span></h3><ul><li><p>✅ <strong>Node Discovery Works</strong></p><ul><li>Bootstrap discovery functional</li><li>mDNS discovery works locally</li><li>DNS SRV discovery works</li></ul></li><li><p>✅ <strong>Membership Protocol Stable</strong></p><ul><li>SWIM protocol running</li><li>Failures detected within 10 seconds</li><li>Gossip converges in O(log N) time</li><li>No false positives in stable network</li></ul></li><li><p>✅ <strong>Topology Self-Organizes</strong></p><ul><li>Nodes form k-regular graph</li><li>New nodes join smoothly</li><li>Departed nodes removed from topology</li><li>Healing after network partition</li></ul></li><li><p>✅ <strong>Routing Functions</strong></p><ul><li>Messages route through mesh</li><li>DHT lookup finds nodes</li><li>O(log N) hops for routing</li></ul></li></ul><p><strong>Deliverable:</strong> 20+ node mesh that self-heals from failures</p><hr class="thin"/><h3 id="phase-3-success-criteria" class="section-heading"><a href="#phase-3-success-criteria" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 3 Success Criteria</span></h3><ul><li><p>✅ <strong>NAT Traversal Works</strong></p><ul><li>STUN discovers public address</li><li>ICE negotiates connectivity</li><li>UDP hole punching succeeds (&gt;80%)</li><li>TURN relay works as fallback</li></ul></li><li><p>✅ <strong>Real-World Scenarios</strong></p><ul><li>Home router NAT traversed</li><li>Corporate firewall traversed</li><li>Mobile hotspot NAT traversed</li><li>Symmetric NAT handled</li></ul></li></ul><p><strong>Deliverable:</strong> Nodes behind different NATs forming mesh</p><hr class="thin"/><h3 id="phase-4-success-criteria" class="section-heading"><a href="#phase-4-success-criteria" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 4 Success Criteria</span></h3><ul><li><p>✅ <strong>Pub/Sub Works</strong></p><ul><li>Topic subscriptions work</li><li>Messages routed by topic</li><li>Pattern matching (prefix/wildcard)</li><li>Scalable (not flooding all nodes)</li></ul></li><li><p>✅ <strong>RPC Works</strong></p><ul><li>Synchronous RPC calls</li><li>Timeouts handled correctly</li><li>Error propagation works</li></ul></li><li><p>✅ <strong>WAMP Compatible</strong></p><ul><li>Existing WAMP clients can connect</li><li>Subscribe/Publish semantics match</li><li>Call/Register semantics match</li></ul></li></ul><p><strong>Deliverable:</strong> Example Platform PoC runs on Macula Mesh</p><hr class="thin"/><h3 id="phase-5-success-criteria" class="section-heading"><a href="#phase-5-success-criteria" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 5 Success Criteria</span></h3><ul><li><p>✅ <strong>Security Hardened</strong></p><ul><li>TLS certificates managed</li><li>Message authentication</li><li>Rate limiting prevents DoS</li><li>Access control enforced</li></ul></li><li><p>✅ <strong>Production Monitoring</strong></p><ul><li>Prometheus metrics exported</li><li>Topology visualization works</li><li>Alerts fire on anomalies</li><li>Distributed tracing available</li></ul></li><li><p>✅ <strong>Performance Acceptable</strong></p><ul><li>&lt;10ms latency (local)</li><li>&lt;100ms latency (internet)</li><li><blockquote><p>10,000 msg/sec throughput</p></blockquote></li><li>Scales to 1000+ nodes</li></ul></li><li><p>✅ <strong>Documentation Complete</strong></p><ul><li>Architecture guide published</li><li>API reference docs</li><li>Deployment guide</li><li>Migration from Bondy guide</li></ul></li></ul><p><strong>Deliverable:</strong> Production-ready Macula Mesh 1.0</p><hr class="thin"/><h2 id="conclusion" class="section-heading"><a href="#conclusion" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Conclusion</span></h2><p>Macula HTTP/3 Mesh represents a unique opportunity to build <strong>world-class distributed infrastructure for the BEAM ecosystem</strong>. By leveraging QUIC's modern transport capabilities, we can create a mesh network that:</p><ol><li><strong>Works anywhere</strong> - Through NATs, firewalls, mobile networks</li><li><strong>Scales effortlessly</strong> - O(log N) routing, not O(N²) connections</li><li><strong>Feels native</strong> - Standard Erlang distribution semantics</li><li><strong>Performs brilliantly</strong> - 0-RTT reconnection, no head-of-line blocking</li><li><strong>Stands out</strong> - Nobody else has this for BEAM</li></ol><p>This is a <strong>20-week journey</strong> that will culminate in a &quot;Wow, how do they do it?&quot; moment.</p><p><strong>Next Steps:</strong></p><ol><li>Set up development environment</li><li>Integrate quicer dependency</li><li>Build Week 1 deliverable (QUIC echo server/client)</li><li>Start the journey! 🚀</li></ol><hr class="thin"/><h2 id="references" class="section-heading"><a href="#references" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">References</span></h2><h3 id="quic-http-3" class="section-heading"><a href="#quic-http-3" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">QUIC &amp; HTTP/3</span></h3><ul><li><a href="https://www.rfc-editor.org/rfc/rfc9000.html">RFC 9000: QUIC Transport Protocol</a></li><li><a href="https://www.rfc-editor.org/rfc/rfc9001.html">RFC 9001: Using TLS to Secure QUIC</a></li><li><a href="https://www.rfc-editor.org/rfc/rfc9114.html">RFC 9114: HTTP/3</a></li><li><a href="https://github.com/microsoft/msquic/tree/main/docs">MsQuic Documentation</a></li></ul><h3 id="libraries" class="section-heading"><a href="#libraries" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Libraries</span></h3><ul><li><a href="https://github.com/emqx/quic">quicer (Erlang NIF)</a></li><li><a href="https://github.com/alibaba/xquic">xquic (Alibaba)</a></li><li><a href="https://github.com/quinn-rs/quinn">quinn (Rust)</a></li></ul><h3 id="algorithms" class="section-heading"><a href="#algorithms" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Algorithms</span></h3><ul><li><a href="https://www.cs.cornell.edu/projects/Quicksilver/public_pdfs/SWIM.pdf">SWIM: Scalable Membership Protocol</a></li><li><a href="https://pdos.csail.mit.edu/~petar/papers/maymounkov-kademlia-lncs.pdf">Kademlia: A Peer-to-peer Information System</a></li><li><a href="https://www.cs.princeton.edu/courses/archive/fall09/cos518/papers/chash.pdf">Consistent Hashing</a></li></ul><h3 id="related-work" class="section-heading"><a href="#related-work" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Related Work</span></h3><ul><li><a href="https://github.com/lasp-lang/partisan">Partisan: Flexible Distributed Erlang</a></li><li><a href="https://github.com/bondy-io/bondy">Bondy: Distributed WAMP Router</a></li><li><a href="https://github.com/basho/riak_core">Riak Core: Distributed Systems Framework</a></li></ul><hr class="thin"/><p><strong>Document Version:</strong> 1.0
<strong>Last Updated:</strong> 2025-11-07
<strong>Author:</strong> Macula Architecture Team
<strong>Status:</strong> Proposal</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="macula_http3_mesh_hello_world.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Hello World
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="documentation_status.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Documentation Status
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.7.7" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.7.7">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.7.7/show/architecture/macula_http3_mesh_roadmap.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
