<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module macula_peer</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module macula_peer</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>   
Macula Peer - Mesh Participant API (v0.7.0+).

<p><b>Behaviours:</b> <a href="gen_server.html"><code>gen_server</code></a>.</p>

<h2><a name="description">Description</a></h2><p>   
Macula Peer - Mesh Participant API (v0.7.0+).</p>
  
   <p>This module provides the high-level API for mesh participants.   
Use this module to connect to a Macula mesh and communicate via pub/sub or RPC.</p>
  
   <h3><a name="Quick_Start">Quick Start</a></h3>
  
   <pre>   %% 1. Connect to a gateway
   {ok, Peer} = macula_peer:start_link(&lt;&lt;"https://gateway.example.com:9443"&gt;&gt;, #{
       realm =&gt; &lt;&lt;"com.example.app"&gt;&gt;
   }).
  
   %% 2. Subscribe to events
   ok = macula_peer:subscribe(Peer, &lt;&lt;"sensor.temperature"&gt;&gt;, self()).
  
   %% 3. Publish an event
   ok = macula_peer:publish(Peer, &lt;&lt;"sensor.temperature"&gt;&gt;, #{
       device_id =&gt; &lt;&lt;"sensor-001"&gt;&gt;,
       celsius =&gt; 21.5
   }).
  
   %% 4. Call a remote service
   {ok, Result} = macula_peer:call(Peer, &lt;&lt;"calculator.add"&gt;&gt;, #{a =&gt; 5, b =&gt; 3}).
  
   %% 5. Advertise a service
   ok = macula_peer:advertise(Peer, &lt;&lt;"calculator.add"&gt;&gt;, fun(#{a := A, b := B}) -&gt;
       #{result =&gt; A + B}
   end, #{ttl =&gt; 300}).</pre>
  
   <h3><a name="Architecture">Architecture</a></h3>
  
   <p>The peer acts as a facade/coordinator, delegating to specialized child processes:
     - <code>macula_connection</code>: QUIC transport layer (send/receive, encoding/decoding)
     - <code>macula_pubsub_handler</code>: Pub/sub message routing
     - <code>macula_rpc_handler</code>: RPC call/response handling
     - <code>macula_advertisement_manager</code>: DHT service advertisements</p>
  
   <p>Renamed from macula_connection in v0.7.0 for clarity:
     - <code>macula_peer</code> = mesh participant (this module)
     - <code>macula_connection</code> = QUIC transport (low-level)</p>
  
   <h3><a name="Multi-Tenancy_via_Realms">Multi-Tenancy via Realms</a></h3>
  
   <p>Realms provide logical isolation for different applications:</p>
  
   <pre>   %% App 1
   {ok, Peer1} = macula_peer:start_link(GatewayUrl, #{realm =&gt; &lt;&lt;"com.app1"&gt;&gt;}).
  
   %% App 2 (completely isolated from App 1)
   {ok, Peer2} = macula_peer:start_link(GatewayUrl, #{realm =&gt; &lt;&lt;"com.app2"&gt;&gt;}).</pre>
  
<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#advertise-4">advertise/4</a></td><td>Advertise a service handler for a procedure.</td></tr>
<tr><td valign="top"><a href="#call-3">call/3</a></td><td>Make an RPC call through this client (default timeout).</td></tr>
<tr><td valign="top"><a href="#call-4">call/4</a></td><td>Make an RPC call through this client with options.</td></tr>
<tr><td valign="top"><a href="#discover_subscribers-2">discover_subscribers/2</a></td><td>Discover subscribers to a topic via DHT query.</td></tr>
<tr><td valign="top"><a href="#get_node_id-1">get_node_id/1</a></td><td>Get the node ID of this peer.</td></tr>
<tr><td valign="top"><a href="#publish-3">publish/3</a></td><td>Publish an event through this client (no options).</td></tr>
<tr><td valign="top"><a href="#publish-4">publish/4</a></td><td>Publish an event through this client with options.</td></tr>
<tr><td valign="top"><a href="#start_link-2">start_link/2</a></td><td>Start a client connection to a Macula mesh.</td></tr>
<tr><td valign="top"><a href="#stop-1">stop/1</a></td><td>Stop the client connection.</td></tr>
<tr><td valign="top"><a href="#subscribe-3">subscribe/3</a></td><td>Subscribe to a topic through this client.</td></tr>
<tr><td valign="top"><a href="#unadvertise-2">unadvertise/2</a></td><td>Stop advertising a service.</td></tr>
<tr><td valign="top"><a href="#unsubscribe-2">unsubscribe/2</a></td><td>Unsubscribe from a topic.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="advertise-4">advertise/4</a></h3>
<div class="spec">
<p><code>advertise(Client::pid(), Procedure::binary(), Handler::fun((map()) -&gt; {ok, term()} | {error, term()}), Opts::map()) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p><p>Advertise a service handler for a procedure.</p>
 
  This makes the local handler available to other mesh nodes via DHT.
  The handler will be periodically re-advertised based on TTL.</p>

<h3 class="function"><a name="call-3">call/3</a></h3>
<div class="spec">
<p><code>call(Client::pid(), Procedure::binary(), Args::map() | list()) -&gt; {ok, term()} | {error, term()}</code><br></p>
<p> </p>
</div><p>Make an RPC call through this client (default timeout).</p>

<h3 class="function"><a name="call-4">call/4</a></h3>
<div class="spec">
<p><code>call(Client::pid(), Procedure::binary(), Args::map() | list(), Opts::map()) -&gt; {ok, term()} | {error, term()}</code><br></p>
<p> </p>
</div><p>Make an RPC call through this client with options.</p>

<h3 class="function"><a name="discover_subscribers-2">discover_subscribers/2</a></h3>
<div class="spec">
<p><code>discover_subscribers(Client::pid(), Topic::binary()) -&gt; {ok, [#{node_id := binary(), endpoint := binary()}]} | {error, term()}</code><br></p>
<p> </p>
</div><p>Discover subscribers to a topic via DHT query.</p>

<h3 class="function"><a name="get_node_id-1">get_node_id/1</a></h3>
<div class="spec">
<p><code>get_node_id(Client::pid()) -&gt; {ok, binary()} | {error, term()}</code><br></p>
<p> </p>
</div><p>Get the node ID of this peer.</p>

<h3 class="function"><a name="publish-3">publish/3</a></h3>
<div class="spec">
<p><code>publish(Client::pid(), Topic::binary(), Data::map() | binary()) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p>Publish an event through this client (no options).</p>

<h3 class="function"><a name="publish-4">publish/4</a></h3>
<div class="spec">
<p><code>publish(Client::pid(), Topic::binary(), Data::map() | binary(), Opts::map()) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p>Publish an event through this client with options.</p>

<h3 class="function"><a name="start_link-2">start_link/2</a></h3>
<div class="spec">
<p><code>start_link(Url::binary(), Opts::map()) -&gt; {ok, pid()} | {error, term()}</code><br></p>
<p> </p>
</div><p>Start a client connection to a Macula mesh.</p>

<h3 class="function"><a name="stop-1">stop/1</a></h3>
<div class="spec">
<p><code>stop(Client::pid()) -&gt; ok</code><br></p>
<p> </p>
</div><p>Stop the client connection.</p>

<h3 class="function"><a name="subscribe-3">subscribe/3</a></h3>
<div class="spec">
<p><code>subscribe(Client::pid(), Topic::binary(), Callback::fun((map()) -&gt; ok)) -&gt; {ok, reference()} | {error, term()}</code><br></p>
<p> </p>
</div><p>Subscribe to a topic through this client.</p>

<h3 class="function"><a name="unadvertise-2">unadvertise/2</a></h3>
<div class="spec">
<p><code>unadvertise(Client::pid(), Procedure::binary()) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p><p>Stop advertising a service.</p>
 
  Removes the local handler and stops advertising to the DHT.</p>

<h3 class="function"><a name="unsubscribe-2">unsubscribe/2</a></h3>
<div class="spec">
<p><code>unsubscribe(Client::pid(), SubRef::reference()) -&gt; ok | {error, term()}</code><br></p>
<p> </p>
</div><p>Unsubscribe from a topic.</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
