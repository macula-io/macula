<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.12.6">


    <title>NAT Types — macula v0.12.6</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-969EFB48.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="overview.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="overview.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.12.6
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>NAT Types Explained</h1>


      <a href="https://github.com/macula-io/macula/blob/0.12.6/docs/guides/NAT_TYPES_EXPLAINED.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>Understanding NAT (Network Address Translation) types is essential for building P2P applications that work across different network environments. This guide explains the NAT classification model used in Macula based on the NATCracker methodology.</p><hr class="thin"/><h2 id="why-nat-matters-for-p2p" class="section-heading"><a href="#why-nat-matters-for-p2p" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Why NAT Matters for P2P</span></h2><p>When two peers behind NAT want to communicate directly:</p><pre><code class="makeup erlang" translate="no"><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p" data-group-id="8699973174-1">(</span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p" data-group-id="8699973174-1">)</span><span class="w">                    </span><span class="n">Peer</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="p" data-group-id="8699973174-2">(</span><span class="mf">192.168</span><span class="p">.</span><span class="mf">2.20</span><span class="p" data-group-id="8699973174-2">)</span><span class="w">
       </span><span class="p">|</span><span class="w">                                        </span><span class="p">|</span><span class="w">
   </span><span class="p" data-group-id="8699973174-3">[</span><span class="n">NAT</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="8699973174-3">]</span><span class="w">                                  </span><span class="p" data-group-id="8699973174-4">[</span><span class="n">NAT</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="8699973174-4">]</span><span class="w">
       </span><span class="p">|</span><span class="w">                                        </span><span class="p">|</span><span class="w">
  </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w">                      </span><span class="mf">198.51</span><span class="p">.</span><span class="mf">100.8</span><span class="p">:</span><span class="mi">50000</span><span class="w">
       </span><span class="p">|</span><span class="w">                                        </span><span class="p">|</span><span class="w">
       </span><span class="o">+</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="w">  </span><span class="n">Internet</span><span class="w">  </span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">--</span><span class="o">+</span></code></pre><p>The challenge: Neither peer can initiate a connection to the other because NATs block unsolicited incoming traffic.</p><hr class="thin"/><h2 id="nat-policy-classification" class="section-heading"><a href="#nat-policy-classification" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">NAT Policy Classification</span></h2><p>Macula uses the NATCracker 3-policy classification model to characterize NAT behavior. Each NAT is described by three policies:</p><h3 id="1-mapping-policy-how-nat-assigns-external-addresses" class="section-heading"><a href="#1-mapping-policy-how-nat-assigns-external-addresses" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Mapping Policy (How NAT assigns external addresses)</span></h3><table><thead><tr><th style="text-align: left;">Policy</th><th style="text-align: left;">Code</th><th style="text-align: left;">Behavior</th><th style="text-align: left;">Prevalence</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Endpoint-Independent</strong></td><td style="text-align: left;">EI</td><td style="text-align: left;">Same external addr for all destinations</td><td style="text-align: left;">~52%</td></tr><tr><td style="text-align: left;"><strong>Host-Dependent</strong></td><td style="text-align: left;">HD</td><td style="text-align: left;">Different external addr per destination host</td><td style="text-align: left;">~12%</td></tr><tr><td style="text-align: left;"><strong>Port-Dependent</strong></td><td style="text-align: left;">PD</td><td style="text-align: left;">Different external addr per destination host:port</td><td style="text-align: left;">~36%</td></tr></tbody></table><p><strong>Example - Endpoint-Independent (EI):</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p">:</span><span class="mi">5000</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Destination</span><span class="w"> </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="mf">8.8</span><span class="p">.</span><span class="mf">8.8</span><span class="p">:</span><span class="mi">53</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="ss">maps</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Destination</span><span class="w"> </span><span class="n">B</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1</span><span class="p">.</span><span class="mf">1.1</span><span class="p">:</span><span class="mi">53</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="ss">maps</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w">  </span><span class="p" data-group-id="7622896205-1">(</span><span class="ss">same</span><span class="o">!</span><span class="p" data-group-id="7622896205-1">)</span></code></pre><p><strong>Example - Port-Dependent (PD):</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p">:</span><span class="mi">5000</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Destination</span><span class="w"> </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="mf">8.8</span><span class="p">.</span><span class="mf">8.8</span><span class="p">:</span><span class="mi">53</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="ss">maps</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Destination</span><span class="w"> </span><span class="n">B</span><span class="p">:</span><span class="w"> </span><span class="mf">1.1</span><span class="p">.</span><span class="mf">1.1</span><span class="p">:</span><span class="mi">53</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="ss">maps</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40001</span><span class="w">  </span><span class="p" data-group-id="5267507875-1">(</span><span class="ss">different</span><span class="o">!</span><span class="p" data-group-id="5267507875-1">)</span></code></pre><h3 id="2-filtering-policy-what-incoming-traffic-nat-accepts" class="section-heading"><a href="#2-filtering-policy-what-incoming-traffic-nat-accepts" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Filtering Policy (What incoming traffic NAT accepts)</span></h3><table><thead><tr><th style="text-align: left;">Policy</th><th style="text-align: left;">Code</th><th style="text-align: left;">Behavior</th><th style="text-align: left;">Security</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Endpoint-Independent</strong></td><td style="text-align: left;">EI</td><td style="text-align: left;">Accepts from any source</td><td style="text-align: left;">Low</td></tr><tr><td style="text-align: left;"><strong>Host-Dependent</strong></td><td style="text-align: left;">HD</td><td style="text-align: left;">Accepts from hosts we've contacted</td><td style="text-align: left;">Medium</td></tr><tr><td style="text-align: left;"><strong>Port-Dependent</strong></td><td style="text-align: left;">PD</td><td style="text-align: left;">Accepts from host:port we've contacted</td><td style="text-align: left;">High</td></tr></tbody></table><p><strong>Example - Port-Dependent filtering:</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p">:</span><span class="mi">5000</span><span class="w"> </span><span class="ss">sends</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="mf">8.8</span><span class="p">.</span><span class="mf">8.8</span><span class="p">:</span><span class="mi">53</span><span class="w">
</span><span class="n">NAT</span><span class="w"> </span><span class="ss">now</span><span class="w"> </span><span class="ss">accepts</span><span class="w"> </span><span class="ss">incoming</span><span class="w"> </span><span class="ss">on</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w"> </span><span class="n">ONLY</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="mf">8.8</span><span class="p">.</span><span class="mf">8.8</span><span class="p">:</span><span class="mi">53</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="mf">8.8</span><span class="p">.</span><span class="mf">8.8</span><span class="p">:</span><span class="mi">53</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">ALLOWED</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="mf">8.8</span><span class="p">.</span><span class="mf">8.8</span><span class="p">:</span><span class="mi">80</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">BLOCKED</span><span class="w"> </span><span class="p" data-group-id="8322871305-1">(</span><span class="ss">wrong</span><span class="w"> </span><span class="ss">port</span><span class="p" data-group-id="8322871305-1">)</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="mf">1.1</span><span class="p">.</span><span class="mf">1.1</span><span class="p">:</span><span class="mi">53</span><span class="w">     </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">BLOCKED</span><span class="w"> </span><span class="p" data-group-id="8322871305-2">(</span><span class="ss">wrong</span><span class="w"> </span><span class="ss">host</span><span class="p" data-group-id="8322871305-2">)</span></code></pre><h3 id="3-allocation-policy-how-nat-chooses-external-ports" class="section-heading"><a href="#3-allocation-policy-how-nat-chooses-external-ports" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Allocation Policy (How NAT chooses external ports)</span></h3><table><thead><tr><th style="text-align: left;">Policy</th><th style="text-align: left;">Code</th><th style="text-align: left;">Behavior</th><th style="text-align: left;">Predictability</th></tr></thead><tbody><tr><td style="text-align: left;"><strong>Port-Preservation</strong></td><td style="text-align: left;">PP</td><td style="text-align: left;">external_port = local_port</td><td style="text-align: left;">High</td></tr><tr><td style="text-align: left;"><strong>Port-Contiguity</strong></td><td style="text-align: left;">PC</td><td style="text-align: left;">external_port = last_port + delta</td><td style="text-align: left;">Medium</td></tr><tr><td style="text-align: left;"><strong>Random</strong></td><td style="text-align: left;">RD</td><td style="text-align: left;">No predictable pattern</td><td style="text-align: left;">None</td></tr></tbody></table><p><strong>Example - Port-Preservation (PP):</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p">:</span><span class="mi">5000</span><span class="w">  </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">5000</span><span class="w">  </span><span class="p" data-group-id="2979274869-1">(</span><span class="ss">same</span><span class="w"> </span><span class="ss">port</span><span class="o">!</span><span class="p" data-group-id="2979274869-1">)</span></code></pre><p><strong>Example - Port-Contiguity (PC):</strong></p><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p">:</span><span class="mi">5000</span><span class="w">  </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w">
</span><span class="n">Local</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p">:</span><span class="mi">5001</span><span class="w">  </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40001</span><span class="w">  </span><span class="p" data-group-id="9839047354-1">(</span><span class="ss">delta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9839047354-1">)</span></code></pre><hr class="thin"/><h2 id="common-nat-type-combinations" class="section-heading"><a href="#common-nat-type-combinations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common NAT Type Combinations</span></h2><p>Based on NATCracker research across millions of NATs:</p><table><thead><tr><th style="text-align: left;">Type</th><th style="text-align: left;">Mapping</th><th style="text-align: left;">Filtering</th><th style="text-align: left;">Allocation</th><th style="text-align: left;">Prevalence</th><th style="text-align: left;">Direct P2P</th></tr></thead><tbody><tr><td style="text-align: left;">Full Cone</td><td style="text-align: left;">EI</td><td style="text-align: left;">EI</td><td style="text-align: left;">PP</td><td style="text-align: left;">15%</td><td style="text-align: left;">Yes</td></tr><tr><td style="text-align: left;">Restricted Cone</td><td style="text-align: left;">EI</td><td style="text-align: left;">HD</td><td style="text-align: left;">PP</td><td style="text-align: left;">37%</td><td style="text-align: left;">With punch</td></tr><tr><td style="text-align: left;">Port Restricted</td><td style="text-align: left;">EI</td><td style="text-align: left;">PD</td><td style="text-align: left;">PP</td><td style="text-align: left;">20%</td><td style="text-align: left;">With punch</td></tr><tr><td style="text-align: left;">Symmetric</td><td style="text-align: left;">PD</td><td style="text-align: left;">PD</td><td style="text-align: left;">RD</td><td style="text-align: left;">12%</td><td style="text-align: left;">No (relay)</td></tr><tr><td style="text-align: left;">CGNAT</td><td style="text-align: left;">varies</td><td style="text-align: left;">PD</td><td style="text-align: left;">varies</td><td style="text-align: left;">16%</td><td style="text-align: left;">Usually relay</td></tr></tbody></table><h3 id="full-cone-nat-ei-ei-pp-best-case" class="section-heading"><a href="#full-cone-nat-ei-ei-pp-best-case" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Full Cone NAT (EI, EI, PP) - Best Case</span></h3><pre><code class="makeup erlang" translate="no"><span class="w">                   </span><span class="n">Internet</span><span class="w">
                      </span><span class="p">|</span><span class="w">
                 </span><span class="p" data-group-id="8372938312-1">[</span><span class="n">Full</span><span class="w"> </span><span class="n">Cone</span><span class="w"> </span><span class="n">NAT</span><span class="p" data-group-id="8372938312-1">]</span><span class="w">
                      </span><span class="p">|</span><span class="w">
             </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">5000</span><span class="w">
                      </span><span class="p">|</span><span class="w">
</span><span class="n">Any</span><span class="w"> </span><span class="ss">external</span><span class="w"> </span><span class="ss">host</span><span class="w"> </span><span class="ss">can</span><span class="w"> </span><span class="nb">send</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">this</span><span class="w"> </span><span class="ss">address</span><span class="w">
</span><span class="k">after</span><span class="w"> </span><span class="n">ANY</span><span class="w"> </span><span class="ss">outbound</span><span class="w"> </span><span class="ss">packet</span><span class="w"> </span><span class="ss">from</span><span class="w"> </span><span class="ss">local</span><span class="w"> </span><span class="ss">peer</span><span class="w">

</span><span class="n">Direct</span><span class="w"> </span><span class="n">P2P</span><span class="p">:</span><span class="w"> </span><span class="n">YES</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Any</span><span class="w"> </span><span class="ss">peer</span><span class="w"> </span><span class="ss">can</span><span class="w"> </span><span class="ss">connect</span><span class="w"> </span><span class="ss">directly</span></code></pre><h3 id="restricted-cone-nat-ei-hd-pp-good" class="section-heading"><a href="#restricted-cone-nat-ei-hd-pp-good" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Restricted Cone NAT (EI, HD, PP) - Good</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="w"> </span><span class="ss">sends</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="n">A</span><span class="w">
  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">External</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">5000</span><span class="w">

</span><span class="n">Now</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="p" data-group-id="6815381039-1">(</span><span class="ss">any</span><span class="w"> </span><span class="ss">port</span><span class="p" data-group-id="6815381039-1">)</span><span class="w"> </span><span class="ss">can</span><span class="w"> </span><span class="nb">send</span><span class="w"> </span><span class="ss">back</span><span class="w">
</span><span class="n">Host</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="ss">cannot</span><span class="w"> </span><span class="nf">send</span><span class="w"> </span><span class="p" data-group-id="6815381039-2">(</span><span class="ss">never</span><span class="w"> </span><span class="ss">contacted</span><span class="p" data-group-id="6815381039-2">)</span><span class="w">

</span><span class="n">Direct</span><span class="w"> </span><span class="n">P2P</span><span class="p">:</span><span class="w"> </span><span class="n">YES</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="ss">hole</span><span class="w"> </span><span class="ss">punching</span></code></pre><h3 id="symmetric-nat-pd-pd-rd-worst-case" class="section-heading"><a href="#symmetric-nat-pd-pd-rd-worst-case" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Symmetric NAT (PD, PD, RD) - Worst Case</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Local</span><span class="w"> </span><span class="ss">sends</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="n">A</span><span class="p">:</span><span class="n">Port1</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40000</span><span class="w">
</span><span class="n">Local</span><span class="w"> </span><span class="ss">sends</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">Host</span><span class="w"> </span><span class="n">B</span><span class="p">:</span><span class="n">Port2</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">NAT</span><span class="p">:</span><span class="w"> </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="p">:</span><span class="mi">40001</span><span class="w"> </span><span class="p" data-group-id="4436320423-1">(</span><span class="ss">different</span><span class="o">!</span><span class="p" data-group-id="4436320423-1">)</span><span class="w">

</span><span class="n">Each</span><span class="w"> </span><span class="ss">destination</span><span class="w"> </span><span class="ss">gets</span><span class="w"> </span><span class="ss">different</span><span class="w"> </span><span class="ss">external</span><span class="w"> </span><span class="ss">address</span><span class="w">
</span><span class="n">External</span><span class="w"> </span><span class="ss">port</span><span class="w"> </span><span class="ss">is</span><span class="w"> </span><span class="ss">random</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ss">unpredictable</span><span class="w">

</span><span class="n">Direct</span><span class="w"> </span><span class="n">P2P</span><span class="p">:</span><span class="w"> </span><span class="n">NO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="ss">must</span><span class="w"> </span><span class="ss">use</span><span class="w"> </span><span class="ss">relay</span></code></pre><hr class="thin"/><h2 id="nat-detection-in-macula" class="section-heading"><a href="#nat-detection-in-macula" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">NAT Detection in Macula</span></h2><p>Macula detects NAT type automatically using <code class="inline">macula_nat_detector</code>:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get local NAT profile</span><span class="w">
</span><span class="p" data-group-id="7119200787-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="7119200787-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">get_local_profile</span><span class="p" data-group-id="7119200787-2">(</span><span class="p" data-group-id="7119200787-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Profile contains:</span><span class="w">
</span><span class="p" data-group-id="7119200787-3">#{</span><span class="w">
    </span><span class="ss">mapping</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ei</span><span class="p">,</span><span class="w">           </span><span class="c1">% Endpoint-Independent</span><span class="w">
    </span><span class="ss">filtering</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">pd</span><span class="p">,</span><span class="w">         </span><span class="c1">% Port-Dependent</span><span class="w">
    </span><span class="ss">allocation</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">pp</span><span class="p">,</span><span class="w">        </span><span class="c1">% Port-Preservation</span><span class="w">
    </span><span class="ss">public_ip</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7119200787-4">{</span><span class="mi">203</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">5</span><span class="p" data-group-id="7119200787-4">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">public_port</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">,</span><span class="w">
    </span><span class="ss">detected_at</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1700000000</span><span class="w">
</span><span class="p" data-group-id="7119200787-3">}</span></code></pre><h3 id="detection-algorithm" class="section-heading"><a href="#detection-algorithm" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Detection Algorithm</span></h3><ol><li><p><strong>Send NAT_PROBE to primary observer</strong> (gateway/public peer)</p><ul><li>Receive reflexive address (your public IP:port as seen from outside)</li></ul></li><li><p><strong>Send NAT_PROBE to secondary observer</strong> (different public peer)</p><ul><li>Compare reflexive addresses</li></ul></li><li><p><strong>Classification:</strong></p><ul><li>Same address for both observers -&gt; EI mapping</li><li>Same IP, different port -&gt; HD mapping</li><li>Different IP -&gt; PD mapping (or multiple NATs)</li></ul></li></ol><hr class="thin"/><h2 id="connection-strategy-decision-tree" class="section-heading"><a href="#connection-strategy-decision-tree" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Strategy Decision Tree</span></h2><p>Macula's <code class="inline">macula_nat_coordinator</code> uses this decision tree:</p><pre><code class="makeup erlang" translate="no"><span class="n">Start</span><span class="p">:</span><span class="w"> </span><span class="n">Want</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">connect</span><span class="w"> </span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">&lt;-</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Peer</span><span class="w"> </span><span class="n">B</span><span class="w">
  </span><span class="p">|</span><span class="w">
  </span><span class="ss">v</span><span class="w">
</span><span class="n">Either</span><span class="w"> </span><span class="ss">has</span><span class="w"> </span><span class="ss">public</span><span class="w"> </span><span class="n">IP</span><span class="o">?</span><span class="w">
  </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">YES</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Direct</span><span class="w"> </span><span class="ss">connection</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">public</span><span class="w"> </span><span class="ss">peer</span><span class="w">
  </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">NO</span><span class="w">  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Check</span><span class="w"> </span><span class="n">NAT</span><span class="w"> </span><span class="ss">profiles</span><span class="w">
              </span><span class="p">|</span><span class="w">
              </span><span class="ss">v</span><span class="w">
         </span><span class="n">Both</span><span class="w"> </span><span class="ss">have</span><span class="w"> </span><span class="n">EI</span><span class="w"> </span><span class="ss">mapping</span><span class="o">?</span><span class="w">
           </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">YES</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Hole</span><span class="w"> </span><span class="ss">punching</span><span class="w"> </span><span class="ss">possible</span><span class="w">
           </span><span class="p">|</span><span class="w">          </span><span class="p">|</span><span class="w">
           </span><span class="p">|</span><span class="w">          </span><span class="ss">v</span><span class="w">
           </span><span class="p">|</span><span class="w">     </span><span class="n">Any</span><span class="w"> </span><span class="ss">has</span><span class="w"> </span><span class="n">EI</span><span class="w"> </span><span class="ss">filtering</span><span class="o">?</span><span class="w">
           </span><span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">YES</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Simple</span><span class="w"> </span><span class="ss">hole</span><span class="w"> </span><span class="ss">punch</span><span class="w">
           </span><span class="p">|</span><span class="w">       </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">NO</span><span class="w">  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Coordinated</span><span class="w"> </span><span class="ss">hole</span><span class="w"> </span><span class="ss">punch</span><span class="w">
           </span><span class="p">|</span><span class="w">
           </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">NO</span><span class="w">  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Either</span><span class="w"> </span><span class="ss">has</span><span class="w"> </span><span class="n">PD</span><span class="o">+</span><span class="n">PD</span><span class="o">+</span><span class="n">RD</span><span class="w"> </span><span class="p" data-group-id="9412252201-1">(</span><span class="ss">symmetric</span><span class="p" data-group-id="9412252201-1">)</span><span class="o">?</span><span class="w">
                        </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">YES</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Must</span><span class="w"> </span><span class="ss">use</span><span class="w"> </span><span class="ss">relay</span><span class="w">
                        </span><span class="p">|</span><span class="o">--</span><span class="w"> </span><span class="n">NO</span><span class="w">  </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Try</span><span class="w"> </span><span class="ss">hole</span><span class="w"> </span><span class="ss">punch</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="ss">prediction</span></code></pre><hr class="thin"/><h2 id="hole-punching-explained" class="section-heading"><a href="#hole-punching-explained" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Hole Punching Explained</span></h2><p>Hole punching creates NAT mappings that allow peers to communicate:</p><pre><code class="makeup erlang" translate="no"><span class="n">Time</span><span class="w"> </span><span class="n">T0</span><span class="p">:</span><span class="w"> </span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="ss">have</span><span class="w"> </span><span class="ss">no</span><span class="w"> </span><span class="ss">mappings</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">each</span><span class="w"> </span><span class="ss">other</span><span class="w">

</span><span class="n">Time</span><span class="w"> </span><span class="n">T1</span><span class="p">:</span><span class="w"> </span><span class="n">Coordinator</span><span class="w"> </span><span class="ss">tells</span><span class="w"> </span><span class="ss">both</span><span class="w"> </span><span class="ss">peers</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="nb">send</span><span class="w"> </span><span class="ss">packet</span><span class="w">
         </span><span class="n">Peer</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="ss">sends</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="n">Peer</span><span class="w"> </span><span class="n">B</span><span class="ss">&#39;s predicted external addr
         Peer B sends to Peer A&#39;</span><span class="ss">s</span><span class="w"> </span><span class="ss">predicted</span><span class="w"> </span><span class="ss">external</span><span class="w"> </span><span class="ss">addr</span><span class="w">

</span><span class="n">Time</span><span class="w"> </span><span class="n">T2</span><span class="p">:</span><span class="w"> </span><span class="n">Packets</span><span class="w"> </span><span class="ss">arrive</span><span class="w"> </span><span class="ss">at</span><span class="w"> </span><span class="n">NATs</span><span class="w">
         </span><span class="n">NAT</span><span class="w"> </span><span class="n">A</span><span class="p">:</span><span class="w"> </span><span class="n">Creates</span><span class="w"> </span><span class="ss">mapping</span><span class="w"> </span><span class="ss">for</span><span class="w"> </span><span class="n">B</span><span class="ss">&#39;s address (outbound packet)
         NAT B: Creates mapping for A&#39;</span><span class="ss">s</span><span class="w"> </span><span class="nf">address</span><span class="w"> </span><span class="p" data-group-id="7376577088-1">(</span><span class="ss">outbound</span><span class="w"> </span><span class="ss">packet</span><span class="p" data-group-id="7376577088-1">)</span><span class="w">

</span><span class="n">Time</span><span class="w"> </span><span class="n">T3</span><span class="p">:</span><span class="w"> </span><span class="n">Subsequent</span><span class="w"> </span><span class="ss">packets</span><span class="w"> </span><span class="ss">pass</span><span class="w"> </span><span class="ss">through</span><span class="w"> </span><span class="ss">created</span><span class="w"> </span><span class="ss">mappings</span><span class="w">
         </span><span class="n">Direct</span><span class="w"> </span><span class="ss">communication</span><span class="w"> </span><span class="ss">established</span><span class="o">!</span></code></pre><p><strong>Requirements for successful hole punch:</strong></p><ul><li>Both NATs have EI or HD mapping (predictable external address)</li><li>At least one has PP or PC allocation (predictable port)</li><li>Timing coordination within ~100ms</li></ul><hr class="thin"/><h2 id="cgnat-carrier-grade-nat" class="section-heading"><a href="#cgnat-carrier-grade-nat" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">CGNAT (Carrier-Grade NAT)</span></h2><p>ISPs increasingly use CGNAT, adding another NAT layer:</p><pre><code class="makeup erlang" translate="no"><span class="n">Your</span><span class="w"> </span><span class="n">Device</span><span class="w"> </span><span class="p" data-group-id="0607995009-1">(</span><span class="mf">192.168</span><span class="p">.</span><span class="mf">1.10</span><span class="p" data-group-id="0607995009-1">)</span><span class="w">
       </span><span class="p">|</span><span class="w">
   </span><span class="p" data-group-id="0607995009-2">[</span><span class="n">Home</span><span class="w"> </span><span class="n">Router</span><span class="w"> </span><span class="n">NAT</span><span class="p" data-group-id="0607995009-2">]</span><span class="w">
       </span><span class="p">|</span><span class="w">
   </span><span class="mf">10.0</span><span class="p">.</span><span class="mf">0.50</span><span class="w"> </span><span class="p" data-group-id="0607995009-3">(</span><span class="n">ISP</span><span class="w"> </span><span class="ss">private</span><span class="p" data-group-id="0607995009-3">)</span><span class="w">
       </span><span class="p">|</span><span class="w">
   </span><span class="p" data-group-id="0607995009-4">[</span><span class="n">CGNAT</span><span class="p" data-group-id="0607995009-4">]</span><span class="w">
       </span><span class="p">|</span><span class="w">
   </span><span class="mf">203.0</span><span class="p">.</span><span class="mf">113.5</span><span class="w"> </span><span class="p" data-group-id="0607995009-5">(</span><span class="ss">public</span><span class="p" data-group-id="0607995009-5">)</span><span class="w">
       </span><span class="p">|</span><span class="w">
   </span><span class="n">Internet</span></code></pre><p>CGNAT complications:</p><ul><li>Multiple customers share same public IP</li><li>Often uses PD filtering (restrictive)</li><li>Hole punching success rate drops to ~40%</li><li>Relay fallback frequently needed</li></ul><hr class="thin"/><h2 id="best-practices" class="section-heading"><a href="#best-practices" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Best Practices</span></h2><h3 id="for-application-developers" class="section-heading"><a href="#for-application-developers" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">For Application Developers</span></h3><ol><li><strong>Always have relay fallback</strong> - Some NATs cannot be traversed</li><li><strong>Detect NAT type early</strong> - Cache profile at peer startup</li><li><strong>Prefer EI-mapping peers as coordinators</strong> - Better success rate</li></ol><h3 id="for-network-operators" class="section-heading"><a href="#for-network-operators" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">For Network Operators</span></h3><ol><li><strong>Use Full Cone or Restricted Cone NAT</strong> - Best P2P compatibility</li><li><strong>Enable UPnP/NAT-PMP</strong> - Allows applications to request mappings</li><li><strong>Avoid Symmetric NAT</strong> - Breaks most P2P protocols</li></ol><hr class="thin"/><h2 id="further-reading" class="section-heading"><a href="#further-reading" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Further Reading</span></h2><ul><li><a href="https://tools.ietf.org/html/rfc5780">RFC 5780 - NAT Behavior Discovery</a></li><li><a href="https://www.usenix.org/conference/nsdi21/presentation/tang">NATCracker Paper</a> - 27 NAT type classification</li></ul><hr class="thin"/><p><strong>See Also:</strong></p><ul><li><a href="nat_traversal_developer_guide.html">NAT Traversal Developer Guide</a> - API usage and code examples</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="dht_guide.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
DHT Architecture
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="nat_traversal_developer_guide.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
NAT Traversal
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.12.6" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.12.6">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.12.6/show/docs/guides/NAT_TYPES_EXPLAINED.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
