<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.12.6">


    <title>Troubleshooting â€” macula v0.12.6</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-969EFB48.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="overview.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="overview.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.12.6
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula Troubleshooting Guide</h1>


      <a href="https://github.com/macula-io/macula/blob/0.12.6/docs/operator/TROUBLESHOOTING_GUIDE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Diagnosing and resolving common issues in Macula deployments</strong></p><p><strong>Audience</strong>: Operators, Developers
<strong>Last Updated</strong>: 2025-11-28</p><hr class="thin"/><h2 id="table-of-contents" class="section-heading"><a href="#table-of-contents" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Table of Contents</span></h2><ol><li><a href="#quick-diagnostics">Quick Diagnostics</a></li><li><a href="#connection-issues">Connection Issues</a></li><li><a href="#rpc-problems">RPC Problems</a></li><li><a href="#pubsub-problems">PubSub Problems</a></li><li><a href="#memory-issues">Memory Issues</a></li><li><a href="#dht-problems">DHT Problems</a></li><li><a href="#performance-issues">Performance Issues</a></li><li><a href="#gateway-issues">Gateway Issues</a></li><li><a href="#debug-tools">Debug Tools</a></li></ol><hr class="thin"/><h2 id="quick-diagnostics" class="section-heading"><a href="#quick-diagnostics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Quick Diagnostics</span></h2><h3 id="first-steps-checklist" class="section-heading"><a href="#first-steps-checklist" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">First Steps Checklist</span></h3><pre><code class="makeup erlang" translate="no"><span class="mi">1</span><span class="p">.</span><span class="w"> </span><span class="p" data-group-id="0055232470-1">[</span><span class="w"> </span><span class="p" data-group-id="0055232470-1">]</span><span class="w"> </span><span class="n">Is</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">gateway</span><span class="w"> </span><span class="ss">process</span><span class="w"> </span><span class="ss">running</span><span class="o">?</span><span class="w">
</span><span class="mi">2</span><span class="p">.</span><span class="w"> </span><span class="p" data-group-id="0055232470-2">[</span><span class="w"> </span><span class="p" data-group-id="0055232470-2">]</span><span class="w"> </span><span class="n">Are</span><span class="w"> </span><span class="ss">all</span><span class="w"> </span><span class="ss">supervisors</span><span class="w"> </span><span class="ss">alive</span><span class="o">?</span><span class="w">
</span><span class="mi">3</span><span class="p">.</span><span class="w"> </span><span class="p" data-group-id="0055232470-3">[</span><span class="w"> </span><span class="p" data-group-id="0055232470-3">]</span><span class="w"> </span><span class="n">Can</span><span class="w"> </span><span class="ss">you</span><span class="w"> </span><span class="ss">reach</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">bootstrap</span><span class="w"> </span><span class="nb">node</span><span class="o">?</span><span class="w">
</span><span class="mi">4</span><span class="p">.</span><span class="w"> </span><span class="p" data-group-id="0055232470-4">[</span><span class="w"> </span><span class="p" data-group-id="0055232470-4">]</span><span class="w"> </span><span class="n">Is</span><span class="w"> </span><span class="n">TLS</span><span class="w"> </span><span class="ss">configured</span><span class="w"> </span><span class="ss">correctly</span><span class="o">?</span><span class="w">
</span><span class="mi">5</span><span class="p">.</span><span class="w"> </span><span class="p" data-group-id="0055232470-5">[</span><span class="w"> </span><span class="p" data-group-id="0055232470-5">]</span><span class="w"> </span><span class="n">Are</span><span class="w"> </span><span class="ss">there</span><span class="w"> </span><span class="ss">errors</span><span class="w"> </span><span class="ss">in</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">logs</span><span class="o">?</span></code></pre><h3 id="erlang-shell-health-check" class="section-heading"><a href="#erlang-shell-health-check" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Erlang Shell Health Check</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Quick health check script</span><span class="w">
</span><span class="n">QuickCheck</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9766169269-1">(</span><span class="p" data-group-id="9766169269-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9766169269-2">(</span><span class="s">&quot;Gateway: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9766169269-3">[</span><span class="nf">is_pid</span><span class="p" data-group-id="9766169269-4">(</span><span class="nf">whereis</span><span class="p" data-group-id="9766169269-5">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="9766169269-5">)</span><span class="p" data-group-id="9766169269-4">)</span><span class="p" data-group-id="9766169269-3">]</span><span class="p" data-group-id="9766169269-2">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9766169269-6">(</span><span class="s">&quot;Sup: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9766169269-7">[</span><span class="nf">is_pid</span><span class="p" data-group-id="9766169269-8">(</span><span class="nf">whereis</span><span class="p" data-group-id="9766169269-9">(</span><span class="ss">macula_sup</span><span class="p" data-group-id="9766169269-9">)</span><span class="p" data-group-id="9766169269-8">)</span><span class="p" data-group-id="9766169269-7">]</span><span class="p" data-group-id="9766169269-6">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9766169269-10">(</span><span class="s">&quot;Clients: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9766169269-11">[</span><span class="nc">macula_gateway_client_manager</span><span class="p">:</span><span class="nf">count</span><span class="p" data-group-id="9766169269-12">(</span><span class="p" data-group-id="9766169269-12">)</span><span class="p" data-group-id="9766169269-11">]</span><span class="p" data-group-id="9766169269-10">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9766169269-13">(</span><span class="s">&quot;Services: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9766169269-14">[</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">count_services</span><span class="p" data-group-id="9766169269-15">(</span><span class="p" data-group-id="9766169269-15">)</span><span class="p" data-group-id="9766169269-14">]</span><span class="p" data-group-id="9766169269-13">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w">
</span><span class="k">end</span><span class="p">,</span><span class="w">
</span><span class="n">QuickCheck</span><span class="p" data-group-id="9766169269-16">(</span><span class="p" data-group-id="9766169269-16">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="connection-issues" class="section-heading"><a href="#connection-issues" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Issues</span></h2><h3 id="problem-clients-can-t-connect" class="section-heading"><a href="#problem-clients-can-t-connect" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Clients Can't Connect</span></h3><p><strong>Symptoms:</strong></p><ul><li>Connection timeouts</li><li>TLS handshake failures</li><li>&quot;Connection refused&quot; errors</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check listener is running</span><span class="w">
</span><span class="nf">is_pid</span><span class="p" data-group-id="1068422100-1">(</span><span class="nf">whereis</span><span class="p" data-group-id="1068422100-2">(</span><span class="ss">macula_quic_listener</span><span class="p" data-group-id="1068422100-2">)</span><span class="p" data-group-id="1068422100-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 2. Check port is bound</span><span class="w">
</span><span class="c1">%% From shell:</span><span class="w">
</span><span class="c1">%% netstat -tlnp | grep 4433</span><span class="w">

</span><span class="c1">%% 3. Check TLS certificates</span><span class="w">
</span><span class="nc">ssl</span><span class="p">:</span><span class="nf">peercert</span><span class="p" data-group-id="1068422100-3">(</span><span class="n">Socket</span><span class="p" data-group-id="1068422100-3">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Firewall blocking UDP</td><td style="text-align: left;">Open UDP port 4433 (or configured port)</td></tr><tr><td style="text-align: left;">TLS cert expired</td><td style="text-align: left;">Renew certificates</td></tr><tr><td style="text-align: left;">Wrong cert path in config</td><td style="text-align: left;">Verify <code class="inline">certfile</code> and <code class="inline">keyfile</code> paths</td></tr><tr><td style="text-align: left;">Listener crashed</td><td style="text-align: left;">Check supervisor, restart gateway</td></tr><tr><td style="text-align: left;">Max clients reached</td><td style="text-align: left;">Scale horizontally or increase limit</td></tr></tbody></table><p><strong>Fix: TLS Certificate Issues</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Verify certificate is readable</span><span class="w">
</span><span class="nc">file</span><span class="p">:</span><span class="nf">read_file</span><span class="p" data-group-id="1003704783-1">(</span><span class="s">&quot;/path/to/cert.pem&quot;</span><span class="p" data-group-id="1003704783-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Check certificate validity</span><span class="w">
</span><span class="nc">ssl</span><span class="p">:</span><span class="nf">pkix_verify_certificate_chain</span><span class="p" data-group-id="1003704783-2">(</span><span class="n">CertDer</span><span class="p">,</span><span class="w"> </span><span class="n">TrustedCerts</span><span class="p" data-group-id="1003704783-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Check expiration date</span><span class="w">
</span><span class="c1">%% openssl x509 -in cert.pem -noout -dates</span></code></pre><hr class="thin"/><h3 id="problem-connections-drop-unexpectedly" class="section-heading"><a href="#problem-connections-drop-unexpectedly" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Connections Drop Unexpectedly</span></h3><p><strong>Symptoms:</strong></p><ul><li>Clients disconnect randomly</li><li>&quot;connection_closed&quot; errors</li><li>High reconnection rate</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check for QUIC transport errors in logs</span><span class="w">
</span><span class="c1">%% grep -i &quot;quic\|transport\|closed&quot; /var/log/macula.log</span><span class="w">

</span><span class="c1">%% Check connection state</span><span class="w">
</span><span class="nc">sys</span><span class="p">:</span><span class="nf">get_state</span><span class="p" data-group-id="9748413673-1">(</span><span class="n">ClientPid</span><span class="p" data-group-id="9748413673-1">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Network instability</td><td style="text-align: left;">Check network path, MTU settings</td></tr><tr><td style="text-align: left;">Idle timeout</td><td style="text-align: left;">Adjust <code class="inline">idle_timeout_ms</code> in QUIC config</td></tr><tr><td style="text-align: left;">NAT timeout</td><td style="text-align: left;">Enable keepalives</td></tr><tr><td style="text-align: left;">Resource limits</td><td style="text-align: left;">Check ulimit, file descriptor limits</td></tr></tbody></table><p><strong>Fix: Idle Timeout</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% In sys.config</span><span class="w">
</span><span class="p" data-group-id="4816399982-1">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4816399982-2">[</span><span class="w">
    </span><span class="p" data-group-id="4816399982-3">{</span><span class="ss">quic_options</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4816399982-4">[</span><span class="w">
        </span><span class="p" data-group-id="4816399982-5">{</span><span class="ss">idle_timeout_ms</span><span class="p">,</span><span class="w"> </span><span class="mi">300000</span><span class="p" data-group-id="4816399982-5">}</span><span class="w">  </span><span class="c1">%% 5 minutes</span><span class="w">
    </span><span class="p" data-group-id="4816399982-4">]</span><span class="p" data-group-id="4816399982-3">}</span><span class="w">
</span><span class="p" data-group-id="4816399982-2">]</span><span class="p" data-group-id="4816399982-1">}</span></code></pre><hr class="thin"/><h2 id="rpc-problems" class="section-heading"><a href="#rpc-problems" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">RPC Problems</span></h2><h3 id="problem-rpc-calls-timeout" class="section-heading"><a href="#problem-rpc-calls-timeout" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: RPC Calls Timeout</span></h3><p><strong>Symptoms:</strong></p><ul><li><code class="inline">{error, timeout}</code> returned from calls</li><li>Slow response times</li><li>High pending call count</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check pending calls</span><span class="w">
</span><span class="nc">sys</span><span class="p">:</span><span class="nf">get_state</span><span class="p" data-group-id="1118707592-1">(</span><span class="ss">macula_rpc_handler</span><span class="p" data-group-id="1118707592-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Look at pending_calls map size</span><span class="w">

</span><span class="c1">%% 2. Check if service is registered</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">lookup</span><span class="p" data-group-id="1118707592-2">(</span><span class="p" data-group-id="1118707592-3">&lt;&lt;</span><span class="s">&quot;energy.home.get&quot;</span><span class="p" data-group-id="1118707592-3">&gt;&gt;</span><span class="p" data-group-id="1118707592-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 3. Check DHT for providers</span><span class="w">
</span><span class="nc">macula_dht</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="1118707592-4">(</span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="1118707592-5">(</span><span class="ss">sha256</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1118707592-6">&lt;&lt;</span><span class="s">&quot;energy.home.get&quot;</span><span class="p" data-group-id="1118707592-6">&gt;&gt;</span><span class="p" data-group-id="1118707592-5">)</span><span class="p" data-group-id="1118707592-4">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Service not registered</td><td style="text-align: left;">Verify provider called <a href="https://www.erlang.org/doc/apps/erts/erlang.html#register/2"><code class="inline">register/2</code></a></td></tr><tr><td style="text-align: left;">Provider unreachable</td><td style="text-align: left;">Check provider node connectivity</td></tr><tr><td style="text-align: left;">Handler too slow</td><td style="text-align: left;">Profile handler, add async processing</td></tr><tr><td style="text-align: left;">DHT not propagated</td><td style="text-align: left;">Wait for DHT sync (up to 30s)</td></tr><tr><td style="text-align: left;">Network partition</td><td style="text-align: left;">Check mesh connectivity</td></tr></tbody></table><p><strong>Fix: Increase Timeout</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% For specific calls</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="6928950430-1">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6928950430-2">&lt;&lt;</span><span class="s">&quot;slow.procedure&quot;</span><span class="p" data-group-id="6928950430-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6928950430-3">#{</span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">30000</span><span class="p" data-group-id="6928950430-3">}</span><span class="p" data-group-id="6928950430-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Global default (sys.config)</span><span class="w">
</span><span class="p" data-group-id="6928950430-4">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6928950430-5">[</span><span class="w">
    </span><span class="p" data-group-id="6928950430-6">{</span><span class="ss">rpc_timeout_ms</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p" data-group-id="6928950430-6">}</span><span class="w">  </span><span class="c1">%% 10 seconds</span><span class="w">
</span><span class="p" data-group-id="6928950430-5">]</span><span class="p" data-group-id="6928950430-4">}</span></code></pre><hr class="thin"/><h3 id="problem-rpc-returns-no-provider" class="section-heading"><a href="#problem-rpc-returns-no-provider" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: RPC Returns &quot;No Provider&quot;</span></h3><p><strong>Symptoms:</strong></p><ul><li><code class="inline">{error, no_provider}</code> returned</li><li>Service works on some nodes but not others</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check local registry</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">list_services</span><span class="p" data-group-id="6743976743-1">(</span><span class="p" data-group-id="6743976743-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 2. Check DHT directly</span><span class="w">
</span><span class="n">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="6743976743-2">(</span><span class="ss">sha256</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6743976743-3">&lt;&lt;</span><span class="s">&quot;my.procedure&quot;</span><span class="p" data-group-id="6743976743-3">&gt;&gt;</span><span class="p" data-group-id="6743976743-2">)</span><span class="p">,</span><span class="w">
</span><span class="nc">macula_dht</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="6743976743-4">(</span><span class="n">Key</span><span class="p" data-group-id="6743976743-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 3. Check if advertised recently</span><span class="w">
</span><span class="nc">macula_advertisement_manager</span><span class="p">:</span><span class="nf">get_last_advertised</span><span class="p" data-group-id="6743976743-5">(</span><span class="p" data-group-id="6743976743-6">&lt;&lt;</span><span class="s">&quot;my.procedure&quot;</span><span class="p" data-group-id="6743976743-6">&gt;&gt;</span><span class="p" data-group-id="6743976743-5">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Service not advertised</td><td style="text-align: left;">Call <a href="macula.html#advertise/3"><code class="inline">macula:advertise/3</code></a></td></tr><tr><td style="text-align: left;">TTL expired</td><td style="text-align: left;">Re-advertise (auto every 60s)</td></tr><tr><td style="text-align: left;">DHT not synced</td><td style="text-align: left;">Wait, then query bootstrap node</td></tr><tr><td style="text-align: left;">Wrong procedure name</td><td style="text-align: left;">Check for typos in procedure name</td></tr></tbody></table><hr class="thin"/><h2 id="pubsub-problems" class="section-heading"><a href="#pubsub-problems" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">PubSub Problems</span></h2><h3 id="problem-subscribers-not-receiving-events" class="section-heading"><a href="#problem-subscribers-not-receiving-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Subscribers Not Receiving Events</span></h3><p><strong>Symptoms:</strong></p><ul><li>Publisher succeeds but subscribers get nothing</li><li>Works locally but not across mesh</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check subscription is active</span><span class="w">
</span><span class="nc">macula_pubsub_handler</span><span class="p">:</span><span class="nf">list_subscriptions</span><span class="p" data-group-id="7119405638-1">(</span><span class="p" data-group-id="7119405638-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 2. Check DHT for subscribers</span><span class="w">
</span><span class="n">Topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7119405638-2">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="7119405638-2">&gt;&gt;</span><span class="p">,</span><span class="w">
</span><span class="n">Key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="7119405638-3">(</span><span class="ss">sha256</span><span class="p">,</span><span class="w"> </span><span class="n">Topic</span><span class="p" data-group-id="7119405638-3">)</span><span class="p">,</span><span class="w">
</span><span class="nc">macula_dht</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7119405638-4">(</span><span class="n">Key</span><span class="p" data-group-id="7119405638-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 3. Verify subscriber endpoint is reachable</span><span class="w">
</span><span class="nc">macula_peer_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="7119405638-5">(</span><span class="n">Endpoint</span><span class="p" data-group-id="7119405638-5">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Subscription not in DHT</td><td style="text-align: left;">Re-subscribe, wait for propagation</td></tr><tr><td style="text-align: left;">Wildcard mismatch</td><td style="text-align: left;">Verify wildcard pattern syntax</td></tr><tr><td style="text-align: left;">Subscriber crashed</td><td style="text-align: left;">Check subscriber process, restart</td></tr><tr><td style="text-align: left;">Endpoint unreachable</td><td style="text-align: left;">Fix network/firewall</td></tr><tr><td style="text-align: left;">Cache stale</td><td style="text-align: left;">Wait for cache refresh (60s TTL)</td></tr></tbody></table><p><strong>Fix: Force DHT Refresh</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Clear subscriber cache for topic</span><span class="w">
</span><span class="nc">macula_subscriber_cache</span><span class="p">:</span><span class="nf">invalidate</span><span class="p" data-group-id="4447546864-1">(</span><span class="p" data-group-id="4447546864-2">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="4447546864-2">&gt;&gt;</span><span class="p" data-group-id="4447546864-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Re-subscribe</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="4447546864-3">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4447546864-4">&lt;&lt;</span><span class="s">&quot;sensor.temperature&quot;</span><span class="p" data-group-id="4447546864-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Callback</span><span class="p" data-group-id="4447546864-3">)</span><span class="p">.</span></code></pre><hr class="thin"/><h3 id="problem-duplicate-events" class="section-heading"><a href="#problem-duplicate-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Duplicate Events</span></h3><p><strong>Symptoms:</strong></p><ul><li>Same event delivered multiple times</li><li>Subscribers overwhelmed</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check for multiple subscriptions</span><span class="w">
</span><span class="nc">macula_pubsub_handler</span><span class="p">:</span><span class="nf">list_subscriptions</span><span class="p" data-group-id="6091193240-1">(</span><span class="p" data-group-id="6091193240-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Should see only one entry per topic</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Multiple subscribe calls</td><td style="text-align: left;">Track subscription refs, unsubscribe first</td></tr><tr><td style="text-align: left;">Stale DHT entries</td><td style="text-align: left;">Wait for TTL expiration</td></tr><tr><td style="text-align: left;">Gateway restart during publish</td><td style="text-align: left;">Implement idempotency in subscriber</td></tr></tbody></table><hr class="thin"/><h2 id="memory-issues" class="section-heading"><a href="#memory-issues" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Memory Issues</span></h2><h3 id="problem-memory-usage-keeps-growing" class="section-heading"><a href="#problem-memory-usage-keeps-growing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Memory Usage Keeps Growing</span></h3><p><strong>Symptoms:</strong></p><ul><li>Memory climbs over hours/days</li><li>Eventually OOM crash</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check process memory</span><span class="w">
</span><span class="nc">erlang</span><span class="p">:</span><span class="nf">memory</span><span class="p" data-group-id="1063710310-1">(</span><span class="p" data-group-id="1063710310-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 2. Find top memory consumers</span><span class="w">
</span><span class="nc">lists</span><span class="p">:</span><span class="nf">sort</span><span class="p" data-group-id="1063710310-2">(</span><span class="w">
    </span><span class="nf">fun</span><span class="p" data-group-id="1063710310-3">(</span><span class="p" data-group-id="1063710310-4">{</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">A</span><span class="p" data-group-id="1063710310-4">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1063710310-5">{</span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="1063710310-5">}</span><span class="p" data-group-id="1063710310-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="k">end</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="1063710310-6">[</span><span class="p" data-group-id="1063710310-7">{</span><span class="n">Pid</span><span class="p">,</span><span class="w"> </span><span class="nf">element</span><span class="p" data-group-id="1063710310-8">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nf">process_info</span><span class="p" data-group-id="1063710310-9">(</span><span class="n">Pid</span><span class="p">,</span><span class="w"> </span><span class="nb">memory</span><span class="p" data-group-id="1063710310-9">)</span><span class="p" data-group-id="1063710310-8">)</span><span class="p" data-group-id="1063710310-7">}</span><span class="w">
     </span><span class="p">||</span><span class="w"> </span><span class="n">Pid</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">processes</span><span class="p" data-group-id="1063710310-10">(</span><span class="p" data-group-id="1063710310-10">)</span><span class="p" data-group-id="1063710310-6">]</span><span class="w">
</span><span class="p" data-group-id="1063710310-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 3. Check ETS tables</span><span class="w">
</span><span class="p" data-group-id="1063710310-11">[</span><span class="p" data-group-id="1063710310-12">{</span><span class="n">Tab</span><span class="p">,</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="1063710310-13">(</span><span class="n">Tab</span><span class="p">,</span><span class="w"> </span><span class="nb">size</span><span class="p" data-group-id="1063710310-13">)</span><span class="p">,</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="1063710310-14">(</span><span class="n">Tab</span><span class="p">,</span><span class="w"> </span><span class="nb">memory</span><span class="p" data-group-id="1063710310-14">)</span><span class="p" data-group-id="1063710310-12">}</span><span class="w">
 </span><span class="p">||</span><span class="w"> </span><span class="n">Tab</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">all</span><span class="p" data-group-id="1063710310-15">(</span><span class="p" data-group-id="1063710310-15">)</span><span class="p" data-group-id="1063710310-11">]</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Unbounded message queue</td><td style="text-align: left;">Add backpressure, check slow handlers</td></tr><tr><td style="text-align: left;">ETS table growth</td><td style="text-align: left;">Verify TTL cleanup is running</td></tr><tr><td style="text-align: left;">Process leak</td><td style="text-align: left;">Check spawn/exit patterns</td></tr><tr><td style="text-align: left;">Binary leak</td><td style="text-align: left;">Force GC: <code class="inline">erlang:garbage_collect()</code></td></tr></tbody></table><p><strong>Fix: Force Cleanup</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Trigger service cleanup manually</span><span class="w">
</span><span class="nc">macula_advertisement_manager</span><span class="p">:</span><span class="nf">cleanup_expired</span><span class="p" data-group-id="2036897406-1">(</span><span class="p" data-group-id="2036897406-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Force garbage collection on specific process</span><span class="w">
</span><span class="nc">erlang</span><span class="p">:</span><span class="nf">garbage_collect</span><span class="p" data-group-id="2036897406-2">(</span><span class="nf">whereis</span><span class="p" data-group-id="2036897406-3">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="2036897406-3">)</span><span class="p" data-group-id="2036897406-2">)</span><span class="p">.</span></code></pre><hr class="thin"/><h3 id="problem-max_clients_reached-errors" class="section-heading"><a href="#problem-max_clients_reached-errors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: &quot;max_clients_reached&quot; Errors</span></h3><p><strong>Symptoms:</strong></p><ul><li>New clients rejected</li><li>Warning logs: <code class="inline">Client connection rejected: max_clients_reached</code></li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check current client count</span><span class="w">
</span><span class="nc">macula_gateway_client_manager</span><span class="p">:</span><span class="nf">count</span><span class="p" data-group-id="4878644857-1">(</span><span class="p" data-group-id="4878644857-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Check max limit</span><span class="w">
</span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="4878644857-2">(</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="ss">max_clients</span><span class="p" data-group-id="4878644857-2">)</span><span class="p">.</span></code></pre><p><strong>Solutions:</strong></p><ol><li><strong>Scale horizontally</strong> - Add more gateway nodes</li><li><strong>Increase limit</strong> (if resources allow):<pre><code class="makeup erlang" translate="no"><span class="c1">%% In sys.config</span><span class="w">
</span><span class="p" data-group-id="2697497395-1">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2697497395-2">[</span><span class="w">
    </span><span class="p" data-group-id="2697497395-3">{</span><span class="ss">max_clients</span><span class="p">,</span><span class="w"> </span><span class="mi">20000</span><span class="p" data-group-id="2697497395-3">}</span><span class="w">  </span><span class="c1">%% Double the default</span><span class="w">
</span><span class="p" data-group-id="2697497395-2">]</span><span class="p" data-group-id="2697497395-1">}</span></code></pre></li><li><strong>Investigate client churn</strong> - Why are clients not disconnecting?</li></ol><hr class="thin"/><h2 id="dht-problems" class="section-heading"><a href="#dht-problems" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">DHT Problems</span></h2><h3 id="problem-dht-queries-timeout" class="section-heading"><a href="#problem-dht-queries-timeout" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: DHT Queries Timeout</span></h3><p><strong>Symptoms:</strong></p><ul><li>Service discovery fails</li><li><code class="inline">{error, timeout}</code> from DHT operations</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check DHT process</span><span class="w">
</span><span class="nf">is_pid</span><span class="p" data-group-id="7626085870-1">(</span><span class="nf">whereis</span><span class="p" data-group-id="7626085870-2">(</span><span class="ss">macula_dht</span><span class="p" data-group-id="7626085870-2">)</span><span class="p" data-group-id="7626085870-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 2. Check bootstrap connectivity</span><span class="w">
</span><span class="nc">macula_dht</span><span class="p">:</span><span class="nf">ping</span><span class="p" data-group-id="7626085870-3">(</span><span class="p" data-group-id="7626085870-3">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 3. Check DHT routing table</span><span class="w">
</span><span class="nc">macula_dht</span><span class="p">:</span><span class="nf">get_routing_table</span><span class="p" data-group-id="7626085870-4">(</span><span class="p" data-group-id="7626085870-4">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Bootstrap unreachable</td><td style="text-align: left;">Check network to bootstrap node</td></tr><tr><td style="text-align: left;">DHT not initialized</td><td style="text-align: left;">Wait for startup, check logs</td></tr><tr><td style="text-align: left;">Network partition</td><td style="text-align: left;">Restore connectivity</td></tr><tr><td style="text-align: left;">High DHT load</td><td style="text-align: left;">Scale bootstrap nodes</td></tr></tbody></table><hr class="thin"/><h3 id="problem-services-not-propagating" class="section-heading"><a href="#problem-services-not-propagating" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Services Not Propagating</span></h3><p><strong>Symptoms:</strong></p><ul><li>Service works on registering node</li><li>Other nodes can't discover it</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% On provider node</span><span class="w">
</span><span class="nc">macula_service_registry</span><span class="p">:</span><span class="nf">list_services</span><span class="p" data-group-id="4518048148-1">(</span><span class="p" data-group-id="4518048148-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% On consumer node</span><span class="w">
</span><span class="nc">macula_dht</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="4518048148-2">(</span><span class="nc">crypto</span><span class="p">:</span><span class="nf">hash</span><span class="p" data-group-id="4518048148-3">(</span><span class="ss">sha256</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4518048148-4">&lt;&lt;</span><span class="s">&quot;service.name&quot;</span><span class="p" data-group-id="4518048148-4">&gt;&gt;</span><span class="p" data-group-id="4518048148-3">)</span><span class="p" data-group-id="4518048148-2">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">DHT replication delay</td><td style="text-align: left;">Wait up to 30 seconds</td></tr><tr><td style="text-align: left;">Partition during advertisement</td><td style="text-align: left;">Re-advertise service</td></tr><tr><td style="text-align: left;">TTL too short</td><td style="text-align: left;">Increase <code class="inline">service_ttl_ms</code></td></tr></tbody></table><hr class="thin"/><h2 id="performance-issues" class="section-heading"><a href="#performance-issues" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Issues</span></h2><h3 id="problem-high-latency" class="section-heading"><a href="#problem-high-latency" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: High Latency</span></h3><p><strong>Symptoms:</strong></p><ul><li>RPC calls take &gt; 100ms</li><li>User-perceived slowness</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check cache hit rate</span><span class="w">
</span><span class="nc">macula_subscriber_cache</span><span class="p">:</span><span class="nf">stats</span><span class="p" data-group-id="6931485428-1">(</span><span class="p" data-group-id="6931485428-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Should see high hit_rate</span><span class="w">

</span><span class="c1">%% 2. Profile a call</span><span class="w">
</span><span class="p" data-group-id="6931485428-2">{</span><span class="n">Time</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="6931485428-2">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">timer</span><span class="p">:</span><span class="nf">tc</span><span class="p" data-group-id="6931485428-3">(</span><span class="nf">fun</span><span class="p" data-group-id="6931485428-4">(</span><span class="p" data-group-id="6931485428-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="6931485428-5">(</span><span class="n">Client</span><span class="p">,</span><span class="w"> </span><span class="n">Proc</span><span class="p">,</span><span class="w"> </span><span class="n">Args</span><span class="p" data-group-id="6931485428-5">)</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="6931485428-3">)</span><span class="p">,</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="6931485428-6">(</span><span class="s">&quot;Call took </span><span class="si">~p</span><span class="s"> ms</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6931485428-7">[</span><span class="n">Time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1000</span><span class="p" data-group-id="6931485428-7">]</span><span class="p" data-group-id="6931485428-6">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Cache miss</td><td style="text-align: left;">Warm up cache, check TTL settings</td></tr><tr><td style="text-align: left;">Slow handler</td><td style="text-align: left;">Profile handler code</td></tr><tr><td style="text-align: left;">Network latency</td><td style="text-align: left;">Check network path</td></tr><tr><td style="text-align: left;">DHT overloaded</td><td style="text-align: left;">Add more DHT nodes</td></tr><tr><td style="text-align: left;">QUIC handshake overhead</td><td style="text-align: left;">Enable connection reuse</td></tr></tbody></table><p><strong>Fix: Enable Caching</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Verify caching is enabled (should be by default)</span><span class="w">
</span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="3931258127-1">(</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="ss">enable_subscriber_cache</span><span class="p" data-group-id="3931258127-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Should return {ok, true}</span></code></pre><hr class="thin"/><h3 id="problem-low-throughput" class="section-heading"><a href="#problem-low-throughput" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Low Throughput</span></h3><p><strong>Symptoms:</strong></p><ul><li>PubSub &lt; 1000 msg/sec</li><li>System seems slow under load</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check for backpressure</span><span class="w">
</span><span class="nc">sys</span><span class="p">:</span><span class="nf">get_state</span><span class="p" data-group-id="0167410232-1">(</span><span class="ss">macula_gateway_pubsub</span><span class="p" data-group-id="0167410232-1">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Look at queue sizes</span><span class="w">

</span><span class="c1">%% Check scheduler utilization</span><span class="w">
</span><span class="nc">scheduler</span><span class="p">:</span><span class="nf">utilization</span><span class="p" data-group-id="0167410232-2">(</span><span class="mi">1000</span><span class="p" data-group-id="0167410232-2">)</span><span class="p">.</span></code></pre><p><strong>Solutions:</strong></p><ol><li><strong>Enable caching</strong> (see Performance Guide)</li><li><strong>Batch messages</strong> - Send in groups</li><li><strong>Reduce DHT queries</strong> - Increase cache TTL</li><li><strong>Profile handlers</strong> - Find bottlenecks</li></ol><hr class="thin"/><h2 id="gateway-issues" class="section-heading"><a href="#gateway-issues" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Gateway Issues</span></h2><h3 id="problem-gateway-crashes-on-startup" class="section-heading"><a href="#problem-gateway-crashes-on-startup" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Gateway Crashes on Startup</span></h3><p><strong>Symptoms:</strong></p><ul><li>Gateway fails to start</li><li>Supervisor keeps restarting</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Check crash logs</span><span class="w">
</span><span class="c1">%% grep &quot;CRASH\|EXIT\|error&quot; /var/log/macula.log</span><span class="w">

</span><span class="c1">%% Try manual start to see error</span><span class="w">
</span><span class="nc">macula_gateway</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="5590480273-1">(</span><span class="n">Config</span><span class="p" data-group-id="5590480273-1">)</span><span class="p">.</span></code></pre><p><strong>Common Causes &amp; Solutions:</strong></p><table><thead><tr><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;">Missing TLS certs</td><td style="text-align: left;">Provide valid cert/key paths</td></tr><tr><td style="text-align: left;">Port already in use</td><td style="text-align: left;">Change port or stop conflicting service</td></tr><tr><td style="text-align: left;">Invalid config</td><td style="text-align: left;">Verify sys.config syntax</td></tr><tr><td style="text-align: left;">Missing dependency</td><td style="text-align: left;">Check all deps started</td></tr></tbody></table><hr class="thin"/><h3 id="problem-gateway-becomes-unresponsive" class="section-heading"><a href="#problem-gateway-becomes-unresponsive" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem: Gateway Becomes Unresponsive</span></h3><p><strong>Symptoms:</strong></p><ul><li>Gateway process alive but not handling requests</li><li>Message queue growing</li></ul><p><strong>Diagnostic Steps:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% 1. Check message queue</span><span class="w">
</span><span class="nf">process_info</span><span class="p" data-group-id="8881726193-1">(</span><span class="nf">whereis</span><span class="p" data-group-id="8881726193-2">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="8881726193-2">)</span><span class="p">,</span><span class="w"> </span><span class="ss">message_queue_len</span><span class="p" data-group-id="8881726193-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 2. Check if processing</span><span class="w">
</span><span class="nc">sys</span><span class="p">:</span><span class="nf">get_status</span><span class="p" data-group-id="8881726193-3">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="8881726193-3">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% 3. Check for locks</span><span class="w">
</span><span class="nc">erlang</span><span class="p">:</span><span class="nf">process_info</span><span class="p" data-group-id="8881726193-4">(</span><span class="nf">whereis</span><span class="p" data-group-id="8881726193-5">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="8881726193-5">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8881726193-6">[</span><span class="ss">status</span><span class="p">,</span><span class="w"> </span><span class="ss">current_stacktrace</span><span class="p" data-group-id="8881726193-6">]</span><span class="p" data-group-id="8881726193-4">)</span><span class="p">.</span></code></pre><p><strong>Solutions:</strong></p><ol><li><strong>Restart gateway</strong> - Last resort: <code class="inline">supervisor:restart_child(macula_sup, macula_gateway).</code></li><li><strong>Find slow handler</strong> - Profile message handling</li><li><strong>Add flow control</strong> - Implement backpressure</li></ol><hr class="thin"/><h2 id="debug-tools" class="section-heading"><a href="#debug-tools" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Debug Tools</span></h2><h3 id="enabling-debug-logging" class="section-heading"><a href="#enabling-debug-logging" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Enabling Debug Logging</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Temporarily enable debug logs</span><span class="w">
</span><span class="nc">logger</span><span class="p">:</span><span class="nf">set_primary_config</span><span class="p" data-group-id="5427176329-1">(</span><span class="ss">level</span><span class="p">,</span><span class="w"> </span><span class="ss">debug</span><span class="p" data-group-id="5427176329-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% For specific module</span><span class="w">
</span><span class="nc">logger</span><span class="p">:</span><span class="nf">set_module_level</span><span class="p" data-group-id="5427176329-2">(</span><span class="ss">macula_gateway</span><span class="p">,</span><span class="w"> </span><span class="ss">debug</span><span class="p" data-group-id="5427176329-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Reset to normal</span><span class="w">
</span><span class="nc">logger</span><span class="p">:</span><span class="nf">set_primary_config</span><span class="p" data-group-id="5427176329-3">(</span><span class="ss">level</span><span class="p">,</span><span class="w"> </span><span class="ss">info</span><span class="p" data-group-id="5427176329-3">)</span><span class="p">.</span></code></pre><h3 id="tracing" class="section-heading"><a href="#tracing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Tracing</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Trace function calls</span><span class="w">
</span><span class="nc">dbg</span><span class="p">:</span><span class="nf">tracer</span><span class="p" data-group-id="3883595713-1">(</span><span class="p" data-group-id="3883595713-1">)</span><span class="p">.</span><span class="w">
</span><span class="nc">dbg</span><span class="p">:</span><span class="nf">p</span><span class="p" data-group-id="3883595713-2">(</span><span class="ss">all</span><span class="p">,</span><span class="w"> </span><span class="ss">c</span><span class="p" data-group-id="3883595713-2">)</span><span class="p">.</span><span class="w">
</span><span class="nc">dbg</span><span class="p">:</span><span class="nf">tpl</span><span class="p" data-group-id="3883595713-3">(</span><span class="ss">macula_gateway</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_call</span><span class="p">,</span><span class="w"> </span><span class="ss">&#39;_&#39;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3883595713-4">[</span><span class="p" data-group-id="3883595713-4">]</span><span class="p" data-group-id="3883595713-3">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Stop tracing</span><span class="w">
</span><span class="nc">dbg</span><span class="p">:</span><span class="nf">stop</span><span class="p" data-group-id="3883595713-5">(</span><span class="p" data-group-id="3883595713-5">)</span><span class="p">.</span></code></pre><h3 id="state-inspection" class="section-heading"><a href="#state-inspection" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">State Inspection</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get process state (gen_server)</span><span class="w">
</span><span class="nc">sys</span><span class="p">:</span><span class="nf">get_state</span><span class="p" data-group-id="3397744301-1">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="3397744301-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Get ETS table contents</span><span class="w">
</span><span class="nc">ets</span><span class="p">:</span><span class="nf">tab2list</span><span class="p" data-group-id="3397744301-2">(</span><span class="ss">macula_peers</span><span class="p" data-group-id="3397744301-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Process info</span><span class="w">
</span><span class="nf">process_info</span><span class="p" data-group-id="3397744301-3">(</span><span class="nf">whereis</span><span class="p" data-group-id="3397744301-4">(</span><span class="ss">macula_gateway</span><span class="p" data-group-id="3397744301-4">)</span><span class="p" data-group-id="3397744301-3">)</span><span class="p">.</span></code></pre><h3 id="remote-shell" class="section-heading"><a href="#remote-shell" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Remote Shell</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Connect to running node
</span><span class="">/opt/macula/bin/macula remote_console
</span><span class="">
</span><span class=""># Or via remsh
</span><span class="">erl -name debug@localhost -setcookie macula -remsh macula@hostname
</span></code></pre><h3 id="log-analysis-commands" class="section-heading"><a href="#log-analysis-commands" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Log Analysis Commands</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Find errors in last hour
</span><span class="">journalctl -u macula --since &quot;1 hour ago&quot; | grep -i error
</span><span class="">
</span><span class=""># Count warnings by type
</span><span class="">grep -oP &#39;\[warning\] \K[^:]+&#39; /var/log/macula.log | sort | uniq -c | sort -rn
</span><span class="">
</span><span class=""># Watch logs in real-time
</span><span class="">tail -f /var/log/macula.log | grep -E &quot;(error|warning|CRASH)&quot;
</span></code></pre><hr class="thin"/><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="monitoring_guide.html">Monitoring Guide</a> - Metrics and alerting</li><li><a href="performance_guide.html">Performance Guide</a> - Optimization techniques</li><li><a href="readme.html">Memory Management</a> - Bounded resource design</li><li><a href="rpc_guide.html">RPC Guide</a> - RPC architecture details</li><li><a href="pubsub_guide.html">PubSub Guide</a> - PubSub architecture details</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="monitoring_guide.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
Monitoring Guide
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="dht_guide.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
DHT Architecture
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.12.6" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.12.6">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.12.6/show/docs/operator/TROUBLESHOOTING_GUIDE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
