<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.9.2">


    <title>Mesh Hot Upgrade Design — macula v0.9.2</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-91483A11.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="readme.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="readme.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.9.2
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Mesh-Wide Hot Code Upgrade</h1>


      <a href="https://github.com/macula-io/macula/blob/0.9.2/architecture/MESH_HOT_UPGRADE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Target Release:</strong> v1.0.0
<strong>Status:</strong> Design Phase
<strong>Priority:</strong> High (Core Platform Feature)</p><hr class="thin"/><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>Macula's clear separation between platform and workloads enables a powerful capability: <strong>coordinated mesh-wide hot code upgrades</strong> without service interruption. This document describes the design for upgrading workload applications across all nodes in the mesh using standard OTP release mechanisms coordinated through Macula's RPC layer.</p><hr class="thin"/><h2 id="problem-statement" class="section-heading"><a href="#problem-statement" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Problem Statement</span></h2><h3 id="current-state" class="section-heading"><a href="#current-state" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Current State</span></h3><p>Individual nodes can perform hot code upgrades using standard OTP mechanisms:</p><ul><li><a href="https://www.erlang.org/doc/apps/kernel/code.html#load_file/1"><code class="inline">code:load_file/1</code></a> for simple module reloads</li><li><code class="inline">release_handler</code> for full release upgrades</li><li><code class="inline">appup</code> and <code class="inline">relup</code> files for state migration</li></ul><p><strong>Limitation</strong>: Each node must be upgraded manually or via external orchestration (Ansible, Kubernetes rolling updates, etc.).</p><h3 id="desired-state" class="section-heading"><a href="#desired-state" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Desired State</span></h3><p>Mesh-wide coordinated upgrades from any node:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Upgrade snake_game to v1.1.0 across entire mesh</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="6923086658-1">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6923086658-2">#{</span><span class="w">
    </span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">rolling</span><span class="p">,</span><span class="w">
    </span><span class="ss">batch_size</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">health_check</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
</span><span class="p" data-group-id="6923086658-2">}</span><span class="p" data-group-id="6923086658-1">)</span><span class="p">.</span></code></pre><p><strong>Benefits</strong>:</p><ul><li>Zero external orchestration required</li><li>BEAM-native upgrade path (OTP release_handler)</li><li>Rolling upgrades with automatic rollback</li><li>Health verification between batches</li><li>Audit trail of upgrades across mesh</li></ul><hr class="thin"/><h2 id="architecture" class="section-heading"><a href="#architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Architecture</span></h2><h3 id="component-overview" class="section-heading"><a href="#component-overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Component Overview</span></h3><pre><code class="makeup erlang" translate="no"><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="nf">macula_upgrade</span><span class="w"> </span><span class="p" data-group-id="6082138507-1">(</span><span class="n">Coordinator</span><span class="p" data-group-id="6082138507-1">)</span><span class="w">                           </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Discovers</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">with</span><span class="w"> </span><span class="ss">target</span><span class="w"> </span><span class="ss">app</span><span class="w">                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Plans</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="ss">batches</span><span class="w">                                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Coordinates</span><span class="w"> </span><span class="ss">execution</span><span class="w">                                </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Monitors</span><span class="w"> </span><span class="ss">health</span><span class="w">                                      </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Handles</span><span class="w"> </span><span class="ss">rollback</span><span class="w">                                     </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┬</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
                         </span><span class="err">│</span><span class="w"> </span><span class="n">Macula</span><span class="w"> </span><span class="n">RPC</span><span class="w">
                         </span><span class="err">↓</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="nf">macula_upgrade_agent</span><span class="w"> </span><span class="p" data-group-id="6082138507-2">(</span><span class="n">Per</span><span class="o">-</span><span class="n">Node</span><span class="p" data-group-id="6082138507-2">)</span><span class="w">                        </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Receives</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="ss">commands</span><span class="w">                            </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Executes</span><span class="w"> </span><span class="ss">release_handler</span><span class="w"> </span><span class="ss">operations</span><span class="w">                  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Reports</span><span class="w"> </span><span class="ss">status</span><span class="w"> </span><span class="ss">back</span><span class="w"> </span><span class="ss">to</span><span class="w"> </span><span class="ss">coordinator</span><span class="w">                   </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">Performs</span><span class="w"> </span><span class="ss">local</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">checks</span><span class="w">                         </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><h3 id="new-modules" class="section-heading"><a href="#new-modules" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">New Modules</span></h3><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Purpose</th><th style="text-align: left;">LOC (est)</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">macula_upgrade</code></td><td style="text-align: left;">Mesh-wide coordination</td><td style="text-align: left;">~400</td></tr><tr><td style="text-align: left;"><code class="inline">macula_upgrade_agent</code></td><td style="text-align: left;">Per-node execution</td><td style="text-align: left;">~250</td></tr><tr><td style="text-align: left;"><code class="inline">macula_upgrade_planner</code></td><td style="text-align: left;">Batch planning strategies</td><td style="text-align: left;">~200</td></tr><tr><td style="text-align: left;"><code class="inline">macula_upgrade_health</code></td><td style="text-align: left;">Health check framework</td><td style="text-align: left;">~150</td></tr></tbody></table><p><strong>Total estimated</strong>: ~1,000 LOC</p><hr class="thin"/><h2 id="api-design" class="section-heading"><a href="#api-design" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">API Design</span></h2><h3 id="primary-api" class="section-heading"><a href="#primary-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Primary API</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="8063534915-1">(</span><span class="ss">macula</span><span class="p" data-group-id="8063534915-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Mesh-wide upgrade</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">upgrade</span><span class="p" data-group-id="8063534915-2">(</span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="8063534915-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="8063534915-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">UpgradeResult</span><span class="p" data-group-id="8063534915-3">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="8063534915-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8063534915-4">}</span><span class="w">
    </span><span class="k">when</span><span class="w"> </span><span class="n">App</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">atom</span><span class="p" data-group-id="8063534915-5">(</span><span class="p" data-group-id="8063534915-5">)</span><span class="p">,</span><span class="w">
         </span><span class="n">Version</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">string</span><span class="p" data-group-id="8063534915-6">(</span><span class="p" data-group-id="8063534915-6">)</span><span class="p">,</span><span class="w">
         </span><span class="n">Opts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">upgrade_opts</span><span class="p" data-group-id="8063534915-7">(</span><span class="p" data-group-id="8063534915-7">)</span><span class="p">,</span><span class="w">
         </span><span class="n">UpgradeResult</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8063534915-8">#{</span><span class="w">
             </span><span class="ss">total</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="8063534915-9">(</span><span class="p" data-group-id="8063534915-9">)</span><span class="p">,</span><span class="w">
             </span><span class="ss">upgraded</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="8063534915-10">(</span><span class="p" data-group-id="8063534915-10">)</span><span class="p">,</span><span class="w">
             </span><span class="ss">failed</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="8063534915-11">(</span><span class="p" data-group-id="8063534915-11">)</span><span class="p">,</span><span class="w">
             </span><span class="ss">details</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="p" data-group-id="8063534915-12">[</span><span class="nf">node_result</span><span class="p" data-group-id="8063534915-13">(</span><span class="p" data-group-id="8063534915-13">)</span><span class="p" data-group-id="8063534915-12">]</span><span class="w">
         </span><span class="p" data-group-id="8063534915-8">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Check upgrade status</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">upgrade_status</span><span class="p" data-group-id="8063534915-14">(</span><span class="n">UpgradeId</span><span class="p" data-group-id="8063534915-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="8063534915-15">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="8063534915-15">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="8063534915-16">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_found</span><span class="p" data-group-id="8063534915-16">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Cancel in-progress upgrade</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">upgrade_cancel</span><span class="p" data-group-id="8063534915-17">(</span><span class="n">UpgradeId</span><span class="p" data-group-id="8063534915-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="8063534915-18">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8063534915-18">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% List available versions for an app</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">upgrade_versions</span><span class="p" data-group-id="8063534915-19">(</span><span class="n">App</span><span class="p" data-group-id="8063534915-19">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="8063534915-20">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8063534915-21">[</span><span class="n">Version</span><span class="p" data-group-id="8063534915-21">]</span><span class="p" data-group-id="8063534915-20">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="8063534915-22">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8063534915-22">}</span><span class="p">.</span></code></pre><h3 id="options" class="section-heading"><a href="#options" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Options</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">upgrade_opts</span><span class="p" data-group-id="8047968043-1">(</span><span class="p" data-group-id="8047968043-1">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8047968043-2">#{</span><span class="w">
    </span><span class="c1">%% Upgrade strategy</span><span class="w">
    </span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">rolling</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">all_at_once</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">canary</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Nodes per batch (for rolling)</span><span class="w">
    </span><span class="ss">batch_size</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">pos_integer</span><span class="p" data-group-id="8047968043-3">(</span><span class="p" data-group-id="8047968043-3">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Delay between batches (ms)</span><span class="w">
    </span><span class="ss">batch_delay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="8047968043-4">(</span><span class="p" data-group-id="8047968043-4">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Health check configuration</span><span class="w">
    </span><span class="ss">health_check</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">boolean</span><span class="p" data-group-id="8047968043-5">(</span><span class="p" data-group-id="8047968043-5">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nf">health_opts</span><span class="p" data-group-id="8047968043-6">(</span><span class="p" data-group-id="8047968043-6">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Automatic rollback on failure</span><span class="w">
    </span><span class="ss">rollback_on_fail</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">boolean</span><span class="p" data-group-id="8047968043-7">(</span><span class="p" data-group-id="8047968043-7">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Target specific nodes (default: all nodes with app)</span><span class="w">
    </span><span class="nb">nodes</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="8047968043-8">[</span><span class="nf">node_id</span><span class="p" data-group-id="8047968043-9">(</span><span class="p" data-group-id="8047968043-9">)</span><span class="p" data-group-id="8047968043-8">]</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">all</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Timeout per node (ms)</span><span class="w">
    </span><span class="ss">node_timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">pos_integer</span><span class="p" data-group-id="8047968043-10">(</span><span class="p" data-group-id="8047968043-10">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Release tarball location</span><span class="w">
    </span><span class="ss">release_url</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="8047968043-11">(</span><span class="p" data-group-id="8047968043-11">)</span><span class="w">  </span><span class="c1">% URL to fetch release from</span><span class="w">
</span><span class="p" data-group-id="8047968043-2">}</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">health_opts</span><span class="p" data-group-id="8047968043-12">(</span><span class="p" data-group-id="8047968043-12">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8047968043-13">#{</span><span class="w">
    </span><span class="c1">%% Health check endpoint</span><span class="w">
    </span><span class="ss">endpoint</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="8047968043-14">(</span><span class="p" data-group-id="8047968043-14">)</span><span class="p">,</span><span class="w">  </span><span class="c1">% e.g., &lt;&lt;&quot;system.health&quot;&gt;&gt;</span><span class="w">

    </span><span class="c1">%% Required health status</span><span class="w">
    </span><span class="ss">required_status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">degraded</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Retries before declaring failure</span><span class="w">
    </span><span class="ss">retries</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">pos_integer</span><span class="p" data-group-id="8047968043-15">(</span><span class="p" data-group-id="8047968043-15">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Delay between retries (ms)</span><span class="w">
    </span><span class="ss">retry_delay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="8047968043-16">(</span><span class="p" data-group-id="8047968043-16">)</span><span class="w">
</span><span class="p" data-group-id="8047968043-13">}</span><span class="p">.</span></code></pre><h3 id="example-usage" class="section-heading"><a href="#example-usage" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example Usage</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Simple rolling upgrade</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="7424081536-1">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7424081536-2">#{</span><span class="w">
    </span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">rolling</span><span class="p">,</span><span class="w">
    </span><span class="ss">batch_size</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w">
</span><span class="p" data-group-id="7424081536-2">}</span><span class="p" data-group-id="7424081536-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Careful production upgrade</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="7424081536-3">(</span><span class="ss">payment_service</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;2.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7424081536-4">#{</span><span class="w">
    </span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">canary</span><span class="p">,</span><span class="w">
    </span><span class="ss">batch_size</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">batch_delay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">30000</span><span class="p">,</span><span class="w">  </span><span class="c1">% 30 second delay</span><span class="w">
    </span><span class="ss">health_check</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7424081536-5">#{</span><span class="w">
        </span><span class="ss">endpoint</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7424081536-6">&lt;&lt;</span><span class="s">&quot;payment.health&quot;</span><span class="p" data-group-id="7424081536-6">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="ss">required_status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w">
        </span><span class="ss">retries</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="ss">retry_delay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5000</span><span class="w">
    </span><span class="p" data-group-id="7424081536-5">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">rollback_on_fail</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
</span><span class="p" data-group-id="7424081536-4">}</span><span class="p" data-group-id="7424081536-3">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Upgrade specific nodes only</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="7424081536-7">(</span><span class="ss">analytics</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.5.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7424081536-8">#{</span><span class="w">
    </span><span class="nb">nodes</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7424081536-9">[</span><span class="p" data-group-id="7424081536-10">&lt;&lt;</span><span class="s">&quot;node-eu-1&quot;</span><span class="p" data-group-id="7424081536-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7424081536-11">&lt;&lt;</span><span class="s">&quot;node-eu-2&quot;</span><span class="p" data-group-id="7424081536-11">&gt;&gt;</span><span class="p" data-group-id="7424081536-9">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">all_at_once</span><span class="w">
</span><span class="p" data-group-id="7424081536-8">}</span><span class="p" data-group-id="7424081536-7">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="upgrade-strategies" class="section-heading"><a href="#upgrade-strategies" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upgrade Strategies</span></h2><h3 id="1-rolling-upgrade-default" class="section-heading"><a href="#1-rolling-upgrade-default" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Rolling Upgrade (Default)</span></h3><p>Upgrades nodes in batches, waiting for health confirmation between batches.</p><pre><code class="makeup erlang" translate="no"><span class="n">Batch</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2924257226-1">[</span><span class="ss">node1</span><span class="p">,</span><span class="w"> </span><span class="ss">node2</span><span class="p" data-group-id="2924257226-1">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">check</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">OK</span><span class="w">
</span><span class="n">Batch</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2924257226-2">[</span><span class="ss">node3</span><span class="p">,</span><span class="w"> </span><span class="ss">node4</span><span class="p" data-group-id="2924257226-2">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">check</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">OK</span><span class="w">
</span><span class="n">Batch</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2924257226-3">[</span><span class="ss">node5</span><span class="p">,</span><span class="w"> </span><span class="ss">node6</span><span class="p" data-group-id="2924257226-3">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">check</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">OK</span><span class="w">
</span><span class="n">Complete</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="o">/</span><span class="mi">6</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">upgraded</span></code></pre><p><strong>Use case</strong>: Production systems requiring zero downtime</p><h3 id="2-canary-upgrade" class="section-heading"><a href="#2-canary-upgrade" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Canary Upgrade</span></h3><p>Upgrades a small subset first, waits for extended monitoring, then proceeds.</p><pre><code class="makeup erlang" translate="no"><span class="n">Canary</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9588254112-1">[</span><span class="ss">node1</span><span class="p" data-group-id="9588254112-1">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="nb">monitor</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="ss">minutes</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">OK</span><span class="w">
</span><span class="n">Batch</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9588254112-2">[</span><span class="ss">node2</span><span class="p">,</span><span class="w"> </span><span class="ss">node3</span><span class="p">,</span><span class="w"> </span><span class="ss">node4</span><span class="p" data-group-id="9588254112-2">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">check</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">OK</span><span class="w">
</span><span class="n">Batch</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="9588254112-3">[</span><span class="ss">node5</span><span class="p">,</span><span class="w"> </span><span class="ss">node6</span><span class="p" data-group-id="9588254112-3">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">health</span><span class="w"> </span><span class="ss">check</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">OK</span><span class="w">
</span><span class="n">Complete</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="o">/</span><span class="mi">6</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">upgraded</span></code></pre><p><strong>Use case</strong>: High-risk upgrades requiring validation</p><h3 id="3-all-at-once" class="section-heading"><a href="#3-all-at-once" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. All-at-Once</span></h3><p>Upgrades all nodes simultaneously.</p><pre><code class="makeup erlang" translate="no"><span class="n">All</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7375146794-1">[</span><span class="ss">node1</span><span class="p">,</span><span class="w"> </span><span class="ss">node2</span><span class="p">,</span><span class="w"> </span><span class="ss">node3</span><span class="p">,</span><span class="w"> </span><span class="ss">node4</span><span class="p">,</span><span class="w"> </span><span class="ss">node5</span><span class="p">,</span><span class="w"> </span><span class="ss">node6</span><span class="p" data-group-id="7375146794-1">]</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="ss">upgrade</span><span class="w">
</span><span class="n">Complete</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="o">/</span><span class="mi">6</span><span class="w"> </span><span class="nb">nodes</span><span class="w"> </span><span class="ss">upgraded</span></code></pre><p><strong>Use case</strong>: Development/staging or when rolling isn't feasible</p><hr class="thin"/><h2 id="implementation-details" class="section-heading"><a href="#implementation-details" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Implementation Details</span></h2><h3 id="coordinator-module" class="section-heading"><a href="#coordinator-module" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Coordinator Module</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="2243917048-1">(</span><span class="ss">macula_upgrade</span><span class="p" data-group-id="2243917048-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="2243917048-2">(</span><span class="ss">gen_statem</span><span class="p" data-group-id="2243917048-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="2243917048-3">(</span><span class="p" data-group-id="2243917048-4">[</span><span class="w">
    </span><span class="ss">upgrade</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">status</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">cancel</span><span class="p">/</span><span class="mi">1</span><span class="w">
</span><span class="p" data-group-id="2243917048-4">]</span><span class="p" data-group-id="2243917048-3">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% State machine states</span><span class="w">
</span><span class="p">-</span><span class="na">type</span><span class="w"> </span><span class="nf">state</span><span class="p" data-group-id="2243917048-5">(</span><span class="p" data-group-id="2243917048-5">)</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="ss">idle</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">discovering</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">planning</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">upgrading</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">verifying</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">complete</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">failed</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Upgrade record</span><span class="w">
</span><span class="p">-</span><span class="na">record</span><span class="p" data-group-id="2243917048-6">(</span><span class="ss">upgrade</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-7">{</span><span class="w">
    </span><span class="ss">id</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="2243917048-8">(</span><span class="p" data-group-id="2243917048-8">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">app</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">atom</span><span class="p" data-group-id="2243917048-9">(</span><span class="p" data-group-id="2243917048-9">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">version</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">string</span><span class="p" data-group-id="2243917048-10">(</span><span class="p" data-group-id="2243917048-10">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">opts</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="2243917048-11">(</span><span class="p" data-group-id="2243917048-11">)</span><span class="p">,</span><span class="w">
    </span><span class="nb">nodes</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2243917048-12">[</span><span class="nf">node_id</span><span class="p" data-group-id="2243917048-13">(</span><span class="p" data-group-id="2243917048-13">)</span><span class="p" data-group-id="2243917048-12">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">batches</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2243917048-14">[</span><span class="p" data-group-id="2243917048-15">[</span><span class="nf">node_id</span><span class="p" data-group-id="2243917048-16">(</span><span class="p" data-group-id="2243917048-16">)</span><span class="p" data-group-id="2243917048-15">]</span><span class="p" data-group-id="2243917048-14">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">current_batch</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">non_neg_integer</span><span class="p" data-group-id="2243917048-17">(</span><span class="p" data-group-id="2243917048-17">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">results</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="2243917048-18">#{</span><span class="nf">node_id</span><span class="p" data-group-id="2243917048-19">(</span><span class="p" data-group-id="2243917048-19">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">result</span><span class="p" data-group-id="2243917048-20">(</span><span class="p" data-group-id="2243917048-20">)</span><span class="p" data-group-id="2243917048-18">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">started_at</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="2243917048-21">(</span><span class="p" data-group-id="2243917048-21">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">completed_at</span><span class="w"> </span><span class="p">:</span><span class="p">:</span><span class="w"> </span><span class="nf">integer</span><span class="p" data-group-id="2243917048-22">(</span><span class="p" data-group-id="2243917048-22">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="ss">undefined</span><span class="w">
</span><span class="p" data-group-id="2243917048-7">}</span><span class="p" data-group-id="2243917048-6">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%%====================================================================</span><span class="w">
</span><span class="c1">%% API</span><span class="w">
</span><span class="c1">%%====================================================================</span><span class="w">

</span><span class="nf">upgrade</span><span class="p" data-group-id="2243917048-23">(</span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="2243917048-23">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">UpgradeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">generate_id</span><span class="p" data-group-id="2243917048-24">(</span><span class="p" data-group-id="2243917048-24">)</span><span class="p">,</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">gen_statem</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="2243917048-25">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-26">{</span><span class="ss">start_upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">UpgradeId</span><span class="p">,</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="2243917048-26">}</span><span class="p" data-group-id="2243917048-25">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2243917048-27">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">started</span><span class="p" data-group-id="2243917048-27">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Wait for completion or return immediately based on opts</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-28">(</span><span class="ss">async</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="2243917048-28">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2243917048-29">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-30">#{</span><span class="ss">upgrade_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">UpgradeId</span><span class="p" data-group-id="2243917048-30">}</span><span class="p" data-group-id="2243917048-29">}</span><span class="p">;</span><span class="w">
                </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">wait_for_completion</span><span class="p" data-group-id="2243917048-31">(</span><span class="n">UpgradeId</span><span class="p" data-group-id="2243917048-31">)</span><span class="w">
            </span><span class="k">end</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2243917048-32">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2243917048-32">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2243917048-33">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2243917048-33">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%%====================================================================</span><span class="w">
</span><span class="c1">%% State Machine</span><span class="w">
</span><span class="c1">%%====================================================================</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="2243917048-34">(</span><span class="p" data-group-id="2243917048-35">[</span><span class="p" data-group-id="2243917048-35">]</span><span class="p" data-group-id="2243917048-34">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Register upgrade agent on this node</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="2243917048-36">(</span><span class="p" data-group-id="2243917048-37">&lt;&lt;</span><span class="s">&quot;system.upgrade&quot;</span><span class="p" data-group-id="2243917048-37">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">handle_upgrade_request</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="2243917048-36">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2243917048-38">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">idle</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-39">#{</span><span class="p" data-group-id="2243917048-39">}</span><span class="p" data-group-id="2243917048-38">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% State: idle -&gt; discovering</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2243917048-40">(</span><span class="p" data-group-id="2243917048-41">{</span><span class="ss">call</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p" data-group-id="2243917048-41">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-42">{</span><span class="ss">start_upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p" data-group-id="2243917048-42">}</span><span class="p">,</span><span class="w"> </span><span class="ss">idle</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-40">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Upgrade</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">#</span><span class="ss">upgrade</span><span class="p" data-group-id="2243917048-43">{</span><span class="w">
        </span><span class="ss">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w">
        </span><span class="ss">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w">
        </span><span class="ss">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w">
        </span><span class="ss">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w">
        </span><span class="ss">started_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="2243917048-44">(</span><span class="ss">millisecond</span><span class="p" data-group-id="2243917048-44">)</span><span class="w">
    </span><span class="p" data-group-id="2243917048-43">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2243917048-45">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">discovering</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-46">#{</span><span class="n">Id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-46">}</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="2243917048-47">[</span><span class="p" data-group-id="2243917048-48">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-49">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">started</span><span class="p" data-group-id="2243917048-49">}</span><span class="p" data-group-id="2243917048-48">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-50">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">discover</span><span class="p" data-group-id="2243917048-50">}</span><span class="p" data-group-id="2243917048-47">]</span><span class="p" data-group-id="2243917048-45">}</span><span class="p">;</span><span class="w">

</span><span class="c1">%% State: discovering</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2243917048-51">(</span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">discover</span><span class="p">,</span><span class="w"> </span><span class="ss">discovering</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-52">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-52">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-51">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">App</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">app</span><span class="p">,</span><span class="w">
    </span><span class="n">Opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Find all nodes running this app</span><span class="w">
    </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-53">(</span><span class="nb">nodes</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="ss">all</span><span class="p" data-group-id="2243917048-53">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">all</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">discover_nodes_with_app</span><span class="p" data-group-id="2243917048-54">(</span><span class="n">App</span><span class="p" data-group-id="2243917048-54">)</span><span class="p">;</span><span class="w">
        </span><span class="n">Specific</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="n">Specific</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="n">Nodes</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2243917048-55">[</span><span class="p" data-group-id="2243917048-55">]</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2243917048-56">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">failed</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2243917048-57">[</span><span class="p" data-group-id="2243917048-58">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-59">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_nodes_found</span><span class="p" data-group-id="2243917048-59">}</span><span class="p" data-group-id="2243917048-58">}</span><span class="p" data-group-id="2243917048-57">]</span><span class="p" data-group-id="2243917048-56">}</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">Upgrade1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p" data-group-id="2243917048-60">{</span><span class="nb">nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="2243917048-60">}</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="2243917048-61">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">planning</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-62">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade1</span><span class="p" data-group-id="2243917048-62">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2243917048-63">[</span><span class="p" data-group-id="2243917048-64">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">plan</span><span class="p" data-group-id="2243917048-64">}</span><span class="p" data-group-id="2243917048-63">]</span><span class="p" data-group-id="2243917048-61">}</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="c1">%% State: planning</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2243917048-65">(</span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">plan</span><span class="p">,</span><span class="w"> </span><span class="ss">planning</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-66">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-66">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-65">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p">,</span><span class="w">
    </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="nb">nodes</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Create batches based on strategy</span><span class="w">
    </span><span class="n">Batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_upgrade_planner</span><span class="p">:</span><span class="nf">create_batches</span><span class="p" data-group-id="2243917048-67">(</span><span class="w">
        </span><span class="n">Nodes</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-68">(</span><span class="ss">strategy</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="ss">rolling</span><span class="p" data-group-id="2243917048-68">)</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-69">(</span><span class="ss">batch_size</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="2243917048-69">)</span><span class="w">
    </span><span class="p" data-group-id="2243917048-67">)</span><span class="p">,</span><span class="w">

    </span><span class="n">Upgrade1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p" data-group-id="2243917048-70">{</span><span class="ss">batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Batches</span><span class="p">,</span><span class="w"> </span><span class="ss">current_batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2243917048-70">}</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2243917048-71">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrading</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-72">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade1</span><span class="p" data-group-id="2243917048-72">}</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="2243917048-73">[</span><span class="p" data-group-id="2243917048-74">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrade_batch</span><span class="p" data-group-id="2243917048-74">}</span><span class="p" data-group-id="2243917048-73">]</span><span class="p" data-group-id="2243917048-71">}</span><span class="p">;</span><span class="w">

</span><span class="c1">%% State: upgrading</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2243917048-75">(</span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrade_batch</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrading</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-76">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-76">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-75">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">BatchNum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">current_batch</span><span class="p">,</span><span class="w">
    </span><span class="n">Batches</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">batches</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="n">BatchNum</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nf">length</span><span class="p" data-group-id="2243917048-77">(</span><span class="n">Batches</span><span class="p" data-group-id="2243917048-77">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% All batches complete</span><span class="w">
            </span><span class="p" data-group-id="2243917048-78">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">complete</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2243917048-79">[</span><span class="p" data-group-id="2243917048-80">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">finalize</span><span class="p" data-group-id="2243917048-80">}</span><span class="p" data-group-id="2243917048-79">]</span><span class="p" data-group-id="2243917048-78">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">Batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p" data-group-id="2243917048-81">(</span><span class="n">BatchNum</span><span class="p">,</span><span class="w"> </span><span class="n">Batches</span><span class="p" data-group-id="2243917048-81">)</span><span class="p">,</span><span class="w">
            </span><span class="c1">%% Upgrade nodes in this batch</span><span class="w">
            </span><span class="n">Results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">upgrade_batch_nodes</span><span class="p" data-group-id="2243917048-82">(</span><span class="n">Batch</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-82">)</span><span class="p">,</span><span class="w">

            </span><span class="k">case</span><span class="w"> </span><span class="nf">check_batch_results</span><span class="p" data-group-id="2243917048-83">(</span><span class="n">Results</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p" data-group-id="2243917048-83">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="n">Upgrade1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">update_results</span><span class="p" data-group-id="2243917048-84">(</span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">Results</span><span class="p" data-group-id="2243917048-84">)</span><span class="p">,</span><span class="w">
                    </span><span class="n">Upgrade2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade1</span><span class="o">#</span><span class="ss">upgrade</span><span class="p" data-group-id="2243917048-85">{</span><span class="ss">current_batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BatchNum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2243917048-85">}</span><span class="p">,</span><span class="w">

                    </span><span class="c1">%% Optional delay between batches</span><span class="w">
                    </span><span class="n">Delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-86">(</span><span class="ss">batch_delay</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p" data-group-id="2243917048-86">)</span><span class="p">,</span><span class="w">
                    </span><span class="p" data-group-id="2243917048-87">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">verifying</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-88">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade2</span><span class="p" data-group-id="2243917048-88">}</span><span class="p">,</span><span class="w">
                     </span><span class="p" data-group-id="2243917048-89">[</span><span class="p" data-group-id="2243917048-90">{</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="n">Delay</span><span class="p">,</span><span class="w"> </span><span class="ss">next_batch</span><span class="p" data-group-id="2243917048-90">}</span><span class="p" data-group-id="2243917048-89">]</span><span class="p" data-group-id="2243917048-87">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="2243917048-91">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">FailedNodes</span><span class="p" data-group-id="2243917048-91">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="nf">handle_batch_failure</span><span class="p" data-group-id="2243917048-92">(</span><span class="n">FailedNodes</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-92">)</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">;</span><span class="w">

</span><span class="c1">%% State: verifying (health checks between batches)</span><span class="w">
</span><span class="nf">handle_event</span><span class="p" data-group-id="2243917048-93">(</span><span class="ss">state_timeout</span><span class="p">,</span><span class="w"> </span><span class="ss">next_batch</span><span class="p">,</span><span class="w"> </span><span class="ss">verifying</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-94">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-94">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-93">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-95">(</span><span class="ss">health_check</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">false</span><span class="p" data-group-id="2243917048-95">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2243917048-96">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrading</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2243917048-97">[</span><span class="p" data-group-id="2243917048-98">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrade_batch</span><span class="p" data-group-id="2243917048-98">}</span><span class="p" data-group-id="2243917048-97">]</span><span class="p" data-group-id="2243917048-96">}</span><span class="p">;</span><span class="w">
        </span><span class="n">HealthOpts</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="k">case</span><span class="w"> </span><span class="nf">perform_health_checks</span><span class="p" data-group-id="2243917048-99">(</span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">HealthOpts</span><span class="p" data-group-id="2243917048-99">)</span><span class="w"> </span><span class="k">of</span><span class="w">
                </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="p" data-group-id="2243917048-100">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrading</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
                     </span><span class="p" data-group-id="2243917048-101">[</span><span class="p" data-group-id="2243917048-102">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrade_batch</span><span class="p" data-group-id="2243917048-102">}</span><span class="p" data-group-id="2243917048-101">]</span><span class="p" data-group-id="2243917048-100">}</span><span class="p">;</span><span class="w">
                </span><span class="p" data-group-id="2243917048-103">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">UnhealthyNodes</span><span class="p" data-group-id="2243917048-103">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                    </span><span class="nf">handle_health_failure</span><span class="p" data-group-id="2243917048-104">(</span><span class="n">UnhealthyNodes</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-104">)</span><span class="w">
            </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="c1">%%====================================================================</span><span class="w">
</span><span class="c1">%% Internal Functions</span><span class="w">
</span><span class="c1">%%====================================================================</span><span class="w">

</span><span class="nf">discover_nodes_with_app</span><span class="p" data-group-id="2243917048-105">(</span><span class="n">App</span><span class="p" data-group-id="2243917048-105">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Query DHT for nodes advertising this app</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">discover</span><span class="p" data-group-id="2243917048-106">(</span><span class="p" data-group-id="2243917048-107">&lt;&lt;</span><span class="p" data-group-id="2243917048-108">(</span><span class="nf">atom_to_binary</span><span class="p" data-group-id="2243917048-109">(</span><span class="n">App</span><span class="p" data-group-id="2243917048-109">)</span><span class="p" data-group-id="2243917048-108">)</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.*&quot;</span><span class="p" data-group-id="2243917048-107">&gt;&gt;</span><span class="p" data-group-id="2243917048-106">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="2243917048-110">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Services</span><span class="p" data-group-id="2243917048-110">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Extract unique node IDs from service advertisements</span><span class="w">
            </span><span class="nc">lists</span><span class="p">:</span><span class="nf">usort</span><span class="p" data-group-id="2243917048-111">(</span><span class="p" data-group-id="2243917048-112">[</span><span class="n">NodeId</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="2243917048-113">#{</span><span class="ss">node_id</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="2243917048-113">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Services</span><span class="p" data-group-id="2243917048-112">]</span><span class="p" data-group-id="2243917048-111">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="2243917048-114">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="2243917048-114">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="2243917048-115">[</span><span class="p" data-group-id="2243917048-115">]</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">upgrade_batch_nodes</span><span class="p" data-group-id="2243917048-116">(</span><span class="n">Nodes</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-116">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">App</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">app</span><span class="p">,</span><span class="w">
    </span><span class="n">Version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">version</span><span class="p">,</span><span class="w">
    </span><span class="n">Opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p">,</span><span class="w">
    </span><span class="n">Timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-117">(</span><span class="ss">node_timeout</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="mi">60000</span><span class="p" data-group-id="2243917048-117">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Parallel upgrade of all nodes in batch</span><span class="w">
    </span><span class="n">Results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">pmap</span><span class="p" data-group-id="2243917048-118">(</span><span class="nf">fun</span><span class="p" data-group-id="2243917048-119">(</span><span class="n">NodeId</span><span class="p" data-group-id="2243917048-119">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="n">Request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="2243917048-120">#{</span><span class="w">
            </span><span class="ss">app</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w">
            </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w">
            </span><span class="ss">release_url</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-121">(</span><span class="ss">release_url</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="ss">undefined</span><span class="p" data-group-id="2243917048-121">)</span><span class="w">
        </span><span class="p" data-group-id="2243917048-120">}</span><span class="p">,</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="2243917048-122">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-123">&lt;&lt;</span><span class="s">&quot;system.upgrade&quot;</span><span class="p" data-group-id="2243917048-123">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="p">,</span><span class="w"> </span><span class="n">Timeout</span><span class="p" data-group-id="2243917048-122">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="2243917048-124">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="2243917048-124">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2243917048-125">{</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="2243917048-125">}</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="2243917048-126">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2243917048-126">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="2243917048-127">{</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-128">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="2243917048-128">}</span><span class="p" data-group-id="2243917048-127">}</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="2243917048-118">)</span><span class="p">,</span><span class="w">

    </span><span class="nc">maps</span><span class="p">:</span><span class="nf">from_list</span><span class="p" data-group-id="2243917048-129">(</span><span class="n">Results</span><span class="p" data-group-id="2243917048-129">)</span><span class="p">.</span><span class="w">

</span><span class="nf">perform_health_checks</span><span class="p" data-group-id="2243917048-130">(</span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">HealthOpts</span><span class="p" data-group-id="2243917048-130">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_map</span><span class="p" data-group-id="2243917048-131">(</span><span class="n">HealthOpts</span><span class="p" data-group-id="2243917048-131">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Check health of all upgraded nodes so far</span><span class="w">
    </span><span class="n">UpgradedNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_upgraded_nodes</span><span class="p" data-group-id="2243917048-132">(</span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-132">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-133">(</span><span class="ss">endpoint</span><span class="p">,</span><span class="w"> </span><span class="n">HealthOpts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-134">&lt;&lt;</span><span class="s">&quot;system.health&quot;</span><span class="p" data-group-id="2243917048-134">&gt;&gt;</span><span class="p" data-group-id="2243917048-133">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Retries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-135">(</span><span class="ss">retries</span><span class="p">,</span><span class="w"> </span><span class="n">HealthOpts</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p" data-group-id="2243917048-135">)</span><span class="p">,</span><span class="w">
    </span><span class="n">RetryDelay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-136">(</span><span class="ss">retry_delay</span><span class="p">,</span><span class="w"> </span><span class="n">HealthOpts</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="2243917048-136">)</span><span class="p">,</span><span class="w">
    </span><span class="n">RequiredStatus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-137">(</span><span class="ss">required_status</span><span class="p">,</span><span class="w"> </span><span class="n">HealthOpts</span><span class="p">,</span><span class="w"> </span><span class="ss">ok</span><span class="p" data-group-id="2243917048-137">)</span><span class="p">,</span><span class="w">

    </span><span class="nf">check_nodes_health</span><span class="p" data-group-id="2243917048-138">(</span><span class="n">UpgradedNodes</span><span class="p">,</span><span class="w"> </span><span class="n">Endpoint</span><span class="p">,</span><span class="w"> </span><span class="n">RequiredStatus</span><span class="p">,</span><span class="w"> </span><span class="n">Retries</span><span class="p">,</span><span class="w"> </span><span class="n">RetryDelay</span><span class="p" data-group-id="2243917048-138">)</span><span class="p">;</span><span class="w">

</span><span class="nf">perform_health_checks</span><span class="p" data-group-id="2243917048-139">(</span><span class="p">_</span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="2243917048-139">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Default health check</span><span class="w">
    </span><span class="nf">perform_health_checks</span><span class="p" data-group-id="2243917048-140">(</span><span class="p">_</span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-141">#{</span><span class="ss">endpoint</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="2243917048-142">&lt;&lt;</span><span class="s">&quot;system.health&quot;</span><span class="p" data-group-id="2243917048-142">&gt;&gt;</span><span class="p" data-group-id="2243917048-141">}</span><span class="p" data-group-id="2243917048-140">)</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_batch_failure</span><span class="p" data-group-id="2243917048-143">(</span><span class="n">FailedNodes</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-143">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2243917048-144">(</span><span class="ss">rollback_on_fail</span><span class="p">,</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="2243917048-144">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">true</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Rollback all upgraded nodes</span><span class="w">
            </span><span class="nf">rollback_upgrade</span><span class="p" data-group-id="2243917048-145">(</span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-145">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="2243917048-146">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">failed</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2243917048-147">[</span><span class="p" data-group-id="2243917048-148">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-149">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-150">{</span><span class="ss">batch_failed</span><span class="p">,</span><span class="w"> </span><span class="n">FailedNodes</span><span class="p" data-group-id="2243917048-150">}</span><span class="p" data-group-id="2243917048-149">}</span><span class="p" data-group-id="2243917048-148">}</span><span class="p" data-group-id="2243917048-147">]</span><span class="p" data-group-id="2243917048-146">}</span><span class="p">;</span><span class="w">
        </span><span class="ss">false</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% Continue despite failures</span><span class="w">
            </span><span class="n">Upgrade1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p" data-group-id="2243917048-151">{</span><span class="ss">current_batch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">current_batch</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="2243917048-151">}</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="2243917048-152">{</span><span class="ss">next_state</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrading</span><span class="p">,</span><span class="w"> </span><span class="n">Data</span><span class="p" data-group-id="2243917048-153">#{</span><span class="ss">current</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Upgrade1</span><span class="p" data-group-id="2243917048-153">}</span><span class="p">,</span><span class="w">
             </span><span class="p" data-group-id="2243917048-154">[</span><span class="p" data-group-id="2243917048-155">{</span><span class="ss">next_event</span><span class="p">,</span><span class="w"> </span><span class="ss">internal</span><span class="p">,</span><span class="w"> </span><span class="ss">upgrade_batch</span><span class="p" data-group-id="2243917048-155">}</span><span class="p" data-group-id="2243917048-154">]</span><span class="p" data-group-id="2243917048-152">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">rollback_upgrade</span><span class="p" data-group-id="2243917048-156">(</span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-156">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Get all successfully upgraded nodes</span><span class="w">
    </span><span class="n">UpgradedNodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_upgraded_nodes</span><span class="p" data-group-id="2243917048-157">(</span><span class="n">Upgrade</span><span class="p" data-group-id="2243917048-157">)</span><span class="p">,</span><span class="w">
    </span><span class="n">PreviousVersion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_previous_version</span><span class="p" data-group-id="2243917048-158">(</span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">app</span><span class="p" data-group-id="2243917048-158">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Rollback each node</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="2243917048-159">(</span><span class="nf">fun</span><span class="p" data-group-id="2243917048-160">(</span><span class="n">NodeId</span><span class="p" data-group-id="2243917048-160">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">macula</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="2243917048-161">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-162">&lt;&lt;</span><span class="s">&quot;system.rollback&quot;</span><span class="p" data-group-id="2243917048-162">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2243917048-163">#{</span><span class="w">
            </span><span class="ss">app</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Upgrade</span><span class="o">#</span><span class="ss">upgrade</span><span class="p">.</span><span class="ss">app</span><span class="p">,</span><span class="w">
            </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">PreviousVersion</span><span class="w">
        </span><span class="p" data-group-id="2243917048-163">}</span><span class="p" data-group-id="2243917048-161">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">UpgradedNodes</span><span class="p" data-group-id="2243917048-159">)</span><span class="p">.</span></code></pre><h3 id="agent-module-per-node" class="section-heading"><a href="#agent-module-per-node" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Agent Module (Per-Node)</span></h3><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="8036149413-1">(</span><span class="ss">macula_upgrade_agent</span><span class="p" data-group-id="8036149413-1">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="8036149413-2">(</span><span class="p" data-group-id="8036149413-3">[</span><span class="w">
    </span><span class="ss">init</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="ss">handle_upgrade</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="ss">handle_rollback</span><span class="p">/</span><span class="mi">1</span><span class="w">
</span><span class="p" data-group-id="8036149413-3">]</span><span class="p" data-group-id="8036149413-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%%====================================================================</span><span class="w">
</span><span class="c1">%% Initialization</span><span class="w">
</span><span class="c1">%%====================================================================</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="8036149413-4">(</span><span class="p" data-group-id="8036149413-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Register upgrade handlers</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="8036149413-5">(</span><span class="p" data-group-id="8036149413-6">&lt;&lt;</span><span class="s">&quot;system.upgrade&quot;</span><span class="p" data-group-id="8036149413-6">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">handle_upgrade</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="8036149413-5">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="8036149413-7">(</span><span class="p" data-group-id="8036149413-8">&lt;&lt;</span><span class="s">&quot;system.rollback&quot;</span><span class="p" data-group-id="8036149413-8">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">handle_rollback</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="8036149413-7">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="8036149413-9">(</span><span class="p" data-group-id="8036149413-10">&lt;&lt;</span><span class="s">&quot;system.versions&quot;</span><span class="p" data-group-id="8036149413-10">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">handle_versions</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="8036149413-9">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%%====================================================================</span><span class="w">
</span><span class="c1">%% Handlers</span><span class="w">
</span><span class="c1">%%====================================================================</span><span class="w">

</span><span class="nf">handle_upgrade</span><span class="p" data-group-id="8036149413-11">(</span><span class="p" data-group-id="8036149413-12">#{</span><span class="ss">app</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="ss">version</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Request</span><span class="p" data-group-id="8036149413-11">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8036149413-13">(</span><span class="s">&quot;Upgrading </span><span class="si">~p</span><span class="s"> to </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-14">[</span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-14">]</span><span class="p" data-group-id="8036149413-13">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Fetch release if URL provided</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="8036149413-15">(</span><span class="ss">release_url</span><span class="p">,</span><span class="w"> </span><span class="n">Request</span><span class="p">,</span><span class="w"> </span><span class="ss">undefined</span><span class="p" data-group-id="8036149413-15">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">undefined</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="n">Url</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">fetch_release</span><span class="p" data-group-id="8036149413-16">(</span><span class="n">Url</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-16">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Perform OTP release upgrade</span><span class="w">
    </span><span class="k">try</span><span class="w">
        </span><span class="c1">%% Unpack the release</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">unpack_release</span><span class="p" data-group-id="8036149413-17">(</span><span class="n">Version</span><span class="p" data-group-id="8036149413-17">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="8036149413-18">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-18">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8036149413-19">(</span><span class="s">&quot;Unpacked release </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-20">[</span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-20">]</span><span class="p" data-group-id="8036149413-19">)</span><span class="p">;</span><span class="w">
            </span><span class="p" data-group-id="8036149413-21">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-22">{</span><span class="ss">already_installed</span><span class="p">,</span><span class="w"> </span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-22">}</span><span class="p" data-group-id="8036149413-21">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8036149413-23">(</span><span class="s">&quot;Release </span><span class="si">~s</span><span class="s"> already installed&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-24">[</span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-24">]</span><span class="p" data-group-id="8036149413-23">)</span><span class="w">
        </span><span class="k">end</span><span class="p">,</span><span class="w">

        </span><span class="c1">%% Install the release</span><span class="w">
        </span><span class="k">case</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">install_release</span><span class="p" data-group-id="8036149413-25">(</span><span class="n">Version</span><span class="p" data-group-id="8036149413-25">)</span><span class="w"> </span><span class="k">of</span><span class="w">
            </span><span class="p" data-group-id="8036149413-26">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">OldVsn</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="8036149413-26">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8036149413-27">(</span><span class="s">&quot;Installed </span><span class="si">~s</span><span class="s"> (was </span><span class="si">~s</span><span class="s">)&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-28">[</span><span class="n">Version</span><span class="p">,</span><span class="w"> </span><span class="n">OldVsn</span><span class="p" data-group-id="8036149413-28">]</span><span class="p" data-group-id="8036149413-27">)</span><span class="p">,</span><span class="w">

                </span><span class="c1">%% Make permanent</span><span class="w">
                </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">make_permanent</span><span class="p" data-group-id="8036149413-29">(</span><span class="n">Version</span><span class="p" data-group-id="8036149413-29">)</span><span class="p">,</span><span class="w">
                </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8036149413-30">(</span><span class="s">&quot;Made </span><span class="si">~s</span><span class="s"> permanent&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-31">[</span><span class="n">Version</span><span class="p" data-group-id="8036149413-31">]</span><span class="p" data-group-id="8036149413-30">)</span><span class="p">,</span><span class="w">

                </span><span class="p" data-group-id="8036149413-32">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-33">#{</span><span class="w">
                    </span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">upgraded</span><span class="p">,</span><span class="w">
                    </span><span class="ss">from_version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">OldVsn</span><span class="p">,</span><span class="w">
                    </span><span class="ss">to_version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Version</span><span class="p">,</span><span class="w">
                    </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="8036149413-34">(</span><span class="p" data-group-id="8036149413-34">)</span><span class="w">
                </span><span class="p" data-group-id="8036149413-33">}</span><span class="p" data-group-id="8036149413-32">}</span><span class="p">;</span><span class="w">

            </span><span class="p" data-group-id="8036149413-35">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8036149413-35">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
                </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="8036149413-36">(</span><span class="s">&quot;Install failed: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-37">[</span><span class="n">Reason</span><span class="p" data-group-id="8036149413-37">]</span><span class="p" data-group-id="8036149413-36">)</span><span class="p">,</span><span class="w">
                </span><span class="p" data-group-id="8036149413-38">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-39">{</span><span class="ss">install_failed</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8036149413-39">}</span><span class="p" data-group-id="8036149413-38">}</span><span class="w">
        </span><span class="k">end</span><span class="w">
    </span><span class="k">catch</span><span class="w">
        </span><span class="n">Class</span><span class="p">:</span><span class="n">Error</span><span class="p">:</span><span class="n">Stack</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="8036149413-40">(</span><span class="s">&quot;Upgrade exception: </span><span class="si">~p</span><span class="s">:</span><span class="si">~p</span><span class="si">~n</span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-41">[</span><span class="n">Class</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p">,</span><span class="w"> </span><span class="n">Stack</span><span class="p" data-group-id="8036149413-41">]</span><span class="p" data-group-id="8036149413-40">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="8036149413-42">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-43">{</span><span class="ss">exception</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="p" data-group-id="8036149413-43">}</span><span class="p" data-group-id="8036149413-42">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_rollback</span><span class="p" data-group-id="8036149413-44">(</span><span class="p" data-group-id="8036149413-45">#{</span><span class="ss">app</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="ss">version</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-45">}</span><span class="p" data-group-id="8036149413-44">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">logger</span><span class="p">:</span><span class="nf">warning</span><span class="p" data-group-id="8036149413-46">(</span><span class="s">&quot;Rolling back </span><span class="si">~p</span><span class="s"> to </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-47">[</span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-47">]</span><span class="p" data-group-id="8036149413-46">)</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">install_release</span><span class="p" data-group-id="8036149413-48">(</span><span class="n">Version</span><span class="p" data-group-id="8036149413-48">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="8036149413-49">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="8036149413-49">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">make_permanent</span><span class="p" data-group-id="8036149413-50">(</span><span class="n">Version</span><span class="p" data-group-id="8036149413-50">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="8036149413-51">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-52">#{</span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">rolled_back</span><span class="p">,</span><span class="w"> </span><span class="ss">version</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-52">}</span><span class="p" data-group-id="8036149413-51">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="8036149413-53">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8036149413-53">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="8036149413-54">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-55">{</span><span class="ss">rollback_failed</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8036149413-55">}</span><span class="p" data-group-id="8036149413-54">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_versions</span><span class="p" data-group-id="8036149413-56">(</span><span class="p" data-group-id="8036149413-57">#{</span><span class="ss">app</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">App</span><span class="p" data-group-id="8036149413-57">}</span><span class="p" data-group-id="8036149413-56">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% List installed versions</span><span class="w">
    </span><span class="n">Releases</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">which_releases</span><span class="p" data-group-id="8036149413-58">(</span><span class="p" data-group-id="8036149413-58">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Versions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8036149413-59">[</span><span class="n">Vsn</span><span class="w"> </span><span class="p">||</span><span class="w"> </span><span class="p" data-group-id="8036149413-60">{</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Vsn</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="8036149413-60">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">Releases</span><span class="p">,</span><span class="w">
                       </span><span class="nc">lists</span><span class="p">:</span><span class="nf">member</span><span class="p" data-group-id="8036149413-61">(</span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="nf">get_release_apps</span><span class="p" data-group-id="8036149413-62">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-62">)</span><span class="p" data-group-id="8036149413-61">)</span><span class="p" data-group-id="8036149413-59">]</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="8036149413-63">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-64">#{</span><span class="ss">app</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">App</span><span class="p">,</span><span class="w"> </span><span class="ss">versions</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Versions</span><span class="p" data-group-id="8036149413-64">}</span><span class="p" data-group-id="8036149413-63">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%%====================================================================</span><span class="w">
</span><span class="c1">%% Internal Functions</span><span class="w">
</span><span class="c1">%%====================================================================</span><span class="w">

</span><span class="nf">fetch_release</span><span class="p" data-group-id="8036149413-65">(</span><span class="n">Url</span><span class="p">,</span><span class="w"> </span><span class="n">Version</span><span class="p" data-group-id="8036149413-65">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Download release tarball</span><span class="w">
    </span><span class="n">ReleasesDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">code</span><span class="p">:</span><span class="nf">root_dir</span><span class="p" data-group-id="8036149413-66">(</span><span class="p" data-group-id="8036149413-66">)</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;/releases&quot;</span><span class="p">,</span><span class="w">
    </span><span class="n">TarFile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ReleasesDir</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="n">Version</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="s">&quot;.tar.gz&quot;</span><span class="p">,</span><span class="w">

    </span><span class="k">case</span><span class="w"> </span><span class="nc">httpc</span><span class="p">:</span><span class="nf">request</span><span class="p" data-group-id="8036149413-67">(</span><span class="nb">get</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-68">{</span><span class="nf">binary_to_list</span><span class="p" data-group-id="8036149413-69">(</span><span class="n">Url</span><span class="p" data-group-id="8036149413-69">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-70">[</span><span class="p" data-group-id="8036149413-70">]</span><span class="p" data-group-id="8036149413-68">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-71">[</span><span class="p" data-group-id="8036149413-71">]</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-72">[</span><span class="p" data-group-id="8036149413-73">{</span><span class="ss">stream</span><span class="p">,</span><span class="w"> </span><span class="n">TarFile</span><span class="p" data-group-id="8036149413-73">}</span><span class="p" data-group-id="8036149413-72">]</span><span class="p" data-group-id="8036149413-67">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="8036149413-74">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">saved_to_file</span><span class="p" data-group-id="8036149413-74">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="8036149413-75">(</span><span class="s">&quot;Downloaded release to </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-76">[</span><span class="n">TarFile</span><span class="p" data-group-id="8036149413-76">]</span><span class="p" data-group-id="8036149413-75">)</span><span class="p">,</span><span class="w">
            </span><span class="ss">ok</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="8036149413-77">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8036149413-77">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">logger</span><span class="p">:</span><span class="nf">error</span><span class="p" data-group-id="8036149413-78">(</span><span class="s">&quot;Failed to download release: </span><span class="si">~p</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-79">[</span><span class="n">Reason</span><span class="p" data-group-id="8036149413-79">]</span><span class="p" data-group-id="8036149413-78">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="8036149413-80">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-81">{</span><span class="ss">download_failed</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8036149413-81">}</span><span class="p" data-group-id="8036149413-80">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">get_release_apps</span><span class="p" data-group-id="8036149413-82">(</span><span class="n">RelName</span><span class="p">,</span><span class="w"> </span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-82">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Get list of apps in a release</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">release_handler</span><span class="p">:</span><span class="nf">get_release</span><span class="p" data-group-id="8036149413-83">(</span><span class="n">RelName</span><span class="p">,</span><span class="w"> </span><span class="n">Vsn</span><span class="p" data-group-id="8036149413-83">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="8036149413-84">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Release</span><span class="p" data-group-id="8036149413-84">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="8036149413-85">(</span><span class="ss">applications</span><span class="p">,</span><span class="w"> </span><span class="n">Release</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8036149413-86">[</span><span class="p" data-group-id="8036149413-86">]</span><span class="p" data-group-id="8036149413-85">)</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="8036149413-87">[</span><span class="p" data-group-id="8036149413-87">]</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="health-check-integration" class="section-heading"><a href="#health-check-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Health Check Integration</span></h2><h3 id="default-health-service" class="section-heading"><a href="#default-health-service" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Default Health Service</span></h3><p>Every Macula node provides a default health endpoint:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Registered automatically by macula_upgrade_agent</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="7402205011-1">(</span><span class="p" data-group-id="7402205011-2">&lt;&lt;</span><span class="s">&quot;system.health&quot;</span><span class="p" data-group-id="7402205011-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="7402205011-3">(</span><span class="p" data-group-id="7402205011-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="7402205011-4">#{</span><span class="w">
        </span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="7402205011-5">(</span><span class="p" data-group-id="7402205011-5">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">uptime</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nf">get_uptime</span><span class="p" data-group-id="7402205011-6">(</span><span class="p" data-group-id="7402205011-6">)</span><span class="p">,</span><span class="w">
        </span><span class="nb">memory</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">memory</span><span class="p" data-group-id="7402205011-7">(</span><span class="p" data-group-id="7402205011-7">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">processes</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_info</span><span class="p" data-group-id="7402205011-8">(</span><span class="ss">process_count</span><span class="p" data-group-id="7402205011-8">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">apps</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">application</span><span class="p">:</span><span class="nf">which_applications</span><span class="p" data-group-id="7402205011-9">(</span><span class="p" data-group-id="7402205011-9">)</span><span class="w">
    </span><span class="p" data-group-id="7402205011-4">}</span><span class="w">
</span><span class="k">end</span><span class="p" data-group-id="7402205011-1">)</span><span class="p">.</span></code></pre><h3 id="custom-health-checks" class="section-heading"><a href="#custom-health-checks" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Custom Health Checks</span></h3><p>Applications can register custom health checks:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% In your workload app</span><span class="w">
</span><span class="nf">init</span><span class="p" data-group-id="0901556696-1">(</span><span class="p" data-group-id="0901556696-2">[</span><span class="p" data-group-id="0901556696-2">]</span><span class="p" data-group-id="0901556696-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula</span><span class="p">:</span><span class="nf">advertise</span><span class="p" data-group-id="0901556696-3">(</span><span class="p" data-group-id="0901556696-4">&lt;&lt;</span><span class="s">&quot;snake_game.health&quot;</span><span class="p" data-group-id="0901556696-4">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">check_game_health</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="0901556696-3">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0901556696-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="o">#</span><span class="ss">state</span><span class="p" data-group-id="0901556696-6">{</span><span class="p" data-group-id="0901556696-6">}</span><span class="p" data-group-id="0901556696-5">}</span><span class="p">.</span><span class="w">

</span><span class="nf">check_game_health</span><span class="p" data-group-id="0901556696-7">(</span><span class="p" data-group-id="0901556696-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="0901556696-8">(</span><span class="ss">game_state</span><span class="p" data-group-id="0901556696-8">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">undefined</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="0901556696-9">#{</span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">reason</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">no_game_state</span><span class="p" data-group-id="0901556696-9">}</span><span class="p">;</span><span class="w">
        </span><span class="p">_</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="n">ActiveGames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">ets</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="0901556696-10">(</span><span class="ss">game_state</span><span class="p">,</span><span class="w"> </span><span class="nb">size</span><span class="p" data-group-id="0901556696-10">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="0901556696-11">#{</span><span class="w">
                </span><span class="ss">status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w">
                </span><span class="ss">active_games</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">ActiveGames</span><span class="p">,</span><span class="w">
                </span><span class="ss">memory_mb</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">memory</span><span class="p" data-group-id="0901556696-12">(</span><span class="ss">total</span><span class="p" data-group-id="0901556696-12">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w">
            </span><span class="p" data-group-id="0901556696-11">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="health-check-during-upgrade" class="section-heading"><a href="#health-check-during-upgrade" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Health Check During Upgrade</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Upgrade with custom health check</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="4956622638-1">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4956622638-2">#{</span><span class="w">
    </span><span class="ss">health_check</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4956622638-3">#{</span><span class="w">
        </span><span class="ss">endpoint</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="4956622638-4">&lt;&lt;</span><span class="s">&quot;snake_game.health&quot;</span><span class="p" data-group-id="4956622638-4">&gt;&gt;</span><span class="p">,</span><span class="w">
        </span><span class="ss">required_status</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w">
        </span><span class="ss">retries</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w">
        </span><span class="ss">retry_delay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2000</span><span class="w">
    </span><span class="p" data-group-id="4956622638-3">}</span><span class="w">
</span><span class="p" data-group-id="4956622638-2">}</span><span class="p" data-group-id="4956622638-1">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="release-distribution" class="section-heading"><a href="#release-distribution" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Release Distribution</span></h2><h3 id="option-1-pre-deployed-releases" class="section-heading"><a href="#option-1-pre-deployed-releases" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Option 1: Pre-deployed Releases</span></h3><p>Releases already present on each node:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Nodes have releases in /releases directory</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="0301950771-1">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0301950771-2">#{</span><span class="p" data-group-id="0301950771-2">}</span><span class="p" data-group-id="0301950771-1">)</span><span class="p">.</span></code></pre><h3 id="option-2-url-based-distribution" class="section-heading"><a href="#option-2-url-based-distribution" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Option 2: URL-based Distribution</span></h3><p>Fetch releases from central repository:</p><pre><code class="makeup erlang" translate="no"><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="7803151196-1">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7803151196-2">#{</span><span class="w">
    </span><span class="ss">release_url</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="7803151196-3">&lt;&lt;</span><span class="s">&quot;https://releases.example.com/snake_game-1.1.0.tar.gz&quot;</span><span class="p" data-group-id="7803151196-3">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="7803151196-2">}</span><span class="p" data-group-id="7803151196-1">)</span><span class="p">.</span></code></pre><h3 id="option-3-mesh-based-distribution-future" class="section-heading"><a href="#option-3-mesh-based-distribution-future" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Option 3: Mesh-based Distribution (Future)</span></h3><p>Distribute releases through the mesh itself:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Upload release to mesh storage (future feature)</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">store_release</span><span class="p" data-group-id="3514391833-1">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">TarballBinary</span><span class="p" data-group-id="3514391833-1">)</span><span class="p">,</span><span class="w">

</span><span class="c1">%% Upgrade fetches from mesh</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="3514391833-2">(</span><span class="ss">snake_game</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3514391833-3">#{</span><span class="w">
    </span><span class="ss">release_source</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">mesh</span><span class="w">
</span><span class="p" data-group-id="3514391833-3">}</span><span class="p" data-group-id="3514391833-2">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="monitoring-and-observability" class="section-heading"><a href="#monitoring-and-observability" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Monitoring and Observability</span></h2><h3 id="upgrade-events" class="section-heading"><a href="#upgrade-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upgrade Events</span></h3><p>Published during upgrade for monitoring:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Subscribe to upgrade events</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="2944404759-1">(</span><span class="p" data-group-id="2944404759-2">&lt;&lt;</span><span class="s">&quot;system.upgrade.*&quot;</span><span class="p" data-group-id="2944404759-2">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">handle_upgrade_event</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="2944404759-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Events published:</span><span class="w">
</span><span class="c1">%% system.upgrade.started     - Upgrade initiated</span><span class="w">
</span><span class="c1">%% system.upgrade.batch       - Batch started/completed</span><span class="w">
</span><span class="c1">%% system.upgrade.node        - Node upgraded/failed</span><span class="w">
</span><span class="c1">%% system.upgrade.health      - Health check result</span><span class="w">
</span><span class="c1">%% system.upgrade.rollback    - Rollback initiated</span><span class="w">
</span><span class="c1">%% system.upgrade.completed   - Upgrade finished</span><span class="w">
</span><span class="c1">%% system.upgrade.failed      - Upgrade failed</span></code></pre><h3 id="upgrade-history" class="section-heading"><a href="#upgrade-history" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Upgrade History</span></h3><p>Query upgrade history:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get recent upgrades</span><span class="w">
</span><span class="p" data-group-id="3537349599-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">History</span><span class="p" data-group-id="3537349599-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade_history</span><span class="p" data-group-id="3537349599-2">(</span><span class="p" data-group-id="3537349599-3">#{</span><span class="ss">limit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="3537349599-3">}</span><span class="p" data-group-id="3537349599-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Get specific upgrade details</span><span class="w">
</span><span class="p" data-group-id="3537349599-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Details</span><span class="p" data-group-id="3537349599-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade_details</span><span class="p" data-group-id="3537349599-5">(</span><span class="n">UpgradeId</span><span class="p" data-group-id="3537349599-5">)</span><span class="p">.</span></code></pre><h3 id="metrics" class="section-heading"><a href="#metrics" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Metrics</span></h3><p>Exported for Prometheus/OpenTelemetry:</p><pre><code class="makeup erlang" translate="no"><span class="p">#</span><span class="w"> </span><span class="n">Upgrade</span><span class="w"> </span><span class="ss">duration</span><span class="w"> </span><span class="ss">histogram</span><span class="w">
</span><span class="ss">macula_upgrade_duration_seconds</span><span class="p" data-group-id="3685757236-1">{</span><span class="ss">app</span><span class="o">=</span><span class="s">&quot;snake_game&quot;</span><span class="p">,</span><span class="ss">version</span><span class="o">=</span><span class="s">&quot;1.1.0&quot;</span><span class="p" data-group-id="3685757236-1">}</span><span class="w">

</span><span class="p">#</span><span class="w"> </span><span class="n">Nodes</span><span class="w"> </span><span class="ss">upgraded</span><span class="w"> </span><span class="ss">counter</span><span class="w">
</span><span class="ss">macula_upgrade_nodes_total</span><span class="p" data-group-id="3685757236-2">{</span><span class="ss">app</span><span class="o">=</span><span class="s">&quot;snake_game&quot;</span><span class="p">,</span><span class="ss">status</span><span class="o">=</span><span class="s">&quot;success&quot;</span><span class="p" data-group-id="3685757236-2">}</span><span class="w">
</span><span class="ss">macula_upgrade_nodes_total</span><span class="p" data-group-id="3685757236-3">{</span><span class="ss">app</span><span class="o">=</span><span class="s">&quot;snake_game&quot;</span><span class="p">,</span><span class="ss">status</span><span class="o">=</span><span class="s">&quot;failed&quot;</span><span class="p" data-group-id="3685757236-3">}</span><span class="w">

</span><span class="p">#</span><span class="w"> </span><span class="n">Active</span><span class="w"> </span><span class="ss">upgrades</span><span class="w"> </span><span class="ss">gauge</span><span class="w">
</span><span class="ss">macula_upgrade_active</span></code></pre><hr class="thin"/><h2 id="error-handling" class="section-heading"><a href="#error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling</span></h2><h3 id="failure-scenarios" class="section-heading"><a href="#failure-scenarios" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Failure Scenarios</span></h3><table><thead><tr><th style="text-align: left;">Scenario</th><th style="text-align: left;">Detection</th><th style="text-align: left;">Response</th></tr></thead><tbody><tr><td style="text-align: left;">Node unreachable</td><td style="text-align: left;">RPC timeout</td><td style="text-align: left;">Skip or rollback</td></tr><tr><td style="text-align: left;">Release not found</td><td style="text-align: left;">release_handler error</td><td style="text-align: left;">Abort upgrade</td></tr><tr><td style="text-align: left;">Health check fails</td><td style="text-align: left;">Custom check</td><td style="text-align: left;">Retry or rollback</td></tr><tr><td style="text-align: left;">Partial batch failure</td><td style="text-align: left;">Mixed results</td><td style="text-align: left;">Continue or rollback</td></tr><tr><td style="text-align: left;">Coordinator crash</td><td style="text-align: left;">gen_statem terminate</td><td style="text-align: left;">Agents continue running</td></tr></tbody></table><h3 id="rollback-mechanism" class="section-heading"><a href="#rollback-mechanism" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Rollback Mechanism</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Automatic rollback on failure</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="9058865096-1">(</span><span class="ss">my_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9058865096-2">#{</span><span class="w">
    </span><span class="ss">rollback_on_fail</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">  </span><span class="c1">% Default</span><span class="w">
</span><span class="p" data-group-id="9058865096-2">}</span><span class="p" data-group-id="9058865096-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Manual rollback</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">rollback</span><span class="p" data-group-id="9058865096-3">(</span><span class="ss">my_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9058865096-4">#{</span><span class="w">
    </span><span class="nb">nodes</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">all</span><span class="w">  </span><span class="c1">% or specific nodes</span><span class="w">
</span><span class="p" data-group-id="9058865096-4">}</span><span class="p" data-group-id="9058865096-3">)</span><span class="p">.</span></code></pre><h3 id="partial-upgrade-recovery" class="section-heading"><a href="#partial-upgrade-recovery" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Partial Upgrade Recovery</span></h3><p>If coordinator crashes mid-upgrade:</p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Query current state across mesh</span><span class="w">
</span><span class="p" data-group-id="0330768457-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Status</span><span class="p" data-group-id="0330768457-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade_audit</span><span class="p" data-group-id="0330768457-2">(</span><span class="ss">my_app</span><span class="p" data-group-id="0330768457-2">)</span><span class="p">.</span><span class="w">
</span><span class="c1">%% Returns: #{</span><span class="w">
</span><span class="c1">%%   &quot;1.0.0&quot; =&gt; [node1, node2, node3],</span><span class="w">
</span><span class="c1">%%   &quot;1.1.0&quot; =&gt; [node4, node5]</span><span class="w">
</span><span class="c1">%% }</span><span class="w">

</span><span class="c1">%% Resume upgrade</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="0330768457-3">(</span><span class="ss">my_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0330768457-4">#{</span><span class="w">
    </span><span class="nb">nodes</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0330768457-5">[</span><span class="ss">node1</span><span class="p">,</span><span class="w"> </span><span class="ss">node2</span><span class="p">,</span><span class="w"> </span><span class="ss">node3</span><span class="p" data-group-id="0330768457-5">]</span><span class="w">  </span><span class="c1">% Only remaining nodes</span><span class="w">
</span><span class="p" data-group-id="0330768457-4">}</span><span class="p" data-group-id="0330768457-3">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="security-considerations" class="section-heading"><a href="#security-considerations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Security Considerations</span></h2><h3 id="authorization" class="section-heading"><a href="#authorization" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Authorization</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Only authorized nodes can initiate upgrades</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="9702227409-1">(</span><span class="ss">my_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9702227409-2">#{</span><span class="w">
    </span><span class="ss">auth_token</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9702227409-3">&lt;&lt;</span><span class="s">&quot;secret_token&quot;</span><span class="p" data-group-id="9702227409-3">&gt;&gt;</span><span class="w">
</span><span class="p" data-group-id="9702227409-2">}</span><span class="p" data-group-id="9702227409-1">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Agent verifies authorization</span><span class="w">
</span><span class="nf">handle_upgrade</span><span class="p" data-group-id="9702227409-4">(</span><span class="p" data-group-id="9702227409-5">#{</span><span class="ss">auth_token</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Token</span><span class="p" data-group-id="9702227409-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Request</span><span class="p" data-group-id="9702227409-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nf">verify_upgrade_token</span><span class="p" data-group-id="9702227409-6">(</span><span class="n">Token</span><span class="p" data-group-id="9702227409-6">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="ss">ok</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">do_upgrade</span><span class="p" data-group-id="9702227409-7">(</span><span class="n">Request</span><span class="p" data-group-id="9702227409-7">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="9702227409-8">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">unauthorized</span><span class="p" data-group-id="9702227409-8">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9702227409-9">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">unauthorized</span><span class="p" data-group-id="9702227409-9">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><h3 id="release-verification" class="section-heading"><a href="#release-verification" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Release Verification</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Verify release signature</span><span class="w">
</span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="8595512720-1">(</span><span class="ss">my_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8595512720-2">#{</span><span class="w">
    </span><span class="ss">release_url</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Url</span><span class="p">,</span><span class="w">
    </span><span class="ss">signature_url</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">SigUrl</span><span class="p">,</span><span class="w">
    </span><span class="ss">public_key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">PublicKey</span><span class="w">
</span><span class="p" data-group-id="8595512720-2">}</span><span class="p" data-group-id="8595512720-1">)</span><span class="p">.</span></code></pre><h3 id="audit-logging" class="section-heading"><a href="#audit-logging" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Audit Logging</span></h3><p>All upgrade operations logged with:</p><ul><li>Initiator node ID</li><li>Timestamp</li><li>Target app/version</li><li>Affected nodes</li><li>Result (success/failure)</li><li>Rollback actions</li></ul><hr class="thin"/><h2 id="testing-strategy" class="section-heading"><a href="#testing-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Testing Strategy</span></h2><h3 id="unit-tests" class="section-heading"><a href="#unit-tests" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Unit Tests</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Test batch planning</span><span class="w">
</span><span class="nc">macula_upgrade_planner_tests</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">-</span><span class="w"> </span><span class="na">rolling_creates_correct_batches</span><span class="o">/</span><span class="mi">0</span><span class="w">
</span><span class="w">  </span><span class="p">-</span><span class="w"> </span><span class="na">canary_separates_first_node</span><span class="o">/</span><span class="mi">0</span><span class="w">
</span><span class="w">  </span><span class="p">-</span><span class="w"> </span><span class="na">all_at_once_single_batch</span><span class="o">/</span><span class="mi">0</span><span class="w">

</span><span class="c1">%% Test agent operations</span><span class="w">
</span><span class="nc">macula_upgrade_agent_tests</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="p">-</span><span class="w"> </span><span class="na">successful_upgrade</span><span class="o">/</span><span class="mi">0</span><span class="w">
</span><span class="w">  </span><span class="p">-</span><span class="w"> </span><span class="na">failed_upgrade_returns_error</span><span class="o">/</span><span class="mi">0</span><span class="w">
</span><span class="w">  </span><span class="p">-</span><span class="w"> </span><span class="na">rollback_restores_version</span><span class="o">/</span><span class="mi">0</span></code></pre><h3 id="integration-tests" class="section-heading"><a href="#integration-tests" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Integration Tests</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Multi-node upgrade test</span><span class="w">
</span><span class="nf">upgrade_integration_test</span><span class="p" data-group-id="9448820009-1">(</span><span class="p" data-group-id="9448820009-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Start 5-node mesh</span><span class="w">
    </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">start_test_mesh</span><span class="p" data-group-id="9448820009-2">(</span><span class="mi">5</span><span class="p" data-group-id="9448820009-2">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Deploy v1.0.0 to all</span><span class="w">
    </span><span class="nf">deploy_app</span><span class="p" data-group-id="9448820009-3">(</span><span class="ss">test_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.0.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="9448820009-3">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Upgrade to v1.1.0</span><span class="w">
    </span><span class="p" data-group-id="9448820009-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="9448820009-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="9448820009-5">(</span><span class="ss">test_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9448820009-6">#{</span><span class="w">
        </span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">rolling</span><span class="p">,</span><span class="w">
        </span><span class="ss">batch_size</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w">
    </span><span class="p" data-group-id="9448820009-6">}</span><span class="p" data-group-id="9448820009-5">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Verify all nodes upgraded</span><span class="w">
    </span><span class="o">?</span><span class="nf">assertEqual</span><span class="p" data-group-id="9448820009-7">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9448820009-8">(</span><span class="ss">upgraded</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="9448820009-8">)</span><span class="p" data-group-id="9448820009-7">)</span><span class="p">,</span><span class="w">
    </span><span class="o">?</span><span class="nf">assertEqual</span><span class="p" data-group-id="9448820009-9">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9448820009-10">(</span><span class="ss">failed</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="9448820009-10">)</span><span class="p" data-group-id="9448820009-9">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Verify correct version running</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="9448820009-11">(</span><span class="nf">fun</span><span class="p" data-group-id="9448820009-12">(</span><span class="n">Node</span><span class="p" data-group-id="9448820009-12">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="9448820009-13">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9448820009-14">#{</span><span class="ss">version</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p" data-group-id="9448820009-14">}</span><span class="p" data-group-id="9448820009-13">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">get_app_version</span><span class="p" data-group-id="9448820009-15">(</span><span class="n">Node</span><span class="p">,</span><span class="w"> </span><span class="ss">test_app</span><span class="p" data-group-id="9448820009-15">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="9448820009-11">)</span><span class="p">.</span></code></pre><h3 id="chaos-testing" class="section-heading"><a href="#chaos-testing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Chaos Testing</span></h3><pre><code class="makeup erlang" translate="no"><span class="c1">%% Test failure scenarios</span><span class="w">
</span><span class="nf">chaos_upgrade_test</span><span class="p" data-group-id="9358847012-1">(</span><span class="p" data-group-id="9358847012-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Nodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">start_test_mesh</span><span class="p" data-group-id="9358847012-2">(</span><span class="mi">6</span><span class="p" data-group-id="9358847012-2">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Kill node during upgrade</span><span class="w">
    </span><span class="nf">spawn</span><span class="p" data-group-id="9358847012-3">(</span><span class="nf">fun</span><span class="p" data-group-id="9358847012-4">(</span><span class="p" data-group-id="9358847012-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">timer</span><span class="p">:</span><span class="nf">sleep</span><span class="p" data-group-id="9358847012-5">(</span><span class="mi">500</span><span class="p" data-group-id="9358847012-5">)</span><span class="p">,</span><span class="w">
        </span><span class="nf">kill_node</span><span class="p" data-group-id="9358847012-6">(</span><span class="nc">lists</span><span class="p">:</span><span class="nf">nth</span><span class="p" data-group-id="9358847012-7">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">Nodes</span><span class="p" data-group-id="9358847012-7">)</span><span class="p" data-group-id="9358847012-6">)</span><span class="w">
    </span><span class="k">end</span><span class="p" data-group-id="9358847012-3">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Upgrade should handle failure gracefully</span><span class="w">
    </span><span class="n">Result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">upgrade</span><span class="p" data-group-id="9358847012-8">(</span><span class="ss">test_app</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1.1.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9358847012-9">#{</span><span class="w">
        </span><span class="ss">rollback_on_fail</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
    </span><span class="p" data-group-id="9358847012-9">}</span><span class="p" data-group-id="9358847012-8">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Should have rolled back</span><span class="w">
    </span><span class="o">?</span><span class="nf">assertMatch</span><span class="p" data-group-id="9358847012-10">(</span><span class="p" data-group-id="9358847012-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9358847012-12">{</span><span class="ss">batch_failed</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="p" data-group-id="9358847012-12">}</span><span class="p" data-group-id="9358847012-11">}</span><span class="p">,</span><span class="w"> </span><span class="n">Result</span><span class="p" data-group-id="9358847012-10">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="implementation-timeline" class="section-heading"><a href="#implementation-timeline" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Implementation Timeline</span></h2><h3 id="phase-1-core-framework-week-1-2" class="section-heading"><a href="#phase-1-core-framework-week-1-2" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 1: Core Framework (Week 1-2)</span></h3><ul><li>[ ] <code class="inline">macula_upgrade</code> coordinator module</li><li>[ ] <code class="inline">macula_upgrade_agent</code> per-node module</li><li>[ ] Basic rolling upgrade strategy</li><li>[ ] Unit tests</li></ul><h3 id="phase-2-strategies-health-week-3" class="section-heading"><a href="#phase-2-strategies-health-week-3" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 2: Strategies &amp; Health (Week 3)</span></h3><ul><li>[ ] <code class="inline">macula_upgrade_planner</code> with all strategies</li><li>[ ] <code class="inline">macula_upgrade_health</code> framework</li><li>[ ] Custom health check integration</li><li>[ ] Integration tests</li></ul><h3 id="phase-3-resilience-week-4" class="section-heading"><a href="#phase-3-resilience-week-4" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 3: Resilience (Week 4)</span></h3><ul><li>[ ] Rollback mechanism</li><li>[ ] Partial failure handling</li><li>[ ] Coordinator crash recovery</li><li>[ ] Chaos tests</li></ul><h3 id="phase-4-polish-docs-week-5" class="section-heading"><a href="#phase-4-polish-docs-week-5" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Phase 4: Polish &amp; Docs (Week 5)</span></h3><ul><li>[ ] Metrics and observability</li><li>[ ] Security (auth, signatures)</li><li>[ ] Documentation</li><li>[ ] Performance optimization</li></ul><p><strong>Total estimated effort</strong>: 5 weeks</p><hr class="thin"/><h2 id="dependencies" class="section-heading"><a href="#dependencies" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Dependencies</span></h2><ul><li><strong>Macula v0.9.0</strong>: NAT traversal for reliable node connectivity</li><li><strong>OTP 27+</strong>: Modern release_handler features</li><li><strong>Application appup files</strong>: Required for stateful upgrades</li></ul><hr class="thin"/><h2 id="future-enhancements" class="section-heading"><a href="#future-enhancements" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Future Enhancements</span></h2><h3 id="v1-1-0" class="section-heading"><a href="#v1-1-0" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">v1.1.0+</span></h3><ul><li><strong>Mesh-based release storage</strong>: Store releases in DHT</li><li><strong>Differential updates</strong>: Only transfer changed modules</li><li><strong>Scheduled upgrades</strong>: Cron-like upgrade scheduling</li><li><strong>Upgrade policies</strong>: Automatic upgrades based on rules</li><li><strong>Multi-app transactions</strong>: Upgrade multiple apps atomically</li></ul><hr class="thin"/><h2 id="references" class="section-heading"><a href="#references" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">References</span></h2><ul><li><a href="https://www.erlang.org/doc/design_principles/release_handling.html">OTP Release Handling</a></li><li><a href="https://www.erlang.org/doc/design_principles/appup_cookbook.html">Appup Cookbook</a></li><li><a href="https://www.erlang.org/doc/reference_manual/code_loading.html">Hot Code Loading</a></li><li><a href="https://erlware.github.io/relx/">Relx Documentation</a></li></ul><hr class="thin"/><h2 id="summary" class="section-heading"><a href="#summary" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Summary</span></h2><p>Mesh-wide hot code upgrade is a <strong>flagship feature</strong> for Macula v1.0.0 that leverages:</p><ol><li><strong>Platform/workload separation</strong> - Upgrade workloads while platform maintains connections</li><li><strong>Macula RPC</strong> - Coordinate upgrades across mesh without external tools</li><li><strong>OTP release_handler</strong> - Standard BEAM upgrade mechanism</li><li><strong>Health checks</strong> - Verify upgrades before proceeding</li></ol><p><strong>Result</strong>: True BEAM-native distributed deployment with zero-downtime rolling upgrades orchestrated through the mesh itself.</p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="v1-0-0-roadmap.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
v1.0.0 Roadmap
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="index.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Architecture Index
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.9.2" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.9.2">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.9.2/show/architecture/MESH_HOT_UPGRADE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
