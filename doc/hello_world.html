<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.12.4">


    <title>Hello World — macula v0.12.4</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-DE2E663F.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="overview.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="overview.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.12.4
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>Macula HTTP/3 Mesh - Hello World Tutorial</h1>


      <a href="https://github.com/macula-io/macula/blob/0.12.4/docs/user/HELLO_WORLD.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p><strong>Build your first distributed application on Macula</strong></p><hr class="thin"/><h2 id="what-we-ll-build" class="section-heading"><a href="#what-we-ll-build" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What We'll Build</span></h2><p>A <strong>distributed chat application</strong> where:</p><ul><li>Multiple nodes can join a chat room</li><li>Users can send messages that appear on all nodes</li><li>Messages are routed via the Macula mesh (pub/sub)</li><li>Users can query &quot;who's online&quot; (RPC call)</li><li>Graceful handling of nodes joining/leaving</li></ul><p><strong>Time to complete</strong>: 30 minutes</p><p><strong>Prerequisites</strong>:</p><ul><li>Completed <a href="quick_start.html">Quick Start Guide</a></li><li>Basic Erlang or Elixir knowledge</li><li>Macula installed and working</li></ul><hr class="thin"/><h2 id="project-structure" class="section-heading"><a href="#project-structure" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Project Structure</span></h2><p>We'll create a new Mix (Elixir) or Rebar3 (Erlang) project:</p><pre><code class="makeup erlang" translate="no"><span class="ss">macula_chat</span><span class="o">/</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">config</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">config</span><span class="p">.</span><span class="ss">exs</span><span class="w">          </span><span class="p">#</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="ss">configuration</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">lib</span><span class="o">/</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">macula_chat</span><span class="p">.</span><span class="ss">ex</span><span class="w">      </span><span class="p">#</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="ss">entry</span><span class="w"> </span><span class="ss">point</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">chat_room</span><span class="p">.</span><span class="ss">ex</span><span class="w">        </span><span class="p">#</span><span class="w"> </span><span class="n">Chat</span><span class="w"> </span><span class="ss">room</span><span class="w"> </span><span class="n">GenServer</span><span class="w">
</span><span class="err">│</span><span class="w">   </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">chat_client</span><span class="p">.</span><span class="ss">ex</span><span class="w">      </span><span class="p">#</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="ss">client</span><span class="w">
</span><span class="err">├</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="ss">mix</span><span class="p">.</span><span class="ss">exs</span><span class="w">                 </span><span class="p">#</span><span class="w"> </span><span class="n">Project</span><span class="w"> </span><span class="ss">definition</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="w"> </span><span class="n">README</span><span class="p">.</span><span class="ss">md</span></code></pre><hr class="thin"/><h2 id="step-1-create-new-project" class="section-heading"><a href="#step-1-create-new-project" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 1: Create New Project</span></h2><h3 id="using-mix-elixir" class="section-heading"><a href="#using-mix-elixir" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Using Mix (Elixir)</span></h3><pre><code class="makeup bash" translate="no"><span class="">mix new macula_chat --sup
</span><span class="">cd macula_chat
</span></code></pre><h3 id="using-rebar3-erlang" class="section-heading"><a href="#using-rebar3-erlang" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Using Rebar3 (Erlang)</span></h3><pre><code class="makeup bash" translate="no"><span class="">rebar3 new app macula_chat
</span><span class="">cd macula_chat
</span></code></pre><hr class="thin"/><h2 id="step-2-add-macula-dependency" class="section-heading"><a href="#step-2-add-macula-dependency" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 2: Add Macula Dependency</span></h2><h3 id="mix-elixir" class="section-heading"><a href="#mix-elixir" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Mix (Elixir)</span></h3><p>Edit <code class="inline">mix.exs</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MaculaChat.MixProject</span><span class="w"> </span><span class="k" data-group-id="7027528188-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Mix.Project</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">project</span><span class="w"> </span><span class="k" data-group-id="7027528188-2">do</span><span class="w">
    </span><span class="p" data-group-id="7027528188-3">[</span><span class="w">
      </span><span class="ss">app</span><span class="p">:</span><span class="w"> </span><span class="ss">:macula_chat</span><span class="p">,</span><span class="w">
      </span><span class="ss">version</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0.1.0&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">elixir</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;~&gt; 1.15&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">start_permanent</span><span class="p">:</span><span class="w"> </span><span class="nc">Mix</span><span class="o">.</span><span class="n">env</span><span class="p" data-group-id="7027528188-4">(</span><span class="p" data-group-id="7027528188-4">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="ss">:prod</span><span class="p">,</span><span class="w">
      </span><span class="ss">deps</span><span class="p">:</span><span class="w"> </span><span class="n">deps</span><span class="p" data-group-id="7027528188-5">(</span><span class="p" data-group-id="7027528188-5">)</span><span class="w">
    </span><span class="p" data-group-id="7027528188-3">]</span><span class="w">
  </span><span class="k" data-group-id="7027528188-2">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">application</span><span class="w"> </span><span class="k" data-group-id="7027528188-6">do</span><span class="w">
    </span><span class="p" data-group-id="7027528188-7">[</span><span class="w">
      </span><span class="ss">extra_applications</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7027528188-8">[</span><span class="ss">:logger</span><span class="p" data-group-id="7027528188-8">]</span><span class="p">,</span><span class="w">
      </span><span class="ss">mod</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7027528188-9">{</span><span class="nc">MaculaChat.Application</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7027528188-10">[</span><span class="p" data-group-id="7027528188-10">]</span><span class="p" data-group-id="7027528188-9">}</span><span class="w">
    </span><span class="p" data-group-id="7027528188-7">]</span><span class="w">
  </span><span class="k" data-group-id="7027528188-6">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">deps</span><span class="w"> </span><span class="k" data-group-id="7027528188-11">do</span><span class="w">
    </span><span class="p" data-group-id="7027528188-12">[</span><span class="w">
      </span><span class="p" data-group-id="7027528188-13">{</span><span class="ss">:macula</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;~&gt; 0.6&quot;</span><span class="p" data-group-id="7027528188-13">}</span><span class="w">
    </span><span class="p" data-group-id="7027528188-12">]</span><span class="w">
  </span><span class="k" data-group-id="7027528188-11">end</span><span class="w">
</span><span class="k" data-group-id="7027528188-1">end</span></code></pre><h3 id="rebar3-erlang" class="section-heading"><a href="#rebar3-erlang" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Rebar3 (Erlang)</span></h3><p>Edit <code class="inline">rebar.config</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2050738153-1">{</span><span class="ss">erl_opts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2050738153-2">[</span><span class="ss">debug_info</span><span class="p" data-group-id="2050738153-2">]</span><span class="p" data-group-id="2050738153-1">}</span><span class="p">.</span><span class="w">

</span><span class="p" data-group-id="2050738153-3">{</span><span class="ss">deps</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2050738153-4">[</span><span class="w">
    </span><span class="p" data-group-id="2050738153-5">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;0.6.6&quot;</span><span class="p" data-group-id="2050738153-5">}</span><span class="w">
</span><span class="p" data-group-id="2050738153-4">]</span><span class="p" data-group-id="2050738153-3">}</span><span class="p">.</span><span class="w">

</span><span class="p" data-group-id="2050738153-6">{</span><span class="ss">shell</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2050738153-7">[</span><span class="w">
    </span><span class="p" data-group-id="2050738153-8">{</span><span class="ss">apps</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2050738153-9">[</span><span class="ss">macula_chat</span><span class="p" data-group-id="2050738153-9">]</span><span class="p" data-group-id="2050738153-8">}</span><span class="w">
</span><span class="p" data-group-id="2050738153-7">]</span><span class="p" data-group-id="2050738153-6">}</span><span class="p">.</span></code></pre><h3 id="install-dependencies" class="section-heading"><a href="#install-dependencies" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Install Dependencies</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Mix
</span><span class="">mix deps.get
</span><span class="">
</span><span class=""># Rebar3
</span><span class="">rebar3 get-deps
</span></code></pre><hr class="thin"/><h2 id="step-3-configure-macula" class="section-heading"><a href="#step-3-configure-macula" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 3: Configure Macula</span></h2><h3 id="mix-configuration" class="section-heading"><a href="#mix-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Mix Configuration</span></h3><p>Create <code class="inline">config/config.exs</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kn">import</span><span class="w"> </span><span class="nc">Config</span><span class="w">

</span><span class="n">config</span><span class="w"> </span><span class="ss">:macula</span><span class="p">,</span><span class="w">
  </span><span class="ss">realm</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;io.macula.chat&quot;</span><span class="p">,</span><span class="w">
  </span><span class="ss">listen_port</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="5948386157-1">(</span><span class="s">&quot;MACULA_PORT&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;4433&quot;</span><span class="p" data-group-id="5948386157-1">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">String</span><span class="o">.</span><span class="n">to_integer</span><span class="p" data-group-id="5948386157-2">(</span><span class="p" data-group-id="5948386157-2">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">discovery</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5948386157-3">[</span><span class="w">
    </span><span class="ss">methods</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5948386157-4">[</span><span class="ss">:static</span><span class="p">,</span><span class="w"> </span><span class="ss">:mdns</span><span class="p" data-group-id="5948386157-4">]</span><span class="p">,</span><span class="w">
    </span><span class="ss">static_nodes</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5948386157-5">[</span><span class="p" data-group-id="5948386157-5">]</span><span class="w">  </span><span class="c1"># Add bootstrap nodes via env var</span><span class="w">
  </span><span class="p" data-group-id="5948386157-3">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">topology</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5948386157-6">[</span><span class="w">
    </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:k_regular</span><span class="p">,</span><span class="w">
    </span><span class="ss">k</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="w">
  </span><span class="p" data-group-id="5948386157-6">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">cert_mode</span><span class="p">:</span><span class="w"> </span><span class="ss">:auto_generate</span><span class="p">,</span><span class="w">
  </span><span class="ss">log_level</span><span class="p">:</span><span class="w"> </span><span class="ss">:info</span><span class="w">

</span><span class="c1"># Chat-specific config</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:macula_chat</span><span class="p">,</span><span class="w">
  </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="5948386157-7">(</span><span class="s">&quot;CHAT_USER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Anonymous&quot;</span><span class="p" data-group-id="5948386157-7">)</span><span class="p">,</span><span class="w">
  </span><span class="ss">room</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="5948386157-8">(</span><span class="s">&quot;CHAT_ROOM&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;general&quot;</span><span class="p" data-group-id="5948386157-8">)</span></code></pre><h3 id="rebar3-configuration" class="section-heading"><a href="#rebar3-configuration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Rebar3 Configuration</span></h3><p>Create <code class="inline">config/sys.config</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2404240222-1">[</span><span class="w">
 </span><span class="p" data-group-id="2404240222-2">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-3">[</span><span class="w">
   </span><span class="p" data-group-id="2404240222-4">{</span><span class="ss">realm</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-5">&lt;&lt;</span><span class="s">&quot;io.macula.chat&quot;</span><span class="p" data-group-id="2404240222-5">&gt;&gt;</span><span class="p" data-group-id="2404240222-4">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2404240222-6">{</span><span class="ss">listen_port</span><span class="p">,</span><span class="w"> </span><span class="mi">4433</span><span class="p" data-group-id="2404240222-6">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2404240222-7">{</span><span class="ss">discovery</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-8">[</span><span class="w">
     </span><span class="p" data-group-id="2404240222-9">{</span><span class="ss">methods</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-10">[</span><span class="ss">static</span><span class="p">,</span><span class="w"> </span><span class="ss">mdns</span><span class="p" data-group-id="2404240222-10">]</span><span class="p" data-group-id="2404240222-9">}</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="2404240222-11">{</span><span class="ss">static_nodes</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-12">[</span><span class="p" data-group-id="2404240222-12">]</span><span class="p" data-group-id="2404240222-11">}</span><span class="w">
   </span><span class="p" data-group-id="2404240222-8">]</span><span class="p" data-group-id="2404240222-7">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2404240222-13">{</span><span class="ss">topology</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-14">[</span><span class="w">
     </span><span class="p" data-group-id="2404240222-15">{</span><span class="ss">type</span><span class="p">,</span><span class="w"> </span><span class="ss">k_regular</span><span class="p" data-group-id="2404240222-15">}</span><span class="p">,</span><span class="w">
     </span><span class="p" data-group-id="2404240222-16">{</span><span class="ss">k</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p" data-group-id="2404240222-16">}</span><span class="w">
   </span><span class="p" data-group-id="2404240222-14">]</span><span class="p" data-group-id="2404240222-13">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2404240222-17">{</span><span class="ss">cert_mode</span><span class="p">,</span><span class="w"> </span><span class="ss">auto_generate</span><span class="p" data-group-id="2404240222-17">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2404240222-18">{</span><span class="ss">log_level</span><span class="p">,</span><span class="w"> </span><span class="ss">info</span><span class="p" data-group-id="2404240222-18">}</span><span class="w">
 </span><span class="p" data-group-id="2404240222-3">]</span><span class="p" data-group-id="2404240222-2">}</span><span class="p">,</span><span class="w">

 </span><span class="p" data-group-id="2404240222-19">{</span><span class="ss">macula_chat</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-20">[</span><span class="w">
   </span><span class="p" data-group-id="2404240222-21">{</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-22">&lt;&lt;</span><span class="s">&quot;Anonymous&quot;</span><span class="p" data-group-id="2404240222-22">&gt;&gt;</span><span class="p" data-group-id="2404240222-21">}</span><span class="p">,</span><span class="w">
   </span><span class="p" data-group-id="2404240222-23">{</span><span class="ss">room</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2404240222-24">&lt;&lt;</span><span class="s">&quot;general&quot;</span><span class="p" data-group-id="2404240222-24">&gt;&gt;</span><span class="p" data-group-id="2404240222-23">}</span><span class="w">
 </span><span class="p" data-group-id="2404240222-20">]</span><span class="p" data-group-id="2404240222-19">}</span><span class="w">
</span><span class="p" data-group-id="2404240222-1">]</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="step-4-implement-chat-room" class="section-heading"><a href="#step-4-implement-chat-room" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 4: Implement Chat Room</span></h2><h3 id="elixir-implementation" class="section-heading"><a href="#elixir-implementation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Elixir Implementation</span></h3><p>Create <code class="inline">lib/chat_room.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MaculaChat.ChatRoom</span><span class="w"> </span><span class="k" data-group-id="0548894450-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Chat room GenServer that handles:
  - Subscribing to chat messages
  - Publishing messages to the room
  - Tracking online users
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">

  </span><span class="na">@topic_prefix</span><span class="w"> </span><span class="s">&quot;io.macula.chat.room&quot;</span><span class="w">

  </span><span class="c1">## Client API</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="0548894450-2">(</span><span class="n">opts</span><span class="p" data-group-id="0548894450-2">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-3">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="0548894450-4">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="0548894450-4">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-3">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Send a message to the chat room&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p" data-group-id="0548894450-5">(</span><span class="n">message</span><span class="p" data-group-id="0548894450-5">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-6">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p" data-group-id="0548894450-7">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-8">{</span><span class="ss">:send_message</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="0548894450-8">}</span><span class="p" data-group-id="0548894450-7">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-6">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Get list of online users (RPC)&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_online_users</span><span class="w"> </span><span class="k" data-group-id="0548894450-9">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="0548894450-10">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="ss">:get_online_users</span><span class="p" data-group-id="0548894450-10">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-9">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Join a chat room&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">join_room</span><span class="p" data-group-id="0548894450-11">(</span><span class="n">room_name</span><span class="p" data-group-id="0548894450-11">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-12">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="0548894450-13">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-14">{</span><span class="ss">:join_room</span><span class="p">,</span><span class="w"> </span><span class="n">room_name</span><span class="p" data-group-id="0548894450-14">}</span><span class="p" data-group-id="0548894450-13">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-12">end</span><span class="w">

  </span><span class="c1">## Server Callbacks</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="0548894450-15">(</span><span class="n">opts</span><span class="p" data-group-id="0548894450-15">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-16">do</span><span class="w">
    </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="0548894450-17">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:username</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Anonymous&quot;</span><span class="p" data-group-id="0548894450-17">)</span><span class="w">
    </span><span class="n">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="0548894450-18">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:room</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;general&quot;</span><span class="p" data-group-id="0548894450-18">)</span><span class="w">

    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0548894450-19">%{</span><span class="w">
      </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w">
      </span><span class="ss">room</span><span class="p">:</span><span class="w"> </span><span class="n">room</span><span class="p">,</span><span class="w">
      </span><span class="ss">topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="0548894450-20">#{</span><span class="na">@topic_prefix</span><span class="si" data-group-id="0548894450-20">}</span><span class="s">.</span><span class="si" data-group-id="0548894450-21">#{</span><span class="n">room</span><span class="si" data-group-id="0548894450-21">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">presence_topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="0548894450-22">#{</span><span class="na">@topic_prefix</span><span class="si" data-group-id="0548894450-22">}</span><span class="s">.</span><span class="si" data-group-id="0548894450-23">#{</span><span class="n">room</span><span class="si" data-group-id="0548894450-23">}</span><span class="s">.presence&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">online_users</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0548894450-24">%{</span><span class="p" data-group-id="0548894450-24">}</span><span class="w">
    </span><span class="p" data-group-id="0548894450-19">}</span><span class="w">

    </span><span class="c1"># Subscribe to room messages</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="0548894450-25">(</span><span class="n">state</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="0548894450-26">(</span><span class="p" data-group-id="0548894450-26">)</span><span class="p" data-group-id="0548894450-25">)</span><span class="w">

    </span><span class="c1"># Subscribe to presence (join/leave notifications)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="0548894450-27">(</span><span class="n">state</span><span class="o">.</span><span class="n">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="0548894450-28">(</span><span class="p" data-group-id="0548894450-28">)</span><span class="p" data-group-id="0548894450-27">)</span><span class="w">

    </span><span class="c1"># Register RPC endpoint for &quot;who&#39;s online&quot;</span><span class="w">
    </span><span class="n">rpc_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;chat.</span><span class="si" data-group-id="0548894450-29">#{</span><span class="n">room</span><span class="si" data-group-id="0548894450-29">}</span><span class="s">.users&quot;</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macula.RPC</span><span class="o">.</span><span class="n">register</span><span class="p" data-group-id="0548894450-30">(</span><span class="n">rpc_name</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="0548894450-31">fn</span><span class="w"> </span><span class="bp">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="0548894450-32">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">keys</span><span class="p" data-group-id="0548894450-33">(</span><span class="n">state</span><span class="o">.</span><span class="n">online_users</span><span class="p" data-group-id="0548894450-33">)</span><span class="p" data-group-id="0548894450-32">}</span><span class="w">
    </span><span class="k" data-group-id="0548894450-31">end</span><span class="p" data-group-id="0548894450-30">)</span><span class="w">

    </span><span class="c1"># Announce presence</span><span class="w">
    </span><span class="n">announce_join</span><span class="p" data-group-id="0548894450-34">(</span><span class="n">state</span><span class="p" data-group-id="0548894450-34">)</span><span class="w">

    </span><span class="c1"># Schedule periodic presence heartbeat</span><span class="w">
    </span><span class="n">schedule_heartbeat</span><span class="p" data-group-id="0548894450-35">(</span><span class="p" data-group-id="0548894450-35">)</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="0548894450-36">(</span><span class="s">&quot;Joined chat room: </span><span class="si" data-group-id="0548894450-37">#{</span><span class="n">room</span><span class="si" data-group-id="0548894450-37">}</span><span class="s"> as </span><span class="si" data-group-id="0548894450-38">#{</span><span class="n">username</span><span class="si" data-group-id="0548894450-38">}</span><span class="s">&quot;</span><span class="p" data-group-id="0548894450-36">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-39">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-39">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-16">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="0548894450-40">(</span><span class="ss">:get_online_users</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-40">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-41">do</span><span class="w">
    </span><span class="n">users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">keys</span><span class="p" data-group-id="0548894450-42">(</span><span class="n">state</span><span class="o">.</span><span class="n">online_users</span><span class="p" data-group-id="0548894450-42">)</span><span class="w">
    </span><span class="p" data-group-id="0548894450-43">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-44">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="0548894450-44">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-43">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-41">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="0548894450-45">(</span><span class="p" data-group-id="0548894450-46">{</span><span class="ss">:join_room</span><span class="p">,</span><span class="w"> </span><span class="n">new_room</span><span class="p" data-group-id="0548894450-46">}</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-45">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-47">do</span><span class="w">
    </span><span class="c1"># Unsubscribe from old room</span><span class="w">
    </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p" data-group-id="0548894450-48">(</span><span class="n">state</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="0548894450-49">(</span><span class="p" data-group-id="0548894450-49">)</span><span class="p" data-group-id="0548894450-48">)</span><span class="w">
    </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p" data-group-id="0548894450-50">(</span><span class="n">state</span><span class="o">.</span><span class="n">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="0548894450-51">(</span><span class="p" data-group-id="0548894450-51">)</span><span class="p" data-group-id="0548894450-50">)</span><span class="w">

    </span><span class="c1"># Announce leave</span><span class="w">
    </span><span class="n">announce_leave</span><span class="p" data-group-id="0548894450-52">(</span><span class="n">state</span><span class="p" data-group-id="0548894450-52">)</span><span class="w">

    </span><span class="c1"># Update state</span><span class="w">
    </span><span class="n">new_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0548894450-53">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w">
      </span><span class="ss">room</span><span class="p">:</span><span class="w"> </span><span class="n">new_room</span><span class="p">,</span><span class="w">
      </span><span class="ss">topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="0548894450-54">#{</span><span class="na">@topic_prefix</span><span class="si" data-group-id="0548894450-54">}</span><span class="s">.</span><span class="si" data-group-id="0548894450-55">#{</span><span class="n">new_room</span><span class="si" data-group-id="0548894450-55">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">presence_topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="0548894450-56">#{</span><span class="na">@topic_prefix</span><span class="si" data-group-id="0548894450-56">}</span><span class="s">.</span><span class="si" data-group-id="0548894450-57">#{</span><span class="n">new_room</span><span class="si" data-group-id="0548894450-57">}</span><span class="s">.presence&quot;</span><span class="p">,</span><span class="w">
      </span><span class="ss">online_users</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0548894450-58">%{</span><span class="p" data-group-id="0548894450-58">}</span><span class="w">
    </span><span class="p" data-group-id="0548894450-53">}</span><span class="w">

    </span><span class="c1"># Subscribe to new room</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="0548894450-59">(</span><span class="n">new_state</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="0548894450-60">(</span><span class="p" data-group-id="0548894450-60">)</span><span class="p" data-group-id="0548894450-59">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="0548894450-61">(</span><span class="n">new_state</span><span class="o">.</span><span class="n">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p" data-group-id="0548894450-62">(</span><span class="p" data-group-id="0548894450-62">)</span><span class="p" data-group-id="0548894450-61">)</span><span class="w">

    </span><span class="c1"># Announce join</span><span class="w">
    </span><span class="n">announce_join</span><span class="p" data-group-id="0548894450-63">(</span><span class="n">new_state</span><span class="p" data-group-id="0548894450-63">)</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="0548894450-64">(</span><span class="s">&quot;Switched to chat room: </span><span class="si" data-group-id="0548894450-65">#{</span><span class="n">new_room</span><span class="si" data-group-id="0548894450-65">}</span><span class="s">&quot;</span><span class="p" data-group-id="0548894450-64">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-66">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_state</span><span class="p" data-group-id="0548894450-66">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-47">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_cast</span><span class="p" data-group-id="0548894450-67">(</span><span class="p" data-group-id="0548894450-68">{</span><span class="ss">:send_message</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="0548894450-68">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-67">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-69">do</span><span class="w">
    </span><span class="c1"># Publish message to room</span><span class="w">
    </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0548894450-70">%{</span><span class="w">
      </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">username</span><span class="p">,</span><span class="w">
      </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w">
      </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="0548894450-71">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="0548894450-71">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">node_id</span><span class="p">:</span><span class="w"> </span><span class="nc">Macula</span><span class="o">.</span><span class="n">node_id</span><span class="p" data-group-id="0548894450-72">(</span><span class="p" data-group-id="0548894450-72">)</span><span class="w">
    </span><span class="p" data-group-id="0548894450-70">}</span><span class="w">

    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="0548894450-73">(</span><span class="n">state</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p" data-group-id="0548894450-73">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-74">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-74">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-69">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0548894450-75">(</span><span class="p" data-group-id="0548894450-76">{</span><span class="ss">:event</span><span class="p">,</span><span class="w"> </span><span class="c">_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-77">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:message</span><span class="p" data-group-id="0548894450-77">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0548894450-76">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-75">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-78">do</span><span class="w">
    </span><span class="c1"># Received chat message</span><span class="w">
    </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">username</span><span class="w">
    </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="w">
    </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">timestamp</span><span class="w">

    </span><span class="c1"># Format timestamp</span><span class="w">
    </span><span class="p" data-group-id="0548894450-79">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p" data-group-id="0548894450-79">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">DateTime</span><span class="o">.</span><span class="n">from_unix</span><span class="p" data-group-id="0548894450-80">(</span><span class="n">timestamp</span><span class="p">,</span><span class="w"> </span><span class="ss">:millisecond</span><span class="p" data-group-id="0548894450-80">)</span><span class="w">
    </span><span class="n">time_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Calendar</span><span class="o">.</span><span class="n">strftime</span><span class="p" data-group-id="0548894450-81">(</span><span class="n">dt</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%H:%M:%S&quot;</span><span class="p" data-group-id="0548894450-81">)</span><span class="w">

    </span><span class="c1"># Print to console</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="0548894450-82">(</span><span class="s">&quot;[</span><span class="si" data-group-id="0548894450-83">#{</span><span class="n">time_str</span><span class="si" data-group-id="0548894450-83">}</span><span class="s">] &lt;</span><span class="si" data-group-id="0548894450-84">#{</span><span class="n">username</span><span class="si" data-group-id="0548894450-84">}</span><span class="s">&gt; </span><span class="si" data-group-id="0548894450-85">#{</span><span class="n">message</span><span class="si" data-group-id="0548894450-85">}</span><span class="s">&quot;</span><span class="p" data-group-id="0548894450-82">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-86">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-86">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-78">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0548894450-87">(</span><span class="p" data-group-id="0548894450-88">{</span><span class="ss">:event</span><span class="p">,</span><span class="w"> </span><span class="c">_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-89">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:join</span><span class="p" data-group-id="0548894450-89">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0548894450-88">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-87">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-90">do</span><span class="w">
    </span><span class="c1"># User joined</span><span class="w">
    </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">username</span><span class="w">
    </span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">node_id</span><span class="w">

    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">put_in</span><span class="p" data-group-id="0548894450-91">(</span><span class="n">state</span><span class="o">.</span><span class="n">online_users</span><span class="p" data-group-id="0548894450-92">[</span><span class="n">username</span><span class="p" data-group-id="0548894450-92">]</span><span class="p">,</span><span class="w"> </span><span class="n">node_id</span><span class="p" data-group-id="0548894450-91">)</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="0548894450-93">(</span><span class="s">&quot;</span><span class="si" data-group-id="0548894450-94">#{</span><span class="n">username</span><span class="si" data-group-id="0548894450-94">}</span><span class="s"> joined the room&quot;</span><span class="p" data-group-id="0548894450-93">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="0548894450-95">(</span><span class="s">&quot;*** </span><span class="si" data-group-id="0548894450-96">#{</span><span class="n">username</span><span class="si" data-group-id="0548894450-96">}</span><span class="s"> joined the room&quot;</span><span class="p" data-group-id="0548894450-95">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-97">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-97">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-90">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0548894450-98">(</span><span class="p" data-group-id="0548894450-99">{</span><span class="ss">:event</span><span class="p">,</span><span class="w"> </span><span class="c">_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-100">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:leave</span><span class="p" data-group-id="0548894450-100">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0548894450-99">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-98">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-101">do</span><span class="w">
    </span><span class="c1"># User left</span><span class="w">
    </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">username</span><span class="w">

    </span><span class="p" data-group-id="0548894450-102">{</span><span class="c">_node_id</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-102">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pop_in</span><span class="p" data-group-id="0548894450-103">(</span><span class="n">state</span><span class="o">.</span><span class="n">online_users</span><span class="p" data-group-id="0548894450-104">[</span><span class="n">username</span><span class="p" data-group-id="0548894450-104">]</span><span class="p" data-group-id="0548894450-103">)</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="0548894450-105">(</span><span class="s">&quot;</span><span class="si" data-group-id="0548894450-106">#{</span><span class="n">username</span><span class="si" data-group-id="0548894450-106">}</span><span class="s"> left the room&quot;</span><span class="p" data-group-id="0548894450-105">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="0548894450-107">(</span><span class="s">&quot;*** </span><span class="si" data-group-id="0548894450-108">#{</span><span class="n">username</span><span class="si" data-group-id="0548894450-108">}</span><span class="s"> left the room&quot;</span><span class="p" data-group-id="0548894450-107">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-109">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-109">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-101">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0548894450-110">(</span><span class="p" data-group-id="0548894450-111">{</span><span class="ss">:event</span><span class="p">,</span><span class="w"> </span><span class="c">_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-112">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:heartbeat</span><span class="p" data-group-id="0548894450-112">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="0548894450-111">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-110">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-113">do</span><span class="w">
    </span><span class="c1"># Presence heartbeat</span><span class="w">
    </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">username</span><span class="w">
    </span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">.</span><span class="n">node_id</span><span class="w">

    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">put_in</span><span class="p" data-group-id="0548894450-114">(</span><span class="n">state</span><span class="o">.</span><span class="n">online_users</span><span class="p" data-group-id="0548894450-115">[</span><span class="n">username</span><span class="p" data-group-id="0548894450-115">]</span><span class="p">,</span><span class="w"> </span><span class="n">node_id</span><span class="p" data-group-id="0548894450-114">)</span><span class="w">

    </span><span class="p" data-group-id="0548894450-116">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-116">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-113">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="0548894450-117">(</span><span class="ss">:send_heartbeat</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-117">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-118">do</span><span class="w">
    </span><span class="n">announce_heartbeat</span><span class="p" data-group-id="0548894450-119">(</span><span class="n">state</span><span class="p" data-group-id="0548894450-119">)</span><span class="w">
    </span><span class="n">schedule_heartbeat</span><span class="p" data-group-id="0548894450-120">(</span><span class="p" data-group-id="0548894450-120">)</span><span class="w">
    </span><span class="p" data-group-id="0548894450-121">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="0548894450-121">}</span><span class="w">
  </span><span class="k" data-group-id="0548894450-118">end</span><span class="w">

  </span><span class="c1">## Private Functions</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">announce_join</span><span class="p" data-group-id="0548894450-122">(</span><span class="n">state</span><span class="p" data-group-id="0548894450-122">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-123">do</span><span class="w">
    </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="0548894450-124">(</span><span class="n">state</span><span class="o">.</span><span class="n">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-125">%{</span><span class="w">
      </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:join</span><span class="p">,</span><span class="w">
      </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">username</span><span class="p">,</span><span class="w">
      </span><span class="ss">node_id</span><span class="p">:</span><span class="w"> </span><span class="nc">Macula</span><span class="o">.</span><span class="n">node_id</span><span class="p" data-group-id="0548894450-126">(</span><span class="p" data-group-id="0548894450-126">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="0548894450-127">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="0548894450-127">)</span><span class="w">
    </span><span class="p" data-group-id="0548894450-125">}</span><span class="p" data-group-id="0548894450-124">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-123">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">announce_leave</span><span class="p" data-group-id="0548894450-128">(</span><span class="n">state</span><span class="p" data-group-id="0548894450-128">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-129">do</span><span class="w">
    </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="0548894450-130">(</span><span class="n">state</span><span class="o">.</span><span class="n">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-131">%{</span><span class="w">
      </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:leave</span><span class="p">,</span><span class="w">
      </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">username</span><span class="p">,</span><span class="w">
      </span><span class="ss">node_id</span><span class="p">:</span><span class="w"> </span><span class="nc">Macula</span><span class="o">.</span><span class="n">node_id</span><span class="p" data-group-id="0548894450-132">(</span><span class="p" data-group-id="0548894450-132">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="0548894450-133">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="0548894450-133">)</span><span class="w">
    </span><span class="p" data-group-id="0548894450-131">}</span><span class="p" data-group-id="0548894450-130">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-129">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">announce_heartbeat</span><span class="p" data-group-id="0548894450-134">(</span><span class="n">state</span><span class="p" data-group-id="0548894450-134">)</span><span class="w"> </span><span class="k" data-group-id="0548894450-135">do</span><span class="w">
    </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="0548894450-136">(</span><span class="n">state</span><span class="o">.</span><span class="n">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0548894450-137">%{</span><span class="w">
      </span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:heartbeat</span><span class="p">,</span><span class="w">
      </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">username</span><span class="p">,</span><span class="w">
      </span><span class="ss">node_id</span><span class="p">:</span><span class="w"> </span><span class="nc">Macula</span><span class="o">.</span><span class="n">node_id</span><span class="p" data-group-id="0548894450-138">(</span><span class="p" data-group-id="0548894450-138">)</span><span class="p">,</span><span class="w">
      </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="0548894450-139">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="0548894450-139">)</span><span class="w">
    </span><span class="p" data-group-id="0548894450-137">}</span><span class="p" data-group-id="0548894450-136">)</span><span class="w">
  </span><span class="k" data-group-id="0548894450-135">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">schedule_heartbeat</span><span class="w"> </span><span class="k" data-group-id="0548894450-140">do</span><span class="w">
    </span><span class="nc">Process</span><span class="o">.</span><span class="n">send_after</span><span class="p" data-group-id="0548894450-141">(</span><span class="n">self</span><span class="p" data-group-id="0548894450-142">(</span><span class="p" data-group-id="0548894450-142">)</span><span class="p">,</span><span class="w"> </span><span class="ss">:send_heartbeat</span><span class="p">,</span><span class="w"> </span><span class="mi">30_000</span><span class="p" data-group-id="0548894450-141">)</span><span class="w">  </span><span class="c1"># Every 30 seconds</span><span class="w">
  </span><span class="k" data-group-id="0548894450-140">end</span><span class="w">
</span><span class="k" data-group-id="0548894450-1">end</span></code></pre><h3 id="erlang-implementation" class="section-heading"><a href="#erlang-implementation" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Erlang Implementation</span></h3><p>Create <code class="inline">src/chat_room.erl</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="9943596945-1">(</span><span class="ss">chat_room</span><span class="p" data-group-id="9943596945-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="9943596945-2">(</span><span class="ss">gen_server</span><span class="p" data-group-id="9943596945-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="9943596945-3">(</span><span class="p" data-group-id="9943596945-4">[</span><span class="ss">start_link</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">send_message</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">get_online_users</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">join_room</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="9943596945-4">]</span><span class="p" data-group-id="9943596945-3">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="9943596945-5">(</span><span class="p" data-group-id="9943596945-6">[</span><span class="ss">init</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_call</span><span class="p">/</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_cast</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">handle_info</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="9943596945-6">]</span><span class="p" data-group-id="9943596945-5">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">define</span><span class="p" data-group-id="9943596945-7">(</span><span class="n">TOPIC_PREFIX</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-8">&lt;&lt;</span><span class="s">&quot;io.macula.chat.room&quot;</span><span class="p" data-group-id="9943596945-8">&gt;&gt;</span><span class="p" data-group-id="9943596945-7">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Client API</span><span class="w">

</span><span class="nf">start_link</span><span class="p" data-group-id="9943596945-9">(</span><span class="n">Opts</span><span class="p" data-group-id="9943596945-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="9943596945-10">(</span><span class="p" data-group-id="9943596945-11">{</span><span class="ss">local</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p" data-group-id="9943596945-11">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-12">[</span><span class="p" data-group-id="9943596945-12">]</span><span class="p" data-group-id="9943596945-10">)</span><span class="p">.</span><span class="w">

</span><span class="nf">send_message</span><span class="p" data-group-id="9943596945-13">(</span><span class="n">Message</span><span class="p" data-group-id="9943596945-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">cast</span><span class="p" data-group-id="9943596945-14">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-15">{</span><span class="ss">send_message</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="9943596945-15">}</span><span class="p" data-group-id="9943596945-14">)</span><span class="p">.</span><span class="w">

</span><span class="nf">get_online_users</span><span class="p" data-group-id="9943596945-16">(</span><span class="p" data-group-id="9943596945-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="9943596945-17">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="ss">get_online_users</span><span class="p" data-group-id="9943596945-17">)</span><span class="p">.</span><span class="w">

</span><span class="nf">join_room</span><span class="p" data-group-id="9943596945-18">(</span><span class="n">RoomName</span><span class="p" data-group-id="9943596945-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">gen_server</span><span class="p">:</span><span class="nf">call</span><span class="p" data-group-id="9943596945-19">(</span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-20">{</span><span class="ss">join_room</span><span class="p">,</span><span class="w"> </span><span class="n">RoomName</span><span class="p" data-group-id="9943596945-20">}</span><span class="p" data-group-id="9943596945-19">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Server Callbacks</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="9943596945-21">(</span><span class="n">Opts</span><span class="p" data-group-id="9943596945-21">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="9943596945-22">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-23">&lt;&lt;</span><span class="s">&quot;Anonymous&quot;</span><span class="p" data-group-id="9943596945-23">&gt;&gt;</span><span class="p" data-group-id="9943596945-22">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">proplists</span><span class="p">:</span><span class="nf">get_value</span><span class="p" data-group-id="9943596945-24">(</span><span class="ss">room</span><span class="p">,</span><span class="w"> </span><span class="n">Opts</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-25">&lt;&lt;</span><span class="s">&quot;general&quot;</span><span class="p" data-group-id="9943596945-25">&gt;&gt;</span><span class="p" data-group-id="9943596945-24">)</span><span class="p">,</span><span class="w">

    </span><span class="n">Topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-26">&lt;&lt;</span><span class="o">?</span><span class="n">TOPIC_PREFIX</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Room</span><span class="o">/</span><span class="ss">binary</span><span class="p" data-group-id="9943596945-26">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">PresenceTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-27">&lt;&lt;</span><span class="n">Topic</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.presence&quot;</span><span class="p" data-group-id="9943596945-27">&gt;&gt;</span><span class="p">,</span><span class="w">

    </span><span class="n">State</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-28">#{</span><span class="w">
        </span><span class="ss">username</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Username</span><span class="p">,</span><span class="w">
        </span><span class="ss">room</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Room</span><span class="p">,</span><span class="w">
        </span><span class="ss">topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Topic</span><span class="p">,</span><span class="w">
        </span><span class="ss">presence_topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">PresenceTopic</span><span class="p">,</span><span class="w">
        </span><span class="ss">online_users</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9943596945-29">#{</span><span class="p" data-group-id="9943596945-29">}</span><span class="w">
    </span><span class="p" data-group-id="9943596945-28">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Subscribe to room messages</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="9943596945-30">(</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-31">(</span><span class="p" data-group-id="9943596945-31">)</span><span class="p" data-group-id="9943596945-30">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="9943596945-32">(</span><span class="n">PresenceTopic</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-33">(</span><span class="p" data-group-id="9943596945-33">)</span><span class="p" data-group-id="9943596945-32">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Register RPC endpoint</span><span class="w">
    </span><span class="n">RpcName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-34">&lt;&lt;</span><span class="s">&quot;chat.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Room</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.users&quot;</span><span class="p" data-group-id="9943596945-34">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_rpc</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="9943596945-35">(</span><span class="n">RpcName</span><span class="p">,</span><span class="w"> </span><span class="nf">fun</span><span class="p" data-group-id="9943596945-36">(</span><span class="p">_</span><span class="n">Args</span><span class="p" data-group-id="9943596945-36">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="9943596945-37">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">keys</span><span class="p" data-group-id="9943596945-38">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-39">(</span><span class="ss">online_users</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-39">)</span><span class="p" data-group-id="9943596945-38">)</span><span class="p" data-group-id="9943596945-37">}</span><span class="w">
    </span><span class="k">end</span><span class="p" data-group-id="9943596945-35">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Announce presence</span><span class="w">
    </span><span class="nf">announce_join</span><span class="p" data-group-id="9943596945-40">(</span><span class="n">State</span><span class="p" data-group-id="9943596945-40">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Schedule heartbeat</span><span class="w">
    </span><span class="nf">schedule_heartbeat</span><span class="p" data-group-id="9943596945-41">(</span><span class="p" data-group-id="9943596945-41">)</span><span class="p">,</span><span class="w">

    </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="9943596945-42">(</span><span class="s">&quot;Joined chat room: </span><span class="si">~s</span><span class="s"> as </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-43">[</span><span class="n">Room</span><span class="p">,</span><span class="w"> </span><span class="n">Username</span><span class="p" data-group-id="9943596945-43">]</span><span class="p" data-group-id="9943596945-42">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-44">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-44">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="9943596945-45">(</span><span class="ss">get_online_users</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-45">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Users</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">keys</span><span class="p" data-group-id="9943596945-46">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-47">(</span><span class="ss">online_users</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-47">)</span><span class="p" data-group-id="9943596945-46">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9943596945-48">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-49">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Users</span><span class="p" data-group-id="9943596945-49">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-48">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_call</span><span class="p" data-group-id="9943596945-50">(</span><span class="p" data-group-id="9943596945-51">{</span><span class="ss">join_room</span><span class="p">,</span><span class="w"> </span><span class="n">NewRoom</span><span class="p" data-group-id="9943596945-51">}</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">From</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-50">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Unsubscribe from old room</span><span class="w">
    </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">unsubscribe</span><span class="p" data-group-id="9943596945-52">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-53">(</span><span class="ss">topic</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-53">)</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-54">(</span><span class="p" data-group-id="9943596945-54">)</span><span class="p" data-group-id="9943596945-52">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">unsubscribe</span><span class="p" data-group-id="9943596945-55">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-56">(</span><span class="ss">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-56">)</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-57">(</span><span class="p" data-group-id="9943596945-57">)</span><span class="p" data-group-id="9943596945-55">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Announce leave</span><span class="w">
    </span><span class="nf">announce_leave</span><span class="p" data-group-id="9943596945-58">(</span><span class="n">State</span><span class="p" data-group-id="9943596945-58">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Update state</span><span class="w">
    </span><span class="n">NewTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-59">&lt;&lt;</span><span class="o">?</span><span class="n">TOPIC_PREFIX</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NewRoom</span><span class="o">/</span><span class="ss">binary</span><span class="p" data-group-id="9943596945-59">&gt;&gt;</span><span class="p">,</span><span class="w">
    </span><span class="n">NewPresenceTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-60">&lt;&lt;</span><span class="n">NewTopic</span><span class="o">/</span><span class="ss">binary</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.presence&quot;</span><span class="p" data-group-id="9943596945-60">&gt;&gt;</span><span class="p">,</span><span class="w">

    </span><span class="n">NewState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-61">#{</span><span class="w">
        </span><span class="ss">room</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NewRoom</span><span class="p">,</span><span class="w">
        </span><span class="ss">topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NewTopic</span><span class="p">,</span><span class="w">
        </span><span class="ss">presence_topic</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NewPresenceTopic</span><span class="p">,</span><span class="w">
        </span><span class="ss">online_users</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="9943596945-62">#{</span><span class="p" data-group-id="9943596945-62">}</span><span class="w">
    </span><span class="p" data-group-id="9943596945-61">}</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Subscribe to new room</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="9943596945-63">(</span><span class="n">NewTopic</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-64">(</span><span class="p" data-group-id="9943596945-64">)</span><span class="p" data-group-id="9943596945-63">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="9943596945-65">(</span><span class="n">NewPresenceTopic</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-66">(</span><span class="p" data-group-id="9943596945-66">)</span><span class="p" data-group-id="9943596945-65">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Announce join</span><span class="w">
    </span><span class="nf">announce_join</span><span class="p" data-group-id="9943596945-67">(</span><span class="n">NewState</span><span class="p" data-group-id="9943596945-67">)</span><span class="p">,</span><span class="w">

    </span><span class="nc">logger</span><span class="p">:</span><span class="nf">info</span><span class="p" data-group-id="9943596945-68">(</span><span class="s">&quot;Switched to chat room: </span><span class="si">~s</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-69">[</span><span class="n">NewRoom</span><span class="p" data-group-id="9943596945-69">]</span><span class="p" data-group-id="9943596945-68">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-70">{</span><span class="ss">reply</span><span class="p">,</span><span class="w"> </span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">NewState</span><span class="p" data-group-id="9943596945-70">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_cast</span><span class="p" data-group-id="9943596945-71">(</span><span class="p" data-group-id="9943596945-72">{</span><span class="ss">send_message</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="9943596945-72">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-71">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9943596945-73">#{</span><span class="w">
        </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">message</span><span class="p">,</span><span class="w">
        </span><span class="ss">username</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-74">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-74">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">message</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="9943596945-75">(</span><span class="ss">millisecond</span><span class="p" data-group-id="9943596945-75">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="9943596945-76">(</span><span class="p" data-group-id="9943596945-76">)</span><span class="w">
    </span><span class="p" data-group-id="9943596945-73">}</span><span class="p">,</span><span class="w">

    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="9943596945-77">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-78">(</span><span class="ss">topic</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-78">)</span><span class="p">,</span><span class="w"> </span><span class="n">Payload</span><span class="p" data-group-id="9943596945-77">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-79">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-79">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="9943596945-80">(</span><span class="p" data-group-id="9943596945-81">{</span><span class="ss">event</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-82">#{</span><span class="ss">type</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="ss">message</span><span class="p" data-group-id="9943596945-82">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-81">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-80">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-83">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-83">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-84">(</span><span class="ss">message</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-84">)</span><span class="p">,</span><span class="w">
    </span><span class="n">Timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-85">(</span><span class="ss">timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-85">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Print to console</span><span class="w">
    </span><span class="p" data-group-id="9943596945-86">{</span><span class="p" data-group-id="9943596945-87">{</span><span class="n">Y</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">D</span><span class="p" data-group-id="9943596945-87">}</span><span class="p">,</span><span class="p" data-group-id="9943596945-88">{</span><span class="n">H</span><span class="p">,</span><span class="n">Min</span><span class="p">,</span><span class="n">S</span><span class="p" data-group-id="9943596945-88">}</span><span class="p" data-group-id="9943596945-86">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">calendar</span><span class="p">:</span><span class="nf">system_time_to_universal_time</span><span class="p" data-group-id="9943596945-89">(</span><span class="n">Timestamp</span><span class="p">,</span><span class="w"> </span><span class="ss">millisecond</span><span class="p" data-group-id="9943596945-89">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9943596945-90">(</span><span class="s">&quot;[</span><span class="si">~2..0B</span><span class="s">:</span><span class="si">~2..0B</span><span class="s">:</span><span class="si">~2..0B</span><span class="s">] &lt;</span><span class="si">~s</span><span class="s">&gt; </span><span class="si">~s</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-91">[</span><span class="n">H</span><span class="p">,</span><span class="w"> </span><span class="n">Min</span><span class="p">,</span><span class="w"> </span><span class="n">S</span><span class="p">,</span><span class="w"> </span><span class="n">Username</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="9943596945-91">]</span><span class="p" data-group-id="9943596945-90">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-92">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-92">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="9943596945-93">(</span><span class="p" data-group-id="9943596945-94">{</span><span class="ss">event</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-95">#{</span><span class="ss">type</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="ss">join</span><span class="p" data-group-id="9943596945-95">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-94">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-93">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-96">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-96">)</span><span class="p">,</span><span class="w">
    </span><span class="n">NodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-97">(</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-97">)</span><span class="p">,</span><span class="w">

    </span><span class="n">OnlineUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-98">(</span><span class="ss">online_users</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-98">)</span><span class="p">,</span><span class="w">
    </span><span class="n">NewOnlineUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="9943596945-99">(</span><span class="n">Username</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">OnlineUsers</span><span class="p" data-group-id="9943596945-99">)</span><span class="p">,</span><span class="w">

    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9943596945-100">(</span><span class="s">&quot;*** </span><span class="si">~s</span><span class="s"> joined the room</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-101">[</span><span class="n">Username</span><span class="p" data-group-id="9943596945-101">]</span><span class="p" data-group-id="9943596945-100">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-102">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-103">#{</span><span class="ss">online_users</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NewOnlineUsers</span><span class="p" data-group-id="9943596945-103">}</span><span class="p" data-group-id="9943596945-102">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="9943596945-104">(</span><span class="p" data-group-id="9943596945-105">{</span><span class="ss">event</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-106">#{</span><span class="ss">type</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="ss">leave</span><span class="p" data-group-id="9943596945-106">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-105">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-104">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-107">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-107">)</span><span class="p">,</span><span class="w">

    </span><span class="n">OnlineUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-108">(</span><span class="ss">online_users</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-108">)</span><span class="p">,</span><span class="w">
    </span><span class="n">NewOnlineUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">remove</span><span class="p" data-group-id="9943596945-109">(</span><span class="n">Username</span><span class="p">,</span><span class="w"> </span><span class="n">OnlineUsers</span><span class="p" data-group-id="9943596945-109">)</span><span class="p">,</span><span class="w">

    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="9943596945-110">(</span><span class="s">&quot;*** </span><span class="si">~s</span><span class="s"> left the room</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-111">[</span><span class="n">Username</span><span class="p" data-group-id="9943596945-111">]</span><span class="p" data-group-id="9943596945-110">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-112">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-113">#{</span><span class="ss">online_users</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NewOnlineUsers</span><span class="p" data-group-id="9943596945-113">}</span><span class="p" data-group-id="9943596945-112">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="9943596945-114">(</span><span class="p" data-group-id="9943596945-115">{</span><span class="ss">event</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">Topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-116">#{</span><span class="ss">type</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="ss">heartbeat</span><span class="p" data-group-id="9943596945-116">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-115">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-114">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-117">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-117">)</span><span class="p">,</span><span class="w">
    </span><span class="n">NodeId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-118">(</span><span class="ss">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">Event</span><span class="p" data-group-id="9943596945-118">)</span><span class="p">,</span><span class="w">

    </span><span class="n">OnlineUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-119">(</span><span class="ss">online_users</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-119">)</span><span class="p">,</span><span class="w">
    </span><span class="n">NewOnlineUsers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="9943596945-120">(</span><span class="n">Username</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">OnlineUsers</span><span class="p" data-group-id="9943596945-120">)</span><span class="p">,</span><span class="w">

    </span><span class="p" data-group-id="9943596945-121">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-122">#{</span><span class="ss">online_users</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">NewOnlineUsers</span><span class="p" data-group-id="9943596945-122">}</span><span class="p" data-group-id="9943596945-121">}</span><span class="p">;</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="9943596945-123">(</span><span class="ss">send_heartbeat</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-123">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nf">announce_heartbeat</span><span class="p" data-group-id="9943596945-124">(</span><span class="n">State</span><span class="p" data-group-id="9943596945-124">)</span><span class="p">,</span><span class="w">
    </span><span class="nf">schedule_heartbeat</span><span class="p" data-group-id="9943596945-125">(</span><span class="p" data-group-id="9943596945-125">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="9943596945-126">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-126">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Private Functions</span><span class="w">

</span><span class="nf">announce_join</span><span class="p" data-group-id="9943596945-127">(</span><span class="n">State</span><span class="p" data-group-id="9943596945-127">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="9943596945-128">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-129">(</span><span class="ss">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-129">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-130">#{</span><span class="w">
        </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">join</span><span class="p">,</span><span class="w">
        </span><span class="ss">username</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-131">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-131">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="9943596945-132">(</span><span class="p" data-group-id="9943596945-132">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="9943596945-133">(</span><span class="ss">millisecond</span><span class="p" data-group-id="9943596945-133">)</span><span class="w">
    </span><span class="p" data-group-id="9943596945-130">}</span><span class="p" data-group-id="9943596945-128">)</span><span class="p">.</span><span class="w">

</span><span class="nf">announce_leave</span><span class="p" data-group-id="9943596945-134">(</span><span class="n">State</span><span class="p" data-group-id="9943596945-134">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="9943596945-135">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-136">(</span><span class="ss">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-136">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-137">#{</span><span class="w">
        </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">leave</span><span class="p">,</span><span class="w">
        </span><span class="ss">username</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-138">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-138">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="9943596945-139">(</span><span class="p" data-group-id="9943596945-139">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="9943596945-140">(</span><span class="ss">millisecond</span><span class="p" data-group-id="9943596945-140">)</span><span class="w">
    </span><span class="p" data-group-id="9943596945-137">}</span><span class="p" data-group-id="9943596945-135">)</span><span class="p">.</span><span class="w">

</span><span class="nf">announce_heartbeat</span><span class="p" data-group-id="9943596945-141">(</span><span class="n">State</span><span class="p" data-group-id="9943596945-141">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula_pubsub</span><span class="p">:</span><span class="nf">publish</span><span class="p" data-group-id="9943596945-142">(</span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-143">(</span><span class="ss">presence_topic</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-143">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9943596945-144">#{</span><span class="w">
        </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">heartbeat</span><span class="p">,</span><span class="w">
        </span><span class="ss">username</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="9943596945-145">(</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="9943596945-145">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">node_id</span><span class="p" data-group-id="9943596945-146">(</span><span class="p" data-group-id="9943596945-146">)</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">system_time</span><span class="p" data-group-id="9943596945-147">(</span><span class="ss">millisecond</span><span class="p" data-group-id="9943596945-147">)</span><span class="w">
    </span><span class="p" data-group-id="9943596945-144">}</span><span class="p" data-group-id="9943596945-142">)</span><span class="p">.</span><span class="w">

</span><span class="nf">schedule_heartbeat</span><span class="p" data-group-id="9943596945-148">(</span><span class="p" data-group-id="9943596945-148">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">erlang</span><span class="p">:</span><span class="nf">send_after</span><span class="p" data-group-id="9943596945-149">(</span><span class="mi">30000</span><span class="p">,</span><span class="w"> </span><span class="nf">self</span><span class="p" data-group-id="9943596945-150">(</span><span class="p" data-group-id="9943596945-150">)</span><span class="p">,</span><span class="w"> </span><span class="ss">send_heartbeat</span><span class="p" data-group-id="9943596945-149">)</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="step-5-update-application-supervisor" class="section-heading"><a href="#step-5-update-application-supervisor" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 5: Update Application Supervisor</span></h2><h3 id="elixir" class="section-heading"><a href="#elixir" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Elixir</span></h3><p>Edit <code class="inline">lib/macula_chat/application.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MaculaChat.Application</span><span class="w"> </span><span class="k" data-group-id="6991765106-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">Application</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="p" data-group-id="6991765106-2">(</span><span class="c">_type</span><span class="p">,</span><span class="w"> </span><span class="c">_args</span><span class="p" data-group-id="6991765106-2">)</span><span class="w"> </span><span class="k" data-group-id="6991765106-3">do</span><span class="w">
    </span><span class="c1"># Get config</span><span class="w">
    </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="6991765106-4">(</span><span class="ss">:macula_chat</span><span class="p">,</span><span class="w"> </span><span class="ss">:username</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Anonymous&quot;</span><span class="p" data-group-id="6991765106-4">)</span><span class="w">
    </span><span class="n">room</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p" data-group-id="6991765106-5">(</span><span class="ss">:macula_chat</span><span class="p">,</span><span class="w"> </span><span class="ss">:room</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;general&quot;</span><span class="p" data-group-id="6991765106-5">)</span><span class="w">

    </span><span class="n">children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6991765106-6">[</span><span class="w">
      </span><span class="c1"># Start Macula mesh</span><span class="w">
      </span><span class="p" data-group-id="6991765106-7">{</span><span class="nc">Macula</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6991765106-8">[</span><span class="p" data-group-id="6991765106-8">]</span><span class="p" data-group-id="6991765106-7">}</span><span class="p">,</span><span class="w">

      </span><span class="c1"># Start chat room</span><span class="w">
      </span><span class="p" data-group-id="6991765106-9">{</span><span class="nc">MaculaChat.ChatRoom</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6991765106-10">[</span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="ss">room</span><span class="p">:</span><span class="w"> </span><span class="n">room</span><span class="p" data-group-id="6991765106-10">]</span><span class="p" data-group-id="6991765106-9">}</span><span class="w">
    </span><span class="p" data-group-id="6991765106-6">]</span><span class="w">

    </span><span class="n">opts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="6991765106-11">[</span><span class="ss">strategy</span><span class="p">:</span><span class="w"> </span><span class="ss">:one_for_one</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="nc">MaculaChat.Supervisor</span><span class="p" data-group-id="6991765106-11">]</span><span class="w">
    </span><span class="nc">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="6991765106-12">(</span><span class="n">children</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p" data-group-id="6991765106-12">)</span><span class="w">
  </span><span class="k" data-group-id="6991765106-3">end</span><span class="w">
</span><span class="k" data-group-id="6991765106-1">end</span></code></pre><h3 id="erlang" class="section-heading"><a href="#erlang" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Erlang</span></h3><p>Edit <code class="inline">src/macula_chat_app.erl</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="0380523806-1">(</span><span class="ss">macula_chat_app</span><span class="p" data-group-id="0380523806-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="0380523806-2">(</span><span class="ss">application</span><span class="p" data-group-id="0380523806-2">)</span><span class="p">.</span><span class="w">
</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="0380523806-3">(</span><span class="p" data-group-id="0380523806-4">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">stop</span><span class="p">/</span><span class="mi">1</span><span class="p" data-group-id="0380523806-4">]</span><span class="p" data-group-id="0380523806-3">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="0380523806-5">(</span><span class="p">_</span><span class="n">StartType</span><span class="p">,</span><span class="w"> </span><span class="p">_</span><span class="n">StartArgs</span><span class="p" data-group-id="0380523806-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Get config</span><span class="w">
    </span><span class="p" data-group-id="0380523806-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Username</span><span class="p" data-group-id="0380523806-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="0380523806-7">(</span><span class="ss">macula_chat</span><span class="p">,</span><span class="w"> </span><span class="ss">username</span><span class="p" data-group-id="0380523806-7">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0380523806-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Room</span><span class="p" data-group-id="0380523806-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">application</span><span class="p">:</span><span class="nf">get_env</span><span class="p" data-group-id="0380523806-9">(</span><span class="ss">macula_chat</span><span class="p">,</span><span class="w"> </span><span class="ss">room</span><span class="p" data-group-id="0380523806-9">)</span><span class="p">,</span><span class="w">

    </span><span class="n">Children</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0380523806-10">[</span><span class="w">
        </span><span class="c1">%% Start Macula mesh</span><span class="w">
        </span><span class="p" data-group-id="0380523806-11">#{</span><span class="w">
            </span><span class="ss">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">macula</span><span class="p">,</span><span class="w">
            </span><span class="ss">start</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0380523806-12">{</span><span class="ss">macula</span><span class="p">,</span><span class="w"> </span><span class="ss">start_link</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0380523806-13">[</span><span class="p" data-group-id="0380523806-13">]</span><span class="p" data-group-id="0380523806-12">}</span><span class="p">,</span><span class="w">
            </span><span class="ss">restart</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">permanent</span><span class="p">,</span><span class="w">
            </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">supervisor</span><span class="w">
        </span><span class="p" data-group-id="0380523806-11">}</span><span class="p">,</span><span class="w">

        </span><span class="c1">%% Start chat room</span><span class="w">
        </span><span class="p" data-group-id="0380523806-14">#{</span><span class="w">
            </span><span class="ss">id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">chat_room</span><span class="p">,</span><span class="w">
            </span><span class="ss">start</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0380523806-15">{</span><span class="ss">chat_room</span><span class="p">,</span><span class="w"> </span><span class="ss">start_link</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0380523806-16">[</span><span class="p" data-group-id="0380523806-17">[</span><span class="p" data-group-id="0380523806-18">{</span><span class="ss">username</span><span class="p">,</span><span class="w"> </span><span class="n">Username</span><span class="p" data-group-id="0380523806-18">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0380523806-19">{</span><span class="ss">room</span><span class="p">,</span><span class="w"> </span><span class="n">Room</span><span class="p" data-group-id="0380523806-19">}</span><span class="p" data-group-id="0380523806-17">]</span><span class="p" data-group-id="0380523806-16">]</span><span class="p" data-group-id="0380523806-15">}</span><span class="p">,</span><span class="w">
            </span><span class="ss">restart</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">permanent</span><span class="p">,</span><span class="w">
            </span><span class="ss">type</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">worker</span><span class="w">
        </span><span class="p" data-group-id="0380523806-14">}</span><span class="w">
    </span><span class="p" data-group-id="0380523806-10">]</span><span class="p">,</span><span class="w">

    </span><span class="n">SupFlags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="0380523806-20">#{</span><span class="ss">strategy</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">one_for_one</span><span class="p">,</span><span class="w"> </span><span class="ss">intensity</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">period</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="0380523806-20">}</span><span class="p">,</span><span class="w">

    </span><span class="nc">supervisor</span><span class="p">:</span><span class="nf">start_link</span><span class="p" data-group-id="0380523806-21">(</span><span class="p" data-group-id="0380523806-22">{</span><span class="ss">local</span><span class="p">,</span><span class="w"> </span><span class="ss">macula_chat_sup</span><span class="p" data-group-id="0380523806-22">}</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="n">MODULE</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0380523806-23">{</span><span class="n">SupFlags</span><span class="p">,</span><span class="w"> </span><span class="n">Children</span><span class="p" data-group-id="0380523806-23">}</span><span class="p" data-group-id="0380523806-21">)</span><span class="p">.</span><span class="w">

</span><span class="nf">stop</span><span class="p" data-group-id="0380523806-24">(</span><span class="p">_</span><span class="n">State</span><span class="p" data-group-id="0380523806-24">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="step-6-create-interactive-client" class="section-heading"><a href="#step-6-create-interactive-client" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 6: Create Interactive Client</span></h2><h3 id="elixir-1" class="section-heading"><a href="#elixir-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Elixir</span></h3><p>Create <code class="inline">lib/chat_client.ex</code>:</p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MaculaChat.Client</span><span class="w"> </span><span class="k" data-group-id="1411280231-1">do</span><span class="w">
  </span><span class="na">@moduledoc</span><span class="w"> </span><span class="s">&quot;&quot;&quot;
  Interactive chat client - run from IEx
  &quot;&quot;&quot;</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Send a message to the chat room&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">say</span><span class="p" data-group-id="1411280231-2">(</span><span class="n">message</span><span class="p" data-group-id="1411280231-2">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1411280231-3">(</span><span class="n">message</span><span class="p" data-group-id="1411280231-3">)</span><span class="w"> </span><span class="k" data-group-id="1411280231-4">do</span><span class="w">
    </span><span class="nc">MaculaChat.ChatRoom</span><span class="o">.</span><span class="n">send_message</span><span class="p" data-group-id="1411280231-5">(</span><span class="n">message</span><span class="p" data-group-id="1411280231-5">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="1411280231-4">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;List who&#39;s online&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">who</span><span class="w"> </span><span class="k" data-group-id="1411280231-6">do</span><span class="w">
    </span><span class="p" data-group-id="1411280231-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p" data-group-id="1411280231-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MaculaChat.ChatRoom</span><span class="o">.</span><span class="n">get_online_users</span><span class="p" data-group-id="1411280231-8">(</span><span class="p" data-group-id="1411280231-8">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1411280231-9">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Online users (</span><span class="si" data-group-id="1411280231-10">#{</span><span class="n">length</span><span class="p" data-group-id="1411280231-11">(</span><span class="n">users</span><span class="p" data-group-id="1411280231-11">)</span><span class="si" data-group-id="1411280231-10">}</span><span class="s">):&quot;</span><span class="p" data-group-id="1411280231-9">)</span><span class="w">
    </span><span class="nc">Enum</span><span class="o">.</span><span class="n">each</span><span class="p" data-group-id="1411280231-12">(</span><span class="n">users</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="1411280231-13">fn</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1411280231-14">(</span><span class="s">&quot;  - </span><span class="si" data-group-id="1411280231-15">#{</span><span class="n">user</span><span class="si" data-group-id="1411280231-15">}</span><span class="s">&quot;</span><span class="p" data-group-id="1411280231-14">)</span><span class="w">
    </span><span class="k" data-group-id="1411280231-13">end</span><span class="p" data-group-id="1411280231-12">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="1411280231-6">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Switch to different room&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">join</span><span class="p" data-group-id="1411280231-16">(</span><span class="n">room_name</span><span class="p" data-group-id="1411280231-16">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_binary</span><span class="p" data-group-id="1411280231-17">(</span><span class="n">room_name</span><span class="p" data-group-id="1411280231-17">)</span><span class="w"> </span><span class="k" data-group-id="1411280231-18">do</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">MaculaChat.ChatRoom</span><span class="o">.</span><span class="n">join_room</span><span class="p" data-group-id="1411280231-19">(</span><span class="n">room_name</span><span class="p" data-group-id="1411280231-19">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1411280231-20">(</span><span class="s">&quot;Joined room: </span><span class="si" data-group-id="1411280231-21">#{</span><span class="n">room_name</span><span class="si" data-group-id="1411280231-21">}</span><span class="s">&quot;</span><span class="p" data-group-id="1411280231-20">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="1411280231-18">end</span><span class="w">

  </span><span class="na">@doc</span><span class="w"> </span><span class="s">&quot;Show help&quot;</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">help</span><span class="w"> </span><span class="k" data-group-id="1411280231-22">do</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="1411280231-23">(</span><span class="s">&quot;&quot;&quot;

    Macula Chat Client Commands:
    =============================

    Chat.say(&quot;message&quot;)     - Send a message
    Chat.who()              - List online users
    Chat.join(&quot;room&quot;)       - Switch to different room
    Chat.help()             - Show this help

    Examples:
      Chat.say(&quot;Hello world!&quot;)
      Chat.who()
      Chat.join(&quot;random&quot;)

    &quot;&quot;&quot;</span><span class="p" data-group-id="1411280231-23">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w">
  </span><span class="k" data-group-id="1411280231-22">end</span><span class="w">
</span><span class="k" data-group-id="1411280231-1">end</span><span class="w">

</span><span class="c1"># Alias for convenience</span><span class="w">
</span><span class="kn">alias</span><span class="w"> </span><span class="nc">MaculaChat.Client</span><span class="p">,</span><span class="w"> </span><span class="ss">as</span><span class="p">:</span><span class="w"> </span><span class="nc">Chat</span></code></pre><h3 id="erlang-1" class="section-heading"><a href="#erlang-1" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Erlang</span></h3><p>Create <code class="inline">src/chat_client.erl</code>:</p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="1799457206-1">(</span><span class="ss">chat_client</span><span class="p" data-group-id="1799457206-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1799457206-2">(</span><span class="p" data-group-id="1799457206-3">[</span><span class="ss">say</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">who</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">join</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">help</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="1799457206-3">]</span><span class="p" data-group-id="1799457206-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">say</span><span class="p" data-group-id="1799457206-4">(</span><span class="n">Message</span><span class="p" data-group-id="1799457206-4">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_binary</span><span class="p" data-group-id="1799457206-5">(</span><span class="n">Message</span><span class="p" data-group-id="1799457206-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">chat_room</span><span class="p">:</span><span class="nf">send_message</span><span class="p" data-group-id="1799457206-6">(</span><span class="n">Message</span><span class="p" data-group-id="1799457206-6">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="nf">who</span><span class="p" data-group-id="1799457206-7">(</span><span class="p" data-group-id="1799457206-7">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1799457206-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Users</span><span class="p" data-group-id="1799457206-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">chat_room</span><span class="p">:</span><span class="nf">get_online_users</span><span class="p" data-group-id="1799457206-9">(</span><span class="p" data-group-id="1799457206-9">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="1799457206-10">(</span><span class="s">&quot;</span><span class="si">~n</span><span class="s">Online users (</span><span class="si">~p</span><span class="s">):</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1799457206-11">[</span><span class="nf">length</span><span class="p" data-group-id="1799457206-12">(</span><span class="n">Users</span><span class="p" data-group-id="1799457206-12">)</span><span class="p" data-group-id="1799457206-11">]</span><span class="p" data-group-id="1799457206-10">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="1799457206-13">(</span><span class="nf">fun</span><span class="p" data-group-id="1799457206-14">(</span><span class="n">User</span><span class="p" data-group-id="1799457206-14">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
        </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="1799457206-15">(</span><span class="s">&quot;  - </span><span class="si">~s</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1799457206-16">[</span><span class="n">User</span><span class="p" data-group-id="1799457206-16">]</span><span class="p" data-group-id="1799457206-15">)</span><span class="w">
    </span><span class="k">end</span><span class="p">,</span><span class="w"> </span><span class="n">Users</span><span class="p" data-group-id="1799457206-13">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="nf">join</span><span class="p" data-group-id="1799457206-17">(</span><span class="n">RoomName</span><span class="p" data-group-id="1799457206-17">)</span><span class="w"> </span><span class="k">when</span><span class="w"> </span><span class="nf">is_binary</span><span class="p" data-group-id="1799457206-18">(</span><span class="n">RoomName</span><span class="p" data-group-id="1799457206-18">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">chat_room</span><span class="p">:</span><span class="nf">join_room</span><span class="p" data-group-id="1799457206-19">(</span><span class="n">RoomName</span><span class="p" data-group-id="1799457206-19">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="1799457206-20">(</span><span class="s">&quot;Joined room: </span><span class="si">~s</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1799457206-21">[</span><span class="n">RoomName</span><span class="p" data-group-id="1799457206-21">]</span><span class="p" data-group-id="1799457206-20">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="nf">help</span><span class="p" data-group-id="1799457206-22">(</span><span class="p" data-group-id="1799457206-22">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="1799457206-23">(</span><span class="s">&quot;</span><span class="si">~n</span><span class="si">~s</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1799457206-24">[</span><span class="w">
        </span><span class="s">&quot;Macula Chat Client Commands:\n&quot;</span><span class="w">
        </span><span class="s">&quot;=============================\n&quot;</span><span class="w">
        </span><span class="s">&quot;\n&quot;</span><span class="w">
        </span><span class="s">&quot;chat_client:say(&lt;&lt;\&quot;message\&quot;&gt;&gt;)     - Send a message\n&quot;</span><span class="w">
        </span><span class="s">&quot;chat_client:who()                   - List online users\n&quot;</span><span class="w">
        </span><span class="s">&quot;chat_client:join(&lt;&lt;\&quot;room\&quot;&gt;&gt;)        - Switch to different room\n&quot;</span><span class="w">
        </span><span class="s">&quot;chat_client:help()                  - Show this help\n&quot;</span><span class="w">
        </span><span class="s">&quot;\n&quot;</span><span class="w">
        </span><span class="s">&quot;Examples:\n&quot;</span><span class="w">
        </span><span class="s">&quot;  chat_client:say(&lt;&lt;\&quot;Hello world!\&quot;&gt;&gt;).\n&quot;</span><span class="w">
        </span><span class="s">&quot;  chat_client:who().\n&quot;</span><span class="w">
        </span><span class="s">&quot;  chat_client:join(&lt;&lt;\&quot;random\&quot;&gt;&gt;).\n&quot;</span><span class="w">
    </span><span class="p" data-group-id="1799457206-24">]</span><span class="p" data-group-id="1799457206-23">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="p">.</span></code></pre><hr class="thin"/><h2 id="step-7-run-the-chat-application" class="section-heading"><a href="#step-7-run-the-chat-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 7: Run the Chat Application</span></h2><h3 id="terminal-1-user-alice" class="section-heading"><a href="#terminal-1-user-alice" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Terminal 1: User &quot;Alice&quot;</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Elixir
</span><span class="">CHAT_USER=Alice CHAT_ROOM=general MACULA_PORT=4433 iex -S mix
</span><span class="">
</span><span class=""># Erlang
</span><span class="">CHAT_USER=Alice CHAT_ROOM=general MACULA_PORT=4433 rebar3 shell
</span><span class="">
</span><span class=""># You should see:
</span><span class="">[info] Macula node started
</span><span class="">[info] Joined chat room: general as Alice
</span></code></pre><h3 id="terminal-2-user-bob" class="section-heading"><a href="#terminal-2-user-bob" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Terminal 2: User &quot;Bob&quot;</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Elixir
</span><span class="">CHAT_USER=Bob CHAT_ROOM=general MACULA_PORT=4434 iex -S mix
</span><span class="">
</span><span class=""># Erlang
</span><span class="">CHAT_USER=Bob CHAT_ROOM=general MACULA_PORT=4434 rebar3 shell
</span><span class="">
</span><span class=""># Both terminals show:
</span><span class="">*** Bob joined the room
</span></code></pre><h3 id="terminal-3-user-charlie" class="section-heading"><a href="#terminal-3-user-charlie" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Terminal 3: User &quot;Charlie&quot;</span></h3><pre><code class="makeup bash" translate="no"><span class=""># Elixir
</span><span class="">CHAT_USER=Charlie CHAT_ROOM=general MACULA_PORT=4435 iex -S mix
</span><span class="">
</span><span class=""># Erlang
</span><span class="">CHAT_USER=Charlie CHAT_ROOM=general MACULA_PORT=4435 rebar3 shell
</span><span class="">
</span><span class=""># All terminals show:
</span><span class="">*** Charlie joined the room
</span></code></pre><hr class="thin"/><h2 id="step-8-chat" class="section-heading"><a href="#step-8-chat" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 8: Chat!</span></h2><h3 id="send-messages" class="section-heading"><a href="#send-messages" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Send Messages</span></h3><p><strong>In Alice's terminal (Elixir)</strong>:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Chat</span><span class="o">.</span><span class="n">say</span><span class="p" data-group-id="6286287072-1">(</span><span class="s">&quot;Hello everyone!&quot;</span><span class="p" data-group-id="6286287072-1">)</span></code></pre><p><strong>In Bob's terminal (Erlang)</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="nc">chat_client</span><span class="p">:</span><span class="nf">say</span><span class="p" data-group-id="4795773341-1">(</span><span class="p" data-group-id="4795773341-2">&lt;&lt;</span><span class="s">&quot;Hey Alice!&quot;</span><span class="p" data-group-id="4795773341-2">&gt;&gt;</span><span class="p" data-group-id="4795773341-1">)</span><span class="p">.</span></code></pre><p><strong>In Charlie's terminal</strong>:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Chat</span><span class="o">.</span><span class="n">say</span><span class="p" data-group-id="3280621046-1">(</span><span class="s">&quot;What&#39;s up?&quot;</span><span class="p" data-group-id="3280621046-1">)</span></code></pre><p><strong>All terminals show</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="p" data-group-id="2153802673-1">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">56</span><span class="p" data-group-id="2153802673-1">]</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Alice</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Hello</span><span class="w"> </span><span class="ss">everyone</span><span class="o">!</span><span class="w">
</span><span class="p" data-group-id="2153802673-2">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">58</span><span class="p" data-group-id="2153802673-2">]</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Bob</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Hey</span><span class="w"> </span><span class="n">Alice</span><span class="o">!</span><span class="w">
</span><span class="p" data-group-id="2153802673-3">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">35</span><span class="p">:</span><span class="mi">01</span><span class="p" data-group-id="2153802673-3">]</span><span class="w"> </span><span class="o">&lt;</span><span class="n">Charlie</span><span class="o">&gt;</span><span class="w"> </span><span class="n">What</span><span class="err">&#39;</span><span class="ss">s</span><span class="w"> </span><span class="ss">up</span><span class="o">?</span></code></pre><h3 id="list-online-users" class="section-heading"><a href="#list-online-users" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">List Online Users</span></h3><p><strong>In any terminal (Elixir)</strong>:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Chat</span><span class="o">.</span><span class="n">who</span><span class="p" data-group-id="0417684668-1">(</span><span class="p" data-group-id="0417684668-1">)</span></code></pre><p><strong>Output</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Online</span><span class="w"> </span><span class="nf">users</span><span class="w"> </span><span class="p" data-group-id="7118044387-1">(</span><span class="mi">3</span><span class="p" data-group-id="7118044387-1">)</span><span class="p">:</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Alice</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Bob</span><span class="w">
  </span><span class="o">-</span><span class="w"> </span><span class="n">Charlie</span></code></pre><h3 id="switch-rooms" class="section-heading"><a href="#switch-rooms" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Switch Rooms</span></h3><p><strong>In Charlie's terminal</strong>:</p><pre><code class="makeup elixir" translate="no"><span class="nc">Chat</span><span class="o">.</span><span class="n">join</span><span class="p" data-group-id="7618795605-1">(</span><span class="s">&quot;random&quot;</span><span class="p" data-group-id="7618795605-1">)</span></code></pre><p><strong>Alice and Bob's terminals show</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="o">*</span><span class="o">*</span><span class="o">*</span><span class="w"> </span><span class="n">Charlie</span><span class="w"> </span><span class="ss">left</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">room</span></code></pre><p><strong>Charlie's terminal shows</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="n">Joined</span><span class="w"> </span><span class="nc">room</span><span class="p">:</span><span class="w"> </span><span class="ss">random</span></code></pre><p>Now Charlie is in a different room and won't see messages in &quot;general&quot;.</p><hr class="thin"/><h2 id="step-9-test-fault-tolerance" class="section-heading"><a href="#step-9-test-fault-tolerance" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Step 9: Test Fault Tolerance</span></h2><h3 id="stop-bob-s-node" class="section-heading"><a href="#stop-bob-s-node" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Stop Bob's Node</span></h3><p>In Bob's terminal, press <code class="inline">Ctrl+C</code> twice.</p><p><strong>Alice and Charlie's terminals show</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="o">*</span><span class="o">*</span><span class="o">*</span><span class="w"> </span><span class="n">Bob</span><span class="w"> </span><span class="ss">left</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">room</span></code></pre><h3 id="restart-bob" class="section-heading"><a href="#restart-bob" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Restart Bob</span></h3><p>Restart Bob's node (same command as before).</p><p><strong>All terminals show</strong>:</p><pre><code class="makeup erlang" translate="no"><span class="o">*</span><span class="o">*</span><span class="o">*</span><span class="w"> </span><span class="n">Bob</span><span class="w"> </span><span class="ss">joined</span><span class="w"> </span><span class="ss">the</span><span class="w"> </span><span class="ss">room</span></code></pre><p><strong>Messages continue flowing</strong> - the mesh automatically reconnected Bob.</p><hr class="thin"/><h2 id="understanding-the-architecture" class="section-heading"><a href="#understanding-the-architecture" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Understanding the Architecture</span></h2><h3 id="message-flow-pub-sub" class="section-heading"><a href="#message-flow-pub-sub" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Message Flow (Pub/Sub)</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Alice</span><span class="ss">&#39;s Node                   Macula Mesh                   Bob&#39;</span><span class="ss">s</span><span class="w"> </span><span class="n">Node</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Chat</span><span class="p">.</span><span class="nf">say</span><span class="p" data-group-id="8081905407-1">(</span><span class="p" data-group-id="8081905407-1">)</span><span class="w">   </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="ss">publish</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">→</span><span class="w"> </span><span class="err">│</span><span class="w">   </span><span class="n">Topic</span><span class="p">:</span><span class="w">    </span><span class="err">│</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="ss">route</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">→</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="ss">handle_info</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="ss">io</span><span class="p">.</span><span class="ss">macula</span><span class="p">.</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="p" data-group-id="8081905407-2">{</span><span class="p">:</span><span class="ss">event</span><span class="p">,</span><span class="p">.</span><span class="p">.</span><span class="p">.</span><span class="p" data-group-id="8081905407-2">}</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="ss">chat</span><span class="p">.</span><span class="ss">room</span><span class="p">.</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="ss">general</span><span class="w">     </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="n">IO</span><span class="p">.</span><span class="nf">puts</span><span class="p" data-group-id="8081905407-3">(</span><span class="p" data-group-id="8081905407-3">)</span><span class="w">    </span><span class="err">│</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><p><strong>How it works</strong>:</p><ol><li>Alice calls <code class="inline">Chat.say(&quot;hello&quot;)</code></li><li>ChatRoom GenServer calls <code class="inline">Macula.PubSub.publish(topic, %{message: &quot;hello&quot;})</code></li><li>Macula encodes the message and sends it via QUIC to subscribers</li><li>Bob's ChatRoom GenServer receives <code class="inline">{:event, topic, payload}</code></li><li>Bob's node prints the message to console</li></ol><p><strong>No central server</strong> - messages route peer-to-peer through the mesh!</p><h3 id="rpc-flow-who-s-online" class="section-heading"><a href="#rpc-flow-who-s-online" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">RPC Flow (Who's Online)</span></h3><pre><code class="makeup erlang" translate="no"><span class="n">Alice</span><span class="ss">&#39;s Node                   Macula Mesh                   Bob&#39;</span><span class="ss">s</span><span class="w"> </span><span class="n">Node</span><span class="w">
</span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">              </span><span class="err">┌</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┐</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Chat</span><span class="p">.</span><span class="nf">who</span><span class="p" data-group-id="0316898419-1">(</span><span class="p" data-group-id="0316898419-1">)</span><span class="w">   </span><span class="err">│</span><span class="err">─</span><span class="err">─</span><span class="n">RPC</span><span class="w"> </span><span class="ss">call</span><span class="err">─</span><span class="err">─</span><span class="err">→</span><span class="w"> </span><span class="err">│</span><span class="w">   </span><span class="n">Routing</span><span class="w">   </span><span class="err">│</span><span class="w"> </span><span class="err">─</span><span class="err">─</span><span class="ss">lookup</span><span class="err">─</span><span class="err">─</span><span class="err">→</span><span class="w"> </span><span class="err">│</span><span class="w"> </span><span class="n">RPC</span><span class="w"> </span><span class="n">Handler</span><span class="w">  </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">   </span><span class="n">Table</span><span class="w">     </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w"> </span><span class="err">←</span><span class="err">─</span><span class="err">─</span><span class="ss">result</span><span class="err">─</span><span class="err">─</span><span class="w">  </span><span class="err">│</span><span class="w">   </span><span class="p" data-group-id="0316898419-2">(</span><span class="n">DHT</span><span class="p" data-group-id="0316898419-2">)</span><span class="w">     </span><span class="err">│</span><span class="w"> </span><span class="err">←</span><span class="err">─</span><span class="ss">return</span><span class="err">─</span><span class="err">─</span><span class="w">  </span><span class="err">│</span><span class="w"> </span><span class="ss">return</span><span class="w"> </span><span class="ss">users</span><span class="w"> </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">             </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">              </span><span class="err">│</span><span class="w">
</span><span class="err">│</span><span class="w"> </span><span class="n">Print</span><span class="w"> </span><span class="ss">users</span><span class="w">  </span><span class="err">│</span><span class="w">              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">              </span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span><span class="w">
</span><span class="err">└</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">─</span><span class="err">┘</span></code></pre><p><strong>How it works</strong>:</p><ol><li>Alice calls <code class="inline">Chat.who()</code></li><li>ChatRoom calls <code class="inline">Macula.RPC.call(&quot;chat.general.users&quot;, %{})</code></li><li>Macula looks up which node registered &quot;chat.general.users&quot; (could be any node)</li><li>Macula routes RPC request to that node</li><li>RPC handler executes and returns list of users</li><li>Result routes back to Alice</li><li>Alice prints the list</li></ol><p><strong>Distributed RPC</strong> - any node can register an endpoint, any node can call it!</p><hr class="thin"/><h2 id="enhancements" class="section-heading"><a href="#enhancements" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Enhancements</span></h2><p>Try adding these features:</p><h3 id="1-private-messages-dms" class="section-heading"><a href="#1-private-messages-dms" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">1. Private Messages (DMs)</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># In chat_room.ex</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">send_dm</span><span class="p" data-group-id="9354788336-1">(</span><span class="n">to_username</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="9354788336-1">)</span><span class="w"> </span><span class="k" data-group-id="9354788336-2">do</span><span class="w">
  </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p" data-group-id="9354788336-3">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9354788336-4">{</span><span class="ss">:send_dm</span><span class="p">,</span><span class="w"> </span><span class="n">to_username</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="9354788336-4">}</span><span class="p" data-group-id="9354788336-3">)</span><span class="w">
</span><span class="k" data-group-id="9354788336-2">end</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_cast</span><span class="p" data-group-id="9354788336-5">(</span><span class="p" data-group-id="9354788336-6">{</span><span class="ss">:send_dm</span><span class="p">,</span><span class="w"> </span><span class="n">to_username</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="9354788336-6">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9354788336-5">)</span><span class="w"> </span><span class="k" data-group-id="9354788336-7">do</span><span class="w">
  </span><span class="c1"># Find target user&#39;s node via presence</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="9354788336-8">(</span><span class="n">state</span><span class="o">.</span><span class="n">online_users</span><span class="p">,</span><span class="w"> </span><span class="n">to_username</span><span class="p" data-group-id="9354788336-8">)</span><span class="w"> </span><span class="k" data-group-id="9354788336-9">do</span><span class="w">
    </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="9354788336-10">(</span><span class="s">&quot;User </span><span class="si" data-group-id="9354788336-11">#{</span><span class="n">to_username</span><span class="si" data-group-id="9354788336-11">}</span><span class="s"> not found&quot;</span><span class="p" data-group-id="9354788336-10">)</span><span class="w">

    </span><span class="n">node_id</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="c1"># Send directly to that node</span><span class="w">
      </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;io.macula.chat.dm.</span><span class="si" data-group-id="9354788336-12">#{</span><span class="n">node_id</span><span class="si" data-group-id="9354788336-12">}</span><span class="s">&quot;</span><span class="w">
      </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="9354788336-13">%{</span><span class="w">
        </span><span class="ss">from</span><span class="p">:</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">username</span><span class="p">,</span><span class="w">
        </span><span class="ss">to</span><span class="p">:</span><span class="w"> </span><span class="n">to_username</span><span class="p">,</span><span class="w">
        </span><span class="ss">message</span><span class="p">:</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w">
        </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="9354788336-14">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="9354788336-14">)</span><span class="w">
      </span><span class="p" data-group-id="9354788336-13">}</span><span class="w">

      </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="9354788336-15">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">payload</span><span class="p" data-group-id="9354788336-15">)</span><span class="w">
  </span><span class="k" data-group-id="9354788336-9">end</span><span class="w">

  </span><span class="p" data-group-id="9354788336-16">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9354788336-16">}</span><span class="w">
</span><span class="k" data-group-id="9354788336-7">end</span></code></pre><h3 id="2-message-history-last-10-messages" class="section-heading"><a href="#2-message-history-last-10-messages" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">2. Message History (Last 10 Messages)</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># In chat_room.ex</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="8421695404-1">(</span><span class="n">opts</span><span class="p" data-group-id="8421695404-1">)</span><span class="w"> </span><span class="k" data-group-id="8421695404-2">do</span><span class="w">
  </span><span class="c1"># ... existing code ...</span><span class="w">

  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="8421695404-3">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="ss">:message_history</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8421695404-4">[</span><span class="p" data-group-id="8421695404-4">]</span><span class="p" data-group-id="8421695404-3">)</span><span class="w">

  </span><span class="c1"># ... rest of init ...</span><span class="w">
</span><span class="k" data-group-id="8421695404-2">end</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="8421695404-5">(</span><span class="p" data-group-id="8421695404-6">{</span><span class="ss">:event</span><span class="p">,</span><span class="w"> </span><span class="c">_topic</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8421695404-7">%{</span><span class="ss">type</span><span class="p">:</span><span class="w"> </span><span class="ss">:message</span><span class="p" data-group-id="8421695404-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="p" data-group-id="8421695404-6">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8421695404-5">)</span><span class="w"> </span><span class="k" data-group-id="8421695404-8">do</span><span class="w">
  </span><span class="c1"># ... existing code to print message ...</span><span class="w">

  </span><span class="c1"># Store in history</span><span class="w">
  </span><span class="n">history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="8421695404-9">[</span><span class="n">event</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">message_history</span><span class="p" data-group-id="8421695404-9">]</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">take</span><span class="p" data-group-id="8421695404-10">(</span><span class="mi">10</span><span class="p" data-group-id="8421695404-10">)</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="8421695404-11">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="ss">:message_history</span><span class="p">,</span><span class="w"> </span><span class="n">history</span><span class="p" data-group-id="8421695404-11">)</span><span class="w">

  </span><span class="p" data-group-id="8421695404-12">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8421695404-12">}</span><span class="w">
</span><span class="k" data-group-id="8421695404-8">end</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">get_history</span><span class="w"> </span><span class="k" data-group-id="8421695404-13">do</span><span class="w">
  </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="8421695404-14">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="ss">:get_history</span><span class="p" data-group-id="8421695404-14">)</span><span class="w">
</span><span class="k" data-group-id="8421695404-13">end</span><span class="w">

</span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="8421695404-15">(</span><span class="ss">:get_history</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8421695404-15">)</span><span class="w"> </span><span class="k" data-group-id="8421695404-16">do</span><span class="w">
  </span><span class="p" data-group-id="8421695404-17">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8421695404-18">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reverse</span><span class="p" data-group-id="8421695404-19">(</span><span class="n">state</span><span class="o">.</span><span class="n">message_history</span><span class="p" data-group-id="8421695404-19">)</span><span class="p" data-group-id="8421695404-18">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8421695404-17">}</span><span class="w">
</span><span class="k" data-group-id="8421695404-16">end</span></code></pre><h3 id="3-typing-indicator" class="section-heading"><a href="#3-typing-indicator" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">3. Typing Indicator</span></h3><pre><code class="makeup elixir" translate="no"><span class="c1"># In chat_client.ex</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">typing</span><span class="w"> </span><span class="k" data-group-id="0472605528-1">do</span><span class="w">
  </span><span class="c1"># Publish ephemeral &quot;typing&quot; event</span><span class="w">
  </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="0472605528-2">(</span><span class="s">&quot;io.macula.chat.room.general.typing&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0472605528-3">%{</span><span class="w">
    </span><span class="ss">username</span><span class="p">:</span><span class="w"> </span><span class="nc">MaculaChat.ChatRoom</span><span class="o">.</span><span class="n">get_username</span><span class="p" data-group-id="0472605528-4">(</span><span class="p" data-group-id="0472605528-4">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">timestamp</span><span class="p">:</span><span class="w"> </span><span class="nc">System</span><span class="o">.</span><span class="n">system_time</span><span class="p" data-group-id="0472605528-5">(</span><span class="ss">:millisecond</span><span class="p" data-group-id="0472605528-5">)</span><span class="w">
  </span><span class="p" data-group-id="0472605528-3">}</span><span class="p" data-group-id="0472605528-2">)</span><span class="w">
</span><span class="k" data-group-id="0472605528-1">end</span></code></pre><h3 id="4-file-sharing" class="section-heading"><a href="#4-file-sharing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">4. File Sharing</span></h3><p>Use RPC to request file chunks:</p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">share_file</span><span class="p" data-group-id="9404389193-1">(</span><span class="n">filename</span><span class="p" data-group-id="9404389193-1">)</span><span class="w"> </span><span class="k" data-group-id="9404389193-2">do</span><span class="w">
  </span><span class="c1"># Read file and encode as base64</span><span class="w">
  </span><span class="n">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">File</span><span class="o">.</span><span class="n">read!</span><span class="p" data-group-id="9404389193-3">(</span><span class="n">filename</span><span class="p" data-group-id="9404389193-3">)</span><span class="w"> </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Base</span><span class="o">.</span><span class="n">encode64</span><span class="p" data-group-id="9404389193-4">(</span><span class="p" data-group-id="9404389193-4">)</span><span class="w">

  </span><span class="c1"># Announce file availability</span><span class="w">
  </span><span class="nc">Macula.PubSub</span><span class="o">.</span><span class="n">publish</span><span class="p" data-group-id="9404389193-5">(</span><span class="s">&quot;io.macula.chat.room.general.file&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9404389193-6">%{</span><span class="w">
    </span><span class="ss">filename</span><span class="p">:</span><span class="w"> </span><span class="nc">Path</span><span class="o">.</span><span class="n">basename</span><span class="p" data-group-id="9404389193-7">(</span><span class="n">filename</span><span class="p" data-group-id="9404389193-7">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">size</span><span class="p">:</span><span class="w"> </span><span class="n">byte_size</span><span class="p" data-group-id="9404389193-8">(</span><span class="n">content</span><span class="p" data-group-id="9404389193-8">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">owner</span><span class="p">:</span><span class="w"> </span><span class="nc">Macula</span><span class="o">.</span><span class="n">node_id</span><span class="p" data-group-id="9404389193-9">(</span><span class="p" data-group-id="9404389193-9">)</span><span class="w">
  </span><span class="p" data-group-id="9404389193-6">}</span><span class="p" data-group-id="9404389193-5">)</span><span class="w">

  </span><span class="c1"># Register RPC endpoint to serve chunks</span><span class="w">
  </span><span class="nc">Macula.RPC</span><span class="o">.</span><span class="n">register</span><span class="p" data-group-id="9404389193-10">(</span><span class="s">&quot;chat.file.</span><span class="si" data-group-id="9404389193-11">#{</span><span class="n">filename</span><span class="si" data-group-id="9404389193-11">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="9404389193-12">fn</span><span class="w"> </span><span class="p" data-group-id="9404389193-13">%{</span><span class="ss">offset</span><span class="p">:</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="ss">length</span><span class="p">:</span><span class="w"> </span><span class="n">length</span><span class="p" data-group-id="9404389193-13">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="n">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">binary_part</span><span class="p" data-group-id="9404389193-14">(</span><span class="n">content</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p" data-group-id="9404389193-14">)</span><span class="w">
    </span><span class="p" data-group-id="9404389193-15">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9404389193-16">%{</span><span class="ss">chunk</span><span class="p">:</span><span class="w"> </span><span class="n">chunk</span><span class="p" data-group-id="9404389193-16">}</span><span class="p" data-group-id="9404389193-15">}</span><span class="w">
  </span><span class="k" data-group-id="9404389193-12">end</span><span class="p" data-group-id="9404389193-10">)</span><span class="w">
</span><span class="k" data-group-id="9404389193-2">end</span></code></pre><hr class="thin"/><h2 id="what-you-ve-learned" class="section-heading"><a href="#what-you-ve-learned" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">What You've Learned</span></h2><p>Congratulations! You've built a fully distributed chat application using Macula. You now understand:</p><p>✅ <strong>Pub/Sub</strong>: How to publish events and subscribe to topics across the mesh
✅ <strong>RPC</strong>: How to register callable endpoints and invoke them from any node
✅ <strong>Mesh Topology</strong>: How nodes discover each other and form a network
✅ <strong>Fault Tolerance</strong>: How the mesh adapts when nodes join/leave
✅ <strong>Presence</strong>: How to track who's online using heartbeats
✅ <strong>BEAM OTP</strong>: How to structure applications with GenServers and supervisors</p><hr class="thin"/><h2 id="next-steps" class="section-heading"><a href="#next-steps" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Next Steps</span></h2><ul><li><strong><a href="rpc_guide.html">RPC Guide</a></strong> - Complete RPC documentation</li><li><strong><a href="pubsub_guide.html">PubSub Guide</a></strong> - Pub/Sub patterns</li><li><strong><a href="development.html">Development Guide</a></strong> - Contributing to Macula</li><li><strong><a href="glossary.html">Glossary</a></strong> - Terminology reference</li><li><strong>Build something cool!</strong> Share it with the community</li></ul><hr class="thin"/><p><strong>Happy coding!</strong></p>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="quick_start.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          ← Previous Page
        </span>
        <span class="title">
Quick Start
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="development.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page →
        </span>
        <span class="title">
Development Guide
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.12.4" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.12.4">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.12.4/show/docs/user/HELLO_WORLD.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
