<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.38.2">
    <meta name="project" content="macula v0.12.6">


    <title>NAT Traversal â€” macula v0.12.6</title>

    <link rel="stylesheet" href="dist/html-erlang-DQDXQC7W.css" />

    <script defer src="dist/sidebar_items-969EFB48.js"></script>
    <script defer src="docs_config.js"></script>
    <script defer src="dist/html-DPJLHKSM.js"></script>

  </head>
  <body>
    <script>(()=>{var t="ex_doc:settings",e="dark";var o="dark",s="light";var E="sidebar_state",n="closed";var r="sidebar_width";var a="sidebar-open";var i=new URLSearchParams(window.location.search),S=i.get("theme")||JSON.parse(localStorage.getItem(t)||"{}").theme;(S===o||S!==s&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.body.classList.add(e);var d=sessionStorage.getItem(E),A=d!==n&&!window.matchMedia(`screen and (max-width: ${768}px)`).matches;document.body.classList.toggle(a,A);var c=sessionStorage.getItem(r);c&&document.body.style.setProperty("--sidebarWidth",`${c}px`);var p=/(Macintosh|iPhone|iPad|iPod)/.test(window.navigator.userAgent);document.documentElement.classList.toggle("apple-os",p);})();
</script>

<div class="body-wrapper">

<button id="sidebar-menu" class="sidebar-button sidebar-toggle" aria-label="toggle sidebar" aria-controls="sidebar">
  <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
</button>

<nav id="sidebar" class="sidebar">

  <div class="sidebar-header">
    <div class="sidebar-projectInfo">

        <a href="overview.html" class="sidebar-projectImage">
          <img src="assets/logo.svg" alt="macula" />
        </a>

      <div>
        <a href="overview.html" class="sidebar-projectName" translate="no">
macula
        </a>
        <div class="sidebar-projectVersion" translate="no">
          v0.12.6
        </div>
      </div>
    </div>
    <ul id="sidebar-list-nav" class="sidebar-list-nav" role="tablist" data-extras=""></ul>
  </div>
</nav>

<output role="status" id="toast"></output>

<main class="content page-extra" id="main" data-type="extras">
  <div id="content" class="content-inner">
    <div class="top-search">
      <div class="search-settings">
        <form class="search-bar" action="search.html">
          <label class="search-label">
            <span class="sr-only">Search documentation of macula</span>
            <input name="q" type="text" class="search-input" placeholder="Press / to search" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
          </label>
          <button type="submit" class="search-button" aria-label="Submit Search" tabindex="-1">
            <i class="ri-search-2-line ri-lg" aria-hidden="true"></i>
          </button>
          <button type="button" tabindex="-1" class="search-close-button" aria-hidden="true">
            <i class="ri-close-line ri-lg" title="Cancel search"></i>
          </button>
        </form>
        <div class="autocomplete">
        </div>
        <button class="icon-settings display-settings">
          <i class="ri-settings-3-line"></i>
          <span class="sr-only">Settings</span>
        </button>
      </div>
    </div>

<div id="top-content">
  <div class="heading-with-actions top-heading">
    <h1>NAT Traversal Developer Guide</h1>


      <a href="https://github.com/macula-io/macula/blob/0.12.6/docs/guides/NAT_TRAVERSAL_DEVELOPER_GUIDE.md#L1" title="View Source" class="icon-action" rel="help">
        <i class="ri-code-s-slash-line" aria-hidden="true"></i>
        <span class="sr-only">View Source</span>
      </a>

  </div>


<p>This guide covers the Macula NAT traversal system API, code examples in both Erlang and Elixir, and integration patterns.</p><hr class="thin"/><h2 id="overview" class="section-heading"><a href="#overview" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Overview</span></h2><p>The NAT traversal system consists of these modules:</p><table><thead><tr><th style="text-align: left;">Module</th><th style="text-align: left;">Purpose</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">macula_nat_system</code></td><td style="text-align: left;">Supervisor for NAT subsystem</td></tr><tr><td style="text-align: left;"><code class="inline">macula_nat_detector</code></td><td style="text-align: left;">Detects local NAT type</td></tr><tr><td style="text-align: left;"><code class="inline">macula_nat_cache</code></td><td style="text-align: left;">Caches NAT profiles with TTL</td></tr><tr><td style="text-align: left;"><code class="inline">macula_nat_coordinator</code></td><td style="text-align: left;">Coordinates hole punching</td></tr><tr><td style="text-align: left;"><code class="inline">macula_nat_connector</code></td><td style="text-align: left;">Intelligent connection establishment</td></tr><tr><td style="text-align: left;"><code class="inline">macula_relay_registry</code></td><td style="text-align: left;">Distributed relay node registry</td></tr><tr><td style="text-align: left;"><code class="inline">macula_relay_node</code></td><td style="text-align: left;">Relay server functionality</td></tr></tbody></table><hr class="thin"/><h2 id="quick-start" class="section-heading"><a href="#quick-start" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Quick Start</span></h2><h3 id="detecting-your-nat-type" class="section-heading"><a href="#detecting-your-nat-type" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Detecting Your NAT Type</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Detect NAT type (async, returns cached if available)</span><span class="w">
</span><span class="p" data-group-id="3232238623-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="3232238623-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">detect</span><span class="p" data-group-id="3232238623-2">(</span><span class="p" data-group-id="3232238623-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Force fresh detection (bypasses cache)</span><span class="w">
</span><span class="p" data-group-id="3232238623-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="3232238623-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">detect</span><span class="p" data-group-id="3232238623-4">(</span><span class="p" data-group-id="3232238623-5">#{</span><span class="ss">force</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p" data-group-id="3232238623-5">}</span><span class="p" data-group-id="3232238623-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Get cached local profile (fast, no network)</span><span class="w">
</span><span class="p" data-group-id="3232238623-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="3232238623-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">get_local_profile</span><span class="p" data-group-id="3232238623-7">(</span><span class="p" data-group-id="3232238623-7">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Detect NAT type (async, returns cached if available)</span><span class="w">
</span><span class="p" data-group-id="4932625519-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="4932625519-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">detect</span><span class="p" data-group-id="4932625519-2">(</span><span class="p" data-group-id="4932625519-2">)</span><span class="w">

</span><span class="c1"># Force fresh detection (bypasses cache)</span><span class="w">
</span><span class="p" data-group-id="4932625519-3">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="4932625519-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">detect</span><span class="p" data-group-id="4932625519-4">(</span><span class="p" data-group-id="4932625519-5">%{</span><span class="ss">force</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p" data-group-id="4932625519-5">}</span><span class="p" data-group-id="4932625519-4">)</span><span class="w">

</span><span class="c1"># Get cached local profile (fast, no network)</span><span class="w">
</span><span class="p" data-group-id="4932625519-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="4932625519-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">get_local_profile</span><span class="p" data-group-id="4932625519-7">(</span><span class="p" data-group-id="4932625519-7">)</span></code></pre><h3 id="connecting-to-a-peer" class="section-heading"><a href="#connecting-to-a-peer" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connecting to a Peer</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Connect using optimal strategy (automatic)</span><span class="w">
</span><span class="p" data-group-id="3138518544-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Connection</span><span class="p" data-group-id="3138518544-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="3138518544-2">(</span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3138518544-3">#{</span><span class="w">
    </span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">          </span><span class="c1">% 10 second timeout</span><span class="w">
    </span><span class="ss">prefer_direct</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">      </span><span class="c1">% Try direct before relay</span><span class="w">
</span><span class="p" data-group-id="3138518544-3">}</span><span class="p" data-group-id="3138518544-2">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% The connector automatically:</span><span class="w">
</span><span class="c1">%% 1. Fetches target&#39;s NAT profile from DHT</span><span class="w">
</span><span class="c1">%% 2. Determines best connection strategy</span><span class="w">
</span><span class="c1">%% 3. Attempts hole punching if feasible</span><span class="w">
</span><span class="c1">%% 4. Falls back to relay if needed</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Connect using optimal strategy (automatic)</span><span class="w">
</span><span class="p" data-group-id="5356666497-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">connection</span><span class="p" data-group-id="5356666497-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="5356666497-2">(</span><span class="n">target_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5356666497-3">%{</span><span class="w">
  </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">10_000</span><span class="p">,</span><span class="w">           </span><span class="c1"># 10 second timeout</span><span class="w">
  </span><span class="ss">prefer_direct</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">        </span><span class="c1"># Try direct before relay</span><span class="w">
</span><span class="p" data-group-id="5356666497-3">}</span><span class="p" data-group-id="5356666497-2">)</span><span class="w">

</span><span class="c1"># The connector automatically:</span><span class="w">
</span><span class="c1"># 1. Fetches target&#39;s NAT profile from DHT</span><span class="w">
</span><span class="c1"># 2. Determines best connection strategy</span><span class="w">
</span><span class="c1"># 3. Attempts hole punching if feasible</span><span class="w">
</span><span class="c1"># 4. Falls back to relay if needed</span></code></pre><hr class="thin"/><h2 id="nat-detection-api" class="section-heading"><a href="#nat-detection-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">NAT Detection API</span></h2><h3 id="macula_nat_detector" class="section-heading"><a href="#macula_nat_detector" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_nat_detector</span></h3><h4>detect/0, detect/1</h4><p>Detect local NAT characteristics.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">detect</span><span class="p" data-group-id="3408186541-1">(</span><span class="p" data-group-id="3408186541-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3408186541-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="3408186541-3">(</span><span class="p" data-group-id="3408186541-3">)</span><span class="p" data-group-id="3408186541-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3408186541-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3408186541-5">(</span><span class="p" data-group-id="3408186541-5">)</span><span class="p" data-group-id="3408186541-4">}</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">detect</span><span class="p" data-group-id="3408186541-6">(</span><span class="nf">map</span><span class="p" data-group-id="3408186541-7">(</span><span class="p" data-group-id="3408186541-7">)</span><span class="p" data-group-id="3408186541-6">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="3408186541-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="3408186541-9">(</span><span class="p" data-group-id="3408186541-9">)</span><span class="p" data-group-id="3408186541-8">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="3408186541-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="3408186541-11">(</span><span class="p" data-group-id="3408186541-11">)</span><span class="p" data-group-id="3408186541-10">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Options:</span><span class="w">
</span><span class="c1">%%   force =&gt; boolean()     - Bypass cache, force fresh detection</span><span class="w">
</span><span class="c1">%%   timeout =&gt; integer()   - Detection timeout in ms (default 5000)</span><span class="w">
</span><span class="c1">%%   observers =&gt; [endpoint()] - Custom observer endpoints</span><span class="w">

</span><span class="c1">%% Example</span><span class="w">
</span><span class="p" data-group-id="3408186541-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3408186541-13">#{</span><span class="w">
    </span><span class="ss">mapping</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">ei</span><span class="p">,</span><span class="w">           </span><span class="c1">% ei | hd | pd</span><span class="w">
    </span><span class="ss">filtering</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">pd</span><span class="p">,</span><span class="w">         </span><span class="c1">% ei | hd | pd</span><span class="w">
    </span><span class="ss">allocation</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">pp</span><span class="p">,</span><span class="w">        </span><span class="c1">% pp | pc | rd</span><span class="w">
    </span><span class="ss">public_ip</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="3408186541-14">{</span><span class="mi">203</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">113</span><span class="p">,</span><span class="mi">5</span><span class="p" data-group-id="3408186541-14">}</span><span class="p">,</span><span class="w">
    </span><span class="ss">public_port</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">4433</span><span class="p">,</span><span class="w">
    </span><span class="ss">detected_at</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1700000000</span><span class="p">,</span><span class="w">
    </span><span class="ss">confidence</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">high</span><span class="w">       </span><span class="c1">% high | medium | low</span><span class="w">
</span><span class="p" data-group-id="3408186541-13">}</span><span class="p" data-group-id="3408186541-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">detect</span><span class="p" data-group-id="3408186541-15">(</span><span class="p" data-group-id="3408186541-15">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Options:</span><span class="w">
</span><span class="c1">#   force: boolean()     - Bypass cache, force fresh detection</span><span class="w">
</span><span class="c1">#   timeout: integer()   - Detection timeout in ms (default 5000)</span><span class="w">
</span><span class="c1">#   observers: [endpoint()] - Custom observer endpoints</span><span class="w">

</span><span class="c1"># Example</span><span class="w">
</span><span class="p" data-group-id="5431050414-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5431050414-2">%{</span><span class="w">
  </span><span class="ss">mapping</span><span class="p">:</span><span class="w"> </span><span class="ss">:ei</span><span class="p">,</span><span class="w">           </span><span class="c1"># :ei | :hd | :pd</span><span class="w">
  </span><span class="ss">filtering</span><span class="p">:</span><span class="w"> </span><span class="ss">:pd</span><span class="p">,</span><span class="w">         </span><span class="c1"># :ei | :hd | :pd</span><span class="w">
  </span><span class="ss">allocation</span><span class="p">:</span><span class="w"> </span><span class="ss">:pp</span><span class="p">,</span><span class="w">        </span><span class="c1"># :pp | :pc | :rd</span><span class="w">
  </span><span class="ss">public_ip</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="5431050414-3">{</span><span class="mi">203</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">113</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p" data-group-id="5431050414-3">}</span><span class="p">,</span><span class="w">
  </span><span class="ss">public_port</span><span class="p">:</span><span class="w"> </span><span class="mi">4433</span><span class="p">,</span><span class="w">
  </span><span class="ss">detected_at</span><span class="p">:</span><span class="w"> </span><span class="mi">1_700_000_000</span><span class="p">,</span><span class="w">
  </span><span class="ss">confidence</span><span class="p">:</span><span class="w"> </span><span class="ss">:high</span><span class="w">       </span><span class="c1"># :high | :medium | :low</span><span class="w">
</span><span class="p" data-group-id="5431050414-2">}</span><span class="p" data-group-id="5431050414-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">detect</span><span class="p" data-group-id="5431050414-4">(</span><span class="p" data-group-id="5431050414-4">)</span></code></pre><h4>get_local_profile/0</h4><p>Get cached local NAT profile (no network call).</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">get_local_profile</span><span class="p" data-group-id="0789545167-1">(</span><span class="p" data-group-id="0789545167-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0789545167-2">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="0789545167-3">(</span><span class="p" data-group-id="0789545167-3">)</span><span class="p" data-group-id="0789545167-2">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="0789545167-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_detected</span><span class="p" data-group-id="0789545167-4">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Returns immediately with cached profile</span><span class="w">
</span><span class="p" data-group-id="0789545167-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="0789545167-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">get_local_profile</span><span class="p" data-group-id="0789545167-6">(</span><span class="p" data-group-id="0789545167-6">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Returns immediately with cached profile</span><span class="w">
</span><span class="p" data-group-id="1054414544-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="1054414544-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">get_local_profile</span><span class="p" data-group-id="1054414544-2">(</span><span class="p" data-group-id="1054414544-2">)</span></code></pre><h4>add_observation/2</h4><p>Add external observation for detection refinement.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">add_observation</span><span class="p" data-group-id="5142470979-1">(</span><span class="nc">inet</span><span class="p">:</span><span class="nf">ip_address</span><span class="p" data-group-id="5142470979-2">(</span><span class="p" data-group-id="5142470979-2">)</span><span class="p">,</span><span class="w"> </span><span class="nc">inet</span><span class="p">:</span><span class="nf">port_number</span><span class="p" data-group-id="5142470979-3">(</span><span class="p" data-group-id="5142470979-3">)</span><span class="p" data-group-id="5142470979-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Called when receiving reflexive address from external peer</span><span class="w">
</span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">add_observation</span><span class="p" data-group-id="5142470979-4">(</span><span class="p" data-group-id="5142470979-5">{</span><span class="mi">198</span><span class="p">,</span><span class="mi">51</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p" data-group-id="5142470979-5">}</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="5142470979-4">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Called when receiving reflexive address from external peer</span><span class="w">
</span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">add_observation</span><span class="p" data-group-id="9897790228-1">(</span><span class="p" data-group-id="9897790228-2">{</span><span class="mi">198</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="9897790228-2">}</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p" data-group-id="9897790228-1">)</span></code></pre><h4>refresh/0</h4><p>Trigger background NAT profile refresh.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">refresh</span><span class="p" data-group-id="2544934294-1">(</span><span class="p" data-group-id="2544934294-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Useful after network change (IP change, reconnect)</span><span class="w">
</span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">refresh</span><span class="p" data-group-id="2544934294-2">(</span><span class="p" data-group-id="2544934294-2">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Useful after network change (IP change, reconnect)</span><span class="w">
</span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">refresh</span><span class="p" data-group-id="0499159539-1">(</span><span class="p" data-group-id="0499159539-1">)</span></code></pre><hr class="thin"/><h2 id="nat-cache-api" class="section-heading"><a href="#nat-cache-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">NAT Cache API</span></h2><h3 id="macula_nat_cache" class="section-heading"><a href="#macula_nat_cache" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_nat_cache</span></h3><p>Caches NAT profiles with TTL and stale-while-revalidate semantics.</p><h4>get/1</h4><p>Get cached NAT profile for a node.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">get</span><span class="p" data-group-id="7872003290-1">(</span><span class="nf">binary</span><span class="p" data-group-id="7872003290-2">(</span><span class="p" data-group-id="7872003290-2">)</span><span class="p" data-group-id="7872003290-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="7872003290-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="7872003290-4">(</span><span class="p" data-group-id="7872003290-4">)</span><span class="p" data-group-id="7872003290-3">}</span><span class="w"> </span><span class="p">|</span><span class="w">
                       </span><span class="p" data-group-id="7872003290-5">{</span><span class="ss">stale</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="7872003290-6">(</span><span class="p" data-group-id="7872003290-6">)</span><span class="p" data-group-id="7872003290-5">}</span><span class="w"> </span><span class="p">|</span><span class="w">
                       </span><span class="p" data-group-id="7872003290-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_found</span><span class="p" data-group-id="7872003290-7">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Fresh cache hit</span><span class="w">
</span><span class="p" data-group-id="7872003290-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="7872003290-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7872003290-9">(</span><span class="n">NodeId</span><span class="p" data-group-id="7872003290-9">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Stale but usable (background refresh triggered)</span><span class="w">
</span><span class="p" data-group-id="7872003290-10">{</span><span class="ss">stale</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="7872003290-10">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7872003290-11">(</span><span class="n">NodeId</span><span class="p" data-group-id="7872003290-11">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Not in cache</span><span class="w">
</span><span class="p" data-group-id="7872003290-12">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">not_found</span><span class="p" data-group-id="7872003290-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="7872003290-13">(</span><span class="n">UnknownNodeId</span><span class="p" data-group-id="7872003290-13">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Fresh cache hit</span><span class="w">
</span><span class="p" data-group-id="4147505585-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="4147505585-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="4147505585-2">(</span><span class="n">node_id</span><span class="p" data-group-id="4147505585-2">)</span><span class="w">

</span><span class="c1"># Stale but usable (background refresh triggered)</span><span class="w">
</span><span class="p" data-group-id="4147505585-3">{</span><span class="ss">:stale</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="4147505585-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="4147505585-4">(</span><span class="n">node_id</span><span class="p" data-group-id="4147505585-4">)</span><span class="w">

</span><span class="c1"># Not in cache</span><span class="w">
</span><span class="p" data-group-id="4147505585-5">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:not_found</span><span class="p" data-group-id="4147505585-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="4147505585-6">(</span><span class="n">unknown_node_id</span><span class="p" data-group-id="4147505585-6">)</span></code></pre><h4>get_from_dht/1</h4><p>Fetch NAT profile from DHT (with caching).</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">get_from_dht</span><span class="p" data-group-id="9271461061-1">(</span><span class="nf">binary</span><span class="p" data-group-id="9271461061-2">(</span><span class="p" data-group-id="9271461061-2">)</span><span class="p" data-group-id="9271461061-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="9271461061-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="9271461061-4">(</span><span class="p" data-group-id="9271461061-4">)</span><span class="p" data-group-id="9271461061-3">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="9271461061-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="9271461061-6">(</span><span class="p" data-group-id="9271461061-6">)</span><span class="p" data-group-id="9271461061-5">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Fetches from DHT if not in local cache</span><span class="w">
</span><span class="p" data-group-id="9271461061-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="9271461061-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">get_from_dht</span><span class="p" data-group-id="9271461061-8">(</span><span class="n">NodeId</span><span class="p" data-group-id="9271461061-8">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Fetches from DHT if not in local cache</span><span class="w">
</span><span class="p" data-group-id="3279003452-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="3279003452-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">get_from_dht</span><span class="p" data-group-id="3279003452-2">(</span><span class="n">node_id</span><span class="p" data-group-id="3279003452-2">)</span></code></pre><h4>put/2, put/3</h4><p>Store NAT profile in cache.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">put</span><span class="p" data-group-id="0146445965-1">(</span><span class="nf">binary</span><span class="p" data-group-id="0146445965-2">(</span><span class="p" data-group-id="0146445965-2">)</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="0146445965-3">(</span><span class="p" data-group-id="0146445965-3">)</span><span class="p" data-group-id="0146445965-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">put</span><span class="p" data-group-id="0146445965-4">(</span><span class="nf">binary</span><span class="p" data-group-id="0146445965-5">(</span><span class="p" data-group-id="0146445965-5">)</span><span class="p">,</span><span class="w"> </span><span class="nf">nat_profile</span><span class="p" data-group-id="0146445965-6">(</span><span class="p" data-group-id="0146445965-6">)</span><span class="p">,</span><span class="w"> </span><span class="nf">pos_integer</span><span class="p" data-group-id="0146445965-7">(</span><span class="p" data-group-id="0146445965-7">)</span><span class="p" data-group-id="0146445965-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Store with default TTL (300 seconds)</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="0146445965-8">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="0146445965-8">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Store with custom TTL</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">put</span><span class="p" data-group-id="0146445965-9">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p">,</span><span class="w"> </span><span class="mi">600</span><span class="p" data-group-id="0146445965-9">)</span><span class="p">.</span><span class="w">  </span><span class="c1">% 10 minutes</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Store with default TTL (300 seconds)</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="8130585341-1">(</span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="8130585341-1">)</span><span class="w">

</span><span class="c1"># Store with custom TTL</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="8130585341-2">(</span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="mi">600</span><span class="p" data-group-id="8130585341-2">)</span><span class="w">  </span><span class="c1"># 10 minutes</span></code></pre><h4>invalidate/1</h4><p>Remove profile from cache.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">invalidate</span><span class="p" data-group-id="7405427385-1">(</span><span class="nf">binary</span><span class="p" data-group-id="7405427385-2">(</span><span class="p" data-group-id="7405427385-2">)</span><span class="p" data-group-id="7405427385-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Force re-fetch on next access</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">invalidate</span><span class="p" data-group-id="7405427385-3">(</span><span class="n">NodeId</span><span class="p" data-group-id="7405427385-3">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Force re-fetch on next access</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">invalidate</span><span class="p" data-group-id="1765313211-1">(</span><span class="n">node_id</span><span class="p" data-group-id="1765313211-1">)</span></code></pre><h4>stats/0</h4><p>Get cache statistics.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">stats</span><span class="p" data-group-id="0173064839-1">(</span><span class="p" data-group-id="0173064839-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="0173064839-2">(</span><span class="p" data-group-id="0173064839-2">)</span><span class="p">.</span><span class="w">

</span><span class="p" data-group-id="0173064839-3">#{</span><span class="w">
    </span><span class="nb">size</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w">
    </span><span class="ss">hits</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
    </span><span class="ss">misses</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
    </span><span class="ss">stale_hits</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
    </span><span class="ss">evictions</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span><span class="p" data-group-id="0173064839-3">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">stats</span><span class="p" data-group-id="0173064839-4">(</span><span class="p" data-group-id="0173064839-4">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="5213696854-1">%{</span><span class="w">
  </span><span class="ss">size</span><span class="p">:</span><span class="w"> </span><span class="mi">150</span><span class="p">,</span><span class="w">
  </span><span class="ss">hits</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span><span class="w">
  </span><span class="ss">misses</span><span class="p">:</span><span class="w"> </span><span class="mi">50</span><span class="p">,</span><span class="w">
  </span><span class="ss">stale_hits</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
  </span><span class="ss">evictions</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span><span class="p" data-group-id="5213696854-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">stats</span><span class="p" data-group-id="5213696854-2">(</span><span class="p" data-group-id="5213696854-2">)</span></code></pre><hr class="thin"/><h2 id="connection-coordination-api" class="section-heading"><a href="#connection-coordination-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Connection Coordination API</span></h2><h3 id="macula_nat_coordinator" class="section-heading"><a href="#macula_nat_coordinator" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_nat_coordinator</span></h3><p>Coordinates hole punching between peers.</p><h4>request_connection/2, request_connection/3</h4><p>Request connection to a target peer.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">request_connection</span><span class="p" data-group-id="4888741344-1">(</span><span class="nf">binary</span><span class="p" data-group-id="4888741344-2">(</span><span class="p" data-group-id="4888741344-2">)</span><span class="p">,</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="4888741344-3">(</span><span class="p" data-group-id="4888741344-3">)</span><span class="p" data-group-id="4888741344-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="4888741344-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">direct</span><span class="p">,</span><span class="w"> </span><span class="n">Connection</span><span class="p" data-group-id="4888741344-4">}</span><span class="w"> </span><span class="p">|</span><span class="w">
    </span><span class="p" data-group-id="4888741344-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">punched</span><span class="p">,</span><span class="w"> </span><span class="n">Connection</span><span class="p" data-group-id="4888741344-5">}</span><span class="w"> </span><span class="p">|</span><span class="w">
    </span><span class="p" data-group-id="4888741344-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="ss">relayed</span><span class="p">,</span><span class="w"> </span><span class="n">Connection</span><span class="p" data-group-id="4888741344-6">}</span><span class="w"> </span><span class="p">|</span><span class="w">
    </span><span class="p" data-group-id="4888741344-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="4888741344-8">(</span><span class="p" data-group-id="4888741344-8">)</span><span class="p" data-group-id="4888741344-7">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Simple request</span><span class="w">
</span><span class="p" data-group-id="4888741344-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="4888741344-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_coordinator</span><span class="p">:</span><span class="nf">request_connection</span><span class="p" data-group-id="4888741344-10">(</span><span class="w">
    </span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4888741344-11">#{</span><span class="p" data-group-id="4888741344-11">}</span><span class="w">
</span><span class="p" data-group-id="4888741344-10">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% With options</span><span class="w">
</span><span class="p" data-group-id="4888741344-12">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="4888741344-12">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_coordinator</span><span class="p">:</span><span class="nf">request_connection</span><span class="p" data-group-id="4888741344-13">(</span><span class="w">
    </span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="4888741344-14">#{</span><span class="w">
        </span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">15000</span><span class="p">,</span><span class="w">
        </span><span class="ss">max_punch_attempts</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
        </span><span class="ss">allow_relay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
    </span><span class="p" data-group-id="4888741344-14">}</span><span class="w">
</span><span class="p" data-group-id="4888741344-13">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Method indicates how connection was established:</span><span class="w">
</span><span class="c1">%%   direct  - Direct connection (target has public IP or Full Cone NAT)</span><span class="w">
</span><span class="c1">%%   punched - Hole punching succeeded</span><span class="w">
</span><span class="c1">%%   relayed - Using relay node</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Simple request</span><span class="w">
</span><span class="p" data-group-id="2277115180-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="2277115180-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_coordinator</span><span class="o">.</span><span class="n">request_connection</span><span class="p" data-group-id="2277115180-2">(</span><span class="w">
  </span><span class="n">target_node_id</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2277115180-3">%{</span><span class="p" data-group-id="2277115180-3">}</span><span class="w">
</span><span class="p" data-group-id="2277115180-2">)</span><span class="w">

</span><span class="c1"># With options</span><span class="w">
</span><span class="p" data-group-id="2277115180-4">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="2277115180-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_coordinator</span><span class="o">.</span><span class="n">request_connection</span><span class="p" data-group-id="2277115180-5">(</span><span class="w">
  </span><span class="n">target_node_id</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="2277115180-6">%{</span><span class="w">
    </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">15_000</span><span class="p">,</span><span class="w">
    </span><span class="ss">max_punch_attempts</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="ss">allow_relay</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="p" data-group-id="2277115180-6">}</span><span class="w">
</span><span class="p" data-group-id="2277115180-5">)</span><span class="w">

</span><span class="c1"># Method indicates how connection was established:</span><span class="w">
</span><span class="c1">#   :direct  - Direct connection (target has public IP or Full Cone NAT)</span><span class="w">
</span><span class="c1">#   :punched - Hole punching succeeded</span><span class="w">
</span><span class="c1">#   :relayed - Using relay node</span></code></pre><h4>coordinate_punch/3</h4><p>Low-level hole punch coordination (usually internal).</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">coordinate_punch</span><span class="p" data-group-id="0836767668-1">(</span><span class="nf">binary</span><span class="p" data-group-id="0836767668-2">(</span><span class="p" data-group-id="0836767668-2">)</span><span class="p">,</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="0836767668-3">(</span><span class="p" data-group-id="0836767668-3">)</span><span class="p">,</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="0836767668-4">(</span><span class="p" data-group-id="0836767668-4">)</span><span class="p" data-group-id="0836767668-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="0836767668-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">reference</span><span class="p" data-group-id="0836767668-6">(</span><span class="p" data-group-id="0836767668-6">)</span><span class="p" data-group-id="0836767668-5">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="0836767668-7">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="0836767668-8">(</span><span class="p" data-group-id="0836767668-8">)</span><span class="p" data-group-id="0836767668-7">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Returns reference for tracking punch attempt</span><span class="w">
</span><span class="p" data-group-id="0836767668-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Ref</span><span class="p" data-group-id="0836767668-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_coordinator</span><span class="p">:</span><span class="nf">coordinate_punch</span><span class="p" data-group-id="0836767668-10">(</span><span class="w">
    </span><span class="n">PeerA_NodeId</span><span class="p">,</span><span class="w">
    </span><span class="n">PeerB_NodeId</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="0836767668-11">#{</span><span class="ss">predicted_ports</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p" data-group-id="0836767668-12">{</span><span class="n">PeerA_Port</span><span class="p">,</span><span class="w"> </span><span class="n">PeerB_Port</span><span class="p" data-group-id="0836767668-12">}</span><span class="p" data-group-id="0836767668-11">}</span><span class="w">
</span><span class="p" data-group-id="0836767668-10">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Returns reference for tracking punch attempt</span><span class="w">
</span><span class="p" data-group-id="0814753975-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">ref</span><span class="p" data-group-id="0814753975-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_coordinator</span><span class="o">.</span><span class="n">coordinate_punch</span><span class="p" data-group-id="0814753975-2">(</span><span class="w">
  </span><span class="n">peer_a_node_id</span><span class="p">,</span><span class="w">
  </span><span class="n">peer_b_node_id</span><span class="p">,</span><span class="w">
  </span><span class="p" data-group-id="0814753975-3">%{</span><span class="ss">predicted_ports</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="0814753975-4">{</span><span class="n">peer_a_port</span><span class="p">,</span><span class="w"> </span><span class="n">peer_b_port</span><span class="p" data-group-id="0814753975-4">}</span><span class="p" data-group-id="0814753975-3">}</span><span class="w">
</span><span class="p" data-group-id="0814753975-2">)</span></code></pre><h3 id="macula_nat_connector" class="section-heading"><a href="#macula_nat_connector" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_nat_connector</span></h3><p>High-level connection establishment with automatic strategy selection.</p><h4>connect/2, connect/3</h4><p>Establish connection to peer using optimal strategy.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">connect</span><span class="p" data-group-id="4594111200-1">(</span><span class="nf">binary</span><span class="p" data-group-id="4594111200-2">(</span><span class="p" data-group-id="4594111200-2">)</span><span class="p">,</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="4594111200-3">(</span><span class="p" data-group-id="4594111200-3">)</span><span class="p" data-group-id="4594111200-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="4594111200-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">connection</span><span class="p" data-group-id="4594111200-5">(</span><span class="p" data-group-id="4594111200-5">)</span><span class="p" data-group-id="4594111200-4">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="4594111200-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="4594111200-7">(</span><span class="p" data-group-id="4594111200-7">)</span><span class="p" data-group-id="4594111200-6">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Connect with defaults</span><span class="w">
</span><span class="p" data-group-id="4594111200-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="4594111200-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="4594111200-9">(</span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4594111200-10">#{</span><span class="p" data-group-id="4594111200-10">}</span><span class="p" data-group-id="4594111200-9">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Connect with options</span><span class="w">
</span><span class="p" data-group-id="4594111200-11">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="4594111200-11">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="4594111200-12">(</span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4594111200-13">#{</span><span class="w">
    </span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">20000</span><span class="p">,</span><span class="w">
    </span><span class="ss">prefer_direct</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p">,</span><span class="w">
    </span><span class="ss">fallback_relay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="p">,</span><span class="w">
    </span><span class="ss">max_attempts</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="p" data-group-id="4594111200-13">}</span><span class="p" data-group-id="4594111200-12">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Connect with defaults</span><span class="w">
</span><span class="p" data-group-id="5381133667-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="5381133667-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="5381133667-2">(</span><span class="n">target_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5381133667-3">%{</span><span class="p" data-group-id="5381133667-3">}</span><span class="p" data-group-id="5381133667-2">)</span><span class="w">

</span><span class="c1"># Connect with options</span><span class="w">
</span><span class="p" data-group-id="5381133667-4">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="5381133667-4">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="5381133667-5">(</span><span class="n">target_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5381133667-6">%{</span><span class="w">
  </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">20_000</span><span class="p">,</span><span class="w">
  </span><span class="ss">prefer_direct</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
  </span><span class="ss">fallback_relay</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="p">,</span><span class="w">
  </span><span class="ss">max_attempts</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="p" data-group-id="5381133667-6">}</span><span class="p" data-group-id="5381133667-5">)</span></code></pre><hr class="thin"/><h2 id="relay-system-api" class="section-heading"><a href="#relay-system-api" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Relay System API</span></h2><h3 id="macula_relay_registry" class="section-heading"><a href="#macula_relay_registry" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_relay_registry</span></h3><p>Distributed registry of relay-capable nodes.</p><h4>register/2</h4><p>Register as relay-capable node.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">register</span><span class="p" data-group-id="1794444954-1">(</span><span class="nf">binary</span><span class="p" data-group-id="1794444954-2">(</span><span class="p" data-group-id="1794444954-2">)</span><span class="p">,</span><span class="w"> </span><span class="nf">binary</span><span class="p" data-group-id="1794444954-3">(</span><span class="p" data-group-id="1794444954-3">)</span><span class="p" data-group-id="1794444954-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="1794444954-4">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="1794444954-5">(</span><span class="p" data-group-id="1794444954-5">)</span><span class="p" data-group-id="1794444954-4">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Register self as relay with endpoint</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_registry</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="1794444954-6">(</span><span class="n">MyNodeId</span><span class="p">,</span><span class="w"> </span><span class="n">MyEndpoint</span><span class="p" data-group-id="1794444954-6">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Register self as relay with endpoint</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_registry</span><span class="o">.</span><span class="n">register</span><span class="p" data-group-id="3780410568-1">(</span><span class="n">my_node_id</span><span class="p">,</span><span class="w"> </span><span class="n">my_endpoint</span><span class="p" data-group-id="3780410568-1">)</span></code></pre><h4>find_relay/1</h4><p>Find suitable relay for target peer.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">find_relay</span><span class="p" data-group-id="0221081781-1">(</span><span class="nf">binary</span><span class="p" data-group-id="0221081781-2">(</span><span class="p" data-group-id="0221081781-2">)</span><span class="p" data-group-id="0221081781-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p" data-group-id="0221081781-3">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">relay_info</span><span class="p" data-group-id="0221081781-4">(</span><span class="p" data-group-id="0221081781-4">)</span><span class="p" data-group-id="0221081781-3">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="0221081781-5">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_relay</span><span class="p" data-group-id="0221081781-5">}</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Find relay to reach target</span><span class="w">
</span><span class="p" data-group-id="0221081781-6">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="0221081781-7">#{</span><span class="w">
    </span><span class="ss">node_id</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">RelayNodeId</span><span class="p">,</span><span class="w">
    </span><span class="ss">endpoint</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">RelayEndpoint</span><span class="p">,</span><span class="w">
    </span><span class="ss">latency_ms</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
    </span><span class="ss">load</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mf">0.3</span><span class="w">
</span><span class="p" data-group-id="0221081781-7">}</span><span class="p" data-group-id="0221081781-6">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_registry</span><span class="p">:</span><span class="nf">find_relay</span><span class="p" data-group-id="0221081781-8">(</span><span class="n">TargetNodeId</span><span class="p" data-group-id="0221081781-8">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Find relay to reach target</span><span class="w">
</span><span class="p" data-group-id="3767680625-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="3767680625-2">%{</span><span class="w">
  </span><span class="ss">node_id</span><span class="p">:</span><span class="w"> </span><span class="n">relay_node_id</span><span class="p">,</span><span class="w">
  </span><span class="ss">endpoint</span><span class="p">:</span><span class="w"> </span><span class="n">relay_endpoint</span><span class="p">,</span><span class="w">
  </span><span class="ss">latency_ms</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w">
  </span><span class="ss">load</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3</span><span class="w">
</span><span class="p" data-group-id="3767680625-2">}</span><span class="p" data-group-id="3767680625-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_registry</span><span class="o">.</span><span class="n">find_relay</span><span class="p" data-group-id="3767680625-3">(</span><span class="n">target_node_id</span><span class="p" data-group-id="3767680625-3">)</span></code></pre><h3 id="macula_relay_node" class="section-heading"><a href="#macula_relay_node" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">macula_relay_node</span></h3><p>Relay server functionality.</p><h4>enable/0, enable/1</h4><p>Enable relay functionality on this node.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">enable</span><span class="p" data-group-id="2873119122-1">(</span><span class="p" data-group-id="2873119122-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">enable</span><span class="p" data-group-id="2873119122-2">(</span><span class="nf">map</span><span class="p" data-group-id="2873119122-3">(</span><span class="p" data-group-id="2873119122-3">)</span><span class="p" data-group-id="2873119122-2">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Enable with defaults</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_node</span><span class="p">:</span><span class="nf">enable</span><span class="p" data-group-id="2873119122-4">(</span><span class="p" data-group-id="2873119122-4">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Enable with custom limits</span><span class="w">
</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_node</span><span class="p">:</span><span class="nf">enable</span><span class="p" data-group-id="2873119122-5">(</span><span class="p" data-group-id="2873119122-6">#{</span><span class="w">
    </span><span class="ss">max_sessions</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
    </span><span class="ss">bandwidth_limit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">2097152</span><span class="p">,</span><span class="w">  </span><span class="c1">% 2 MB/s per session</span><span class="w">
    </span><span class="ss">session_timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">1800000</span><span class="w">   </span><span class="c1">% 30 minutes</span><span class="w">
</span><span class="p" data-group-id="2873119122-6">}</span><span class="p" data-group-id="2873119122-5">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Enable with defaults</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_node</span><span class="o">.</span><span class="n">enable</span><span class="p" data-group-id="9735845511-1">(</span><span class="p" data-group-id="9735845511-1">)</span><span class="w">

</span><span class="c1"># Enable with custom limits</span><span class="w">
</span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_node</span><span class="o">.</span><span class="n">enable</span><span class="p" data-group-id="9735845511-2">(</span><span class="p" data-group-id="9735845511-3">%{</span><span class="w">
  </span><span class="ss">max_sessions</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span><span class="w">
  </span><span class="ss">bandwidth_limit</span><span class="p">:</span><span class="w"> </span><span class="mi">2_097_152</span><span class="p">,</span><span class="w">  </span><span class="c1"># 2 MB/s per session</span><span class="w">
  </span><span class="ss">session_timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">1_800_000</span><span class="w">   </span><span class="c1"># 30 minutes</span><span class="w">
</span><span class="p" data-group-id="9735845511-3">}</span><span class="p" data-group-id="9735845511-2">)</span></code></pre><h4>disable/0</h4><p>Disable relay functionality.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">disable</span><span class="p" data-group-id="9818614613-1">(</span><span class="p" data-group-id="9818614613-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="ss">ok</span><span class="p">.</span><span class="w">

</span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_node</span><span class="p">:</span><span class="nf">disable</span><span class="p" data-group-id="9818614613-2">(</span><span class="p" data-group-id="9818614613-2">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_node</span><span class="o">.</span><span class="n">disable</span><span class="p" data-group-id="8529287132-1">(</span><span class="p" data-group-id="8529287132-1">)</span></code></pre><h4>request_relay/2</h4><p>Request relay session to target.</p><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">spec</span><span class="w"> </span><span class="nf">request_relay</span><span class="p" data-group-id="1219492169-1">(</span><span class="nf">binary</span><span class="p" data-group-id="1219492169-2">(</span><span class="p" data-group-id="1219492169-2">)</span><span class="p">,</span><span class="w"> </span><span class="nf">map</span><span class="p" data-group-id="1219492169-3">(</span><span class="p" data-group-id="1219492169-3">)</span><span class="p" data-group-id="1219492169-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="p" data-group-id="1219492169-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="nf">relay_session</span><span class="p" data-group-id="1219492169-5">(</span><span class="p" data-group-id="1219492169-5">)</span><span class="p" data-group-id="1219492169-4">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="p" data-group-id="1219492169-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="nf">term</span><span class="p" data-group-id="1219492169-7">(</span><span class="p" data-group-id="1219492169-7">)</span><span class="p" data-group-id="1219492169-6">}</span><span class="p">.</span><span class="w">

</span><span class="p" data-group-id="1219492169-8">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Session</span><span class="p" data-group-id="1219492169-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_node</span><span class="p">:</span><span class="nf">request_relay</span><span class="p" data-group-id="1219492169-9">(</span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1219492169-10">#{</span><span class="p" data-group-id="1219492169-10">}</span><span class="p" data-group-id="1219492169-9">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="p" data-group-id="1212627369-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p" data-group-id="1212627369-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_node</span><span class="o">.</span><span class="n">request_relay</span><span class="p" data-group-id="1212627369-2">(</span><span class="n">target_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1212627369-3">%{</span><span class="p" data-group-id="1212627369-3">}</span><span class="p" data-group-id="1212627369-2">)</span></code></pre><hr class="thin"/><h2 id="integration-examples" class="section-heading"><a href="#integration-examples" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Integration Examples</span></h2><h3 id="example-1-p2p-chat-application" class="section-heading"><a href="#example-1-p2p-chat-application" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 1: P2P Chat Application</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="1521914064-1">(</span><span class="ss">chat_client</span><span class="p" data-group-id="1521914064-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="1521914064-2">(</span><span class="p" data-group-id="1521914064-3">[</span><span class="ss">connect_to_peer</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="ss">send_message</span><span class="p">/</span><span class="mi">2</span><span class="p" data-group-id="1521914064-3">]</span><span class="p" data-group-id="1521914064-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">connect_to_peer</span><span class="p" data-group-id="1521914064-4">(</span><span class="n">PeerNodeId</span><span class="p" data-group-id="1521914064-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% NAT-aware connection - automatically handles traversal</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_nat_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="1521914064-5">(</span><span class="n">PeerNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1521914064-6">#{</span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">15000</span><span class="p" data-group-id="1521914064-6">}</span><span class="p" data-group-id="1521914064-5">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="1521914064-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="1521914064-7">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nf">log_connection_method</span><span class="p" data-group-id="1521914064-8">(</span><span class="n">Conn</span><span class="p" data-group-id="1521914064-8">)</span><span class="p">,</span><span class="w">
            </span><span class="p" data-group-id="1521914064-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="1521914064-9">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="1521914064-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1521914064-10">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="1521914064-11">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1521914064-12">{</span><span class="ss">connection_failed</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="1521914064-12">}</span><span class="p" data-group-id="1521914064-11">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span><span class="w">

</span><span class="nf">log_connection_method</span><span class="p" data-group-id="1521914064-13">(</span><span class="n">Conn</span><span class="p" data-group-id="1521914064-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="n">Method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">get_info</span><span class="p" data-group-id="1521914064-14">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="ss">connection_method</span><span class="p" data-group-id="1521914064-14">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="1521914064-15">(</span><span class="s">&quot;Connected via: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1521914064-16">[</span><span class="n">Method</span><span class="p" data-group-id="1521914064-16">]</span><span class="p" data-group-id="1521914064-15">)</span><span class="p">.</span><span class="w">

</span><span class="nf">send_message</span><span class="p" data-group-id="1521914064-17">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1521914064-17">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">macula_connection</span><span class="p">:</span><span class="nf">send</span><span class="p" data-group-id="1521914064-18">(</span><span class="n">Conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="1521914064-19">{</span><span class="ss">chat_message</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="p" data-group-id="1521914064-19">}</span><span class="p" data-group-id="1521914064-18">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">ChatClient</span><span class="w"> </span><span class="k" data-group-id="8699011364-1">do</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">connect_to_peer</span><span class="p" data-group-id="8699011364-2">(</span><span class="n">peer_node_id</span><span class="p" data-group-id="8699011364-2">)</span><span class="w"> </span><span class="k" data-group-id="8699011364-3">do</span><span class="w">
    </span><span class="c1"># NAT-aware connection - automatically handles traversal</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="8699011364-4">(</span><span class="n">peer_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8699011364-5">%{</span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">15_000</span><span class="p" data-group-id="8699011364-5">}</span><span class="p" data-group-id="8699011364-4">)</span><span class="w"> </span><span class="k" data-group-id="8699011364-6">do</span><span class="w">
      </span><span class="p" data-group-id="8699011364-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="8699011364-7">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="n">log_connection_method</span><span class="p" data-group-id="8699011364-8">(</span><span class="n">conn</span><span class="p" data-group-id="8699011364-8">)</span><span class="w">
        </span><span class="p" data-group-id="8699011364-9">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="8699011364-9">}</span><span class="w">

      </span><span class="p" data-group-id="8699011364-10">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="8699011364-10">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="8699011364-11">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8699011364-12">{</span><span class="ss">:connection_failed</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="8699011364-12">}</span><span class="p" data-group-id="8699011364-11">}</span><span class="w">
    </span><span class="k" data-group-id="8699011364-6">end</span><span class="w">
  </span><span class="k" data-group-id="8699011364-3">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">log_connection_method</span><span class="p" data-group-id="8699011364-13">(</span><span class="n">conn</span><span class="p" data-group-id="8699011364-13">)</span><span class="w"> </span><span class="k" data-group-id="8699011364-14">do</span><span class="w">
    </span><span class="n">method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_connection</span><span class="o">.</span><span class="n">get_info</span><span class="p" data-group-id="8699011364-15">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="ss">:connection_method</span><span class="p" data-group-id="8699011364-15">)</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="8699011364-16">(</span><span class="s">&quot;Connected via: </span><span class="si" data-group-id="8699011364-17">#{</span><span class="n">inspect</span><span class="p" data-group-id="8699011364-18">(</span><span class="n">method</span><span class="p" data-group-id="8699011364-18">)</span><span class="si" data-group-id="8699011364-17">}</span><span class="s">&quot;</span><span class="p" data-group-id="8699011364-16">)</span><span class="w">
  </span><span class="k" data-group-id="8699011364-14">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">send_message</span><span class="p" data-group-id="8699011364-19">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="8699011364-19">)</span><span class="w"> </span><span class="k" data-group-id="8699011364-20">do</span><span class="w">
    </span><span class="nc">:macula_connection</span><span class="o">.</span><span class="n">send</span><span class="p" data-group-id="8699011364-21">(</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8699011364-22">{</span><span class="ss">:chat_message</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p" data-group-id="8699011364-22">}</span><span class="p" data-group-id="8699011364-21">)</span><span class="w">
  </span><span class="k" data-group-id="8699011364-20">end</span><span class="w">
</span><span class="k" data-group-id="8699011364-1">end</span></code></pre><h3 id="example-2-monitoring-nat-changes" class="section-heading"><a href="#example-2-monitoring-nat-changes" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 2: Monitoring NAT Changes</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="2310931223-1">(</span><span class="ss">nat_monitor</span><span class="p" data-group-id="2310931223-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">behaviour</span><span class="p" data-group-id="2310931223-2">(</span><span class="ss">gen_server</span><span class="p" data-group-id="2310931223-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">init</span><span class="p" data-group-id="2310931223-3">(</span><span class="p" data-group-id="2310931223-4">[</span><span class="p" data-group-id="2310931223-4">]</span><span class="p" data-group-id="2310931223-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Subscribe to NAT profile changes</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">subscribe</span><span class="p" data-group-id="2310931223-5">(</span><span class="nf">self</span><span class="p" data-group-id="2310931223-6">(</span><span class="p" data-group-id="2310931223-6">)</span><span class="p" data-group-id="2310931223-5">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2310931223-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2310931223-8">#{</span><span class="p" data-group-id="2310931223-8">}</span><span class="p" data-group-id="2310931223-7">}</span><span class="p">.</span><span class="w">

</span><span class="nf">handle_info</span><span class="p" data-group-id="2310931223-9">(</span><span class="p" data-group-id="2310931223-10">{</span><span class="ss">nat_profile_changed</span><span class="p">,</span><span class="w"> </span><span class="n">OldProfile</span><span class="p">,</span><span class="w"> </span><span class="n">NewProfile</span><span class="p" data-group-id="2310931223-10">}</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="2310931223-9">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="2310931223-11">(</span><span class="s">&quot;NAT changed: </span><span class="si">~p</span><span class="s"> -&gt; </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="2310931223-12">[</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2310931223-13">(</span><span class="ss">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">OldProfile</span><span class="p" data-group-id="2310931223-13">)</span><span class="p">,</span><span class="w">
        </span><span class="nc">maps</span><span class="p">:</span><span class="nf">get</span><span class="p" data-group-id="2310931223-14">(</span><span class="ss">mapping</span><span class="p">,</span><span class="w"> </span><span class="n">NewProfile</span><span class="p" data-group-id="2310931223-14">)</span><span class="w">
    </span><span class="p" data-group-id="2310931223-12">]</span><span class="p" data-group-id="2310931223-11">)</span><span class="p">,</span><span class="w">
    </span><span class="c1">%% Notify application of network change</span><span class="w">
    </span><span class="nf">notify_network_change</span><span class="p" data-group-id="2310931223-15">(</span><span class="n">NewProfile</span><span class="p" data-group-id="2310931223-15">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="2310931223-16">{</span><span class="ss">noreply</span><span class="p">,</span><span class="w"> </span><span class="n">State</span><span class="p" data-group-id="2310931223-16">}</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">NatMonitor</span><span class="w"> </span><span class="k" data-group-id="9894638671-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="9894638671-2">(</span><span class="c">_opts</span><span class="p" data-group-id="9894638671-2">)</span><span class="w"> </span><span class="k" data-group-id="9894638671-3">do</span><span class="w">
    </span><span class="c1"># Subscribe to NAT profile changes</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="9894638671-4">(</span><span class="n">self</span><span class="p" data-group-id="9894638671-5">(</span><span class="p" data-group-id="9894638671-5">)</span><span class="p" data-group-id="9894638671-4">)</span><span class="w">
    </span><span class="p" data-group-id="9894638671-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9894638671-7">%{</span><span class="p" data-group-id="9894638671-7">}</span><span class="p" data-group-id="9894638671-6">}</span><span class="w">
  </span><span class="k" data-group-id="9894638671-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="9894638671-8">(</span><span class="p" data-group-id="9894638671-9">{</span><span class="ss">:nat_profile_changed</span><span class="p">,</span><span class="w"> </span><span class="n">old_profile</span><span class="p">,</span><span class="w"> </span><span class="n">new_profile</span><span class="p" data-group-id="9894638671-9">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9894638671-8">)</span><span class="w"> </span><span class="k" data-group-id="9894638671-10">do</span><span class="w">
    </span><span class="nc">IO</span><span class="o">.</span><span class="n">puts</span><span class="p" data-group-id="9894638671-11">(</span><span class="s">&quot;&quot;&quot;
    NAT changed: </span><span class="si" data-group-id="9894638671-12">#{</span><span class="n">inspect</span><span class="p" data-group-id="9894638671-13">(</span><span class="n">old_profile</span><span class="o">.</span><span class="n">mapping</span><span class="p" data-group-id="9894638671-13">)</span><span class="si" data-group-id="9894638671-12">}</span><span class="s"> -&gt; </span><span class="si" data-group-id="9894638671-14">#{</span><span class="n">inspect</span><span class="p" data-group-id="9894638671-15">(</span><span class="n">new_profile</span><span class="o">.</span><span class="n">mapping</span><span class="p" data-group-id="9894638671-15">)</span><span class="si" data-group-id="9894638671-14">}</span><span class="s">
    &quot;&quot;&quot;</span><span class="p" data-group-id="9894638671-11">)</span><span class="w">

    </span><span class="c1"># Notify application of network change</span><span class="w">
    </span><span class="n">notify_network_change</span><span class="p" data-group-id="9894638671-16">(</span><span class="n">new_profile</span><span class="p" data-group-id="9894638671-16">)</span><span class="w">
    </span><span class="p" data-group-id="9894638671-17">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="9894638671-17">}</span><span class="w">
  </span><span class="k" data-group-id="9894638671-10">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">notify_network_change</span><span class="p" data-group-id="9894638671-18">(</span><span class="n">profile</span><span class="p" data-group-id="9894638671-18">)</span><span class="w"> </span><span class="k" data-group-id="9894638671-19">do</span><span class="w">
    </span><span class="c1"># Custom notification logic</span><span class="w">
    </span><span class="nc">Phoenix.PubSub</span><span class="o">.</span><span class="n">broadcast</span><span class="p" data-group-id="9894638671-20">(</span><span class="nc">MyApp.PubSub</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nat:changes&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="9894638671-21">{</span><span class="ss">:nat_changed</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="9894638671-21">}</span><span class="p" data-group-id="9894638671-20">)</span><span class="w">
  </span><span class="k" data-group-id="9894638671-19">end</span><span class="w">
</span><span class="k" data-group-id="9894638671-1">end</span></code></pre><h3 id="example-3-running-a-relay-node" class="section-heading"><a href="#example-3-running-a-relay-node" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 3: Running a Relay Node</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="p">-</span><span class="na">module</span><span class="p" data-group-id="5605276189-1">(</span><span class="ss">relay_server</span><span class="p" data-group-id="5605276189-1">)</span><span class="p">.</span><span class="w">
</span><span class="p">-</span><span class="na">export</span><span class="p" data-group-id="5605276189-2">(</span><span class="p" data-group-id="5605276189-3">[</span><span class="ss">start</span><span class="p">/</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="ss">stop</span><span class="p">/</span><span class="mi">0</span><span class="p" data-group-id="5605276189-3">]</span><span class="p" data-group-id="5605276189-2">)</span><span class="p">.</span><span class="w">

</span><span class="nf">start</span><span class="p" data-group-id="5605276189-4">(</span><span class="p" data-group-id="5605276189-4">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="c1">%% Enable relay with monitoring</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_node</span><span class="p">:</span><span class="nf">enable</span><span class="p" data-group-id="5605276189-5">(</span><span class="p" data-group-id="5605276189-6">#{</span><span class="w">
        </span><span class="ss">max_sessions</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w">
        </span><span class="ss">bandwidth_limit</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5242880</span><span class="p">,</span><span class="w">  </span><span class="c1">% 5 MB/s</span><span class="w">
        </span><span class="ss">on_session_start</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">log_session_start</span><span class="p">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="ss">on_session_end</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="k">fun</span><span class="w"> </span><span class="ss">log_session_end</span><span class="p">/</span><span class="mi">1</span><span class="w">
    </span><span class="p" data-group-id="5605276189-6">}</span><span class="p" data-group-id="5605276189-5">)</span><span class="p">,</span><span class="w">

    </span><span class="c1">%% Register in distributed registry</span><span class="w">
    </span><span class="p" data-group-id="5605276189-7">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">NodeId</span><span class="p" data-group-id="5605276189-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">get_node_id</span><span class="p" data-group-id="5605276189-8">(</span><span class="p" data-group-id="5605276189-8">)</span><span class="p">,</span><span class="w">
    </span><span class="p" data-group-id="5605276189-9">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Endpoint</span><span class="p" data-group-id="5605276189-9">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula</span><span class="p">:</span><span class="nf">get_public_endpoint</span><span class="p" data-group-id="5605276189-10">(</span><span class="p" data-group-id="5605276189-10">)</span><span class="p">,</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_registry</span><span class="p">:</span><span class="nf">register</span><span class="p" data-group-id="5605276189-11">(</span><span class="n">NodeId</span><span class="p">,</span><span class="w"> </span><span class="n">Endpoint</span><span class="p" data-group-id="5605276189-11">)</span><span class="p">,</span><span class="w">

    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5605276189-12">(</span><span class="s">&quot;Relay server started</span><span class="si">~n</span><span class="s">&quot;</span><span class="p" data-group-id="5605276189-12">)</span><span class="p">.</span><span class="w">

</span><span class="nf">stop</span><span class="p" data-group-id="5605276189-13">(</span><span class="p" data-group-id="5605276189-13">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="ss">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_relay_node</span><span class="p">:</span><span class="nf">disable</span><span class="p" data-group-id="5605276189-14">(</span><span class="p" data-group-id="5605276189-14">)</span><span class="p">,</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5605276189-15">(</span><span class="s">&quot;Relay server stopped</span><span class="si">~n</span><span class="s">&quot;</span><span class="p" data-group-id="5605276189-15">)</span><span class="p">.</span><span class="w">

</span><span class="nf">log_session_start</span><span class="p" data-group-id="5605276189-16">(</span><span class="p" data-group-id="5605276189-17">#{</span><span class="ss">peer_a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">peer_b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="5605276189-17">}</span><span class="p" data-group-id="5605276189-16">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5605276189-18">(</span><span class="s">&quot;Relay session: </span><span class="si">~s</span><span class="s"> &lt;-&gt; </span><span class="si">~s</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5605276189-19">[</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p" data-group-id="5605276189-19">]</span><span class="p" data-group-id="5605276189-18">)</span><span class="p">.</span><span class="w">

</span><span class="nf">log_session_end</span><span class="p" data-group-id="5605276189-20">(</span><span class="p" data-group-id="5605276189-21">#{</span><span class="ss">peer_a</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="ss">peer_b</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="ss">bytes_transferred</span><span class="w"> </span><span class="p">:=</span><span class="w"> </span><span class="n">Bytes</span><span class="p" data-group-id="5605276189-21">}</span><span class="p" data-group-id="5605276189-20">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="5605276189-22">(</span><span class="s">&quot;Session ended: </span><span class="si">~s</span><span class="s"> &lt;-&gt; </span><span class="si">~s</span><span class="s"> (</span><span class="si">~p</span><span class="s"> bytes)</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="5605276189-23">[</span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">Bytes</span><span class="p" data-group-id="5605276189-23">]</span><span class="p" data-group-id="5605276189-22">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">RelayServer</span><span class="w"> </span><span class="k" data-group-id="6063694481-1">do</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start</span><span class="w"> </span><span class="k" data-group-id="6063694481-2">do</span><span class="w">
    </span><span class="c1"># Enable relay with monitoring</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_node</span><span class="o">.</span><span class="n">enable</span><span class="p" data-group-id="6063694481-3">(</span><span class="p" data-group-id="6063694481-4">%{</span><span class="w">
      </span><span class="ss">max_sessions</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w">
      </span><span class="ss">bandwidth_limit</span><span class="p">:</span><span class="w"> </span><span class="mi">5_242_880</span><span class="p">,</span><span class="w">  </span><span class="c1"># 5 MB/s</span><span class="w">
      </span><span class="ss">on_session_start</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">log_session_start</span><span class="o">/</span><span class="mi">1</span><span class="p">,</span><span class="w">
      </span><span class="ss">on_session_end</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="n">log_session_end</span><span class="o">/</span><span class="mi">1</span><span class="w">
    </span><span class="p" data-group-id="6063694481-4">}</span><span class="p" data-group-id="6063694481-3">)</span><span class="w">

    </span><span class="c1"># Register in distributed registry</span><span class="w">
    </span><span class="p" data-group-id="6063694481-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">node_id</span><span class="p" data-group-id="6063694481-5">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">get_node_id</span><span class="p" data-group-id="6063694481-6">(</span><span class="p" data-group-id="6063694481-6">)</span><span class="w">
    </span><span class="p" data-group-id="6063694481-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint</span><span class="p" data-group-id="6063694481-7">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula</span><span class="o">.</span><span class="n">get_public_endpoint</span><span class="p" data-group-id="6063694481-8">(</span><span class="p" data-group-id="6063694481-8">)</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_registry</span><span class="o">.</span><span class="n">register</span><span class="p" data-group-id="6063694481-9">(</span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">endpoint</span><span class="p" data-group-id="6063694481-9">)</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="6063694481-10">(</span><span class="s">&quot;Relay server started&quot;</span><span class="p" data-group-id="6063694481-10">)</span><span class="w">
  </span><span class="k" data-group-id="6063694481-2">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">stop</span><span class="w"> </span><span class="k" data-group-id="6063694481-11">do</span><span class="w">
    </span><span class="ss">:ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_relay_node</span><span class="o">.</span><span class="n">disable</span><span class="p" data-group-id="6063694481-12">(</span><span class="p" data-group-id="6063694481-12">)</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="6063694481-13">(</span><span class="s">&quot;Relay server stopped&quot;</span><span class="p" data-group-id="6063694481-13">)</span><span class="w">
  </span><span class="k" data-group-id="6063694481-11">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">log_session_start</span><span class="p" data-group-id="6063694481-14">(</span><span class="p" data-group-id="6063694481-15">%{</span><span class="ss">peer_a</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="ss">peer_b</span><span class="p">:</span><span class="w"> </span><span class="n">b</span><span class="p" data-group-id="6063694481-15">}</span><span class="p" data-group-id="6063694481-14">)</span><span class="w"> </span><span class="k" data-group-id="6063694481-16">do</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="6063694481-17">(</span><span class="s">&quot;Relay session: </span><span class="si" data-group-id="6063694481-18">#{</span><span class="n">a</span><span class="si" data-group-id="6063694481-18">}</span><span class="s"> &lt;-&gt; </span><span class="si" data-group-id="6063694481-19">#{</span><span class="n">b</span><span class="si" data-group-id="6063694481-19">}</span><span class="s">&quot;</span><span class="p" data-group-id="6063694481-17">)</span><span class="w">
  </span><span class="k" data-group-id="6063694481-16">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">log_session_end</span><span class="p" data-group-id="6063694481-20">(</span><span class="p" data-group-id="6063694481-21">%{</span><span class="ss">peer_a</span><span class="p">:</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="ss">peer_b</span><span class="p">:</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="ss">bytes_transferred</span><span class="p">:</span><span class="w"> </span><span class="n">bytes</span><span class="p" data-group-id="6063694481-21">}</span><span class="p" data-group-id="6063694481-20">)</span><span class="w"> </span><span class="k" data-group-id="6063694481-22">do</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="6063694481-23">(</span><span class="s">&quot;Session ended: </span><span class="si" data-group-id="6063694481-24">#{</span><span class="n">a</span><span class="si" data-group-id="6063694481-24">}</span><span class="s"> &lt;-&gt; </span><span class="si" data-group-id="6063694481-25">#{</span><span class="n">b</span><span class="si" data-group-id="6063694481-25">}</span><span class="s"> (</span><span class="si" data-group-id="6063694481-26">#{</span><span class="n">bytes</span><span class="si" data-group-id="6063694481-26">}</span><span class="s"> bytes)&quot;</span><span class="p" data-group-id="6063694481-23">)</span><span class="w">
  </span><span class="k" data-group-id="6063694481-22">end</span><span class="w">
</span><span class="k" data-group-id="6063694481-1">end</span></code></pre><h3 id="example-4-phoenix-liveview-integration" class="section-heading"><a href="#example-4-phoenix-liveview-integration" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 4: Phoenix LiveView Integration</span></h3><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyAppWeb.ConnectionLive</span><span class="w"> </span><span class="k" data-group-id="6243017160-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">MyAppWeb</span><span class="p">,</span><span class="w"> </span><span class="ss">:live_view</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">mount</span><span class="p" data-group-id="6243017160-2">(</span><span class="c">_params</span><span class="p">,</span><span class="w"> </span><span class="c">_session</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="6243017160-2">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-3">do</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">connected?</span><span class="p" data-group-id="6243017160-4">(</span><span class="n">socket</span><span class="p" data-group-id="6243017160-4">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-5">do</span><span class="w">
      </span><span class="c1"># Subscribe to NAT changes</span><span class="w">
      </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="6243017160-6">(</span><span class="n">self</span><span class="p" data-group-id="6243017160-7">(</span><span class="p" data-group-id="6243017160-7">)</span><span class="p" data-group-id="6243017160-6">)</span><span class="w">

      </span><span class="c1"># Get initial NAT profile</span><span class="w">
      </span><span class="p" data-group-id="6243017160-8">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="6243017160-8">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">get_local_profile</span><span class="p" data-group-id="6243017160-9">(</span><span class="p" data-group-id="6243017160-9">)</span><span class="w">

      </span><span class="p" data-group-id="6243017160-10">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w">
       </span><span class="n">socket</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-11">(</span><span class="ss">:nat_profile</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="6243017160-11">)</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-12">(</span><span class="ss">:connection_status</span><span class="p">,</span><span class="w"> </span><span class="ss">:disconnected</span><span class="p" data-group-id="6243017160-12">)</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-13">(</span><span class="ss">:peers</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-14">[</span><span class="p" data-group-id="6243017160-14">]</span><span class="p" data-group-id="6243017160-13">)</span><span class="p" data-group-id="6243017160-10">}</span><span class="w">
    </span><span class="k" data-group-id="6243017160-5">else</span><span class="w">
      </span><span class="p" data-group-id="6243017160-15">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w">
       </span><span class="n">socket</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-16">(</span><span class="ss">:nat_profile</span><span class="p">,</span><span class="w"> </span><span class="no">nil</span><span class="p" data-group-id="6243017160-16">)</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-17">(</span><span class="ss">:connection_status</span><span class="p">,</span><span class="w"> </span><span class="ss">:loading</span><span class="p" data-group-id="6243017160-17">)</span><span class="w">
       </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-18">(</span><span class="ss">:peers</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-19">[</span><span class="p" data-group-id="6243017160-19">]</span><span class="p" data-group-id="6243017160-18">)</span><span class="p" data-group-id="6243017160-15">}</span><span class="w">
    </span><span class="k" data-group-id="6243017160-5">end</span><span class="w">
  </span><span class="k" data-group-id="6243017160-3">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_event</span><span class="p" data-group-id="6243017160-20">(</span><span class="s">&quot;connect&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-21">%{</span><span class="s">&quot;peer_id&quot;</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="6243017160-21">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="6243017160-20">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-22">do</span><span class="w">
    </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-23">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:connection_status</span><span class="p">,</span><span class="w"> </span><span class="ss">:connecting</span><span class="p" data-group-id="6243017160-23">)</span><span class="w">

    </span><span class="nc">Task</span><span class="o">.</span><span class="n">async</span><span class="p" data-group-id="6243017160-24">(</span><span class="k" data-group-id="6243017160-25">fn</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="6243017160-26">(</span><span class="n">peer_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-27">%{</span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">15_000</span><span class="p" data-group-id="6243017160-27">}</span><span class="p" data-group-id="6243017160-26">)</span><span class="w">
    </span><span class="k" data-group-id="6243017160-25">end</span><span class="p" data-group-id="6243017160-24">)</span><span class="w">

    </span><span class="p" data-group-id="6243017160-28">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="6243017160-28">}</span><span class="w">
  </span><span class="k" data-group-id="6243017160-22">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="6243017160-29">(</span><span class="p" data-group-id="6243017160-30">{</span><span class="n">ref</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-31">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="6243017160-31">}</span><span class="p" data-group-id="6243017160-30">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="6243017160-29">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_reference</span><span class="p" data-group-id="6243017160-32">(</span><span class="n">ref</span><span class="p" data-group-id="6243017160-32">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-33">do</span><span class="w">
    </span><span class="nc">Process</span><span class="o">.</span><span class="n">demonitor</span><span class="p" data-group-id="6243017160-34">(</span><span class="n">ref</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-35">[</span><span class="ss">:flush</span><span class="p" data-group-id="6243017160-35">]</span><span class="p" data-group-id="6243017160-34">)</span><span class="w">

    </span><span class="p" data-group-id="6243017160-36">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
     </span><span class="n">socket</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-37">(</span><span class="ss">:connection_status</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-38">{</span><span class="ss">:connected</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="6243017160-38">}</span><span class="p" data-group-id="6243017160-37">)</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">update</span><span class="p" data-group-id="6243017160-39">(</span><span class="ss">:peers</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="6243017160-40">fn</span><span class="w"> </span><span class="n">peers</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p" data-group-id="6243017160-41">[</span><span class="n">conn</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">peers</span><span class="p" data-group-id="6243017160-41">]</span><span class="w"> </span><span class="k" data-group-id="6243017160-40">end</span><span class="p" data-group-id="6243017160-39">)</span><span class="p" data-group-id="6243017160-36">}</span><span class="w">
  </span><span class="k" data-group-id="6243017160-33">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="6243017160-42">(</span><span class="p" data-group-id="6243017160-43">{</span><span class="n">ref</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-44">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="6243017160-44">}</span><span class="p" data-group-id="6243017160-43">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="6243017160-42">)</span><span class="w"> </span><span class="ow">when</span><span class="w"> </span><span class="n">is_reference</span><span class="p" data-group-id="6243017160-45">(</span><span class="n">ref</span><span class="p" data-group-id="6243017160-45">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-46">do</span><span class="w">
    </span><span class="nc">Process</span><span class="o">.</span><span class="n">demonitor</span><span class="p" data-group-id="6243017160-47">(</span><span class="n">ref</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-48">[</span><span class="ss">:flush</span><span class="p" data-group-id="6243017160-48">]</span><span class="p" data-group-id="6243017160-47">)</span><span class="w">

    </span><span class="p" data-group-id="6243017160-49">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w">
     </span><span class="n">socket</span><span class="w">
     </span><span class="o">|&gt;</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-50">(</span><span class="ss">:connection_status</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6243017160-51">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="6243017160-51">}</span><span class="p" data-group-id="6243017160-50">)</span><span class="p" data-group-id="6243017160-49">}</span><span class="w">
  </span><span class="k" data-group-id="6243017160-46">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="6243017160-52">(</span><span class="p" data-group-id="6243017160-53">{</span><span class="ss">:nat_profile_changed</span><span class="p">,</span><span class="w"> </span><span class="c">_old</span><span class="p">,</span><span class="w"> </span><span class="n">new_profile</span><span class="p" data-group-id="6243017160-53">}</span><span class="p">,</span><span class="w"> </span><span class="n">socket</span><span class="p" data-group-id="6243017160-52">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-54">do</span><span class="w">
    </span><span class="p" data-group-id="6243017160-55">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">assign</span><span class="p" data-group-id="6243017160-56">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="ss">:nat_profile</span><span class="p">,</span><span class="w"> </span><span class="n">new_profile</span><span class="p" data-group-id="6243017160-56">)</span><span class="p" data-group-id="6243017160-55">}</span><span class="w">
  </span><span class="k" data-group-id="6243017160-54">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">render</span><span class="p" data-group-id="6243017160-57">(</span><span class="n">assigns</span><span class="p" data-group-id="6243017160-57">)</span><span class="w"> </span><span class="k" data-group-id="6243017160-58">do</span><span class="w">
    </span><span class="sx">~H&quot;&quot;&quot;
    &lt;div class=&quot;nat-status&quot;&gt;
      &lt;h3&gt;NAT Status&lt;/h3&gt;
      &lt;%= if @nat_profile do %&gt;
        &lt;dl&gt;
          &lt;dt&gt;Mapping&lt;/dt&gt;
          &lt;dd&gt;&lt;%= @nat_profile.mapping %&gt;&lt;/dd&gt;
          &lt;dt&gt;Filtering&lt;/dt&gt;
          &lt;dd&gt;&lt;%= @nat_profile.filtering %&gt;&lt;/dd&gt;
          &lt;dt&gt;Allocation&lt;/dt&gt;
          &lt;dd&gt;&lt;%= @nat_profile.allocation %&gt;&lt;/dd&gt;
          &lt;dt&gt;Public IP&lt;/dt&gt;
          &lt;dd&gt;&lt;%= format_ip(@nat_profile.public_ip) %&gt;&lt;/dd&gt;
        &lt;/dl&gt;
      &lt;% else %&gt;
        &lt;p&gt;Detecting NAT type...&lt;/p&gt;
      &lt;% end %&gt;

      &lt;h3&gt;Connection Status: &lt;%= inspect(@connection_status) %&gt;&lt;/h3&gt;

      &lt;form phx-submit=&quot;connect&quot;&gt;
        &lt;input type=&quot;text&quot; name=&quot;peer_id&quot; placeholder=&quot;Peer Node ID&quot; /&gt;
        &lt;button type=&quot;submit&quot;&gt;Connect&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
    &quot;&quot;&quot;</span><span class="w">
  </span><span class="k" data-group-id="6243017160-58">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">format_ip</span><span class="p" data-group-id="6243017160-59">(</span><span class="p" data-group-id="6243017160-60">{</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">d</span><span class="p" data-group-id="6243017160-60">}</span><span class="p" data-group-id="6243017160-59">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;</span><span class="si" data-group-id="6243017160-61">#{</span><span class="n">a</span><span class="si" data-group-id="6243017160-61">}</span><span class="s">.</span><span class="si" data-group-id="6243017160-62">#{</span><span class="n">b</span><span class="si" data-group-id="6243017160-62">}</span><span class="s">.</span><span class="si" data-group-id="6243017160-63">#{</span><span class="n">c</span><span class="si" data-group-id="6243017160-63">}</span><span class="s">.</span><span class="si" data-group-id="6243017160-64">#{</span><span class="n">d</span><span class="si" data-group-id="6243017160-64">}</span><span class="s">&quot;</span><span class="w">
</span><span class="k" data-group-id="6243017160-1">end</span></code></pre><h3 id="example-5-genserver-based-connection-manager" class="section-heading"><a href="#example-5-genserver-based-connection-manager" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Example 5: GenServer-based Connection Manager</span></h3><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">MyApp.ConnectionManager</span><span class="w"> </span><span class="k" data-group-id="8892167799-1">do</span><span class="w">
  </span><span class="kn">use</span><span class="w"> </span><span class="nc">GenServer</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">

  </span><span class="kd">defstruct</span><span class="w"> </span><span class="p" data-group-id="8892167799-2">[</span><span class="ss">:node_id</span><span class="p">,</span><span class="w"> </span><span class="ss">:connections</span><span class="p">,</span><span class="w"> </span><span class="ss">:nat_profile</span><span class="p" data-group-id="8892167799-2">]</span><span class="w">

  </span><span class="c1"># Client API</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">start_link</span><span class="p" data-group-id="8892167799-3">(</span><span class="n">opts</span><span class="p" data-group-id="8892167799-3">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-4">do</span><span class="w">
    </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p" data-group-id="8892167799-5">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">name</span><span class="p">:</span><span class="w"> </span><span class="bp">__MODULE__</span><span class="p" data-group-id="8892167799-5">)</span><span class="w">
  </span><span class="k" data-group-id="8892167799-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">connect</span><span class="p" data-group-id="8892167799-6">(</span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-6">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="8892167799-7">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-8">{</span><span class="ss">:connect</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-8">}</span><span class="p" data-group-id="8892167799-7">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">disconnect</span><span class="p" data-group-id="8892167799-9">(</span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-9">)</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p" data-group-id="8892167799-10">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-11">{</span><span class="ss">:disconnect</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-11">}</span><span class="p" data-group-id="8892167799-10">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">list_connections</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="8892167799-12">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="ss">:list</span><span class="p" data-group-id="8892167799-12">)</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">get_nat_profile</span><span class="p">,</span><span class="w"> </span><span class="ss">do</span><span class="p">:</span><span class="w"> </span><span class="nc">GenServer</span><span class="o">.</span><span class="n">call</span><span class="p" data-group-id="8892167799-13">(</span><span class="bp">__MODULE__</span><span class="p">,</span><span class="w"> </span><span class="ss">:nat_profile</span><span class="p" data-group-id="8892167799-13">)</span><span class="w">

  </span><span class="c1"># Server Callbacks</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="8892167799-14">(</span><span class="n">opts</span><span class="p" data-group-id="8892167799-14">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-15">do</span><span class="w">
    </span><span class="n">node_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Keyword</span><span class="o">.</span><span class="n">fetch!</span><span class="p" data-group-id="8892167799-16">(</span><span class="n">opts</span><span class="p">,</span><span class="w"> </span><span class="ss">:node_id</span><span class="p" data-group-id="8892167799-16">)</span><span class="w">

    </span><span class="c1"># Detect NAT type on startup</span><span class="w">
    </span><span class="p" data-group-id="8892167799-17">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="8892167799-17">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">detect</span><span class="p" data-group-id="8892167799-18">(</span><span class="p" data-group-id="8892167799-18">)</span><span class="w">

    </span><span class="c1"># Subscribe to profile changes</span><span class="w">
    </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">subscribe</span><span class="p" data-group-id="8892167799-19">(</span><span class="n">self</span><span class="p" data-group-id="8892167799-20">(</span><span class="p" data-group-id="8892167799-20">)</span><span class="p" data-group-id="8892167799-19">)</span><span class="w">

    </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">%</span><span class="bp">__MODULE__</span><span class="p" data-group-id="8892167799-21">{</span><span class="w">
      </span><span class="ss">node_id</span><span class="p">:</span><span class="w"> </span><span class="n">node_id</span><span class="p">,</span><span class="w">
      </span><span class="ss">connections</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="8892167799-22">%{</span><span class="p" data-group-id="8892167799-22">}</span><span class="p">,</span><span class="w">
      </span><span class="ss">nat_profile</span><span class="p">:</span><span class="w"> </span><span class="n">profile</span><span class="w">
    </span><span class="p" data-group-id="8892167799-21">}</span><span class="w">

    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="8892167799-23">(</span><span class="s">&quot;ConnectionManager started with NAT profile: </span><span class="si" data-group-id="8892167799-24">#{</span><span class="n">inspect</span><span class="p" data-group-id="8892167799-25">(</span><span class="n">profile</span><span class="p" data-group-id="8892167799-25">)</span><span class="si" data-group-id="8892167799-24">}</span><span class="s">&quot;</span><span class="p" data-group-id="8892167799-23">)</span><span class="w">
    </span><span class="p" data-group-id="8892167799-26">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-26">}</span><span class="w">
  </span><span class="k" data-group-id="8892167799-15">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="8892167799-27">(</span><span class="p" data-group-id="8892167799-28">{</span><span class="ss">:connect</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-28">}</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-27">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-29">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="8892167799-30">(</span><span class="n">state</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-31">%{</span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">10_000</span><span class="p" data-group-id="8892167799-31">}</span><span class="p" data-group-id="8892167799-30">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-32">do</span><span class="w">
      </span><span class="p" data-group-id="8892167799-33">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="8892167799-33">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="8892167799-34">(</span><span class="s">&quot;Connected to </span><span class="si" data-group-id="8892167799-35">#{</span><span class="n">peer_id</span><span class="si" data-group-id="8892167799-35">}</span><span class="s"> via </span><span class="si" data-group-id="8892167799-36">#{</span><span class="n">method</span><span class="si" data-group-id="8892167799-36">}</span><span class="s">&quot;</span><span class="p" data-group-id="8892167799-34">)</span><span class="w">
        </span><span class="n">connections</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="8892167799-37">(</span><span class="n">state</span><span class="o">.</span><span class="n">connections</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-38">{</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="8892167799-38">}</span><span class="p" data-group-id="8892167799-37">)</span><span class="w">
        </span><span class="p" data-group-id="8892167799-39">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-40">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">method</span><span class="p" data-group-id="8892167799-40">}</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-41">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">connections</span><span class="p">:</span><span class="w"> </span><span class="n">connections</span><span class="p" data-group-id="8892167799-41">}</span><span class="p" data-group-id="8892167799-39">}</span><span class="w">

      </span><span class="p" data-group-id="8892167799-42">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="8892167799-42">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">Logger</span><span class="o">.</span><span class="n">warning</span><span class="p" data-group-id="8892167799-43">(</span><span class="s">&quot;Failed to connect to </span><span class="si" data-group-id="8892167799-44">#{</span><span class="n">peer_id</span><span class="si" data-group-id="8892167799-44">}</span><span class="s">: </span><span class="si" data-group-id="8892167799-45">#{</span><span class="n">inspect</span><span class="p" data-group-id="8892167799-46">(</span><span class="n">reason</span><span class="p" data-group-id="8892167799-46">)</span><span class="si" data-group-id="8892167799-45">}</span><span class="s">&quot;</span><span class="p" data-group-id="8892167799-43">)</span><span class="w">
        </span><span class="p" data-group-id="8892167799-47">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-47">}</span><span class="w">
    </span><span class="k" data-group-id="8892167799-32">end</span><span class="w">
  </span><span class="k" data-group-id="8892167799-29">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="8892167799-48">(</span><span class="ss">:list</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-48">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-49">do</span><span class="w">
    </span><span class="p" data-group-id="8892167799-50">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">keys</span><span class="p" data-group-id="8892167799-51">(</span><span class="n">state</span><span class="o">.</span><span class="n">connections</span><span class="p" data-group-id="8892167799-51">)</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-50">}</span><span class="w">
  </span><span class="k" data-group-id="8892167799-49">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_call</span><span class="p" data-group-id="8892167799-52">(</span><span class="ss">:nat_profile</span><span class="p">,</span><span class="w"> </span><span class="c">_from</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-52">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-53">do</span><span class="w">
    </span><span class="p" data-group-id="8892167799-54">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">nat_profile</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-54">}</span><span class="w">
  </span><span class="k" data-group-id="8892167799-53">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_cast</span><span class="p" data-group-id="8892167799-55">(</span><span class="p" data-group-id="8892167799-56">{</span><span class="ss">:disconnect</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-56">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-55">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-57">do</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">pop</span><span class="p" data-group-id="8892167799-58">(</span><span class="n">state</span><span class="o">.</span><span class="n">connections</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-58">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-59">do</span><span class="w">
      </span><span class="p" data-group-id="8892167799-60">{</span><span class="p" data-group-id="8892167799-61">{</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="c">_method</span><span class="p" data-group-id="8892167799-61">}</span><span class="p">,</span><span class="w"> </span><span class="n">connections</span><span class="p" data-group-id="8892167799-60">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">disconnect</span><span class="p" data-group-id="8892167799-62">(</span><span class="n">conn</span><span class="p" data-group-id="8892167799-62">)</span><span class="w">
        </span><span class="p" data-group-id="8892167799-63">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-64">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">connections</span><span class="p">:</span><span class="w"> </span><span class="n">connections</span><span class="p" data-group-id="8892167799-64">}</span><span class="p" data-group-id="8892167799-63">}</span><span class="w">

      </span><span class="p" data-group-id="8892167799-65">{</span><span class="no">nil</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="8892167799-65">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
        </span><span class="p" data-group-id="8892167799-66">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-66">}</span><span class="w">
    </span><span class="k" data-group-id="8892167799-59">end</span><span class="w">
  </span><span class="k" data-group-id="8892167799-57">end</span><span class="w">

  </span><span class="na">@impl</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_info</span><span class="p" data-group-id="8892167799-67">(</span><span class="p" data-group-id="8892167799-68">{</span><span class="ss">:nat_profile_changed</span><span class="p">,</span><span class="w"> </span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p" data-group-id="8892167799-68">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="8892167799-67">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-69">do</span><span class="w">
    </span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p" data-group-id="8892167799-70">(</span><span class="s">&quot;NAT profile changed: </span><span class="si" data-group-id="8892167799-71">#{</span><span class="n">inspect</span><span class="p" data-group-id="8892167799-72">(</span><span class="n">old</span><span class="o">.</span><span class="n">mapping</span><span class="p" data-group-id="8892167799-72">)</span><span class="si" data-group-id="8892167799-71">}</span><span class="s"> -&gt; </span><span class="si" data-group-id="8892167799-73">#{</span><span class="n">inspect</span><span class="p" data-group-id="8892167799-74">(</span><span class="n">new</span><span class="o">.</span><span class="n">mapping</span><span class="p" data-group-id="8892167799-74">)</span><span class="si" data-group-id="8892167799-73">}</span><span class="s">&quot;</span><span class="p" data-group-id="8892167799-70">)</span><span class="w">

    </span><span class="c1"># Optionally reconnect peers if NAT type changed significantly</span><span class="w">
    </span><span class="k">if</span><span class="w"> </span><span class="n">needs_reconnection?</span><span class="p" data-group-id="8892167799-75">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p" data-group-id="8892167799-75">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-76">do</span><span class="w">
      </span><span class="n">reconnect_all_peers</span><span class="p" data-group-id="8892167799-77">(</span><span class="n">state</span><span class="p" data-group-id="8892167799-77">)</span><span class="w">
    </span><span class="k" data-group-id="8892167799-76">end</span><span class="w">

    </span><span class="p" data-group-id="8892167799-78">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-79">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">nat_profile</span><span class="p">:</span><span class="w"> </span><span class="n">new</span><span class="p" data-group-id="8892167799-79">}</span><span class="p" data-group-id="8892167799-78">}</span><span class="w">
  </span><span class="k" data-group-id="8892167799-69">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">needs_reconnection?</span><span class="p" data-group-id="8892167799-80">(</span><span class="n">old</span><span class="p">,</span><span class="w"> </span><span class="n">new</span><span class="p" data-group-id="8892167799-80">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-81">do</span><span class="w">
    </span><span class="n">old</span><span class="o">.</span><span class="n">mapping</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">new</span><span class="o">.</span><span class="n">mapping</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">old</span><span class="o">.</span><span class="n">filtering</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">new</span><span class="o">.</span><span class="n">filtering</span><span class="w">
  </span><span class="k" data-group-id="8892167799-81">end</span><span class="w">

  </span><span class="kd">defp</span><span class="w"> </span><span class="nf">reconnect_all_peers</span><span class="p" data-group-id="8892167799-82">(</span><span class="n">state</span><span class="p" data-group-id="8892167799-82">)</span><span class="w"> </span><span class="k" data-group-id="8892167799-83">do</span><span class="w">
    </span><span class="k">for</span><span class="w"> </span><span class="p" data-group-id="8892167799-84">{</span><span class="n">peer_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-85">{</span><span class="n">conn</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="8892167799-85">}</span><span class="p" data-group-id="8892167799-84">}</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">state</span><span class="o">.</span><span class="n">connections</span><span class="w"> </span><span class="k" data-group-id="8892167799-86">do</span><span class="w">
      </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">disconnect</span><span class="p" data-group-id="8892167799-87">(</span><span class="n">conn</span><span class="p" data-group-id="8892167799-87">)</span><span class="w">
      </span><span class="n">send</span><span class="p" data-group-id="8892167799-88">(</span><span class="n">self</span><span class="p" data-group-id="8892167799-89">(</span><span class="p" data-group-id="8892167799-89">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8892167799-90">{</span><span class="ss">:reconnect</span><span class="p">,</span><span class="w"> </span><span class="n">peer_id</span><span class="p" data-group-id="8892167799-90">}</span><span class="p" data-group-id="8892167799-88">)</span><span class="w">
    </span><span class="k" data-group-id="8892167799-86">end</span><span class="w">
  </span><span class="k" data-group-id="8892167799-83">end</span><span class="w">
</span><span class="k" data-group-id="8892167799-1">end</span></code></pre><hr class="thin"/><h2 id="error-handling" class="section-heading"><a href="#error-handling" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Error Handling</span></h2><h3 id="common-errors" class="section-heading"><a href="#common-errors" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Common Errors</span></h3><table><thead><tr><th style="text-align: left;">Error</th><th style="text-align: left;">Cause</th><th style="text-align: left;">Solution</th></tr></thead><tbody><tr><td style="text-align: left;"><code class="inline">{:error, :detection_timeout}</code></td><td style="text-align: left;">NAT detection timed out</td><td style="text-align: left;">Check network, retry with longer timeout</td></tr><tr><td style="text-align: left;"><code class="inline">{:error, :no_observers}</code></td><td style="text-align: left;">No public peers for detection</td><td style="text-align: left;">Connect to gateway first</td></tr><tr><td style="text-align: left;"><code class="inline">{:error, :symmetric_nat}</code></td><td style="text-align: left;">Both peers have symmetric NAT</td><td style="text-align: left;">Relay will be used automatically</td></tr><tr><td style="text-align: left;"><code class="inline">{:error, :punch_failed}</code></td><td style="text-align: left;">Hole punching failed</td><td style="text-align: left;">Falls back to relay automatically</td></tr><tr><td style="text-align: left;"><code class="inline">{:error, :no_relay}</code></td><td style="text-align: left;">No relay available</td><td style="text-align: left;">Enable relay on more nodes</td></tr></tbody></table><h3 id="handling-connection-failures" class="section-heading"><a href="#handling-connection-failures" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Handling Connection Failures</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="nf">connect_with_fallback</span><span class="p" data-group-id="8847332655-1">(</span><span class="n">TargetNodeId</span><span class="p" data-group-id="8847332655-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="k">case</span><span class="w"> </span><span class="nc">macula_nat_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="8847332655-2">(</span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8847332655-3">#{</span><span class="w">
        </span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">10000</span><span class="p">,</span><span class="w">
        </span><span class="ss">fallback_relay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">true</span><span class="w">
    </span><span class="p" data-group-id="8847332655-3">}</span><span class="p" data-group-id="8847332655-2">)</span><span class="w"> </span><span class="k">of</span><span class="w">
        </span><span class="p" data-group-id="8847332655-4">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="8847332655-4">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="8847332655-5">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Conn</span><span class="p" data-group-id="8847332655-5">}</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="8847332655-6">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="ss">no_relay</span><span class="p" data-group-id="8847332655-6">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="c1">%% No relay available, try direct with longer timeout</span><span class="w">
            </span><span class="nc">macula_nat_connector</span><span class="p">:</span><span class="nf">connect</span><span class="p" data-group-id="8847332655-7">(</span><span class="n">TargetNodeId</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="8847332655-8">#{</span><span class="w">
                </span><span class="ss">timeout</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">30000</span><span class="p">,</span><span class="w">
                </span><span class="ss">fallback_relay</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ss">false</span><span class="p">,</span><span class="w">
                </span><span class="ss">max_attempts</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="mi">5</span><span class="w">
            </span><span class="p" data-group-id="8847332655-8">}</span><span class="p" data-group-id="8847332655-7">)</span><span class="p">;</span><span class="w">
        </span><span class="p" data-group-id="8847332655-9">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8847332655-9">}</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="p" data-group-id="8847332655-10">{</span><span class="ss">error</span><span class="p">,</span><span class="w"> </span><span class="n">Reason</span><span class="p" data-group-id="8847332655-10">}</span><span class="w">
    </span><span class="k">end</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="kd">def</span><span class="w"> </span><span class="nf">connect_with_fallback</span><span class="p" data-group-id="6846415332-1">(</span><span class="n">target_node_id</span><span class="p" data-group-id="6846415332-1">)</span><span class="w"> </span><span class="k" data-group-id="6846415332-2">do</span><span class="w">
  </span><span class="k">case</span><span class="w"> </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="6846415332-3">(</span><span class="n">target_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6846415332-4">%{</span><span class="w">
    </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">10_000</span><span class="p">,</span><span class="w">
    </span><span class="ss">fallback_relay</span><span class="p">:</span><span class="w"> </span><span class="no">true</span><span class="w">
  </span><span class="p" data-group-id="6846415332-4">}</span><span class="p" data-group-id="6846415332-3">)</span><span class="w"> </span><span class="k" data-group-id="6846415332-5">do</span><span class="w">
    </span><span class="p" data-group-id="6846415332-6">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="6846415332-6">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="6846415332-7">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">conn</span><span class="p" data-group-id="6846415332-7">}</span><span class="w">

    </span><span class="p" data-group-id="6846415332-8">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="ss">:no_relay</span><span class="p" data-group-id="6846415332-8">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="c1"># No relay available, try direct with longer timeout</span><span class="w">
      </span><span class="nc">:macula_nat_connector</span><span class="o">.</span><span class="n">connect</span><span class="p" data-group-id="6846415332-9">(</span><span class="n">target_node_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="6846415332-10">%{</span><span class="w">
        </span><span class="ss">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">30_000</span><span class="p">,</span><span class="w">
        </span><span class="ss">fallback_relay</span><span class="p">:</span><span class="w"> </span><span class="no">false</span><span class="p">,</span><span class="w">
        </span><span class="ss">max_attempts</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
      </span><span class="p" data-group-id="6846415332-10">}</span><span class="p" data-group-id="6846415332-9">)</span><span class="w">

    </span><span class="p" data-group-id="6846415332-11">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="6846415332-11">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
      </span><span class="p" data-group-id="6846415332-12">{</span><span class="ss">:error</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p" data-group-id="6846415332-12">}</span><span class="w">
  </span><span class="k" data-group-id="6846415332-5">end</span><span class="w">
</span><span class="k" data-group-id="6846415332-2">end</span></code></pre><hr class="thin"/><h2 id="performance-considerations" class="section-heading"><a href="#performance-considerations" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Performance Considerations</span></h2><h3 id="nat-detection-timing" class="section-heading"><a href="#nat-detection-timing" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">NAT Detection Timing</span></h3><table><thead><tr><th style="text-align: left;">Operation</th><th style="text-align: left;">Typical Latency</th></tr></thead><tbody><tr><td style="text-align: left;">Cached profile lookup</td><td style="text-align: left;">&lt; 1ms</td></tr><tr><td style="text-align: left;">Fresh detection (2 observers)</td><td style="text-align: left;">200-400ms</td></tr><tr><td style="text-align: left;">DHT profile fetch</td><td style="text-align: left;">100-300ms</td></tr><tr><td style="text-align: left;">Hole punch coordination</td><td style="text-align: left;">200-500ms</td></tr></tbody></table><h3 id="caching-strategy" class="section-heading"><a href="#caching-strategy" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Caching Strategy</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Pre-warm cache for known peers at startup</span><span class="w">
</span><span class="nf">prewarm_nat_cache</span><span class="p" data-group-id="5347681129-1">(</span><span class="n">KnownPeers</span><span class="p" data-group-id="5347681129-1">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
    </span><span class="nc">lists</span><span class="p">:</span><span class="nf">foreach</span><span class="p" data-group-id="5347681129-2">(</span><span class="w">
        </span><span class="nf">fun</span><span class="p" data-group-id="5347681129-3">(</span><span class="n">PeerId</span><span class="p" data-group-id="5347681129-3">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w">
            </span><span class="nf">spawn</span><span class="p" data-group-id="5347681129-4">(</span><span class="nf">fun</span><span class="p" data-group-id="5347681129-5">(</span><span class="p" data-group-id="5347681129-5">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">get_from_dht</span><span class="p" data-group-id="5347681129-6">(</span><span class="n">PeerId</span><span class="p" data-group-id="5347681129-6">)</span><span class="w"> </span><span class="k">end</span><span class="p" data-group-id="5347681129-4">)</span><span class="w">
        </span><span class="k">end</span><span class="p">,</span><span class="w">
        </span><span class="n">KnownPeers</span><span class="w">
    </span><span class="p" data-group-id="5347681129-2">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Pre-warm cache for known peers at startup</span><span class="w">
</span><span class="kd">def</span><span class="w"> </span><span class="nf">prewarm_nat_cache</span><span class="p" data-group-id="6824772125-1">(</span><span class="n">known_peers</span><span class="p" data-group-id="6824772125-1">)</span><span class="w"> </span><span class="k" data-group-id="6824772125-2">do</span><span class="w">
  </span><span class="n">known_peers</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Task</span><span class="o">.</span><span class="n">async_stream</span><span class="p" data-group-id="6824772125-3">(</span><span class="k" data-group-id="6824772125-4">fn</span><span class="w"> </span><span class="n">peer_id</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
    </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">get_from_dht</span><span class="p" data-group-id="6824772125-5">(</span><span class="n">peer_id</span><span class="p" data-group-id="6824772125-5">)</span><span class="w">
  </span><span class="k" data-group-id="6824772125-4">end</span><span class="p">,</span><span class="w"> </span><span class="ss">max_concurrency</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p" data-group-id="6824772125-3">)</span><span class="w">
  </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Stream</span><span class="o">.</span><span class="n">run</span><span class="p" data-group-id="6824772125-6">(</span><span class="p" data-group-id="6824772125-6">)</span><span class="w">
</span><span class="k" data-group-id="6824772125-2">end</span></code></pre><hr class="thin"/><h2 id="debugging" class="section-heading"><a href="#debugging" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Debugging</span></h2><h3 id="logging-nat-events" class="section-heading"><a href="#logging-nat-events" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Logging NAT Events</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Enable debug logging for NAT system</span><span class="w">
</span><span class="nc">logger</span><span class="p">:</span><span class="nf">set_module_level</span><span class="p" data-group-id="2154943759-1">(</span><span class="ss">macula_nat_detector</span><span class="p">,</span><span class="w"> </span><span class="ss">debug</span><span class="p" data-group-id="2154943759-1">)</span><span class="p">,</span><span class="w">
</span><span class="nc">logger</span><span class="p">:</span><span class="nf">set_module_level</span><span class="p" data-group-id="2154943759-2">(</span><span class="ss">macula_nat_coordinator</span><span class="p">,</span><span class="w"> </span><span class="ss">debug</span><span class="p" data-group-id="2154943759-2">)</span><span class="p">,</span><span class="w">
</span><span class="nc">logger</span><span class="p">:</span><span class="nf">set_module_level</span><span class="p" data-group-id="2154943759-3">(</span><span class="ss">macula_nat_connector</span><span class="p">,</span><span class="w"> </span><span class="ss">debug</span><span class="p" data-group-id="2154943759-3">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Enable debug logging for NAT system</span><span class="w">
</span><span class="nc">Logger</span><span class="o">.</span><span class="n">configure</span><span class="p" data-group-id="3280888505-1">(</span><span class="ss">level</span><span class="p">:</span><span class="w"> </span><span class="ss">:debug</span><span class="p" data-group-id="3280888505-1">)</span><span class="w">

</span><span class="c1"># Or configure specific modules in config/dev.exs</span><span class="w">
</span><span class="n">config</span><span class="w"> </span><span class="ss">:logger</span><span class="p">,</span><span class="w"> </span><span class="ss">:console</span><span class="p">,</span><span class="w">
  </span><span class="ss">metadata</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="3280888505-2">[</span><span class="ss">:module</span><span class="p" data-group-id="3280888505-2">]</span><span class="p">,</span><span class="w">
  </span><span class="ss">format</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;$time $metadata[$level] $message</span><span class="se">\n</span><span class="s">&quot;</span></code></pre><h3 id="inspecting-nat-state" class="section-heading"><a href="#inspecting-nat-state" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">Inspecting NAT State</span></h3><p><strong>Erlang:</strong></p><pre><code class="makeup erlang" translate="no"><span class="c1">%% Get current NAT profile</span><span class="w">
</span><span class="p" data-group-id="4183836571-1">{</span><span class="ss">ok</span><span class="p">,</span><span class="w"> </span><span class="n">Profile</span><span class="p" data-group-id="4183836571-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_detector</span><span class="p">:</span><span class="nf">get_local_profile</span><span class="p" data-group-id="4183836571-2">(</span><span class="p" data-group-id="4183836571-2">)</span><span class="p">,</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="4183836571-3">(</span><span class="s">&quot;NAT Profile: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4183836571-4">[</span><span class="n">Profile</span><span class="p" data-group-id="4183836571-4">]</span><span class="p" data-group-id="4183836571-3">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% Check cache stats</span><span class="w">
</span><span class="n">Stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_cache</span><span class="p">:</span><span class="nf">stats</span><span class="p" data-group-id="4183836571-5">(</span><span class="p" data-group-id="4183836571-5">)</span><span class="p">,</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="4183836571-6">(</span><span class="s">&quot;Cache Stats: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4183836571-7">[</span><span class="n">Stats</span><span class="p" data-group-id="4183836571-7">]</span><span class="p" data-group-id="4183836571-6">)</span><span class="p">.</span><span class="w">

</span><span class="c1">%% List pending punch attempts</span><span class="w">
</span><span class="n">Pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">macula_nat_coordinator</span><span class="p">:</span><span class="nf">get_pending</span><span class="p" data-group-id="4183836571-8">(</span><span class="p" data-group-id="4183836571-8">)</span><span class="p">,</span><span class="w">
</span><span class="nc">io</span><span class="p">:</span><span class="nf">format</span><span class="p" data-group-id="4183836571-9">(</span><span class="s">&quot;Pending Punches: </span><span class="si">~p</span><span class="si">~n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4183836571-10">[</span><span class="n">Pending</span><span class="p" data-group-id="4183836571-10">]</span><span class="p" data-group-id="4183836571-9">)</span><span class="p">.</span></code></pre><p><strong>Elixir:</strong></p><pre><code class="makeup elixir" translate="no"><span class="c1"># Get current NAT profile</span><span class="w">
</span><span class="p" data-group-id="6031926421-1">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">profile</span><span class="p" data-group-id="6031926421-1">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_detector</span><span class="o">.</span><span class="n">get_local_profile</span><span class="p" data-group-id="6031926421-2">(</span><span class="p" data-group-id="6031926421-2">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="6031926421-3">(</span><span class="n">profile</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NAT Profile&quot;</span><span class="p" data-group-id="6031926421-3">)</span><span class="w">

</span><span class="c1"># Check cache stats</span><span class="w">
</span><span class="n">stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_cache</span><span class="o">.</span><span class="n">stats</span><span class="p" data-group-id="6031926421-4">(</span><span class="p" data-group-id="6031926421-4">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="6031926421-5">(</span><span class="n">stats</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Cache Stats&quot;</span><span class="p" data-group-id="6031926421-5">)</span><span class="w">

</span><span class="c1"># List pending punch attempts</span><span class="w">
</span><span class="n">pending</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:macula_nat_coordinator</span><span class="o">.</span><span class="n">get_pending</span><span class="p" data-group-id="6031926421-6">(</span><span class="p" data-group-id="6031926421-6">)</span><span class="w">
</span><span class="nc">IO</span><span class="o">.</span><span class="n">inspect</span><span class="p" data-group-id="6031926421-7">(</span><span class="n">pending</span><span class="p">,</span><span class="w"> </span><span class="ss">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Pending Punches&quot;</span><span class="p" data-group-id="6031926421-7">)</span></code></pre><hr class="thin"/><h2 id="see-also" class="section-heading"><a href="#see-also" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i></a><span class="text">See Also</span></h2><ul><li><a href="nat_types_explained.html">NAT Types Explained</a> - Background on NAT types</li></ul>

</div>

<div class="bottom-actions" id="bottom-actions">
  <div class="bottom-actions-item">

      <a href="nat_types_explained.html" class="bottom-actions-button" rel="prev">
        <span class="subheader">
          â† Previous Page
        </span>
        <span class="title">
NAT Types
        </span>
      </a>

  </div>
  <div class="bottom-actions-item">

      <a href="full_supervision_tree.html" class="bottom-actions-button" rel="next">
        <span class="subheader">
          Next Page â†’
        </span>
        <span class="title">
Supervision Tree
        </span>
      </a>

  </div>
</div>
    <footer class="footer">
      <p>

          <span class="line">
            <a href="https://hex.pm/packages/macula/0.12.6" class="footer-hex-package">Hex Package</a>

            <a href="https://preview.hex.pm/preview/macula/0.12.6">Hex Preview</a>

              (<a href="https://preview.hex.pm/preview/macula/0.12.6/show/docs/guides/NAT_TRAVERSAL_DEVELOPER_GUIDE.md">current file</a>)

          </span>

        <span class="line">
          <button class="a-main footer-button display-quick-switch" title="Search HexDocs packages">
            Search HexDocs
          </button>

            <a href="macula.epub" title="ePub version">
              Download ePub version
            </a>

        </span>
      </p>

      <p class="built-using">
        Built using
        <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.38.2) for the

          <a href="https://erlang.org" title="Erlang" target="_blank" translate="no">Erlang programming language</a>

      </p>

    </footer>
  </div>
</main>
</div>

  </body>
</html>
