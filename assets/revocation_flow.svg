<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 500" width="800" height="500">
  <defs>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444"/>
    </marker>
    <marker id="arrowGray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#6B7280"/>
    </marker>
    <linearGradient id="issuerGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#1D4ED8;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="nodeGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#6D28D9;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="cacheGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="800" height="500" fill="#F9FAFB"/>

  <!-- Title -->
  <text x="400" y="35" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="600" fill="#111827">UCAN Revocation Flow</text>
  <text x="400" y="55" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="12" fill="#6B7280">Distributed revocation via PubSub gossip with local ETS caching</text>

  <!-- Step 1: Issuer Revokes -->
  <rect x="50" y="85" width="150" height="80" rx="8" fill="url(#issuerGrad)"/>
  <text x="125" y="115" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="600" fill="white">Token Issuer</text>
  <text x="125" y="135" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#BFDBFE">did:macula:io.macula</text>
  <text x="125" y="150" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#BFDBFE">.rgfaber</text>

  <!-- Step 1 Label -->
  <circle cx="55" cy="90" r="12" fill="#EF4444"/>
  <text x="55" y="94" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="700" fill="white">1</text>

  <!-- Revocation message -->
  <rect x="230" y="85" width="180" height="80" rx="8" fill="white" stroke="#EF4444" stroke-width="2"/>
  <text x="320" y="108" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#DC2626">Revocation Message</text>
  <text x="245" y="128" font-family="monospace" font-size="9" fill="#374151">issuer_did: "did:macula:..."</text>
  <text x="245" y="142" font-family="monospace" font-size="9" fill="#374151">ucan_cid: "bafyrei..."</text>
  <text x="245" y="156" font-family="monospace" font-size="9" fill="#374151">signature: &lt;Ed25519&gt;</text>

  <!-- Arrow to message -->
  <line x1="200" y1="125" x2="225" y2="125" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="212" y="115" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#EF4444">revoke()</text>

  <!-- PubSub Topic -->
  <rect x="440" y="85" width="200" height="80" rx="8" fill="#FEE2E2" stroke="#EF4444" stroke-width="2"/>
  <text x="540" y="115" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#DC2626">System Topic</text>
  <text x="540" y="135" text-anchor="middle" font-family="monospace" font-size="10" fill="#7F1D1D">io.macula.system</text>
  <text x="540" y="150" text-anchor="middle" font-family="monospace" font-size="10" fill="#7F1D1D">.ucan_revoked</text>

  <!-- Arrow to topic -->
  <line x1="410" y1="125" x2="435" y2="125" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <text x="422" y="115" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#EF4444">publish</text>

  <!-- Step 2: Broadcast to nodes -->
  <circle cx="445" cy="90" r="12" fill="#EF4444"/>
  <text x="445" y="94" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="700" fill="white">2</text>

  <!-- Node 1 -->
  <rect x="100" y="220" width="120" height="70" rx="8" fill="url(#nodeGrad)"/>
  <text x="160" y="250" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="white">Node A</text>
  <text x="160" y="268" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#DDD6FE">Mesh Peer</text>

  <!-- Node 2 -->
  <rect x="340" y="220" width="120" height="70" rx="8" fill="url(#nodeGrad)"/>
  <text x="400" y="250" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="white">Node B</text>
  <text x="400" y="268" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#DDD6FE">Mesh Peer</text>

  <!-- Node 3 -->
  <rect x="580" y="220" width="120" height="70" rx="8" fill="url(#nodeGrad)"/>
  <text x="640" y="250" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="white">Node C</text>
  <text x="640" y="268" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#DDD6FE">Mesh Peer</text>

  <!-- Broadcast arrows -->
  <line x1="540" y1="165" x2="160" y2="215" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <line x1="540" y1="165" x2="400" y2="215" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>
  <line x1="540" y1="165" x2="640" y2="215" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed)"/>

  <!-- Step 3: Validate and cache -->
  <circle cx="105" cy="225" r="12" fill="#EF4444"/>
  <text x="105" y="229" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="700" fill="white">3</text>

  <!-- Validation box -->
  <rect x="100" y="310" width="160" height="55" rx="6" fill="#F3F4F6" stroke="#D1D5DB" stroke-width="1"/>
  <text x="180" y="332" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="600" fill="#374151">Validate Signature</text>
  <text x="180" y="350" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Ed25519 verify(issuer_pubkey)</text>

  <!-- Arrow to validation -->
  <line x1="160" y1="290" x2="160" y2="305" stroke="#6B7280" stroke-width="2" marker-end="url(#arrowGray)"/>

  <!-- ETS Cache -->
  <rect x="100" y="385" width="160" height="70" rx="8" fill="url(#cacheGrad)"/>
  <text x="180" y="412" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="white">ETS Cache</text>
  <text x="180" y="428" text-anchor="middle" font-family="monospace" font-size="9" fill="#FEF3C7">macula_revocation_cache</text>
  <text x="180" y="445" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#FEF3C7">Key: {issuer_did, cid}</text>

  <!-- Arrow to cache -->
  <line x1="180" y1="365" x2="180" y2="380" stroke="#6B7280" stroke-width="2" marker-end="url(#arrowGray)"/>
  <text x="190" y="375" font-family="Inter, system-ui, sans-serif" font-size="8" fill="#10B981">valid</text>

  <!-- Step 4: Auth check -->
  <circle cx="295" cy="320" r="12" fill="#EF4444"/>
  <text x="295" y="324" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="700" fill="white">4</text>

  <!-- Auth check box -->
  <rect x="310" y="310" width="180" height="100" rx="8" fill="white" stroke="#10B981" stroke-width="2"/>
  <text x="400" y="335" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#059669">Authorization Check</text>
  <text x="320" y="358" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#374151">1. Parse UCAN token</text>
  <text x="320" y="373" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#374151">2. Compute CID (SHA-256)</text>
  <text x="320" y="388" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#374151">3. Check cache: is_revoked?</text>
  <text x="320" y="403" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#EF4444">4. If revoked â†’ DENY</text>

  <!-- Arrow from cache to auth -->
  <line x1="260" y1="420" x2="305" y2="380" stroke="#6B7280" stroke-width="2" marker-end="url(#arrowGray)"/>
  <text x="275" y="395" font-family="Inter, system-ui, sans-serif" font-size="8" fill="#6B7280">O(1) lookup</text>

  <!-- Properties -->
  <rect x="520" y="310" width="230" height="145" rx="8" fill="white" stroke="#E5E7EB" stroke-width="1"/>
  <text x="635" y="335" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="12" font-weight="600" fill="#111827">Safeguards</text>

  <circle cx="540" cy="355" r="5" fill="#10B981"/>
  <text x="555" y="359" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Only issuer can revoke</text>

  <circle cx="540" cy="375" r="5" fill="#3B82F6"/>
  <text x="555" y="379" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Rate limit: 10/min/issuer</text>

  <circle cx="540" cy="395" r="5" fill="#F59E0B"/>
  <text x="555" y="399" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Auto-expire at UCAN exp</text>

  <circle cx="540" cy="415" r="5" fill="#8B5CF6"/>
  <text x="555" y="419" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Ed25519 signature required</text>

  <circle cx="540" cy="435" r="5" fill="#EF4444"/>
  <text x="555" y="439" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Cleanup every 60 seconds</text>
</svg>
