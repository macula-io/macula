<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 650" width="900" height="650">
  <defs>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3B82F6"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10B981"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#EF4444"/>
    </marker>
    <linearGradient id="natGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#F59E0B;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#D97706;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="clientGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#1D4ED8;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="serverGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="900" height="650" fill="#F9FAFB"/>

  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="20" font-weight="600" fill="#111827">NAT Types and Their Impact on P2P Connectivity</text>
  <text x="450" y="50" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="12" fill="#6B7280">RFC 3489 NAT classification - from easiest to hardest for hole punching</text>

  <!-- Full Cone NAT -->
  <rect x="20" y="70" width="420" height="130" rx="8" fill="white" stroke="#10B981" stroke-width="2"/>
  <rect x="20" y="70" width="420" height="28" rx="8" fill="#ECFDF5"/>
  <text x="230" y="90" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="13" font-weight="600" fill="#047857">1. Full Cone NAT (Easiest)</text>

  <!-- Full Cone Diagram -->
  <rect x="40" y="110" width="60" height="35" rx="4" fill="url(#clientGrad)"/>
  <text x="70" y="132" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Client</text>
  <text x="70" y="155" font-family="monospace" font-size="8" fill="#6B7280">10.0.0.1:5000</text>

  <rect x="140" y="105" width="70" height="45" rx="4" fill="url(#natGrad)"/>
  <text x="175" y="125" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">NAT</text>
  <text x="175" y="140" text-anchor="middle" font-family="monospace" font-size="8" fill="white">1:1 map</text>

  <rect x="250" y="110" width="60" height="35" rx="4" fill="url(#serverGrad)"/>
  <text x="280" y="132" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Server A</text>

  <rect x="330" y="110" width="60" height="35" rx="4" fill="url(#serverGrad)"/>
  <text x="360" y="132" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Any Host</text>

  <line x1="100" y1="127" x2="135" y2="127" stroke="#3B82F6" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
  <line x1="210" y1="127" x2="245" y2="127" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <line x1="245" y1="127" x2="210" y2="127" stroke="#10B981" stroke-width="1.5"/>
  <line x1="330" y1="137" x2="215" y2="137" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <text x="230" y="180" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">External port always maps to same internal. Any host can send inbound.</text>

  <!-- Restricted Cone NAT -->
  <rect x="460" y="70" width="420" height="130" rx="8" fill="white" stroke="#F59E0B" stroke-width="2"/>
  <rect x="460" y="70" width="420" height="28" rx="8" fill="#FFFBEB"/>
  <text x="670" y="90" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="13" font-weight="600" fill="#B45309">2. Restricted Cone NAT</text>

  <!-- Restricted Cone Diagram -->
  <rect x="480" y="110" width="60" height="35" rx="4" fill="url(#clientGrad)"/>
  <text x="510" y="132" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Client</text>

  <rect x="580" y="105" width="70" height="45" rx="4" fill="url(#natGrad)"/>
  <text x="615" y="125" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">NAT</text>
  <text x="615" y="140" text-anchor="middle" font-family="monospace" font-size="8" fill="white">IP filter</text>

  <rect x="690" y="110" width="60" height="35" rx="4" fill="url(#serverGrad)"/>
  <text x="720" y="132" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Server A</text>

  <rect x="770" y="110" width="60" height="35" rx="4" fill="#FEE2E2" stroke="#EF4444" stroke-width="1"/>
  <text x="800" y="127" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#B91C1C">Other IP</text>
  <text x="800" y="139" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="8" fill="#B91C1C">BLOCKED</text>

  <line x1="540" y1="127" x2="575" y2="127" stroke="#3B82F6" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
  <line x1="650" y1="127" x2="685" y2="127" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <line x1="685" y1="127" x2="650" y2="127" stroke="#10B981" stroke-width="1.5"/>
  <line x1="770" y1="137" x2="655" y2="137" stroke="#EF4444" stroke-width="1.5" stroke-dasharray="4"/>

  <text x="670" y="180" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Only hosts we've sent to can reply. IP must match.</text>

  <!-- Port Restricted Cone NAT -->
  <rect x="20" y="215" width="420" height="130" rx="8" fill="white" stroke="#F97316" stroke-width="2"/>
  <rect x="20" y="215" width="420" height="28" rx="8" fill="#FFF7ED"/>
  <text x="230" y="235" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="13" font-weight="600" fill="#C2410C">3. Port Restricted Cone NAT</text>

  <!-- Port Restricted Diagram -->
  <rect x="40" y="255" width="60" height="35" rx="4" fill="url(#clientGrad)"/>
  <text x="70" y="277" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Client</text>

  <rect x="140" y="250" width="70" height="45" rx="4" fill="url(#natGrad)"/>
  <text x="175" y="270" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">NAT</text>
  <text x="175" y="285" text-anchor="middle" font-family="monospace" font-size="8" fill="white">IP:Port</text>

  <rect x="250" y="255" width="60" height="35" rx="4" fill="url(#serverGrad)"/>
  <text x="280" y="272" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">A:8080</text>

  <rect x="330" y="255" width="60" height="35" rx="4" fill="#FEE2E2" stroke="#EF4444" stroke-width="1"/>
  <text x="360" y="272" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#B91C1C">A:9090</text>
  <text x="360" y="284" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="8" fill="#B91C1C">BLOCKED</text>

  <line x1="100" y1="272" x2="135" y2="272" stroke="#3B82F6" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
  <line x1="210" y1="272" x2="245" y2="272" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <line x1="245" y1="272" x2="210" y2="272" stroke="#10B981" stroke-width="1.5"/>
  <line x1="330" y1="282" x2="215" y2="282" stroke="#EF4444" stroke-width="1.5" stroke-dasharray="4"/>

  <text x="230" y="325" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Both IP AND port must match. Same server, different port = blocked.</text>

  <!-- Symmetric NAT -->
  <rect x="460" y="215" width="420" height="130" rx="8" fill="white" stroke="#EF4444" stroke-width="2"/>
  <rect x="460" y="215" width="420" height="28" rx="8" fill="#FEF2F2"/>
  <text x="670" y="235" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="13" font-weight="600" fill="#B91C1C">4. Symmetric NAT (Hardest)</text>

  <!-- Symmetric Diagram -->
  <rect x="480" y="255" width="60" height="35" rx="4" fill="url(#clientGrad)"/>
  <text x="510" y="277" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">Client</text>

  <rect x="580" y="250" width="70" height="45" rx="4" fill="url(#natGrad)"/>
  <text x="615" y="270" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">NAT</text>
  <text x="615" y="285" text-anchor="middle" font-family="monospace" font-size="8" fill="white">per-dest</text>

  <rect x="690" y="250" width="60" height="25" rx="4" fill="url(#serverGrad)"/>
  <text x="720" y="267" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">A</text>
  <text x="760" y="267" font-family="monospace" font-size="8" fill="#6B7280">:4001</text>

  <rect x="690" y="280" width="60" height="25" rx="4" fill="url(#serverGrad)"/>
  <text x="720" y="297" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="white">B</text>
  <text x="760" y="297" font-family="monospace" font-size="8" fill="#6B7280">:4002</text>

  <line x1="540" y1="272" x2="575" y2="272" stroke="#3B82F6" stroke-width="1.5" marker-end="url(#arrowBlue)"/>
  <line x1="650" y1="262" x2="685" y2="262" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
  <line x1="650" y1="292" x2="685" y2="292" stroke="#10B981" stroke-width="1.5" marker-end="url(#arrowGreen)"/>

  <text x="670" y="325" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Different external port for each destination. Unpredictable!</text>

  <!-- Compatibility Matrix -->
  <rect x="20" y="360" width="420" height="270" rx="8" fill="white" stroke="#E5E7EB" stroke-width="1"/>
  <text x="230" y="385" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600" fill="#111827">P2P Connectivity Matrix</text>

  <!-- Matrix Header -->
  <text x="160" y="415" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="600" fill="#374151">Peer A</text>
  <line x1="100" y1="425" x2="380" y2="425" stroke="#E5E7EB" stroke-width="1"/>
  <line x1="100" y1="425" x2="100" y2="605" stroke="#E5E7EB" stroke-width="1"/>

  <!-- Column headers -->
  <text x="140" y="445" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Full</text>
  <text x="200" y="445" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Restr</text>
  <text x="260" y="445" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Port-R</text>
  <text x="320" y="445" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Symm</text>

  <!-- Row headers -->
  <text x="60" y="475" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Full</text>
  <text x="60" y="515" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Restr</text>
  <text x="60" y="555" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Port-R</text>
  <text x="60" y="595" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#6B7280">Symm</text>

  <text x="35" y="535" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" font-weight="600" fill="#374151" transform="rotate(-90 35 535)">Peer B</text>

  <!-- Matrix cells - Full row -->
  <circle cx="140" cy="470" r="12" fill="#10B981"/>
  <text x="140" y="475" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="200" cy="470" r="12" fill="#10B981"/>
  <text x="200" y="475" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="260" cy="470" r="12" fill="#10B981"/>
  <text x="260" y="475" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="320" cy="470" r="12" fill="#10B981"/>
  <text x="320" y="475" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>

  <!-- Matrix cells - Restricted row -->
  <circle cx="140" cy="510" r="12" fill="#10B981"/>
  <text x="140" y="515" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="200" cy="510" r="12" fill="#10B981"/>
  <text x="200" y="515" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="260" cy="510" r="12" fill="#10B981"/>
  <text x="260" y="515" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="320" cy="510" r="12" fill="#F59E0B"/>
  <text x="320" y="515" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">R</text>

  <!-- Matrix cells - Port Restricted row -->
  <circle cx="140" cy="550" r="12" fill="#10B981"/>
  <text x="140" y="555" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="200" cy="550" r="12" fill="#10B981"/>
  <text x="200" y="555" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="260" cy="550" r="12" fill="#10B981"/>
  <text x="260" y="555" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="320" cy="550" r="12" fill="#F59E0B"/>
  <text x="320" y="555" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">R</text>

  <!-- Matrix cells - Symmetric row -->
  <circle cx="140" cy="590" r="12" fill="#10B981"/>
  <text x="140" y="595" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2713;</text>
  <circle cx="200" cy="590" r="12" fill="#F59E0B"/>
  <text x="200" y="595" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">R</text>
  <circle cx="260" cy="590" r="12" fill="#F59E0B"/>
  <text x="260" y="595" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">R</text>
  <circle cx="320" cy="590" r="12" fill="#EF4444"/>
  <text x="320" y="595" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="10" fill="white">&#x2717;</text>

  <!-- Legend -->
  <rect x="380" y="495" width="50" height="70" rx="4" fill="#F9FAFB"/>
  <circle cx="395" cy="515" r="8" fill="#10B981"/>
  <text x="410" y="519" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#374151">Direct</text>
  <circle cx="395" cy="535" r="8" fill="#F59E0B"/>
  <text x="410" y="539" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#374151">Relay</text>
  <circle cx="395" cy="555" r="8" fill="#EF4444"/>
  <text x="410" y="559" font-family="Inter, system-ui, sans-serif" font-size="9" fill="#374151">Hard</text>

  <!-- Macula Solution -->
  <rect x="460" y="360" width="420" height="270" rx="8" fill="white" stroke="#3B82F6" stroke-width="2"/>
  <text x="670" y="385" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="14" font-weight="600" fill="#1D4ED8">Macula NAT Traversal Strategy</text>

  <!-- Strategy 1: Detection -->
  <rect x="480" y="400" width="380" height="55" rx="6" fill="#EFF6FF" stroke="#3B82F6" stroke-width="1"/>
  <circle cx="500" cy="427" r="14" fill="#3B82F6"/>
  <text x="500" y="432" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="white">1</text>
  <text x="525" y="420" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#1D4ED8">NAT Type Detection</text>
  <text x="525" y="440" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">STUN-like probing via macula_nat_detector</text>

  <!-- Strategy 2: Hole Punch -->
  <rect x="480" y="465" width="380" height="55" rx="6" fill="#ECFDF5" stroke="#10B981" stroke-width="1"/>
  <circle cx="500" cy="492" r="14" fill="#10B981"/>
  <text x="500" y="497" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="white">2</text>
  <text x="525" y="485" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#047857">Coordinated Hole Punching</text>
  <text x="525" y="505" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Simultaneous UDP via macula_hole_punch (adaptive timing)</text>

  <!-- Strategy 3: Relay -->
  <rect x="480" y="530" width="380" height="55" rx="6" fill="#FFFBEB" stroke="#F59E0B" stroke-width="1"/>
  <circle cx="500" cy="557" r="14" fill="#F59E0B"/>
  <text x="500" y="562" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="700" fill="white">3</text>
  <text x="525" y="550" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#B45309">Hierarchical Relay Fallback</text>
  <text x="525" y="570" font-family="Inter, system-ui, sans-serif" font-size="10" fill="#374151">Gateway relay via macula_relay_registry (load-based)</text>

  <!-- Result -->
  <rect x="480" y="595" width="380" height="25" rx="4" fill="#F0FDF4"/>
  <text x="670" y="612" text-anchor="middle" font-family="Inter, system-ui, sans-serif" font-size="11" font-weight="600" fill="#15803D">Result: 80%+ direct connections in typical networks</text>
</svg>
