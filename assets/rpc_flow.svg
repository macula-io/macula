<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 750">
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#4b5563"/>
    </marker>
    <marker id="arrowhead-call" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <marker id="arrowhead-reply" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
    <marker id="arrowhead-dht" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8b5cf6"/>
    </marker>
    <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1"/>
      <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1"/>
    </linearGradient>
    <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="2" dy="2" stdDeviation="2" flood-opacity="0.15"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="900" height="750" fill="#f8fafc"/>

  <!-- Header -->
  <rect x="0" y="0" width="900" height="50" fill="url(#headerGrad)"/>
  <text x="450" y="32" text-anchor="middle" fill="white" font-family="system-ui" font-size="18" font-weight="bold">Decentralized RPC with DHT Service Discovery</text>

  <!-- Legend -->
  <rect x="670" y="60" width="210" height="95" rx="6" fill="white" stroke="#e5e7eb" filter="url(#shadow)"/>
  <text x="680" y="80" font-family="system-ui" font-size="11" font-weight="600" fill="#374151">Legend</text>
  <line x1="680" y1="97" x2="710" y2="97" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead-call)"/>
  <text x="720" y="101" font-family="system-ui" font-size="10" fill="#6b7280">RPC Call</text>
  <line x1="680" y1="117" x2="710" y2="117" stroke="#10b981" stroke-width="2" marker-end="url(#arrowhead-reply)"/>
  <text x="720" y="121" font-family="system-ui" font-size="10" fill="#6b7280">RPC Reply</text>
  <line x1="680" y1="137" x2="710" y2="137" stroke="#8b5cf6" stroke-width="2" marker-end="url(#arrowhead-dht)"/>
  <text x="720" y="141" font-family="system-ui" font-size="10" fill="#6b7280">DHT Operation</text>

  <!-- Section 1: 4-Tier Discovery Hierarchy -->
  <rect x="20" y="60" width="320" height="200" rx="8" fill="#eef2ff" stroke="#a5b4fc" stroke-width="1.5"/>
  <text x="35" y="85" font-family="system-ui" font-size="14" font-weight="600" fill="#4338ca">Discovery Hierarchy (4-Tier)</text>

  <!-- Tier 1: Local -->
  <rect x="40" y="100" width="280" height="35" rx="4" fill="#fef9c3" stroke="#facc15" stroke-width="2"/>
  <text x="50" y="117" font-family="system-ui" font-size="9" font-weight="bold" fill="#a16207">1</text>
  <text x="65" y="117" font-family="system-ui" font-size="11" font-weight="500" fill="#a16207">Local Handler</text>
  <text x="180" y="117" font-family="system-ui" font-size="10" fill="#ca8a04">‚ö° Zero latency</text>
  <text x="180" y="128" font-family="system-ui" font-size="8" fill="#92400e">Same-process execution</text>

  <!-- Tier 2: Cache -->
  <rect x="40" y="140" width="280" height="35" rx="4" fill="#d1fae5" stroke="#6ee7b7" stroke-width="2"/>
  <text x="50" y="157" font-family="system-ui" font-size="9" font-weight="bold" fill="#047857">2</text>
  <text x="65" y="157" font-family="system-ui" font-size="11" font-weight="500" fill="#047857">Cache Hit</text>
  <text x="180" y="157" font-family="system-ui" font-size="10" fill="#059669">üöÄ Sub-millisecond</text>
  <text x="180" y="168" font-family="system-ui" font-size="8" fill="#047857">ETS lookup (60s TTL)</text>

  <!-- Tier 3: DHT -->
  <rect x="40" y="180" width="280" height="35" rx="4" fill="#ede9fe" stroke="#a78bfa" stroke-width="2"/>
  <text x="50" y="197" font-family="system-ui" font-size="9" font-weight="bold" fill="#6d28d9">3</text>
  <text x="65" y="197" font-family="system-ui" font-size="11" font-weight="500" fill="#6d28d9">DHT Query</text>
  <text x="180" y="197" font-family="system-ui" font-size="10" fill="#7c3aed">üåê 50-100ms</text>
  <text x="180" y="208" font-family="system-ui" font-size="8" fill="#6d28d9">Network query, cache result</text>

  <!-- Tier 4: Direct -->
  <rect x="40" y="220" width="280" height="35" rx="4" fill="#dbeafe" stroke="#93c5fd" stroke-width="2"/>
  <text x="50" y="237" font-family="system-ui" font-size="9" font-weight="bold" fill="#1e40af">4</text>
  <text x="65" y="237" font-family="system-ui" font-size="11" font-weight="500" fill="#1e40af">Direct Call</text>
  <text x="180" y="237" font-family="system-ui" font-size="10" fill="#2563eb">üîó Fallback</text>
  <text x="180" y="248" font-family="system-ui" font-size="8" fill="#1e40af">Connected endpoint</text>

  <!-- Section 2: Service Advertisement -->
  <rect x="360" y="60" width="290" height="200" rx="8" fill="#fff7ed" stroke="#fed7aa" stroke-width="1.5"/>
  <text x="375" y="85" font-family="system-ui" font-size="14" font-weight="600" fill="#c2410c">Service Advertisement</text>

  <!-- Provider node -->
  <rect x="380" y="105" width="110" height="45" rx="6" fill="white" stroke="#f97316" stroke-width="2" filter="url(#shadow)"/>
  <text x="435" y="125" text-anchor="middle" font-family="system-ui" font-size="11" font-weight="500" fill="#c2410c">Provider</text>
  <text x="435" y="140" text-anchor="middle" font-family="system-ui" font-size="9" fill="#6b7280">Node A</text>

  <!-- Local registry -->
  <rect x="380" y="165" width="110" height="35" rx="4" fill="#ffedd5" stroke="#fdba74"/>
  <text x="435" y="187" text-anchor="middle" font-family="system-ui" font-size="9" font-weight="500" fill="#c2410c">Local Registry</text>

  <!-- DHT for advertisement -->
  <ellipse cx="570" cy="145" rx="45" ry="35" fill="#ede9fe" stroke="#8b5cf6" stroke-width="2"/>
  <text x="570" y="142" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#6d28d9">Kademlia</text>
  <text x="570" y="156" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#6d28d9">DHT</text>

  <!-- Arrows -->
  <line x1="435" y1="150" x2="435" y2="162" stroke="#f97316" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <text x="445" y="158" font-family="system-ui" font-size="8" fill="#ea580c">store</text>

  <line x1="490" y1="127" x2="520" y2="140" stroke="#8b5cf6" stroke-width="1.5" marker-end="url(#arrowhead-dht)"/>
  <text x="503" y="125" font-family="system-ui" font-size="8" fill="#7c3aed">publish</text>

  <!-- DHT entry detail -->
  <rect x="380" y="210" width="250" height="45" rx="4" fill="white" stroke="#e5e7eb"/>
  <text x="390" y="227" font-family="system-ui" font-size="8" font-weight="500" fill="#374151">DHT Entry (SHA256(procedure) ‚Üí value)</text>
  <text x="390" y="242" font-family="system-ui" font-size="7" fill="#6b7280">{node_id, endpoint, metadata, ttl, advertised_at}</text>

  <!-- Section 3: RPC Call Flow -->
  <rect x="20" y="280" width="860" height="220" rx="8" fill="white" stroke="#e5e7eb" stroke-width="1.5" filter="url(#shadow)"/>
  <text x="40" y="305" font-family="system-ui" font-size="14" font-weight="600" fill="#374151">RPC Call Flow</text>

  <!-- Timeline -->
  <line x1="60" y1="360" x2="850" y2="360" stroke="#d1d5db" stroke-width="1"/>

  <!-- Consumer -->
  <rect x="70" y="320" width="80" height="30" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="110" y="340" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#1d4ed8">Consumer</text>
  <line x1="110" y1="350" x2="110" y2="480" stroke="#3b82f6" stroke-width="1" stroke-dasharray="4,2"/>

  <!-- Cache -->
  <rect x="200" y="320" width="70" height="30" rx="4" fill="#d1fae5" stroke="#10b981" stroke-width="1.5"/>
  <text x="235" y="340" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#047857">Cache</text>
  <line x1="235" y1="350" x2="235" y2="480" stroke="#10b981" stroke-width="1" stroke-dasharray="4,2"/>

  <!-- DHT -->
  <rect x="320" y="320" width="70" height="30" rx="4" fill="#ede9fe" stroke="#8b5cf6" stroke-width="1.5"/>
  <text x="355" y="340" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#6d28d9">DHT</text>
  <line x1="355" y1="350" x2="355" y2="480" stroke="#8b5cf6" stroke-width="1" stroke-dasharray="4,2"/>

  <!-- Provider -->
  <rect x="520" y="320" width="80" height="30" rx="4" fill="#ffedd5" stroke="#f97316" stroke-width="1.5"/>
  <text x="560" y="340" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#c2410c">Provider</text>
  <line x1="560" y1="350" x2="560" y2="480" stroke="#f97316" stroke-width="1" stroke-dasharray="4,2"/>

  <!-- Handler -->
  <rect x="650" y="320" width="80" height="30" rx="4" fill="#fef3c7" stroke="#fbbf24" stroke-width="1.5"/>
  <text x="690" y="340" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#a16207">Handler</text>
  <line x1="690" y1="350" x2="690" y2="480" stroke="#fbbf24" stroke-width="1" stroke-dasharray="4,2"/>

  <!-- Sequence: Cache miss path -->
  <line x1="115" y1="370" x2="230" y2="370" stroke="#6b7280" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <text x="170" y="365" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">1. Check cache</text>

  <line x1="230" y1="385" x2="115" y2="385" stroke="#dc2626" stroke-width="1.5" stroke-dasharray="3,2"/>
  <text x="170" y="398" text-anchor="middle" font-family="system-ui" font-size="8" fill="#dc2626">miss</text>

  <line x1="115" y1="405" x2="350" y2="405" stroke="#8b5cf6" stroke-width="1.5" marker-end="url(#arrowhead-dht)"/>
  <text x="230" y="400" text-anchor="middle" font-family="system-ui" font-size="8" fill="#7c3aed">2. Query DHT</text>

  <line x1="350" y1="420" x2="115" y2="420" stroke="#8b5cf6" stroke-width="1.5" marker-end="url(#arrowhead-dht)"/>
  <text x="230" y="433" text-anchor="middle" font-family="system-ui" font-size="8" fill="#7c3aed">3. Providers list</text>

  <line x1="115" y1="440" x2="555" y2="440" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrowhead-call)"/>
  <text x="335" y="455" text-anchor="middle" font-family="system-ui" font-size="8" fill="#1d4ed8">4. MSG_CALL (procedure, args)</text>

  <line x1="560" y1="455" x2="685" y2="455" stroke="#f97316" stroke-width="1.5" marker-end="url(#arrowhead)"/>
  <text x="620" y="450" text-anchor="middle" font-family="system-ui" font-size="8" fill="#c2410c">5. Execute</text>

  <line x1="685" y1="470" x2="560" y2="470" stroke="#fbbf24" stroke-width="1.5"/>
  <text x="620" y="483" text-anchor="middle" font-family="system-ui" font-size="8" fill="#a16207">result</text>

  <line x1="555" y1="475" x2="115" y2="475" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrowhead-reply)"/>
  <text x="335" y="490" text-anchor="middle" font-family="system-ui" font-size="8" fill="#059669">6. MSG_REPLY (result)</text>

  <!-- Latency breakdown -->
  <rect x="760" y="365" width="90" height="110" rx="4" fill="#f3f4f6" stroke="#d1d5db"/>
  <text x="805" y="382" text-anchor="middle" font-family="system-ui" font-size="8" font-weight="600" fill="#374151">Latency</text>
  <text x="805" y="398" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">Local: 0ms</text>
  <text x="805" y="413" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">Cache: &lt;1ms</text>
  <text x="805" y="428" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">DHT: 50ms</text>
  <text x="805" y="443" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">QUIC: 20ms</text>
  <text x="805" y="458" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">Handler: var</text>
  <text x="805" y="473" text-anchor="middle" font-family="system-ui" font-size="8" font-weight="500" fill="#374151">Total: ~70ms</text>

  <!-- Section 4: Module Architecture -->
  <rect x="20" y="520" width="420" height="210" rx="8" fill="#fefce8" stroke="#fde047" stroke-width="1.5"/>
  <text x="40" y="545" font-family="system-ui" font-size="14" font-weight="600" fill="#a16207">Module Architecture</text>

  <!-- Layers -->
  <rect x="40" y="565" width="380" height="30" rx="4" fill="#fef9c3" stroke="#facc15" stroke-width="1.5"/>
  <text x="230" y="585" text-anchor="middle" font-family="system-ui" font-size="11" font-weight="500" fill="#a16207">Application: macula (Public API)</text>

  <rect x="40" y="605" width="185" height="50" rx="4" fill="white" stroke="#e5e7eb"/>
  <text x="132" y="625" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#374151">macula_rpc_handler</text>
  <text x="132" y="640" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">Request/reply handling</text>

  <rect x="235" y="605" width="185" height="50" rx="4" fill="white" stroke="#e5e7eb"/>
  <text x="327" y="625" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#374151">macula_service_registry</text>
  <text x="327" y="640" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">Local + DHT discovery</text>

  <rect x="40" y="665" width="380" height="25" rx="4" fill="#ede9fe" stroke="#a78bfa"/>
  <text x="230" y="683" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#6d28d9">DHT: macula_routing_dht (Kademlia)</text>

  <rect x="40" y="700" width="380" height="25" rx="4" fill="#dbeafe" stroke="#93c5fd"/>
  <text x="230" y="718" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#1e40af">Transport: HTTP/3 QUIC</text>

  <!-- Section 5: Multi-Provider Load Balancing -->
  <rect x="460" y="520" width="420" height="210" rx="8" fill="#f0fdf4" stroke="#86efac" stroke-width="1.5"/>
  <text x="480" y="545" font-family="system-ui" font-size="14" font-weight="600" fill="#047857">Multi-Provider Load Balancing</text>

  <!-- Multiple providers diagram -->
  <rect x="480" y="565" width="100" height="40" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="530" y="590" text-anchor="middle" font-family="system-ui" font-size="10" font-weight="500" fill="#1d4ed8">Consumer</text>

  <rect x="650" y="555" width="90" height="30" rx="4" fill="#ffedd5" stroke="#f97316"/>
  <text x="695" y="575" text-anchor="middle" font-family="system-ui" font-size="9" font-weight="500" fill="#c2410c">Provider 1</text>

  <rect x="650" y="590" width="90" height="30" rx="4" fill="#ffedd5" stroke="#f97316"/>
  <text x="695" y="610" text-anchor="middle" font-family="system-ui" font-size="9" font-weight="500" fill="#c2410c">Provider 2</text>

  <rect x="650" y="625" width="90" height="30" rx="4" fill="#ffedd5" stroke="#f97316"/>
  <text x="695" y="645" text-anchor="middle" font-family="system-ui" font-size="9" font-weight="500" fill="#c2410c">Provider 3</text>

  <!-- Arrows -->
  <line x1="580" y1="575" x2="645" y2="570" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrowhead-call)"/>
  <line x1="580" y1="585" x2="645" y2="605" stroke="#4b5563" stroke-width="1" stroke-dasharray="3,2"/>
  <line x1="580" y1="595" x2="645" y2="640" stroke="#4b5563" stroke-width="1" stroke-dasharray="3,2"/>

  <!-- Selection strategies -->
  <rect x="480" y="665" width="380" height="60" rx="4" fill="white" stroke="#d1d5db"/>
  <text x="490" y="682" font-family="system-ui" font-size="10" font-weight="600" fill="#374151">Provider Selection Strategies</text>
  <text x="490" y="700" font-family="system-ui" font-size="9" fill="#6b7280">‚Ä¢ Round-robin (default)</text>
  <text x="490" y="715" font-family="system-ui" font-size="9" fill="#6b7280">‚Ä¢ Random selection</text>
  <text x="680" y="700" font-family="system-ui" font-size="9" fill="#6b7280">‚Ä¢ First available</text>
  <text x="680" y="715" font-family="system-ui" font-size="9" fill="#6b7280">‚Ä¢ Failover on error</text>

  <!-- Selection label -->
  <rect x="755" y="565" width="110" height="55" rx="4" fill="#ecfdf5" stroke="#6ee7b7"/>
  <text x="810" y="583" text-anchor="middle" font-family="system-ui" font-size="9" font-weight="500" fill="#047857">Failover</text>
  <text x="810" y="598" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">On timeout/error</text>
  <text x="810" y="611" text-anchor="middle" font-family="system-ui" font-size="8" fill="#6b7280">‚Üí try next</text>

  <!-- Best practices box -->
  <rect x="760" y="60" width="120" height="65" rx="4" fill="white" stroke="#d1d5db" filter="url(#shadow)"/>
  <text x="770" y="78" font-family="system-ui" font-size="9" font-weight="600" fill="#374151">Best Practices</text>
  <text x="770" y="94" font-family="system-ui" font-size="7" fill="#6b7280">‚Ä¢ Set timeouts</text>
  <text x="770" y="106" font-family="system-ui" font-size="7" fill="#6b7280">‚Ä¢ Handle errors</text>
  <text x="770" y="118" font-family="system-ui" font-size="7" fill="#6b7280">‚Ä¢ Cache results</text>
</svg>
