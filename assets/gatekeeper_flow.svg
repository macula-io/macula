<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 700" width="900" height="700">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22d3ee"/>
    </marker>
    <marker id="arrowRed" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#ef4444"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#22c55e"/>
    </marker>
    <linearGradient id="stepGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#1e40af"/>
      <stop offset="100%" style="stop-color:#3b82f6"/>
    </linearGradient>
    <linearGradient id="successGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#166534"/>
      <stop offset="100%" style="stop-color:#22c55e"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" style="stop-color:#991b1b"/>
      <stop offset="100%" style="stop-color:#ef4444"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="900" height="700" fill="#0f172a"/>

  <!-- Title -->
  <text x="450" y="40" fill="#f1f5f9" font-family="system-ui, sans-serif" font-size="24" font-weight="bold" text-anchor="middle">macula_gatekeeper Verification Pipeline</text>
  <text x="450" y="65" fill="#94a3b8" font-family="system-ui, sans-serif" font-size="14" text-anchor="middle">Pipeline-based validation for mesh admission</text>

  <!-- Entry Point -->
  <ellipse cx="450" cy="110" rx="100" ry="30" fill="#1e293b" stroke="#6366f1" stroke-width="2"/>
  <text x="450" y="115" fill="#c7d2fe" font-family="monospace" font-size="14" text-anchor="middle">verify_beam_app/2</text>

  <!-- Arrow to Step 1 -->
  <line x1="450" y1="140" x2="450" y2="165" stroke="#22d3ee" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 1: Protocol Loaded -->
  <rect x="300" y="175" width="300" height="60" rx="8" fill="url(#stepGrad)" stroke="#60a5fa" stroke-width="2"/>
  <text x="320" y="195" fill="#fff" font-family="system-ui, sans-serif" font-size="12" font-weight="bold">Step 1</text>
  <text x="320" y="215" fill="#bfdbfe" font-family="monospace" font-size="12">ensure_protocol_loaded(Node)</text>
  <text x="320" y="230" fill="#93c5fd" font-family="monospace" font-size="10">Check macula_protocol behaviour available</text>

  <!-- Arrow to Step 2 -->
  <line x1="450" y1="235" x2="450" y2="260" stroke="#22d3ee" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 2: Behaviour Check -->
  <rect x="300" y="270" width="300" height="60" rx="8" fill="url(#stepGrad)" stroke="#60a5fa" stroke-width="2"/>
  <text x="320" y="290" fill="#fff" font-family="system-ui, sans-serif" font-size="12" font-weight="bold">Step 2</text>
  <text x="320" y="310" fill="#bfdbfe" font-family="monospace" font-size="12">check_behaviour_implementation/2</text>
  <text x="320" y="325" fill="#93c5fd" font-family="monospace" font-size="10">Verify all 8 callbacks exported</text>

  <!-- Arrow to Step 3 -->
  <line x1="450" y1="330" x2="450" y2="355" stroke="#22d3ee" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 3: Identity + Cert -->
  <rect x="300" y="365" width="300" height="60" rx="8" fill="url(#stepGrad)" stroke="#60a5fa" stroke-width="2"/>
  <text x="320" y="385" fill="#fff" font-family="system-ui, sans-serif" font-size="12" font-weight="bold">Step 3</text>
  <text x="320" y="405" fill="#bfdbfe" font-family="monospace" font-size="12">get_and_validate_identity/3</text>
  <text x="320" y="420" fill="#93c5fd" font-family="monospace" font-size="10">Verify cert, extract fingerprint</text>

  <!-- Arrow to Step 4 -->
  <line x1="450" y1="425" x2="450" y2="450" stroke="#22d3ee" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 4: Capabilities -->
  <rect x="300" y="460" width="300" height="60" rx="8" fill="url(#stepGrad)" stroke="#60a5fa" stroke-width="2"/>
  <text x="320" y="480" fill="#fff" font-family="system-ui, sans-serif" font-size="12" font-weight="bold">Step 4</text>
  <text x="320" y="500" fill="#bfdbfe" font-family="monospace" font-size="12">get_capabilities_and_api/2</text>
  <text x="320" y="515" fill="#93c5fd" font-family="monospace" font-size="10">Validate declared capabilities</text>

  <!-- Arrow to Step 5 -->
  <line x1="450" y1="520" x2="450" y2="545" stroke="#22d3ee" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 5: Health Check -->
  <rect x="300" y="555" width="300" height="60" rx="8" fill="url(#stepGrad)" stroke="#60a5fa" stroke-width="2"/>
  <text x="320" y="575" fill="#fff" font-family="system-ui, sans-serif" font-size="12" font-weight="bold">Step 5</text>
  <text x="320" y="595" fill="#bfdbfe" font-family="monospace" font-size="12">check_app_health/2</text>
  <text x="320" y="610" fill="#93c5fd" font-family="monospace" font-size="10">Call mesh_health/0 callback</text>

  <!-- Success Path -->
  <line x1="450" y1="615" x2="450" y2="645" stroke="#22c55e" stroke-width="2" marker-end="url(#arrowGreen)"/>
  <rect x="350" y="650" width="200" height="40" rx="8" fill="url(#successGrad)" stroke="#4ade80" stroke-width="2"/>
  <text x="450" y="675" fill="#fff" font-family="monospace" font-size="14" font-weight="bold" text-anchor="middle">{ok, app_manifest()}</text>

  <!-- Error Paths (right side) -->
  <g transform="translate(650, 0)">
    <!-- Error indicators -->
    <rect x="0" y="175" width="180" height="35" rx="6" fill="url(#errorGrad)" stroke="#f87171" stroke-width="1"/>
    <text x="90" y="197" fill="#fff" font-family="monospace" font-size="10" text-anchor="middle">no_macula_sdk</text>
    <line x1="-50" y1="205" x2="0" y2="192" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrowRed)"/>

    <rect x="0" y="270" width="180" height="35" rx="6" fill="url(#errorGrad)" stroke="#f87171" stroke-width="1"/>
    <text x="90" y="292" fill="#fff" font-family="monospace" font-size="10" text-anchor="middle">{missing_callbacks, [...]}</text>
    <line x1="-50" y1="300" x2="0" y2="287" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrowRed)"/>

    <rect x="0" y="365" width="180" height="35" rx="6" fill="url(#errorGrad)" stroke="#f87171" stroke-width="1"/>
    <text x="90" y="387" fill="#fff" font-family="monospace" font-size="10" text-anchor="middle">{certificate_invalid, ...}</text>
    <line x1="-50" y1="395" x2="0" y2="382" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrowRed)"/>

    <rect x="0" y="460" width="180" height="35" rx="6" fill="url(#errorGrad)" stroke="#f87171" stroke-width="1"/>
    <text x="90" y="482" fill="#fff" font-family="monospace" font-size="10" text-anchor="middle">invalid_capability</text>
    <line x1="-50" y1="490" x2="0" y2="477" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrowRed)"/>

    <rect x="0" y="555" width="180" height="35" rx="6" fill="url(#errorGrad)" stroke="#f87171" stroke-width="1"/>
    <text x="90" y="577" fill="#fff" font-family="monospace" font-size="10" text-anchor="middle">health_check_failed</text>
    <line x1="-50" y1="585" x2="0" y2="572" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrowRed)"/>
  </g>

  <!-- Pipeline Pattern Info -->
  <rect x="40" y="175" width="200" height="140" rx="8" fill="#1e293b" stroke="#475569" stroke-width="1"/>
  <text x="140" y="200" fill="#94a3b8" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" text-anchor="middle">Pipeline Pattern</text>
  <text x="50" y="230" fill="#d1d5db" font-family="monospace" font-size="10">with_step(Result, Next)</text>
  <text x="50" y="255" fill="#6b7280" font-family="monospace" font-size="9">{ok, Val} -&gt; Next(Val)</text>
  <text x="50" y="275" fill="#6b7280" font-family="monospace" font-size="9">ok -&gt; Next()</text>
  <text x="50" y="295" fill="#f87171" font-family="monospace" font-size="9">{error, _} -&gt; stop</text>

  <!-- Manifest Output -->
  <rect x="40" y="420" width="200" height="150" rx="8" fill="#1e293b" stroke="#22c55e" stroke-width="1"/>
  <text x="140" y="445" fill="#4ade80" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" text-anchor="middle">app_manifest()</text>
  <text x="50" y="470" fill="#d1d5db" font-family="monospace" font-size="10">identity</text>
  <text x="50" y="490" fill="#d1d5db" font-family="monospace" font-size="10">capabilities</text>
  <text x="50" y="510" fill="#d1d5db" font-family="monospace" font-size="10">api</text>
  <text x="50" y="530" fill="#d1d5db" font-family="monospace" font-size="10">certificate_fingerprint</text>
  <text x="50" y="550" fill="#d1d5db" font-family="monospace" font-size="10">verified_at</text>

  <!-- Legend -->
  <rect x="40" y="600" width="200" height="80" rx="8" fill="#1e293b" stroke="#475569" stroke-width="1"/>
  <text x="140" y="625" fill="#94a3b8" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" text-anchor="middle">Legend</text>
  <line x1="55" y1="645" x2="95" y2="645" stroke="#22d3ee" stroke-width="2"/>
  <text x="105" y="650" fill="#94a3b8" font-family="system-ui, sans-serif" font-size="10">Success flow</text>
  <line x1="55" y1="665" x2="95" y2="665" stroke="#ef4444" stroke-width="2" stroke-dasharray="4"/>
  <text x="105" y="670" fill="#94a3b8" font-family="system-ui, sans-serif" font-size="10">Error path</text>
</svg>
