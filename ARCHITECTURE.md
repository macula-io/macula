# Macula Architecture Overview

> **Visual guide to understanding Macula's distributed mesh architecture**

---

## Table of Contents

1. [System Context (C4)](#system-context-c4)
2. [Container View (C4)](#container-view-c4)
3. [Deployment Topologies](#deployment-topologies)
4. [Supervision Trees](#supervision-trees)
5. [Message Flow Patterns](#message-flow-patterns)
6. [DHT Architecture](#dht-architecture)
7. [Direct P2P Connections (v0.8.0)](#direct-p2p-connections-v080)

---

## System Context (C4)

**How applications use Macula to build distributed systems**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              YOUR APPLICATION                                 â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                       â”‚  Elixir/Erlang Application  â”‚                        â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                     â”‚                                         â”‚
â”‚                          start_link â”‚ publish                                â”‚
â”‚                          subscribe  â”‚ call                                   â”‚
â”‚                          advertise  â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              MACULA PLATFORM                                  â”‚
â”‚                                                                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   macula_peer    â”‚       â”‚  macula_gateway  â”‚      â”‚       DHT       â”‚  â”‚
â”‚   â”‚ Mesh Participant â”‚       â”‚   Relay Node     â”‚      â”‚    Kademlia     â”‚  â”‚
â”‚   â”‚       API        â”‚       â”‚                  â”‚      â”‚   Discovery     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                          â”‚                         â”‚            â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€QUIC/HTTP3â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”€â”€Store/Findâ”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                       â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                                â”‚                                â”‚
       â–¼ Direct P2P                     â–¼ Relay                         â–¼ Direct P2P
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Remote     â”‚               â”‚   Remote     â”‚                â”‚   Remote     â”‚
â”‚  Service 1   â”‚               â”‚ Subscriber   â”‚                â”‚  Service 2   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Concepts:**
- **macula_peer**: Your application's interface to the mesh
- **macula_gateway**: Relay node for NAT-traversed peers (optional)
- **DHT**: Kademlia-based distributed service registry (k=20 replication)
- **Direct P2P**: v0.8.0+ establishes direct QUIC connections (50% latency improvement)

---

## Container View (C4)

**Internal architecture of a Macula node**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           APPLICATION LAYER                                  â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚   Your Application Code   â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ API Calls
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MACULA PEER (High-Level API)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                macula_peer (Facade/Coordinator)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SUPERVISED CHILDREN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚      â”‚
â”‚  â”‚  â”‚ macula_     â”‚ â”‚ macula_     â”‚ â”‚ macula_     â”‚ â”‚ macula_     â”‚â”‚      â”‚
â”‚  â”‚  â”‚ connection  â”‚ â”‚ pubsub_     â”‚ â”‚ rpc_        â”‚ â”‚ advertisementâ”‚â”‚      â”‚
â”‚  â”‚  â”‚ (QUIC)      â”‚ â”‚ handler     â”‚ â”‚ handler     â”‚ â”‚ _manager    â”‚â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚               â”‚
             â”‚ QUIC          â”‚               â”‚               â”‚
             â–¼               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GATEWAY (Optional Relay Node)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                macula_gateway (Coordinator)                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                   â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GATEWAY WORKERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚      â”‚
â”‚  â”‚  â”‚ client_     â”‚ â”‚ gateway_    â”‚ â”‚ gateway_    â”‚ â”‚ gateway_    â”‚â”‚      â”‚
â”‚  â”‚  â”‚ manager     â”‚ â”‚ pubsub      â”‚ â”‚ rpc         â”‚ â”‚ mesh        â”‚â”‚      â”‚
â”‚  â”‚  â”‚ (Lifecycle) â”‚ â”‚ (Routing)   â”‚ â”‚ (Registry)  â”‚ â”‚ (Pool)      â”‚â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CORE SERVICES                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ macula_routing_   â”‚ â”‚ macula_service_   â”‚ â”‚ macula_pubsub_    â”‚         â”‚
â”‚  â”‚ server (DHT Node) â”‚ â”‚ registry (Store)  â”‚ â”‚ dht (Subscriber)  â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                â”‚                                             â”‚
â”‚                     Kademlia DHT (k=20 replication)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Architecture Principles:**
- **Single Responsibility**: Each module has one clear purpose
- **OTP Supervision**: Automatic fault recovery at all levels
- **Stateless Utilities**: DHT operations don't hold state
- **Connection Pooling**: Gateway reuses QUIC connections (v0.9.0+)

---

## Deployment Topologies

### 1. Edge-First Mesh (IoT, Distributed Systems)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Cloud / Data Center                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Bootstrap â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Bootstrap â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Bootstrap â”‚    â”‚
â”‚  â”‚    Node    â”‚      â”‚    Node    â”‚      â”‚    Node    â”‚    â”‚
â”‚  â”‚ (DHT Seed) â”‚      â”‚ (DHT Seed) â”‚      â”‚ (DHT Seed) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                     â”‚                   â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Gateway â”‚           â”‚ Gateway â”‚        â”‚ Gateway â”‚
    â”‚  Node   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Node   â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  Node   â”‚
    â”‚(Relay+  â”‚           â”‚(Relay+  â”‚        â”‚(Relay+  â”‚
    â”‚ DHT)    â”‚           â”‚ DHT)    â”‚        â”‚ DHT)    â”‚
    â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚  Edge   â”‚           â”‚  Edge   â”‚        â”‚  Edge   â”‚
    â”‚  Peer   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Peer   â”‚â—„â”€â”€â”€â”€â”€â”€â–ºâ”‚  Peer   â”‚
    â”‚(Behind  â”‚  Direct   â”‚(Behind  â”‚ Direct â”‚(Behind  â”‚
    â”‚  NAT)   â”‚    P2P    â”‚  NAT)   â”‚  P2P   â”‚  NAT)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (v0.8.0) â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (v0.8.0)â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ Sensor  â”‚           â”‚ Sensor  â”‚        â”‚ Sensor  â”‚
    â”‚ Device  â”‚           â”‚ Device  â”‚        â”‚ Device  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use Cases:**
- IoT networks with edge processing
- Distributed sensor networks
- Edge computing platforms
- Multi-site deployments

**Features:**
- Bootstrap nodes: DHT seeds (always available)
- Gateway nodes: Relay for NAT-traversed peers
- Edge peers: Application logic at the edge
- Direct P2P: v0.8.0+ bypasses relay when possible

---

### 2. Microservices Mesh (Kubernetes, Cloud)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes Cluster                        â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Namespace: macula-system                 â”‚   â”‚
â”‚  â”‚                                                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚Bootstrap â”‚  â”‚Bootstrap â”‚  â”‚Bootstrap â”‚           â”‚   â”‚
â”‚  â”‚  â”‚   Pod    â”‚  â”‚   Pod    â”‚  â”‚   Pod    â”‚           â”‚   â”‚
â”‚  â”‚  â”‚(Headless â”‚  â”‚(Headless â”‚  â”‚(Headless â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ Service) â”‚  â”‚ Service) â”‚  â”‚ Service) â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Namespace: app-services                   â”‚   â”‚
â”‚  â”‚                      â”‚                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚        Service A (3 replicas)        â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Pod A1 â”‚ â”‚  Pod A2 â”‚ â”‚  Pod A3 â”‚â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚(macula  â”‚ â”‚(macula  â”‚ â”‚(macula  â”‚â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ peer)   â”‚ â”‚ peer)   â”‚ â”‚ peer)   â”‚â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â–²â”€â”€â”€â”€â”˜â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚          â”‚           â”‚           â”‚                   â”‚   â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
â”‚  â”‚                      â”‚                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚        Service B (2 replicas)        â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Pod B1 â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Pod B2 â”‚       â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚(macula  â”‚Directâ”‚(macula  â”‚       â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â”‚ peer)   â”‚  P2P â”‚ peer)   â”‚       â”‚            â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜(v0.8)â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use Cases:**
- Microservices communication
- Service mesh alternative
- Event-driven architectures
- Multi-tenant platforms

**Features:**
- No external message broker needed
- Built-in service discovery via DHT
- Realm-based multi-tenancy
- Direct P2P between pods (v0.8.0+)

---

### 3. Hybrid Cloud-Edge (Best of Both Worlds)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Cloud Region                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Gateway   â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Gateway   â”‚â—„â”€â”€â”€â”€â–ºâ”‚  Gateway   â”‚    â”‚
â”‚  â”‚ (Public IP)â”‚      â”‚ (Public IP)â”‚      â”‚ (Public IP)â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                   â”‚
    Internet/WAN          Internet/WAN        Internet/WAN
         â”‚                     â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”‚                     â”‚                   â”‚           â”‚
â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ Factory â”‚           â”‚  Retail â”‚        â”‚  Office â”‚     â”‚
â”‚   â”‚   Site  â”‚           â”‚   Site  â”‚        â”‚   Site  â”‚     â”‚
â”‚   â”‚         â”‚           â”‚         â”‚        â”‚         â”‚     â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚           â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â” â”‚     â”‚
â”‚   â”‚ â”‚Edge â”‚ â”‚           â”‚ â”‚Edge â”‚ â”‚        â”‚ â”‚Edge â”‚ â”‚     â”‚
â”‚   â”‚ â”‚Peer â”‚ â”‚           â”‚ â”‚Peer â”‚ â”‚        â”‚ â”‚Peer â”‚ â”‚     â”‚
â”‚   â”‚ â””â”€â”€â–²â”€â”€â”˜ â”‚           â”‚ â””â”€â”€â–²â”€â”€â”˜ â”‚        â”‚ â””â”€â”€â–²â”€â”€â”˜ â”‚     â”‚
â”‚   â”‚    â”‚    â”‚           â”‚    â”‚    â”‚        â”‚    â”‚    â”‚     â”‚
â”‚   â”‚ â”Œâ”€â”€â–¼â”€â”€â” â”‚           â”‚ â”Œâ”€â”€â–¼â”€â”€â” â”‚        â”‚ â”Œâ”€â”€â–¼â”€â”€â” â”‚     â”‚
â”‚   â”‚ â”‚Equipâ”‚ â”‚           â”‚ â”‚ POS â”‚ â”‚        â”‚ â”‚ App â”‚ â”‚     â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚           â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚        â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                     Edge Locations                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Use Cases:**
- Retail chains with local processing
- Manufacturing with edge analytics
- Distributed branch offices
- Multi-region applications

**Features:**
- Cloud gateways for global reach
- Edge peers for local processing
- Automatic failover (relay â†” direct P2P)
- Low latency via direct connections

---

## Supervision Trees

### Peer Supervision Tree

```
                    macula_peer_sup
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
macula_connection  macula_pubsub_handler  macula_rpc_handler
  (QUIC Layer)      (Pub/Sub Logic)       (RPC Logic)
        â”‚
        â–¼
macula_advertisement_manager
  (Service Ads)
```

**Strategy**: `one_for_all`
- If any child crashes, restart all (coordinated state)
- Connection is the foundation; handlers depend on it

---

### Gateway Supervision Tree

```
                    macula_gateway_sup (Root)
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
        â–¼                   â–¼                   â–¼
macula_gateway_    macula_gateway    macula_gateway_workers_sup
  quic_server                               (Supervisor)
 (QUIC Listener)   (Coordinator)                â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚           â”‚           â”‚
                                    â–¼           â–¼           â–¼
                          client_manager  pubsub_router  rpc_handler
                            (Lifecycle)    (Routing)     (Registry)
                                    â”‚
                                    â–¼
                              mesh_connection_manager
                                 (Pool)
```

**Strategy**: `rest_for_one` (top-level)
- QUIC server starts first
- Gateway coordinates
- Workers handle business logic
- If QUIC crashes, restart everything
- If worker crashes, only restart later siblings

**Strategy**: `one_for_one` (workers)
- Each worker independent
- Failures isolated to single worker

---

## Message Flow Patterns

### RPC Flow (v0.8.0 Direct P2P)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                                         â”‚Provider â”‚
â”‚  Peer   â”‚                                         â”‚  Peer   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                    â”‚
     â”‚ 1. call("service.add", #{a=>5, b=>3})            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
     â”‚                                 â”‚                 â”‚
     â”‚                                 â–¼                 â”‚
     â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
     â”‚                           â”‚   DHT    â”‚            â”‚
     â”‚                           â”‚ (Find    â”‚            â”‚
     â”‚                           â”‚ Service) â”‚            â”‚
     â”‚                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â”‚
     â”‚                                â”‚                  â”‚
     â”‚ 2. Returns: "192.168.1.50:9443"                  â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
     â”‚                                                   â”‚
     â”‚ 3. Direct QUIC Connection                        â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚   RPC_REQUEST: service.add, {a:5, b:3}           â”‚
     â”‚                                                   â”‚
     â”‚                                  4. Execute Handler
     â”‚                                     Result = 8    â”‚
     â”‚                                                   â”‚
     â”‚ 5. RPC_RESPONSE: {result: 8}                     â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                                                   â”‚
     â–¼                                                   â–¼
  Returns                                            Handler
{ok, #{result=>8}}                                   Executed
```

**Performance**: 1-hop (direct), ~10-50ms latency
**Fallback**: If direct fails, relay via gateway (2-3 hops)

---

### PubSub Flow (v0.8.0 Direct P2P)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Publisher â”‚                                      â”‚Subscriberâ”‚
â”‚   Peer   â”‚                                      â”‚   Peer   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                                 â”‚
     â”‚ 1. subscribe("sensor.temp")                    â”‚
     â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â”‚                              â”‚   DHT    â”‚      â”‚
     â”‚                              â”‚  Store:  â”‚â—„â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚"sensor." â”‚      â”‚
     â”‚                              â”‚"temp" -> â”‚      â”‚
     â”‚                              â”‚192.1.1.X â”‚      â”‚
     â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
     â”‚                                                 â”‚
     â”‚ 2. publish("sensor.temp", {celsius: 21.5})     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
     â”‚                  â”‚                              â”‚
     â”‚                  â–¼                              â”‚
     â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
     â”‚            â”‚   DHT    â”‚                         â”‚
     â”‚            â”‚ Find:    â”‚                         â”‚
     â”‚            â”‚"sensor." â”‚                         â”‚
     â”‚            â”‚  "temp"  â”‚                         â”‚
     â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”‚
     â”‚                 â”‚                               â”‚
     â”‚ 3. Returns: "192.168.1.X:9443"                 â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
     â”‚                                                 â”‚
     â”‚ 4. Direct QUIC Connection                      â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚   PUBLISH: sensor.temp, {celsius: 21.5}        â”‚
     â”‚                                                 â”‚
     â”‚                                  5. Deliver to  â”‚
     â”‚                                     Subscriber  â”‚
     â”‚                                                 â–¼
     â”‚                                        receive {macula_event,
     â”‚                                                 "sensor.temp",
     â”‚                                                 #{celsius=>21.5}}
```

**Performance**: 1-hop (direct), ~10-50ms latency
**Wildcard Support**: `sensor.*` matches `sensor.temp`, `sensor.pressure`
**Fanout**: One DHT query finds all subscribers

---

## DHT Architecture

### Kademlia XOR Distance

```
Node ID Space (160-bit):

    0                                              2^160
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

    Distance(A, B) = A XOR B

    Example:
    Node A: 1010...
    Node B: 1100...
    XOR:    0110... (closer = smaller distance)
```

### Routing Table (K-Buckets)

```
Each node maintains:

Bucket 0:  Nodes 2^0    distance away  [0-1 bits different]
Bucket 1:  Nodes 2^1    distance away  [1-2 bits different]
Bucket 2:  Nodes 2^2    distance away  [2-4 bits different]
...
Bucket 159: Nodes 2^159 distance away  [159-160 bits different]

Each bucket holds up to k=20 nodes (sorted by last-seen time)
```

### DHT Operations

#### STORE Operation (k=20 Propagation)

```
1. Hash key: hash("service.calculator.add") = node_id
2. Find k=20 closest nodes via iterative lookup
3. Send STORE to all k nodes
4. Each node stores: {key, value, ttl}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  STORE   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Node 1 â”‚ (closest)
â”‚  (You) â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Node 2 â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Node 3 â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   ...  â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Node 20 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### FIND_VALUE Operation

```
1. Hash key: hash("service.calculator.add") = target_id
2. Query closest known nodes
3. If found, return value
4. If not found, return closer nodes
5. Repeat until value found or no closer nodes

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  FIND    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Node A â”‚â”€â”
â”‚  (You) â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚ â”‚ "Not found,
â”‚        â”‚  Closer  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  try Node B"
â”‚        â”‚   Nodes              â”‚
â”‚        â”‚                      â–¼
â”‚        â”‚  FIND    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Node B â”‚
â”‚        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚ "Found! Here's
â”‚        â”‚  Value   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  the value"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Complexity**: O(log N) hops to find any key
**Redundancy**: k=20 replication for fault tolerance

---

## Direct P2P Connections (v0.8.0)

### Connection Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Connection Decision Flow                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Need to send message   â”‚
        â”‚  (RPC or PubSub)        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Query DHT for endpoint â”‚
        â”‚  (IP:Port discovered)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Attempt Direct P2P     â”‚
        â”‚  via peer_connector     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
            â”‚               â”‚
       Success           Failure
            â”‚               â”‚
            â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Message   â”‚   â”‚  Fallback   â”‚
    â”‚  Delivered  â”‚   â”‚  to Gateway â”‚
    â”‚   (1-hop)   â”‚   â”‚   Relay     â”‚
    â”‚             â”‚   â”‚  (2-3 hops) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ 100% Reliabilityâ”‚
          â”‚  Guaranteed     â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Benefits**:
- 50% latency reduction when direct succeeds
- Automatic fallback ensures reliability
- Gateway load reduced (more direct connections = less relay traffic)

---

### Performance Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Message Delivery Latency (ms)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

v0.7.x (Relay-Only):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”    50ms    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    50ms    â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚Client â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Gateway â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Server â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”˜
Total: ~100ms (2-hop minimum)


v0.8.0 (Direct P2P):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”           50ms              â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚Client â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Server â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜                             â””â”€â”€â”€â”€â”€â”€â”€â”˜
Total: ~50ms (1-hop direct)

50% Improvement! ğŸš€
```

---

## Module Dependencies

```
Application Layer
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              macula_peer (API Facade)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ macula_connection  â”‚  â”‚ macula_pubsub_   â”‚
   â”‚  (QUIC Transport)  â”‚  â”‚    handler       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  macula_quic       â”‚  â”‚ macula_pubsub_   â”‚
   â”‚   (MsQuic FFI)     â”‚  â”‚      dht         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚      macula_routing_server (DHT)         â”‚
   â”‚    (Kademlia, k=20 replication)          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ macula_routing_    â”‚
   â”‚      table         â”‚
   â”‚  (K-buckets)       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Layered Architecture**:
1. **API Layer**: High-level user-facing API
2. **Business Logic**: Pub/sub, RPC, advertisements
3. **Transport Layer**: QUIC connections and streams
4. **Discovery Layer**: DHT for service/subscriber lookup
5. **Routing Layer**: Kademlia routing table

---

## Key Takeaways for Architects

### âœ… What Makes Macula Unique

1. **BEAM-Native**
   - OTP supervision for automatic fault recovery
   - Process-per-connection scalability
   - Erlang's proven distributed systems DNA

2. **Modern Transport**
   - HTTP/3 (QUIC) instead of TCP
   - Built-in encryption (TLS 1.3)
   - NAT/firewall friendly
   - Multiplexed streams

3. **Self-Organizing**
   - No centralized message broker
   - DHT-based service discovery (Kademlia)
   - Automatic replication (k=20)
   - O(log N) lookup complexity

4. **Direct P2P (v0.8.0)**
   - 50% latency improvement
   - Bypasses relay when possible
   - Automatic fallback for reliability
   - Scales better (less gateway load)

5. **Multi-Tenancy**
   - Realm-based isolation
   - Share infrastructure, isolate traffic
   - Perfect for SaaS platforms

---

### ğŸš€ Performance Characteristics

| Metric | Value | Notes |
|--------|-------|-------|
| **Message Latency** | ~50ms | Direct P2P (v0.8.0) |
| | ~100ms | Relay via gateway |
| **DHT Lookup** | O(log N) | Kademlia routing |
| **Replication** | k=20 | Fault tolerance |
| **Throughput** | 500-2K msg/s | Gateway (v0.8.0) |
| | 10K+ msg/s | Planned (v0.9.0 pooling) |
| **Connections** | 100K+ | Per gateway node |

---

### ğŸ“Š When to Use Macula

**âœ… Great Fit:**
- Distributed IoT systems
- Microservices mesh
- Edge computing platforms
- Real-time event streaming
- Multi-region applications
- Multi-tenant SaaS

**âš ï¸ Consider Alternatives:**
- Single-region monoliths (RabbitMQ simpler)
- Ultra-high-frequency trading (direct TCP faster)
- Batch processing (Kafka better)
- Web browser clients (use gateway as WebSocket bridge)

---

**Next Steps**: See [README.md](README.md) for Quick Start and [v0.8.0-OVERVIEW.md](architecture/v0.8.0-OVERVIEW.md) for latest features.
