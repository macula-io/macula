# Macula v0.9.0 - Scope and Implementation Plan

**Version:** v0.9.0
**Target Release:** Q2 2025 (4-6 months)
**Focus:** Production Hardening + Architectural Foundations
**Status:** Planning
**Date:** 2025-11-18

---

## Executive Summary

v0.9.0 builds on v0.8.0's P2P foundation to create a production-ready, zero-config mesh platform with:
- ✅ Auto-generated TLS certificates (zero-config deployment)
- ✅ Always-on architecture (all capabilities in every node)
- ✅ Connection pooling (10x performance improvement)
- ✅ Consistency guarantees (correlation IDs, request/response patterns)
- ✅ NAT traversal (80%+ direct P2P connections)
- ✅ Production observability

---

## v0.8.0 Baseline

**What v0.8.0 Delivered:**
- ✅ Direct P2P QUIC connections
- ✅ DHT propagation (k=20 replication)
- ✅ Gateway on all node types
- ✅ RPC via direct P2P (11/11 tests passing)
- ✅ PubSub via direct P2P (10/10 tests passing)
- ✅ 100% test coverage (21/21 integration tests)

**Current Limitations:**
- ❌ TLS uses `{verify, none}` (security risk)
- ❌ Manual certificate management (doesn't scale)
- ❌ New connection per message (performance overhead)
- ❌ Fire-and-forget DHT (no confirmation)
- ❌ No NAT traversal (behind NAT = relay only)
- ❌ Limited observability

---

## v0.9.0 Strategic Goals

### 1. **Zero-Config Deployment**
Enable production deployment without manual configuration:
- Auto-generated TLS certificates
- Stable Node IDs (derived from public key)
- No CA infrastructure required
- Container-friendly (volume persistence)

### 2. **Always-On Architecture**
Every node has all capabilities (no mode configuration):
- DHT routing (always)
- Bootstrap service (always)
- Gateway QUIC listener (always)
- Peer connections (always)
- Simplifies deployment (one binary, zero config)

### 3. **Production Performance**
10x performance improvement via connection pooling:
- LRU connection pool (max 1,000 connections)
- Connection reuse for repeated operations
- <50ms message delivery (cached routes)
- Batch operations where possible

### 4. **Consistency Guarantees**
Make mesh operations reliable:
- Request/response patterns for DHT
- Correlation IDs for RPC
- Retry logic for failed operations
- Circuit breaker for dead peers

### 5. **NAT Traversal**
Enable direct P2P behind NAT:
- Opportunistic hole punching (80% success)
- Relay fallback (100% connectivity)
- Graceful connection upgrade
- Zero manual port forwarding

### 6. **Production Observability**
Visibility into mesh operations:
- Prometheus metrics
- Health check endpoints
- Connection pool statistics
- DHT operation tracking

---

## Scope Definition

### IN SCOPE (v0.9.0)

#### Phase 1: Architectural Foundations (Weeks 1-6)

**1.1. TLS Auto-Generation**
- ✅ Auto-generate self-signed certs on first boot
- ✅ Persist to disk (configurable path)
- ✅ Node ID derivation from public key hash
- ✅ Certificate validation on startup
- ✅ File permissions (0600 for private key)

**Deliverable:** `macula_tls.erl`
**Tests:** 10+ unit tests
**Effort:** 2 weeks

**1.2. Always-On Supervision Tree**
- ✅ Remove mode-based conditionals from `macula_root`
- ✅ Always start bootstrap_system
- ✅ Always start gateway_system
- ✅ Add `macula_peers_sup` (simple_one_for_one)
- ✅ Update FULL_SUPERVISION_TREE.md

**Deliverable:** Updated `macula_root.erl`, new `macula_peers_sup.erl`
**Tests:** 15+ supervision tests
**Effort:** 2 weeks

**1.3. Peer Supervision Management**
- ✅ Create `macula_peers_sup.erl` (simple_one_for_one supervisor)
- ✅ API: `start_peer/2`, `stop_peer/1`, `list_peers/0`, `count_peers/0`
- ✅ Integrate with `macula_peer:start_link/2`
- ✅ Proper lifecycle management

**Deliverable:** `macula_peers_sup.erl`
**Tests:** 12+ tests
**Effort:** 1 week

**1.4. Configuration Simplification**
- ✅ Remove `MACULA_MODE` environment variable
- ✅ Simplify to: `MACULA_QUIC_PORT`, `MACULA_REALM`, `MACULA_BOOTSTRAP_URL`
- ✅ Update docker-compose examples
- ✅ Update documentation

**Deliverable:** Updated configs, docs
**Effort:** 1 week

---

#### Phase 2: Performance & Connection Management (Weeks 7-12)

**2.1. Connection Pooling**
- ✅ Enhance `macula_gateway_mesh` with connection pool
- ✅ LRU eviction policy (max 1,000 connections)
- ✅ TTL-based cleanup (5-min idle timeout)
- ✅ Automatic reconnection on failure
- ✅ Connection health tracking

**Deliverable:** Updated `macula_gateway_mesh.erl`
**Tests:** 20+ pool management tests
**Effort:** 3 weeks

**2.2. Connection Reuse for RPC/PubSub**
- ✅ Update `macula_rpc_discovery` to use pooled connections
- ✅ Update `macula_pubsub_discovery` to use pooled connections
- ✅ Cache DHT results (5-min TTL)
- ✅ Invalidate cache on connection failure

**Deliverable:** Updated RPC/PubSub modules
**Tests:** 15+ integration tests
**Effort:** 2 weeks

**2.3. Performance Benchmarking**
- ✅ Benchmark connection pooling improvements
- ✅ Measure latency reduction
- ✅ Throughput testing
- ✅ Document results

**Deliverable:** Performance test suite, benchmark report
**Effort:** 1 week

---

#### Phase 3: Consistency & Reliability (Weeks 13-16)

**3.1. Request/Response DHT Pattern**
- ✅ Add correlation IDs to DHT messages
- ✅ Implement response tracking with timeout
- ✅ Return query results to caller
- ✅ Retry logic for failed queries

**Deliverable:** Updated `macula_routing_server.erl`, `macula_routing_protocol.erl`
**Tests:** 18+ request/response tests
**Effort:** 2 weeks

**3.2. RPC Correlation & Timeout**
- ✅ Verify correlation ID implementation in `macula_rpc_handler`
- ✅ Pending calls registry with timeouts
- ✅ Caller process monitoring (immediate cleanup on death)
- ✅ Circuit breaker pattern

**Deliverable:** Updated `macula_rpc_handler.erl`
**Tests:** 15+ correlation tests
**Effort:** 1 week

**3.3. Connection State Management**
- ✅ Health checks (QUIC keepalive or application-level ping)
- ✅ Stale connection detection
- ✅ Automatic reconnection
- ✅ Connection lifecycle hooks

**Deliverable:** Connection health tracking
**Tests:** 12+ health check tests
**Effort:** 1 week

---

#### Phase 4: NAT Traversal (Weeks 17-24)

**4.1. NAT Discovery**
- ✅ Create `macula_nat_discovery.erl`
- ✅ Detect public IP/port via gateway
- ✅ Detect NAT type (cone, symmetric, etc.)
- ✅ Cache NAT type and public address

**Deliverable:** `macula_nat_discovery.erl`
**Tests:** 10+ NAT detection tests
**Effort:** 2 weeks

**4.2. Hole Punching**
- ✅ Create `macula_hole_punch.erl`
- ✅ Coordinate simultaneous connection attempts
- ✅ Exchange addresses via gateway
- ✅ Timeout and fallback to relay (5 seconds)

**Deliverable:** `macula_hole_punch.erl`
**Tests:** 15+ hole punching tests
**Effort:** 3 weeks

**4.3. Connection Upgrade**
- ✅ Create `macula_connection_upgrade.erl`
- ✅ Migrate active streams from relay to direct
- ✅ Handle graceful transition
- ✅ Update routing tables

**Deliverable:** `macula_connection_upgrade.erl`
**Tests:** 12+ upgrade tests
**Effort:** 2 weeks

**4.4. NAT Traversal Testing**
- ✅ Docker-based NAT simulation
- ✅ Test various NAT types (cone, symmetric)
- ✅ Verify fallback behavior
- ✅ Integration tests

**Deliverable:** NAT test suite
**Effort:** 1 week

---

#### Phase 5: Observability (Weeks 25-26)

**5.1. Telemetry Integration**
- ✅ Add telemetry events for DHT operations
- ✅ Track connection pool statistics
- ✅ Monitor P2P connection success rates
- ✅ Add health check endpoints

**Deliverable:** Telemetry integration
**Effort:** 1 week

**5.2. Metrics & Monitoring**
- ✅ Prometheus metrics endpoint
- ✅ Sample Grafana dashboards
- ✅ Connection pool metrics
- ✅ DHT operation metrics
- ✅ RPC/PubSub latency metrics

**Deliverable:** Metrics module, dashboards
**Effort:** 1 week

---

### OUT OF SCOPE (Deferred to v1.0.0)

**Certificate Pinning** - Optional trust verification
**Reason:** Auto-generated certs with "accept all" trust model is sufficient for v0.9.0
**Deferred to:** v0.9.1 or v1.0.0

**STUN/TURN Infrastructure** - External NAT traversal services
**Reason:** Opportunistic hole punching + relay fallback provides 100% connectivity
**Deferred to:** v1.0.0 (only if 80% direct P2P isn't sufficient)

**Subsystem Refactoring** - Separate bootstrap from gateway
**Reason:** Current architecture works well, not critical for production
**Deferred to:** v1.0.0 (only if separate deployment models needed)

**DHT-Based Cert Verification** - Verify certs via DHT
**Reason:** Trust model complexity, chicken-and-egg bootstrapping
**Deferred to:** v1.0.0+

**Message Sequencing (PubSub)** - Strict message ordering
**Reason:** Best-effort delivery is acceptable for most use cases
**Deferred to:** v1.0.0 (if strict ordering required)

---

## Implementation Roadmap

### Week-by-Week Breakdown

#### Weeks 1-2: TLS Auto-Generation
- Create `macula_tls.erl`
- Implement `generate_self_signed_cert/1`
- Implement `derive_node_id/1`
- Implement `ensure_cert_exists/2`
- Write 10+ unit tests
- Integration with QUIC server

#### Weeks 3-4: Always-On Architecture
- Remove mode conditionals from `macula_root.erl`
- Update supervision tree (always start all systems)
- Create `macula_peers_sup.erl`
- Write 15+ supervision tests
- Update FULL_SUPERVISION_TREE.md

#### Weeks 5-6: Configuration Simplification
- Remove `MACULA_MODE` env var
- Simplify configuration (only port, realm, bootstrap URL)
- Update docker-compose.demo.yml
- Update all documentation
- Migration guide for v0.8.0 users

#### Weeks 7-9: Connection Pooling
- Enhance `macula_gateway_mesh` with LRU pool
- Implement TTL-based cleanup
- Add connection health tracking
- Write 20+ pool tests
- Performance benchmarking

#### Weeks 10-12: Connection Reuse
- Update RPC/PubSub to use pooled connections
- Implement DHT result caching (5-min TTL)
- Cache invalidation on failure
- Integration tests
- Performance validation (10x improvement target)

#### Weeks 13-14: Request/Response DHT
- Add correlation IDs to DHT protocol
- Implement response tracking with timeout
- Add retry logic
- Write 18+ tests
- Measure latency improvements

#### Weeks 15-16: RPC Correlation & Connection Health
- Verify/enhance RPC correlation IDs
- Implement circuit breaker pattern
- Add connection health checks
- Write 27+ tests
- End-to-end reliability testing

#### Weeks 17-18: NAT Discovery
- Create `macula_nat_discovery.erl`
- Implement public address discovery
- Implement NAT type detection
- Write 10+ tests
- Integration with gateway

#### Weeks 19-21: Hole Punching
- Create `macula_hole_punch.erl`
- Coordinate simultaneous connection attempts
- Implement fallback logic (5-sec timeout)
- Write 15+ tests
- Integration testing

#### Weeks 22-23: Connection Upgrade
- Create `macula_connection_upgrade.erl`
- Graceful relay → direct migration
- Stream transfer logic
- Write 12+ tests
- End-to-end NAT traversal testing

#### Week 24: NAT Testing Infrastructure
- Docker-based NAT simulation
- Test cone NAT (should succeed)
- Test symmetric NAT (should fallback)
- Verify 80%+ success rate target
- Document NAT compatibility

#### Weeks 25-26: Observability
- Telemetry integration
- Prometheus metrics
- Sample Grafana dashboards
- Health check endpoints
- Monitoring documentation

---

## Success Criteria

### Performance Metrics
- ✅ **10x improvement** in repeated P2P operations (connection pooling)
- ✅ **<50ms** P2P message delivery (cached routes + pooled connections)
- ✅ **2-3x** throughput increase (batching + tuning)
- ✅ **<5ms** DHT cache lookup (vs 100ms+ query)

### Security Metrics
- ✅ **Zero-config TLS** - Every node has valid certificate
- ✅ **Stable Node IDs** - Cryptographic identity (SHA-256 of public key)
- ✅ **File permissions** - Private keys protected (0600)
- ✅ **No verify_none** - TLS handshake validates certificate format

### Reliability Metrics
- ✅ **100% test coverage** maintained (or improved)
- ✅ **DHT confirmation** - All STORE operations confirmed
- ✅ **Retry logic** - Failed operations retry 3x with exponential backoff
- ✅ **Circuit breaker** - Dead peers excluded after 5 consecutive failures

### Connectivity Metrics
- ✅ **80%+ direct P2P** - NAT hole punching success rate
- ✅ **100% connectivity** - Relay fallback ensures universal reachability
- ✅ **<100ms upgrade** - Relay → direct connection migration time
- ✅ **Zero message loss** during connection upgrade

### Observability Metrics
- ✅ **Comprehensive metrics** - 20+ Prometheus metrics exposed
- ✅ **Health endpoints** - `/health` and `/metrics` available
- ✅ **Sample dashboards** - Grafana dashboards for ops teams
- ✅ **Documentation** - Monitoring guide published

### Deployment Metrics
- ✅ **Zero-config** - No manual cert generation required
- ✅ **Container-friendly** - Volume mount for cert persistence
- ✅ **Stable identity** - Same cert = same Node ID across restarts
- ✅ **Backward compatible** - v0.8.0 nodes can interoperate (if certs provided)

---

## New Modules

### Core Infrastructure
1. **`macula_tls.erl`** - TLS certificate auto-generation and management
2. **`macula_peers_sup.erl`** - Dynamic peer connection supervisor

### NAT Traversal
3. **`macula_nat_discovery.erl`** - NAT type detection and public address discovery
4. **`macula_hole_punch.erl`** - Hole punching coordination
5. **`macula_connection_upgrade.erl`** - Relay → direct connection migration

### Observability (Optional - may be integrated into existing modules)
6. **`macula_telemetry.erl`** - Telemetry event emission
7. **`macula_metrics.erl`** - Prometheus metrics endpoint

---

## Updated Modules

### Supervision Tree
- **`macula_root.erl`** - Remove mode conditionals, always-on architecture
- **`macula_gateway_system.erl`** - TLS auto-generation integration

### Connection Management
- **`macula_gateway_mesh.erl`** - Enhanced connection pooling (LRU, TTL cleanup)
- **`macula_connection.erl`** - Health checks, automatic reconnection

### DHT & Routing
- **`macula_routing_server.erl`** - Request/response pattern, correlation IDs
- **`macula_routing_protocol.erl`** - Response message types

### RPC & PubSub
- **`macula_rpc_handler.erl`** - Enhanced correlation, circuit breaker
- **`macula_rpc_discovery.erl`** - Use connection pool, cache results
- **`macula_pubsub_discovery.erl`** - Use connection pool, cache results

---

## Testing Strategy

### Unit Tests (150+ new tests)
- TLS generation and validation (10 tests)
- Supervision tree (15 tests)
- Connection pooling (20 tests)
- Request/response DHT (18 tests)
- RPC correlation (15 tests)
- NAT discovery (10 tests)
- Hole punching (15 tests)
- Connection upgrade (12 tests)
- Connection health (12 tests)
- Telemetry (8 tests)
- Metrics (5 tests)

### Integration Tests (50+ new tests)
- Auto-generated cert mesh (5 tests)
- Connection pool reuse (10 tests)
- DHT request/response (8 tests)
- NAT traversal scenarios (15 tests)
- Connection upgrade flows (8 tests)
- End-to-end observability (4 tests)

### Performance Tests (10+ benchmarks)
- Connection pool vs new connections (baseline)
- Cached DHT vs fresh queries (10x improvement)
- Pooled RPC vs new connections (10x improvement)
- Throughput improvements (2-3x)
- Latency improvements (<50ms target)

### NAT Simulation Tests
- Cone NAT (should succeed with hole punching)
- Symmetric NAT (should fallback to relay)
- Mixed NAT scenarios
- Connection upgrade verification
- Fallback behavior testing

---

## Migration Path (v0.8.0 → v0.9.0)

### Backward Compatibility

**v0.8.0 nodes with manual certs:**
- ✅ Continue to work (certs detected, loaded)
- ✅ Node ID derived from existing public key
- ✅ No manual intervention required

**v0.8.0 nodes without certs:**
- ✅ Auto-generate on first boot
- ✅ New Node ID assigned (based on generated cert)
- ✅ Zero-config upgrade path

### Breaking Changes

**Minimal breaking changes:**
1. **Environment variables changed:**
   - Removed: `MACULA_MODE` (all nodes have all capabilities)
   - Renamed: `GATEWAY_PORT` → `MACULA_QUIC_PORT`
   - Renamed: `MACULA_GATEWAY_URL` → `MACULA_BOOTSTRAP_URL`

2. **Configuration simplified:**
   - No mode selection needed
   - Fewer environment variables
   - Clearer naming

**Migration guide:**
```bash
# v0.8.0 (old)
MACULA_MODE=gateway
GATEWAY_PORT=4433
MACULA_GATEWAY_URL=https://bootstrap:4433

# v0.9.0 (new)
# MACULA_MODE removed (always all capabilities)
MACULA_QUIC_PORT=4433
MACULA_BOOTSTRAP_URL=https://bootstrap:4433
```

### Deployment Migration

**Step 1: Update environment variables**
- Remove `MACULA_MODE`
- Rename `GATEWAY_PORT` → `MACULA_QUIC_PORT`
- Rename `MACULA_GATEWAY_URL` → `MACULA_BOOTSTRAP_URL`

**Step 2: Volume mount for certs (Docker)**
```yaml
volumes:
  - macula-certs:/opt/macula/certs  # Persist auto-generated certs
```

**Step 3: Rolling update**
- Update one node at a time
- Verify connectivity before next node
- v0.8.0 and v0.9.0 nodes can interoperate

**Step 4: Verify Node IDs stable**
- Check logs for Node ID on startup
- Should remain consistent across restarts

---

## Risk Assessment

### High Risk
**Connection pooling bugs**
- Mitigation: Comprehensive tests, gradual rollout
- Fallback: Feature flag to disable pooling

**NAT traversal failures**
- Mitigation: Relay fallback ensures 100% connectivity
- Monitoring: Track direct vs relay connection rates

### Medium Risk
**TLS auto-generation edge cases**
- Mitigation: Extensive testing, file permission checks
- Fallback: Manual cert specification still supported

**Performance regression**
- Mitigation: Benchmarking before merge
- Monitoring: Performance test suite in CI

### Low Risk
**Observability overhead**
- Mitigation: Optional telemetry, configurable sampling
- Monitoring: CPU/memory impact measurement

---

## Dependencies

### External Libraries
- **quicer** - Already used (QUIC transport)
- **gproc** - Already used (process registry)
- **msgpack** - Already used (serialization)
- **telemetry** - NEW (optional, for observability)
- **prometheus** - NEW (optional, for metrics)

### Erlang/OTP Version
- **Minimum:** OTP 26+ (already required by v0.8.0)
- **Recommended:** OTP 27+ (performance improvements)

---

## Documentation Updates

### New Documentation
1. **TLS Auto-Generation Guide** - How certs are generated, Node ID derivation
2. **Always-On Architecture** - Explanation of all-capabilities model
3. **Connection Pooling** - Performance tuning guide
4. **NAT Traversal** - Hole punching behavior, fallback logic
5. **Monitoring Guide** - Prometheus metrics, Grafana dashboards
6. **Migration Guide** - v0.8.0 → v0.9.0 upgrade path

### Updated Documentation
1. **FULL_SUPERVISION_TREE.md** - Always-on architecture
2. **GETTING_STARTED.md** - Simplified configuration
3. **ARCHITECTURE.md** - Updated with v0.9.0 features
4. **docker-compose.demo.yml** - Zero-config example
5. **README.md** - Updated feature list

---

## Release Checklist

### Code Complete
- [ ] All 7 new modules implemented
- [ ] All 12 updated modules completed
- [ ] 200+ new tests passing
- [ ] Performance benchmarks met
- [ ] Documentation complete

### Quality Gates
- [ ] Code review (all PRs reviewed)
- [ ] Test coverage ≥ 85%
- [ ] No critical bugs
- [ ] Performance targets met
- [ ] Security audit passed

### Release Artifacts
- [ ] Release notes published
- [ ] Migration guide published
- [ ] Docker images tagged
- [ ] Hex package published
- [ ] Documentation deployed

### Post-Release
- [ ] Monitor metrics for issues
- [ ] Community feedback collected
- [ ] Patch releases as needed
- [ ] v1.0.0 planning begins

---

## References

- **v0.8.0 Status:** `architecture/v0.8.0-OVERVIEW.md`
- **v0.9.0 Roadmap:** `architecture/v0.8.0-ROADMAP.md`
- **NAT Traversal:** `architecture/NAT_TRAVERSAL_ROADMAP.md`
- **Consistency Concerns:** `architecture/v0.9.0-CONSISTENCY-CONCERNS.md`
- **TLS Auto-Generation:** `architecture/TLS_AUTO_GENERATION.md`
- **Memory Management:** `architecture/memory_management/`

---

**Document Version:** 1.0
**Last Updated:** 2025-11-18
**Status:** Planning Phase
**Next Review:** After community feedback

---

## Summary

v0.9.0 transforms Macula from a P2P foundation (v0.8.0) into a production-ready, zero-config mesh platform with:

✅ **Zero-config deployment** - Auto-generated TLS, no manual setup
✅ **10x performance** - Connection pooling for repeated operations
✅ **80% direct P2P** - NAT hole punching with 100% fallback
✅ **Production observability** - Metrics, health checks, monitoring
✅ **Reliable operations** - Request/response, retry logic, circuit breakers
✅ **Simple architecture** - All nodes identical, all capabilities always-on

**Timeline:** 26 weeks (4-6 months)
**Effort:** ~150 engineer-days
**Release:** Q2 2025
