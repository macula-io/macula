# Macula v0.8.0 - Direct P2P with DHT Propagation

**Release Date**: 2025-11-17
**Status**: ✅ Production Ready
**Test Coverage**: 21/21 integration tests passing (100%)

---

## Executive Summary

Macula v0.8.0 introduces **direct peer-to-peer communication** with **DHT propagation**, eliminating the need for multi-hop routing. This release represents a fundamental architectural improvement over v0.7.x, enabling true distributed mesh networking with comprehensive test coverage.

### Key Achievements

1. **Direct P2P QUIC Connections** - Messages delivered directly to destination without intermediary hops
2. **DHT Propagation** - Service registrations and subscriptions propagate to k=20 closest nodes
3. **Unified Architecture** - All node types (bootstrap, gateway, edge) run QUIC listeners
4. **RPC via Direct P2P** - Service discovery + direct connection (11/11 tests passing)
5. **PubSub via Direct P2P** - Subscription discovery + direct messaging (10/10 tests passing)

---

## What's New in v0.8.0

### 1. Direct Peer-to-Peer Messaging

**Before (v0.7.x)**: Multi-hop relay through gateway
```
Publisher → Gateway Connection → Multi-hop Routing → Subscriber
```

**After (v0.8.0)**: Direct QUIC connection
```
Publisher → DHT Lookup → Direct QUIC Connection → Subscriber
```

**Benefits**:
- Lower latency (1 hop instead of 2+)
- Reduced gateway load
- Better scalability
- Simpler message flow

### 2. New Module: `macula_peer_connector`

Fire-and-forget P2P QUIC connections (112 LOC):

```erlang
%% Send message directly to peer
macula_peer_connector:send_message(Endpoint, MessageType, Message).
```

**Features**:
- Handles transport_down errors gracefully
- 100ms delay before closing (prevents race condition)
- Simple endpoint parsing (host:port format)
- Direct quicer integration with ALPN ["macula"]

### 3. DHT STORE Propagation

Service registrations now propagate to k closest nodes:

```erlang
%% Register service - automatically propagates
macula_routing_server:store(Pid, Key, Value)
```

**Propagation**:
- Stores locally
- Finds k=20 closest nodes via XOR distance
- Sends STORE message to each node
- Eventual consistency across mesh

### 4. Gateway on All Node Types

**All nodes now run QUIC listeners on port 9443**:
- Bootstrap nodes - Accept P2P connections
- Gateway nodes - Accept P2P connections
- Edge nodes - Accept P2P connections

**Why**: Edge nodes must receive incoming DHT STORE messages and direct P2P messages. Without a listener, they cannot participate fully in the mesh.

### 5. Updated RPC Architecture

RPC now uses direct P2P instead of multi-hop routing:

1. Client queries DHT for service provider
2. DHT returns provider endpoint
3. Client connects directly via `macula_peer_connector`
4. RPC message delivered in single hop

**Test Coverage**: 11/11 integration tests passing
- Service registration/discovery
- Multi-node RPC calls
- Timeout handling
- Error scenarios

### 6. Updated PubSub Architecture

PubSub now uses direct P2P for message delivery:

1. Subscriber advertises subscription in DHT
2. Publisher queries DHT for subscribers
3. Publisher connects directly to each subscriber
4. Message delivered via pubsub_route envelope

**Test Coverage**: 10/10 integration tests passing
- Subscription advertisement
- Subscriber discovery
- Multi-hop topology
- Multiple subscribers

---

## Architecture Changes

### Node Types

All node types now have identical P2P capabilities:

| Node Type | v0.7.x | v0.8.0 |
|-----------|--------|--------|
| **Bootstrap** | DHT only | DHT + QUIC listener |
| **Gateway** | DHT + listener | DHT + QUIC listener |
| **Edge** | DHT only | DHT + QUIC listener |

### Message Flow

#### RPC Message Flow (v0.8.0)
```
1. Client queries DHT for service "calculator"
2. DHT returns: {node_id, endpoint: "172.21.0.33:9443"}
3. Client → peer_connector → QUIC connection → Provider
4. Provider executes RPC, returns result
5. Result → peer_connector → Client
```

#### PubSub Message Flow (v0.8.0)
```
1. Edge1 advertises subscription to "sensor.data" in DHT
2. DHT propagates to k=20 nodes
3. Publisher queries DHT for "sensor.data" subscribers
4. DHT returns: [{node_id, endpoint: "172.21.0.31:9443"}]
5. Publisher → peer_connector → QUIC → Subscriber
6. Message delivered wrapped in pubsub_route envelope
```

### DHT Propagation Flow
```
Edge3 registers service "calculator"
  ↓
macula_routing_server:store(Key, Value)
  ↓
Store locally + Find k=20 closest nodes
  ↓
For each of k nodes:
  ↓
macula_gateway_dht:send_to_peer(Node, store, Message)
  ↓
macula_peer_connector:send_message(Endpoint, store, Message)
  ↓
Establish QUIC connection
  ↓
Send MessagePack-encoded STORE
  ↓
Wait 100ms for transmission
  ↓
Gracefully close stream and connection
  ↓
Remote node receives STORE message
  ↓
Stores value locally in DHT
```

---

## Performance Characteristics

### Connection Pattern
- **Fire-and-forget**: New connection per DHT message
- **Connection lifetime**: ~100-200ms (connect + send + delay + close)
- **No connection pooling**: Simple but creates overhead

### Throughput
- **DHT STORE**: ~5-10 operations/sec per node
- **RPC calls**: Limited by DHT discovery latency (~100-200ms first call, then cached)
- **PubSub messages**: Direct delivery, ~10-50ms latency

### Optimization Opportunities (v0.9.0)
1. **Connection pooling** - Reuse connections to frequently-contacted peers
2. **Persistent streams** - Keep streams open for multiple messages
3. **Batch sending** - Combine multiple DHT operations
4. **Adaptive delay** - Tune delay based on network conditions

---

## Breaking Changes

### None (Fully Backward Compatible)

v0.8.0 is fully compatible with v0.7.x. The internal architecture changed but the external API remains the same.

**Migration**: Simply upgrade - no code changes required.

---

## Files Created

### New Modules
- `src/macula_peer_connector.erl` (112 LOC) - Direct P2P QUIC connections

### New Tests
- `test/integration/multi_hop_rpc_SUITE.erl` (11 tests) - RPC integration tests
- `test/integration/multi_hop_pubsub_SUITE.erl` (10 tests) - PubSub integration tests

### Documentation
- `architecture/v0.8.0-OVERVIEW.md` - This document
- `architecture/v0.8.0-ARCHITECTURE.md` - Technical architecture
- `architecture/v0.8.0-DECISIONS.md` - Architecture Decision Records
- `architecture/v0.8.0-CHANGELOG.md` - Detailed changes
- `architecture/v0.8.0-ROADMAP.md` - Future plans (v0.9.0)
- `architecture/v0.8.0-HISTORY.md` - Development history

---

## Files Modified

### Core Implementation
- `src/macula_routing_server.erl` - Added `store/3` with k-node propagation
- `src/macula_gateway_dht.erl` - Updated to use peer_connector
- `src/macula_service_registry.erl` - Changed to use `store/3` instead of `store_local/3`
- `src/macula_pubsub_dht.erl` - Updated RPC and PubSub to use peer_connector

### Docker Infrastructure
- `docker/Dockerfile.bootstrap` - Enabled gateway, added certs, exposed 9443
- `docker/Dockerfile.edge` - Enabled gateway, added certs, exposed 9443
- `docker/docker-compose.multi-mode.yml` - Added TLS volumes, gateway env vars

### Test Infrastructure
- `test/integration/test_helpers.erl` - Updated to use DHT APIs
- Added routing table seeding for reproducible integration tests

---

## Upgrade Guide

### From v0.7.x to v0.8.0

**Step 1**: Update dependency
```erlang
{deps, [
    {macula, "0.8.0"}
]}.
```

**Step 2**: Rebuild
```bash
rebar3 upgrade macula
rebar3 compile
```

**Step 3**: Update Docker images (if using)
```bash
docker build -f docker/Dockerfile.edge -t macula-edge:0.8.0 .
```

**Step 4**: Verify
```bash
rebar3 eunit
rebar3 ct
```

**No configuration changes required!**

---

## Known Limitations

### TLS Certificate Verification
**Status**: Deferred to v0.9.0
**Impact**: Low (works but less secure)
**Workaround**: Run on trusted networks

Current implementation uses `{verify, none}` for QUIC connections. This works but doesn't validate peer certificates.

**Modules affected**:
- `macula_connection.erl`
- `macula_connection_pool.erl`
- `macula_peer_connector.erl`

**Planned fix (v0.9.0)**: Implement proper certificate validation with CA bundle.

### Fire-and-Forget Pattern Limitations
**Status**: By design
**Impact**: Low (works well for DHT)
**Workaround**: None needed

The peer connector uses fire-and-forget pattern:
- No confirmation of delivery
- No feedback if remote node processed message
- Good for DHT (eventual consistency)
- May need request/response pattern for other use cases (v0.9.0)

### Connection Overhead
**Status**: Optimization opportunity
**Impact**: Medium (creates overhead)
**Workaround**: Acceptable for current workloads

New connection per message creates overhead:
- ~100-200ms per operation
- No connection reuse
- Good enough for service discovery use case
- Connection pooling planned for v0.9.0

---

## What's Next (v0.9.0)

See `architecture/v0.8.0-ROADMAP.md` for detailed planning.

**High Priority**:
1. **Connection Pooling** - Reuse connections to frequently-contacted peers
2. **TLS Certificate Validation** - Proper certificate verification
3. **Request/Response Pattern** - DHT queries with timeout and correlation IDs

**Medium Priority**:
4. **NAT Traversal** - Hole punching for direct P2P behind NAT
5. **Performance Tuning** - Optimize delay parameter, batch operations
6. **Subsystem Refactoring** - Extract bootstrap and relay systems

---

## References

- **Source Code**: https://github.com/macula-io/macula
- **Architecture Docs**: `architecture/v0.8.0-ARCHITECTURE.md`
- **Changelog**: `architecture/v0.8.0-CHANGELOG.md`
- **Roadmap**: `architecture/v0.8.0-ROADMAP.md`
- **Integration Tests**: `test/integration/`

---

## Contributors

- Architecture design and implementation
- Comprehensive integration test coverage
- Documentation and release preparation

---

**Document Version**: 1.0
**Last Updated**: 2025-11-17
**Status**: Final
