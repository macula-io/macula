# Macula v0.8.0 - Supervision Tree Diagrams

**Date**: 2025-11-17
**Purpose**: Visual representation of supervision trees for all deployment modes

---

## Current Architecture (v0.7.x + v0.8.0)

### Complete Supervision Tree (All Components)

```
macula (OTP Application)
â”‚
â””â”€â”€ macula_root (Application Root Supervisor)
    â”‚   Strategy: one_for_one
    â”‚   Intensity: 10/5s
    â”‚
    â”œâ”€â”€â”€ [1] macula_routing_server â­ ALWAYS STARTED
    â”‚         Role: DHT Core (Kademlia)
    â”‚         Storage: routing_table (ETS), key-value (ETS)
    â”‚         API: find_node/3, find_value/2, store/3, store_local/3, get_local/2
    â”‚
    â”œâ”€â”€â”€ [2] macula_bootstrap_system ğŸ†• (CONDITIONAL - bootstrap/hybrid modes)
    â”‚    â”‚   Strategy: one_for_one
    â”‚    â”‚   Intensity: 10/60s
    â”‚    â”‚
    â”‚    â”œâ”€â”€ [2.1] macula_bootstrap_server
    â”‚    â”‚         Role: DHT query handler
    â”‚    â”‚         API: handle_dht_query/2, get_stats/0
    â”‚    â”‚         Delegates: macula_routing_server (for storage)
    â”‚    â”‚
    â”‚    â”œâ”€â”€ [2.2] macula_bootstrap_registry
    â”‚    â”‚         Role: Service registry facade (thin wrapper)
    â”‚    â”‚         API: store_service/2, lookup_service/1, store_topic/2, lookup_topic/1
    â”‚    â”‚         Delegates: macula_routing_server:store_local/3, get_local/2
    â”‚    â”‚
    â”‚    â””â”€â”€ [2.3] macula_bootstrap_health
    â”‚              Role: Health monitoring
    â”‚              Checks: server running, registry running, memory < 80%
    â”‚              Periodic: Every 30-60s
    â”‚
    â””â”€â”€â”€ [3] macula_gateway_system (CONDITIONAL - gateway/hybrid modes)
         â”‚   Strategy: rest_for_one
         â”‚   Intensity: 10/60s
         â”‚
         â”œâ”€â”€ [3.1] macula_gateway_health
         â”‚         Role: HTTP health check server
         â”‚         Port: 8080 (configurable)
         â”‚
         â”œâ”€â”€ [3.2] macula_gateway_diagnostics
         â”‚         Role: Diagnostics and metrics
         â”‚
         â”œâ”€â”€ [3.3] macula_gateway_quic_server
         â”‚         Role: QUIC listener (HTTP/3 transport)
         â”‚         Port: 9443 (configurable)
         â”‚         TLS: cert.pem, key.pem
         â”‚
         â”œâ”€â”€ [3.4] macula_gateway
         â”‚    â”‚    Role: Message routing coordinator
         â”‚    â”‚    Delegates to: rpc_router, pubsub_dht
         â”‚    â”‚
         â”‚    â”œâ”€â”€ Uses: macula_rpc_routing (for RPC messages)
         â”‚    â””â”€â”€ Uses: macula_pubsub_routing (for pub/sub messages)
         â”‚
         â””â”€â”€ [3.5] macula_gateway_workers_sup
              â”‚   Strategy: one_for_one
              â”‚   Intensity: 10/60s
              â”‚
              â”œâ”€â”€ [3.5.1] macula_gateway_client_manager
              â”‚           Role: Client connection lifecycle
              â”‚           Limits: Max 10,000 clients (backpressure)
              â”‚
              â”œâ”€â”€ [3.5.2] macula_gateway_pubsub
              â”‚           Role: Pub/Sub routing with wildcards
              â”‚           Tests: 31 tests passing
              â”‚
              â”œâ”€â”€ [3.5.3] macula_gateway_rpc
              â”‚           Role: RPC handler registration
              â”‚           Tests: 20 tests passing
              â”‚
              â””â”€â”€ [3.5.4] macula_gateway_mesh
                          Role: Mesh connection pooling
                          Strategy: LRU eviction, max 1,000 connections
                          Tests: 22 tests passing
```

---

## Mode-Specific Trees

### Mode 1: Bootstrap Node

```
macula_root
â”‚   Config: {mode, bootstrap}, {start_gateway, false}
â”‚   Purpose: Well-known DHT entry point
â”‚
â”œâ”€â”€â”€ macula_routing_server âœ…
â”‚     Stores: Routing table, peer info, service registrations
â”‚     API: FIND_NODE, FIND_VALUE, STORE
â”‚
â””â”€â”€â”€ macula_bootstrap_system âœ… ğŸ†•
     â”œâ”€â”€ macula_bootstrap_server
     â”‚    Handles: DHT queries from peers
     â”‚    Stats: queries_handled, uptime_seconds, services_registered
     â”‚
     â”œâ”€â”€ macula_bootstrap_registry
     â”‚    API: store_service/lookup_service (RPC services)
     â”‚    API: store_topic/lookup_topic (pub/sub topics)
     â”‚    Storage: Delegates to routing_server (NO ETS!)
     â”‚
     â””â”€â”€ macula_bootstrap_health
          Monitors: server running, registry running, memory usage
          HTTP: GET /health â†’ {status: healthy|unhealthy, checks: [...]}

DOES NOT START:
âŒ macula_gateway_system (no relay needed)
âŒ macula_peer (bootstrap-only, no business logic)

TESTS: âœ… 18 tests passing (100% coverage)
```

---

### Mode 2: Edge Node (Pure P2P)

```
macula_root
â”‚   Config: {mode, edge}, {start_gateway, false}
â”‚   Purpose: Pure P2P peer (no relay)
â”‚
â””â”€â”€â”€ macula_routing_server âœ…
      Connects to: Bootstrap nodes for DHT discovery
      Stores: Local services, subscriptions
      Routes: RPC and pub/sub via DHT (multi-hop)

APPLICATION LAYER (Not supervised by macula_root):
â”‚
â”œâ”€â”€â”€ macula_peer (High-level API facade)
â”‚     API: publish/3, subscribe/3, call/3, register/2
â”‚
â”œâ”€â”€â”€ macula_rpc_handler ğŸ†• (DHT-routed RPC)
â”‚     Wraps calls in: rpc_route envelope (via macula_rpc_routing:wrap_call/4)
â”‚     Routes via: DHT (multi-hop)
â”‚     NO direct connections to provider!
â”‚
â””â”€â”€â”€ macula_pubsub_handler ğŸ†• (DHT-routed pub/sub)
      Discovers subscribers via: DHT (FIND_VALUE for topic)
      Wraps publish in: pubsub_route envelope (via macula_pubsub_routing:wrap_publish/4)
      Routes via: DHT (multi-hop)
      NO gateway relay!

DOES NOT START:
âŒ macula_gateway_system (pure P2P, no relay)
âŒ macula_bootstrap_system (not a bootstrap node)

TESTS: âœ… 20 routing tests passing (RPC + pub/sub)
```

---

### Mode 3: Gateway Node (Relay/NAT Fallback)

```
macula_root
â”‚   Config: {mode, gateway}, {start_gateway, true}
â”‚   Purpose: Relay for NAT-ed peers, fallback for unreachable nodes
â”‚
â”œâ”€â”€â”€ macula_routing_server âœ…
â”‚     Same as edge node
â”‚
â””â”€â”€â”€ macula_gateway_system âœ…
     â”œâ”€â”€ macula_gateway_health (HTTP health checks)
     â”œâ”€â”€ macula_gateway_diagnostics
     â”œâ”€â”€ macula_gateway_quic_server (Accept QUIC connections)
     â”‚    Listen on: 0.0.0.0:9443 (public IP)
     â”‚    TLS: Required (cert.pem, key.pem)
     â”‚
     â”œâ”€â”€ macula_gateway (Message routing coordinator)
     â”‚    Routes: rpc_route, pubsub_route messages
     â”‚    Delegates to:
     â”‚      - macula_gateway_rpc_router (multi-hop RPC)
     â”‚      - macula_pubsub_dht (pub/sub DHT integration)
     â”‚
     â””â”€â”€ macula_gateway_workers_sup
          â”œâ”€â”€ macula_gateway_client_manager (NAT-ed clients)
          â”œâ”€â”€ macula_gateway_pubsub (Pub/Sub routing)
          â”œâ”€â”€ macula_gateway_rpc (RPC handler registry)
          â””â”€â”€ macula_gateway_mesh (Mesh connection pooling)

DOES NOT START:
âŒ macula_bootstrap_system (not a bootstrap node)

ROLE: Optional fallback relay (NOT primary path)
- Most traffic: Direct P2P via DHT routing
- Gateway used: ONLY when direct connection fails (NAT, firewall, etc.)

TESTS: âœ… Gateway refactoring complete (49 tests passing)
```

---

### Mode 4: Hybrid Node (Bootstrap + Gateway)

```
macula_root
â”‚   Config: {mode, hybrid}, {start_gateway, true}
â”‚   Purpose: Well-known entry point + relay capability
â”‚
â”œâ”€â”€â”€ macula_routing_server âœ…
â”‚
â”œâ”€â”€â”€ macula_bootstrap_system âœ…
â”‚     (Same as Mode 1 - bootstrap node)
â”‚
â””â”€â”€â”€ macula_gateway_system âœ…
      (Same as Mode 3 - gateway node)

RESPONSIBILITIES: All of the above
- DHT bootstrap for peer discovery
- Service registry for RPC/pub-sub
- Relay for NAT-ed peers
- Health monitoring

TYPICAL USE CASE: Public-facing infrastructure node
- DNS: bootstrap.macula.io â†’ Hybrid node
- Provides: Discovery + Relay fallback
- High availability deployment

TESTS: â³ Pending (needs mode integration in macula_root)
```

---

## Dependency Flow Diagrams

### RPC Call Flow (Pure P2P - No Gateway Relay)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Client calls RPC service                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_peer:call(Service, Args)     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_rpc_handler:call/3           â”‚
         â”‚ - Discover provider via DHT         â”‚
         â”‚   (FIND_VALUE for service key)      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_rpc_routing:wrap_call/4 ğŸ†•   â”‚
         â”‚ - Wrap in rpc_route envelope        â”‚
         â”‚ - Set hop_count = 0, max_hops = 10  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_connection:send_message/3    â”‚
         â”‚ - Send rpc_route to next hop        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Message hops through mesh (XOR distance routing)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Peer 1 receives rpc_route           â”‚
         â”‚ macula_gateway:handle_decoded_msg   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_rpc_routing:route_or_deliver â”‚
         â”‚ - Destination = this node? No       â”‚
         â”‚ - Find next hop via DHT             â”‚
         â”‚ - Increment hop_count               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Forward to Peer 2 (closer to dest)  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Peer 2 receives rpc_route           â”‚
         â”‚ macula_rpc_routing:route_or_deliver â”‚
         â”‚ - Destination = this node? YES âœ…   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Provider processes call and sends reply                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_gateway_rpc_router:          â”‚
         â”‚   handle_routed_call/5              â”‚
         â”‚ - Invoke local handler              â”‚
         â”‚ - Generate reply                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_rpc_routing:wrap_reply/4     â”‚
         â”‚ - Wrap reply in rpc_route envelope  â”‚
         â”‚ - Destination = original caller     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Reply hops back through mesh        â”‚
         â”‚ (Peer 2 â†’ Peer 1 â†’ Client)          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Client receives reply                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY POINTS:
âœ… NO direct connection from client to provider
âœ… NO gateway relay (unless NAT fallback needed)
âœ… Multi-hop routing via DHT (typically 2-4 hops)
âœ… Scales to O(log N) routing complexity
```

---

### Pub/Sub Flow (Pure P2P - No Gateway Relay)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Publisher publishes to topic                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_peer:publish(Topic, Payload) â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_pubsub_handler:publish/3     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_pubsub_dht:discover_subs     â”‚
         â”‚ - FIND_VALUE in DHT for topic       â”‚
         â”‚ - Returns list of subscriber nodes  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ For each subscriber:                â”‚
         â”‚ macula_pubsub_routing:wrap_publish  â”‚
         â”‚ - Wrap in pubsub_route envelope     â”‚
         â”‚ - Set hop_count = 0, max_hops = 10  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Messages hop through mesh to each subscriber                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Peer receives pubsub_route          â”‚
         â”‚ macula_pubsub_routing:              â”‚
         â”‚   route_or_deliver/3                â”‚
         â”‚ - Destination = this node? YES âœ…   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ macula_gateway:deliver_publish      â”‚
         â”‚ - Invoke subscriber callback        â”‚
         â”‚ - Pass topic and payload            â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KEY POINTS:
âœ… NO gateway relay for pub/sub (removed in v0.8.0!)
âœ… Publisher discovers ALL subscribers via DHT
âœ… Fanout handled by publisher (not gateway)
âœ… Each subscriber message routes independently
âœ… Scales to O(N subscribers Ã— log N hops)
```

---

## Bootstrap Discovery Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge node starts up and needs to join mesh                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Config: bootstrap_nodes =           â”‚
         â”‚   ["bootstrap1.macula.io:9443",     â”‚
         â”‚    "bootstrap2.macula.io:9443"]     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Connect to bootstrap1 via QUIC      â”‚
         â”‚ macula_connection:connect/2         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Send FIND_NODE query                â”‚
         â”‚ Target: Own node ID                 â”‚
         â”‚ Goal: Discover closest peers        â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Bootstrap node responds with:       â”‚
         â”‚ - List of K closest peers (K=20)    â”‚
         â”‚ - Each peer: {node_id, address, port}â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Edge node adds peers to routing     â”‚
         â”‚ table and connects to them          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Now part of mesh! Can discover services and peers via DHT             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BOOTSTRAP NODE RESPONSIBILITIES:
âœ… Accept FIND_NODE queries
âœ… Maintain routing table of known peers
âœ… Return closest peers for any target ID
âœ… Store service registrations (STORE queries)
âœ… Return service locations (FIND_VALUE queries)

EDGE NODE RESPONSIBILITIES:
âœ… Connect to well-known bootstrap nodes
âœ… Discover peers via FIND_NODE
âœ… Populate local routing table
âœ… Store local services in DHT (STORE)
âœ… Discover remote services via DHT (FIND_VALUE)
```

---

## Restart Strategies Summary

| Supervisor | Strategy | Why |
|------------|----------|-----|
| `macula_root` | `one_for_one` | Core + subsystems independent |
| `macula_bootstrap_system` | `one_for_one` | Server, registry, health independent |
| `macula_gateway_system` | `rest_for_one` | Dependencies: quic â†’ gateway â†’ workers |
| `macula_gateway_workers_sup` | `one_for_one` | Workers independent (clients, pubsub, rpc, mesh) |

**Key Principle**: Use `rest_for_one` when there are **runtime dependencies** (e.g., gateway needs quic_server PID). Use `one_for_one` when workers are **independent**.

---

## Module Count by Layer

| Layer | Module Count | Status |
|-------|--------------|--------|
| **Core** | 1 | âœ… Complete |
| - `macula_routing_server` | | DHT Kademlia implementation |
| **Bootstrap System** ğŸ†• | 4 | âœ… Complete |
| - `macula_bootstrap_system` | | Supervisor |
| - `macula_bootstrap_server` | | DHT query handler |
| - `macula_bootstrap_registry` | | Service registry facade |
| - `macula_bootstrap_health` | | Health monitoring |
| **Routing Layer** ğŸ†• | 2 | âœ… Complete |
| - `macula_rpc_routing` | | RPC multi-hop routing |
| - `macula_pubsub_routing` | | Pub/Sub multi-hop routing |
| **Gateway System** | 11 | âœ… Complete |
| - `macula_gateway_system` | | Root supervisor |
| - `macula_gateway_health` | | HTTP health checks |
| - `macula_gateway_diagnostics` | | Diagnostics |
| - `macula_gateway_quic_server` | | QUIC listener |
| - `macula_gateway` | | Message coordinator |
| - `macula_gateway_workers_sup` | | Workers supervisor |
| - `macula_gateway_client_manager` | | Client lifecycle |
| - `macula_gateway_pubsub` | | Pub/Sub routing |
| - `macula_gateway_rpc` | | RPC handler registry |
| - `macula_gateway_rpc_router` | | Multi-hop RPC router |
| - `macula_gateway_mesh` | | Mesh connection pooling |
| **Total** | **18 modules** | âœ… Foundation complete |

---

**Next**: Mode integration in `macula_root` to enable bootstrap/edge/gateway/hybrid deployment modes!
