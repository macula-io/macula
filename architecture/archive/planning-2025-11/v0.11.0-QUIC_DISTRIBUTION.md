# v0.11.0 - QUIC Distribution: Replacing EPMD for the BEAM Ecosystem

**Status**: IMPLEMENTATION IN PROGRESS
**Target**: v0.11.0
**Author**: Macula Team
**Last Updated**: 2025-11-27

## Implementation Status

| Component | Status | Tests |
|-----------|--------|-------|
| `macula_dist.erl` | âœ… Complete | 22 tests |
| `macula_dist_discovery.erl` | âœ… Complete | 7 tests |
| `macula_cluster_strategy.erl` | âœ… Complete | 3 tests |
| `macula_dist_system.erl` | âœ… Complete | - |

**Total Tests**: 31 passing

---

## Executive Summary

Macula v0.11.0 proposes a **fundamental improvement to distributed Erlang**: replacing TCP-based distribution and EPMD with QUIC transport and decentralized discovery. This is not just an internal improvementâ€”it's a potential **significant contribution to the entire BEAM ecosystem**.

### The Problem

Distributed Erlang has been painful for 25+ years:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Current Distributed Erlang Pain                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ðŸ˜“ EPMD (Erlang Port Mapper Daemon)                            â”‚
â”‚     â€¢ Centralized per-host (single point of failure)            â”‚
â”‚     â€¢ Requires TCP port 4369 open                               â”‚
â”‚     â€¢ Cannot work behind NAT                                    â”‚
â”‚     â€¢ Extra daemon to manage, monitor, secure                   â”‚
â”‚                                                                  â”‚
â”‚  ðŸ˜“ TCP Transport                                                â”‚
â”‚     â€¢ Poor NAT traversal                                        â”‚
â”‚     â€¢ No built-in encryption (TLS is optional add-on)          â”‚
â”‚     â€¢ Head-of-line blocking                                     â”‚
â”‚     â€¢ 1-3 RTT connection setup                                  â”‚
â”‚                                                                  â”‚
â”‚  ðŸ˜“ Port Management                                              â”‚
â”‚     â€¢ EPMD port (4369) + distribution port range                â”‚
â”‚     â€¢ Complex firewall rules                                    â”‚
â”‚     â€¢ Kubernetes networking workarounds required                â”‚
â”‚                                                                  â”‚
â”‚  ðŸ˜“ Edge/Mobile Deployment                                       â”‚
â”‚     â€¢ "Just use a VPN" is the standard answer                   â”‚
â”‚     â€¢ IoT devices behind NAT nearly impossible                  â”‚
â”‚     â€¢ Mobile nodes completely impractical                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### The Solution

Macula already uses QUIC (via `quicer`) for mesh networking. By extending this to Erlang distribution itself, we can:

1. **Eliminate EPMD** - Use Macula's mDNS/DHT for decentralized discovery
2. **Unify Transport** - Single QUIC stack for everything
3. **Enable Edge Computing** - NAT-friendly distribution out of the box
4. **Improve Security** - Built-in TLS 1.3 (not optional)

---

## Why This Matters to the BEAM Ecosystem

### Current Landscape

| Solution | Approach | Limitation |
|----------|----------|------------|
| **EPMD + TCP** | OTP default | NAT-unfriendly, centralized, multiple ports |
| **inet_tls_dist** | TLS over TCP | Still NAT-unfriendly, still needs EPMD |
| **[Partisan](https://github.com/lasp-lang/partisan)** | Replace distribution entirely | Different API, steep learning curve |
| **[quic_dist](https://github.com/mickel8/quic_dist)** | QUIC transport only | No discovery, early stage, no ecosystem integration |
| **libcluster** | Discovery only | Still needs EPMD/TCP underneath |

### What's Missing

**No complete solution exists** that provides:
- QUIC transport for Erlang distribution
- Decentralized discovery (no EPMD)
- Integration with existing ecosystem (libcluster, Horde, Swarm)
- Production-ready quality
- Documentation and migration guides

**Macula can be that solution.**

### Potential Impact

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Ecosystem Impact                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ðŸŽ¯ First complete QUIC-native distribution for BEAM            â”‚
â”‚                                                                  â”‚
â”‚  ðŸŽ¯ Decentralized discovery as first-class citizen              â”‚
â”‚                                                                  â”‚
â”‚  ðŸŽ¯ Drop-in compatibility with ecosystem tools:                 â”‚
â”‚     â€¢ libcluster (custom strategy)                              â”‚
â”‚     â€¢ Horde (distributed supervisor/registry)                   â”‚
â”‚     â€¢ Swarm (process distribution)                              â”‚
â”‚     â€¢ Mnesia (replication over QUIC)                            â”‚
â”‚     â€¢ :pg (process groups)                                      â”‚
â”‚                                                                  â”‚
â”‚  ðŸŽ¯ Enables new class of applications:                          â”‚
â”‚     â€¢ Edge AI/ML (TWEANN, distributed training)                 â”‚
â”‚     â€¢ Mobile-first Elixir apps                                  â”‚
â”‚     â€¢ True P2P systems                                          â”‚
â”‚     â€¢ IoT mesh networks                                         â”‚
â”‚     â€¢ Distributed games                                         â”‚
â”‚                                                                  â”‚
â”‚  ðŸŽ¯ Could influence OTP direction (Issue #5426)                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Technical Architecture

### Before: Traditional Erlang Distribution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Node A                   Node B            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Horde  â”‚  â”‚ Mnesia  â”‚           â”‚  Horde  â”‚  â”‚ Mnesia  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚            â”‚                     â”‚            â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â–¼                                  â–¼                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚ Erlang Dist â”‚                    â”‚ Erlang Dist â”‚         â”‚
â”‚      â”‚    API      â”‚                    â”‚    API      â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â”‚                                  â”‚                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚inet_tcp_distâ”‚â—„â”€â”€â”€â”€â”€ TCP â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚inet_tcp_distâ”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â”‚                                  â”‚                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚    EPMD     â”‚â—„â”€â”€â”€â”€ TCP:4369 â”€â”€â”€â”€â–ºâ”‚    EPMD     â”‚         â”‚
â”‚      â”‚  (daemon)   â”‚                    â”‚  (daemon)   â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                  â”‚
â”‚  Ports needed: 4369 + distribution range (e.g., 9100-9155)      â”‚
â”‚  NAT traversal: Poor (TCP, multiple ports, EPMD required)       â”‚
â”‚  Encryption: Optional TLS layer                                 â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### After: Macula QUIC Distribution

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Node A                   Node B            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Horde  â”‚  â”‚ Mnesia  â”‚           â”‚  Horde  â”‚  â”‚ Mnesia  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â”‚
â”‚       â”‚            â”‚                     â”‚            â”‚         â”‚
â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â–¼                                  â–¼                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚ Erlang Dist â”‚                    â”‚ Erlang Dist â”‚         â”‚
â”‚      â”‚    API      â”‚                    â”‚    API      â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â”‚                                  â”‚                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚ macula_dist â”‚â—„â•â•â• QUIC/UDP â•â•â•â•â•â–ºâ”‚ macula_dist â”‚         â”‚
â”‚      â”‚   (QUIC)    â”‚    (single port)   â”‚   (QUIC)    â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚             â”‚                                  â”‚                 â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚      â”‚   Macula    â”‚â—„â•â•â• mDNS/DHT â•â•â•â•â•â–ºâ”‚   Macula    â”‚         â”‚
â”‚      â”‚  Discovery  â”‚   (decentralized)  â”‚  Discovery  â”‚         â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                  â”‚
â”‚  Ports needed: Single QUIC port (e.g., 4433)                    â”‚
â”‚  NAT traversal: Good (UDP-based, connection migration)          â”‚
â”‚  Encryption: Built-in TLS 1.3 (mandatory)                       â”‚
â”‚  Discovery: Decentralized (no single point of failure)          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Unified Stack

Since Macula already uses QUIC for mesh networking, adding QUIC distribution creates a **unified transport layer**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Macula Node                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                  Application Layer                        â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚   â”‚  Macula PubSub  â”‚  â”‚      Macula RPC             â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  Macula DHT     â”‚  â”‚      Macula Platform        â”‚   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â”‚            â”‚                        â”‚                     â”‚  â”‚
â”‚   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚   â”‚                       â–¼                                   â”‚  â”‚
â”‚   â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚
â”‚   â”‚            â”‚   Macula Protocol   â”‚                        â”‚  â”‚
â”‚   â”‚            â”‚   (HTTP/3 mesh)     â”‚                        â”‚  â”‚
â”‚   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                 Distribution Layer                        â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚   â”‚   â”‚  Horde/Swarm    â”‚  â”‚      Mnesia / :pg           â”‚   â”‚  â”‚
â”‚   â”‚   â”‚  libcluster     â”‚  â”‚      :global                â”‚   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚   â”‚            â”‚                        â”‚                     â”‚  â”‚
â”‚   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚  â”‚
â”‚   â”‚                       â–¼                                   â”‚  â”‚
â”‚   â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚
â”‚   â”‚            â”‚    Erlang Dist      â”‚                        â”‚  â”‚
â”‚   â”‚            â”‚   (macula_dist)     â”‚                        â”‚  â”‚
â”‚   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                  Transport Layer                          â”‚  â”‚
â”‚   â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚
â”‚   â”‚            â”‚       quicer        â”‚  â† Shared QUIC stack   â”‚  â”‚
â”‚   â”‚            â”‚  (single endpoint)  â”‚                        â”‚  â”‚
â”‚   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚                  Discovery Layer                          â”‚  â”‚
â”‚   â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚  â”‚
â”‚   â”‚            â”‚  Macula Discovery   â”‚  â† Replaces EPMD       â”‚  â”‚
â”‚   â”‚            â”‚  (mDNS / DHT)       â”‚                        â”‚  â”‚
â”‚   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## QUIC Advantages for Erlang Distribution

| Feature | TCP (inet_tcp_dist) | QUIC (macula_dist) |
|---------|---------------------|-------------------|
| **Encryption** | Optional TLS layer | Built-in TLS 1.3 |
| **Connection setup** | 1-3 RTT | 0-1 RTT (0-RTT resumption) |
| **Head-of-line blocking** | Yes (single stream) | No (multiplexed streams) |
| **NAT traversal** | Poor | Good (UDP-based) |
| **Connection migration** | No | Yes (survives IP changes) |
| **Lossy networks** | Poor | Better (independent streams) |
| **Ports required** | EPMD + dist range | Single port |
| **Discovery** | EPMD (centralized) | mDNS/DHT (decentralized) |

### Stream Multiplexing for Distribution

QUIC's multiplexed streams map naturally to Erlang distribution:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               QUIC Connection (single UDP port)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  Stream 0: Control Channel                                       â”‚
â”‚  â”œâ”€â”€ Handshake messages                                         â”‚
â”‚  â”œâ”€â”€ Heartbeats                                                 â”‚
â”‚  â””â”€â”€ Node monitoring                                            â”‚
â”‚                                                                  â”‚
â”‚  Stream 1: Process Messages (high priority)                     â”‚
â”‚  â”œâ”€â”€ gen_server:call                                            â”‚
â”‚  â”œâ”€â”€ gen_statem messages                                        â”‚
â”‚  â””â”€â”€ Synchronous operations                                     â”‚
â”‚                                                                  â”‚
â”‚  Stream 2: Async Messages (normal priority)                     â”‚
â”‚  â”œâ”€â”€ gen_server:cast                                            â”‚
â”‚  â”œâ”€â”€ Process signals                                            â”‚
â”‚  â””â”€â”€ Asynchronous operations                                    â”‚
â”‚                                                                  â”‚
â”‚  Stream 3: Bulk Data (low priority)                             â”‚
â”‚  â”œâ”€â”€ Large binaries                                             â”‚
â”‚  â”œâ”€â”€ Mnesia replication                                         â”‚
â”‚  â””â”€â”€ Code loading                                               â”‚
â”‚                                                                  â”‚
â”‚  Streams 4+: Dynamic (on-demand)                                â”‚
â”‚  â””â”€â”€ Created for parallel operations                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Ecosystem Integration

### libcluster Strategy

A custom libcluster strategy using Macula discovery:

```erlang
%% Erlang version
-module(macula_cluster_strategy).
-behaviour(gen_server).

-export([start_link/1, init/1, handle_info/2]).

start_link(Opts) ->
    gen_server:start_link(?MODULE, Opts, []).

init(#{topology := Topology, config := Config}) ->
    %% Subscribe to Macula discovery
    ok = macula_discovery:subscribe(self()),
    {ok, #{topology => Topology, config => Config, connected => #{}}}.

%% Handle node discovered via mDNS/DHT
handle_info({node_discovered, NodeName, Ip, Port}, State) ->
    %% Node name format for macula_dist: 'port@ip'
    Node = list_to_atom(integer_to_list(Port) ++ "@" ++ inet:ntoa(Ip)),
    case net_kernel:connect_node(Node) of
        true ->
            {noreply, State#{connected := maps:put(Node, true, maps:get(connected, State))}};
        false ->
            {noreply, State}
    end;

handle_info({node_lost, Node}, State) ->
    erlang:disconnect_node(Node),
    {noreply, State#{connected := maps:remove(Node, maps:get(connected, State))}}.
```

```elixir
# Elixir version
defmodule Cluster.Strategy.Macula do
  @moduledoc """
  libcluster strategy using Macula's mDNS/DHT discovery.
  Works with QUIC distribution - no EPMD required.
  """
  use Cluster.Strategy
  use GenServer

  def start_link(opts) do
    topology = Keyword.fetch!(opts, :topology)
    config = Keyword.fetch!(opts, :config)
    GenServer.start_link(__MODULE__, {topology, config})
  end

  @impl true
  def init({topology, config}) do
    # Subscribe to Macula discovery
    :ok = :macula_discovery.subscribe(self())
    {:ok, %{topology: topology, config: config, connected: MapSet.new()}}
  end

  @impl true
  def handle_info({:node_discovered, node_name, ip, port}, state) do
    # Node name format for macula_dist: 'port@ip'
    node = :"#{port}@#{:inet.ntoa(ip)}"

    case Cluster.Strategy.connect_nodes(state.topology, [node]) do
      :ok ->
        {:noreply, %{state | connected: MapSet.put(state.connected, node)}}
      {:error, _} ->
        {:noreply, state}
    end
  end

  def handle_info({:node_lost, node}, state) do
    Cluster.Strategy.disconnect_nodes(state.topology, [node])
    {:noreply, %{state | connected: MapSet.delete(state.connected, node)}}
  end
end
```

### Configuration Example

```elixir
# config/config.exs
config :libcluster,
  topologies: [
    macula_mesh: [
      strategy: Cluster.Strategy.Macula,
      config: [
        realm: "my-app.macula.local",
        discovery_type: :mdns  # or :dht for internet-scale
      ],
      # These work transparently with macula_dist!
      connect: {:net_kernel, :connect_node, []},
      disconnect: {:erlang, :disconnect_node, []},
      list_nodes: {:erlang, :nodes, [:connected]}
    ]
  ]

# Horde configuration (unchanged - it just works!)
config :horde,
  # ... normal Horde config
```

### Compatibility Matrix

| Library | Compatible? | Notes |
|---------|-------------|-------|
| **libcluster** | âœ… Yes | Custom strategy for Macula discovery |
| **Horde** | âœ… Yes | Transparent - uses Erlang dist API |
| **Swarm** | âœ… Yes | Transparent - uses Erlang dist API |
| **Mnesia** | âœ… Yes | Replication over QUIC |
| **:pg** | âœ… Yes | Process groups over QUIC |
| **:global** | âœ… Yes | Global registry over QUIC |
| **Phoenix.PubSub** | âœ… Yes | Transparent - uses :pg or custom |
| **Commanded** | âœ… Yes | Event sourcing over distributed Erlang |

---

## Implementation Plan

### Phase 1: macula_dist Module (Weeks 1-4)

Implement the distribution carrier interface:

```erlang
-module(macula_dist).

%% Distribution carrier callbacks
-export([
    listen/1,           %% Start listening for connections
    accept/1,           %% Accept incoming connection
    accept_connection/5,%% Handle connection setup
    setup/5,            %% Setup outgoing connection
    close/1,            %% Close connection
    select/1,           %% Select readable connections
    childspecs/0        %% Supervisor childspecs
]).

%% Start QUIC listener for distribution
listen(Name) ->
    Port = get_dist_port(Name),
    Opts = #{
        cert => get_cert(),
        key => get_key(),
        alpn => [<<"macula-dist">>]
    },
    quicer:listen(Port, Opts).

%% ... implementation details
```

### Phase 2: Discovery Integration (Weeks 5-6)

Integrate with existing Macula discovery:

```erlang
-module(macula_dist_discovery).

-export([
    register_node/2,    %% Announce node to mesh
    lookup_node/1,      %% Find node by name
    subscribe/1,        %% Subscribe to node events
    unsubscribe/1       %% Unsubscribe from events
]).

%% Register this node in the DHT
register_node(Name, Port) ->
    NodeInfo = #{
        name => Name,
        port => Port,
        protocol => 'macula-dist',
        capabilities => [dist, rpc, pubsub]
    },
    macula_dht:store(<<"_dist.", Name/binary>>, NodeInfo).
```

### Phase 3: libcluster Strategy (Weeks 7-8)

Publish as standalone hex package:

```
macula_libcluster/
â”œâ”€â”€ src/
â”‚   â””â”€â”€ macula_cluster_strategy.erl
â”œâ”€â”€ lib/
â”‚   â””â”€â”€ cluster/strategy/macula.ex
â”œâ”€â”€ mix.exs
â”œâ”€â”€ rebar.config
â””â”€â”€ README.md
```

### Phase 4: Testing & Documentation (Weeks 9-12)

- Comprehensive test suite
- Performance benchmarks
- Migration guide from EPMD
- Integration examples (Horde, Swarm, Mnesia)
- Troubleshooting guide

### Phase 5: Community Release (Week 13+)

- Publish to hex.pm
- Blog post / announcement
- Submit to OTP for consideration
- Gather community feedback

---

## Migration Guide

### From Traditional EPMD Setup

**Before (vm.args):**
```
-name myapp@192.168.1.100
-setcookie mysecret
```

**After (vm.args):**
```
-proto_dist macula
-no_epmd
-start_epmd false
-name 4433@192.168.1.100
-setcookie mysecret
-macula_dist_port 4433
-macula_discovery mdns
```

### From libcluster EPMD Strategy

**Before:**
```elixir
config :libcluster,
  topologies: [
    k8s: [
      strategy: Cluster.Strategy.Kubernetes,
      config: [...]
    ]
  ]
```

**After:**
```elixir
config :libcluster,
  topologies: [
    macula: [
      strategy: Cluster.Strategy.Macula,
      config: [
        realm: "my-app.local",
        discovery_type: :mdns
      ]
    ]
  ]
```

### Gradual Migration

For existing clusters, migration can be gradual:

1. **Phase 1**: Add Macula nodes alongside EPMD nodes
2. **Phase 2**: Configure bridge nodes that speak both protocols
3. **Phase 3**: Migrate remaining nodes to Macula
4. **Phase 4**: Decommission EPMD

---

## Use Cases Enabled

### 1. Edge AI/ML (TWEANN Distribution)

```erlang
%% Node A (edge device) - trains a neural network
AgentId = genotype:construct_Agent(xor_mimic, default, test),
%% Genome automatically available across mesh via Mnesia over QUIC

%% Node B (another edge device) - can evaluate the same network
Agent = genotype:read({agent, AgentId}),
{ok, Network} = network_compiler:compile(AgentId),
Outputs = tweann_nif:evaluate(Network, Inputs).
```

### 2. Mobile-First Elixir Apps

```elixir
# Mobile node connects to mesh from anywhere
# Connection survives IP changes (QUIC connection migration)
# No VPN required, no port forwarding needed

:macula_peer.connect("game.macula.io", 4433)
:macula_peer.subscribe("game.events", &handle_event/1)
```

### 3. Distributed Gaming

```elixir
# Game server cluster with Horde
# Automatic process distribution across mesh
# Players connect via QUIC (NAT-friendly)

defmodule GameServer do
  use Horde.DynamicSupervisor
  # ... normal Horde code, works over QUIC distribution
end
```

### 4. IoT Mesh Networks

```erlang
%% Sensors automatically discover each other via mDNS
%% Data replication via Mnesia over QUIC
%% No central coordinator required

macula_discovery:subscribe(self()),
receive
    {node_discovered, SensorNode, _, _} ->
        net_kernel:connect_node(SensorNode),
        mnesia:add_table_copy(sensor_data, SensorNode, ram_copies)
end.
```

---

## Success Criteria

### Technical
- [ ] All existing Erlang distribution tests pass
- [ ] Mnesia replication works over QUIC
- [ ] Horde/Swarm integration verified
- [ ] Performance within 10% of TCP distribution
- [ ] 0-RTT reconnection works

### Ecosystem
- [ ] libcluster strategy published to hex.pm
- [ ] Integration examples for major libraries
- [ ] Migration guide from EPMD
- [ ] Community feedback incorporated

### Adoption
- [ ] Used in at least 3 production deployments
- [ ] Positive community reception
- [ ] Considered for OTP inclusion (Issue #5426)

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| QUIC complexity | Medium | High | Build on quic_dist foundation |
| Performance regression | Low | High | Extensive benchmarking |
| Ecosystem incompatibility | Low | Medium | Comprehensive testing |
| OTP changes break it | Low | High | Track OTP releases |
| Limited adoption | Medium | Medium | Strong documentation |

---

## Related Work

- **[quic_dist](https://github.com/mickel8/quic_dist)** - QUIC carrier for Erlang distribution (foundation)
- **[OTP Issue #5426](https://github.com/erlang/otp/issues/5426)** - QUIC as alternative carrier proposal
- **[quicer](https://github.com/emqx/quic)** - QUIC library for Erlang (Macula's transport)
- **[Partisan](https://github.com/lasp-lang/partisan)** - Alternative distribution layer
- **[libcluster](https://github.com/bitwalker/libcluster)** - Cluster formation library

---

## Timeline

| Phase | Duration | Deliverable |
|-------|----------|-------------|
| Design & Planning | 2 weeks | Architecture document (this) |
| macula_dist implementation | 4 weeks | Working QUIC distribution |
| Discovery integration | 2 weeks | mDNS/DHT node discovery |
| libcluster strategy | 2 weeks | Published hex package |
| Testing & docs | 4 weeks | Full test suite, guides |
| Community release | Ongoing | hex.pm, blog, feedback |

**Total**: ~14 weeks to initial release

---

## Conclusion

Macula v0.11.0's QUIC distribution represents a potential **significant contribution to the BEAM ecosystem**. By solving the 25-year-old problem of distributed Erlang behind NAT, we enable an entire class of applications that were previously impractical:

- Edge computing
- Mobile-first apps
- P2P systems
- IoT mesh networks
- Distributed games

The combination of QUIC transport + decentralized discovery + ecosystem integration makes this more than just another transport layerâ€”it's a **complete solution** that could change how BEAM applications are deployed.

---

## References

- [QUIC RFC 9000](https://www.rfc-editor.org/rfc/rfc9000)
- [HTTP/3 RFC 9114](https://www.rfc-editor.org/rfc/rfc9114)
- [Erlang Distribution Protocol](https://www.erlang.org/doc/apps/erts/erl_dist_protocol.html)
- [quicer Documentation](https://github.com/emqx/quic)
- [libcluster Documentation](https://hexdocs.pm/libcluster)
- [Horde Documentation](https://hexdocs.pm/horde)

---

**Document Version**: 1.0
**Status**: VISION / PLANNING
**Feedback**: https://github.com/macula-io/macula/discussions
