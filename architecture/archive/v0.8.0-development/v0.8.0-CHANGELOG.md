# Macula v0.8.0 Changelog

**Release Date**: 2025-11-17

---

## New Features

### Direct Peer-to-Peer Messaging

**New Module**: `macula_peer_connector` (112 LOC)
- Fire-and-forget QUIC connections
- Handles transport_down errors gracefully
- 100ms delay before closing to prevent race conditions
- Simple endpoint parsing

**API**:
```erlang
macula_peer_connector:send_message(Endpoint, MessageType, Message).
macula_peer_connector:send_message(Endpoint, MessageType, Message, Timeout).
```

### DHT STORE Propagation

**Enhanced**: `macula_routing_server:store/3`
- Now propagates to k=20 closest nodes
- Automatic replication across mesh
- Eventual consistency model

**Before**:
```erlang
%% Only stored locally
macula_routing_server:store_local(Pid, Key, Value).
```

**After**:
```erlang
%% Stores locally + propagates to k closest nodes
macula_routing_server:store(Pid, Key, Value).
```

### Gateway on All Node Types

**Changed**: All node types now run QUIC listeners

- Bootstrap nodes: Now accept P2P connections on port 9443
- Gateway nodes: (unchanged) Accept P2P connections on port 9443
- Edge nodes: Now accept P2P connections on port 9443

**Why**: Enables edge nodes to receive incoming DHT messages and participate fully in P2P mesh.

### RPC via Direct P2P

**Updated**: `src/macula_pubsub_dht.erl` (RPC functions)
- Service discovery via DHT
- Direct connection to provider endpoint
- No multi-hop routing needed

**Message Flow**:
1. Query DHT for service → Get endpoint
2. Connect directly via peer_connector
3. Deliver RPC message
4. Return result directly

**Test Coverage**: 11/11 integration tests passing

### PubSub via Direct P2P

**Updated**: `src/macula_pubsub_dht.erl` (PubSub functions)
- Subscription advertisement in DHT
- Subscriber discovery via DHT queries
- Direct message delivery to subscribers

**Message Flow**:
1. Subscriber advertises in DHT
2. Publisher queries DHT for subscribers
3. Publisher connects directly to each subscriber
4. Delivers message wrapped in pubsub_route envelope

**Test Coverage**: 10/10 integration tests passing

---

## Improvements

### Error Handling

**Improved**: QUIC connection error handling
- Added pattern match for 3-tuple errors: `{error, transport_down, Details}`
- Graceful handling of connection failures
- Better error messages

### Stream Lifecycle Management

**Fixed**: Race condition in stream closing
- Added 100ms delay after send before closing stream
- Allows QUIC to flush send buffer
- Prevents "Failed to set stream active: closed" errors
- Graceful shutdown with proper ACKs

### Docker Configuration

**Fixed**: Gateway configuration in Dockerfiles
- Changed hardcoded `start_gateway` to environment-driven
- All node types now expose port 9443
- TLS certificates properly mounted

**Files Modified**:
- `docker/Dockerfile.bootstrap`
- `docker/Dockerfile.edge`
- `docker/docker-compose.multi-mode.yml`

### Test Infrastructure

**New**: Integration test suites
- `test/integration/multi_hop_rpc_SUITE.erl` - 11 RPC tests
- `test/integration/multi_hop_pubsub_SUITE.erl` - 10 PubSub tests
- Routing table seeding for reproducible tests
- Docker-based multi-node testing

**New**: Test helpers
- `test/integration/test_helpers.erl` - DHT operations, Docker exec, health checks

---

## Bug Fixes

### Fixed: Edge Nodes Cannot Send Messages

**Problem**: Edge nodes don't run gateway, so `whereis(macula_gateway)` returned `undefined`.

**Solution**: Implemented `macula_peer_connector` for direct QUIC connections without requiring local gateway.

### Fixed: Edge Nodes Cannot Receive Messages

**Problem**: Edge nodes without QUIC listener cannot accept incoming connections.

**Solution**: Enabled gateway on all node types so every node can receive P2P connections.

### Fixed: QUIC Error Handling

**Problem**: `quicer:connect` returns `{error, transport_down, Details}` (3-tuple) but code only handled 2-tuple errors.

**Solution**: Added pattern match for 3-tuple error.

### Fixed: Stream Closing Race Condition

**Problem**: Sender closed stream immediately after `quicer:send/2`, receiver got "Failed to set stream active: closed".

**Solution**: Added 100ms delay after send before closing.

### Fixed: Dockerfile Configuration Override

**Problem**: `docker-compose.yml` environment variables didn't override Dockerfile CMD arguments.

**Solution**: Changed Dockerfiles to enable gateway by default with proper ENV vars.

---

## Deprecated

### Deprecated: `macula_dht_rpc` module

**Status**: Moved to `src/archive/`
**Reason**: Superseded by `macula_peer_connector`
**Migration**: Use `macula_peer_connector:send_message/3` instead

---

## API Changes

### No Breaking Changes

All v0.7.x APIs remain functional. New functionality is additive.

### New APIs

```erlang
%% macula_peer_connector (NEW)
-spec send_message(binary(), atom(), map()) -> ok | {error, term()}.
-spec send_message(binary(), atom(), map(), timeout()) -> ok | {error, term()}.

%% macula_routing_server (ENHANCED)
-spec store(pid(), binary(), term()) -> ok.  % Now propagates to k nodes
```

### Enhanced APIs

```erlang
%% macula_pubsub_dht (UPDATED)
%% Now uses peer_connector for direct P2P delivery
route_to_subscribers(Topic, Payload, Qos, Subscribers, SourceNodeId).
advertise_subscription(Topic, SubRef, NodeId, Url, ConnMgrPid).
query_dht_async(Topic, Payload, Qos, MsgId, ConnMgrPid).
```

---

## Configuration Changes

### No Required Changes

v0.8.0 is fully backward compatible. No configuration changes required.

### New Optional Configuration

```erlang
%% Future: Connection pooling (v0.9.0)
{macula, [
    {peer_connector, #{
        pool_size => 100,
        connection_ttl => 300000  % 5 minutes
    }}
]}.

%% Future: TLS verification (v0.9.0)
{macula, [
    {tls, #{
        verify => verify_peer,
        cacertfile => "/path/to/ca.pem"
    }}
]}.
```

---

## Performance

### Latency Improvements

- **RPC calls**: 1-hop direct vs 2+ hop relay (~50% latency reduction)
- **PubSub messages**: Direct delivery vs gateway relay (~50% latency reduction)
- **DHT queries**: Local + remote queries (~100-200ms for remote)

### Throughput

- **DHT STORE**: ~5-10 operations/sec per node
- **RPC calls**: Limited by DHT discovery (~100-200ms first call, cached after)
- **PubSub**: Direct delivery, ~10-50ms latency

### Resource Usage

- **Connection overhead**: New connection per message (~100-200ms)
- **Memory**: Minimal increase (peer_connector is stateless)
- **CPU**: Slightly higher due to connection establishment overhead

---

## Testing

### New Test Suites

**RPC Integration Tests** (`test/integration/multi_hop_rpc_SUITE.erl`):
- ✅ test_bootstrap_node_healthy
- ✅ test_gateway_node_healthy
- ✅ test_edge_nodes_healthy
- ✅ test_dht_peer_discovery
- ✅ test_service_registration_in_dht
- ✅ test_service_discovery_via_dht
- ✅ test_single_hop_rpc_call
- ✅ test_multi_hop_rpc_call
- ✅ test_rpc_timeout_handling
- ✅ test_rpc_provider_not_found
- ✅ test_rpc_max_hops_exceeded

**PubSub Integration Tests** (`test/integration/multi_hop_pubsub_SUITE.erl`):
- ✅ test_bootstrap_node_healthy
- ✅ test_gateway_node_healthy
- ✅ test_edge_nodes_healthy
- ✅ test_dht_peer_discovery
- ✅ test_subscription_advertisement_in_dht
- ✅ test_subscriber_discovery_via_dht
- ✅ test_single_hop_pubsub
- ✅ test_multi_hop_pubsub
- ✅ test_wildcard_subscriptions
- ✅ test_multiple_subscribers

**Total**: 21/21 integration tests passing (100%)

---

## Known Issues

### TLS Certificate Verification Disabled

**Impact**: Security concern for production
**Workaround**: Run on trusted networks
**Fix**: Planned for v0.9.0

Currently using `{verify, none}` in QUIC connections. This works but doesn't validate peer certificates.

### Fire-and-Forget Pattern Limitations

**Impact**: No delivery confirmation
**Workaround**: Use eventual consistency model
**Enhancement**: Request/response pattern planned for v0.9.0

The peer connector doesn't confirm delivery or provide feedback. This is by design for DHT operations but may need enhancement for other use cases.

### Connection Overhead

**Impact**: New connection per message
**Workaround**: Acceptable for current workloads
**Optimization**: Connection pooling planned for v0.9.0

Creating new connection for each message adds overhead. Connection pooling will significantly improve performance.

---

## Documentation

### New Documents

- `architecture/v0.8.0-OVERVIEW.md` - Release overview
- `architecture/v0.8.0-ARCHITECTURE.md` - Technical architecture
- `architecture/v0.8.0-DECISIONS.md` - Architecture Decision Records
- `architecture/v0.8.0-CHANGELOG.md` - This document
- `architecture/v0.8.0-ROADMAP.md` - Future plans
- `architecture/v0.8.0-HISTORY.md` - Development history
- `TODO.md` - Tracked limitations and planned improvements

### Updated Documents

- `README.md` - Updated for v0.8.0
- Module @doc comments - Enhanced documentation
- Integration test documentation

### Archived Documents

Moved to `architecture/archive/v0.8.0-development/`:
- Development session summaries
- Implementation progress tracking
- Work breakdown documents
- Phase completion reports

---

## Upgrade Instructions

### From v0.7.x

**Step 1**: Update dependency
```erlang
%% In rebar.config
{deps, [
    {macula, "0.8.0"}
]}.
```

**Step 2**: Rebuild
```bash
rebar3 upgrade macula
rebar3 compile
```

**Step 3**: Update Docker images (optional)
```bash
# Rebuild with v0.8.0
docker build -f docker/Dockerfile.bootstrap -t macula-bootstrap:0.8.0 .
docker build -f docker/Dockerfile.gateway -t macula-gateway:0.8.0 .
docker build -f docker/Dockerfile.edge -t macula-edge:0.8.0 .
```

**Step 4**: Test
```bash
rebar3 eunit
rebar3 ct
```

**No configuration changes required!**

---

## Contributors

Development, testing, documentation, and release preparation.

---

## Release Assets

- **Source**: GitHub tag `v0.8.0`
- **Hex Package**: `macula` v0.8.0
- **Docker Images**:
  - `macula-bootstrap:0.8.0`
  - `macula-gateway:0.8.0`
  - `macula-edge:0.8.0`

---

**Document Version**: 1.0
**Last Updated**: 2025-11-17
