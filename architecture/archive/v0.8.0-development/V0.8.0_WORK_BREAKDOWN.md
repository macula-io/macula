# Macula v0.8.0 - Work Breakdown

**Date**: 2025-11-17
**Purpose**: Detailed task breakdown with implementation steps

---

## Quick Reference

**Completed**: âœ… Bootstrap System (18 tests) + Pure P2P Routing (20 tests) = 38 tests passing
**Next**: Mode integration â†’ Multi-node testing â†’ NAT traversal

**Time Estimate**: 44-53 hours (~6-7 days focused work)

---

## Phase 1: Mode Integration (PRIORITY ðŸ”´)

### Task 1.1: Add Mode Support to `macula_root.erl`

**File**: `/src/macula_root.erl`

**Goal**: Enable bootstrap/edge/gateway/hybrid mode selection via config

**Estimate**: 2-3 hours

**Implementation Steps**:

1. **Add mode detection** (30 min):
   ```erlang
   %% Add to init/1:
   init([]) ->
       Mode = application:get_env(macula, mode, gateway),
       io:format("Starting Macula in ~p mode~n", [Mode]),

       SupFlags = #{strategy => one_for_one, intensity => 10, period => 5},

       %% Build child specs based on mode
       CoreSpecs = get_core_child_specs(),
       BootstrapSpecs = maybe_start_bootstrap(Mode),
       GatewaySpecs = maybe_start_gateway(Mode),

       ChildSpecs = CoreSpecs ++ BootstrapSpecs ++ GatewaySpecs,
       {ok, {SupFlags, ChildSpecs}}.
   ```

2. **Implement `maybe_start_bootstrap/1`** (45 min):
   ```erlang
   maybe_start_bootstrap(bootstrap) -> get_bootstrap_specs();
   maybe_start_bootstrap(hybrid) -> get_bootstrap_specs();
   maybe_start_bootstrap(_) -> [].

   get_bootstrap_specs() ->
       Realm = get_gateway_realm(),
       io:format("Starting Bootstrap System (realm: ~s)~n", [Realm]),
       [
           #{
               id => macula_bootstrap_system,
               start => {macula_bootstrap_system, start_link, [#{
                   realm => Realm,
                   health_check_interval => application:get_env(macula, bootstrap_health_interval, 60000)
               }]},
               restart => permanent,
               shutdown => infinity,  % supervisor
               type => supervisor,
               modules => [macula_bootstrap_system]
           }
       ].
   ```

3. **Update `maybe_start_gateway/0` â†’ `maybe_start_gateway/1`** (45 min):
   ```erlang
   maybe_start_gateway(Mode) ->
       %% Gateway required for: gateway, hybrid modes
       %% Can be overridden by: {start_gateway, false}
       DefaultStartGateway = mode_requires_gateway(Mode),
       StartGateway = application:get_env(macula, start_gateway, DefaultStartGateway),

       case StartGateway of
           true -> get_gateway_specs();
           false ->
               io:format("Gateway disabled for ~p mode~n", [Mode]),
               []
       end.

   mode_requires_gateway(gateway) -> true;
   mode_requires_gateway(hybrid) -> true;
   mode_requires_gateway(bootstrap) -> false;  % Bootstrap-only, no gateway
   mode_requires_gateway(edge) -> false.       % Pure P2P, no gateway
   ```

4. **Add configuration validation** (30 min):
   ```erlang
   validate_mode_config(Mode) ->
       ValidModes = [bootstrap, edge, gateway, hybrid],
       case lists:member(Mode, ValidModes) of
           true -> ok;
           false ->
               io:format("ERROR: Invalid mode ~p. Valid modes: ~p~n", [Mode, ValidModes]),
               erlang:error({invalid_mode, Mode})
       end.
   ```

**Testing** (30 min):

```erlang
%% In test/macula_root_tests.erl:

bootstrap_mode_starts_correct_children_test() ->
    %% Set mode to bootstrap
    application:set_env(macula, mode, bootstrap),
    application:set_env(macula, start_gateway, false),

    {ok, Pid} = macula_root:start_link(),

    %% Verify routing_server started
    ?assertMatch({ok, _}, whereis(macula_routing_server)),

    %% Verify bootstrap_system started
    ?assertMatch({ok, _}, whereis(macula_bootstrap_system)),

    %% Verify gateway NOT started
    ?assertEqual(undefined, whereis(macula_gateway_system)),

    supervisor:stop(Pid).

edge_mode_starts_only_routing_server_test() ->
    application:set_env(macula, mode, edge),
    application:set_env(macula, start_gateway, false),

    {ok, Pid} = macula_root:start_link(),

    ?assertMatch({ok, _}, whereis(macula_routing_server)),
    ?assertEqual(undefined, whereis(macula_bootstrap_system)),
    ?assertEqual(undefined, whereis(macula_gateway_system)),

    supervisor:stop(Pid).
```

**Config Examples**:

```erlang
%% config/bootstrap.config
[
    {macula, [
        {mode, bootstrap},
        {start_gateway, false},
        {realm, <<"macula.global">>},
        {bootstrap_health_interval, 30000}
    ]}
].

%% config/edge.config
[
    {macula, [
        {mode, edge},
        {start_gateway, false},
        {bootstrap_nodes, [
            <<"bootstrap1.macula.io:9443">>,
            <<"bootstrap2.macula.io:9443">>
        ]}
    ]}
].

%% config/gateway.config
[
    {macula, [
        {mode, gateway},
        {start_gateway, true},
        {gateway_port, 9443},
        {gateway_realm, <<"macula.relay">>}
    ]}
].

%% config/hybrid.config
[
    {macula, [
        {mode, hybrid},
        {start_gateway, true},
        {gateway_port, 9443},
        {realm, <<"macula.global">>}
    ]}
].
```

---

### Task 1.2: Create Docker Images for Each Mode

**Files**:
- `/docker/Dockerfile.bootstrap`
- `/docker/Dockerfile.edge`
- `/docker/Dockerfile.gateway`
- `/docker/docker-compose.multi-mode.yml`

**Estimate**: 4-6 hours

**Implementation Steps**:

1. **Base Dockerfile** (45 min):
   ```dockerfile
   # docker/Dockerfile.base
   FROM erlang:26-alpine AS builder

   # Install build dependencies
   RUN apk add --no-cache git make gcc musl-dev

   # Copy source
   WORKDIR /opt/macula
   COPY . .

   # Compile
   RUN rebar3 compile
   RUN rebar3 as prod release

   # Runtime image
   FROM alpine:3.18
   RUN apk add --no-cache ncurses-libs libstdc++ openssl

   WORKDIR /opt/macula
   COPY --from=builder /opt/macula/_build/prod/rel/macula .

   # This will be overridden by mode-specific images
   CMD ["./bin/macula", "foreground"]
   ```

2. **Bootstrap Dockerfile** (30 min):
   ```dockerfile
   # docker/Dockerfile.bootstrap
   FROM erlang:26-alpine AS builder
   WORKDIR /opt/macula
   COPY . .
   RUN rebar3 compile && rebar3 as prod release

   FROM alpine:3.18
   RUN apk add --no-cache ncurses-libs libstdc++ openssl
   WORKDIR /opt/macula
   COPY --from=builder /opt/macula/_build/prod/rel/macula .

   # Bootstrap mode configuration
   ENV MODE=bootstrap
   ENV START_GATEWAY=false
   ENV MACULA_REALM=macula.global
   ENV HEALTH_PORT=8080

   EXPOSE 8080

   # Start with bootstrap config
   CMD ["./bin/macula", "foreground", "-config", "config/bootstrap.config"]
   ```

3. **Edge Dockerfile** (30 min):
   ```dockerfile
   # docker/Dockerfile.edge
   FROM erlang:26-alpine AS builder
   WORKDIR /opt/macula
   COPY . .
   RUN rebar3 compile && rebar3 as prod release

   FROM alpine:3.18
   RUN apk add --no-cache ncurses-libs libstdc++ openssl
   WORKDIR /opt/macula
   COPY --from=builder /opt/macula/_build/prod/rel/macula .

   # Edge mode configuration
   ENV MODE=edge
   ENV START_GATEWAY=false
   ENV BOOTSTRAP_NODES=bootstrap:9443

   # No ports exposed (client-only)

   CMD ["./bin/macula", "foreground", "-config", "config/edge.config"]
   ```

4. **Gateway Dockerfile** (30 min):
   ```dockerfile
   # docker/Dockerfile.gateway
   FROM erlang:26-alpine AS builder
   WORKDIR /opt/macula
   COPY . .
   RUN rebar3 compile && rebar3 as prod release

   FROM alpine:3.18
   RUN apk add --no-cache ncurses-libs libstdc++ openssl
   WORKDIR /opt/macula
   COPY --from=builder /opt/macula/_build/prod/rel/macula .

   # Gateway mode configuration
   ENV MODE=gateway
   ENV START_GATEWAY=true
   ENV GATEWAY_PORT=9443
   ENV HEALTH_PORT=8080
   ENV MACULA_REALM=macula.relay

   EXPOSE 9443 8080

   CMD ["./bin/macula", "foreground", "-config", "config/gateway.config"]
   ```

5. **Multi-Mode Docker Compose** (2 hours):
   ```yaml
   # docker/docker-compose.multi-mode.yml
   version: '3.8'

   services:
     # Bootstrap node (well-known entry point)
     bootstrap:
       build:
         context: ..
         dockerfile: docker/Dockerfile.bootstrap
       container_name: macula-bootstrap
       hostname: bootstrap
       environment:
         - MODE=bootstrap
         - START_GATEWAY=false
         - MACULA_REALM=macula.test
         - NODE_ID=${BOOTSTRAP_NODE_ID:-}
       ports:
         - "8080:8080"  # Health check
       networks:
         macula_mesh:
           ipv4_address: 172.20.0.10
       healthcheck:
         test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
         interval: 5s
         timeout: 3s
         retries: 3

     # Gateway node (relay for NAT-ed peers)
     gateway:
       build:
         context: ..
         dockerfile: docker/Dockerfile.gateway
       container_name: macula-gateway
       hostname: gateway
       environment:
         - MODE=gateway
         - START_GATEWAY=true
         - GATEWAY_PORT=9443
         - MACULA_REALM=macula.test
         - BOOTSTRAP_NODES=bootstrap:9443
       ports:
         - "9443:9443"  # QUIC listener
         - "8081:8080"  # Health check
       depends_on:
         bootstrap:
           condition: service_healthy
       networks:
         macula_mesh:
           ipv4_address: 172.20.0.20
       volumes:
         - ../docker/certs:/opt/macula/certs:ro

     # Edge node 1 (pure P2P peer)
     edge1:
       build:
         context: ..
         dockerfile: docker/Dockerfile.edge
       container_name: macula-edge1
       hostname: edge1
       environment:
         - MODE=edge
         - START_GATEWAY=false
         - BOOTSTRAP_NODES=bootstrap:9443
       depends_on:
         bootstrap:
           condition: service_healthy
       networks:
         macula_mesh:
           ipv4_address: 172.20.0.31

     # Edge node 2 (pure P2P peer)
     edge2:
       build:
         context: ..
         dockerfile: docker/Dockerfile.edge
       container_name: macula-edge2
       hostname: edge2
       environment:
         - MODE=edge
         - START_GATEWAY=false
         - BOOTSTRAP_NODES=bootstrap:9443
       depends_on:
         bootstrap:
           condition: service_healthy
       networks:
         macula_mesh:
           ipv4_address: 172.20.0.32

     # Edge node 3 (pure P2P peer - RPC provider)
     edge3:
       build:
         context: ..
         dockerfile: docker/Dockerfile.edge
       container_name: macula-edge3
       hostname: edge3
       environment:
         - MODE=edge
         - START_GATEWAY=false
         - BOOTSTRAP_NODES=bootstrap:9443
       depends_on:
         bootstrap:
           condition: service_healthy
       networks:
         macula_mesh:
           ipv4_address: 172.20.0.33

   networks:
     macula_mesh:
       driver: bridge
       ipam:
         config:
           - subnet: 172.20.0.0/16
   ```

6. **Test Script** (1 hour):
   ```bash
   #!/bin/bash
   # docker/test-multi-mode.sh

   set -e

   echo "=== Building Docker images ==="
   docker-compose -f docker/docker-compose.multi-mode.yml build --no-cache

   echo "=== Starting multi-mode test environment ==="
   docker-compose -f docker/docker-compose.multi-mode.yml up -d

   echo "=== Waiting for bootstrap to become healthy ==="
   sleep 5

   echo "=== Testing bootstrap node health ==="
   curl -s http://localhost:8080/health | jq .

   echo "=== Testing gateway node health ==="
   curl -s http://localhost:8081/health | jq .

   echo "=== Checking DHT connectivity ==="
   docker exec macula-edge1 bin/macula remote_console <<EOF
   {ok, RoutingPid} = whereis(macula_routing_server).
   macula_routing_server:get_routing_table(RoutingPid).
   EOF

   echo "=== All tests passed! ==="
   ```

---

## Phase 2: Multi-Hop Integration Testing

### Task 2.1: Multi-Node RPC Integration Test

**File**: `/test/integration/multi_hop_rpc_SUITE.erl` (Common Test suite)

**Estimate**: 6-8 hours

**Test Topology**:
```
Bootstrap (172.20.0.10)
    â”‚
    â”œâ”€â”€â”€ Gateway (172.20.0.20)
    â”‚       â”‚
    â”‚       â”œâ”€â”€â”€ Edge1 (172.20.0.31)
    â”‚       â””â”€â”€â”€ Edge2 (172.20.0.32 - RPC client)
    â”‚
    â””â”€â”€â”€ Edge3 (172.20.0.33 - RPC provider)

RPC Flow: Edge2 â†’ Edge1 â†’ Gateway â†’ Edge3
          (Client discovers provider via DHT, routes via mesh)
```

**Implementation**:

```erlang
-module(multi_hop_rpc_SUITE).
-include_lib("common_test/include/ct.hrl").
-include_lib("eunit/include/eunit.hrl").

-export([all/0, init_per_suite/1, end_per_suite/1]).
-export([
    test_rpc_discovery_via_dht/1,
    test_rpc_call_single_hop/1,
    test_rpc_call_multi_hop/1,
    test_rpc_timeout_handling/1,
    test_rpc_provider_not_found/1
]).

all() -> [
    test_rpc_discovery_via_dht,
    test_rpc_call_single_hop,
    test_rpc_call_multi_hop,
    test_rpc_timeout_handling,
    test_rpc_provider_not_found
].

init_per_suite(Config) ->
    %% Start Docker Compose environment
    os:cmd("docker-compose -f docker/docker-compose.multi-mode.yml up -d"),
    timer:sleep(10000),  % Wait for services to start

    %% Store container info
    [{bootstrap_ip, "172.20.0.10"},
     {gateway_ip, "172.20.0.20"},
     {edge1_ip, "172.20.0.31"},
     {edge2_ip, "172.20.0.32"},
     {edge3_ip, "172.20.0.33"}
     | Config].

end_per_suite(_Config) ->
    os:cmd("docker-compose -f docker/docker-compose.multi-mode.yml down"),
    ok.

test_rpc_discovery_via_dht(Config) ->
    %% Edge3 registers RPC service "test.calculator.add"
    Edge3Ip = ?config(edge3_ip, Config),
    ServiceKey = <<"test.calculator.add">>,

    %% Register service in DHT
    {ok, _} = rpc:call(Edge3Ip, macula_bootstrap_registry, store_service, [
        ServiceKey,
        #{node_id => get_node_id(Edge3Ip), endpoint => <<"172.20.0.33:9443">>}
    ]),

    %% Edge2 discovers service via DHT
    Edge2Ip = ?config(edge2_ip, Config),
    {ok, Providers} = rpc:call(Edge2Ip, macula_bootstrap_registry, lookup_service, [ServiceKey]),

    %% Should find Edge3 as provider
    ?assertMatch([#{node_id := _, endpoint := <<"172.20.0.33:9443">>}], Providers).

test_rpc_call_multi_hop(Config) ->
    %% Edge2 calls RPC service on Edge3 (routes via Edge1 â†’ Gateway â†’ Edge3)
    Edge2Ip = ?config(edge2_ip, Config),

    Result = rpc:call(Edge2Ip, macula_peer, call, [
        <<"test.calculator.add">>,
        #{a => 5, b => 3},
        5000  % 5 second timeout
    ]),

    %% Should receive reply #{sum => 8}
    ?assertMatch({ok, #{sum := 8}}, Result).

%% ... more tests ...
```

---

## Phase 3: NAT Traversal

### Task 3.1: Relay System Extraction

**Estimate**: 8-10 hours

**Files to Create**:
- `/src/macula_relay_system/macula_relay_system.erl`
- `/src/macula_relay_system/macula_relay_server.erl`
- `/src/macula_relay_system/macula_relay_connection.erl`

**Steps**: See detailed breakdown in V0.8.0_ARCHITECTURE_OVERVIEW.md

---

## Quick Start Commands

```bash
# 1. Mode integration
cd /home/rl/work/github.com/macula-io/macula
vim src/macula_root.erl  # Implement mode support

# 2. Test mode support
rebar3 eunit --module=macula_root_tests

# 3. Build Docker images
docker-compose -f docker/docker-compose.multi-mode.yml build --no-cache

# 4. Run multi-mode test
./docker/test-multi-mode.sh

# 5. Run integration tests
rebar3 ct --suite=test/integration/multi_hop_rpc_SUITE
```

---

## Summary

**Phase 1 (Week 1-2)**: Mode integration + Docker images
- Task 1.1: 2-3 hours (mode support in macula_root)
- Task 1.2: 4-6 hours (Docker images + compose)

**Phase 2 (Week 2-3)**: Multi-hop integration testing
- Task 2.1: 6-8 hours (RPC multi-hop test)
- Task 2.2: 6-8 hours (Pub/Sub multi-hop test)

**Phase 3 (Week 3-4)**: NAT traversal preparation
- Task 3.1: 8-10 hours (Relay system extraction)
- Task 3.2: 6-8 hours (NAT discovery module)

**Total**: 44-53 hours

**Critical Path**: Phase 1 â†’ Phase 2 â†’ Phase 3
**Parallel Work**: Docker images can be built while implementing mode support

**Next Session**: Start with Task 1.1 (mode support in macula_root)
