# Macula v0.8.0 - Architecture Overview

**Date**: 2025-11-17
**Status**: In Progress (Bootstrap + Pure P2P complete, Integration pending)

---

## Table of Contents

1. [Supervision Trees](#supervision-trees)
2. [Module Dependencies](#module-dependencies)
3. [Deployment Modes](#deployment-modes)
4. [Responsibilities Matrix](#responsibilities-matrix)
5. [Work To Do](#work-to-do)

---

## Supervision Trees

### Current Architecture (v0.7.x + Bootstrap System)

```
macula (OTP Application)
â””â”€â”€ macula_root (Application Root Supervisor)
    â”œâ”€â”€ macula_routing_server (DHT Core - ALWAYS STARTED)
    â”‚   â””â”€â”€ State: routing_table (ETS), storage (ETS), node_id
    â”‚
    â””â”€â”€ macula_gateway_system (Conditional - Gateway Mode)
        â”œâ”€â”€ macula_gateway_health (HTTP health checks)
        â”œâ”€â”€ macula_gateway_diagnostics (Diagnostics service)
        â”œâ”€â”€ macula_gateway_quic_server (QUIC listener)
        â”œâ”€â”€ macula_gateway (Message routing coordinator)
        â”‚   â””â”€â”€ Delegates to:
        â”‚       â”œâ”€â”€ macula_gateway_rpc_router (multi-hop RPC routing)
        â”‚       â””â”€â”€ macula_pubsub_dht (pub/sub DHT integration)
        â”‚
        â””â”€â”€ macula_gateway_workers_sup (Business Logic Workers)
            â”œâ”€â”€ macula_gateway_client_manager (Client lifecycle)
            â”œâ”€â”€ macula_gateway_pubsub (Pub/Sub routing)
            â”œâ”€â”€ macula_gateway_rpc (RPC handler registry)
            â””â”€â”€ macula_gateway_mesh (Mesh connection pooling)
```

### NEW: Bootstrap System (v0.8.0)

```
macula_bootstrap_system (Bootstrap Root Supervisor)
â”œâ”€â”€ macula_bootstrap_server (DHT query handler)
â”‚   â”œâ”€â”€ Handles: FIND_NODE, FIND_VALUE, STORE
â”‚   â”œâ”€â”€ Delegates storage to: macula_routing_server
â”‚   â””â”€â”€ Tracks: query stats, uptime
â”‚
â”œâ”€â”€ macula_bootstrap_registry (Service registry facade)
â”‚   â”œâ”€â”€ API: store_service/2, lookup_service/1
â”‚   â”œâ”€â”€ API: store_topic/2, lookup_topic/1
â”‚   â””â”€â”€ Delegates ALL storage to: macula_routing_server
â”‚
â””â”€â”€ macula_bootstrap_health (Health monitoring)
    â”œâ”€â”€ Checks: server running, registry running, memory
    â””â”€â”€ Periodic checks every 30s (configurable)
```

**Key Principle**: Bootstrap system is a **thin wrapper** around DHT - it does NOT duplicate storage!

---

## Module Dependencies

### Dependency Graph (Current)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CORE LAYER (Always Required)                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  macula_routing_server (DHT Core)                                â”‚
â”‚  â”œâ”€â”€ Provides: Key-value storage, routing table, peer discovery â”‚
â”‚  â”œâ”€â”€ Used by: ALL systems (bootstrap, gateway, peer)            â”‚
â”‚  â””â”€â”€ Dependencies: crypto, ets                                   â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ROUTING LAYER (Pure P2P Infrastructure)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  macula_rpc_routing                                              â”‚
â”‚  â”œâ”€â”€ Provides: wrap_call/4, wrap_reply/4, route_or_deliver/3   â”‚
â”‚  â”œâ”€â”€ Used by: macula_rpc_handler, macula_gateway_rpc_router    â”‚
â”‚  â””â”€â”€ Dependencies: macula_routing_server                        â”‚
â”‚                                                                   â”‚
â”‚  macula_pubsub_routing                                           â”‚
â”‚  â”œâ”€â”€ Provides: wrap_publish/4, route_or_deliver/3              â”‚
â”‚  â”œâ”€â”€ Used by: macula_pubsub_handler, macula_pubsub_dht         â”‚
â”‚  â””â”€â”€ Dependencies: macula_routing_server                        â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BOOTSTRAP SYSTEM (New in v0.8.0)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  macula_bootstrap_system (Supervisor)                            â”‚
â”‚  â”œâ”€â”€ macula_bootstrap_server                                    â”‚
â”‚  â”‚   â””â”€â”€ Dependencies: macula_routing_server                   â”‚
â”‚  â”œâ”€â”€ macula_bootstrap_registry                                  â”‚
â”‚  â”‚   â””â”€â”€ Dependencies: macula_routing_server                   â”‚
â”‚  â””â”€â”€ macula_bootstrap_health                                    â”‚
â”‚      â””â”€â”€ Dependencies: macula_bootstrap_server, registry       â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GATEWAY SYSTEM (Relay/NAT Fallback)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  macula_gateway_system (Supervisor)                              â”‚
â”‚  â”œâ”€â”€ macula_gateway_quic_server                                 â”‚
â”‚  â”‚   â””â”€â”€ Dependencies: quicer (QUIC transport)                 â”‚
â”‚  â”œâ”€â”€ macula_gateway                                              â”‚
â”‚  â”‚   â”œâ”€â”€ Dependencies: macula_rpc_routing, macula_pubsub_routingâ”‚
â”‚  â”‚   â””â”€â”€ Delegates to: gateway_rpc_router, pubsub_dht          â”‚
â”‚  â””â”€â”€ macula_gateway_workers_sup                                 â”‚
â”‚      â”œâ”€â”€ macula_gateway_client_manager                          â”‚
â”‚      â”œâ”€â”€ macula_gateway_pubsub                                  â”‚
â”‚      â”œâ”€â”€ macula_gateway_rpc                                     â”‚
â”‚      â””â”€â”€ macula_gateway_mesh                                    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PEER SYSTEM (RPC/Pub-Sub Handlers)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  macula_rpc_handler                                              â”‚
â”‚  â”œâ”€â”€ Provides: RPC client operations (call, register)          â”‚
â”‚  â”œâ”€â”€ Dependencies: macula_rpc_routing, macula_routing_server   â”‚
â”‚  â””â”€â”€ Wraps calls in rpc_route envelope (DHT routing)            â”‚
â”‚                                                                   â”‚
â”‚  macula_pubsub_handler                                           â”‚
â”‚  â”œâ”€â”€ Provides: Pub/Sub operations (publish, subscribe)         â”‚
â”‚  â”œâ”€â”€ Dependencies: macula_pubsub_routing, macula_routing_serverâ”‚
â”‚  â””â”€â”€ Uses DHT for subscriber discovery (pure P2P)              â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Modes

### Mode 1: Bootstrap Node

**Purpose**: Well-known DHT entry point for peer discovery

**What Starts**:
```
macula_root
â”œâ”€â”€ macula_routing_server âœ… (DHT core)
â””â”€â”€ macula_bootstrap_system âœ… (NEW)
    â”œâ”€â”€ macula_bootstrap_server
    â”œâ”€â”€ macula_bootstrap_registry
    â””â”€â”€ macula_bootstrap_health
```

**Configuration**:
```erlang
%% In sys.config or environment:
{macula, [
    {mode, bootstrap},
    {realm, <<"macula.global">>},
    {start_gateway, false}  % No gateway needed
]}.
```

**Responsibilities**:
- Accept DHT queries (FIND_NODE, FIND_VALUE, STORE)
- Maintain routing table of known peers
- Store service registrations in DHT
- Health monitoring and metrics
- **Does NOT relay messages** (pure DHT bootstrap)

**Status**: âœ… **COMPLETE** (18 tests passing)

---

### Mode 2: Edge Node (Pure P2P)

**Purpose**: Client peer with direct P2P communication

**What Starts**:
```
macula_root
â”œâ”€â”€ macula_routing_server âœ… (DHT core)
â””â”€â”€ macula_peer âœ… (High-level API)
    â”œâ”€â”€ macula_rpc_handler (DHT-routed RPC)
    â””â”€â”€ macula_pubsub_handler (DHT-routed pub/sub)
```

**Configuration**:
```erlang
{macula, [
    {mode, edge},
    {start_gateway, false},
    {bootstrap_nodes, [
        <<"bootstrap1.macula.io:9443">>,
        <<"bootstrap2.macula.io:9443">>
    ]}
]}.
```

**Responsibilities**:
- Connect to bootstrap nodes for DHT discovery
- Publish/subscribe via DHT routing (pure P2P)
- RPC calls via DHT routing (pure P2P)
- Store local services in DHT
- **No gateway relay** - all traffic is P2P

**Status**: âœ… **CORE COMPLETE** (20 routing tests passing)

---

### Mode 3: Gateway Node (Relay/NAT Fallback)

**Purpose**: Relay for NAT-ed peers, fallback for unreachable nodes

**What Starts**:
```
macula_root
â”œâ”€â”€ macula_routing_server âœ… (DHT core)
â””â”€â”€ macula_gateway_system âœ… (Conditional)
    â”œâ”€â”€ macula_gateway_quic_server (QUIC listener)
    â”œâ”€â”€ macula_gateway (Routing coordinator)
    â””â”€â”€ macula_gateway_workers_sup
        â”œâ”€â”€ macula_gateway_client_manager
        â”œâ”€â”€ macula_gateway_pubsub
        â”œâ”€â”€ macula_gateway_rpc
        â””â”€â”€ macula_gateway_mesh
```

**Configuration**:
```erlang
{macula, [
    {mode, gateway},
    {start_gateway, true},
    {gateway_port, 9443},
    {gateway_realm, <<"macula.relay">>}
]}.
```

**Responsibilities**:
- Accept QUIC connections from NAT-ed peers
- Relay messages when direct P2P fails
- Gateway becomes **optional fallback**, NOT primary path
- Multi-hop RPC routing (when needed)
- Mesh connection pooling

**Status**: âœ… **EXISTING** (Gateway refactoring complete, needs relay extraction)

---

### Mode 4: Hybrid Node (Bootstrap + Gateway)

**Purpose**: Well-known entry point with relay capability

**What Starts**:
```
macula_root
â”œâ”€â”€ macula_routing_server âœ…
â”œâ”€â”€ macula_bootstrap_system âœ…
â””â”€â”€ macula_gateway_system âœ…
```

**Configuration**:
```erlang
{macula, [
    {mode, hybrid},
    {start_gateway, true},
    {gateway_port, 9443}
]}.
```

**Responsibilities**: All of the above (Bootstrap + Gateway)

**Status**: â³ **PENDING** (Needs mode integration in macula_root)

---

## Responsibilities Matrix

| Component | Bootstrap | Edge | Gateway | Hybrid |
|-----------|-----------|------|---------|--------|
| **DHT Core** | âœ… | âœ… | âœ… | âœ… |
| DHT queries (FIND_NODE, FIND_VALUE, STORE) | âœ… | âœ… | âœ… | âœ… |
| Routing table maintenance | âœ… | âœ… | âœ… | âœ… |
| **Bootstrap System** | âœ… | âŒ | âŒ | âœ… |
| Service registry facade | âœ… | âŒ | âŒ | âœ… |
| Health monitoring | âœ… | âŒ | âŒ | âœ… |
| **Pure P2P Messaging** | âŒ | âœ… | âœ… | âœ… |
| RPC via DHT routing | âŒ | âœ… | âœ… | âœ… |
| Pub/Sub via DHT routing | âŒ | âœ… | âœ… | âœ… |
| **Gateway/Relay** | âŒ | âŒ | âœ… | âœ… |
| QUIC listener | âŒ | âŒ | âœ… | âœ… |
| Message relay (NAT fallback) | âŒ | âŒ | âœ… | âœ… |
| Client connection management | âŒ | âŒ | âœ… | âœ… |

---

## Work To Do

### Phase 1: Mode Integration (Week 1-2) - **PRIORITY**

#### Task 1.1: Add Mode Support to `macula_root`

**File**: `/src/macula_root.erl`

**Changes Needed**:

```erlang
%% Add to get_core_child_specs/0:
get_core_child_specs() ->
    Mode = application:get_env(macula, mode, gateway),
    io:format("Starting Macula in ~p mode~n", [Mode]),

    CoreSpecs = [
        %% DHT routing server (always required)
        #{
            id => macula_routing_server,
            start => {macula_routing_server, start_link, [get_node_id(), get_routing_config()]},
            restart => permanent,
            shutdown => 5000,
            type => worker,
            modules => [macula_routing_server]
        }
    ],

    %% Add bootstrap system if mode is bootstrap or hybrid
    BootstrapSpecs = maybe_start_bootstrap(Mode),

    CoreSpecs ++ BootstrapSpecs.

%% NEW FUNCTION:
maybe_start_bootstrap(bootstrap) -> get_bootstrap_specs();
maybe_start_bootstrap(hybrid) -> get_bootstrap_specs();
maybe_start_bootstrap(_) -> [].

%% NEW FUNCTION:
get_bootstrap_specs() ->
    Realm = get_gateway_realm(),
    io:format("Starting Bootstrap System (realm: ~s)~n", [Realm]),
    [
        #{
            id => macula_bootstrap_system,
            start => {macula_bootstrap_system, start_link, [#{
                realm => Realm,
                health_check_interval => 60000
            }]},
            restart => permanent,
            shutdown => infinity,
            type => supervisor,
            modules => [macula_bootstrap_system]
        }
    ].
```

**Update `maybe_start_gateway/0`**:

```erlang
maybe_start_gateway() ->
    Mode = application:get_env(macula, mode, gateway),
    StartGateway = application:get_env(macula, start_gateway, mode_requires_gateway(Mode)),

    case StartGateway of
        true -> get_gateway_specs();
        false ->
            io:format("Gateway disabled for ~p mode~n", [Mode]),
            []
    end.

%% NEW FUNCTION:
mode_requires_gateway(gateway) -> true;
mode_requires_gateway(hybrid) -> true;
mode_requires_gateway(_) -> false.
```

**Estimate**: 2-3 hours
**Tests**: Update `macula_root` tests to verify mode-based startup

---

#### Task 1.2: Create Docker Images for Each Mode

**Files**: `/docker/Dockerfile.bootstrap`, `/docker/Dockerfile.edge`, `/docker/Dockerfile.gateway`

**Dockerfile.bootstrap**:
```dockerfile
FROM erlang:26-alpine

# Copy application
COPY . /opt/macula
WORKDIR /opt/macula

# Compile
RUN rebar3 compile

# Environment configuration
ENV MODE=bootstrap
ENV MACULA_REALM=macula.global
ENV START_GATEWAY=false

# Expose health port
EXPOSE 8080

# Start in bootstrap mode
CMD ["rebar3", "shell", "--config", "config/bootstrap.config"]
```

**Estimate**: 4-6 hours (3 Dockerfiles + Docker Compose)
**Tests**: Multi-node Docker test with 1 bootstrap + 3 edge nodes

---

### Phase 2: Multi-Hop Integration Testing (Week 2-3)

#### Task 2.1: Multi-Node RPC Test

**File**: `/test/integration/multi_hop_rpc_test.erl`

**Test Scenario**:
```
[Bootstrap Node] â† Connect â† [Gateway Node]
                               â†“
                         [Edge Node 1] â† Connect â† [Edge Node 2 (client)]
                               â†‘
                         [Edge Node 3 (provider)]

Flow: Edge2 (client) â†’ Edge1 â†’ Gateway â†’ Edge3 (provider)
      via DHT routing (max 3 hops)
```

**Test Cases**:
1. Client discovers provider via DHT (FIND_VALUE for service)
2. Client wraps RPC call in `rpc_route` envelope
3. Message hops through mesh (Edge2 â†’ Edge1 â†’ Gateway â†’ Edge3)
4. Provider receives call, processes, sends reply
5. Reply routes back via DHT (Edge3 â†’ Gateway â†’ Edge1 â†’ Edge2)
6. Client receives reply within timeout

**Estimate**: 6-8 hours
**Dependencies**: Docker images from Phase 1

---

#### Task 2.2: Multi-Node Pub/Sub Test

**File**: `/test/integration/multi_hop_pubsub_test.erl`

**Test Scenario**:
```
[Publisher] â†’ DHT discovery â†’ [Subscriber 1]
                           â†’ [Subscriber 2]
                           â†’ [Subscriber 3]

All via DHT routing (no gateway relay unless NAT)
```

**Test Cases**:
1. 3 subscribers register interest in topic via DHT (STORE)
2. Publisher discovers subscribers via DHT (FIND_VALUE)
3. Publisher wraps publish in `pubsub_route` envelopes
4. Messages hop through mesh to each subscriber
5. All subscribers receive message (verify fanout)

**Estimate**: 6-8 hours

---

### Phase 3: NAT Traversal Preparation (Week 3-4)

#### Task 3.1: Relay System Extraction

**Goal**: Move relay logic from `macula_gateway` to `macula_relay_system`

**Files to Create**:
- `/src/macula_relay_system/macula_relay_system.erl` (Supervisor)
- `/src/macula_relay_system/macula_relay_server.erl` (GenServer)
- `/src/macula_relay_system/macula_relay_connection.erl` (Connection tracking)

**Changes to Gateway**:
- Remove relay logic from `macula_gateway.erl`
- Delegate relay operations to `macula_relay_system`

**Estimate**: 8-10 hours
**Tests**: Relay-specific tests (relay registration, connection tracking)

---

#### Task 3.2: NAT Discovery Module

**File**: `/src/macula_nat_system/macula_nat_discovery.erl`

**Responsibilities**:
- Detect local IP vs public IP
- Classify NAT type (Full Cone, Restricted, Port Restricted, Symmetric)
- Report NAT status to DHT (for relay selection)

**API**:
```erlang
-spec discover_nat() -> {ok, NatInfo} | {error, Reason}.
%% NatInfo = #{
%%   local_ip => binary(),
%%   public_ip => binary(),
%%   nat_type => full_cone | restricted | port_restricted | symmetric | none,
%%   requires_relay => boolean()
%% }
```

**Estimate**: 6-8 hours
**Tests**: NAT detection tests (mock STUN responses)

---

### Phase 4: P2P Matchmaking (Week 4-5)

#### Task 4.1: Update Macula Arcade for Pure P2P

**Repository**: `macula-arcade` (separate repo)

**Files to Update**:
- `/apps/macula_arcade_coordinator/src/matchmaking_handler.erl`

**Changes**:
1. Remove gateway relay dependency
2. Use DHT for player discovery (`macula_routing_server:find_value/2`)
3. Wrap RPC calls in `rpc_route` envelope
4. Test matchmaking with 4+ players across different nodes

**Estimate**: 8-10 hours
**Tests**: Matchmaking integration tests (4 players, 2 games)

---

## Summary of Work To Do

| Phase | Task | Estimate | Priority | Status |
|-------|------|----------|----------|--------|
| **Phase 1** | Mode integration in `macula_root` | 2-3h | ğŸ”´ HIGH | â³ Pending |
| **Phase 1** | Docker images (bootstrap, edge, gateway) | 4-6h | ğŸ”´ HIGH | â³ Pending |
| **Phase 2** | Multi-hop RPC integration test | 6-8h | ğŸ”´ HIGH | â³ Pending |
| **Phase 2** | Multi-hop pub/sub integration test | 6-8h | ğŸŸ¡ MEDIUM | â³ Pending |
| **Phase 3** | Relay system extraction | 8-10h | ğŸŸ¡ MEDIUM | â³ Pending |
| **Phase 3** | NAT discovery module | 6-8h | ğŸŸ¡ MEDIUM | â³ Pending |
| **Phase 4** | Macula Arcade P2P matchmaking | 8-10h | ğŸŸ¢ LOW | â³ Pending |

**Total Estimate**: 44-53 hours (~6-7 days of focused work)

---

## Next Immediate Steps

1. **Start with Phase 1, Task 1.1**: Add mode support to `macula_root.erl` (2-3 hours)
2. **Then Phase 1, Task 1.2**: Create Docker images for multi-node testing (4-6 hours)
3. **Then Phase 2, Task 2.1**: Multi-hop RPC integration test (6-8 hours)

This will unlock real-world P2P testing and validate the pure P2P architecture!

---

**Document Status**: âœ… Complete
**Last Updated**: 2025-11-17
**Next Review**: After Phase 1 completion
