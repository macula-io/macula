# Macula v0.8.5 - Architectural Foundations

**Version:** v0.8.5
**Target Release:** December 2024 / Early January 2025
**Focus:** Zero-Config Architecture Foundations
**Timeline:** 2-3 weeks
**Status:** Planning

---

## Executive Summary

v0.8.5 is a **foundational architecture release** that simplifies Macula deployment and sets the stage for v0.9.0's production features. This release introduces zero-config TLS, always-on capabilities, and simplified configuration.

**Key Changes:**
- ✅ Auto-generated TLS certificates (zero manual setup)
- ✅ Always-on architecture (all nodes have all capabilities)
- ✅ Simplified configuration (remove mode selection)
- ✅ Dynamic peer supervision (macula_peers_sup)

**Breaking Changes:** Minimal (environment variable renames only)

---

## Motivation

### Current Pain Points (v0.8.0-v0.8.4)

1. **Manual TLS Certificate Management**
   - Every node needs manual cert generation
   - Doesn't scale to hundreds/thousands of nodes
   - Complex deployment (CA setup, cert distribution)

2. **Mode-Based Configuration Complexity**
   - Users must choose: bootstrap, edge, gateway, hybrid
   - Confusion about which mode to use
   - Nodes have different capabilities based on mode

3. **Missing Peer Supervision**
   - No centralized management of peer connections
   - Hard to list/count active peers
   - No clean lifecycle management

### v0.8.5 Solutions

1. **TLS Auto-Generation**
   ```bash
   # Before v0.8.5 (manual)
   openssl genrsa -out key.pem 2048
   openssl req -new -x509 -key key.pem -out cert.pem
   export MACULA_CERT_PATH=/path/to/cert.pem
   export MACULA_KEY_PATH=/path/to/key.pem

   # After v0.8.5 (automatic)
   docker run macula:0.8.5
   # Certs auto-generated on first boot!
   ```

2. **Always-On Architecture**
   ```bash
   # Before v0.8.5 (confusing)
   MACULA_MODE=hybrid  # What does hybrid mean?
   MACULA_MODE=edge    # What's the difference from gateway?

   # After v0.8.5 (simple)
   # No MACULA_MODE needed - every node has all capabilities!
   MACULA_QUIC_PORT=4433
   MACULA_REALM=my.realm
   ```

3. **Peer Supervision**
   ```erlang
   %% Before v0.8.5 (manual tracking)
   {ok, PeerPid} = macula_peer:start_link(Url, Opts).
   %% No way to list all peers or count them

   %% After v0.8.5 (supervised)
   {ok, PeerPid} = macula_peers_sup:start_peer(Url, Opts).
   Peers = macula_peers_sup:list_peers().
   Count = macula_peers_sup:count_peers().
   ```

---

## Scope

### IN SCOPE

#### 1. TLS Auto-Generation Module

**New File:** `src/macula_tls.erl`

**Functions:**
```erlang
-module(macula_tls).

%% API
-export([
    ensure_cert_exists/2,
    generate_self_signed_cert/1,
    derive_node_id/1
]).

%% Ensure certificate exists, generate if missing
-spec ensure_cert_exists(CertPath, KeyPath) ->
    {ok, CertPath, KeyPath, NodeID} | {error, Reason}.

%% Generate self-signed certificate
-spec generate_self_signed_cert(Opts) ->
    {ok, Cert, Key} | {error, Reason}.

%% Derive Node ID from public key
-spec derive_node_id(CertPEM) -> NodeID.
```

**Features:**
- Auto-generate RSA 2048-bit cert on first boot
- 10-year validity (3650 days)
- Persist to disk (survives restarts)
- Node ID = SHA-256 of public key
- File permissions (0600 for private key)

**Configuration:**
```erlang
{macula, [
    {cert_path, "/var/lib/macula/cert.pem"},
    {key_path, "/var/lib/macula/key.pem"},
    {cert_validity_days, 3650},
    {cert_key_type, rsa},
    {cert_key_bits, 2048}
]}
```

**Tests:** 10+ unit tests
**Effort:** 1 week

---

#### 2. Always-On Supervision Tree

**Updated File:** `src/macula_root.erl`

**Changes:**
```erlang
%% BEFORE (mode-based)
init([]) ->
    Mode = application:get_env(macula, mode, gateway),
    CoreSpecs = get_core_child_specs(),
    BootstrapSpecs = maybe_start_bootstrap(Mode),
    GatewaySpecs = maybe_start_gateway(Mode),
    ChildSpecs = CoreSpecs ++ BootstrapSpecs ++ GatewaySpecs,
    {ok, {SupFlags, ChildSpecs}}.

%% AFTER (always-on)
init([]) ->
    io:format("Starting Macula (all capabilities enabled)~n"),
    SupFlags = #{strategy => one_for_one, intensity => 10, period => 5},

    ChildSpecs = [
        %% Core DHT (always)
        get_routing_server_spec(),

        %% Bootstrap system (always)
        get_bootstrap_system_spec(),

        %% Gateway system (always)
        get_gateway_system_spec(),

        %% Peer connections supervisor (always)
        get_peers_sup_spec()
    ],

    {ok, {SupFlags, ChildSpecs}}.
```

**Impact:**
- Remove `mode` configuration
- Remove `maybe_start_*` functions
- All subsystems always start
- Simpler code, easier to understand

**Tests:** 15+ supervision tests
**Effort:** 3 days

---

#### 3. Peer Connections Supervisor

**New File:** `src/macula_peers_sup.erl`

**Module:**
```erlang
-module(macula_peers_sup).
-behaviour(supervisor).

%% API
-export([
    start_link/0,
    start_peer/2,
    stop_peer/1,
    list_peers/0,
    count_peers/0
]).

%% Supervisor callbacks
-export([init/1]).

%% Start simple_one_for_one supervisor
start_link() ->
    supervisor:start_link({local, ?MODULE}, ?MODULE, []).

%% Start new peer connection
-spec start_peer(Url, Opts) -> {ok, pid()} | {error, term()}.
start_peer(Url, Opts) ->
    supervisor:start_child(?MODULE, [Url, Opts]).

%% Stop peer connection
-spec stop_peer(pid()) -> ok.
stop_peer(PeerPid) ->
    supervisor:terminate_child(?MODULE, PeerPid).

%% List all active peers
-spec list_peers() -> [pid()].
list_peers() ->
    [Pid || {_, Pid, _, _} <- supervisor:which_children(?MODULE)].

%% Count active peers
-spec count_peers() -> non_neg_integer().
count_peers() ->
    length(list_peers()).

%% Supervisor init (simple_one_for_one)
init([]) ->
    SupFlags = #{
        strategy => simple_one_for_one,
        intensity => 10,
        period => 60
    },

    ChildSpec = #{
        id => macula_peer_system,
        start => {macula_peer_system, start_link, []},
        restart => temporary,  % Don't auto-restart failed peers
        shutdown => 5000,
        type => supervisor,
        modules => [macula_peer_system]
    },

    {ok, {SupFlags, [ChildSpec]}}.
```

**Features:**
- Centralized peer management
- List all active peer connections
- Count peers for monitoring
- Clean shutdown of all peers

**Tests:** 12+ supervision tests
**Effort:** 2 days

---

#### 4. Configuration Simplification

**Environment Variables:**

**BEFORE (v0.8.4):**
```bash
MACULA_MODE=hybrid              # Removed!
GATEWAY_PORT=4433               # Renamed
MACULA_GATEWAY_URL=https://...  # Renamed
MACULA_REALM=my.realm
```

**AFTER (v0.8.5):**
```bash
# MACULA_MODE removed (always all capabilities)
MACULA_QUIC_PORT=4433           # Clearer name
MACULA_BOOTSTRAP_URL=https://...  # Clearer purpose
MACULA_REALM=my.realm

# TLS (optional - auto-generated if missing)
MACULA_CERT_PATH=/path/to/cert.pem
MACULA_KEY_PATH=/path/to/key.pem
```

**Updated Files:**
- `src/macula_root.erl` - Remove mode handling
- `src/macula_gateway_system.erl` - Use MACULA_QUIC_PORT
- `docker-compose.demo.yml` - Simplified config
- `README.md` - Updated examples
- `GETTING_STARTED.md` - Simplified guide

**Tests:** Config parsing tests
**Effort:** 1 day

---

#### 5. Documentation Updates

**New Docs:**
- `architecture/TLS_AUTO_GENERATION.md` - Already created ✓
- `architecture/FULL_SUPERVISION_TREE.md` - Update for always-on
- `MIGRATION_V0.8.4_TO_V0.8.5.md` - Migration guide

**Updated Docs:**
- `README.md` - Update configuration examples
- `GETTING_STARTED.md` - Simplified setup
- `ARCHITECTURE.md` - Always-on architecture
- `docker-compose.demo.yml` - Zero-config example

**Effort:** 2 days

---

### OUT OF SCOPE (Deferred to v0.9.0)

**Connection Pooling** - Performance optimization
**NAT Traversal** - Hole punching
**Request/Response DHT** - Consistency improvements
**Observability** - Metrics and monitoring
**Certificate Pinning** - Trust verification

---

## Implementation Plan

### Week 1: Core Implementation

**Days 1-2: TLS Auto-Generation**
- [ ] Create `src/macula_tls.erl`
- [ ] Implement `generate_self_signed_cert/1`
- [ ] Implement `derive_node_id/1`
- [ ] Implement `ensure_cert_exists/2`
- [ ] File permissions handling (0600 for key)
- [ ] Write 10+ unit tests

**Days 3-4: Always-On Supervision**
- [ ] Update `src/macula_root.erl`
- [ ] Remove `mode` configuration
- [ ] Remove `maybe_start_*` functions
- [ ] Always start all subsystems
- [ ] Write 15+ supervision tests

**Day 5: Peer Supervision**
- [ ] Create `src/macula_peers_sup.erl`
- [ ] Implement simple_one_for_one supervisor
- [ ] API: start_peer, stop_peer, list_peers, count_peers
- [ ] Write 12+ tests

---

### Week 2: Integration & Testing

**Days 6-7: Integration**
- [ ] Integrate `macula_tls` into `macula_gateway_system`
- [ ] Integrate `macula_peers_sup` into `macula_root`
- [ ] Update environment variable handling
- [ ] End-to-end integration testing

**Days 8-9: Docker & Configuration**
- [ ] Update `docker-compose.demo.yml`
- [ ] Remove volume mounts for manual certs
- [ ] Add volume mounts for auto-generated certs
- [ ] Test Docker deployment (zero-config)
- [ ] Verify cert persistence across restarts

**Day 10: Documentation**
- [ ] Update `FULL_SUPERVISION_TREE.md`
- [ ] Create `MIGRATION_V0.8.4_TO_V0.8.5.md`
- [ ] Update `README.md`
- [ ] Update `GETTING_STARTED.md`

---

### Week 3: Testing & Release

**Days 11-12: Testing**
- [ ] Run full test suite (all existing tests must pass)
- [ ] Multi-node mesh testing
- [ ] Certificate persistence testing
- [ ] Backward compatibility testing (v0.8.4 with manual certs)

**Days 13-14: Release Preparation**
- [ ] Update `rebar.config` version to 0.8.5
- [ ] Create release notes
- [ ] Tag release: `git tag v0.8.5`
- [ ] Update hex package
- [ ] Build Docker images

**Day 15: Release**
- [ ] Publish hex package
- [ ] Push Docker images
- [ ] Announce release
- [ ] Monitor for issues

---

## Testing Strategy

### Unit Tests (37+ new tests)

**TLS Module (10 tests):**
- Generate cert and verify format
- Persist and reload cert
- Derive consistent Node ID
- Handle missing certs (auto-generate)
- Handle corrupted certs
- File permission verification
- Certificate validity period
- Public key extraction
- Node ID collision resistance (SHA-256)
- Error handling

**Supervision Tree (15 tests):**
- All subsystems start in correct order
- Bootstrap system always starts
- Gateway system always starts
- Peers_sup always starts
- Restart behavior (one_for_one)
- Crash isolation
- Supervisor queries (which_children)
- Child PID retrieval
- Shutdown behavior

**Peers Supervisor (12 tests):**
- Start peer connection
- Stop peer connection
- List active peers
- Count peers
- Multiple peers
- Peer crash handling (temporary restart)
- Supervisor restart behavior
- Clean shutdown (all peers stopped)

---

### Integration Tests (15+ new tests)

**Zero-Config Deployment:**
- First boot auto-generates certs
- Node ID stable across restarts
- Certs persist in volume
- Multiple nodes with auto-generated certs
- Mesh formation with auto-certs

**Backward Compatibility:**
- v0.8.5 with manual certs (should work)
- v0.8.5 with auto-generated certs
- Mixed mesh (v0.8.4 + v0.8.5)

**Supervision:**
- All subsystems running simultaneously
- Peer connections managed by supervisor
- Clean shutdown of mesh

---

## Migration Guide (v0.8.4 → v0.8.5)

### Breaking Changes

**1. Environment Variables Renamed:**
```bash
# OLD (v0.8.4)
MACULA_MODE=hybrid
GATEWAY_PORT=4433
MACULA_GATEWAY_URL=https://bootstrap:4433

# NEW (v0.8.5)
# MACULA_MODE removed
MACULA_QUIC_PORT=4433
MACULA_BOOTSTRAP_URL=https://bootstrap:4433
```

**2. TLS Certificates:**
```yaml
# OLD (v0.8.4) - Manual cert required
environment:
  MACULA_CERT_PATH: /path/to/cert.pem
  MACULA_KEY_PATH: /path/to/key.pem

# NEW (v0.8.5) - Auto-generated if missing
environment:
  # Optional: specify paths (auto-generates if files don't exist)
  MACULA_CERT_PATH: /opt/macula/certs/cert.pem
  MACULA_KEY_PATH: /opt/macula/certs/key.pem
volumes:
  - macula-certs:/opt/macula/certs  # Persist auto-generated certs
```

### Non-Breaking Changes

**All Nodes Have All Capabilities:**
- No functional change (v0.8.4 hybrid mode = v0.8.5 default)
- Bootstrap nodes still bootstrap
- Gateway nodes still accept connections
- Edge nodes still participate

**Deployment remains the same:**
- Same Docker images (just updated)
- Same network topology
- Same realm configuration

---

## Success Criteria

### Functional Requirements
- ✅ Auto-generate certs on first boot
- ✅ Certs persist across restarts (stable Node ID)
- ✅ All subsystems always start
- ✅ Peer connections supervised
- ✅ Configuration simplified
- ✅ All existing tests pass
- ✅ Backward compatible with v0.8.4

### Performance Requirements
- ✅ No performance regression
- ✅ Startup time < 2 seconds (including cert generation)
- ✅ Same P2P performance as v0.8.4

### Quality Requirements
- ✅ 37+ new unit tests
- ✅ 15+ new integration tests
- ✅ Documentation complete
- ✅ Migration guide clear

---

## Risk Assessment

### Low Risk
**TLS auto-generation edge cases**
- Mitigation: Extensive testing
- Fallback: Manual certs still supported

**File permission issues**
- Mitigation: Proper error handling
- Fallback: Log error, require manual intervention

**Configuration migration confusion**
- Mitigation: Clear migration guide
- Fallback: Support both old and new env vars temporarily

### Negligible Risk
**Supervision tree changes**
- Mitigation: No functional change (just remove conditionals)
- Impact: Actually simpler code

---

## Post-Release

### v0.8.6 (Optional Patch)
- Bug fixes from v0.8.5 feedback
- Documentation improvements
- Minor QoL improvements

### v0.9.0 (Next Major Release)
- Connection pooling (10x performance)
- NAT traversal (80% direct P2P)
- Request/response patterns
- Production observability

**Timeline:** 4-6 months after v0.8.5

---

## References

- **v0.9.0 Plan:** `architecture/V0.9.0_SCOPE_AND_IMPLEMENTATION_PLAN.md`
- **TLS Design:** `architecture/TLS_AUTO_GENERATION.md`
- **Supervision Tree:** `architecture/FULL_SUPERVISION_TREE.md`
- **v0.8.0 Overview:** `architecture/v0.8.0-OVERVIEW.md`

---

**Document Version:** 1.0
**Last Updated:** 2025-11-18
**Status:** Planning
**Timeline:** 2-3 weeks

---

## Summary

v0.8.5 is a **focused architectural release** that:

✅ **Eliminates manual TLS setup** (auto-generated certs)
✅ **Simplifies deployment** (zero-config, always-on)
✅ **Improves maintainability** (cleaner supervision tree)
✅ **Sets foundation for v0.9.0** (all nodes equal, ready for advanced features)

**Effort:** 2-3 weeks
**Breaking Changes:** Minimal (env var renames)
**Benefits:** Zero-config deployment, simpler architecture
