# Macula v0.8.0 Roadmap - What's Next

**Current Version**: v0.8.0
**Next Release**: v0.9.0 (Planned Q2 2025)

---

## v0.8.0 Status

✅ **COMPLETE** - All features implemented and tested

- ✅ Direct P2P QUIC connections
- ✅ DHT propagation (k=20 replication)
- ✅ Gateway on all node types
- ✅ RPC via direct P2P (11/11 tests)
- ✅ PubSub via direct P2P (10/10 tests)
- ✅ Comprehensive integration tests

**Test Coverage**: 21/21 integration tests passing (100%)

---

## v0.9.0 Planning - Production Hardening

**Target Release**: Q2 2025 (4-6 months)
**Focus**: Security, Performance, NAT Traversal

### Theme: Production-Ready Infrastructure

v0.8.0 provides the foundation. v0.9.0 makes it production-grade with security hardening, performance optimization, and NAT traversal.

---

## High Priority Features

### 1. Connection Pooling

**Problem**: New connection per message creates overhead
**Impact**: Performance (100-200ms per operation)
**Effort**: 2-3 weeks

**Implementation**:
- Create `macula_connection_pool` enhancement
- LRU eviction policy
- Max 100 connections per pool
- TTL-based cleanup (5-minute idle timeout)
- Automatic reconnection on failure

**Benefits**:
- 10x performance improvement for repeated operations
- Reduced connection establishment overhead
- Better resource utilization
- Lower latency for frequent P2P operations

**API**:
```erlang
%% Get connection from pool (or create new)
{ok, Conn} = macula_connection_pool:get_connection(Endpoint).

%% Send via pooled connection
ok = macula_connection_pool:send_message(Conn, MessageType, Message).

%% Return to pool (automatic via monitoring)
```

### 2. TLS Certificate Verification

**Problem**: Currently using `{verify, none}` (security risk)
**Impact**: Security (high)
**Effort**: 1-2 weeks

**Implementation**:
- Add CA certificate bundle support
- Implement certificate validation
- Support custom CA paths
- Add certificate pinning option

**Configuration**:
```erlang
{macula, [
    {tls, #{
        verify => verify_peer,
        cacertfile => "/etc/macula/ca-bundle.pem",
        certfile => "/etc/macula/node-cert.pem",
        keyfile => "/etc/macula/node-key.pem",
        %% Optional: Pin specific certificates
        pinned_certs => [
            <<...>>  % SHA256 fingerprint
        ]
    }}
]}.
```

**Modules to Update**:
- `macula_connection.erl`
- `macula_connection_pool.erl`
- `macula_peer_connector.erl`
- `macula_quic.erl`

### 3. Request/Response Pattern for DHT

**Problem**: Fire-and-forget provides no feedback
**Impact**: Observability (medium)
**Effort**: 2-3 weeks

**Implementation**:
- Add correlation IDs to DHT messages
- Implement response tracking with timeout
- Return query results to caller
- Add retry logic for failed queries

**API**:
```erlang
%% Query with response
{ok, Result} = macula_routing_server:query_with_response(
    Pid, Key, Timeout
).

%% Store with confirmation
{ok, StoredNodes} = macula_routing_server:store_with_confirmation(
    Pid, Key, Value, Timeout
).
```

**Benefits**:
- Confirm DHT operations succeeded
- Monitor propagation success rate
- Better debugging and observability
- Retry failed operations

---

## Medium Priority Features

### 4. NAT Traversal - Opportunistic Hole Punching

**Problem**: Edge nodes behind NAT cannot accept connections
**Impact**: Connectivity (medium)
**Effort**: 6-8 weeks

**Strategy**: Attempt direct connection while keeping relay fallback

**Implementation Phases**:

#### Phase A: NAT Discovery (2 weeks)
- Create `macula_nat_discovery.erl`
- Detect public IP/port via gateway
- Detect NAT type (cone, symmetric, etc.)
- Cache NAT type and public address

#### Phase B: Hole Punching (3 weeks)
- Create `macula_hole_punch.erl`
- Coordinate simultaneous connection attempts
- Exchange addresses via gateway
- Timeout and fallback to relay

#### Phase C: Connection Upgrade (2 weeks)
- Create `macula_connection_upgrade.erl`
- Migrate active streams from relay to direct
- Handle graceful transition
- Update routing tables

#### Phase D: Testing (1 week)
- Docker-based NAT simulation
- Test various NAT types
- Verify fallback behavior
- Integration tests

**Success Metrics**:
- 80%+ direct P2P success (non-symmetric NAT)
- 100% connectivity (with relay fallback)
- <100ms upgrade time (relay → direct)
- No message loss during upgrade

**See**: `architecture/NAT_TRAVERSAL_ROADMAP.md` for detailed design

### 5. Performance Tuning

**Problem**: Various performance bottlenecks
**Impact**: Performance (medium)
**Effort**: 2-3 weeks

**Optimizations**:

#### 5.1. Adaptive Delay Tuning
- Currently 100ms fixed delay before closing streams
- Implement adaptive delay based on network conditions
- Measure actual transmission time
- Tune per-connection

#### 5.2. Batch DHT Operations
- Combine multiple STORE operations
- Batch FIND_VALUE queries
- Reduce connection overhead
- Better throughput

#### 5.3. DHT Cache Tuning
- Optimize cache TTL values
- Implement cache warming
- Add cache statistics
- Monitor hit rates

#### 5.4. Message Batching
- Batch multiple messages to same peer
- Reduce per-message overhead
- Improve throughput

**Target Improvements**:
- 2-3x throughput increase
- 30-50% latency reduction
- 50% reduction in connection overhead

### 6. Observability & Metrics

**Problem**: Limited visibility into mesh operations
**Impact**: Operations (medium)
**Effort**: 2 weeks

**Implementation**:
- Add telemetry events for DHT operations
- Track connection pool statistics
- Monitor P2P connection success rates
- Add health check endpoints
- Integration with Prometheus/Grafana

**Metrics**:
```erlang
%% DHT metrics
dht_store_operations_total
dht_store_propagation_success_rate
dht_query_latency_milliseconds
dht_cache_hit_rate

%% Connection metrics
p2p_connections_total
p2p_connection_duration_seconds
p2p_connection_pool_size
p2p_connection_errors_total

%% RPC/PubSub metrics
rpc_calls_total
rpc_call_latency_milliseconds
pubsub_messages_total
pubsub_delivery_latency_milliseconds
```

---

## Low Priority / Future Considerations

### 7. Subsystem Refactoring

**Problem**: Gateway module mixes bootstrap and relay concerns
**Impact**: Architecture (low)
**Effort**: 4 weeks

**Deferred Reason**: Current architecture works well. Refactoring is architectural cleanup, not critical for production.

**When to Reconsider**:
- If deploying dedicated bootstrap nodes
- If relay logic becomes complex
- If separation of concerns becomes important

**See**: `architecture/V0.8.0_IMPLEMENTATION_ROADMAP.md` for original plan

### 8. STUN/TURN Infrastructure

**Problem**: Symmetric NAT requires TURN relay
**Impact**: Connectivity (low - already have relay fallback)
**Effort**: 8-10 weeks + infrastructure costs

**Deferred Reason**: v0.8.0 relay fallback works for 100% connectivity. STUN/TURN improves from 80% direct to 95% direct, but requires external infrastructure.

**When to Reconsider**:
- If 80% direct P2P isn't sufficient
- If relay costs become prohibitive
- If symmetric NAT is common in target deployment

**See**: `architecture/NAT_TRAVERSAL_ROADMAP.md` Phase 3

---

## Version Roadmap

### v0.8.1 (Optional - Q1 2025)

Quick quality-of-life improvements:
- Remove remaining empty TODOs
- Add more integration tests
- Improve error messages
- Documentation polish

**Effort**: 1 week

### v0.9.0 (Target - Q2 2025)

Production hardening:
- ✅ Connection pooling (High Priority)
- ✅ TLS certificate verification (High Priority)
- ✅ Request/response DHT pattern (High Priority)
- ✅ NAT hole punching (Medium Priority)
- ✅ Performance tuning (Medium Priority)
- ✅ Observability & metrics (Medium Priority)

**Effort**: 18-24 weeks (4-6 months)

### v0.10.0 (Future - Q3 2025)

Advanced features:
- STUN/TURN infrastructure (if needed)
- Subsystem refactoring (if needed)
- Advanced routing strategies
- Multi-datacenter support

**Effort**: TBD

---

## Development Priorities

### Phase 1: Security (Weeks 1-3)
1. TLS certificate verification
2. Certificate pinning
3. Security audit

### Phase 2: Performance (Weeks 4-9)
1. Connection pooling
2. Adaptive delay tuning
3. Batch operations
4. Performance benchmarking

### Phase 3: Reliability (Weeks 10-12)
1. Request/response DHT pattern
2. Retry logic
3. Error handling improvements

### Phase 4: Connectivity (Weeks 13-20)
1. NAT discovery
2. Hole punching
3. Connection upgrade
4. NAT traversal testing

### Phase 5: Observability (Weeks 21-22)
1. Telemetry integration
2. Metrics endpoints
3. Dashboards
4. Monitoring

### Phase 6: Polish (Weeks 23-24)
1. Documentation
2. Tutorial updates
3. Integration testing
4. Release preparation

---

## Success Criteria (v0.9.0)

### Performance
- ✅ 10x improvement in repeated P2P operations (via connection pooling)
- ✅ <50ms P2P message delivery (cached routes)
- ✅ 2-3x throughput increase (batching + tuning)

### Security
- ✅ TLS certificate verification enabled by default
- ✅ Certificate pinning option available
- ✅ Security audit passed

### Reliability
- ✅ 100% test coverage maintained
- ✅ DHT operation confirmation available
- ✅ Retry logic for failed operations

### Connectivity
- ✅ 80%+ direct P2P connections (NAT hole punching)
- ✅ 100% connectivity maintained (relay fallback)
- ✅ Graceful connection upgrade

### Observability
- ✅ Comprehensive metrics available
- ✅ Integration with Prometheus
- ✅ Sample Grafana dashboards

---

## Breaking Changes (v0.9.0)

### Minimal Breaking Changes Expected

**Possible**:
- TLS verification enabled by default (may require configuration)
- Connection pool configuration (optional)
- Metrics endpoint (new feature)

**Mitigation**:
- Feature flags for gradual rollout
- Backward compatibility mode
- Clear migration guide

---

## Community Feedback

We welcome feedback on this roadmap!

**High Priority Questions**:
- Is NAT traversal critical for your use case?
- What performance metrics matter most?
- What observability features do you need?

**How to Provide Feedback**:
- GitHub Issues: https://github.com/macula-io/macula/issues
- GitHub Discussions: https://github.com/macula-io/macula/discussions

---

## References

- **NAT Traversal Design**: `architecture/NAT_TRAVERSAL_ROADMAP.md`
- **Original v0.8.0 Roadmap**: `architecture/V0.8.0_IMPLEMENTATION_ROADMAP.md`
- **Current Architecture**: `architecture/v0.8.0-ARCHITECTURE.md`
- **Known Issues**: `TODO.md`

---

**Document Version**: 1.0
**Last Updated**: 2025-11-17
**Next Review**: After v0.8.0 release
